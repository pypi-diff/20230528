# Comparing `tmp/freqtrade-2023.4.tar.gz` & `tmp/freqtrade-2023.5.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "freqtrade-2023.4.tar", last modified: Tue Apr 25 14:49:52 2023, max compression
+gzip compressed data, was "freqtrade-2023.5.tar", last modified: Sun May 28 18:36:08 2023, max compression
```

## Comparing `freqtrade-2023.4.tar` & `freqtrade-2023.5.tar`

### file list

```diff
@@ -1,409 +1,416 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.029684 freqtrade-2023.4/
--rw-r--r--   0 runner    (1001) docker     (123)    35141 2023-04-25 14:49:48.000000 freqtrade-2023.4/LICENSE
--rw-r--r--   0 runner    (1001) docker     (123)      277 2023-04-25 14:49:48.000000 freqtrade-2023.4/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (123)    12539 2023-04-25 14:49:52.029684 freqtrade-2023.4/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)    11477 2023-04-25 14:49:48.000000 freqtrade-2023.4/README.md
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.981684 freqtrade-2023.4/freqtrade/
--rw-r--r--   0 runner    (1001) docker     (123)      810 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (123)      206 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/__main__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.985684 freqtrade-2023.4/freqtrade/commands/
--rw-r--r--   0 runner    (1001) docker     (123)     1741 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2171 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/analyze_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)    20942 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/arguments.py
--rw-r--r--   0 runner    (1001) docker     (123)     8813 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/build_config_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)    21825 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/cli_options.py
--rw-r--r--   0 runner    (1001) docker     (123)     9065 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/data_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)     1672 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/db_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)     6530 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/deploy_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)     3634 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/hyperopt_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)     9333 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/list_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)     4513 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/optimize_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)     1388 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/pairlist_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)     1162 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/plot_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)     1852 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/strategy_utils_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)      936 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/trade_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)      416 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/commands/webserver_commands.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.985684 freqtrade-2023.4/freqtrade/configuration/
--rw-r--r--   0 runner    (1001) docker     (123)      299 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/configuration/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      723 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/configuration/config_setup.py
--rw-r--r--   0 runner    (1001) docker     (123)    17360 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/configuration/config_validation.py
--rw-r--r--   0 runner    (1001) docker     (123)    24461 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/configuration/configuration.py
--rw-r--r--   0 runner    (1001) docker     (123)     7035 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/configuration/deprecated_settings.py
--rw-r--r--   0 runner    (1001) docker     (123)     3592 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/configuration/directory_operations.py
--rw-r--r--   0 runner    (1001) docker     (123)     1814 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/configuration/environment_vars.py
--rw-r--r--   0 runner    (1001) docker     (123)     3851 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/configuration/load_config.py
--rw-r--r--   0 runner    (1001) docker     (123)     6143 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/configuration/timerange.py
--rw-r--r--   0 runner    (1001) docker     (123)    29216 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/constants.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.985684 freqtrade-2023.4/freqtrade/data/
--rw-r--r--   0 runner    (1001) docker     (123)      152 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    16153 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/btanalysis.py
--rw-r--r--   0 runner    (1001) docker     (123)    13517 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/converter.py
--rw-r--r--   0 runner    (1001) docker     (123)    21145 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/dataprovider.py
--rw-r--r--   0 runner    (1001) docker     (123)    10010 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/entryexitanalysis.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.989684 freqtrade-2023.4/freqtrade/data/history/
--rw-r--r--   0 runner    (1001) docker     (123)      465 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/history/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     4903 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/history/featherdatahandler.py
--rw-r--r--   0 runner    (1001) docker     (123)     6094 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/history/hdf5datahandler.py
--rw-r--r--   0 runner    (1001) docker     (123)    21492 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/history/history_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    17490 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/history/idatahandler.py
--rw-r--r--   0 runner    (1001) docker     (123)     5580 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/history/jsondatahandler.py
--rw-r--r--   0 runner    (1001) docker     (123)     4798 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/history/parquetdatahandler.py
--rw-r--r--   0 runner    (1001) docker     (123)    12466 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/data/metrics.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.989684 freqtrade-2023.4/freqtrade/edge/
--rw-r--r--   0 runner    (1001) docker     (123)       59 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/edge/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    20825 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/edge/edge_positioning.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.989684 freqtrade-2023.4/freqtrade/enums/
--rw-r--r--   0 runner    (1001) docker     (123)      861 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      238 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/backteststate.py
--rw-r--r--   0 runner    (1001) docker     (123)      798 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/candletype.py
--rw-r--r--   0 runner    (1001) docker     (123)      640 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/exitchecktuple.py
--rw-r--r--   0 runner    (1001) docker     (123)      577 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/exittype.py
--rw-r--r--   0 runner    (1001) docker     (123)      210 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/hyperoptstate.py
--rw-r--r--   0 runner    (1001) docker     (123)      237 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/marginmode.py
--rw-r--r--   0 runner    (1001) docker     (123)      261 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/marketstatetype.py
--rw-r--r--   0 runner    (1001) docker     (123)      100 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/ordertypevalue.py
--rw-r--r--   0 runner    (1001) docker     (123)      177 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/pricetype.py
--rw-r--r--   0 runner    (1001) docker     (123)      976 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/rpcmessagetype.py
--rw-r--r--   0 runner    (1001) docker     (123)      592 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/runmode.py
--rw-r--r--   0 runner    (1001) docker     (123)      626 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/signaltype.py
--rw-r--r--   0 runner    (1001) docker     (123)      202 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/state.py
--rw-r--r--   0 runner    (1001) docker     (123)      220 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/enums/tradingmode.py
--rw-r--r--   0 runner    (1001) docker     (123)     2068 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exceptions.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.993684 freqtrade-2023.4/freqtrade/exchange/
--rw-r--r--   0 runner    (1001) docker     (123)     1531 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     9415 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/binance.py
--rw-r--r--   0 runner    (1001) docker     (123)   605433 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/binance_leverage_tiers.json
--rw-r--r--   0 runner    (1001) docker     (123)     1621 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/bitpanda.py
--rw-r--r--   0 runner    (1001) docker     (123)      517 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/bittrex.py
--rw-r--r--   0 runner    (1001) docker     (123)      547 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/bitvavo.py
--rw-r--r--   0 runner    (1001) docker     (123)     8304 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/bybit.py
--rw-r--r--   0 runner    (1001) docker     (123)     2975 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/check_exchange.py
--rw-r--r--   0 runner    (1001) docker     (123)      564 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/coinbasepro.py
--rw-r--r--   0 runner    (1001) docker     (123)     5922 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/common.py
--rw-r--r--   0 runner    (1001) docker     (123)   129828 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/exchange.py
--rw-r--r--   0 runner    (1001) docker     (123)    10673 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/exchange_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     5035 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/gate.py
--rw-r--r--   0 runner    (1001) docker     (123)      517 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/hitbtc.py
--rw-r--r--   0 runner    (1001) docker     (123)      827 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/huobi.py
--rw-r--r--   0 runner    (1001) docker     (123)     9717 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/kraken.py
--rw-r--r--   0 runner    (1001) docker     (123)     2120 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/kucoin.py
--rw-r--r--   0 runner    (1001) docker     (123)     8621 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/okx.py
--rw-r--r--   0 runner    (1001) docker     (123)      725 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/exchange/types.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.993684 freqtrade-2023.4/freqtrade/freqai/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.993684 freqtrade-2023.4/freqtrade/freqai/RL/
--rw-r--r--   0 runner    (1001) docker     (123)     4405 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/RL/Base3ActionRLEnv.py
--rw-r--r--   0 runner    (1001) docker     (123)     4930 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/RL/Base4ActionRLEnv.py
--rw-r--r--   0 runner    (1001) docker     (123)     5554 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/RL/Base5ActionRLEnv.py
--rw-r--r--   0 runner    (1001) docker     (123)    14600 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/RL/BaseEnvironment.py
--rw-r--r--   0 runner    (1001) docker     (123)    19776 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/RL/BaseReinforcementLearningModel.py
--rw-r--r--   0 runner    (1001) docker     (123)     2045 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/RL/TensorboardCallback.py
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/RL/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.993684 freqtrade-2023.4/freqtrade/freqai/base_models/
--rw-r--r--   0 runner    (1001) docker     (123)     4320 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/base_models/BaseClassifierModel.py
--rw-r--r--   0 runner    (1001) docker     (123)     5478 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/base_models/BasePyTorchClassifier.py
--rw-r--r--   0 runner    (1001) docker     (123)     2920 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/base_models/BasePyTorchModel.py
--rw-r--r--   0 runner    (1001) docker     (123)     1692 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/base_models/BasePyTorchRegressor.py
--rw-r--r--   0 runner    (1001) docker     (123)     4054 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/base_models/BaseRegressionModel.py
--rw-r--r--   0 runner    (1001) docker     (123)     2572 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/base_models/BaseTensorFlowModel.py
--rw-r--r--   0 runner    (1001) docker     (123)     3466 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/base_models/FreqaiMultiOutputClassifier.py
--rw-r--r--   0 runner    (1001) docker     (123)     2502 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/base_models/FreqaiMultiOutputRegressor.py
--rw-r--r--   0 runner    (1001) docker     (123)    30241 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/data_drawer.py
--rw-r--r--   0 runner    (1001) docker     (123)    65930 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/data_kitchen.py
--rw-r--r--   0 runner    (1001) docker     (123)    44061 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/freqai_interface.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.997684 freqtrade-2023.4/freqtrade/freqai/prediction_models/
--rw-r--r--   0 runner    (1001) docker     (123)     2083 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/CatboostClassifier.py
--rw-r--r--   0 runner    (1001) docker     (123)     2866 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/CatboostClassifierMultiTarget.py
--rw-r--r--   0 runner    (1001) docker     (123)     2048 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/CatboostRegressor.py
--rw-r--r--   0 runner    (1001) docker     (123)     2834 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/CatboostRegressorMultiTarget.py
--rw-r--r--   0 runner    (1001) docker     (123)     1920 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/LightGBMClassifier.py
--rw-r--r--   0 runner    (1001) docker     (123)     2698 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/LightGBMClassifierMultiTarget.py
--rw-r--r--   0 runner    (1001) docker     (123)     1837 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/LightGBMRegressor.py
--rw-r--r--   0 runner    (1001) docker     (123)     2692 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/LightGBMRegressorMultiTarget.py
--rw-r--r--   0 runner    (1001) docker     (123)     3470 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/PyTorchMLPClassifier.py
--rw-r--r--   0 runner    (1001) docker     (123)     3160 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/PyTorchMLPRegressor.py
--rw-r--r--   0 runner    (1001) docker     (123)     6227 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/ReinforcementLearner.py
--rw-r--r--   0 runner    (1001) docker     (123)     2752 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/ReinforcementLearner_multiproc.py
--rw-r--r--   0 runner    (1001) docker     (123)     3338 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/XGBoostClassifier.py
--rw-r--r--   0 runner    (1001) docker     (123)     3345 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/XGBoostRFClassifier.py
--rw-r--r--   0 runner    (1001) docker     (123)     1844 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/XGBoostRFRegressor.py
--rw-r--r--   0 runner    (1001) docker     (123)     1838 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/XGBoostRegressor.py
--rw-r--r--   0 runner    (1001) docker     (123)     2596 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/XGBoostRegressorMultiTarget.py
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/prediction_models/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.997684 freqtrade-2023.4/freqtrade/freqai/torch/
--rw-r--r--   0 runner    (1001) docker     (123)     2062 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/torch/PyTorchDataConvertor.py
--rw-r--r--   0 runner    (1001) docker     (123)     3796 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/torch/PyTorchMLPModel.py
--rw-r--r--   0 runner    (1001) docker     (123)     8171 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/torch/PyTorchModelTrainer.py
--rw-r--r--   0 runner    (1001) docker     (123)     2026 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/torch/PyTorchTrainerInterface.py
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/torch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     9210 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqai/utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    92762 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/freqtradebot.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.997684 freqtrade-2023.4/freqtrade/leverage/
--rw-r--r--   0 runner    (1001) docker     (123)       63 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/leverage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1257 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/leverage/interest.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.997684 freqtrade-2023.4/freqtrade/loggers/
--rw-r--r--   0 runner    (1001) docker     (123)     4888 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/loggers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      460 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/loggers/buffering_handler.py
--rw-r--r--   0 runner    (1001) docker     (123)      714 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/loggers/std_err_stream_handler.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     2094 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/main.py
--rw-r--r--   0 runner    (1001) docker     (123)    10215 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/misc.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.997684 freqtrade-2023.4/freqtrade/mixins/
--rw-r--r--   0 runner    (1001) docker     (123)       70 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/mixins/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1265 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/mixins/logging_mixin.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.001684 freqtrade-2023.4/freqtrade/optimize/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1519 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/backtest_caching.py
--rw-r--r--   0 runner    (1001) docker     (123)    64620 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/backtesting.py
--rw-r--r--   0 runner    (1001) docker     (123)      856 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/bt_progress.py
--rw-r--r--   0 runner    (1001) docker     (123)     1856 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/edge_cli.py
--rw-r--r--   0 runner    (1001) docker     (123)    28627 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt.py
--rw-r--r--   0 runner    (1001) docker     (123)     3676 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_auto.py
--rw-r--r--   0 runner    (1001) docker     (123)     4525 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_epoch_filters.py
--rw-r--r--   0 runner    (1001) docker     (123)     8554 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_interface.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.001684 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/
--rw-r--r--   0 runner    (1001) docker     (123)     1102 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_calmar.py
--rw-r--r--   0 runner    (1001) docker     (123)     1237 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_max_drawdown.py
--rw-r--r--   0 runner    (1001) docker     (123)     1470 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_max_drawdown_relative.py
--rw-r--r--   0 runner    (1001) docker     (123)      746 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_onlyprofit.py
--rw-r--r--   0 runner    (1001) docker     (123)      931 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_profit_drawdown.py
--rw-r--r--   0 runner    (1001) docker     (123)     1095 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sharpe.py
--rw-r--r--   0 runner    (1001) docker     (123)     2108 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sharpe_daily.py
--rw-r--r--   0 runner    (1001) docker     (123)     1965 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_short_trade_dur.py
--rw-r--r--   0 runner    (1001) docker     (123)     1109 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sortino.py
--rw-r--r--   0 runner    (1001) docker     (123)     2566 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sortino_daily.py
--rw-r--r--   0 runner    (1001) docker     (123)      951 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_loss_interface.py
--rw-r--r--   0 runner    (1001) docker     (123)    23094 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/hyperopt_tools.py
--rw-r--r--   0 runner    (1001) docker     (123)    43210 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/optimize_reports.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.001684 freqtrade-2023.4/freqtrade/optimize/space/
--rw-r--r--   0 runner    (1001) docker     (123)      127 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/space/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1391 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/optimize/space/decimalspace.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.001684 freqtrade-2023.4/freqtrade/persistence/
--rw-r--r--   0 runner    (1001) docker     (123)      284 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/persistence/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      154 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/persistence/base.py
--rw-r--r--   0 runner    (1001) docker     (123)     6397 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/persistence/key_value_store.py
--rw-r--r--   0 runner    (1001) docker     (123)    15663 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/persistence/migrations.py
--rw-r--r--   0 runner    (1001) docker     (123)     2926 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/persistence/models.py
--rw-r--r--   0 runner    (1001) docker     (123)     3103 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/persistence/pairlock.py
--rw-r--r--   0 runner    (1001) docker     (123)     6366 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/persistence/pairlock_middleware.py
--rw-r--r--   0 runner    (1001) docker     (123)    72089 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/persistence/trade_model.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.001684 freqtrade-2023.4/freqtrade/plot/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plot/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    26213 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plot/plotting.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.005684 freqtrade-2023.4/freqtrade/plugins/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.005684 freqtrade-2023.4/freqtrade/plugins/pairlist/
--rw-r--r--   0 runner    (1001) docker     (123)     5840 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/AgeFilter.py
--rw-r--r--   0 runner    (1001) docker     (123)     7375 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/IPairList.py
--rw-r--r--   0 runner    (1001) docker     (123)     2258 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/OffsetFilter.py
--rw-r--r--   0 runner    (1001) docker     (123)     3259 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/PerformanceFilter.py
--rw-r--r--   0 runner    (1001) docker     (123)     2957 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/PrecisionFilter.py
--rw-r--r--   0 runner    (1001) docker     (123)     5426 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/PriceFilter.py
--rw-r--r--   0 runner    (1001) docker     (123)     3180 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/ProducerPairList.py
--rw-r--r--   0 runner    (1001) docker     (123)     8104 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/RemotePairList.py
--rw-r--r--   0 runner    (1001) docker     (123)     2874 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/ShuffleFilter.py
--rw-r--r--   0 runner    (1001) docker     (123)     2505 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/SpreadFilter.py
--rw-r--r--   0 runner    (1001) docker     (123)     2369 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/StaticPairList.py
--rw-r--r--   0 runner    (1001) docker     (123)     5025 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/VolatilityFilter.py
--rw-r--r--   0 runner    (1001) docker     (123)    10957 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/VolumePairList.py
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2347 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/pairlist_helpers.py
--rw-r--r--   0 runner    (1001) docker     (123)     5423 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlist/rangestabilityfilter.py
--rw-r--r--   0 runner    (1001) docker     (123)     6881 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/pairlistmanager.py
--rw-r--r--   0 runner    (1001) docker     (123)     2872 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/protectionmanager.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.005684 freqtrade-2023.4/freqtrade/plugins/protections/
--rw-r--r--   0 runner    (1001) docker     (123)      105 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/protections/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2707 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/protections/cooldown_period.py
--rw-r--r--   0 runner    (1001) docker     (123)     4268 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/protections/iprotection.py
--rw-r--r--   0 runner    (1001) docker     (123)     3607 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/protections/low_profit_pairs.py
--rw-r--r--   0 runner    (1001) docker     (123)     3544 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/protections/max_drawdown_protection.py
--rw-r--r--   0 runner    (1001) docker     (123)     3691 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/plugins/protections/stoploss_guard.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.009684 freqtrade-2023.4/freqtrade/resolvers/
--rw-r--r--   0 runner    (1001) docker     (123)      512 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/resolvers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2395 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/resolvers/exchange_resolver.py
--rw-r--r--   0 runner    (1001) docker     (123)     1799 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/resolvers/freqaimodel_resolver.py
--rw-r--r--   0 runner    (1001) docker     (123)     1727 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/resolvers/hyperopt_resolver.py
--rw-r--r--   0 runner    (1001) docker     (123)    10493 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/resolvers/iresolver.py
--rw-r--r--   0 runner    (1001) docker     (123)     1794 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/resolvers/pairlist_resolver.py
--rw-r--r--   0 runner    (1001) docker     (123)     1377 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/resolvers/protection_resolver.py
--rw-r--r--   0 runner    (1001) docker     (123)    13615 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/resolvers/strategy_resolver.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.009684 freqtrade-2023.4/freqtrade/rpc/
--rw-r--r--   0 runner    (1001) docker     (123)      111 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.009684 freqtrade-2023.4/freqtrade/rpc/api_server/
--rw-r--r--   0 runner    (1001) docker     (123)       47 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5388 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/api_auth.py
--rw-r--r--   0 runner    (1001) docker     (123)     9883 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/api_backtest.py
--rw-r--r--   0 runner    (1001) docker     (123)    10640 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/api_schemas.py
--rw-r--r--   0 runner    (1001) docker     (123)    13827 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/api_v1.py
--rw-r--r--   0 runner    (1001) docker     (123)     4200 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/api_ws.py
--rw-r--r--   0 runner    (1001) docker     (123)     1566 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/deps.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.009684 freqtrade-2023.4/freqtrade/rpc/api_server/ui/
--rw-r--r--   0 runner    (1001) docker     (123)      753 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/ui/fallback_file.html
--rw-r--r--   0 runner    (1001) docker     (123)   126794 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/ui/favicon.ico
--rw-r--r--   0 runner    (1001) docker     (123)     2100 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/uvicorn_threaded.py
--rw-r--r--   0 runner    (1001) docker     (123)     2163 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/web_ui.py
--rw-r--r--   0 runner    (1001) docker     (123)     7992 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/webserver.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.009684 freqtrade-2023.4/freqtrade/rpc/api_server/ws/
--rw-r--r--   0 runner    (1001) docker     (123)      419 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/ws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     7570 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/ws/channel.py
--rw-r--r--   0 runner    (1001) docker     (123)      898 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/ws/message_stream.py
--rw-r--r--   0 runner    (1001) docker     (123)     2292 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/ws/proxy.py
--rw-r--r--   0 runner    (1001) docker     (123)     1678 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/ws/serializer.py
--rw-r--r--   0 runner    (1001) docker     (123)      257 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/ws/types.py
--rw-r--r--   0 runner    (1001) docker     (123)     1775 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/api_server/ws_schemas.py
--rw-r--r--   0 runner    (1001) docker     (123)     1944 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/discord.py
--rw-r--r--   0 runner    (1001) docker     (123)    14652 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/external_message_consumer.py
--rw-r--r--   0 runner    (1001) docker     (123)     7243 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/fiat_convert.py
--rw-r--r--   0 runner    (1001) docker     (123)    55689 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/rpc.py
--rw-r--r--   0 runner    (1001) docker     (123)     5294 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/rpc_manager.py
--rw-r--r--   0 runner    (1001) docker     (123)     3061 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/rpc_types.py
--rw-r--r--   0 runner    (1001) docker     (123)    76482 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/telegram.py
--rw-r--r--   0 runner    (1001) docker     (123)     4722 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/rpc/webhook.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.013684 freqtrade-2023.4/freqtrade/strategy/
--rw-r--r--   0 runner    (1001) docker     (123)      650 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/strategy/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     8240 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/strategy/hyper.py
--rw-r--r--   0 runner    (1001) docker     (123)     5671 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/strategy/informative_decorator.py
--rw-r--r--   0 runner    (1001) docker     (123)    65833 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/strategy/interface.py
--rw-r--r--   0 runner    (1001) docker     (123)    12586 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/strategy/parameters.py
--rw-r--r--   0 runner    (1001) docker     (123)     6781 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/strategy/strategy_helper.py
--rw-r--r--   0 runner    (1001) docker     (123)     1568 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/strategy/strategy_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (123)     9774 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/strategy/strategyupdater.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.013684 freqtrade-2023.4/freqtrade/templates/
--rw-r--r--   0 runner    (1001) docker     (123)    12781 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/FreqaiExampleHybridStrategy.py
--rw-r--r--   0 runner    (1001) docker     (123)    12601 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/FreqaiExampleStrategy.py
--rw-r--r--   0 runner    (1001) docker     (123)     2167 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/base_config.json.j2
--rw-r--r--   0 runner    (1001) docker     (123)     6167 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/base_strategy.py.j2
--rw-r--r--   0 runner    (1001) docker     (123)     1917 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/sample_hyperopt_loss.py
--rw-r--r--   0 runner    (1001) docker     (123)    16719 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/sample_strategy.py
--rw-r--r--   0 runner    (1001) docker     (123)    14583 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_analysis_example.ipynb
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.013684 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/
--rw-r--r--   0 runner    (1001) docker     (123)      261 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/buy_trend_full.j2
--rw-r--r--   0 runner    (1001) docker     (123)      101 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/buy_trend_minimal.j2
--rw-r--r--   0 runner    (1001) docker     (123)     7747 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/indicators_full.j2
--rw-r--r--   0 runner    (1001) docker     (123)      464 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/indicators_minimal.j2
--rw-r--r--   0 runner    (1001) docker     (123)      506 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/plot_config_full.j2
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/plot_config_minimal.j2
--rw-r--r--   0 runner    (1001) docker     (123)      262 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/sell_trend_full.j2
--rw-r--r--   0 runner    (1001) docker     (123)      103 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/sell_trend_minimal.j2
--rw-r--r--   0 runner    (1001) docker     (123)    15312 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/strategy_methods_advanced.j2
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/strategy_methods_empty.j2
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.013684 freqtrade-2023.4/freqtrade/templates/subtemplates/
--rw-r--r--   0 runner    (1001) docker     (123)      261 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/subtemplates/exchange_binance.j2
--rw-r--r--   0 runner    (1001) docker     (123)      483 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/subtemplates/exchange_bittrex.j2
--rw-r--r--   0 runner    (1001) docker     (123)      271 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/subtemplates/exchange_gateio.j2
--rw-r--r--   0 runner    (1001) docker     (123)      244 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/subtemplates/exchange_generic.j2
--rw-r--r--   0 runner    (1001) docker     (123)      260 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/subtemplates/exchange_huobi.j2
--rw-r--r--   0 runner    (1001) docker     (123)      413 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/subtemplates/exchange_kraken.j2
--rw-r--r--   0 runner    (1001) docker     (123)      291 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/subtemplates/exchange_kucoin.j2
--rw-r--r--   0 runner    (1001) docker     (123)      291 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/templates/subtemplates/exchange_okex.j2
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.017684 freqtrade-2023.4/freqtrade/util/
--rw-r--r--   0 runner    (1001) docker     (123)      132 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/util/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2718 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/util/binance_mig.py
--rw-r--r--   0 runner    (1001) docker     (123)      337 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/util/ft_precise.py
--rw-r--r--   0 runner    (1001) docker     (123)      458 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/util/gc_setup.py
--rw-r--r--   0 runner    (1001) docker     (123)      580 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/util/periodic_cache.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.017684 freqtrade-2023.4/freqtrade/vendor/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/vendor/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.017684 freqtrade-2023.4/freqtrade/vendor/qtpylib/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/vendor/qtpylib/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    19870 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/vendor/qtpylib/indicators.py
--rw-r--r--   0 runner    (1001) docker     (123)    13551 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/wallets.py
--rw-r--r--   0 runner    (1001) docker     (123)     8487 2023-04-25 14:49:48.000000 freqtrade-2023.4/freqtrade/worker.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:51.981684 freqtrade-2023.4/freqtrade.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)    12539 2023-04-25 14:49:51.000000 freqtrade-2023.4/freqtrade.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)    13628 2023-04-25 14:49:51.000000 freqtrade-2023.4/freqtrade.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-04-25 14:49:51.000000 freqtrade-2023.4/freqtrade.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)       50 2023-04-25 14:49:51.000000 freqtrade-2023.4/freqtrade.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-04-25 14:49:51.000000 freqtrade-2023.4/freqtrade.egg-info/not-zip-safe
--rw-r--r--   0 runner    (1001) docker     (123)     1323 2023-04-25 14:49:51.000000 freqtrade-2023.4/freqtrade.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)       16 2023-04-25 14:49:51.000000 freqtrade-2023.4/freqtrade.egg-info/top_level.txt
--rw-r--r--   0 runner    (1001) docker     (123)     1727 2023-04-25 14:49:48.000000 freqtrade-2023.4/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)     1227 2023-04-25 14:49:52.029684 freqtrade-2023.4/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (123)     1934 2023-04-25 14:49:48.000000 freqtrade-2023.4/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.017684 freqtrade-2023.4/tests/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.021684 freqtrade-2023.4/tests/commands/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/commands/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     4444 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/commands/test_build_config.py
--rw-r--r--   0 runner    (1001) docker     (123)    52543 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/commands/test_commands.py
--rw-r--r--   0 runner    (1001) docker     (123)   124895 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/conftest.py
--rw-r--r--   0 runner    (1001) docker     (123)    14607 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/conftest_trades.py
--rw-r--r--   0 runner    (1001) docker     (123)    10612 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/conftest_trades_usdt.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.021684 freqtrade-2023.4/tests/data/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    18984 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/data/test_btanalysis.py
--rw-r--r--   0 runner    (1001) docker     (123)    12997 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/data/test_converter.py
--rw-r--r--   0 runner    (1001) docker     (123)    21704 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/data/test_datahandler.py
--rw-r--r--   0 runner    (1001) docker     (123)    19077 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/data/test_dataprovider.py
--rw-r--r--   0 runner    (1001) docker     (123)     8070 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/data/test_entryexitanalysis.py
--rw-r--r--   0 runner    (1001) docker     (123)    26838 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/data/test_history.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.021684 freqtrade-2023.4/tests/edge/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/edge/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    20672 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/edge/test_edge.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.021684 freqtrade-2023.4/tests/exchange/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    21890 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_binance.py
--rw-r--r--   0 runner    (1001) docker     (123)     2717 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_bitpanda.py
--rw-r--r--   0 runner    (1001) docker     (123)     3199 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_bybit.py
--rw-r--r--   0 runner    (1001) docker     (123)    30064 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_ccxt_compat.py
--rw-r--r--   0 runner    (1001) docker     (123)     2525 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_ccxt_precise.py
--rw-r--r--   0 runner    (1001) docker     (123)   218526 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_exchange.py
--rw-r--r--   0 runner    (1001) docker     (123)     3556 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_exchange_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     3959 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_gate.py
--rw-r--r--   0 runner    (1001) docker     (123)     4979 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_huobi.py
--rw-r--r--   0 runner    (1001) docker     (123)    10785 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_kraken.py
--rw-r--r--   0 runner    (1001) docker     (123)     6641 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_kucoin.py
--rw-r--r--   0 runner    (1001) docker     (123)    22177 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/exchange/test_okx.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.025684 freqtrade-2023.4/tests/optimize/
--rw-r--r--   0 runner    (1001) docker     (123)     2213 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2073 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/conftest.py
--rw-r--r--   0 runner    (1001) docker     (123)    43247 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/test_backtest_detail.py
--rw-r--r--   0 runner    (1001) docker     (123)    82510 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/test_backtesting.py
--rw-r--r--   0 runner    (1001) docker     (123)     7660 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/test_backtesting_adjust_position.py
--rw-r--r--   0 runner    (1001) docker     (123)     4236 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/test_edge_cli.py
--rw-r--r--   0 runner    (1001) docker     (123)    44327 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/test_hyperopt.py
--rw-r--r--   0 runner    (1001) docker     (123)    12797 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/test_hyperopt_tools.py
--rw-r--r--   0 runner    (1001) docker     (123)     5541 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/test_hyperoptloss.py
--rw-r--r--   0 runner    (1001) docker     (123)    20805 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/optimize/test_optimize_reports.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.025684 freqtrade-2023.4/tests/persistence/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/persistence/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2942 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/persistence/test_key_value_store.py
--rw-r--r--   0 runner    (1001) docker     (123)    15699 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/persistence/test_migrations.py
--rw-r--r--   0 runner    (1001) docker     (123)    99646 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/persistence/test_persistence.py
--rw-r--r--   0 runner    (1001) docker     (123)     6514 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/persistence/test_trade_fromjson.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.025684 freqtrade-2023.4/tests/plugins/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/plugins/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    65213 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/plugins/test_pairlist.py
--rw-r--r--   0 runner    (1001) docker     (123)     5655 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/plugins/test_pairlocks.py
--rw-r--r--   0 runner    (1001) docker     (123)    19048 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/plugins/test_protections.py
--rw-r--r--   0 runner    (1001) docker     (123)     6300 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/plugins/test_remotepairlist.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.025684 freqtrade-2023.4/tests/rpc/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/rpc/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     7356 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/rpc/test_fiat_convert.py
--rw-r--r--   0 runner    (1001) docker     (123)    43368 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/rpc/test_rpc.py
--rw-r--r--   0 runner    (1001) docker     (123)    69423 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/rpc/test_rpc_apiserver.py
--rw-r--r--   0 runner    (1001) docker     (123)    14480 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/rpc/test_rpc_emc.py
--rw-r--r--   0 runner    (1001) docker     (123)     9666 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/rpc/test_rpc_manager.py
--rw-r--r--   0 runner    (1001) docker     (123)    90265 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/rpc/test_rpc_telegram.py
--rw-r--r--   0 runner    (1001) docker     (123)    17078 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/rpc/test_rpc_webhook.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:52.029684 freqtrade-2023.4/tests/strategy/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/strategy/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2202 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/strategy/test_default_strategy.py
--rw-r--r--   0 runner    (1001) docker     (123)    41178 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/strategy/test_interface.py
--rw-r--r--   0 runner    (1001) docker     (123)    13011 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/strategy/test_strategy_helpers.py
--rw-r--r--   0 runner    (1001) docker     (123)    18658 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/strategy/test_strategy_loading.py
--rw-r--r--   0 runner    (1001) docker     (123)     9004 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_arguments.py
--rw-r--r--   0 runner    (1001) docker     (123)     1761 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_binance_mig.py
--rw-r--r--   0 runner    (1001) docker     (123)    58608 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_configuration.py
--rw-r--r--   0 runner    (1001) docker     (123)     4395 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_directory_operations.py
--rw-r--r--   0 runner    (1001) docker     (123)   232129 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_freqtradebot.py
--rw-r--r--   0 runner    (1001) docker     (123)      880 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_indicators.py
--rw-r--r--   0 runner    (1001) docker     (123)    20426 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_integration.py
--rw-r--r--   0 runner    (1001) docker     (123)     8293 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_main.py
--rw-r--r--   0 runner    (1001) docker     (123)     9765 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_misc.py
--rw-r--r--   0 runner    (1001) docker     (123)      867 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_periodiccache.py
--rw-r--r--   0 runner    (1001) docker     (123)    20021 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_plotting.py
--rw-r--r--   0 runner    (1001) docker     (123)     6750 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_strategy_updater.py
--rw-r--r--   0 runner    (1001) docker     (123)      414 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_talib.py
--rw-r--r--   0 runner    (1001) docker     (123)     3534 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_timerange.py
--rw-r--r--   0 runner    (1001) docker     (123)    13076 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_wallets.py
--rw-r--r--   0 runner    (1001) docker     (123)     6719 2023-04-25 14:49:48.000000 freqtrade-2023.4/tests/test_worker.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.912543 freqtrade-2023.5/
+-rw-r--r--   0 runner    (1001) docker     (123)    35141 2023-05-28 18:36:04.000000 freqtrade-2023.5/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (123)      277 2023-05-28 18:36:04.000000 freqtrade-2023.5/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (123)    12539 2023-05-28 18:36:08.912543 freqtrade-2023.5/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)    11477 2023-05-28 18:36:04.000000 freqtrade-2023.5/README.md
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.832542 freqtrade-2023.5/freqtrade/
+-rw-r--r--   0 runner    (1001) docker     (123)      810 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)      206 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/__main__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.836542 freqtrade-2023.5/freqtrade/commands/
+-rw-r--r--   0 runner    (1001) docker     (123)     1741 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2171 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/analyze_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21033 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/arguments.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8813 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/build_config_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22324 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/cli_options.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9009 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/data_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1672 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/db_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6530 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/deploy_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3634 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/hyperopt_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9277 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/list_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4513 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/optimize_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1360 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/pairlist_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1162 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/plot_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1852 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/strategy_utils_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)      936 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/trade_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)      416 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/commands/webserver_commands.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.840542 freqtrade-2023.5/freqtrade/configuration/
+-rw-r--r--   0 runner    (1001) docker     (123)      299 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/configuration/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      723 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/configuration/config_setup.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17385 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/configuration/config_validation.py
+-rw-r--r--   0 runner    (1001) docker     (123)    24880 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/configuration/configuration.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7035 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/configuration/deprecated_settings.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3592 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/configuration/directory_operations.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1814 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/configuration/environment_vars.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3851 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/configuration/load_config.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6263 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/configuration/timerange.py
+-rw-r--r--   0 runner    (1001) docker     (123)    29286 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/constants.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.840542 freqtrade-2023.5/freqtrade/data/
+-rw-r--r--   0 runner    (1001) docker     (123)      152 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    16153 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/btanalysis.py
+-rw-r--r--   0 runner    (1001) docker     (123)    13517 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/converter.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21145 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/dataprovider.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12843 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/entryexitanalysis.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.840542 freqtrade-2023.5/freqtrade/data/history/
+-rw-r--r--   0 runner    (1001) docker     (123)      465 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/history/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4903 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/history/featherdatahandler.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6094 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/history/hdf5datahandler.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21512 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/history/history_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17490 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/history/idatahandler.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5580 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/history/jsondatahandler.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4798 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/history/parquetdatahandler.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12466 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/data/metrics.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.840542 freqtrade-2023.5/freqtrade/edge/
+-rw-r--r--   0 runner    (1001) docker     (123)       59 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/edge/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20869 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/edge/edge_positioning.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.844542 freqtrade-2023.5/freqtrade/enums/
+-rw-r--r--   0 runner    (1001) docker     (123)      861 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      238 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/backteststate.py
+-rw-r--r--   0 runner    (1001) docker     (123)      798 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/candletype.py
+-rw-r--r--   0 runner    (1001) docker     (123)      640 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/exitchecktuple.py
+-rw-r--r--   0 runner    (1001) docker     (123)      619 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/exittype.py
+-rw-r--r--   0 runner    (1001) docker     (123)      210 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/hyperoptstate.py
+-rw-r--r--   0 runner    (1001) docker     (123)      237 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/marginmode.py
+-rw-r--r--   0 runner    (1001) docker     (123)      261 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/marketstatetype.py
+-rw-r--r--   0 runner    (1001) docker     (123)      100 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/ordertypevalue.py
+-rw-r--r--   0 runner    (1001) docker     (123)      177 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/pricetype.py
+-rw-r--r--   0 runner    (1001) docker     (123)      976 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/rpcmessagetype.py
+-rw-r--r--   0 runner    (1001) docker     (123)      592 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/runmode.py
+-rw-r--r--   0 runner    (1001) docker     (123)      626 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/signaltype.py
+-rw-r--r--   0 runner    (1001) docker     (123)      202 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/state.py
+-rw-r--r--   0 runner    (1001) docker     (123)      220 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/enums/tradingmode.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2068 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exceptions.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.848542 freqtrade-2023.5/freqtrade/exchange/
+-rw-r--r--   0 runner    (1001) docker     (123)     1540 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9455 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/binance.py
+-rw-r--r--   0 runner    (1001) docker     (123)   632547 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/binance_leverage_tiers.json
+-rw-r--r--   0 runner    (1001) docker     (123)     1621 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/bitpanda.py
+-rw-r--r--   0 runner    (1001) docker     (123)      517 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/bittrex.py
+-rw-r--r--   0 runner    (1001) docker     (123)      547 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/bitvavo.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8304 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/bybit.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2975 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/check_exchange.py
+-rw-r--r--   0 runner    (1001) docker     (123)      564 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/coinbasepro.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6112 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/common.py
+-rw-r--r--   0 runner    (1001) docker     (123)   131874 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/exchange.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10553 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/exchange_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5035 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/gate.py
+-rw-r--r--   0 runner    (1001) docker     (123)      517 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/hitbtc.py
+-rw-r--r--   0 runner    (1001) docker     (123)      827 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/huobi.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9717 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/kraken.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2120 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/kucoin.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8695 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/okx.py
+-rw-r--r--   0 runner    (1001) docker     (123)      725 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/exchange/types.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.852542 freqtrade-2023.5/freqtrade/freqai/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.852542 freqtrade-2023.5/freqtrade/freqai/RL/
+-rw-r--r--   0 runner    (1001) docker     (123)     4496 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/RL/Base3ActionRLEnv.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5021 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/RL/Base4ActionRLEnv.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5644 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/RL/Base5ActionRLEnv.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15138 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/RL/BaseEnvironment.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20053 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/RL/BaseReinforcementLearningModel.py
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/RL/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.852542 freqtrade-2023.5/freqtrade/freqai/base_models/
+-rw-r--r--   0 runner    (1001) docker     (123)     4320 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/base_models/BaseClassifierModel.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5700 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/base_models/BasePyTorchClassifier.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2985 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/base_models/BasePyTorchModel.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1768 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/base_models/BasePyTorchRegressor.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4054 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/base_models/BaseRegressionModel.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2572 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/base_models/BaseTensorFlowModel.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3466 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/base_models/FreqaiMultiOutputClassifier.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2502 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/base_models/FreqaiMultiOutputRegressor.py
+-rw-r--r--   0 runner    (1001) docker     (123)    30241 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/data_drawer.py
+-rw-r--r--   0 runner    (1001) docker     (123)    65930 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/data_kitchen.py
+-rw-r--r--   0 runner    (1001) docker     (123)    44639 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/freqai_interface.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.860542 freqtrade-2023.5/freqtrade/freqai/prediction_models/
+-rw-r--r--   0 runner    (1001) docker     (123)     2083 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/CatboostClassifier.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2866 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/CatboostClassifierMultiTarget.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2048 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/CatboostRegressor.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2834 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/CatboostRegressorMultiTarget.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1920 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/LightGBMClassifier.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2698 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/LightGBMClassifierMultiTarget.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1837 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/LightGBMRegressor.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2692 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/LightGBMRegressorMultiTarget.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3634 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/PyTorchMLPClassifier.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3320 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/PyTorchMLPRegressor.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5635 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/PyTorchTransformerRegressor.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6732 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/ReinforcementLearner.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2981 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/ReinforcementLearner_multiproc.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3338 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/XGBoostClassifier.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3345 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/XGBoostRFClassifier.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1844 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/XGBoostRFRegressor.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2104 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/XGBoostRegressor.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2596 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/XGBoostRegressorMultiTarget.py
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/prediction_models/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.860542 freqtrade-2023.5/freqtrade/freqai/tensorboard/
+-rw-r--r--   0 runner    (1001) docker     (123)     2166 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/tensorboard/TensorboardCallback.py
+-rw-r--r--   0 runner    (1001) docker     (123)      587 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/tensorboard/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      690 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/tensorboard/base_tensorboard.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1926 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/tensorboard/tensorboard.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.860542 freqtrade-2023.5/freqtrade/freqai/torch/
+-rw-r--r--   0 runner    (1001) docker     (123)     2028 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/torch/PyTorchDataConvertor.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3762 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/torch/PyTorchMLPModel.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8903 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/torch/PyTorchModelTrainer.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2026 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/torch/PyTorchTrainerInterface.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3613 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/torch/PyTorchTransformerModel.py
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/torch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      666 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/torch/datasets.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7382 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqai/utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    95442 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/freqtradebot.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.864542 freqtrade-2023.5/freqtrade/leverage/
+-rw-r--r--   0 runner    (1001) docker     (123)       63 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/leverage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1257 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/leverage/interest.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.864542 freqtrade-2023.5/freqtrade/loggers/
+-rw-r--r--   0 runner    (1001) docker     (123)     4942 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/loggers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      460 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/loggers/buffering_handler.py
+-rw-r--r--   0 runner    (1001) docker     (123)      714 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/loggers/std_err_stream_handler.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     2094 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/main.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9450 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/misc.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.864542 freqtrade-2023.5/freqtrade/mixins/
+-rw-r--r--   0 runner    (1001) docker     (123)       70 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/mixins/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1265 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/mixins/logging_mixin.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.864542 freqtrade-2023.5/freqtrade/optimize/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1519 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/backtest_caching.py
+-rw-r--r--   0 runner    (1001) docker     (123)    64916 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/backtesting.py
+-rw-r--r--   0 runner    (1001) docker     (123)      856 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/bt_progress.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1823 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/edge_cli.py
+-rw-r--r--   0 runner    (1001) docker     (123)    28627 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3676 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_auto.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4525 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_epoch_filters.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8554 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_interface.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.868543 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/
+-rw-r--r--   0 runner    (1001) docker     (123)     1102 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_calmar.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1237 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_max_drawdown.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1470 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_max_drawdown_relative.py
+-rw-r--r--   0 runner    (1001) docker     (123)      746 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_onlyprofit.py
+-rw-r--r--   0 runner    (1001) docker     (123)      931 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_profit_drawdown.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1095 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sharpe.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2108 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sharpe_daily.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1965 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_short_trade_dur.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1109 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sortino.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2566 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sortino_daily.py
+-rw-r--r--   0 runner    (1001) docker     (123)      951 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_loss_interface.py
+-rw-r--r--   0 runner    (1001) docker     (123)    23094 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/hyperopt_tools.py
+-rw-r--r--   0 runner    (1001) docker     (123)    45232 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/optimize_reports.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.868543 freqtrade-2023.5/freqtrade/optimize/space/
+-rw-r--r--   0 runner    (1001) docker     (123)      127 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/space/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1391 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/optimize/space/decimalspace.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.868543 freqtrade-2023.5/freqtrade/persistence/
+-rw-r--r--   0 runner    (1001) docker     (123)      284 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/persistence/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      154 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/persistence/base.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6441 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/persistence/key_value_store.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15663 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/persistence/migrations.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2926 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/persistence/models.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3103 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/persistence/pairlock.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6366 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/persistence/pairlock_middleware.py
+-rw-r--r--   0 runner    (1001) docker     (123)    72288 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/persistence/trade_model.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.868543 freqtrade-2023.5/freqtrade/plot/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plot/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26157 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plot/plotting.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.872542 freqtrade-2023.5/freqtrade/plugins/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.872542 freqtrade-2023.5/freqtrade/plugins/pairlist/
+-rw-r--r--   0 runner    (1001) docker     (123)     5739 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/AgeFilter.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7375 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/IPairList.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2258 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/OffsetFilter.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3259 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/PerformanceFilter.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2957 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/PrecisionFilter.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5426 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/PriceFilter.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3180 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/ProducerPairList.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8104 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/RemotePairList.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2874 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/ShuffleFilter.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2505 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/SpreadFilter.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2369 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/StaticPairList.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5005 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/VolatilityFilter.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10935 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/VolumePairList.py
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2347 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/pairlist_helpers.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5402 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlist/rangestabilityfilter.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6881 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/pairlistmanager.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2872 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/protectionmanager.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.876543 freqtrade-2023.5/freqtrade/plugins/protections/
+-rw-r--r--   0 runner    (1001) docker     (123)      105 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/protections/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2707 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/protections/cooldown_period.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4268 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/protections/iprotection.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3607 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/protections/low_profit_pairs.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3544 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/protections/max_drawdown_protection.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3691 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/plugins/protections/stoploss_guard.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.876543 freqtrade-2023.5/freqtrade/resolvers/
+-rw-r--r--   0 runner    (1001) docker     (123)      512 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/resolvers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2618 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/resolvers/exchange_resolver.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1799 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/resolvers/freqaimodel_resolver.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1727 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/resolvers/hyperopt_resolver.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10493 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/resolvers/iresolver.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1794 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/resolvers/pairlist_resolver.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1377 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/resolvers/protection_resolver.py
+-rw-r--r--   0 runner    (1001) docker     (123)    13615 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/resolvers/strategy_resolver.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.884543 freqtrade-2023.5/freqtrade/rpc/
+-rw-r--r--   0 runner    (1001) docker     (123)      111 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.884543 freqtrade-2023.5/freqtrade/rpc/api_server/
+-rw-r--r--   0 runner    (1001) docker     (123)       47 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5388 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/api_auth.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9537 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/api_backtest.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10836 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/api_schemas.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14352 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/api_v1.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4200 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/api_ws.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1583 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/deps.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.884543 freqtrade-2023.5/freqtrade/rpc/api_server/ui/
+-rw-r--r--   0 runner    (1001) docker     (123)      753 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/ui/fallback_file.html
+-rw-r--r--   0 runner    (1001) docker     (123)   126794 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/ui/favicon.ico
+-rw-r--r--   0 runner    (1001) docker     (123)     2100 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/uvicorn_threaded.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2163 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/web_ui.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7693 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/webserver.py
+-rw-r--r--   0 runner    (1001) docker     (123)      342 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/webserver_bgwork.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.884543 freqtrade-2023.5/freqtrade/rpc/api_server/ws/
+-rw-r--r--   0 runner    (1001) docker     (123)      419 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/ws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7570 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/ws/channel.py
+-rw-r--r--   0 runner    (1001) docker     (123)      898 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/ws/message_stream.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2292 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/ws/proxy.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1678 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/ws/serializer.py
+-rw-r--r--   0 runner    (1001) docker     (123)      257 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/ws/types.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1775 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/api_server/ws_schemas.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1944 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/discord.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14652 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/external_message_consumer.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7243 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/fiat_convert.py
+-rw-r--r--   0 runner    (1001) docker     (123)    57320 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/rpc.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5294 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/rpc_manager.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3061 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/rpc_types.py
+-rw-r--r--   0 runner    (1001) docker     (123)    79414 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/telegram.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4738 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/rpc/webhook.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.884543 freqtrade-2023.5/freqtrade/strategy/
+-rw-r--r--   0 runner    (1001) docker     (123)      650 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/strategy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8240 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/strategy/hyper.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5671 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/strategy/informative_decorator.py
+-rw-r--r--   0 runner    (1001) docker     (123)    65823 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/strategy/interface.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12586 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/strategy/parameters.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6781 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/strategy/strategy_helper.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1568 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/strategy/strategy_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9774 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/strategy/strategyupdater.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.888543 freqtrade-2023.5/freqtrade/templates/
+-rw-r--r--   0 runner    (1001) docker     (123)    12781 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/FreqaiExampleHybridStrategy.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12688 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/FreqaiExampleStrategy.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2167 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/base_config.json.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     6167 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/base_strategy.py.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     1917 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/sample_hyperopt_loss.py
+-rw-r--r--   0 runner    (1001) docker     (123)    16719 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/sample_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14583 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_analysis_example.ipynb
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.892543 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/
+-rw-r--r--   0 runner    (1001) docker     (123)      261 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/buy_trend_full.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      101 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/buy_trend_minimal.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     7747 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/indicators_full.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      464 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/indicators_minimal.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      506 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/plot_config_full.j2
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/plot_config_minimal.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      262 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/sell_trend_full.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      103 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/sell_trend_minimal.j2
+-rw-r--r--   0 runner    (1001) docker     (123)    15312 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/strategy_methods_advanced.j2
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/strategy_methods_empty.j2
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.892543 freqtrade-2023.5/freqtrade/templates/subtemplates/
+-rw-r--r--   0 runner    (1001) docker     (123)      261 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/subtemplates/exchange_binance.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      483 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/subtemplates/exchange_bittrex.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      271 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/subtemplates/exchange_gateio.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      244 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/subtemplates/exchange_generic.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      260 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/subtemplates/exchange_huobi.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      413 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/subtemplates/exchange_kraken.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      291 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/subtemplates/exchange_kucoin.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      291 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/templates/subtemplates/exchange_okex.j2
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.892543 freqtrade-2023.5/freqtrade/util/
+-rw-r--r--   0 runner    (1001) docker     (123)      442 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/util/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2718 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/util/binance_mig.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1846 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/util/datetime_helpers.py
+-rw-r--r--   0 runner    (1001) docker     (123)      337 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/util/ft_precise.py
+-rw-r--r--   0 runner    (1001) docker     (123)      458 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/util/gc_setup.py
+-rw-r--r--   0 runner    (1001) docker     (123)      580 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/util/periodic_cache.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.892543 freqtrade-2023.5/freqtrade/vendor/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/vendor/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.892543 freqtrade-2023.5/freqtrade/vendor/qtpylib/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/vendor/qtpylib/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19870 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/vendor/qtpylib/indicators.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14830 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/wallets.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8487 2023-05-28 18:36:04.000000 freqtrade-2023.5/freqtrade/worker.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.832542 freqtrade-2023.5/freqtrade.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)    12539 2023-05-28 18:36:08.000000 freqtrade-2023.5/freqtrade.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)    13938 2023-05-28 18:36:08.000000 freqtrade-2023.5/freqtrade.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-28 18:36:08.000000 freqtrade-2023.5/freqtrade.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       50 2023-05-28 18:36:08.000000 freqtrade-2023.5/freqtrade.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-28 18:36:08.000000 freqtrade-2023.5/freqtrade.egg-info/not-zip-safe
+-rw-r--r--   0 runner    (1001) docker     (123)     1697 2023-05-28 18:36:08.000000 freqtrade-2023.5/freqtrade.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       16 2023-05-28 18:36:08.000000 freqtrade-2023.5/freqtrade.egg-info/top_level.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     1727 2023-05-28 18:36:04.000000 freqtrade-2023.5/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)     1227 2023-05-28 18:36:08.912543 freqtrade-2023.5/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (123)     2291 2023-05-28 18:36:04.000000 freqtrade-2023.5/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.896543 freqtrade-2023.5/tests/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.900543 freqtrade-2023.5/tests/commands/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/commands/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4444 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/commands/test_build_config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    52582 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/commands/test_commands.py
+-rw-r--r--   0 runner    (1001) docker     (123)   124669 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/conftest.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14607 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/conftest_trades.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10612 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/conftest_trades_usdt.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.900543 freqtrade-2023.5/tests/data/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19274 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/data/test_btanalysis.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12997 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/data/test_converter.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21704 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/data/test_datahandler.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19077 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/data/test_dataprovider.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8496 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/data/test_entryexitanalysis.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26738 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/data/test_history.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.904543 freqtrade-2023.5/tests/edge/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/edge/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20687 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/edge/test_edge.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.904543 freqtrade-2023.5/tests/exchange/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21890 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_binance.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2717 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_bitpanda.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3199 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_bybit.py
+-rw-r--r--   0 runner    (1001) docker     (123)    30479 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_ccxt_compat.py
+-rw-r--r--   0 runner    (1001) docker     (123)   221081 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_exchange.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3556 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_exchange_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3959 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_gate.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4979 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_huobi.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10785 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_kraken.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6641 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_kucoin.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22177 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/exchange/test_okx.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.904543 freqtrade-2023.5/tests/optimize/
+-rw-r--r--   0 runner    (1001) docker     (123)     2276 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2073 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/conftest.py
+-rw-r--r--   0 runner    (1001) docker     (123)    43247 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/test_backtest_detail.py
+-rw-r--r--   0 runner    (1001) docker     (123)    82511 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/test_backtesting.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7655 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/test_backtesting_adjust_position.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4236 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/test_edge_cli.py
+-rw-r--r--   0 runner    (1001) docker     (123)    44215 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/test_hyperopt.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12797 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/test_hyperopt_tools.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5541 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/test_hyperoptloss.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20838 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/optimize/test_optimize_reports.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.908543 freqtrade-2023.5/tests/persistence/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/persistence/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2942 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/persistence/test_key_value_store.py
+-rw-r--r--   0 runner    (1001) docker     (123)    16218 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/persistence/test_migrations.py
+-rw-r--r--   0 runner    (1001) docker     (123)    99825 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/persistence/test_persistence.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6514 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/persistence/test_trade_fromjson.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.908543 freqtrade-2023.5/tests/plugins/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/plugins/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    65213 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/plugins/test_pairlist.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5604 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/plugins/test_pairlocks.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19094 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/plugins/test_protections.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6300 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/plugins/test_remotepairlist.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.908543 freqtrade-2023.5/tests/rpc/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/rpc/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7356 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/rpc/test_fiat_convert.py
+-rw-r--r--   0 runner    (1001) docker     (123)    44020 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/rpc/test_rpc.py
+-rw-r--r--   0 runner    (1001) docker     (123)    71301 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/rpc/test_rpc_apiserver.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14480 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/rpc/test_rpc_emc.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9666 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/rpc/test_rpc_manager.py
+-rw-r--r--   0 runner    (1001) docker     (123)    94365 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/rpc/test_rpc_telegram.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17192 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/rpc/test_rpc_webhook.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:08.912543 freqtrade-2023.5/tests/strategy/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/strategy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2230 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/strategy/test_default_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (123)    40824 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/strategy/test_interface.py
+-rw-r--r--   0 runner    (1001) docker     (123)    13011 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/strategy/test_strategy_helpers.py
+-rw-r--r--   0 runner    (1001) docker     (123)    18658 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/strategy/test_strategy_loading.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9004 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_arguments.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1761 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_binance_mig.py
+-rw-r--r--   0 runner    (1001) docker     (123)    58618 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_configuration.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4395 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_directory_operations.py
+-rw-r--r--   0 runner    (1001) docker     (123)   235594 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_freqtradebot.py
+-rw-r--r--   0 runner    (1001) docker     (123)      880 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_indicators.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20485 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_integration.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8293 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_main.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9552 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_misc.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19996 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_plotting.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6787 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_strategy_updater.py
+-rw-r--r--   0 runner    (1001) docker     (123)      414 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_talib.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3539 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_timerange.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15063 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_wallets.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6719 2023-05-28 18:36:04.000000 freqtrade-2023.5/tests/test_worker.py
```

### Comparing `freqtrade-2023.4/LICENSE` & `freqtrade-2023.5/LICENSE`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/PKG-INFO` & `freqtrade-2023.5/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: freqtrade
-Version: 2023.4
+Version: 2023.5
 Summary: Freqtrade - Crypto Trading Bot
 Home-page: https://github.com/freqtrade/freqtrade
 Author: Freqtrade Team
 Author-email: freqtrade@protonmail.com
 License: GPLv3
 Project-URL: Bug Tracker, https://github.com/freqtrade/freqtrade/issues
 Classifier: Environment :: Console
```

### Comparing `freqtrade-2023.4/README.md` & `freqtrade-2023.5/README.md`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/__init__.py` & `freqtrade-2023.5/freqtrade/__init__.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,9 +1,9 @@
 """ Freqtrade bot """
-__version__ = '2023.4'
+__version__ = '2023.5'
 
 if 'dev' in __version__:
     from pathlib import Path
     try:
         import subprocess
         freqtrade_basedir = Path(__file__).parent
```

### Comparing `freqtrade-2023.4/freqtrade/commands/__init__.py` & `freqtrade-2023.5/freqtrade/commands/__init__.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/commands/analyze_commands.py` & `freqtrade-2023.5/freqtrade/commands/analyze_commands.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/commands/arguments.py` & `freqtrade-2023.5/freqtrade/commands/arguments.py`

 * *Files 0% similar despite different names*

```diff
@@ -102,15 +102,16 @@
                       "hyperoptexportfilename", "export_csv"]
 
 ARGS_HYPEROPT_SHOW = ["hyperopt_list_best", "hyperopt_list_profitable", "hyperopt_show_index",
                       "print_json", "hyperoptexportfilename", "hyperopt_show_no_header",
                       "disableparamexport", "backtest_breakdown"]
 
 ARGS_ANALYZE_ENTRIES_EXITS = ["exportfilename", "analysis_groups", "enter_reason_list",
-                              "exit_reason_list", "indicator_list", "timerange"]
+                              "exit_reason_list", "indicator_list", "timerange",
+                              "analysis_rejected", "analysis_to_csv", "analysis_csv_path"]
 
 NO_CONF_REQURIED = ["convert-data", "convert-trade-data", "download-data", "list-timeframes",
                     "list-markets", "list-pairs", "list-strategies", "list-freqaimodels",
                     "list-data", "hyperopt-list", "hyperopt-show", "backtest-filter",
                     "plot-dataframe", "plot-profit", "show-trades", "trades-to-ohlcv",
                     "strategy-updater"]
```

### Comparing `freqtrade-2023.4/freqtrade/commands/build_config_commands.py` & `freqtrade-2023.5/freqtrade/commands/build_config_commands.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/commands/cli_options.py` & `freqtrade-2023.5/freqtrade/commands/cli_options.py`

 * *Files 2% similar despite different names*

```diff
@@ -632,38 +632,53 @@
               "0: simple wins/losses by enter tag, "
               "1: by enter_tag, "
               "2: by enter_tag and exit_tag, "
               "3: by pair and enter_tag, "
               "4: by pair, enter_ and exit_tag (this can get quite large), "
               "5: by exit_tag"),
         nargs='+',
-        default=['0', '1', '2'],
+        default=[],
         choices=['0', '1', '2', '3', '4', '5'],
     ),
     "enter_reason_list": Arg(
         "--enter-reason-list",
-        help=("Comma separated list of entry signals to analyse. Default: all. "
-              "e.g. 'entry_tag_a,entry_tag_b'"),
+        help=("Space separated list of entry signals to analyse. Default: all. "
+              "e.g. 'entry_tag_a entry_tag_b'"),
         nargs='+',
         default=['all'],
     ),
     "exit_reason_list": Arg(
         "--exit-reason-list",
-        help=("Comma separated list of exit signals to analyse. Default: all. "
-              "e.g. 'exit_tag_a,roi,stop_loss,trailing_stop_loss'"),
+        help=("Space separated list of exit signals to analyse. Default: all. "
+              "e.g. 'exit_tag_a roi stop_loss trailing_stop_loss'"),
         nargs='+',
         default=['all'],
     ),
     "indicator_list": Arg(
         "--indicator-list",
-        help=("Comma separated list of indicators to analyse. "
-              "e.g. 'close,rsi,bb_lowerband,profit_abs'"),
+        help=("Space separated list of indicators to analyse. "
+              "e.g. 'close rsi bb_lowerband profit_abs'"),
         nargs='+',
         default=[],
     ),
+    "analysis_rejected": Arg(
+        '--rejected-signals',
+        help='Analyse rejected signals',
+        action='store_true',
+    ),
+    "analysis_to_csv": Arg(
+        '--analysis-to-csv',
+        help='Save selected analysis tables to individual CSVs',
+        action='store_true',
+    ),
+    "analysis_csv_path": Arg(
+        '--analysis-csv-path',
+        help=("Specify a path to save the analysis CSVs "
+              "if --analysis-to-csv is enabled. Default: user_data/basktesting_results/"),
+    ),
     "freqaimodel": Arg(
         '--freqaimodel',
         help='Specify a custom freqaimodels.',
         metavar='NAME',
     ),
     "freqaimodel_path": Arg(
         '--freqaimodel-path',
```

### Comparing `freqtrade-2023.4/freqtrade/commands/data_commands.py` & `freqtrade-2023.5/freqtrade/commands/data_commands.py`

 * *Files 2% similar despite different names*

```diff
@@ -48,15 +48,15 @@
 
     # Remove stake-currency to skip checks which are not relevant for datadownload
     config['stake_currency'] = ''
 
     pairs_not_available: List[str] = []
 
     # Init exchange
-    exchange = ExchangeResolver.load_exchange(config['exchange']['name'], config, validate=False)
+    exchange = ExchangeResolver.load_exchange(config, validate=False)
     markets = [p for p, m in exchange.markets.items() if market_is_active(m)
                or config.get('include_inactive')]
 
     expanded_pairs = dynamic_expand_pairlist(config, markets)
 
     # Manual validations of relevant settings
     if not config['exchange'].get('skip_pair_validation', False):
@@ -121,15 +121,15 @@
 
     if 'pairs' not in config:
         raise OperationalException(
             "Downloading data requires a list of pairs. "
             "Please check the documentation on how to configure this.")
 
     # Init exchange
-    exchange = ExchangeResolver.load_exchange(config['exchange']['name'], config, validate=False)
+    exchange = ExchangeResolver.load_exchange(config, validate=False)
     # Manual validations of relevant settings
     if not config['exchange'].get('skip_pair_validation', False):
         exchange.validate_pairs(config['pairs'])
     expanded_pairs = expand_pairlist(config['pairs'], list(exchange.markets))
 
     logger.info(f"About to Convert pairs: {expanded_pairs}, "
                 f"intervals: {config['timeframes']} to {config['datadir']}")
```

### Comparing `freqtrade-2023.4/freqtrade/commands/db_commands.py` & `freqtrade-2023.5/freqtrade/commands/db_commands.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/commands/deploy_commands.py` & `freqtrade-2023.5/freqtrade/commands/deploy_commands.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/commands/hyperopt_commands.py` & `freqtrade-2023.5/freqtrade/commands/hyperopt_commands.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/commands/list_commands.py` & `freqtrade-2023.5/freqtrade/commands/list_commands.py`

 * *Files 2% similar despite different names*

```diff
@@ -110,15 +110,15 @@
     Print timeframes available on Exchange
     """
     config = setup_utils_configuration(args, RunMode.UTIL_EXCHANGE)
     # Do not use timeframe set in the config
     config['timeframe'] = None
 
     # Init exchange
-    exchange = ExchangeResolver.load_exchange(config['exchange']['name'], config, validate=False)
+    exchange = ExchangeResolver.load_exchange(config, validate=False)
 
     if args['print_one_column']:
         print('\n'.join(exchange.timeframes))
     else:
         print(f"Timeframes available for the exchange `{exchange.name}`: "
               f"{', '.join(exchange.timeframes)}")
 
@@ -129,15 +129,15 @@
     :param args: Cli args from Arguments()
     :param pairs_only: if True print only pairs, otherwise print all instruments (markets)
     :return: None
     """
     config = setup_utils_configuration(args, RunMode.UTIL_EXCHANGE)
 
     # Init exchange
-    exchange = ExchangeResolver.load_exchange(config['exchange']['name'], config, validate=False)
+    exchange = ExchangeResolver.load_exchange(config, validate=False)
 
     # By default only active pairs/markets are to be shown
     active_only = not args.get('list_pairs_all', False)
 
     base_currencies = args.get('base_currencies', [])
     quote_currencies = args.get('quote_currencies', [])
```

### Comparing `freqtrade-2023.4/freqtrade/commands/optimize_commands.py` & `freqtrade-2023.5/freqtrade/commands/optimize_commands.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/commands/pairlist_commands.py` & `freqtrade-2023.5/freqtrade/commands/pairlist_commands.py`

 * *Files 6% similar despite different names*

```diff
@@ -14,15 +14,15 @@
 def start_test_pairlist(args: Dict[str, Any]) -> None:
     """
     Test Pairlist configuration
     """
     from freqtrade.plugins.pairlistmanager import PairListManager
     config = setup_utils_configuration(args, RunMode.UTIL_EXCHANGE)
 
-    exchange = ExchangeResolver.load_exchange(config['exchange']['name'], config, validate=False)
+    exchange = ExchangeResolver.load_exchange(config, validate=False)
 
     quote_currencies = args.get('quote_currencies')
     if not quote_currencies:
         quote_currencies = [config.get('stake_currency')]
     results = {}
     for curr in quote_currencies:
         config['stake_currency'] = curr
```

### Comparing `freqtrade-2023.4/freqtrade/commands/plot_commands.py` & `freqtrade-2023.5/freqtrade/commands/plot_commands.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/commands/strategy_utils_commands.py` & `freqtrade-2023.5/freqtrade/commands/strategy_utils_commands.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/commands/trade_commands.py` & `freqtrade-2023.5/freqtrade/commands/trade_commands.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/configuration/config_setup.py` & `freqtrade-2023.5/freqtrade/configuration/config_setup.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/configuration/config_validation.py` & `freqtrade-2023.5/freqtrade/configuration/config_validation.py`

 * *Files 1% similar despite different names*

```diff
@@ -170,15 +170,15 @@
     Dynamic whitelist does not require pair_whitelist to be set - however StaticWhitelist does.
     """
     if conf.get('runmode', RunMode.OTHER) in [RunMode.OTHER, RunMode.PLOT,
                                               RunMode.UTIL_NO_EXCHANGE, RunMode.UTIL_EXCHANGE]:
         return
 
     for pl in conf.get('pairlists', [{'method': 'StaticPairList'}]):
-        if (pl.get('method') == 'StaticPairList'
+        if (isinstance(pl, dict) and pl.get('method') == 'StaticPairList'
                 and not conf.get('exchange', {}).get('pair_whitelist')):
             raise OperationalException("StaticPairList requires pair_whitelist to be set.")
 
 
 def _validate_protections(conf: Dict[str, Any]) -> None:
     """
     Validate protection configuration validity
```

### Comparing `freqtrade-2023.4/freqtrade/configuration/configuration.py` & `freqtrade-2023.5/freqtrade/configuration/configuration.py`

 * *Files 1% similar despite different names*

```diff
@@ -461,14 +461,23 @@
 
         self._args_to_config(config, argname='indicator_list',
                              logstring='Analysis indicator list: {}')
 
         self._args_to_config(config, argname='timerange',
                              logstring='Filter trades by timerange: {}')
 
+        self._args_to_config(config, argname='analysis_rejected',
+                             logstring='Analyse rejected signals: {}')
+
+        self._args_to_config(config, argname='analysis_to_csv',
+                             logstring='Store analysis tables to CSV: {}')
+
+        self._args_to_config(config, argname='analysis_csv_path',
+                             logstring='Path to store analysis CSVs: {}')
+
     def _process_runmode(self, config: Config) -> None:
 
         self._args_to_config(config, argname='dry_run',
                              logstring='Parameter --dry-run detected, '
                              'overriding dry_run to: {} ...')
 
         if not self.runmode:
```

### Comparing `freqtrade-2023.4/freqtrade/configuration/deprecated_settings.py` & `freqtrade-2023.5/freqtrade/configuration/deprecated_settings.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/configuration/directory_operations.py` & `freqtrade-2023.5/freqtrade/configuration/directory_operations.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/configuration/environment_vars.py` & `freqtrade-2023.5/freqtrade/configuration/environment_vars.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/configuration/load_config.py` & `freqtrade-2023.5/freqtrade/configuration/load_config.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/configuration/timerange.py` & `freqtrade-2023.5/freqtrade/configuration/timerange.py`

 * *Files 3% similar despite different names*

```diff
@@ -2,16 +2,14 @@
 This module contains the argument manager class
 """
 import logging
 import re
 from datetime import datetime, timezone
 from typing import Optional
 
-import arrow
-
 from freqtrade.constants import DATETIME_PRINT_FORMAT
 from freqtrade.exceptions import OperationalException
 
 
 logger = logging.getLogger(__name__)
 
 
@@ -135,24 +133,26 @@
                 rvals = match.groups()
                 index = 0
                 start: int = 0
                 stop: int = 0
                 if stype[0]:
                     starts = rvals[index]
                     if stype[0] == 'date' and len(starts) == 8:
-                        start = arrow.get(starts, 'YYYYMMDD').int_timestamp
+                        start = int(datetime.strptime(starts, '%Y%m%d').replace(
+                            tzinfo=timezone.utc).timestamp())
                     elif len(starts) == 13:
                         start = int(starts) // 1000
                     else:
                         start = int(starts)
                     index += 1
                 if stype[1]:
                     stops = rvals[index]
                     if stype[1] == 'date' and len(stops) == 8:
-                        stop = arrow.get(stops, 'YYYYMMDD').int_timestamp
+                        stop = int(datetime.strptime(stops, '%Y%m%d').replace(
+                            tzinfo=timezone.utc).timestamp())
                     elif len(stops) == 13:
                         stop = int(stops) // 1000
                     else:
                         stop = int(stops)
                 if start > stop > 0:
                     raise OperationalException(
                         f'Start date is after stop date for timerange "{text}"')
```

### Comparing `freqtrade-2023.4/freqtrade/constants.py` & `freqtrade-2023.5/freqtrade/constants.py`

 * *Files 0% similar despite different names*

```diff
@@ -686,8 +686,10 @@
 EntryExit = Literal['entry', 'exit']
 BuySell = Literal['buy', 'sell']
 MakerTaker = Literal['maker', 'taker']
 BidAsk = Literal['bid', 'ask']
 OBLiteral = Literal['asks', 'bids']
 
 Config = Dict[str, Any]
+# Exchange part of the configuration.
+ExchangeConfig = Dict[str, Any]
 IntOrInf = float
```

### Comparing `freqtrade-2023.4/freqtrade/data/btanalysis.py` & `freqtrade-2023.5/freqtrade/data/btanalysis.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/data/converter.py` & `freqtrade-2023.5/freqtrade/data/converter.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/data/dataprovider.py` & `freqtrade-2023.5/freqtrade/data/dataprovider.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/data/entryexitanalysis.py` & `freqtrade-2023.5/freqtrade/data/entryexitanalysis.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,9 +1,10 @@
 import logging
 from pathlib import Path
+from typing import List
 
 import joblib
 import pandas as pd
 from tabulate import tabulate
 
 from freqtrade.configuration import TimeRange
 from freqtrade.constants import Config
@@ -11,45 +12,52 @@
                                        load_backtest_stats)
 from freqtrade.exceptions import OperationalException
 
 
 logger = logging.getLogger(__name__)
 
 
-def _load_signal_candles(backtest_dir: Path):
+def _load_backtest_analysis_data(backtest_dir: Path, name: str):
     if backtest_dir.is_dir():
         scpf = Path(backtest_dir,
-                    Path(get_latest_backtest_filename(backtest_dir)).stem + "_signals.pkl"
+                    Path(get_latest_backtest_filename(backtest_dir)).stem + "_" + name + ".pkl"
                     )
     else:
-        scpf = Path(backtest_dir.parent / f"{backtest_dir.stem}_signals.pkl")
+        scpf = Path(backtest_dir.parent / f"{backtest_dir.stem}_{name}.pkl")
 
     try:
         with scpf.open("rb") as scp:
-            signal_candles = joblib.load(scp)
-            logger.info(f"Loaded signal candles: {str(scpf)}")
+            loaded_data = joblib.load(scp)
+            logger.info(f"Loaded {name} candles: {str(scpf)}")
     except Exception as e:
-        logger.error("Cannot load signal candles from pickled results: ", e)
+        logger.error(f"Cannot load {name} data from pickled results: ", e)
+        return None
+
+    return loaded_data
 
-    return signal_candles
+
+def _load_rejected_signals(backtest_dir: Path):
+    return _load_backtest_analysis_data(backtest_dir, "rejected")
+
+
+def _load_signal_candles(backtest_dir: Path):
+    return _load_backtest_analysis_data(backtest_dir, "signals")
 
 
 def _process_candles_and_indicators(pairlist, strategy_name, trades, signal_candles):
     analysed_trades_dict = {}
     analysed_trades_dict[strategy_name] = {}
 
     try:
         logger.info(f"Processing {strategy_name} : {len(pairlist)} pairs")
 
         for pair in pairlist:
             if pair in signal_candles[strategy_name]:
                 analysed_trades_dict[strategy_name][pair] = _analyze_candles_and_indicators(
-                                                              pair,
-                                                              trades,
-                                                              signal_candles[strategy_name][pair])
+                    pair, trades, signal_candles[strategy_name][pair])
     except Exception as e:
         print(f"Cannot process entry/exit reasons for {strategy_name}: ", e)
 
     return analysed_trades_dict
 
 
 def _analyze_candles_and_indicators(pair, trades: pd.DataFrame, signal_candles: pd.DataFrame):
@@ -81,15 +89,15 @@
                 except Exception as e:
                     raise e
         return trades_red
     else:
         return pd.DataFrame()
 
 
-def _do_group_table_output(bigdf, glist):
+def _do_group_table_output(bigdf, glist, csv_path: Path, to_csv=False, ):
     for g in glist:
         # 0: summary wins/losses grouped by enter tag
         if g == "0":
             group_mask = ['enter_reason']
             wins = bigdf.loc[bigdf['profit_abs'] >= 0] \
                         .groupby(group_mask) \
                         .agg({'profit_abs': ['sum']})
@@ -112,15 +120,16 @@
             new['avg_loss'] = (new['profit_abs_loss'] / new.iloc[:, 2]).fillna(0)
 
             new.columns = ['total_num_buys', 'wins', 'losses', 'profit_abs_wins', 'profit_abs_loss',
                            'profit_tot', 'wl_ratio_pct', 'avg_win', 'avg_loss']
 
             sortcols = ['total_num_buys']
 
-            _print_table(new, sortcols, show_index=True)
+            _print_table(new, sortcols, show_index=True, name="Group 0:",
+                         to_csv=to_csv, csv_path=csv_path)
 
         else:
             agg_mask = {'profit_abs': ['count', 'sum', 'median', 'mean'],
                         'profit_ratio': ['median', 'mean', 'sum']}
             agg_cols = ['num_buys', 'profit_abs_sum', 'profit_abs_median',
                         'profit_abs_mean', 'median_profit_pct', 'mean_profit_pct',
                         'total_profit_pct']
@@ -150,19 +159,32 @@
             if group_mask:
                 new = bigdf.groupby(group_mask).agg(agg_mask).reset_index()
                 new.columns = group_mask + agg_cols
                 new['median_profit_pct'] = new['median_profit_pct'] * 100
                 new['mean_profit_pct'] = new['mean_profit_pct'] * 100
                 new['total_profit_pct'] = new['total_profit_pct'] * 100
 
-                _print_table(new, sortcols)
+                _print_table(new, sortcols, name=f"Group {g}:",
+                             to_csv=to_csv, csv_path=csv_path)
             else:
                 logger.warning("Invalid group mask specified.")
 
 
+def _do_rejected_signals_output(rejected_signals_df: pd.DataFrame,
+                                to_csv: bool = False, csv_path=None) -> None:
+    cols = ['pair', 'date', 'enter_tag']
+    sortcols = ['date', 'pair', 'enter_tag']
+    _print_table(rejected_signals_df[cols],
+                 sortcols,
+                 show_index=False,
+                 name="Rejected Signals:",
+                 to_csv=to_csv,
+                 csv_path=csv_path)
+
+
 def _select_rows_within_dates(df, timerange=None, df_date_col: str = 'date'):
     if timerange:
         if timerange.starttype == 'date':
             df = df.loc[(df[df_date_col] >= timerange.startdt)]
         if timerange.stoptype == 'date':
             df = df.loc[(df[df_date_col] < timerange.stopdt)]
     return df
@@ -188,72 +210,114 @@
 
     if res_df is not None and res_df.shape[0] > 0 and ('enter_reason' in res_df.columns):
         res_df = _select_rows_by_tags(res_df, enter_reason_list, exit_reason_list)
 
     return res_df
 
 
-def print_results(res_df, analysis_groups, indicator_list):
+def print_results(res_df: pd.DataFrame, analysis_groups: List[str], indicator_list: List[str],
+                  csv_path: Path, rejected_signals=None, to_csv=False):
     if res_df.shape[0] > 0:
         if analysis_groups:
-            _do_group_table_output(res_df, analysis_groups)
+            _do_group_table_output(res_df, analysis_groups, to_csv=to_csv, csv_path=csv_path)
+
+        if rejected_signals is not None:
+            if rejected_signals.empty:
+                print("There were no rejected signals.")
+            else:
+                _do_rejected_signals_output(rejected_signals, to_csv=to_csv, csv_path=csv_path)
 
+        # NB this can be large for big dataframes!
         if "all" in indicator_list:
-            print(res_df)
-        elif indicator_list is not None:
+            _print_table(res_df,
+                         show_index=False,
+                         name="Indicators:",
+                         to_csv=to_csv,
+                         csv_path=csv_path)
+        elif indicator_list is not None and indicator_list:
             available_inds = []
             for ind in indicator_list:
                 if ind in res_df:
                     available_inds.append(ind)
             ilist = ["pair", "enter_reason", "exit_reason"] + available_inds
-            _print_table(res_df[ilist], sortcols=['exit_reason'], show_index=False)
+            _print_table(res_df[ilist],
+                         sortcols=['exit_reason'],
+                         show_index=False,
+                         name="Indicators:",
+                         to_csv=to_csv,
+                         csv_path=csv_path)
     else:
         print("\\No trades to show")
 
 
-def _print_table(df, sortcols=None, show_index=False):
+def _print_table(df: pd.DataFrame, sortcols=None, *, show_index=False, name=None,
+                 to_csv=False, csv_path: Path):
     if (sortcols is not None):
         data = df.sort_values(sortcols)
     else:
         data = df
 
-    print(
-        tabulate(
-            data,
-            headers='keys',
-            tablefmt='psql',
-            showindex=show_index
+    if to_csv:
+        safe_name = Path(csv_path, name.lower().replace(" ", "_").replace(":", "") + ".csv")
+        data.to_csv(safe_name)
+        print(f"Saved {name} to {safe_name}")
+    else:
+        if name is not None:
+            print(name)
+
+        print(
+            tabulate(
+                data,
+                headers='keys',
+                tablefmt='psql',
+                showindex=show_index
+            )
         )
-    )
 
 
 def process_entry_exit_reasons(config: Config):
     try:
         analysis_groups = config.get('analysis_groups', [])
         enter_reason_list = config.get('enter_reason_list', ["all"])
         exit_reason_list = config.get('exit_reason_list', ["all"])
         indicator_list = config.get('indicator_list', [])
+        do_rejected = config.get('analysis_rejected', False)
+        to_csv = config.get('analysis_to_csv', False)
+        csv_path = Path(config.get('analysis_csv_path', config['exportfilename']))
+        if to_csv and not csv_path.is_dir():
+            raise OperationalException(f"Specified directory {csv_path} does not exist.")
 
         timerange = TimeRange.parse_timerange(None if config.get(
             'timerange') is None else str(config.get('timerange')))
 
         backtest_stats = load_backtest_stats(config['exportfilename'])
 
         for strategy_name, results in backtest_stats['strategy'].items():
             trades = load_backtest_data(config['exportfilename'], strategy_name)
 
-            if not trades.empty:
+            if trades is not None and not trades.empty:
                 signal_candles = _load_signal_candles(config['exportfilename'])
+
+                rej_df = None
+                if do_rejected:
+                    rejected_signals_dict = _load_rejected_signals(config['exportfilename'])
+                    rej_df = prepare_results(rejected_signals_dict, strategy_name,
+                                             enter_reason_list, exit_reason_list,
+                                             timerange=timerange)
+
                 analysed_trades_dict = _process_candles_and_indicators(
                                         config['exchange']['pair_whitelist'], strategy_name,
                                         trades, signal_candles)
 
                 res_df = prepare_results(analysed_trades_dict, strategy_name,
                                          enter_reason_list, exit_reason_list,
                                          timerange=timerange)
 
                 print_results(res_df,
                               analysis_groups,
-                              indicator_list)
+                              indicator_list,
+                              rejected_signals=rej_df,
+                              to_csv=to_csv,
+                              csv_path=csv_path)
 
     except ValueError as e:
         raise OperationalException(e) from e
```

### Comparing `freqtrade-2023.4/freqtrade/data/history/featherdatahandler.py` & `freqtrade-2023.5/freqtrade/data/history/featherdatahandler.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/data/history/hdf5datahandler.py` & `freqtrade-2023.5/freqtrade/data/history/hdf5datahandler.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/data/history/history_utils.py` & `freqtrade-2023.5/freqtrade/data/history/history_utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,14 +1,13 @@
 import logging
 import operator
-from datetime import datetime
+from datetime import datetime, timedelta
 from pathlib import Path
 from typing import Dict, List, Optional, Tuple
 
-import arrow
 from pandas import DataFrame, concat
 
 from freqtrade.configuration import TimeRange
 from freqtrade.constants import DEFAULT_DATAFRAME_COLUMNS
 from freqtrade.data.converter import (clean_ohlcv_dataframe, ohlcv_to_dataframe,
                                       trades_remove_duplicates, trades_to_ohlcv)
 from freqtrade.data.history.idatahandler import IDataHandler, get_datahandler
@@ -232,16 +231,16 @@
         logger.debug("Current End: %s",
                      f"{data.iloc[-1]['date']:DATETIME_PRINT_FORMAT}" if not data.empty else 'None')
 
         # Default since_ms to 30 days if nothing is given
         new_data = exchange.get_historic_ohlcv(pair=pair,
                                                timeframe=timeframe,
                                                since_ms=since_ms if since_ms else
-                                               arrow.utcnow().shift(
-                                                   days=-new_pairs_days).int_timestamp * 1000,
+                                               int((datetime.now() - timedelta(days=new_pairs_days)
+                                                    ).timestamp()) * 1000,
                                                is_new_pair=data.empty,
                                                candle_type=candle_type,
                                                until_ms=until_ms if until_ms else None
                                                )
         # TODO: Maybe move parsing to exchange class (?)
         new_dataframe = ohlcv_to_dataframe(new_data, timeframe, pair,
                                            fill_missing=False, drop_incomplete=True)
@@ -345,15 +344,15 @@
 
         if trades and since < trades[0][0]:
             # since is before the first trade
             logger.info(f"Start earlier than available data. Redownloading trades for {pair}...")
             trades = []
 
         if not since:
-            since = arrow.utcnow().shift(days=-new_pairs_days).int_timestamp * 1000
+            since = int((datetime.now() - timedelta(days=-new_pairs_days)).timestamp()) * 1000
 
         from_id = trades[-1][1] if trades else None
         if trades and since < trades[-1][0]:
             # Reset since to the last available point
             # - 5 seconds (to ensure we're getting all trades)
             since = trades[-1][0] - (5 * 1000)
             logger.info(f"Using last trade date -5s - Downloading trades for {pair} "
```

### Comparing `freqtrade-2023.4/freqtrade/data/history/idatahandler.py` & `freqtrade-2023.5/freqtrade/data/history/idatahandler.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/data/history/jsondatahandler.py` & `freqtrade-2023.5/freqtrade/data/history/jsondatahandler.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/data/history/parquetdatahandler.py` & `freqtrade-2023.5/freqtrade/data/history/parquetdatahandler.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/data/metrics.py` & `freqtrade-2023.5/freqtrade/data/metrics.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/edge/edge_positioning.py` & `freqtrade-2023.5/freqtrade/edge/edge_positioning.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,27 +1,28 @@
 # pragma pylint: disable=W0603
 """ Edge positioning package """
 import logging
 from collections import defaultdict
 from copy import deepcopy
+from datetime import timedelta
 from typing import Any, Dict, List, NamedTuple
 
-import arrow
 import numpy as np
 import utils_find_1st as utf1st
 from pandas import DataFrame
 
 from freqtrade.configuration import TimeRange
 from freqtrade.constants import DATETIME_PRINT_FORMAT, UNLIMITED_STAKE_AMOUNT, Config
 from freqtrade.data.history import get_timerange, load_data, refresh_data
 from freqtrade.enums import CandleType, ExitType, RunMode
 from freqtrade.exceptions import OperationalException
 from freqtrade.exchange import timeframe_to_seconds
 from freqtrade.plugins.pairlist.pairlist_helpers import expand_pairlist
 from freqtrade.strategy.interface import IStrategy
+from freqtrade.util import dt_now
 
 
 logger = logging.getLogger(__name__)
 
 
 class PairInfo(NamedTuple):
     stoploss: float
@@ -75,16 +76,16 @@
         # calculating stoploss range
         self._stoploss_range = np.arange(
             self._stoploss_range_min,
             self._stoploss_range_max,
             self._stoploss_range_step
         )
 
-        self._timerange: TimeRange = TimeRange.parse_timerange("%s-" % arrow.now().shift(
-            days=-1 * self._since_number_of_days).format('YYYYMMDD'))
+        self._timerange: TimeRange = TimeRange.parse_timerange(
+            f"{(dt_now() - timedelta(days=self._since_number_of_days)).strftime('%Y%m%d')}-")
         if config.get('fee'):
             self.fee = config['fee']
         else:
             try:
                 self.fee = self.exchange.get_fee(symbol=expand_pairlist(
                     self.config['exchange']['pair_whitelist'], list(self.exchange.markets))[0])
             except IndexError:
@@ -93,15 +94,15 @@
     def calculate(self, pairs: List[str]) -> bool:
         if self.fee is None and pairs:
             self.fee = self.exchange.get_fee(pairs[0])
 
         heartbeat = self.edge_config.get('process_throttle_secs')
 
         if (self._last_updated > 0) and (
-                self._last_updated + heartbeat > arrow.utcnow().int_timestamp):
+                self._last_updated + heartbeat > int(dt_now().timestamp())):
             return False
 
         data: Dict[str, Any] = {}
         logger.info('Using stake_currency: %s ...', self.config['stake_currency'])
         logger.info('Using local backtesting data (using whitelist in given config) ...')
 
         if self._refresh_pairs:
@@ -185,15 +186,15 @@
         if len(trades) == 0:
             logger.info("No trades found.")
             return False
 
         # Fill missing, calculable columns, profit, duration , abs etc.
         trades_df = self._fill_calculable_fields(DataFrame(trades))
         self._cached_pairs = self._process_expectancy(trades_df)
-        self._last_updated = arrow.utcnow().int_timestamp
+        self._last_updated = int(dt_now().timestamp())
 
         return True
 
     def stake_amount(self, pair: str, free_capital: float,
                      total_capital: float, capital_in_trade: float) -> float:
         stoploss = self.get_stoploss(pair)
         available_capital = (total_capital + capital_in_trade) * self._capital_ratio
```

### Comparing `freqtrade-2023.4/freqtrade/enums/__init__.py` & `freqtrade-2023.5/freqtrade/enums/__init__.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/enums/candletype.py` & `freqtrade-2023.5/freqtrade/enums/candletype.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/enums/exitchecktuple.py` & `freqtrade-2023.5/freqtrade/enums/exitchecktuple.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/enums/rpcmessagetype.py` & `freqtrade-2023.5/freqtrade/enums/rpcmessagetype.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/enums/runmode.py` & `freqtrade-2023.5/freqtrade/enums/runmode.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/enums/signaltype.py` & `freqtrade-2023.5/freqtrade/enums/signaltype.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exceptions.py` & `freqtrade-2023.5/freqtrade/exceptions.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/__init__.py` & `freqtrade-2023.5/freqtrade/exchange/__init__.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 # flake8: noqa: F401
 # isort: off
-from freqtrade.exchange.common import remove_credentials, MAP_EXCHANGE_CHILDCLASS
+from freqtrade.exchange.common import remove_exchange_credentials, MAP_EXCHANGE_CHILDCLASS
 from freqtrade.exchange.exchange import Exchange
 # isort: on
 from freqtrade.exchange.binance import Binance
 from freqtrade.exchange.bitpanda import Bitpanda
 from freqtrade.exchange.bittrex import Bittrex
 from freqtrade.exchange.bitvavo import Bitvavo
 from freqtrade.exchange.bybit import Bybit
```

### Comparing `freqtrade-2023.4/freqtrade/exchange/binance.py` & `freqtrade-2023.5/freqtrade/exchange/binance.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,14 +1,13 @@
 """ Binance exchange subclass """
 import logging
-from datetime import datetime
+from datetime import datetime, timezone
 from pathlib import Path
 from typing import Dict, List, Optional, Tuple
 
-import arrow
 import ccxt
 
 from freqtrade.enums import CandleType, MarginMode, PriceType, TradingMode
 from freqtrade.exceptions import DDosProtection, OperationalException, TemporaryError
 from freqtrade.exchange import Exchange
 from freqtrade.exchange.common import retrier
 from freqtrade.exchange.types import OHLCVResponse, Tickers
@@ -62,15 +61,15 @@
         """
         Additional exchange initialization logic.
         .api will be available at this point.
         Must be overridden in child methods if required.
         """
         try:
             if self.trading_mode == TradingMode.FUTURES and not self._config['dry_run']:
-                position_side = self._api.fapiPrivateGetPositionsideDual()
+                position_side = self._api.fapiPrivateGetPositionSideDual()
                 self._log_exchange_response('position_side_setting', position_side)
                 assets_margin = self._api.fapiPrivateGetMultiAssetsMargin()
                 self._log_exchange_response('multi_asset_margin', assets_margin)
                 msg = ""
                 if position_side.get('dualSidePosition') is True:
                     msg += (
                         "\nHedge Mode is not supported by freqtrade. "
@@ -101,16 +100,17 @@
         :param candle_type: Any of the enum CandleType (must match trading mode!)
         """
         if is_new_pair:
             x = await self._async_get_candle_history(pair, timeframe, candle_type, 0)
             if x and x[3] and x[3][0] and x[3][0][0] > since_ms:
                 # Set starting date to first available candle.
                 since_ms = x[3][0][0]
-                logger.info(f"Candle-data for {pair} available starting with "
-                            f"{arrow.get(since_ms // 1000).isoformat()}.")
+                logger.info(
+                    f"Candle-data for {pair} available starting with "
+                    f"{datetime.fromtimestamp(since_ms // 1000, tz=timezone.utc).isoformat()}.")
 
         return await super()._async_get_historic_ohlcv(
             pair=pair,
             timeframe=timeframe,
             since_ms=since_ms,
             is_new_pair=is_new_pair,
             raise_=raise_,
```

### Comparing `freqtrade-2023.4/freqtrade/exchange/binance_leverage_tiers.json` & `freqtrade-2023.5/freqtrade/exchange/binance_leverage_tiers.json`

 * *Files 0% similar despite different names*

#### Pretty-printed

 * *Similarity: 0.95891543312604%*

 * *Differences: {"'1000FLOKI/USDT:USDT'": "[OrderedDict([('tier', 1.0), ('currency', 'USDT'), ('minNotional', "*

 * *                          "0.0), ('maxNotional', 5000.0), ('maintenanceMarginRate', 0.02), "*

 * *                          "('maxLeverage', 20.0), ('info', OrderedDict([('bracket', '1'), "*

 * *                          "('initialLeverage', '20'), ('notionalCap', '5000'), ('notionalFloor', "*

 * *                          "'0'), ('maintMarginRatio', '0.02'), ('cum', '0.0')]))]), "*

 * *                          "OrderedDict([('tier […]*

```diff
@@ -1,8 +1,122 @@
 {
+    "1000FLOKI/USDT:USDT": [
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "1",
+                "cum": "0.0",
+                "initialLeverage": "20",
+                "maintMarginRatio": "0.02",
+                "notionalCap": "5000",
+                "notionalFloor": "0"
+            },
+            "maintenanceMarginRate": 0.02,
+            "maxLeverage": 20.0,
+            "maxNotional": 5000.0,
+            "minNotional": 0.0,
+            "tier": 1.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "2",
+                "cum": "25.0",
+                "initialLeverage": "15",
+                "maintMarginRatio": "0.025",
+                "notionalCap": "25000",
+                "notionalFloor": "5000"
+            },
+            "maintenanceMarginRate": 0.025,
+            "maxLeverage": 15.0,
+            "maxNotional": 25000.0,
+            "minNotional": 5000.0,
+            "tier": 2.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "3",
+                "cum": "650.0",
+                "initialLeverage": "10",
+                "maintMarginRatio": "0.05",
+                "notionalCap": "300000",
+                "notionalFloor": "25000"
+            },
+            "maintenanceMarginRate": 0.05,
+            "maxLeverage": 10.0,
+            "maxNotional": 300000.0,
+            "minNotional": 25000.0,
+            "tier": 3.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "4",
+                "cum": "15650.0",
+                "initialLeverage": "5",
+                "maintMarginRatio": "0.1",
+                "notionalCap": "800000",
+                "notionalFloor": "300000"
+            },
+            "maintenanceMarginRate": 0.1,
+            "maxLeverage": 5.0,
+            "maxNotional": 800000.0,
+            "minNotional": 300000.0,
+            "tier": 4.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "5",
+                "cum": "35650.0",
+                "initialLeverage": "4",
+                "maintMarginRatio": "0.125",
+                "notionalCap": "1000000",
+                "notionalFloor": "800000"
+            },
+            "maintenanceMarginRate": 0.125,
+            "maxLeverage": 4.0,
+            "maxNotional": 1000000.0,
+            "minNotional": 800000.0,
+            "tier": 5.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "6",
+                "cum": "160650.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "3000000",
+                "notionalFloor": "1000000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 3000000.0,
+            "minNotional": 1000000.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "910650.0",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "5000000",
+                "notionalFloor": "3000000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 5000000.0,
+            "minNotional": 3000000.0,
+            "tier": 7.0
+        }
+    ],
     "1000LUNC/BUSD:BUSD": [
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
                 "initialLeverage": "20",
@@ -207,14 +321,128 @@
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
             "maxNotional": 10000000.0,
             "minNotional": 6000000.0,
             "tier": 7.0
         }
     ],
+    "1000PEPE/USDT:USDT": [
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "1",
+                "cum": "0.0",
+                "initialLeverage": "20",
+                "maintMarginRatio": "0.02",
+                "notionalCap": "5000",
+                "notionalFloor": "0"
+            },
+            "maintenanceMarginRate": 0.02,
+            "maxLeverage": 20.0,
+            "maxNotional": 5000.0,
+            "minNotional": 0.0,
+            "tier": 1.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "2",
+                "cum": "25.0",
+                "initialLeverage": "15",
+                "maintMarginRatio": "0.025",
+                "notionalCap": "25000",
+                "notionalFloor": "5000"
+            },
+            "maintenanceMarginRate": 0.025,
+            "maxLeverage": 15.0,
+            "maxNotional": 25000.0,
+            "minNotional": 5000.0,
+            "tier": 2.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "3",
+                "cum": "650.0",
+                "initialLeverage": "10",
+                "maintMarginRatio": "0.05",
+                "notionalCap": "600000",
+                "notionalFloor": "25000"
+            },
+            "maintenanceMarginRate": 0.05,
+            "maxLeverage": 10.0,
+            "maxNotional": 600000.0,
+            "minNotional": 25000.0,
+            "tier": 3.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "4",
+                "cum": "30650.0",
+                "initialLeverage": "5",
+                "maintMarginRatio": "0.1",
+                "notionalCap": "1600000",
+                "notionalFloor": "600000"
+            },
+            "maintenanceMarginRate": 0.1,
+            "maxLeverage": 5.0,
+            "maxNotional": 1600000.0,
+            "minNotional": 600000.0,
+            "tier": 4.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "5",
+                "cum": "70650.0",
+                "initialLeverage": "4",
+                "maintMarginRatio": "0.125",
+                "notionalCap": "2000000",
+                "notionalFloor": "1600000"
+            },
+            "maintenanceMarginRate": 0.125,
+            "maxLeverage": 4.0,
+            "maxNotional": 2000000.0,
+            "minNotional": 1600000.0,
+            "tier": 5.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "6",
+                "cum": "320650.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "6000000",
+                "notionalFloor": "2000000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 6000000.0,
+            "minNotional": 2000000.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "1820650.0",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "10000000",
+                "notionalFloor": "6000000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 10000000.0,
+            "minNotional": 6000000.0,
+            "tier": 7.0
+        }
+    ],
     "1000SHIB/BUSD:BUSD": [
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
                 "initialLeverage": "25",
@@ -2169,53 +2397,53 @@
     ],
     "APE/BUSD:BUSD": [
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
-                "initialLeverage": "20",
+                "initialLeverage": "10",
                 "maintMarginRatio": "0.02",
                 "notionalCap": "5000",
                 "notionalFloor": "0"
             },
             "maintenanceMarginRate": 0.02,
-            "maxLeverage": 20.0,
+            "maxLeverage": 10.0,
             "maxNotional": 5000.0,
             "minNotional": 0.0,
             "tier": 1.0
         },
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "2",
                 "cum": "25.0",
-                "initialLeverage": "10",
+                "initialLeverage": "8",
                 "maintMarginRatio": "0.025",
                 "notionalCap": "25000",
                 "notionalFloor": "5000"
             },
             "maintenanceMarginRate": 0.025,
-            "maxLeverage": 10.0,
+            "maxLeverage": 8.0,
             "maxNotional": 25000.0,
             "minNotional": 5000.0,
             "tier": 2.0
         },
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "3",
                 "cum": "650.0",
-                "initialLeverage": "8",
+                "initialLeverage": "6",
                 "maintMarginRatio": "0.05",
                 "notionalCap": "100000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
-            "maxLeverage": 8.0,
+            "maxLeverage": 6.0,
             "maxNotional": 100000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "BUSD",
             "info": {
@@ -2251,20 +2479,20 @@
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "6",
                 "cum": "386900.0",
                 "initialLeverage": "1",
                 "maintMarginRatio": "0.5",
-                "notionalCap": "5000000",
+                "notionalCap": "1200000",
                 "notionalFloor": "1000000"
             },
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
-            "maxNotional": 5000000.0,
+            "maxNotional": 1200000.0,
             "minNotional": 1000000.0,
             "tier": 6.0
         }
     ],
     "APE/USDT:USDT": [
         {
             "currency": "USDT",
@@ -4817,14 +5045,128 @@
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
             "maxNotional": 5000000.0,
             "minNotional": 1000000.0,
             "tier": 6.0
         }
     ],
+    "BLUR/USDT:USDT": [
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "1",
+                "cum": "0.0",
+                "initialLeverage": "25",
+                "maintMarginRatio": "0.02",
+                "notionalCap": "5000",
+                "notionalFloor": "0"
+            },
+            "maintenanceMarginRate": 0.02,
+            "maxLeverage": 25.0,
+            "maxNotional": 5000.0,
+            "minNotional": 0.0,
+            "tier": 1.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "2",
+                "cum": "25.0",
+                "initialLeverage": "20",
+                "maintMarginRatio": "0.025",
+                "notionalCap": "25000",
+                "notionalFloor": "5000"
+            },
+            "maintenanceMarginRate": 0.025,
+            "maxLeverage": 20.0,
+            "maxNotional": 25000.0,
+            "minNotional": 5000.0,
+            "tier": 2.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "3",
+                "cum": "650.0",
+                "initialLeverage": "10",
+                "maintMarginRatio": "0.05",
+                "notionalCap": "600000",
+                "notionalFloor": "25000"
+            },
+            "maintenanceMarginRate": 0.05,
+            "maxLeverage": 10.0,
+            "maxNotional": 600000.0,
+            "minNotional": 25000.0,
+            "tier": 3.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "4",
+                "cum": "30650.0",
+                "initialLeverage": "5",
+                "maintMarginRatio": "0.1",
+                "notionalCap": "1600000",
+                "notionalFloor": "600000"
+            },
+            "maintenanceMarginRate": 0.1,
+            "maxLeverage": 5.0,
+            "maxNotional": 1600000.0,
+            "minNotional": 600000.0,
+            "tier": 4.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "5",
+                "cum": "70650.0",
+                "initialLeverage": "4",
+                "maintMarginRatio": "0.125",
+                "notionalCap": "2000000",
+                "notionalFloor": "1600000"
+            },
+            "maintenanceMarginRate": 0.125,
+            "maxLeverage": 4.0,
+            "maxNotional": 2000000.0,
+            "minNotional": 1600000.0,
+            "tier": 5.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "6",
+                "cum": "320650.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "6000000",
+                "notionalFloor": "2000000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 6000000.0,
+            "minNotional": 2000000.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "1820650.0",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "10000000",
+                "notionalFloor": "6000000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 10000000.0,
+            "minNotional": 6000000.0,
+            "tier": 7.0
+        }
+    ],
     "BLZ/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
                 "initialLeverage": "20",
@@ -8539,53 +8881,53 @@
     ],
     "DOT/BUSD:BUSD": [
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
-                "initialLeverage": "25",
+                "initialLeverage": "10",
                 "maintMarginRatio": "0.02",
                 "notionalCap": "5000",
                 "notionalFloor": "0"
             },
             "maintenanceMarginRate": 0.02,
-            "maxLeverage": 25.0,
+            "maxLeverage": 10.0,
             "maxNotional": 5000.0,
             "minNotional": 0.0,
             "tier": 1.0
         },
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "2",
                 "cum": "25.0",
-                "initialLeverage": "15",
+                "initialLeverage": "8",
                 "maintMarginRatio": "0.025",
                 "notionalCap": "25000",
                 "notionalFloor": "5000"
             },
             "maintenanceMarginRate": 0.025,
-            "maxLeverage": 15.0,
+            "maxLeverage": 8.0,
             "maxNotional": 25000.0,
             "minNotional": 5000.0,
             "tier": 2.0
         },
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "3",
                 "cum": "650.0",
-                "initialLeverage": "10",
+                "initialLeverage": "6",
                 "maintMarginRatio": "0.05",
                 "notionalCap": "100000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
-            "maxLeverage": 10.0,
+            "maxLeverage": 6.0,
             "maxNotional": 100000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "BUSD",
             "info": {
@@ -8637,20 +8979,20 @@
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "7",
                 "cum": "949400.0",
                 "initialLeverage": "1",
                 "maintMarginRatio": "0.5",
-                "notionalCap": "8000000",
+                "notionalCap": "4000000",
                 "notionalFloor": "3000000"
             },
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
-            "maxNotional": 8000000.0,
+            "maxNotional": 4000000.0,
             "minNotional": 3000000.0,
             "tier": 7.0
         }
     ],
     "DOT/USDT:USDT": [
         {
             "currency": "USDT",
@@ -9037,14 +9379,128 @@
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
             "maxNotional": 20000000.0,
             "minNotional": 12000000.0,
             "tier": 8.0
         }
     ],
+    "EDU/USDT:USDT": [
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "1",
+                "cum": "0.0",
+                "initialLeverage": "20",
+                "maintMarginRatio": "0.02",
+                "notionalCap": "5000",
+                "notionalFloor": "0"
+            },
+            "maintenanceMarginRate": 0.02,
+            "maxLeverage": 20.0,
+            "maxNotional": 5000.0,
+            "minNotional": 0.0,
+            "tier": 1.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "2",
+                "cum": "25.0",
+                "initialLeverage": "15",
+                "maintMarginRatio": "0.025",
+                "notionalCap": "25000",
+                "notionalFloor": "5000"
+            },
+            "maintenanceMarginRate": 0.025,
+            "maxLeverage": 15.0,
+            "maxNotional": 25000.0,
+            "minNotional": 5000.0,
+            "tier": 2.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "3",
+                "cum": "650.0",
+                "initialLeverage": "10",
+                "maintMarginRatio": "0.05",
+                "notionalCap": "200000",
+                "notionalFloor": "25000"
+            },
+            "maintenanceMarginRate": 0.05,
+            "maxLeverage": 10.0,
+            "maxNotional": 200000.0,
+            "minNotional": 25000.0,
+            "tier": 3.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "4",
+                "cum": "10650.0",
+                "initialLeverage": "5",
+                "maintMarginRatio": "0.1",
+                "notionalCap": "500000",
+                "notionalFloor": "200000"
+            },
+            "maintenanceMarginRate": 0.1,
+            "maxLeverage": 5.0,
+            "maxNotional": 500000.0,
+            "minNotional": 200000.0,
+            "tier": 4.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "5",
+                "cum": "23150.0",
+                "initialLeverage": "4",
+                "maintMarginRatio": "0.125",
+                "notionalCap": "1000000",
+                "notionalFloor": "500000"
+            },
+            "maintenanceMarginRate": 0.125,
+            "maxLeverage": 4.0,
+            "maxNotional": 1000000.0,
+            "minNotional": 500000.0,
+            "tier": 5.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "6",
+                "cum": "148150.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "3000000",
+                "notionalFloor": "1000000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 3000000.0,
+            "minNotional": 1000000.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "898150.0",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "5000000",
+                "notionalFloor": "3000000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 5000000.0,
+            "minNotional": 3000000.0,
+            "tier": 7.0
+        }
+    ],
     "EGLD/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
                 "initialLeverage": "25",
@@ -9547,53 +10003,53 @@
     ],
     "ETC/BUSD:BUSD": [
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
-                "initialLeverage": "20",
+                "initialLeverage": "8",
                 "maintMarginRatio": "0.02",
                 "notionalCap": "5000",
                 "notionalFloor": "0"
             },
             "maintenanceMarginRate": 0.02,
-            "maxLeverage": 20.0,
+            "maxLeverage": 8.0,
             "maxNotional": 5000.0,
             "minNotional": 0.0,
             "tier": 1.0
         },
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "2",
                 "cum": "25.0",
-                "initialLeverage": "10",
+                "initialLeverage": "7",
                 "maintMarginRatio": "0.025",
                 "notionalCap": "25000",
                 "notionalFloor": "5000"
             },
             "maintenanceMarginRate": 0.025,
-            "maxLeverage": 10.0,
+            "maxLeverage": 7.0,
             "maxNotional": 25000.0,
             "minNotional": 5000.0,
             "tier": 2.0
         },
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "3",
                 "cum": "650.0",
-                "initialLeverage": "8",
+                "initialLeverage": "6",
                 "maintMarginRatio": "0.05",
                 "notionalCap": "100000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
-            "maxLeverage": 8.0,
+            "maxLeverage": 6.0,
             "maxNotional": 100000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "BUSD",
             "info": {
@@ -9629,20 +10085,20 @@
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "6",
                 "cum": "386900.0",
                 "initialLeverage": "1",
                 "maintMarginRatio": "0.5",
-                "notionalCap": "5000000",
+                "notionalCap": "1500000",
                 "notionalFloor": "1000000"
             },
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
-            "maxNotional": 5000000.0,
+            "maxNotional": 1500000.0,
             "minNotional": 1000000.0,
             "tier": 6.0
         }
     ],
     "ETC/USDT:USDT": [
         {
             "currency": "USDT",
@@ -9801,14 +10257,176 @@
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
             "maxNotional": 50000000.0,
             "minNotional": 30000000.0,
             "tier": 10.0
         }
     ],
+    "ETH/BTC:BTC": [
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "1",
+                "cum": "0.0",
+                "initialLeverage": "75",
+                "maintMarginRatio": "0.005",
+                "notionalCap": "5",
+                "notionalFloor": "0"
+            },
+            "maintenanceMarginRate": 0.005,
+            "maxLeverage": 75.0,
+            "maxNotional": 5.0,
+            "minNotional": 0.0,
+            "tier": 1.0
+        },
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "2",
+                "cum": "0.005",
+                "initialLeverage": "50",
+                "maintMarginRatio": "0.006",
+                "notionalCap": "10",
+                "notionalFloor": "5"
+            },
+            "maintenanceMarginRate": 0.006,
+            "maxLeverage": 50.0,
+            "maxNotional": 10.0,
+            "minNotional": 5.0,
+            "tier": 2.0
+        },
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "3",
+                "cum": "0.045",
+                "initialLeverage": "25",
+                "maintMarginRatio": "0.01",
+                "notionalCap": "100",
+                "notionalFloor": "10"
+            },
+            "maintenanceMarginRate": 0.01,
+            "maxLeverage": 25.0,
+            "maxNotional": 100.0,
+            "minNotional": 10.0,
+            "tier": 3.0
+        },
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "4",
+                "cum": "1.045",
+                "initialLeverage": "20",
+                "maintMarginRatio": "0.02",
+                "notionalCap": "250",
+                "notionalFloor": "100"
+            },
+            "maintenanceMarginRate": 0.02,
+            "maxLeverage": 20.0,
+            "maxNotional": 250.0,
+            "minNotional": 100.0,
+            "tier": 4.0
+        },
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "5",
+                "cum": "2.295",
+                "initialLeverage": "10",
+                "maintMarginRatio": "0.025",
+                "notionalCap": "800",
+                "notionalFloor": "250"
+            },
+            "maintenanceMarginRate": 0.025,
+            "maxLeverage": 10.0,
+            "maxNotional": 800.0,
+            "minNotional": 250.0,
+            "tier": 5.0
+        },
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "6",
+                "cum": "22.295",
+                "initialLeverage": "8",
+                "maintMarginRatio": "0.05",
+                "notionalCap": "1500",
+                "notionalFloor": "800"
+            },
+            "maintenanceMarginRate": 0.05,
+            "maxLeverage": 8.0,
+            "maxNotional": 1500.0,
+            "minNotional": 800.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "7",
+                "cum": "97.295",
+                "initialLeverage": "5",
+                "maintMarginRatio": "0.1",
+                "notionalCap": "2000",
+                "notionalFloor": "1500"
+            },
+            "maintenanceMarginRate": 0.1,
+            "maxLeverage": 5.0,
+            "maxNotional": 2000.0,
+            "minNotional": 1500.0,
+            "tier": 7.0
+        },
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "8",
+                "cum": "147.295",
+                "initialLeverage": "4",
+                "maintMarginRatio": "0.125",
+                "notionalCap": "3000",
+                "notionalFloor": "2000"
+            },
+            "maintenanceMarginRate": 0.125,
+            "maxLeverage": 4.0,
+            "maxNotional": 3000.0,
+            "minNotional": 2000.0,
+            "tier": 8.0
+        },
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "9",
+                "cum": "522.295",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "5000",
+                "notionalFloor": "3000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 5000.0,
+            "minNotional": 3000.0,
+            "tier": 9.0
+        },
+        {
+            "currency": "BTC",
+            "info": {
+                "bracket": "10",
+                "cum": "1772.295",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "10000",
+                "notionalFloor": "5000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 10000.0,
+            "minNotional": 5000.0,
+            "tier": 10.0
+        }
+    ],
     "ETH/BUSD:BUSD": [
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
                 "initialLeverage": "75",
@@ -10359,53 +10977,53 @@
     ],
     "FIL/BUSD:BUSD": [
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
-                "initialLeverage": "20",
+                "initialLeverage": "8",
                 "maintMarginRatio": "0.02",
                 "notionalCap": "5000",
                 "notionalFloor": "0"
             },
             "maintenanceMarginRate": 0.02,
-            "maxLeverage": 20.0,
+            "maxLeverage": 8.0,
             "maxNotional": 5000.0,
             "minNotional": 0.0,
             "tier": 1.0
         },
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "2",
                 "cum": "25.0",
-                "initialLeverage": "10",
+                "initialLeverage": "7",
                 "maintMarginRatio": "0.025",
                 "notionalCap": "25000",
                 "notionalFloor": "5000"
             },
             "maintenanceMarginRate": 0.025,
-            "maxLeverage": 10.0,
+            "maxLeverage": 7.0,
             "maxNotional": 25000.0,
             "minNotional": 5000.0,
             "tier": 2.0
         },
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "3",
                 "cum": "650.0",
-                "initialLeverage": "8",
+                "initialLeverage": "6",
                 "maintMarginRatio": "0.05",
                 "notionalCap": "100000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
-            "maxLeverage": 8.0,
+            "maxLeverage": 6.0,
             "maxNotional": 100000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "BUSD",
             "info": {
@@ -10441,20 +11059,20 @@
         {
             "currency": "BUSD",
             "info": {
                 "bracket": "6",
                 "cum": "386900.0",
                 "initialLeverage": "1",
                 "maintMarginRatio": "0.5",
-                "notionalCap": "5000000",
+                "notionalCap": "2000000",
                 "notionalFloor": "1000000"
             },
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
-            "maxNotional": 5000000.0,
+            "maxNotional": 2000000.0,
             "minNotional": 1000000.0,
             "tier": 6.0
         }
     ],
     "FIL/USDT:USDT": [
         {
             "currency": "USDT",
@@ -13337,14 +13955,128 @@
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
             "maxNotional": 5000000.0,
             "minNotional": 3000000.0,
             "tier": 7.0
         }
     ],
+    "IDEX/USDT:USDT": [
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "1",
+                "cum": "0.0",
+                "initialLeverage": "20",
+                "maintMarginRatio": "0.02",
+                "notionalCap": "5000",
+                "notionalFloor": "0"
+            },
+            "maintenanceMarginRate": 0.02,
+            "maxLeverage": 20.0,
+            "maxNotional": 5000.0,
+            "minNotional": 0.0,
+            "tier": 1.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "2",
+                "cum": "25.0",
+                "initialLeverage": "15",
+                "maintMarginRatio": "0.025",
+                "notionalCap": "25000",
+                "notionalFloor": "5000"
+            },
+            "maintenanceMarginRate": 0.025,
+            "maxLeverage": 15.0,
+            "maxNotional": 25000.0,
+            "minNotional": 5000.0,
+            "tier": 2.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "3",
+                "cum": "650.0",
+                "initialLeverage": "10",
+                "maintMarginRatio": "0.05",
+                "notionalCap": "200000",
+                "notionalFloor": "25000"
+            },
+            "maintenanceMarginRate": 0.05,
+            "maxLeverage": 10.0,
+            "maxNotional": 200000.0,
+            "minNotional": 25000.0,
+            "tier": 3.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "4",
+                "cum": "10650.0",
+                "initialLeverage": "5",
+                "maintMarginRatio": "0.1",
+                "notionalCap": "500000",
+                "notionalFloor": "200000"
+            },
+            "maintenanceMarginRate": 0.1,
+            "maxLeverage": 5.0,
+            "maxNotional": 500000.0,
+            "minNotional": 200000.0,
+            "tier": 4.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "5",
+                "cum": "23150.0",
+                "initialLeverage": "4",
+                "maintMarginRatio": "0.125",
+                "notionalCap": "1000000",
+                "notionalFloor": "500000"
+            },
+            "maintenanceMarginRate": 0.125,
+            "maxLeverage": 4.0,
+            "maxNotional": 1000000.0,
+            "minNotional": 500000.0,
+            "tier": 5.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "6",
+                "cum": "148150.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "3000000",
+                "notionalFloor": "1000000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 3000000.0,
+            "minNotional": 1000000.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "898150.0",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "5000000",
+                "notionalFloor": "3000000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 5000000.0,
+            "minNotional": 3000000.0,
+            "tier": 7.0
+        }
+    ],
     "IMX/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
                 "initialLeverage": "25",
@@ -13491,85 +14223,85 @@
         {
             "currency": "USDT",
             "info": {
                 "bracket": "3",
                 "cum": "650.0",
                 "initialLeverage": "10",
                 "maintMarginRatio": "0.05",
-                "notionalCap": "600000",
+                "notionalCap": "1200000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
             "maxLeverage": 10.0,
-            "maxNotional": 600000.0,
+            "maxNotional": 1200000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "4",
-                "cum": "30650.0",
+                "cum": "60650.0",
                 "initialLeverage": "5",
                 "maintMarginRatio": "0.1",
-                "notionalCap": "1600000",
-                "notionalFloor": "600000"
+                "notionalCap": "3200000",
+                "notionalFloor": "1200000"
             },
             "maintenanceMarginRate": 0.1,
             "maxLeverage": 5.0,
-            "maxNotional": 1600000.0,
-            "minNotional": 600000.0,
+            "maxNotional": 3200000.0,
+            "minNotional": 1200000.0,
             "tier": 4.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "5",
-                "cum": "70650.0",
+                "cum": "140650.0",
                 "initialLeverage": "4",
                 "maintMarginRatio": "0.125",
-                "notionalCap": "2000000",
-                "notionalFloor": "1600000"
+                "notionalCap": "4000000",
+                "notionalFloor": "3200000"
             },
             "maintenanceMarginRate": 0.125,
             "maxLeverage": 4.0,
-            "maxNotional": 2000000.0,
-            "minNotional": 1600000.0,
+            "maxNotional": 4000000.0,
+            "minNotional": 3200000.0,
             "tier": 5.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "6",
-                "cum": "320650.0",
+                "cum": "640650.0",
                 "initialLeverage": "2",
                 "maintMarginRatio": "0.25",
-                "notionalCap": "6000000",
-                "notionalFloor": "2000000"
+                "notionalCap": "12000000",
+                "notionalFloor": "4000000"
             },
             "maintenanceMarginRate": 0.25,
             "maxLeverage": 2.0,
-            "maxNotional": 6000000.0,
-            "minNotional": 2000000.0,
+            "maxNotional": 12000000.0,
+            "minNotional": 4000000.0,
             "tier": 6.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "7",
-                "cum": "1820650.0",
+                "cum": "3640650.0",
                 "initialLeverage": "1",
                 "maintMarginRatio": "0.5",
-                "notionalCap": "10000000",
-                "notionalFloor": "6000000"
+                "notionalCap": "20000000",
+                "notionalFloor": "12000000"
             },
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
-            "maxNotional": 10000000.0,
-            "minNotional": 6000000.0,
+            "maxNotional": 20000000.0,
+            "minNotional": 12000000.0,
             "tier": 7.0
         }
     ],
     "IOST/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
@@ -15561,85 +16293,85 @@
         {
             "currency": "USDT",
             "info": {
                 "bracket": "3",
                 "cum": "650.0",
                 "initialLeverage": "10",
                 "maintMarginRatio": "0.05",
-                "notionalCap": "200000",
+                "notionalCap": "600000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
             "maxLeverage": 10.0,
-            "maxNotional": 200000.0,
+            "maxNotional": 600000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "4",
-                "cum": "10650.0",
+                "cum": "30650.0",
                 "initialLeverage": "5",
                 "maintMarginRatio": "0.1",
-                "notionalCap": "500000",
-                "notionalFloor": "200000"
+                "notionalCap": "1600000",
+                "notionalFloor": "600000"
             },
             "maintenanceMarginRate": 0.1,
             "maxLeverage": 5.0,
-            "maxNotional": 500000.0,
-            "minNotional": 200000.0,
+            "maxNotional": 1600000.0,
+            "minNotional": 600000.0,
             "tier": 4.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "5",
-                "cum": "23150.0",
+                "cum": "70650.0",
                 "initialLeverage": "4",
                 "maintMarginRatio": "0.125",
-                "notionalCap": "1000000",
-                "notionalFloor": "500000"
+                "notionalCap": "2000000",
+                "notionalFloor": "1600000"
             },
             "maintenanceMarginRate": 0.125,
             "maxLeverage": 4.0,
-            "maxNotional": 1000000.0,
-            "minNotional": 500000.0,
+            "maxNotional": 2000000.0,
+            "minNotional": 1600000.0,
             "tier": 5.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "6",
-                "cum": "148150.0",
+                "cum": "320650.0",
                 "initialLeverage": "2",
                 "maintMarginRatio": "0.25",
-                "notionalCap": "3000000",
-                "notionalFloor": "1000000"
+                "notionalCap": "6000000",
+                "notionalFloor": "2000000"
             },
             "maintenanceMarginRate": 0.25,
             "maxLeverage": 2.0,
-            "maxNotional": 3000000.0,
-            "minNotional": 1000000.0,
+            "maxNotional": 6000000.0,
+            "minNotional": 2000000.0,
             "tier": 6.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "7",
-                "cum": "898150.0",
+                "cum": "1820650.0",
                 "initialLeverage": "1",
                 "maintMarginRatio": "0.5",
-                "notionalCap": "5000000",
-                "notionalFloor": "3000000"
+                "notionalCap": "10000000",
+                "notionalFloor": "6000000"
             },
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
-            "maxNotional": 5000000.0,
-            "minNotional": 3000000.0,
+            "maxNotional": 10000000.0,
+            "minNotional": 6000000.0,
             "tier": 7.0
         }
     ],
     "LRC/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
@@ -17741,53 +18473,53 @@
     ],
     "OMG/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
-                "initialLeverage": "20",
+                "initialLeverage": "25",
                 "maintMarginRatio": "0.02",
                 "notionalCap": "5000",
                 "notionalFloor": "0"
             },
             "maintenanceMarginRate": 0.02,
-            "maxLeverage": 20.0,
+            "maxLeverage": 25.0,
             "maxNotional": 5000.0,
             "minNotional": 0.0,
             "tier": 1.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "2",
                 "cum": "25.0",
-                "initialLeverage": "10",
+                "initialLeverage": "20",
                 "maintMarginRatio": "0.025",
                 "notionalCap": "25000",
                 "notionalFloor": "5000"
             },
             "maintenanceMarginRate": 0.025,
-            "maxLeverage": 10.0,
+            "maxLeverage": 20.0,
             "maxNotional": 25000.0,
             "minNotional": 5000.0,
             "tier": 2.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "3",
                 "cum": "650.0",
-                "initialLeverage": "8",
+                "initialLeverage": "10",
                 "maintMarginRatio": "0.05",
                 "notionalCap": "900000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
-            "maxLeverage": 8.0,
+            "maxLeverage": 10.0,
             "maxNotional": 900000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "USDT",
             "info": {
@@ -18197,104 +18929,120 @@
     ],
     "PEOPLE/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
-                "initialLeverage": "20",
+                "initialLeverage": "25",
                 "maintMarginRatio": "0.02",
                 "notionalCap": "5000",
                 "notionalFloor": "0"
             },
             "maintenanceMarginRate": 0.02,
-            "maxLeverage": 20.0,
+            "maxLeverage": 25.0,
             "maxNotional": 5000.0,
             "minNotional": 0.0,
             "tier": 1.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "2",
                 "cum": "25.0",
-                "initialLeverage": "10",
+                "initialLeverage": "20",
                 "maintMarginRatio": "0.025",
                 "notionalCap": "25000",
                 "notionalFloor": "5000"
             },
             "maintenanceMarginRate": 0.025,
-            "maxLeverage": 10.0,
+            "maxLeverage": 20.0,
             "maxNotional": 25000.0,
             "minNotional": 5000.0,
             "tier": 2.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "3",
                 "cum": "650.0",
-                "initialLeverage": "8",
+                "initialLeverage": "10",
                 "maintMarginRatio": "0.05",
-                "notionalCap": "100000",
+                "notionalCap": "300000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
-            "maxLeverage": 8.0,
-            "maxNotional": 100000.0,
+            "maxLeverage": 10.0,
+            "maxNotional": 300000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "4",
-                "cum": "5650.0",
+                "cum": "15650.0",
                 "initialLeverage": "5",
                 "maintMarginRatio": "0.1",
-                "notionalCap": "250000",
-                "notionalFloor": "100000"
+                "notionalCap": "800000",
+                "notionalFloor": "300000"
             },
             "maintenanceMarginRate": 0.1,
             "maxLeverage": 5.0,
-            "maxNotional": 250000.0,
-            "minNotional": 100000.0,
+            "maxNotional": 800000.0,
+            "minNotional": 300000.0,
             "tier": 4.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "5",
-                "cum": "11900.0",
-                "initialLeverage": "2",
+                "cum": "35650.0",
+                "initialLeverage": "4",
                 "maintMarginRatio": "0.125",
                 "notionalCap": "1000000",
-                "notionalFloor": "250000"
+                "notionalFloor": "800000"
             },
             "maintenanceMarginRate": 0.125,
-            "maxLeverage": 2.0,
+            "maxLeverage": 4.0,
             "maxNotional": 1000000.0,
-            "minNotional": 250000.0,
+            "minNotional": 800000.0,
             "tier": 5.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "6",
-                "cum": "386900.0",
-                "initialLeverage": "1",
-                "maintMarginRatio": "0.5",
+                "cum": "160650.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
                 "notionalCap": "3000000",
                 "notionalFloor": "1000000"
             },
-            "maintenanceMarginRate": 0.5,
-            "maxLeverage": 1.0,
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
             "maxNotional": 3000000.0,
             "minNotional": 1000000.0,
             "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "910650.0",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "5000000",
+                "notionalFloor": "3000000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 5000000.0,
+            "minNotional": 3000000.0,
+            "tier": 7.0
         }
     ],
     "PERP/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
@@ -18811,14 +19559,128 @@
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
             "maxNotional": 5000000.0,
             "minNotional": 3000000.0,
             "tier": 7.0
         }
     ],
+    "RAD/USDT:USDT": [
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "1",
+                "cum": "0.0",
+                "initialLeverage": "20",
+                "maintMarginRatio": "0.02",
+                "notionalCap": "5000",
+                "notionalFloor": "0"
+            },
+            "maintenanceMarginRate": 0.02,
+            "maxLeverage": 20.0,
+            "maxNotional": 5000.0,
+            "minNotional": 0.0,
+            "tier": 1.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "2",
+                "cum": "25.0",
+                "initialLeverage": "15",
+                "maintMarginRatio": "0.025",
+                "notionalCap": "25000",
+                "notionalFloor": "5000"
+            },
+            "maintenanceMarginRate": 0.025,
+            "maxLeverage": 15.0,
+            "maxNotional": 25000.0,
+            "minNotional": 5000.0,
+            "tier": 2.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "3",
+                "cum": "650.0",
+                "initialLeverage": "10",
+                "maintMarginRatio": "0.05",
+                "notionalCap": "200000",
+                "notionalFloor": "25000"
+            },
+            "maintenanceMarginRate": 0.05,
+            "maxLeverage": 10.0,
+            "maxNotional": 200000.0,
+            "minNotional": 25000.0,
+            "tier": 3.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "4",
+                "cum": "10650.0",
+                "initialLeverage": "5",
+                "maintMarginRatio": "0.1",
+                "notionalCap": "500000",
+                "notionalFloor": "200000"
+            },
+            "maintenanceMarginRate": 0.1,
+            "maxLeverage": 5.0,
+            "maxNotional": 500000.0,
+            "minNotional": 200000.0,
+            "tier": 4.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "5",
+                "cum": "23150.0",
+                "initialLeverage": "4",
+                "maintMarginRatio": "0.125",
+                "notionalCap": "1000000",
+                "notionalFloor": "500000"
+            },
+            "maintenanceMarginRate": 0.125,
+            "maxLeverage": 4.0,
+            "maxNotional": 1000000.0,
+            "minNotional": 500000.0,
+            "tier": 5.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "6",
+                "cum": "148150.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "3000000",
+                "notionalFloor": "1000000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 3000000.0,
+            "minNotional": 1000000.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "898150.0",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "5000000",
+                "notionalFloor": "3000000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 5000000.0,
+            "minNotional": 3000000.0,
+            "tier": 7.0
+        }
+    ],
     "RAY/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
                 "initialLeverage": "25",
@@ -18949,85 +19811,85 @@
         {
             "currency": "USDT",
             "info": {
                 "bracket": "3",
                 "cum": "650.0",
                 "initialLeverage": "10",
                 "maintMarginRatio": "0.05",
-                "notionalCap": "200000",
+                "notionalCap": "600000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
             "maxLeverage": 10.0,
-            "maxNotional": 200000.0,
+            "maxNotional": 600000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "4",
-                "cum": "10650.0",
+                "cum": "30650.0",
                 "initialLeverage": "5",
                 "maintMarginRatio": "0.1",
-                "notionalCap": "500000",
-                "notionalFloor": "200000"
+                "notionalCap": "1600000",
+                "notionalFloor": "600000"
             },
             "maintenanceMarginRate": 0.1,
             "maxLeverage": 5.0,
-            "maxNotional": 500000.0,
-            "minNotional": 200000.0,
+            "maxNotional": 1600000.0,
+            "minNotional": 600000.0,
             "tier": 4.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "5",
-                "cum": "23150.0",
+                "cum": "70650.0",
                 "initialLeverage": "4",
                 "maintMarginRatio": "0.125",
-                "notionalCap": "1000000",
-                "notionalFloor": "500000"
+                "notionalCap": "2000000",
+                "notionalFloor": "1600000"
             },
             "maintenanceMarginRate": 0.125,
             "maxLeverage": 4.0,
-            "maxNotional": 1000000.0,
-            "minNotional": 500000.0,
+            "maxNotional": 2000000.0,
+            "minNotional": 1600000.0,
             "tier": 5.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "6",
-                "cum": "148150.0",
+                "cum": "320650.0",
                 "initialLeverage": "2",
                 "maintMarginRatio": "0.25",
-                "notionalCap": "3000000",
-                "notionalFloor": "1000000"
+                "notionalCap": "6000000",
+                "notionalFloor": "2000000"
             },
             "maintenanceMarginRate": 0.25,
             "maxLeverage": 2.0,
-            "maxNotional": 3000000.0,
-            "minNotional": 1000000.0,
+            "maxNotional": 6000000.0,
+            "minNotional": 2000000.0,
             "tier": 6.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "7",
-                "cum": "898150.0",
+                "cum": "1820650.0",
                 "initialLeverage": "1",
                 "maintMarginRatio": "0.5",
-                "notionalCap": "5000000",
-                "notionalFloor": "3000000"
+                "notionalCap": "10000000",
+                "notionalFloor": "6000000"
             },
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
-            "maxNotional": 5000000.0,
-            "minNotional": 3000000.0,
+            "maxNotional": 10000000.0,
+            "minNotional": 6000000.0,
             "tier": 7.0
         }
     ],
     "REEF/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
@@ -21411,76 +22273,76 @@
         {
             "currency": "USDT",
             "info": {
                 "bracket": "2",
                 "cum": "75.0",
                 "initialLeverage": "20",
                 "maintMarginRatio": "0.025",
-                "notionalCap": "25000",
+                "notionalCap": "50000",
                 "notionalFloor": "5000"
             },
             "maintenanceMarginRate": 0.025,
             "maxLeverage": 20.0,
-            "maxNotional": 25000.0,
+            "maxNotional": 50000.0,
             "minNotional": 5000.0,
             "tier": 2.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "3",
-                "cum": "700.0",
+                "cum": "1325.0",
                 "initialLeverage": "10",
                 "maintMarginRatio": "0.05",
-                "notionalCap": "400000",
-                "notionalFloor": "25000"
+                "notionalCap": "600000",
+                "notionalFloor": "50000"
             },
             "maintenanceMarginRate": 0.05,
             "maxLeverage": 10.0,
-            "maxNotional": 400000.0,
-            "minNotional": 25000.0,
+            "maxNotional": 600000.0,
+            "minNotional": 50000.0,
             "tier": 3.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "4",
-                "cum": "20700.0",
+                "cum": "31325.0",
                 "initialLeverage": "5",
                 "maintMarginRatio": "0.1",
-                "notionalCap": "1000000",
-                "notionalFloor": "400000"
+                "notionalCap": "1600000",
+                "notionalFloor": "600000"
             },
             "maintenanceMarginRate": 0.1,
             "maxLeverage": 5.0,
-            "maxNotional": 1000000.0,
-            "minNotional": 400000.0,
+            "maxNotional": 1600000.0,
+            "minNotional": 600000.0,
             "tier": 4.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "5",
-                "cum": "45700.0",
+                "cum": "71325.0",
                 "initialLeverage": "4",
                 "maintMarginRatio": "0.125",
                 "notionalCap": "2000000",
-                "notionalFloor": "1000000"
+                "notionalFloor": "1600000"
             },
             "maintenanceMarginRate": 0.125,
             "maxLeverage": 4.0,
             "maxNotional": 2000000.0,
-            "minNotional": 1000000.0,
+            "minNotional": 1600000.0,
             "tier": 5.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "6",
-                "cum": "295700.0",
+                "cum": "321325.0",
                 "initialLeverage": "2",
                 "maintMarginRatio": "0.25",
                 "notionalCap": "6000000",
                 "notionalFloor": "2000000"
             },
             "maintenanceMarginRate": 0.25,
             "maxLeverage": 2.0,
@@ -21488,27 +22350,157 @@
             "minNotional": 2000000.0,
             "tier": 6.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "7",
-                "cum": "1795700.0",
+                "cum": "1821325.0",
                 "initialLeverage": "1",
                 "maintMarginRatio": "0.5",
                 "notionalCap": "10000000",
                 "notionalFloor": "6000000"
             },
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
             "maxNotional": 10000000.0,
             "minNotional": 6000000.0,
             "tier": 7.0
         }
     ],
+    "SUI/USDT:USDT": [
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "1",
+                "cum": "0.0",
+                "initialLeverage": "50",
+                "maintMarginRatio": "0.01",
+                "notionalCap": "5000",
+                "notionalFloor": "0"
+            },
+            "maintenanceMarginRate": 0.01,
+            "maxLeverage": 50.0,
+            "maxNotional": 5000.0,
+            "minNotional": 0.0,
+            "tier": 1.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "2",
+                "cum": "50.0",
+                "initialLeverage": "25",
+                "maintMarginRatio": "0.02",
+                "notionalCap": "50000",
+                "notionalFloor": "5000"
+            },
+            "maintenanceMarginRate": 0.02,
+            "maxLeverage": 25.0,
+            "maxNotional": 50000.0,
+            "minNotional": 5000.0,
+            "tier": 2.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "3",
+                "cum": "300.0",
+                "initialLeverage": "20",
+                "maintMarginRatio": "0.025",
+                "notionalCap": "300000",
+                "notionalFloor": "50000"
+            },
+            "maintenanceMarginRate": 0.025,
+            "maxLeverage": 20.0,
+            "maxNotional": 300000.0,
+            "minNotional": 50000.0,
+            "tier": 3.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "4",
+                "cum": "7800.0",
+                "initialLeverage": "10",
+                "maintMarginRatio": "0.05",
+                "notionalCap": "600000",
+                "notionalFloor": "300000"
+            },
+            "maintenanceMarginRate": 0.05,
+            "maxLeverage": 10.0,
+            "maxNotional": 600000.0,
+            "minNotional": 300000.0,
+            "tier": 4.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "5",
+                "cum": "37800.0",
+                "initialLeverage": "5",
+                "maintMarginRatio": "0.1",
+                "notionalCap": "1600000",
+                "notionalFloor": "600000"
+            },
+            "maintenanceMarginRate": 0.1,
+            "maxLeverage": 5.0,
+            "maxNotional": 1600000.0,
+            "minNotional": 600000.0,
+            "tier": 5.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "6",
+                "cum": "77800.0",
+                "initialLeverage": "4",
+                "maintMarginRatio": "0.125",
+                "notionalCap": "2000000",
+                "notionalFloor": "1600000"
+            },
+            "maintenanceMarginRate": 0.125,
+            "maxLeverage": 4.0,
+            "maxNotional": 2000000.0,
+            "minNotional": 1600000.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "327800.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "6000000",
+                "notionalFloor": "2000000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 6000000.0,
+            "minNotional": 2000000.0,
+            "tier": 7.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "8",
+                "cum": "1827800.0",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "10000000",
+                "notionalFloor": "6000000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 10000000.0,
+            "minNotional": 6000000.0,
+            "tier": 8.0
+        }
+    ],
     "SUSHI/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
                 "initialLeverage": "25",
@@ -22755,14 +23747,128 @@
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
             "maxNotional": 30000000.0,
             "minNotional": 20000000.0,
             "tier": 9.0
         }
     ],
+    "UMA/USDT:USDT": [
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "1",
+                "cum": "0.0",
+                "initialLeverage": "20",
+                "maintMarginRatio": "0.02",
+                "notionalCap": "5000",
+                "notionalFloor": "0"
+            },
+            "maintenanceMarginRate": 0.02,
+            "maxLeverage": 20.0,
+            "maxNotional": 5000.0,
+            "minNotional": 0.0,
+            "tier": 1.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "2",
+                "cum": "25.0",
+                "initialLeverage": "15",
+                "maintMarginRatio": "0.025",
+                "notionalCap": "25000",
+                "notionalFloor": "5000"
+            },
+            "maintenanceMarginRate": 0.025,
+            "maxLeverage": 15.0,
+            "maxNotional": 25000.0,
+            "minNotional": 5000.0,
+            "tier": 2.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "3",
+                "cum": "650.0",
+                "initialLeverage": "10",
+                "maintMarginRatio": "0.05",
+                "notionalCap": "200000",
+                "notionalFloor": "25000"
+            },
+            "maintenanceMarginRate": 0.05,
+            "maxLeverage": 10.0,
+            "maxNotional": 200000.0,
+            "minNotional": 25000.0,
+            "tier": 3.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "4",
+                "cum": "10650.0",
+                "initialLeverage": "5",
+                "maintMarginRatio": "0.1",
+                "notionalCap": "500000",
+                "notionalFloor": "200000"
+            },
+            "maintenanceMarginRate": 0.1,
+            "maxLeverage": 5.0,
+            "maxNotional": 500000.0,
+            "minNotional": 200000.0,
+            "tier": 4.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "5",
+                "cum": "23150.0",
+                "initialLeverage": "4",
+                "maintMarginRatio": "0.125",
+                "notionalCap": "1000000",
+                "notionalFloor": "500000"
+            },
+            "maintenanceMarginRate": 0.125,
+            "maxLeverage": 4.0,
+            "maxNotional": 1000000.0,
+            "minNotional": 500000.0,
+            "tier": 5.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "6",
+                "cum": "148150.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "3000000",
+                "notionalFloor": "1000000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 3000000.0,
+            "minNotional": 1000000.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "898150.0",
+                "initialLeverage": "1",
+                "maintMarginRatio": "0.5",
+                "notionalCap": "5000000",
+                "notionalFloor": "3000000"
+            },
+            "maintenanceMarginRate": 0.5,
+            "maxLeverage": 1.0,
+            "maxNotional": 5000000.0,
+            "minNotional": 3000000.0,
+            "tier": 7.0
+        }
+    ],
     "UNFI/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
                 "initialLeverage": "20",
@@ -24813,104 +25919,120 @@
     ],
     "ZIL/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
                 "cum": "0.0",
-                "initialLeverage": "20",
+                "initialLeverage": "25",
                 "maintMarginRatio": "0.01",
                 "notionalCap": "5000",
                 "notionalFloor": "0"
             },
             "maintenanceMarginRate": 0.01,
-            "maxLeverage": 20.0,
+            "maxLeverage": 25.0,
             "maxNotional": 5000.0,
             "minNotional": 0.0,
             "tier": 1.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "2",
                 "cum": "75.0",
-                "initialLeverage": "10",
+                "initialLeverage": "20",
                 "maintMarginRatio": "0.025",
                 "notionalCap": "25000",
                 "notionalFloor": "5000"
             },
             "maintenanceMarginRate": 0.025,
-            "maxLeverage": 10.0,
+            "maxLeverage": 20.0,
             "maxNotional": 25000.0,
             "minNotional": 5000.0,
             "tier": 2.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "3",
                 "cum": "700.0",
-                "initialLeverage": "8",
+                "initialLeverage": "10",
                 "maintMarginRatio": "0.05",
-                "notionalCap": "100000",
+                "notionalCap": "600000",
                 "notionalFloor": "25000"
             },
             "maintenanceMarginRate": 0.05,
-            "maxLeverage": 8.0,
-            "maxNotional": 100000.0,
+            "maxLeverage": 10.0,
+            "maxNotional": 600000.0,
             "minNotional": 25000.0,
             "tier": 3.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "4",
-                "cum": "5700.0",
+                "cum": "30700.0",
                 "initialLeverage": "5",
                 "maintMarginRatio": "0.1",
-                "notionalCap": "250000",
-                "notionalFloor": "100000"
+                "notionalCap": "1600000",
+                "notionalFloor": "600000"
             },
             "maintenanceMarginRate": 0.1,
             "maxLeverage": 5.0,
-            "maxNotional": 250000.0,
-            "minNotional": 100000.0,
+            "maxNotional": 1600000.0,
+            "minNotional": 600000.0,
             "tier": 4.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "5",
-                "cum": "11950.0",
-                "initialLeverage": "2",
+                "cum": "70700.0",
+                "initialLeverage": "4",
                 "maintMarginRatio": "0.125",
-                "notionalCap": "1000000",
-                "notionalFloor": "250000"
+                "notionalCap": "2000000",
+                "notionalFloor": "1600000"
             },
             "maintenanceMarginRate": 0.125,
-            "maxLeverage": 2.0,
-            "maxNotional": 1000000.0,
-            "minNotional": 250000.0,
+            "maxLeverage": 4.0,
+            "maxNotional": 2000000.0,
+            "minNotional": 1600000.0,
             "tier": 5.0
         },
         {
             "currency": "USDT",
             "info": {
                 "bracket": "6",
-                "cum": "386950.0",
+                "cum": "320700.0",
+                "initialLeverage": "2",
+                "maintMarginRatio": "0.25",
+                "notionalCap": "6000000",
+                "notionalFloor": "2000000"
+            },
+            "maintenanceMarginRate": 0.25,
+            "maxLeverage": 2.0,
+            "maxNotional": 6000000.0,
+            "minNotional": 2000000.0,
+            "tier": 6.0
+        },
+        {
+            "currency": "USDT",
+            "info": {
+                "bracket": "7",
+                "cum": "1820700.0",
                 "initialLeverage": "1",
                 "maintMarginRatio": "0.5",
-                "notionalCap": "5000000",
-                "notionalFloor": "1000000"
+                "notionalCap": "10000000",
+                "notionalFloor": "6000000"
             },
             "maintenanceMarginRate": 0.5,
             "maxLeverage": 1.0,
-            "maxNotional": 5000000.0,
-            "minNotional": 1000000.0,
-            "tier": 6.0
+            "maxNotional": 10000000.0,
+            "minNotional": 6000000.0,
+            "tier": 7.0
         }
     ],
     "ZRX/USDT:USDT": [
         {
             "currency": "USDT",
             "info": {
                 "bracket": "1",
```

### Comparing `freqtrade-2023.4/freqtrade/exchange/bitpanda.py` & `freqtrade-2023.5/freqtrade/exchange/bitpanda.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/bittrex.py` & `freqtrade-2023.5/freqtrade/exchange/bittrex.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/bitvavo.py` & `freqtrade-2023.5/freqtrade/exchange/bitvavo.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/bybit.py` & `freqtrade-2023.5/freqtrade/exchange/bybit.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/check_exchange.py` & `freqtrade-2023.5/freqtrade/exchange/check_exchange.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/coinbasepro.py` & `freqtrade-2023.5/freqtrade/exchange/coinbasepro.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/common.py` & `freqtrade-2023.5/freqtrade/exchange/common.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 import asyncio
 import logging
 import time
 from functools import wraps
 from typing import Any, Callable, Optional, TypeVar, cast, overload
 
+from freqtrade.constants import ExchangeConfig
 from freqtrade.exceptions import DDosProtection, RetryableOrderError, TemporaryError
 from freqtrade.mixins import LoggingMixin
 
 
 logger = logging.getLogger(__name__)
 __logging_mixin = None
 
@@ -80,28 +81,30 @@
     'fetchOrderBook', 'fetchL2OrderBook', 'fetchTicker',  # OR for pricing
     'fetchTickers',  # For volumepairlist?
     'fetchTrades',  # Downloading trades data
     # 'fetchFundingRateHistory',  # Futures trading
     # 'fetchPositions',  # Futures trading
     # 'fetchLeverageTiers',  # Futures initialization
     # 'fetchMarketLeverageTiers',  # Futures initialization
+    # 'fetchOpenOrders', 'fetchClosedOrders',  # 'fetchOrders',  # Refinding balance...
 ]
 
 
-def remove_credentials(config) -> None:
+def remove_exchange_credentials(exchange_config: ExchangeConfig, dry_run: bool) -> None:
     """
     Removes exchange keys from the configuration and specifies dry-run
     Used for backtesting / hyperopt / edge and utils.
     Modifies the input dict!
     """
-    if config.get('dry_run', False):
-        config['exchange']['key'] = ''
-        config['exchange']['secret'] = ''
-        config['exchange']['password'] = ''
-        config['exchange']['uid'] = ''
+    if dry_run:
+        exchange_config['key'] = ''
+        exchange_config['apiKey'] = ''
+        exchange_config['secret'] = ''
+        exchange_config['password'] = ''
+        exchange_config['uid'] = ''
 
 
 def calculate_backoff(retrycount, max_retries):
     """
     Calculate backoff
     """
     return (max_retries - retrycount) ** 2 + 1
```

### Comparing `freqtrade-2023.4/freqtrade/exchange/exchange.py` & `freqtrade-2023.5/freqtrade/exchange/exchange.py`

 * *Files 2% similar despite different names*

```diff
@@ -14,8102 +14,8230 @@
 000000d0: 7274 2066 6c6f 6f72 0a66 726f 6d20 7468  rt floor.from th
 000000e0: 7265 6164 696e 6720 696d 706f 7274 204c  reading import L
 000000f0: 6f63 6b0a 6672 6f6d 2074 7970 696e 6720  ock.from typing 
 00000100: 696d 706f 7274 2041 6e79 2c20 436f 726f  import Any, Coro
 00000110: 7574 696e 652c 2044 6963 742c 204c 6973  utine, Dict, Lis
 00000120: 742c 204c 6974 6572 616c 2c20 4f70 7469  t, Literal, Opti
 00000130: 6f6e 616c 2c20 5475 706c 652c 2055 6e69  onal, Tuple, Uni
-00000140: 6f6e 0a0a 696d 706f 7274 2061 7272 6f77  on..import arrow
-00000150: 0a69 6d70 6f72 7420 6363 7874 0a69 6d70  .import ccxt.imp
-00000160: 6f72 7420 6363 7874 2e61 7379 6e63 5f73  ort ccxt.async_s
-00000170: 7570 706f 7274 2061 7320 6363 7874 5f61  upport as ccxt_a
-00000180: 7379 6e63 0a66 726f 6d20 6361 6368 6574  sync.from cachet
-00000190: 6f6f 6c73 2069 6d70 6f72 7420 5454 4c43  ools import TTLC
-000001a0: 6163 6865 0a66 726f 6d20 6363 7874 2069  ache.from ccxt i
-000001b0: 6d70 6f72 7420 5449 434b 5f53 495a 450a  mport TICK_SIZE.
-000001c0: 6672 6f6d 2064 6174 6575 7469 6c20 696d  from dateutil im
-000001d0: 706f 7274 2070 6172 7365 720a 6672 6f6d  port parser.from
-000001e0: 2070 616e 6461 7320 696d 706f 7274 2044   pandas import D
-000001f0: 6174 6146 7261 6d65 2c20 636f 6e63 6174  ataFrame, concat
-00000200: 0a0a 6672 6f6d 2066 7265 7174 7261 6465  ..from freqtrade
-00000210: 2e63 6f6e 7374 616e 7473 2069 6d70 6f72  .constants impor
-00000220: 7420 2844 4546 4155 4c54 5f41 4d4f 554e  t (DEFAULT_AMOUN
-00000230: 545f 5245 5345 5256 455f 5045 5243 454e  T_RESERVE_PERCEN
-00000240: 542c 204e 4f4e 5f4f 5045 4e5f 4558 4348  T, NON_OPEN_EXCH
-00000250: 414e 4745 5f53 5441 5445 532c 2042 6964  ANGE_STATES, Bid
-00000260: 4173 6b2c 0a20 2020 2020 2020 2020 2020  Ask,.           
-00000270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000280: 2020 2020 2020 4275 7953 656c 6c2c 2043        BuySell, C
-00000290: 6f6e 6669 672c 2045 6e74 7279 4578 6974  onfig, EntryExit
-000002a0: 2c20 4c69 7374 5061 6972 7357 6974 6854  , ListPairsWithT
-000002b0: 696d 6566 7261 6d65 732c 204d 616b 6572  imeframes, Maker
-000002c0: 5461 6b65 722c 0a20 2020 2020 2020 2020  Taker,.         
-000002d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000002e0: 2020 2020 2020 2020 4f42 4c69 7465 7261          OBLitera
-000002f0: 6c2c 2050 6169 7257 6974 6854 696d 6566  l, PairWithTimef
-00000300: 7261 6d65 290a 6672 6f6d 2066 7265 7174  rame).from freqt
-00000310: 7261 6465 2e64 6174 612e 636f 6e76 6572  rade.data.conver
-00000320: 7465 7220 696d 706f 7274 2063 6c65 616e  ter import clean
-00000330: 5f6f 686c 6376 5f64 6174 6166 7261 6d65  _ohlcv_dataframe
-00000340: 2c20 6f68 6c63 765f 746f 5f64 6174 6166  , ohlcv_to_dataf
-00000350: 7261 6d65 2c20 7472 6164 6573 5f64 6963  rame, trades_dic
-00000360: 745f 746f 5f6c 6973 740a 6672 6f6d 2066  t_to_list.from f
-00000370: 7265 7174 7261 6465 2e65 6e75 6d73 2069  reqtrade.enums i
-00000380: 6d70 6f72 7420 4f50 5449 4d49 5a45 5f4d  mport OPTIMIZE_M
-00000390: 4f44 4553 2c20 4361 6e64 6c65 5479 7065  ODES, CandleType
-000003a0: 2c20 4d61 7267 696e 4d6f 6465 2c20 5472  , MarginMode, Tr
-000003b0: 6164 696e 674d 6f64 650a 6672 6f6d 2066  adingMode.from f
-000003c0: 7265 7174 7261 6465 2e65 6e75 6d73 2e70  reqtrade.enums.p
-000003d0: 7269 6365 7479 7065 2069 6d70 6f72 7420  ricetype import 
-000003e0: 5072 6963 6554 7970 650a 6672 6f6d 2066  PriceType.from f
-000003f0: 7265 7174 7261 6465 2e65 7863 6570 7469  reqtrade.excepti
-00000400: 6f6e 7320 696d 706f 7274 2028 4444 6f73  ons import (DDos
-00000410: 5072 6f74 6563 7469 6f6e 2c20 4578 6368  Protection, Exch
-00000420: 616e 6765 4572 726f 722c 2049 6e73 7566  angeError, Insuf
-00000430: 6669 6369 656e 7446 756e 6473 4572 726f  ficientFundsErro
-00000440: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00000140: 6f6e 0a0a 696d 706f 7274 2063 6378 740a  on..import ccxt.
+00000150: 696d 706f 7274 2063 6378 742e 6173 796e  import ccxt.asyn
+00000160: 635f 7375 7070 6f72 7420 6173 2063 6378  c_support as ccx
+00000170: 745f 6173 796e 630a 6672 6f6d 2063 6163  t_async.from cac
+00000180: 6865 746f 6f6c 7320 696d 706f 7274 2054  hetools import T
+00000190: 544c 4361 6368 650a 6672 6f6d 2063 6378  TLCache.from ccx
+000001a0: 7420 696d 706f 7274 2054 4943 4b5f 5349  t import TICK_SI
+000001b0: 5a45 0a66 726f 6d20 6461 7465 7574 696c  ZE.from dateutil
+000001c0: 2069 6d70 6f72 7420 7061 7273 6572 0a66   import parser.f
+000001d0: 726f 6d20 7061 6e64 6173 2069 6d70 6f72  rom pandas impor
+000001e0: 7420 4461 7461 4672 616d 652c 2063 6f6e  t DataFrame, con
+000001f0: 6361 740a 0a66 726f 6d20 6672 6571 7472  cat..from freqtr
+00000200: 6164 652e 636f 6e73 7461 6e74 7320 696d  ade.constants im
+00000210: 706f 7274 2028 4445 4641 554c 545f 414d  port (DEFAULT_AM
+00000220: 4f55 4e54 5f52 4553 4552 5645 5f50 4552  OUNT_RESERVE_PER
+00000230: 4345 4e54 2c20 4e4f 4e5f 4f50 454e 5f45  CENT, NON_OPEN_E
+00000240: 5843 4841 4e47 455f 5354 4154 4553 2c20  XCHANGE_STATES, 
+00000250: 4269 6441 736b 2c0a 2020 2020 2020 2020  BidAsk,.        
+00000260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000270: 2020 2020 2020 2020 2042 7579 5365 6c6c           BuySell
+00000280: 2c20 436f 6e66 6967 2c20 456e 7472 7945  , Config, EntryE
+00000290: 7869 742c 2045 7863 6861 6e67 6543 6f6e  xit, ExchangeCon
+000002a0: 6669 672c 0a20 2020 2020 2020 2020 2020  fig,.           
+000002b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000002c0: 2020 2020 2020 4c69 7374 5061 6972 7357        ListPairsW
+000002d0: 6974 6854 696d 6566 7261 6d65 732c 204d  ithTimeframes, M
+000002e0: 616b 6572 5461 6b65 722c 204f 424c 6974  akerTaker, OBLit
+000002f0: 6572 616c 2c20 5061 6972 5769 7468 5469  eral, PairWithTi
+00000300: 6d65 6672 616d 6529 0a66 726f 6d20 6672  meframe).from fr
+00000310: 6571 7472 6164 652e 6461 7461 2e63 6f6e  eqtrade.data.con
+00000320: 7665 7274 6572 2069 6d70 6f72 7420 636c  verter import cl
+00000330: 6561 6e5f 6f68 6c63 765f 6461 7461 6672  ean_ohlcv_datafr
+00000340: 616d 652c 206f 686c 6376 5f74 6f5f 6461  ame, ohlcv_to_da
+00000350: 7461 6672 616d 652c 2074 7261 6465 735f  taframe, trades_
+00000360: 6469 6374 5f74 6f5f 6c69 7374 0a66 726f  dict_to_list.fro
+00000370: 6d20 6672 6571 7472 6164 652e 656e 756d  m freqtrade.enum
+00000380: 7320 696d 706f 7274 204f 5054 494d 495a  s import OPTIMIZ
+00000390: 455f 4d4f 4445 532c 2043 616e 646c 6554  E_MODES, CandleT
+000003a0: 7970 652c 204d 6172 6769 6e4d 6f64 652c  ype, MarginMode,
+000003b0: 2054 7261 6469 6e67 4d6f 6465 0a66 726f   TradingMode.fro
+000003c0: 6d20 6672 6571 7472 6164 652e 656e 756d  m freqtrade.enum
+000003d0: 732e 7072 6963 6574 7970 6520 696d 706f  s.pricetype impo
+000003e0: 7274 2050 7269 6365 5479 7065 0a66 726f  rt PriceType.fro
+000003f0: 6d20 6672 6571 7472 6164 652e 6578 6365  m freqtrade.exce
+00000400: 7074 696f 6e73 2069 6d70 6f72 7420 2844  ptions import (D
+00000410: 446f 7350 726f 7465 6374 696f 6e2c 2045  DosProtection, E
+00000420: 7863 6861 6e67 6545 7272 6f72 2c20 496e  xchangeError, In
+00000430: 7375 6666 6963 6965 6e74 4675 6e64 7345  sufficientFundsE
+00000440: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
 00000450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000460: 2020 2020 2049 6e76 616c 6964 4f72 6465       InvalidOrde
-00000470: 7245 7863 6570 7469 6f6e 2c20 4f70 6572  rException, Oper
-00000480: 6174 696f 6e61 6c45 7863 6570 7469 6f6e  ationalException
-00000490: 2c20 5072 6963 696e 6745 7272 6f72 2c0a  , PricingError,.
-000004a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000460: 2020 2020 2020 2020 496e 7661 6c69 644f          InvalidO
+00000470: 7264 6572 4578 6365 7074 696f 6e2c 204f  rderException, O
+00000480: 7065 7261 7469 6f6e 616c 4578 6365 7074  perationalExcept
+00000490: 696f 6e2c 2050 7269 6369 6e67 4572 726f  ion, PricingErro
+000004a0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
 000004b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000004c0: 2020 5265 7472 7961 626c 654f 7264 6572    RetryableOrder
-000004d0: 4572 726f 722c 2054 656d 706f 7261 7279  Error, Temporary
-000004e0: 4572 726f 7229 0a66 726f 6d20 6672 6571  Error).from freq
-000004f0: 7472 6164 652e 6578 6368 616e 6765 2e63  trade.exchange.c
-00000500: 6f6d 6d6f 6e20 696d 706f 7274 2028 4150  ommon import (AP
-00000510: 495f 4645 5443 485f 4f52 4445 525f 5245  I_FETCH_ORDER_RE
-00000520: 5452 595f 434f 554e 542c 2072 656d 6f76  TRY_COUNT, remov
-00000530: 655f 6372 6564 656e 7469 616c 732c 2072  e_credentials, r
-00000540: 6574 7269 6572 2c0a 2020 2020 2020 2020  etrier,.        
+000004c0: 2020 2020 2052 6574 7279 6162 6c65 4f72       RetryableOr
+000004d0: 6465 7245 7272 6f72 2c20 5465 6d70 6f72  derError, Tempor
+000004e0: 6172 7945 7272 6f72 290a 6672 6f6d 2066  aryError).from f
+000004f0: 7265 7174 7261 6465 2e65 7863 6861 6e67  reqtrade.exchang
+00000500: 652e 636f 6d6d 6f6e 2069 6d70 6f72 7420  e.common import 
+00000510: 2841 5049 5f46 4554 4348 5f4f 5244 4552  (API_FETCH_ORDER
+00000520: 5f52 4554 5259 5f43 4f55 4e54 2c20 7265  _RETRY_COUNT, re
+00000530: 6d6f 7665 5f65 7863 6861 6e67 655f 6372  move_exchange_cr
+00000540: 6564 656e 7469 616c 732c 0a20 2020 2020  edentials,.     
 00000550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000560: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00000570: 6574 7269 6572 5f61 7379 6e63 290a 6672  etrier_async).fr
-00000580: 6f6d 2066 7265 7174 7261 6465 2e65 7863  om freqtrade.exc
-00000590: 6861 6e67 652e 6578 6368 616e 6765 5f75  hange.exchange_u
-000005a0: 7469 6c73 2069 6d70 6f72 7420 2852 4f55  tils import (ROU
-000005b0: 4e44 2c20 524f 554e 445f 444f 574e 2c20  ND, ROUND_DOWN, 
-000005c0: 524f 554e 445f 5550 2c20 4363 7874 4d6f  ROUND_UP, CcxtMo
-000005d0: 6475 6c65 5479 7065 2c0a 2020 2020 2020  duleType,.      
-000005e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000570: 2020 7265 7472 6965 722c 2072 6574 7269    retrier, retri
+00000580: 6572 5f61 7379 6e63 290a 6672 6f6d 2066  er_async).from f
+00000590: 7265 7174 7261 6465 2e65 7863 6861 6e67  reqtrade.exchang
+000005a0: 652e 6578 6368 616e 6765 5f75 7469 6c73  e.exchange_utils
+000005b0: 2069 6d70 6f72 7420 2852 4f55 4e44 2c20   import (ROUND, 
+000005c0: 524f 554e 445f 444f 574e 2c20 524f 554e  ROUND_DOWN, ROUN
+000005d0: 445f 5550 2c20 4363 7874 4d6f 6475 6c65  D_UP, CcxtModule
+000005e0: 5479 7065 2c0a 2020 2020 2020 2020 2020  Type,.          
 000005f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000600: 2020 2020 2020 2020 2061 6d6f 756e 745f           amount_
-00000610: 746f 5f63 6f6e 7472 6163 745f 7072 6563  to_contract_prec
-00000620: 6973 696f 6e2c 2061 6d6f 756e 745f 746f  ision, amount_to
-00000630: 5f63 6f6e 7472 6163 7473 2c0a 2020 2020  _contracts,.    
-00000640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000610: 2020 2020 2061 6d6f 756e 745f 746f 5f63       amount_to_c
+00000620: 6f6e 7472 6163 745f 7072 6563 6973 696f  ontract_precisio
+00000630: 6e2c 2061 6d6f 756e 745f 746f 5f63 6f6e  n, amount_to_con
+00000640: 7472 6163 7473 2c0a 2020 2020 2020 2020  tracts,.        
 00000650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000660: 2020 2020 2020 2020 2020 2061 6d6f 756e             amoun
-00000670: 745f 746f 5f70 7265 6369 7369 6f6e 2c20  t_to_precision, 
-00000680: 636f 6e74 7261 6374 735f 746f 5f61 6d6f  contracts_to_amo
-00000690: 756e 742c 0a20 2020 2020 2020 2020 2020  unt,.           
-000006a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000670: 2020 2020 2020 2061 6d6f 756e 745f 746f         amount_to
+00000680: 5f70 7265 6369 7369 6f6e 2c20 636f 6e74  _precision, cont
+00000690: 7261 6374 735f 746f 5f61 6d6f 756e 742c  racts_to_amount,
+000006a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000006b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000006c0: 2020 2020 6461 7465 5f6d 696e 7573 5f63      date_minus_c
-000006d0: 616e 646c 6573 2c20 6973 5f65 7863 6861  andles, is_excha
-000006e0: 6e67 655f 6b6e 6f77 6e5f 6363 7874 2c0a  nge_known_ccxt,.
-000006f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000006c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000006d0: 6461 7465 5f6d 696e 7573 5f63 616e 646c  date_minus_candl
+000006e0: 6573 2c20 6973 5f65 7863 6861 6e67 655f  es, is_exchange_
+000006f0: 6b6e 6f77 6e5f 6363 7874 2c0a 2020 2020  known_ccxt,.    
 00000700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000710: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00000720: 6172 6b65 745f 6973 5f61 6374 6976 652c  arket_is_active,
-00000730: 2070 7269 6365 5f74 6f5f 7072 6563 6973   price_to_precis
-00000740: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-00000750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000720: 2020 2020 2020 2020 2020 206d 6172 6b65             marke
+00000730: 745f 6973 5f61 6374 6976 652c 2070 7269  t_is_active, pri
+00000740: 6365 5f74 6f5f 7072 6563 6973 696f 6e2c  ce_to_precision,
+00000750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00000760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000770: 2020 2020 7469 6d65 6672 616d 655f 746f      timeframe_to
-00000780: 5f6d 696e 7574 6573 2c20 7469 6d65 6672  _minutes, timefr
-00000790: 616d 655f 746f 5f6d 7365 6373 2c0a 2020  ame_to_msecs,.  
-000007a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000780: 7469 6d65 6672 616d 655f 746f 5f6d 696e  timeframe_to_min
+00000790: 7574 6573 2c20 7469 6d65 6672 616d 655f  utes, timeframe_
+000007a0: 746f 5f6d 7365 6373 2c0a 2020 2020 2020  to_msecs,.      
 000007b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000007c0: 2020 2020 2020 2020 2020 2020 2074 696d               tim
-000007d0: 6566 7261 6d65 5f74 6f5f 6e65 7874 5f64  eframe_to_next_d
-000007e0: 6174 652c 2074 696d 6566 7261 6d65 5f74  ate, timeframe_t
-000007f0: 6f5f 7072 6576 5f64 6174 652c 0a20 2020  o_prev_date,.   
-00000800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000007c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000007d0: 2020 2020 2020 2020 2074 696d 6566 7261           timefra
+000007e0: 6d65 5f74 6f5f 6e65 7874 5f64 6174 652c  me_to_next_date,
+000007f0: 2074 696d 6566 7261 6d65 5f74 6f5f 7072   timeframe_to_pr
+00000800: 6576 5f64 6174 652c 0a20 2020 2020 2020  ev_date,.       
 00000810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000820: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-00000830: 6672 616d 655f 746f 5f73 6563 6f6e 6473  frame_to_seconds
-00000840: 290a 6672 6f6d 2066 7265 7174 7261 6465  ).from freqtrade
-00000850: 2e65 7863 6861 6e67 652e 7479 7065 7320  .exchange.types 
-00000860: 696d 706f 7274 204f 484c 4356 5265 7370  import OHLCVResp
-00000870: 6f6e 7365 2c20 4f72 6465 7242 6f6f 6b2c  onse, OrderBook,
-00000880: 2054 6963 6b65 722c 2054 6963 6b65 7273   Ticker, Tickers
-00000890: 0a66 726f 6d20 6672 6571 7472 6164 652e  .from freqtrade.
-000008a0: 6d69 7363 2069 6d70 6f72 7420 2863 6875  misc import (chu
-000008b0: 6e6b 732c 2064 6565 705f 6d65 7267 655f  nks, deep_merge_
-000008c0: 6469 6374 732c 2066 696c 655f 6475 6d70  dicts, file_dump
-000008d0: 5f6a 736f 6e2c 2066 696c 655f 6c6f 6164  _json, file_load
-000008e0: 5f6a 736f 6e2c 0a20 2020 2020 2020 2020  _json,.         
-000008f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000900: 2020 2073 6166 655f 7661 6c75 655f 6661     safe_value_fa
-00000910: 6c6c 6261 636b 3229 0a66 726f 6d20 6672  llback2).from fr
-00000920: 6571 7472 6164 652e 706c 7567 696e 732e  eqtrade.plugins.
-00000930: 7061 6972 6c69 7374 2e70 6169 726c 6973  pairlist.pairlis
-00000940: 745f 6865 6c70 6572 7320 696d 706f 7274  t_helpers import
-00000950: 2065 7870 616e 645f 7061 6972 6c69 7374   expand_pairlist
-00000960: 0a0a 0a6c 6f67 6765 7220 3d20 6c6f 6767  ...logger = logg
-00000970: 696e 672e 6765 744c 6f67 6765 7228 5f5f  ing.getLogger(__
-00000980: 6e61 6d65 5f5f 290a 0a0a 636c 6173 7320  name__)...class 
-00000990: 4578 6368 616e 6765 3a0a 0a20 2020 2023  Exchange:..    #
-000009a0: 2050 6172 616d 6574 6572 7320 746f 2061   Parameters to a
-000009b0: 6464 2064 6972 6563 746c 7920 746f 2062  dd directly to b
-000009c0: 7579 2f73 656c 6c20 6361 6c6c 7320 286c  uy/sell calls (l
-000009d0: 696b 6520 6167 7265 6569 6e67 2074 6f20  ike agreeing to 
-000009e0: 7472 6164 696e 6720 6167 7265 656d 656e  trading agreemen
-000009f0: 7429 0a20 2020 205f 7061 7261 6d73 3a20  t).    _params: 
-00000a00: 4469 6374 203d 207b 7d0a 0a20 2020 2023  Dict = {}..    #
-00000a10: 2041 6464 6974 696f 6e61 6c20 7061 7261   Additional para
-00000a20: 6d65 7465 7273 202d 2061 6464 6564 2074  meters - added t
-00000a30: 6f20 7468 6520 6363 7874 206f 626a 6563  o the ccxt objec
-00000a40: 740a 2020 2020 5f63 6378 745f 7061 7261  t.    _ccxt_para
-00000a50: 6d73 3a20 4469 6374 203d 207b 7d0a 0a20  ms: Dict = {}.. 
-00000a60: 2020 2023 2044 6963 7420 746f 2073 7065     # Dict to spe
-00000a70: 6369 6679 2077 6869 6368 206f 7074 696f  cify which optio
-00000a80: 6e73 2065 6163 6820 6578 6368 616e 6765  ns each exchange
-00000a90: 2069 6d70 6c65 6d65 6e74 730a 2020 2020   implements.    
-00000aa0: 2320 5468 6973 2064 6566 696e 6573 2064  # This defines d
-00000ab0: 6566 6175 6c74 732c 2077 6869 6368 2063  efaults, which c
-00000ac0: 616e 2062 6520 7365 6c65 6374 6976 656c  an be selectivel
-00000ad0: 7920 6f76 6572 7269 6464 656e 2062 7920  y overridden by 
-00000ae0: 7375 6263 6c61 7373 6573 2075 7369 6e67  subclasses using
-00000af0: 205f 6674 5f68 6173 0a20 2020 2023 206f   _ft_has.    # o
-00000b00: 7220 6279 2073 7065 6369 6679 696e 6720  r by specifying 
-00000b10: 7468 656d 2069 6e20 7468 6520 636f 6e66  them in the conf
-00000b20: 6967 7572 6174 696f 6e2e 0a20 2020 205f  iguration..    _
-00000b30: 6674 5f68 6173 5f64 6566 6175 6c74 3a20  ft_has_default: 
-00000b40: 4469 6374 203d 207b 0a20 2020 2020 2020  Dict = {.       
-00000b50: 2022 7374 6f70 6c6f 7373 5f6f 6e5f 6578   "stoploss_on_ex
-00000b60: 6368 616e 6765 223a 2046 616c 7365 2c0a  change": False,.
-00000b70: 2020 2020 2020 2020 2273 746f 705f 7072          "stop_pr
-00000b80: 6963 655f 7061 7261 6d22 3a20 2273 746f  ice_param": "sto
-00000b90: 7050 7269 6365 222c 0a20 2020 2020 2020  pPrice",.       
-00000ba0: 2022 6f72 6465 725f 7469 6d65 5f69 6e5f   "order_time_in_
-00000bb0: 666f 7263 6522 3a20 5b22 4754 4322 5d2c  force": ["GTC"],
-00000bc0: 0a20 2020 2020 2020 2022 6f68 6c63 765f  .        "ohlcv_
-00000bd0: 7061 7261 6d73 223a 207b 7d2c 0a20 2020  params": {},.   
-00000be0: 2020 2020 2022 6f68 6c63 765f 6361 6e64       "ohlcv_cand
-00000bf0: 6c65 5f6c 696d 6974 223a 2035 3030 2c0a  le_limit": 500,.
-00000c00: 2020 2020 2020 2020 226f 686c 6376 5f68          "ohlcv_h
-00000c10: 6173 5f68 6973 746f 7279 223a 2054 7275  as_history": Tru
-00000c20: 652c 2020 2320 536f 6d65 2065 7863 6861  e,  # Some excha
-00000c30: 6e67 6573 2028 4b72 616b 656e 2920 646f  nges (Kraken) do
-00000c40: 6e27 7420 7072 6f76 6964 6520 6869 7374  n't provide hist
-00000c50: 6f72 7920 7669 6120 6f68 6c63 760a 2020  ory via ohlcv.  
-00000c60: 2020 2020 2020 226f 686c 6376 5f70 6172        "ohlcv_par
-00000c70: 7469 616c 5f63 616e 646c 6522 3a20 5472  tial_candle": Tr
-00000c80: 7565 2c0a 2020 2020 2020 2020 226f 686c  ue,.        "ohl
-00000c90: 6376 5f72 6571 7569 7265 5f73 696e 6365  cv_require_since
-00000ca0: 223a 2046 616c 7365 2c0a 2020 2020 2020  ": False,.      
-00000cb0: 2020 2320 4368 6563 6b20 6874 7470 733a    # Check https:
-00000cc0: 2f2f 6769 7468 7562 2e63 6f6d 2f63 6378  //github.com/ccx
-00000cd0: 742f 6363 7874 2f69 7373 7565 732f 3130  t/ccxt/issues/10
-00000ce0: 3736 3720 666f 7220 7265 6d6f 7661 6c20  767 for removal 
-00000cf0: 6f66 206f 686c 6376 5f76 6f6c 756d 655f  of ohlcv_volume_
-00000d00: 6375 7272 656e 6379 0a20 2020 2020 2020  currency.       
-00000d10: 2022 6f68 6c63 765f 766f 6c75 6d65 5f63   "ohlcv_volume_c
-00000d20: 7572 7265 6e63 7922 3a20 2262 6173 6522  urrency": "base"
-00000d30: 2c20 2023 2022 6261 7365 2220 6f72 2022  ,  # "base" or "
-00000d40: 7175 6f74 6522 0a20 2020 2020 2020 2022  quote".        "
-00000d50: 7469 636b 6572 735f 6861 7665 5f71 756f  tickers_have_quo
-00000d60: 7465 566f 6c75 6d65 223a 2054 7275 652c  teVolume": True,
-00000d70: 0a20 2020 2020 2020 2022 7469 636b 6572  .        "ticker
-00000d80: 735f 6861 7665 5f62 6964 5f61 736b 223a  s_have_bid_ask":
-00000d90: 2054 7275 652c 2020 2320 6269 6420 2f20   True,  # bid / 
-00000da0: 6173 6b20 656d 7074 7920 666f 7220 6665  ask empty for fe
-00000db0: 7463 685f 7469 636b 6572 730a 2020 2020  tch_tickers.    
-00000dc0: 2020 2020 2274 6963 6b65 7273 5f68 6176      "tickers_hav
-00000dd0: 655f 7072 6963 6522 3a20 5472 7565 2c0a  e_price": True,.
-00000de0: 2020 2020 2020 2020 2274 7261 6465 735f          "trades_
-00000df0: 7061 6769 6e61 7469 6f6e 223a 2022 7469  pagination": "ti
-00000e00: 6d65 222c 2020 2320 506f 7373 6962 6c65  me",  # Possible
-00000e10: 2061 7265 2022 7469 6d65 2220 6f72 2022   are "time" or "
-00000e20: 6964 220a 2020 2020 2020 2020 2274 7261  id".        "tra
-00000e30: 6465 735f 7061 6769 6e61 7469 6f6e 5f61  des_pagination_a
-00000e40: 7267 223a 2022 7369 6e63 6522 2c0a 2020  rg": "since",.  
-00000e50: 2020 2020 2020 226c 325f 6c69 6d69 745f        "l2_limit_
-00000e60: 7261 6e67 6522 3a20 4e6f 6e65 2c0a 2020  range": None,.  
-00000e70: 2020 2020 2020 226c 325f 6c69 6d69 745f        "l2_limit_
-00000e80: 7261 6e67 655f 7265 7175 6972 6564 223a  range_required":
-00000e90: 2054 7275 652c 2020 2320 416c 6c6f 7720   True,  # Allow 
-00000ea0: 456d 7074 7920 4c32 206c 696d 6974 2028  Empty L2 limit (
-00000eb0: 6b75 636f 696e 290a 2020 2020 2020 2020  kucoin).        
-00000ec0: 226d 6172 6b5f 6f68 6c63 765f 7072 6963  "mark_ohlcv_pric
-00000ed0: 6522 3a20 226d 6172 6b22 2c0a 2020 2020  e": "mark",.    
-00000ee0: 2020 2020 226d 6172 6b5f 6f68 6c63 765f      "mark_ohlcv_
-00000ef0: 7469 6d65 6672 616d 6522 3a20 2238 6822  timeframe": "8h"
-00000f00: 2c0a 2020 2020 2020 2020 2263 6378 745f  ,.        "ccxt_
-00000f10: 6675 7475 7265 735f 6e61 6d65 223a 2022  futures_name": "
-00000f20: 7377 6170 222c 0a20 2020 2020 2020 2022  swap",.        "
-00000f30: 6665 655f 636f 7374 5f69 6e5f 636f 6e74  fee_cost_in_cont
-00000f40: 7261 6374 7322 3a20 4661 6c73 652c 2020  racts": False,  
-00000f50: 2320 4665 6520 636f 7374 206e 6565 6473  # Fee cost needs
-00000f60: 2063 6f6e 7472 6163 7420 636f 6e76 6572   contract conver
-00000f70: 7369 6f6e 0a20 2020 2020 2020 2022 6e65  sion.        "ne
-00000f80: 6564 735f 7472 6164 696e 675f 6665 6573  eds_trading_fees
-00000f90: 223a 2046 616c 7365 2c20 2023 2075 7365  ": False,  # use
-00000fa0: 2066 6574 6368 5f74 7261 6469 6e67 5f66   fetch_trading_f
-00000fb0: 6565 7320 746f 2063 6163 6865 2066 6565  ees to cache fee
-00000fc0: 730a 2020 2020 2020 2020 226f 7264 6572  s.        "order
-00000fd0: 5f70 726f 7073 5f69 6e5f 636f 6e74 7261  _props_in_contra
-00000fe0: 6374 7322 3a20 5b27 616d 6f75 6e74 272c  cts": ['amount',
-00000ff0: 2027 636f 7374 272c 2027 6669 6c6c 6564   'cost', 'filled
-00001000: 272c 2027 7265 6d61 696e 696e 6727 5d2c  ', 'remaining'],
-00001010: 0a20 2020 2020 2020 2023 204f 7665 7272  .        # Overr
-00001020: 6964 6520 6372 6561 7465 4d61 726b 6574  ide createMarket
-00001030: 4275 794f 7264 6572 5265 7175 6972 6573  BuyOrderRequires
-00001040: 5072 6963 6520 7768 6572 6520 6363 7874  Price where ccxt
-00001050: 2068 6173 2069 7420 7772 6f6e 670a 2020   has it wrong.  
-00001060: 2020 2020 2020 226d 6172 6b65 744f 7264        "marketOrd
-00001070: 6572 5265 7175 6972 6573 5072 6963 6522  erRequiresPrice"
-00001080: 3a20 4661 6c73 652c 0a20 2020 207d 0a20  : False,.    }. 
-00001090: 2020 205f 6674 5f68 6173 3a20 4469 6374     _ft_has: Dict
-000010a0: 203d 207b 7d0a 2020 2020 5f66 745f 6861   = {}.    _ft_ha
-000010b0: 735f 6675 7475 7265 733a 2044 6963 7420  s_futures: Dict 
-000010c0: 3d20 7b7d 0a0a 2020 2020 5f73 7570 706f  = {}..    _suppo
-000010d0: 7274 6564 5f74 7261 6469 6e67 5f6d 6f64  rted_trading_mod
-000010e0: 655f 6d61 7267 696e 5f70 6169 7273 3a20  e_margin_pairs: 
-000010f0: 4c69 7374 5b54 7570 6c65 5b54 7261 6469  List[Tuple[Tradi
-00001100: 6e67 4d6f 6465 2c20 4d61 7267 696e 4d6f  ngMode, MarginMo
-00001110: 6465 5d5d 203d 205b 0a20 2020 2020 2020  de]] = [.       
-00001120: 2023 2054 7261 6469 6e67 4d6f 6465 2e53   # TradingMode.S
-00001130: 504f 5420 616c 7761 7973 2073 7570 706f  POT always suppo
-00001140: 7274 6564 2061 6e64 206e 6f74 2072 6571  rted and not req
-00001150: 7569 7265 6420 696e 2074 6869 7320 6c69  uired in this li
-00001160: 7374 0a20 2020 205d 0a0a 2020 2020 6465  st.    ]..    de
-00001170: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00001180: 2063 6f6e 6669 673a 2043 6f6e 6669 672c   config: Config,
-00001190: 2076 616c 6964 6174 653a 2062 6f6f 6c20   validate: bool 
-000011a0: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-000011b0: 2020 2020 2020 2020 206c 6f61 645f 6c65           load_le
-000011c0: 7665 7261 6765 5f74 6965 7273 3a20 626f  verage_tiers: bo
-000011d0: 6f6c 203d 2046 616c 7365 2920 2d3e 204e  ol = False) -> N
-000011e0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-000011f0: 0a20 2020 2020 2020 2049 6e69 7469 616c  .        Initial
-00001200: 697a 6573 2074 6869 7320 6d6f 6475 6c65  izes this module
-00001210: 2077 6974 6820 7468 6520 6769 7665 6e20   with the given 
-00001220: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
-00001230: 6974 2064 6f65 7320 6261 7369 6320 7661  it does basic va
-00001240: 6c69 6461 7469 6f6e 2077 6865 7468 6572  lidation whether
-00001250: 2074 6865 2073 7065 6369 6669 6564 2065   the specified e
-00001260: 7863 6861 6e67 6520 616e 6420 7061 6972  xchange and pair
-00001270: 7320 6172 6520 7661 6c69 642e 0a20 2020  s are valid..   
-00001280: 2020 2020 203a 7265 7475 726e 3a20 4e6f       :return: No
-00001290: 6e65 0a20 2020 2020 2020 2022 2222 0a20  ne.        """. 
-000012a0: 2020 2020 2020 2073 656c 662e 5f61 7069         self._api
-000012b0: 3a20 6363 7874 2e45 7863 6861 6e67 650a  : ccxt.Exchange.
-000012c0: 2020 2020 2020 2020 7365 6c66 2e5f 6170          self._ap
-000012d0: 695f 6173 796e 633a 2063 6378 745f 6173  i_async: ccxt_as
-000012e0: 796e 632e 4578 6368 616e 6765 203d 204e  ync.Exchange = N
-000012f0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-00001300: 2e5f 6d61 726b 6574 733a 2044 6963 7420  ._markets: Dict 
-00001310: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-00001320: 662e 5f74 7261 6469 6e67 5f66 6565 733a  f._trading_fees:
-00001330: 2044 6963 745b 7374 722c 2041 6e79 5d20   Dict[str, Any] 
-00001340: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-00001350: 662e 5f6c 6576 6572 6167 655f 7469 6572  f._leverage_tier
-00001360: 733a 2044 6963 745b 7374 722c 204c 6973  s: Dict[str, Lis
-00001370: 745b 4469 6374 5d5d 203d 207b 7d0a 2020  t[Dict]] = {}.  
-00001380: 2020 2020 2020 2320 4c6f 636b 2065 7665        # Lock eve
-00001390: 6e74 206c 6f6f 702e 2054 6869 7320 6973  nt loop. This is
-000013a0: 206e 6563 6573 7361 7279 2074 6f20 6176   necessary to av
-000013b0: 6f69 6420 7261 6365 2d63 6f6e 6469 7469  oid race-conditi
-000013c0: 6f6e 7320 7768 656e 2075 7369 6e67 2066  ons when using f
-000013d0: 6f72 6365 2a20 636f 6d6d 616e 6473 0a20  orce* commands. 
-000013e0: 2020 2020 2020 2023 2044 7565 2074 6f20         # Due to 
-000013f0: 6675 6e64 696e 6720 6665 6520 6665 7463  funding fee fetc
-00001400: 6869 6e67 2e0a 2020 2020 2020 2020 7365  hing..        se
-00001410: 6c66 2e5f 6c6f 6f70 5f6c 6f63 6b20 3d20  lf._loop_lock = 
-00001420: 4c6f 636b 2829 0a20 2020 2020 2020 2073  Lock().        s
-00001430: 656c 662e 6c6f 6f70 203d 2061 7379 6e63  elf.loop = async
-00001440: 696f 2e6e 6577 5f65 7665 6e74 5f6c 6f6f  io.new_event_loo
-00001450: 7028 290a 2020 2020 2020 2020 6173 796e  p().        asyn
-00001460: 6369 6f2e 7365 745f 6576 656e 745f 6c6f  cio.set_event_lo
-00001470: 6f70 2873 656c 662e 6c6f 6f70 290a 2020  op(self.loop).  
-00001480: 2020 2020 2020 7365 6c66 2e5f 636f 6e66        self._conf
-00001490: 6967 3a20 436f 6e66 6967 203d 207b 7d0a  ig: Config = {}.
-000014a0: 0a20 2020 2020 2020 2073 656c 662e 5f63  .        self._c
-000014b0: 6f6e 6669 672e 7570 6461 7465 2863 6f6e  onfig.update(con
-000014c0: 6669 6729 0a0a 2020 2020 2020 2020 2320  fig)..        # 
-000014d0: 486f 6c64 7320 6c61 7374 2063 616e 646c  Holds last candl
-000014e0: 6520 7265 6672 6573 6865 6420 7469 6d65  e refreshed time
-000014f0: 206f 6620 6561 6368 2070 6169 720a 2020   of each pair.  
-00001500: 2020 2020 2020 7365 6c66 2e5f 7061 6972        self._pair
-00001510: 735f 6c61 7374 5f72 6566 7265 7368 5f74  s_last_refresh_t
-00001520: 696d 653a 2044 6963 745b 5061 6972 5769  ime: Dict[PairWi
-00001530: 7468 5469 6d65 6672 616d 652c 2069 6e74  thTimeframe, int
-00001540: 5d20 3d20 7b7d 0a20 2020 2020 2020 2023  ] = {}.        #
-00001550: 2054 696d 6573 7461 6d70 206f 6620 6c61   Timestamp of la
-00001560: 7374 206d 6172 6b65 7473 2072 6566 7265  st markets refre
-00001570: 7368 0a20 2020 2020 2020 2073 656c 662e  sh.        self.
-00001580: 5f6c 6173 745f 6d61 726b 6574 735f 7265  _last_markets_re
-00001590: 6672 6573 683a 2069 6e74 203d 2030 0a0a  fresh: int = 0..
-000015a0: 2020 2020 2020 2020 2320 4361 6368 6520          # Cache 
-000015b0: 666f 7220 3130 206d 696e 7574 6573 202e  for 10 minutes .
-000015c0: 2e2e 0a20 2020 2020 2020 2073 656c 662e  ...        self.
-000015d0: 5f63 6163 6865 5f6c 6f63 6b20 3d20 4c6f  _cache_lock = Lo
-000015e0: 636b 2829 0a20 2020 2020 2020 2073 656c  ck().        sel
-000015f0: 662e 5f66 6574 6368 5f74 6963 6b65 7273  f._fetch_tickers
-00001600: 5f63 6163 6865 3a20 5454 4c43 6163 6865  _cache: TTLCache
-00001610: 203d 2054 544c 4361 6368 6528 6d61 7873   = TTLCache(maxs
-00001620: 697a 653d 322c 2074 746c 3d36 3020 2a20  ize=2, ttl=60 * 
-00001630: 3130 290a 2020 2020 2020 2020 2320 4361  10).        # Ca
-00001640: 6368 6520 7661 6c75 6573 2066 6f72 2031  che values for 1
-00001650: 3830 3020 746f 2061 766f 6964 2066 7265  800 to avoid fre
-00001660: 7175 656e 7420 706f 6c6c 696e 6720 6f66  quent polling of
-00001670: 2074 6865 2065 7863 6861 6e67 6520 666f   the exchange fo
-00001680: 7220 7072 6963 6573 0a20 2020 2020 2020  r prices.       
-00001690: 2023 2043 6163 6869 6e67 206f 6e6c 7920   # Caching only 
-000016a0: 6170 706c 6965 7320 746f 2052 5043 206d  applies to RPC m
-000016b0: 6574 686f 6473 2c20 736f 2070 7269 6365  ethods, so price
-000016c0: 7320 666f 7220 6f70 656e 2074 7261 6465  s for open trade
-000016d0: 7320 6172 6520 7374 696c 6c0a 2020 2020  s are still.    
-000016e0: 2020 2020 2320 7265 6672 6573 6865 6420      # refreshed 
-000016f0: 6f6e 6365 2065 7665 7279 2069 7465 7261  once every itera
-00001700: 7469 6f6e 2e0a 2020 2020 2020 2020 7365  tion..        se
-00001710: 6c66 2e5f 6578 6974 5f72 6174 655f 6361  lf._exit_rate_ca
-00001720: 6368 653a 2054 544c 4361 6368 6520 3d20  che: TTLCache = 
-00001730: 5454 4c43 6163 6865 286d 6178 7369 7a65  TTLCache(maxsize
-00001740: 3d31 3030 2c20 7474 6c3d 3138 3030 290a  =100, ttl=1800).
-00001750: 2020 2020 2020 2020 7365 6c66 2e5f 656e          self._en
-00001760: 7472 795f 7261 7465 5f63 6163 6865 3a20  try_rate_cache: 
-00001770: 5454 4c43 6163 6865 203d 2054 544c 4361  TTLCache = TTLCa
-00001780: 6368 6528 6d61 7873 697a 653d 3130 302c  che(maxsize=100,
-00001790: 2074 746c 3d31 3830 3029 0a0a 2020 2020   ttl=1800)..    
-000017a0: 2020 2020 2320 486f 6c64 7320 6361 6e64      # Holds cand
-000017b0: 6c65 730a 2020 2020 2020 2020 7365 6c66  les.        self
-000017c0: 2e5f 6b6c 696e 6573 3a20 4469 6374 5b50  ._klines: Dict[P
-000017d0: 6169 7257 6974 6854 696d 6566 7261 6d65  airWithTimeframe
-000017e0: 2c20 4461 7461 4672 616d 655d 203d 207b  , DataFrame] = {
-000017f0: 7d0a 0a20 2020 2020 2020 2023 2048 6f6c  }..        # Hol
-00001800: 6473 2061 6c6c 206f 7065 6e20 7365 6c6c  ds all open sell
-00001810: 206f 7264 6572 7320 666f 7220 6472 795f   orders for dry_
-00001820: 7275 6e0a 2020 2020 2020 2020 7365 6c66  run.        self
-00001830: 2e5f 6472 795f 7275 6e5f 6f70 656e 5f6f  ._dry_run_open_o
-00001840: 7264 6572 733a 2044 6963 745b 7374 722c  rders: Dict[str,
-00001850: 2041 6e79 5d20 3d20 7b7d 0a20 2020 2020   Any] = {}.     
-00001860: 2020 2072 656d 6f76 655f 6372 6564 656e     remove_creden
-00001870: 7469 616c 7328 636f 6e66 6967 290a 0a20  tials(config).. 
-00001880: 2020 2020 2020 2069 6620 636f 6e66 6967         if config
-00001890: 5b27 6472 795f 7275 6e27 5d3a 0a20 2020  ['dry_run']:.   
-000018a0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-000018b0: 696e 666f 2827 496e 7374 616e 6365 2069  info('Instance i
-000018c0: 7320 7275 6e6e 696e 6720 7769 7468 2064  s running with d
-000018d0: 7279 5f72 756e 2065 6e61 626c 6564 2729  ry_run enabled')
-000018e0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-000018f0: 696e 666f 2866 2255 7369 6e67 2043 4358  info(f"Using CCX
-00001900: 5420 7b63 6378 742e 5f5f 7665 7273 696f  T {ccxt.__versio
-00001910: 6e5f 5f7d 2229 0a20 2020 2020 2020 2065  n__}").        e
-00001920: 7863 6861 6e67 655f 636f 6e66 6967 203d  xchange_config =
-00001930: 2063 6f6e 6669 675b 2765 7863 6861 6e67   config['exchang
-00001940: 6527 5d0a 2020 2020 2020 2020 7365 6c66  e'].        self
-00001950: 2e6c 6f67 5f72 6573 706f 6e73 6573 203d  .log_responses =
-00001960: 2065 7863 6861 6e67 655f 636f 6e66 6967   exchange_config
-00001970: 2e67 6574 2827 6c6f 675f 7265 7370 6f6e  .get('log_respon
-00001980: 7365 7327 2c20 4661 6c73 6529 0a0a 2020  ses', False)..  
-00001990: 2020 2020 2020 2320 4c65 7665 7261 6765        # Leverage
-000019a0: 2070 726f 7065 7274 6965 730a 2020 2020   properties.    
-000019b0: 2020 2020 7365 6c66 2e74 7261 6469 6e67      self.trading
-000019c0: 5f6d 6f64 653a 2054 7261 6469 6e67 4d6f  _mode: TradingMo
-000019d0: 6465 203d 2063 6f6e 6669 672e 6765 7428  de = config.get(
-000019e0: 2774 7261 6469 6e67 5f6d 6f64 6527 2c20  'trading_mode', 
-000019f0: 5472 6164 696e 674d 6f64 652e 5350 4f54  TradingMode.SPOT
-00001a00: 290a 2020 2020 2020 2020 7365 6c66 2e6d  ).        self.m
-00001a10: 6172 6769 6e5f 6d6f 6465 3a20 4d61 7267  argin_mode: Marg
-00001a20: 696e 4d6f 6465 203d 2028 0a20 2020 2020  inMode = (.     
-00001a30: 2020 2020 2020 204d 6172 6769 6e4d 6f64         MarginMod
-00001a40: 6528 636f 6e66 6967 2e67 6574 2827 6d61  e(config.get('ma
-00001a50: 7267 696e 5f6d 6f64 6527 2929 0a20 2020  rgin_mode')).   
-00001a60: 2020 2020 2020 2020 2069 6620 636f 6e66           if conf
-00001a70: 6967 2e67 6574 2827 6d61 7267 696e 5f6d  ig.get('margin_m
-00001a80: 6f64 6527 290a 2020 2020 2020 2020 2020  ode').          
-00001a90: 2020 656c 7365 204d 6172 6769 6e4d 6f64    else MarginMod
-00001aa0: 652e 4e4f 4e45 0a20 2020 2020 2020 2029  e.NONE.        )
-00001ab0: 0a20 2020 2020 2020 2073 656c 662e 6c69  .        self.li
-00001ac0: 7175 6964 6174 696f 6e5f 6275 6666 6572  quidation_buffer
-00001ad0: 203d 2063 6f6e 6669 672e 6765 7428 276c   = config.get('l
-00001ae0: 6971 7569 6461 7469 6f6e 5f62 7566 6665  iquidation_buffe
-00001af0: 7227 2c20 302e 3035 290a 0a20 2020 2020  r', 0.05)..     
-00001b00: 2020 2023 2044 6565 7020 6d65 7267 6520     # Deep merge 
-00001b10: 6674 5f68 6173 2077 6974 6820 6465 6661  ft_has with defa
-00001b20: 756c 7420 6674 5f68 6173 206f 7074 696f  ult ft_has optio
-00001b30: 6e73 0a20 2020 2020 2020 2073 656c 662e  ns.        self.
-00001b40: 5f66 745f 6861 7320 3d20 6465 6570 5f6d  _ft_has = deep_m
-00001b50: 6572 6765 5f64 6963 7473 2873 656c 662e  erge_dicts(self.
-00001b60: 5f66 745f 6861 732c 2064 6565 7063 6f70  _ft_has, deepcop
-00001b70: 7928 7365 6c66 2e5f 6674 5f68 6173 5f64  y(self._ft_has_d
-00001b80: 6566 6175 6c74 2929 0a20 2020 2020 2020  efault)).       
-00001b90: 2069 6620 7365 6c66 2e74 7261 6469 6e67   if self.trading
-00001ba0: 5f6d 6f64 6520 3d3d 2054 7261 6469 6e67  _mode == Trading
-00001bb0: 4d6f 6465 2e46 5554 5552 4553 3a0a 2020  Mode.FUTURES:.  
-00001bc0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00001bd0: 6674 5f68 6173 203d 2064 6565 705f 6d65  ft_has = deep_me
-00001be0: 7267 655f 6469 6374 7328 7365 6c66 2e5f  rge_dicts(self._
-00001bf0: 6674 5f68 6173 5f66 7574 7572 6573 2c20  ft_has_futures, 
-00001c00: 7365 6c66 2e5f 6674 5f68 6173 290a 2020  self._ft_has).  
-00001c10: 2020 2020 2020 6966 2065 7863 6861 6e67        if exchang
-00001c20: 655f 636f 6e66 6967 2e67 6574 2827 5f66  e_config.get('_f
-00001c30: 745f 6861 735f 7061 7261 6d73 2729 3a0a  t_has_params'):.
-00001c40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00001c50: 2e5f 6674 5f68 6173 203d 2064 6565 705f  ._ft_has = deep_
-00001c60: 6d65 7267 655f 6469 6374 7328 6578 6368  merge_dicts(exch
-00001c70: 616e 6765 5f63 6f6e 6669 672e 6765 7428  ange_config.get(
-00001c80: 275f 6674 5f68 6173 5f70 6172 616d 7327  '_ft_has_params'
-00001c90: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00001ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001cb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00001cc0: 656c 662e 5f66 745f 6861 7329 0a20 2020  elf._ft_has).   
-00001cd0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00001ce0: 696e 666f 2822 4f76 6572 7269 6469 6e67  info("Overriding
-00001cf0: 2065 7863 6861 6e67 652e 5f66 745f 6861   exchange._ft_ha
-00001d00: 7320 7769 7468 2063 6f6e 6669 6720 7061  s with config pa
-00001d10: 7261 6d73 2c20 7265 7375 6c74 3a20 2573  rams, result: %s
-00001d20: 222c 2073 656c 662e 5f66 745f 6861 7329  ", self._ft_has)
-00001d30: 0a0a 2020 2020 2020 2020 2320 4173 7369  ..        # Assi
-00001d40: 676e 2074 6869 7320 6469 7265 6374 6c79  gn this directly
-00001d50: 2066 6f72 2065 6173 7920 6163 6365 7373   for easy access
-00001d60: 0a20 2020 2020 2020 2073 656c 662e 5f6f  .        self._o
-00001d70: 686c 6376 5f70 6172 7469 616c 5f63 616e  hlcv_partial_can
-00001d80: 646c 6520 3d20 7365 6c66 2e5f 6674 5f68  dle = self._ft_h
-00001d90: 6173 5b27 6f68 6c63 765f 7061 7274 6961  as['ohlcv_partia
-00001da0: 6c5f 6361 6e64 6c65 275d 0a0a 2020 2020  l_candle']..    
-00001db0: 2020 2020 7365 6c66 2e5f 7472 6164 6573      self._trades
-00001dc0: 5f70 6167 696e 6174 696f 6e20 3d20 7365  _pagination = se
-00001dd0: 6c66 2e5f 6674 5f68 6173 5b27 7472 6164  lf._ft_has['trad
-00001de0: 6573 5f70 6167 696e 6174 696f 6e27 5d0a  es_pagination'].
-00001df0: 2020 2020 2020 2020 7365 6c66 2e5f 7472          self._tr
-00001e00: 6164 6573 5f70 6167 696e 6174 696f 6e5f  ades_pagination_
-00001e10: 6172 6720 3d20 7365 6c66 2e5f 6674 5f68  arg = self._ft_h
-00001e20: 6173 5b27 7472 6164 6573 5f70 6167 696e  as['trades_pagin
-00001e30: 6174 696f 6e5f 6172 6727 5d0a 0a20 2020  ation_arg']..   
-00001e40: 2020 2020 2023 2049 6e69 7469 616c 697a       # Initializ
-00001e50: 6520 6363 7874 206f 626a 6563 7473 0a20  e ccxt objects. 
-00001e60: 2020 2020 2020 2063 6378 745f 636f 6e66         ccxt_conf
-00001e70: 6967 203d 2073 656c 662e 5f63 6378 745f  ig = self._ccxt_
-00001e80: 636f 6e66 6967 0a20 2020 2020 2020 2063  config.        c
-00001e90: 6378 745f 636f 6e66 6967 203d 2064 6565  cxt_config = dee
-00001ea0: 705f 6d65 7267 655f 6469 6374 7328 6578  p_merge_dicts(ex
-00001eb0: 6368 616e 6765 5f63 6f6e 6669 672e 6765  change_config.ge
-00001ec0: 7428 2763 6378 745f 636f 6e66 6967 272c  t('ccxt_config',
-00001ed0: 207b 7d29 2c20 6363 7874 5f63 6f6e 6669   {}), ccxt_confi
-00001ee0: 6729 0a20 2020 2020 2020 2063 6378 745f  g).        ccxt_
-00001ef0: 636f 6e66 6967 203d 2064 6565 705f 6d65  config = deep_me
-00001f00: 7267 655f 6469 6374 7328 6578 6368 616e  rge_dicts(exchan
-00001f10: 6765 5f63 6f6e 6669 672e 6765 7428 2763  ge_config.get('c
-00001f20: 6378 745f 7379 6e63 5f63 6f6e 6669 6727  cxt_sync_config'
-00001f30: 2c20 7b7d 292c 2063 6378 745f 636f 6e66  , {}), ccxt_conf
-00001f40: 6967 290a 0a20 2020 2020 2020 2073 656c  ig)..        sel
-00001f50: 662e 5f61 7069 203d 2073 656c 662e 5f69  f._api = self._i
-00001f60: 6e69 745f 6363 7874 2865 7863 6861 6e67  nit_ccxt(exchang
-00001f70: 655f 636f 6e66 6967 2c20 6363 7874 5f6b  e_config, ccxt_k
-00001f80: 7761 7267 733d 6363 7874 5f63 6f6e 6669  wargs=ccxt_confi
-00001f90: 6729 0a0a 2020 2020 2020 2020 6363 7874  g)..        ccxt
-00001fa0: 5f61 7379 6e63 5f63 6f6e 6669 6720 3d20  _async_config = 
-00001fb0: 7365 6c66 2e5f 6363 7874 5f63 6f6e 6669  self._ccxt_confi
-00001fc0: 670a 2020 2020 2020 2020 6363 7874 5f61  g.        ccxt_a
-00001fd0: 7379 6e63 5f63 6f6e 6669 6720 3d20 6465  sync_config = de
-00001fe0: 6570 5f6d 6572 6765 5f64 6963 7473 2865  ep_merge_dicts(e
-00001ff0: 7863 6861 6e67 655f 636f 6e66 6967 2e67  xchange_config.g
-00002000: 6574 2827 6363 7874 5f63 6f6e 6669 6727  et('ccxt_config'
-00002010: 2c20 7b7d 292c 0a20 2020 2020 2020 2020  , {}),.         
-00002020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002040: 2020 2020 6363 7874 5f61 7379 6e63 5f63      ccxt_async_c
-00002050: 6f6e 6669 6729 0a20 2020 2020 2020 2063  onfig).        c
-00002060: 6378 745f 6173 796e 635f 636f 6e66 6967  cxt_async_config
-00002070: 203d 2064 6565 705f 6d65 7267 655f 6469   = deep_merge_di
-00002080: 6374 7328 6578 6368 616e 6765 5f63 6f6e  cts(exchange_con
-00002090: 6669 672e 6765 7428 2763 6378 745f 6173  fig.get('ccxt_as
-000020a0: 796e 635f 636f 6e66 6967 272c 207b 7d29  ync_config', {})
-000020b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000020c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000020e0: 6378 745f 6173 796e 635f 636f 6e66 6967  cxt_async_config
-000020f0: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-00002100: 6170 695f 6173 796e 6320 3d20 7365 6c66  api_async = self
-00002110: 2e5f 696e 6974 5f63 6378 7428 0a20 2020  ._init_ccxt(.   
-00002120: 2020 2020 2020 2020 2065 7863 6861 6e67           exchang
-00002130: 655f 636f 6e66 6967 2c20 6363 7874 5f61  e_config, ccxt_a
-00002140: 7379 6e63 2c20 6363 7874 5f6b 7761 7267  sync, ccxt_kwarg
-00002150: 733d 6363 7874 5f61 7379 6e63 5f63 6f6e  s=ccxt_async_con
-00002160: 6669 6729 0a0a 2020 2020 2020 2020 6c6f  fig)..        lo
-00002170: 6767 6572 2e69 6e66 6f28 6627 5573 696e  gger.info(f'Usin
-00002180: 6720 4578 6368 616e 6765 2022 7b73 656c  g Exchange "{sel
-00002190: 662e 6e61 6d65 7d22 2729 0a20 2020 2020  f.name}"').     
-000021a0: 2020 2073 656c 662e 7265 7175 6972 6564     self.required
-000021b0: 5f63 616e 646c 655f 6361 6c6c 5f63 6f75  _candle_call_cou
-000021c0: 6e74 203d 2031 0a20 2020 2020 2020 2069  nt = 1.        i
-000021d0: 6620 7661 6c69 6461 7465 3a0a 2020 2020  f validate:.    
-000021e0: 2020 2020 2020 2020 2320 496e 6974 6961          # Initia
-000021f0: 6c20 6d61 726b 6574 7320 6c6f 6164 0a20  l markets load. 
-00002200: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00002210: 5f6c 6f61 645f 6d61 726b 6574 7328 290a  _load_markets().
-00002220: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00002230: 2e76 616c 6964 6174 655f 636f 6e66 6967  .validate_config
-00002240: 2863 6f6e 6669 6729 0a20 2020 2020 2020  (config).       
-00002250: 2020 2020 2073 656c 662e 5f73 7461 7274       self._start
-00002260: 7570 5f63 616e 646c 655f 636f 756e 743a  up_candle_count:
-00002270: 2069 6e74 203d 2063 6f6e 6669 672e 6765   int = config.ge
-00002280: 7428 2773 7461 7274 7570 5f63 616e 646c  t('startup_candl
-00002290: 655f 636f 756e 7427 2c20 3029 0a20 2020  e_count', 0).   
-000022a0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-000022b0: 7175 6972 6564 5f63 616e 646c 655f 6361  quired_candle_ca
-000022c0: 6c6c 5f63 6f75 6e74 203d 2073 656c 662e  ll_count = self.
-000022d0: 7661 6c69 6461 7465 5f72 6571 7569 7265  validate_require
-000022e0: 645f 7374 6172 7475 705f 6361 6e64 6c65  d_startup_candle
-000022f0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00002300: 2020 2073 656c 662e 5f73 7461 7274 7570     self._startup
-00002310: 5f63 616e 646c 655f 636f 756e 742c 2063  _candle_count, c
-00002320: 6f6e 6669 672e 6765 7428 2774 696d 6566  onfig.get('timef
-00002330: 7261 6d65 272c 2027 2729 290a 0a20 2020  rame', ''))..   
-00002340: 2020 2020 2023 2043 6f6e 7665 7274 7320       # Converts 
-00002350: 7468 6520 696e 7465 7276 616c 2070 726f  the interval pro
-00002360: 7669 6465 6420 696e 206d 696e 7574 6573  vided in minutes
-00002370: 2069 6e20 636f 6e66 6967 2074 6f20 7365   in config to se
-00002380: 636f 6e64 730a 2020 2020 2020 2020 7365  conds.        se
-00002390: 6c66 2e6d 6172 6b65 7473 5f72 6566 7265  lf.markets_refre
-000023a0: 7368 5f69 6e74 6572 7661 6c3a 2069 6e74  sh_interval: int
-000023b0: 203d 2065 7863 6861 6e67 655f 636f 6e66   = exchange_conf
-000023c0: 6967 2e67 6574 280a 2020 2020 2020 2020  ig.get(.        
-000023d0: 2020 2020 226d 6172 6b65 7473 5f72 6566      "markets_ref
-000023e0: 7265 7368 5f69 6e74 6572 7661 6c22 2c20  resh_interval", 
-000023f0: 3630 2920 2a20 3630 0a0a 2020 2020 2020  60) * 60..      
-00002400: 2020 6966 2073 656c 662e 7472 6164 696e    if self.tradin
-00002410: 675f 6d6f 6465 2021 3d20 5472 6164 696e  g_mode != Tradin
-00002420: 674d 6f64 652e 5350 4f54 2061 6e64 206c  gMode.SPOT and l
-00002430: 6f61 645f 6c65 7665 7261 6765 5f74 6965  oad_leverage_tie
-00002440: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00002450: 7365 6c66 2e66 696c 6c5f 6c65 7665 7261  self.fill_levera
-00002460: 6765 5f74 6965 7273 2829 0a20 2020 2020  ge_tiers().     
-00002470: 2020 2073 656c 662e 6164 6469 7469 6f6e     self.addition
-00002480: 616c 5f65 7863 6861 6e67 655f 696e 6974  al_exchange_init
-00002490: 2829 0a0a 2020 2020 6465 6620 5f5f 6465  ()..    def __de
-000024a0: 6c5f 5f28 7365 6c66 293a 0a20 2020 2020  l__(self):.     
-000024b0: 2020 2022 2222 0a20 2020 2020 2020 2044     """.        D
-000024c0: 6573 7472 7563 746f 7220 2d20 636c 6561  estructor - clea
-000024d0: 6e20 7570 2061 7379 6e63 2073 7475 6666  n up async stuff
-000024e0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000024f0: 2020 2020 2073 656c 662e 636c 6f73 6528       self.close(
-00002500: 290a 0a20 2020 2064 6566 2063 6c6f 7365  )..    def close
-00002510: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00002520: 6c6f 6767 6572 2e64 6562 7567 2822 4578  logger.debug("Ex
-00002530: 6368 616e 6765 206f 626a 6563 7420 6465  change object de
-00002540: 7374 726f 7965 642c 2063 6c6f 7369 6e67  stroyed, closing
-00002550: 2061 7379 6e63 206c 6f6f 7022 290a 2020   async loop").  
-00002560: 2020 2020 2020 6966 2028 7365 6c66 2e5f        if (self._
-00002570: 6170 695f 6173 796e 6320 616e 6420 696e  api_async and in
-00002580: 7370 6563 742e 6973 636f 726f 7574 696e  spect.iscoroutin
-00002590: 6566 756e 6374 696f 6e28 7365 6c66 2e5f  efunction(self._
-000025a0: 6170 695f 6173 796e 632e 636c 6f73 6529  api_async.close)
-000025b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000025c0: 2061 6e64 2073 656c 662e 5f61 7069 5f61   and self._api_a
-000025d0: 7379 6e63 2e73 6573 7369 6f6e 293a 0a20  sync.session):. 
-000025e0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-000025f0: 722e 6465 6275 6728 2243 6c6f 7369 6e67  r.debug("Closing
-00002600: 2061 7379 6e63 2063 6378 7420 7365 7373   async ccxt sess
-00002610: 696f 6e2e 2229 0a20 2020 2020 2020 2020  ion.").         
-00002620: 2020 2073 656c 662e 6c6f 6f70 2e72 756e     self.loop.run
-00002630: 5f75 6e74 696c 5f63 6f6d 706c 6574 6528  _until_complete(
-00002640: 7365 6c66 2e5f 6170 695f 6173 796e 632e  self._api_async.
-00002650: 636c 6f73 6528 2929 0a20 2020 2020 2020  close()).       
-00002660: 2069 6620 7365 6c66 2e6c 6f6f 7020 616e   if self.loop an
-00002670: 6420 6e6f 7420 7365 6c66 2e6c 6f6f 702e  d not self.loop.
-00002680: 6973 5f63 6c6f 7365 6428 293a 0a20 2020  is_closed():.   
-00002690: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-000026a0: 6f70 2e63 6c6f 7365 2829 0a0a 2020 2020  op.close()..    
-000026b0: 6465 6620 7661 6c69 6461 7465 5f63 6f6e  def validate_con
-000026c0: 6669 6728 7365 6c66 2c20 636f 6e66 6967  fig(self, config
-000026d0: 293a 0a20 2020 2020 2020 2023 2043 6865  ):.        # Che
-000026e0: 636b 2069 6620 7469 6d65 6672 616d 6520  ck if timeframe 
-000026f0: 6973 2061 7661 696c 6162 6c65 0a20 2020  is available.   
-00002700: 2020 2020 2073 656c 662e 7661 6c69 6461       self.valida
-00002710: 7465 5f74 696d 6566 7261 6d65 7328 636f  te_timeframes(co
-00002720: 6e66 6967 2e67 6574 2827 7469 6d65 6672  nfig.get('timefr
-00002730: 616d 6527 2929 0a0a 2020 2020 2020 2020  ame'))..        
-00002740: 2320 4368 6563 6b20 6966 2061 6c6c 2070  # Check if all p
-00002750: 6169 7273 2061 7265 2061 7661 696c 6162  airs are availab
-00002760: 6c65 0a20 2020 2020 2020 2073 656c 662e  le.        self.
-00002770: 7661 6c69 6461 7465 5f73 7461 6b65 6375  validate_stakecu
-00002780: 7272 656e 6379 2863 6f6e 6669 675b 2773  rrency(config['s
-00002790: 7461 6b65 5f63 7572 7265 6e63 7927 5d29  take_currency'])
-000027a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000027b0: 636f 6e66 6967 5b27 6578 6368 616e 6765  config['exchange
-000027c0: 275d 2e67 6574 2827 736b 6970 5f70 6169  '].get('skip_pai
-000027d0: 725f 7661 6c69 6461 7469 6f6e 2729 3a0a  r_validation'):.
-000027e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000027f0: 2e76 616c 6964 6174 655f 7061 6972 7328  .validate_pairs(
-00002800: 636f 6e66 6967 5b27 6578 6368 616e 6765  config['exchange
-00002810: 275d 5b27 7061 6972 5f77 6869 7465 6c69  ']['pair_whiteli
-00002820: 7374 275d 290a 2020 2020 2020 2020 7365  st']).        se
-00002830: 6c66 2e76 616c 6964 6174 655f 6f72 6465  lf.validate_orde
-00002840: 7274 7970 6573 2863 6f6e 6669 672e 6765  rtypes(config.ge
-00002850: 7428 276f 7264 6572 5f74 7970 6573 272c  t('order_types',
-00002860: 207b 7d29 290a 2020 2020 2020 2020 7365   {})).        se
-00002870: 6c66 2e76 616c 6964 6174 655f 6f72 6465  lf.validate_orde
-00002880: 725f 7469 6d65 5f69 6e5f 666f 7263 6528  r_time_in_force(
-00002890: 636f 6e66 6967 2e67 6574 2827 6f72 6465  config.get('orde
-000028a0: 725f 7469 6d65 5f69 6e5f 666f 7263 6527  r_time_in_force'
-000028b0: 2c20 7b7d 2929 0a20 2020 2020 2020 2073  , {})).        s
-000028c0: 656c 662e 7661 6c69 6461 7465 5f74 7261  elf.validate_tra
-000028d0: 6469 6e67 5f6d 6f64 655f 616e 645f 6d61  ding_mode_and_ma
-000028e0: 7267 696e 5f6d 6f64 6528 7365 6c66 2e74  rgin_mode(self.t
-000028f0: 7261 6469 6e67 5f6d 6f64 652c 2073 656c  rading_mode, sel
-00002900: 662e 6d61 7267 696e 5f6d 6f64 6529 0a20  f.margin_mode). 
-00002910: 2020 2020 2020 2073 656c 662e 7661 6c69         self.vali
-00002920: 6461 7465 5f70 7269 6369 6e67 2863 6f6e  date_pricing(con
-00002930: 6669 675b 2765 7869 745f 7072 6963 696e  fig['exit_pricin
-00002940: 6727 5d29 0a20 2020 2020 2020 2073 656c  g']).        sel
-00002950: 662e 7661 6c69 6461 7465 5f70 7269 6369  f.validate_prici
-00002960: 6e67 2863 6f6e 6669 675b 2765 6e74 7279  ng(config['entry
-00002970: 5f70 7269 6369 6e67 275d 290a 0a20 2020  _pricing'])..   
-00002980: 2064 6566 205f 696e 6974 5f63 6378 7428   def _init_ccxt(
-00002990: 7365 6c66 2c20 6578 6368 616e 6765 5f63  self, exchange_c
-000029a0: 6f6e 6669 673a 2044 6963 745b 7374 722c  onfig: Dict[str,
-000029b0: 2041 6e79 5d2c 2063 6378 745f 6d6f 6475   Any], ccxt_modu
-000029c0: 6c65 3a20 4363 7874 4d6f 6475 6c65 5479  le: CcxtModuleTy
-000029d0: 7065 203d 2063 6378 742c 0a20 2020 2020  pe = ccxt,.     
-000029e0: 2020 2020 2020 2020 2020 2020 2020 6363                cc
-000029f0: 7874 5f6b 7761 7267 733a 2044 6963 7420  xt_kwargs: Dict 
-00002a00: 3d20 7b7d 2920 2d3e 2063 6378 742e 4578  = {}) -> ccxt.Ex
-00002a10: 6368 616e 6765 3a0a 2020 2020 2020 2020  change:.        
-00002a20: 2222 220a 2020 2020 2020 2020 496e 6974  """.        Init
-00002a30: 6961 6c69 7a65 2063 6378 7420 7769 7468  ialize ccxt with
-00002a40: 2067 6976 656e 2063 6f6e 6669 6720 616e   given config an
-00002a50: 6420 7265 7475 726e 2076 616c 6964 0a20  d return valid. 
-00002a60: 2020 2020 2020 2063 6378 7420 696e 7374         ccxt inst
-00002a70: 616e 6365 2e0a 2020 2020 2020 2020 2222  ance..        ""
-00002a80: 220a 2020 2020 2020 2020 2320 4669 6e64  ".        # Find
-00002a90: 206d 6174 6368 696e 6720 636c 6173 7320   matching class 
-00002aa0: 666f 7220 7468 6520 6769 7665 6e20 6578  for the given ex
-00002ab0: 6368 616e 6765 206e 616d 650a 2020 2020  change name.    
-00002ac0: 2020 2020 6e61 6d65 203d 2065 7863 6861      name = excha
-00002ad0: 6e67 655f 636f 6e66 6967 5b27 6e61 6d65  nge_config['name
-00002ae0: 275d 0a0a 2020 2020 2020 2020 6966 206e  ']..        if n
-00002af0: 6f74 2069 735f 6578 6368 616e 6765 5f6b  ot is_exchange_k
-00002b00: 6e6f 776e 5f63 6378 7428 6e61 6d65 2c20  nown_ccxt(name, 
-00002b10: 6363 7874 5f6d 6f64 756c 6529 3a0a 2020  ccxt_module):.  
-00002b20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00002b30: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
-00002b40: 7469 6f6e 2866 2745 7863 6861 6e67 6520  tion(f'Exchange 
-00002b50: 7b6e 616d 657d 2069 7320 6e6f 7420 7375  {name} is not su
-00002b60: 7070 6f72 7465 6420 6279 2063 6378 7427  pported by ccxt'
-00002b70: 290a 0a20 2020 2020 2020 2065 785f 636f  )..        ex_co
-00002b80: 6e66 6967 203d 207b 0a20 2020 2020 2020  nfig = {.       
-00002b90: 2020 2020 2027 6170 694b 6579 273a 2065       'apiKey': e
-00002ba0: 7863 6861 6e67 655f 636f 6e66 6967 2e67  xchange_config.g
-00002bb0: 6574 2827 6b65 7927 292c 0a20 2020 2020  et('key'),.     
-00002bc0: 2020 2020 2020 2027 7365 6372 6574 273a         'secret':
-00002bd0: 2065 7863 6861 6e67 655f 636f 6e66 6967   exchange_config
-00002be0: 2e67 6574 2827 7365 6372 6574 2729 2c0a  .get('secret'),.
-00002bf0: 2020 2020 2020 2020 2020 2020 2770 6173              'pas
-00002c00: 7377 6f72 6427 3a20 6578 6368 616e 6765  sword': exchange
-00002c10: 5f63 6f6e 6669 672e 6765 7428 2770 6173  _config.get('pas
-00002c20: 7377 6f72 6427 292c 0a20 2020 2020 2020  sword'),.       
-00002c30: 2020 2020 2027 7569 6427 3a20 6578 6368       'uid': exch
-00002c40: 616e 6765 5f63 6f6e 6669 672e 6765 7428  ange_config.get(
-00002c50: 2775 6964 272c 2027 2729 2c0a 2020 2020  'uid', ''),.    
-00002c60: 2020 2020 7d0a 2020 2020 2020 2020 6966      }.        if
-00002c70: 2063 6378 745f 6b77 6172 6773 3a0a 2020   ccxt_kwargs:.  
-00002c80: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00002c90: 2e69 6e66 6f28 2741 7070 6c79 696e 6720  .info('Applying 
-00002ca0: 6164 6469 7469 6f6e 616c 2063 6378 7420  additional ccxt 
-00002cb0: 636f 6e66 6967 3a20 2573 272c 2063 6378  config: %s', ccx
-00002cc0: 745f 6b77 6172 6773 290a 2020 2020 2020  t_kwargs).      
-00002cd0: 2020 6966 2073 656c 662e 5f63 6378 745f    if self._ccxt_
-00002ce0: 7061 7261 6d73 3a0a 2020 2020 2020 2020  params:.        
-00002cf0: 2020 2020 2320 496e 6a65 6374 2073 7461      # Inject sta
-00002d00: 7469 6320 6f70 7469 6f6e 7320 6166 7465  tic options afte
-00002d10: 7220 7468 6520 6162 6f76 6520 6f75 7470  r the above outp
-00002d20: 7574 2074 6f20 6e6f 7420 636f 6e66 7573  ut to not confus
-00002d30: 6520 7573 6572 732e 0a20 2020 2020 2020  e users..       
-00002d40: 2020 2020 2063 6378 745f 6b77 6172 6773       ccxt_kwargs
-00002d50: 203d 2064 6565 705f 6d65 7267 655f 6469   = deep_merge_di
-00002d60: 6374 7328 7365 6c66 2e5f 6363 7874 5f70  cts(self._ccxt_p
-00002d70: 6172 616d 732c 2063 6378 745f 6b77 6172  arams, ccxt_kwar
-00002d80: 6773 290a 2020 2020 2020 2020 6966 2063  gs).        if c
-00002d90: 6378 745f 6b77 6172 6773 3a0a 2020 2020  cxt_kwargs:.    
-00002da0: 2020 2020 2020 2020 6578 5f63 6f6e 6669          ex_confi
-00002db0: 672e 7570 6461 7465 2863 6378 745f 6b77  g.update(ccxt_kw
-00002dc0: 6172 6773 290a 2020 2020 2020 2020 7472  args).        tr
-00002dd0: 793a 0a0a 2020 2020 2020 2020 2020 2020  y:..            
-00002de0: 6170 6920 3d20 6765 7461 7474 7228 6363  api = getattr(cc
-00002df0: 7874 5f6d 6f64 756c 652c 206e 616d 652e  xt_module, name.
-00002e00: 6c6f 7765 7228 2929 2865 785f 636f 6e66  lower())(ex_conf
-00002e10: 6967 290a 2020 2020 2020 2020 6578 6365  ig).        exce
-00002e20: 7074 2028 4b65 7945 7272 6f72 2c20 4174  pt (KeyError, At
-00002e30: 7472 6962 7574 6545 7272 6f72 2920 6173  tributeError) as
-00002e40: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00002e50: 7261 6973 6520 4f70 6572 6174 696f 6e61  raise Operationa
-00002e60: 6c45 7863 6570 7469 6f6e 2866 2745 7863  lException(f'Exc
-00002e70: 6861 6e67 6520 7b6e 616d 657d 2069 7320  hange {name} is 
-00002e80: 6e6f 7420 7375 7070 6f72 7465 6427 2920  not supported') 
-00002e90: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
-00002ea0: 7863 6570 7420 6363 7874 2e42 6173 6545  xcept ccxt.BaseE
-00002eb0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-00002ec0: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
-00002ed0: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
-00002ee0: 6e28 6622 496e 6974 6961 6c69 7a61 7469  n(f"Initializati
-00002ef0: 6f6e 206f 6620 6363 7874 2066 6169 6c65  on of ccxt faile
-00002f00: 642e 2052 6561 736f 6e3a 207b 657d 2229  d. Reason: {e}")
-00002f10: 2066 726f 6d20 650a 0a20 2020 2020 2020   from e..       
-00002f20: 2073 656c 662e 7365 745f 7361 6e64 626f   self.set_sandbo
-00002f30: 7828 6170 692c 2065 7863 6861 6e67 655f  x(api, exchange_
-00002f40: 636f 6e66 6967 2c20 6e61 6d65 290a 0a20  config, name).. 
-00002f50: 2020 2020 2020 2072 6574 7572 6e20 6170         return ap
-00002f60: 690a 0a20 2020 2040 7072 6f70 6572 7479  i..    @property
-00002f70: 0a20 2020 2064 6566 205f 6363 7874 5f63  .    def _ccxt_c
-00002f80: 6f6e 6669 6728 7365 6c66 2920 2d3e 2044  onfig(self) -> D
-00002f90: 6963 743a 0a20 2020 2020 2020 2023 2050  ict:.        # P
-00002fa0: 6172 616d 6574 6572 7320 746f 2061 6464  arameters to add
-00002fb0: 2064 6972 6563 746c 7920 746f 2063 6378   directly to ccx
-00002fc0: 7420 7379 6e63 2f61 7379 6e63 2069 6e69  t sync/async ini
-00002fd0: 7469 616c 697a 6174 696f 6e2e 0a20 2020  tialization..   
-00002fe0: 2020 2020 2069 6620 7365 6c66 2e74 7261       if self.tra
-00002ff0: 6469 6e67 5f6d 6f64 6520 3d3d 2054 7261  ding_mode == Tra
-00003000: 6469 6e67 4d6f 6465 2e4d 4152 4749 4e3a  dingMode.MARGIN:
-00003010: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00003020: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
-00003030: 2020 2020 2020 226f 7074 696f 6e73 223a        "options":
-00003040: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00003050: 2020 2020 2020 2022 6465 6661 756c 7454         "defaultT
-00003060: 7970 6522 3a20 226d 6172 6769 6e22 0a20  ype": "margin". 
-00003070: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00003080: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00003090: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-000030a0: 2e74 7261 6469 6e67 5f6d 6f64 6520 3d3d  .trading_mode ==
-000030b0: 2054 7261 6469 6e67 4d6f 6465 2e46 5554   TradingMode.FUT
-000030c0: 5552 4553 3a0a 2020 2020 2020 2020 2020  URES:.          
-000030d0: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
-000030e0: 2020 2020 2020 2020 2020 2022 6f70 7469             "opti
-000030f0: 6f6e 7322 3a20 7b0a 2020 2020 2020 2020  ons": {.        
-00003100: 2020 2020 2020 2020 2020 2020 2264 6566              "def
-00003110: 6175 6c74 5479 7065 223a 2073 656c 662e  aultType": self.
-00003120: 5f66 745f 6861 735b 2263 6378 745f 6675  _ft_has["ccxt_fu
-00003130: 7475 7265 735f 6e61 6d65 225d 0a20 2020  tures_name"].   
-00003140: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00003150: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00003160: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00003170: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
-00003180: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00003190: 2020 2020 6465 6620 6e61 6d65 2873 656c      def name(sel
-000031a0: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
-000031b0: 2020 2022 2222 6578 6368 616e 6765 204e     """exchange N
-000031c0: 616d 6520 2866 726f 6d20 6363 7874 2922  ame (from ccxt)"
-000031d0: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-000031e0: 6e20 7365 6c66 2e5f 6170 692e 6e61 6d65  n self._api.name
-000031f0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00003200: 2020 2020 6465 6620 6964 2873 656c 6629      def id(self)
-00003210: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00003220: 2022 2222 6578 6368 616e 6765 2063 6378   """exchange ccx
-00003230: 7420 6964 2222 220a 2020 2020 2020 2020  t id""".        
-00003240: 7265 7475 726e 2073 656c 662e 5f61 7069  return self._api
-00003250: 2e69 640a 0a20 2020 2040 7072 6f70 6572  .id..    @proper
-00003260: 7479 0a20 2020 2064 6566 2074 696d 6566  ty.    def timef
-00003270: 7261 6d65 7328 7365 6c66 2920 2d3e 204c  rames(self) -> L
-00003280: 6973 745b 7374 725d 3a0a 2020 2020 2020  ist[str]:.      
-00003290: 2020 7265 7475 726e 206c 6973 7428 2873    return list((s
-000032a0: 656c 662e 5f61 7069 2e74 696d 6566 7261  elf._api.timefra
-000032b0: 6d65 7320 6f72 207b 7d29 2e6b 6579 7328  mes or {}).keys(
-000032c0: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
-000032d0: 790a 2020 2020 6465 6620 6d61 726b 6574  y.    def market
-000032e0: 7328 7365 6c66 2920 2d3e 2044 6963 743a  s(self) -> Dict:
-000032f0: 0a20 2020 2020 2020 2022 2222 6578 6368  .        """exch
-00003300: 616e 6765 2063 6378 7420 6d61 726b 6574  ange ccxt market
-00003310: 7322 2222 0a20 2020 2020 2020 2069 6620  s""".        if 
-00003320: 6e6f 7420 7365 6c66 2e5f 6d61 726b 6574  not self._market
-00003330: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
-00003340: 6f67 6765 722e 696e 666f 2822 4d61 726b  ogger.info("Mark
-00003350: 6574 7320 7765 7265 206e 6f74 206c 6f61  ets were not loa
-00003360: 6465 642e 204c 6f61 6469 6e67 2074 6865  ded. Loading the
-00003370: 6d20 6e6f 772e 2e22 290a 2020 2020 2020  m now..").      
-00003380: 2020 2020 2020 7365 6c66 2e5f 6c6f 6164        self._load
-00003390: 5f6d 6172 6b65 7473 2829 0a20 2020 2020  _markets().     
-000033a0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-000033b0: 6d61 726b 6574 730a 0a20 2020 2040 7072  markets..    @pr
-000033c0: 6f70 6572 7479 0a20 2020 2064 6566 2070  operty.    def p
-000033d0: 7265 6369 7369 6f6e 4d6f 6465 2873 656c  recisionMode(sel
-000033e0: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
-000033f0: 2020 2022 2222 6578 6368 616e 6765 2063     """exchange c
-00003400: 6378 7420 7072 6563 6973 696f 6e4d 6f64  cxt precisionMod
-00003410: 6522 2222 0a20 2020 2020 2020 2072 6574  e""".        ret
-00003420: 7572 6e20 7365 6c66 2e5f 6170 692e 7072  urn self._api.pr
-00003430: 6563 6973 696f 6e4d 6f64 650a 0a20 2020  ecisionMode..   
-00003440: 2064 6566 2061 6464 6974 696f 6e61 6c5f   def additional_
-00003450: 6578 6368 616e 6765 5f69 6e69 7428 7365  exchange_init(se
-00003460: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
-00003470: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00003480: 2041 6464 6974 696f 6e61 6c20 6578 6368   Additional exch
-00003490: 616e 6765 2069 6e69 7469 616c 697a 6174  ange initializat
-000034a0: 696f 6e20 6c6f 6769 632e 0a20 2020 2020  ion logic..     
-000034b0: 2020 202e 6170 6920 7769 6c6c 2062 6520     .api will be 
-000034c0: 6176 6169 6c61 626c 6520 6174 2074 6869  available at thi
-000034d0: 7320 706f 696e 742e 0a20 2020 2020 2020  s point..       
-000034e0: 204d 7573 7420 6265 206f 7665 7272 6964   Must be overrid
-000034f0: 6465 6e20 696e 2063 6869 6c64 206d 6574  den in child met
-00003500: 686f 6473 2069 6620 7265 7175 6972 6564  hods if required
-00003510: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00003520: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00003530: 6465 6620 5f6c 6f67 5f65 7863 6861 6e67  def _log_exchang
-00003540: 655f 7265 7370 6f6e 7365 2873 656c 662c  e_response(self,
-00003550: 2065 6e64 706f 696e 742c 2072 6573 706f   endpoint, respo
-00003560: 6e73 6529 202d 3e20 4e6f 6e65 3a0a 2020  nse) -> None:.  
-00003570: 2020 2020 2020 2222 2220 4c6f 6720 6578        """ Log ex
-00003580: 6368 616e 6765 2072 6573 706f 6e73 6573  change responses
-00003590: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-000035a0: 7365 6c66 2e6c 6f67 5f72 6573 706f 6e73  self.log_respons
-000035b0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000035c0: 6c6f 6767 6572 2e69 6e66 6f28 6622 4150  logger.info(f"AP
-000035d0: 4920 7b65 6e64 706f 696e 747d 3a20 7b72  I {endpoint}: {r
-000035e0: 6573 706f 6e73 657d 2229 0a0a 2020 2020  esponse}")..    
-000035f0: 6465 6620 6f68 6c63 765f 6361 6e64 6c65  def ohlcv_candle
-00003600: 5f6c 696d 6974 280a 2020 2020 2020 2020  _limit(.        
-00003610: 2020 2020 7365 6c66 2c20 7469 6d65 6672      self, timefr
-00003620: 616d 653a 2073 7472 2c20 6361 6e64 6c65  ame: str, candle
-00003630: 5f74 7970 653a 2043 616e 646c 6554 7970  _type: CandleTyp
-00003640: 652c 2073 696e 6365 5f6d 733a 204f 7074  e, since_ms: Opt
-00003650: 696f 6e61 6c5b 696e 745d 203d 204e 6f6e  ional[int] = Non
-00003660: 6529 202d 3e20 696e 743a 0a20 2020 2020  e) -> int:.     
-00003670: 2020 2022 2222 0a20 2020 2020 2020 2045     """.        E
-00003680: 7863 6861 6e67 6520 6f68 6c63 7620 6361  xchange ohlcv ca
-00003690: 6e64 6c65 206c 696d 6974 0a20 2020 2020  ndle limit.     
-000036a0: 2020 2055 7365 7320 6f68 6c63 765f 6361     Uses ohlcv_ca
-000036b0: 6e64 6c65 5f6c 696d 6974 5f70 6572 5f74  ndle_limit_per_t
-000036c0: 696d 6566 7261 6d65 2069 6620 7468 6520  imeframe if the 
-000036d0: 6578 6368 616e 6765 2068 6173 2064 6966  exchange has dif
-000036e0: 6665 7265 6e74 206c 696d 6974 730a 2020  ferent limits.  
-000036f0: 2020 2020 2020 7065 7220 7469 6d65 6672        per timefr
-00003700: 616d 6520 2865 2e67 2e20 6269 7474 7265  ame (e.g. bittre
-00003710: 7829 2c20 6f74 6865 7277 6973 6520 6661  x), otherwise fa
-00003720: 6c6c 7320 6261 636b 2074 6f20 6f68 6c63  lls back to ohlc
-00003730: 765f 6361 6e64 6c65 5f6c 696d 6974 0a20  v_candle_limit. 
-00003740: 2020 2020 2020 203a 7061 7261 6d20 7469         :param ti
-00003750: 6d65 6672 616d 653a 2054 696d 6566 7261  meframe: Timefra
-00003760: 6d65 2074 6f20 6368 6563 6b0a 2020 2020  me to check.    
-00003770: 2020 2020 3a70 6172 616d 2063 616e 646c      :param candl
-00003780: 655f 7479 7065 3a20 4361 6e64 6c65 2d74  e_type: Candle-t
-00003790: 7970 650a 2020 2020 2020 2020 3a70 6172  ype.        :par
-000037a0: 616d 2073 696e 6365 5f6d 733a 2053 7461  am since_ms: Sta
-000037b0: 7274 696e 6720 7469 6d65 7374 616d 700a  rting timestamp.
-000037c0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-000037d0: 2043 616e 646c 6520 6c69 6d69 7420 6173   Candle limit as
-000037e0: 2069 6e74 6567 6572 0a20 2020 2020 2020   integer.       
-000037f0: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-00003800: 7572 6e20 696e 7428 7365 6c66 2e5f 6674  urn int(self._ft
-00003810: 5f68 6173 2e67 6574 2827 6f68 6c63 765f  _has.get('ohlcv_
+00000820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000830: 2020 2020 2020 2020 7469 6d65 6672 616d          timefram
+00000840: 655f 746f 5f73 6563 6f6e 6473 290a 6672  e_to_seconds).fr
+00000850: 6f6d 2066 7265 7174 7261 6465 2e65 7863  om freqtrade.exc
+00000860: 6861 6e67 652e 7479 7065 7320 696d 706f  hange.types impo
+00000870: 7274 204f 484c 4356 5265 7370 6f6e 7365  rt OHLCVResponse
+00000880: 2c20 4f72 6465 7242 6f6f 6b2c 2054 6963  , OrderBook, Tic
+00000890: 6b65 722c 2054 6963 6b65 7273 0a66 726f  ker, Tickers.fro
+000008a0: 6d20 6672 6571 7472 6164 652e 6d69 7363  m freqtrade.misc
+000008b0: 2069 6d70 6f72 7420 2863 6875 6e6b 732c   import (chunks,
+000008c0: 2064 6565 705f 6d65 7267 655f 6469 6374   deep_merge_dict
+000008d0: 732c 2066 696c 655f 6475 6d70 5f6a 736f  s, file_dump_jso
+000008e0: 6e2c 2066 696c 655f 6c6f 6164 5f6a 736f  n, file_load_jso
+000008f0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00000900: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00000910: 6166 655f 7661 6c75 655f 6661 6c6c 6261  afe_value_fallba
+00000920: 636b 3229 0a66 726f 6d20 6672 6571 7472  ck2).from freqtr
+00000930: 6164 652e 706c 7567 696e 732e 7061 6972  ade.plugins.pair
+00000940: 6c69 7374 2e70 6169 726c 6973 745f 6865  list.pairlist_he
+00000950: 6c70 6572 7320 696d 706f 7274 2065 7870  lpers import exp
+00000960: 616e 645f 7061 6972 6c69 7374 0a66 726f  and_pairlist.fro
+00000970: 6d20 6672 6571 7472 6164 652e 7574 696c  m freqtrade.util
+00000980: 2069 6d70 6f72 7420 6474 5f66 726f 6d5f   import dt_from_
+00000990: 7473 2c20 6474 5f6e 6f77 0a66 726f 6d20  ts, dt_now.from 
+000009a0: 6672 6571 7472 6164 652e 7574 696c 2e64  freqtrade.util.d
+000009b0: 6174 6574 696d 655f 6865 6c70 6572 7320  atetime_helpers 
+000009c0: 696d 706f 7274 2064 745f 6875 6d61 6e69  import dt_humani
+000009d0: 7a65 2c20 6474 5f74 730a 0a0a 6c6f 6767  ze, dt_ts...logg
+000009e0: 6572 203d 206c 6f67 6769 6e67 2e67 6574  er = logging.get
+000009f0: 4c6f 6767 6572 285f 5f6e 616d 655f 5f29  Logger(__name__)
+00000a00: 0a0a 0a63 6c61 7373 2045 7863 6861 6e67  ...class Exchang
+00000a10: 653a 0a0a 2020 2020 2320 5061 7261 6d65  e:..    # Parame
+00000a20: 7465 7273 2074 6f20 6164 6420 6469 7265  ters to add dire
+00000a30: 6374 6c79 2074 6f20 6275 792f 7365 6c6c  ctly to buy/sell
+00000a40: 2063 616c 6c73 2028 6c69 6b65 2061 6772   calls (like agr
+00000a50: 6565 696e 6720 746f 2074 7261 6469 6e67  eeing to trading
+00000a60: 2061 6772 6565 6d65 6e74 290a 2020 2020   agreement).    
+00000a70: 5f70 6172 616d 733a 2044 6963 7420 3d20  _params: Dict = 
+00000a80: 7b7d 0a0a 2020 2020 2320 4164 6469 7469  {}..    # Additi
+00000a90: 6f6e 616c 2070 6172 616d 6574 6572 7320  onal parameters 
+00000aa0: 2d20 6164 6465 6420 746f 2074 6865 2063  - added to the c
+00000ab0: 6378 7420 6f62 6a65 6374 0a20 2020 205f  cxt object.    _
+00000ac0: 6363 7874 5f70 6172 616d 733a 2044 6963  ccxt_params: Dic
+00000ad0: 7420 3d20 7b7d 0a0a 2020 2020 2320 4469  t = {}..    # Di
+00000ae0: 6374 2074 6f20 7370 6563 6966 7920 7768  ct to specify wh
+00000af0: 6963 6820 6f70 7469 6f6e 7320 6561 6368  ich options each
+00000b00: 2065 7863 6861 6e67 6520 696d 706c 656d   exchange implem
+00000b10: 656e 7473 0a20 2020 2023 2054 6869 7320  ents.    # This 
+00000b20: 6465 6669 6e65 7320 6465 6661 756c 7473  defines defaults
+00000b30: 2c20 7768 6963 6820 6361 6e20 6265 2073  , which can be s
+00000b40: 656c 6563 7469 7665 6c79 206f 7665 7272  electively overr
+00000b50: 6964 6465 6e20 6279 2073 7562 636c 6173  idden by subclas
+00000b60: 7365 7320 7573 696e 6720 5f66 745f 6861  ses using _ft_ha
+00000b70: 730a 2020 2020 2320 6f72 2062 7920 7370  s.    # or by sp
+00000b80: 6563 6966 7969 6e67 2074 6865 6d20 696e  ecifying them in
+00000b90: 2074 6865 2063 6f6e 6669 6775 7261 7469   the configurati
+00000ba0: 6f6e 2e0a 2020 2020 5f66 745f 6861 735f  on..    _ft_has_
+00000bb0: 6465 6661 756c 743a 2044 6963 7420 3d20  default: Dict = 
+00000bc0: 7b0a 2020 2020 2020 2020 2273 746f 706c  {.        "stopl
+00000bd0: 6f73 735f 6f6e 5f65 7863 6861 6e67 6522  oss_on_exchange"
+00000be0: 3a20 4661 6c73 652c 0a20 2020 2020 2020  : False,.       
+00000bf0: 2022 7374 6f70 5f70 7269 6365 5f70 6172   "stop_price_par
+00000c00: 616d 223a 2022 7374 6f70 5072 6963 6522  am": "stopPrice"
+00000c10: 2c0a 2020 2020 2020 2020 226f 7264 6572  ,.        "order
+00000c20: 5f74 696d 655f 696e 5f66 6f72 6365 223a  _time_in_force":
+00000c30: 205b 2247 5443 225d 2c0a 2020 2020 2020   ["GTC"],.      
+00000c40: 2020 226f 686c 6376 5f70 6172 616d 7322    "ohlcv_params"
+00000c50: 3a20 7b7d 2c0a 2020 2020 2020 2020 226f  : {},.        "o
+00000c60: 686c 6376 5f63 616e 646c 655f 6c69 6d69  hlcv_candle_limi
+00000c70: 7422 3a20 3530 302c 0a20 2020 2020 2020  t": 500,.       
+00000c80: 2022 6f68 6c63 765f 6861 735f 6869 7374   "ohlcv_has_hist
+00000c90: 6f72 7922 3a20 5472 7565 2c20 2023 2053  ory": True,  # S
+00000ca0: 6f6d 6520 6578 6368 616e 6765 7320 284b  ome exchanges (K
+00000cb0: 7261 6b65 6e29 2064 6f6e 2774 2070 726f  raken) don't pro
+00000cc0: 7669 6465 2068 6973 746f 7279 2076 6961  vide history via
+00000cd0: 206f 686c 6376 0a20 2020 2020 2020 2022   ohlcv.        "
+00000ce0: 6f68 6c63 765f 7061 7274 6961 6c5f 6361  ohlcv_partial_ca
+00000cf0: 6e64 6c65 223a 2054 7275 652c 0a20 2020  ndle": True,.   
+00000d00: 2020 2020 2022 6f68 6c63 765f 7265 7175       "ohlcv_requ
+00000d10: 6972 655f 7369 6e63 6522 3a20 4661 6c73  ire_since": Fals
+00000d20: 652c 0a20 2020 2020 2020 2023 2043 6865  e,.        # Che
+00000d30: 636b 2068 7474 7073 3a2f 2f67 6974 6875  ck https://githu
+00000d40: 622e 636f 6d2f 6363 7874 2f63 6378 742f  b.com/ccxt/ccxt/
+00000d50: 6973 7375 6573 2f31 3037 3637 2066 6f72  issues/10767 for
+00000d60: 2072 656d 6f76 616c 206f 6620 6f68 6c63   removal of ohlc
+00000d70: 765f 766f 6c75 6d65 5f63 7572 7265 6e63  v_volume_currenc
+00000d80: 790a 2020 2020 2020 2020 226f 686c 6376  y.        "ohlcv
+00000d90: 5f76 6f6c 756d 655f 6375 7272 656e 6379  _volume_currency
+00000da0: 223a 2022 6261 7365 222c 2020 2320 2262  ": "base",  # "b
+00000db0: 6173 6522 206f 7220 2271 756f 7465 220a  ase" or "quote".
+00000dc0: 2020 2020 2020 2020 2274 6963 6b65 7273          "tickers
+00000dd0: 5f68 6176 655f 7175 6f74 6556 6f6c 756d  _have_quoteVolum
+00000de0: 6522 3a20 5472 7565 2c0a 2020 2020 2020  e": True,.      
+00000df0: 2020 2274 6963 6b65 7273 5f68 6176 655f    "tickers_have_
+00000e00: 6269 645f 6173 6b22 3a20 5472 7565 2c20  bid_ask": True, 
+00000e10: 2023 2062 6964 202f 2061 736b 2065 6d70   # bid / ask emp
+00000e20: 7479 2066 6f72 2066 6574 6368 5f74 6963  ty for fetch_tic
+00000e30: 6b65 7273 0a20 2020 2020 2020 2022 7469  kers.        "ti
+00000e40: 636b 6572 735f 6861 7665 5f70 7269 6365  ckers_have_price
+00000e50: 223a 2054 7275 652c 0a20 2020 2020 2020  ": True,.       
+00000e60: 2022 7472 6164 6573 5f70 6167 696e 6174   "trades_paginat
+00000e70: 696f 6e22 3a20 2274 696d 6522 2c20 2023  ion": "time",  #
+00000e80: 2050 6f73 7369 626c 6520 6172 6520 2274   Possible are "t
+00000e90: 696d 6522 206f 7220 2269 6422 0a20 2020  ime" or "id".   
+00000ea0: 2020 2020 2022 7472 6164 6573 5f70 6167       "trades_pag
+00000eb0: 696e 6174 696f 6e5f 6172 6722 3a20 2273  ination_arg": "s
+00000ec0: 696e 6365 222c 0a20 2020 2020 2020 2022  ince",.        "
+00000ed0: 6c32 5f6c 696d 6974 5f72 616e 6765 223a  l2_limit_range":
+00000ee0: 204e 6f6e 652c 0a20 2020 2020 2020 2022   None,.        "
+00000ef0: 6c32 5f6c 696d 6974 5f72 616e 6765 5f72  l2_limit_range_r
+00000f00: 6571 7569 7265 6422 3a20 5472 7565 2c20  equired": True, 
+00000f10: 2023 2041 6c6c 6f77 2045 6d70 7479 204c   # Allow Empty L
+00000f20: 3220 6c69 6d69 7420 286b 7563 6f69 6e29  2 limit (kucoin)
+00000f30: 0a20 2020 2020 2020 2022 6d61 726b 5f6f  .        "mark_o
+00000f40: 686c 6376 5f70 7269 6365 223a 2022 6d61  hlcv_price": "ma
+00000f50: 726b 222c 0a20 2020 2020 2020 2022 6d61  rk",.        "ma
+00000f60: 726b 5f6f 686c 6376 5f74 696d 6566 7261  rk_ohlcv_timefra
+00000f70: 6d65 223a 2022 3868 222c 0a20 2020 2020  me": "8h",.     
+00000f80: 2020 2022 6363 7874 5f66 7574 7572 6573     "ccxt_futures
+00000f90: 5f6e 616d 6522 3a20 2273 7761 7022 2c0a  _name": "swap",.
+00000fa0: 2020 2020 2020 2020 2266 6565 5f63 6f73          "fee_cos
+00000fb0: 745f 696e 5f63 6f6e 7472 6163 7473 223a  t_in_contracts":
+00000fc0: 2046 616c 7365 2c20 2023 2046 6565 2063   False,  # Fee c
+00000fd0: 6f73 7420 6e65 6564 7320 636f 6e74 7261  ost needs contra
+00000fe0: 6374 2063 6f6e 7665 7273 696f 6e0a 2020  ct conversion.  
+00000ff0: 2020 2020 2020 226e 6565 6473 5f74 7261        "needs_tra
+00001000: 6469 6e67 5f66 6565 7322 3a20 4661 6c73  ding_fees": Fals
+00001010: 652c 2020 2320 7573 6520 6665 7463 685f  e,  # use fetch_
+00001020: 7472 6164 696e 675f 6665 6573 2074 6f20  trading_fees to 
+00001030: 6361 6368 6520 6665 6573 0a20 2020 2020  cache fees.     
+00001040: 2020 2022 6f72 6465 725f 7072 6f70 735f     "order_props_
+00001050: 696e 5f63 6f6e 7472 6163 7473 223a 205b  in_contracts": [
+00001060: 2761 6d6f 756e 7427 2c20 2763 6f73 7427  'amount', 'cost'
+00001070: 2c20 2766 696c 6c65 6427 2c20 2772 656d  , 'filled', 'rem
+00001080: 6169 6e69 6e67 275d 2c0a 2020 2020 2020  aining'],.      
+00001090: 2020 2320 4f76 6572 7269 6465 2063 7265    # Override cre
+000010a0: 6174 654d 6172 6b65 7442 7579 4f72 6465  ateMarketBuyOrde
+000010b0: 7252 6571 7569 7265 7350 7269 6365 2077  rRequiresPrice w
+000010c0: 6865 7265 2063 6378 7420 6861 7320 6974  here ccxt has it
+000010d0: 2077 726f 6e67 0a20 2020 2020 2020 2022   wrong.        "
+000010e0: 6d61 726b 6574 4f72 6465 7252 6571 7569  marketOrderRequi
+000010f0: 7265 7350 7269 6365 223a 2046 616c 7365  resPrice": False
+00001100: 2c0a 2020 2020 7d0a 2020 2020 5f66 745f  ,.    }.    _ft_
+00001110: 6861 733a 2044 6963 7420 3d20 7b7d 0a20  has: Dict = {}. 
+00001120: 2020 205f 6674 5f68 6173 5f66 7574 7572     _ft_has_futur
+00001130: 6573 3a20 4469 6374 203d 207b 7d0a 0a20  es: Dict = {}.. 
+00001140: 2020 205f 7375 7070 6f72 7465 645f 7472     _supported_tr
+00001150: 6164 696e 675f 6d6f 6465 5f6d 6172 6769  ading_mode_margi
+00001160: 6e5f 7061 6972 733a 204c 6973 745b 5475  n_pairs: List[Tu
+00001170: 706c 655b 5472 6164 696e 674d 6f64 652c  ple[TradingMode,
+00001180: 204d 6172 6769 6e4d 6f64 655d 5d20 3d20   MarginMode]] = 
+00001190: 5b0a 2020 2020 2020 2020 2320 5472 6164  [.        # Trad
+000011a0: 696e 674d 6f64 652e 5350 4f54 2061 6c77  ingMode.SPOT alw
+000011b0: 6179 7320 7375 7070 6f72 7465 6420 616e  ays supported an
+000011c0: 6420 6e6f 7420 7265 7175 6972 6564 2069  d not required i
+000011d0: 6e20 7468 6973 206c 6973 740a 2020 2020  n this list.    
+000011e0: 5d0a 0a20 2020 2064 6566 205f 5f69 6e69  ]..    def __ini
+000011f0: 745f 5f28 7365 6c66 2c20 636f 6e66 6967  t__(self, config
+00001200: 3a20 436f 6e66 6967 2c20 2a2c 2065 7863  : Config, *, exc
+00001210: 6861 6e67 655f 636f 6e66 6967 3a20 4f70  hange_config: Op
+00001220: 7469 6f6e 616c 5b45 7863 6861 6e67 6543  tional[ExchangeC
+00001230: 6f6e 6669 675d 203d 204e 6f6e 652c 0a20  onfig] = None,. 
+00001240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001250: 7661 6c69 6461 7465 3a20 626f 6f6c 203d  validate: bool =
+00001260: 2054 7275 652c 206c 6f61 645f 6c65 7665   True, load_leve
+00001270: 7261 6765 5f74 6965 7273 3a20 626f 6f6c  rage_tiers: bool
+00001280: 203d 2046 616c 7365 2920 2d3e 204e 6f6e   = False) -> Non
+00001290: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+000012a0: 2020 2020 2020 2049 6e69 7469 616c 697a         Initializ
+000012b0: 6573 2074 6869 7320 6d6f 6475 6c65 2077  es this module w
+000012c0: 6974 6820 7468 6520 6769 7665 6e20 636f  ith the given co
+000012d0: 6e66 6967 2c0a 2020 2020 2020 2020 6974  nfig,.        it
+000012e0: 2064 6f65 7320 6261 7369 6320 7661 6c69   does basic vali
+000012f0: 6461 7469 6f6e 2077 6865 7468 6572 2074  dation whether t
+00001300: 6865 2073 7065 6369 6669 6564 2065 7863  he specified exc
+00001310: 6861 6e67 6520 616e 6420 7061 6972 7320  hange and pairs 
+00001320: 6172 6520 7661 6c69 642e 0a20 2020 2020  are valid..     
+00001330: 2020 203a 7265 7475 726e 3a20 4e6f 6e65     :return: None
+00001340: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00001350: 2020 2020 2073 656c 662e 5f61 7069 3a20       self._api: 
+00001360: 6363 7874 2e45 7863 6861 6e67 650a 2020  ccxt.Exchange.  
+00001370: 2020 2020 2020 7365 6c66 2e5f 6170 695f        self._api_
+00001380: 6173 796e 633a 2063 6378 745f 6173 796e  async: ccxt_asyn
+00001390: 632e 4578 6368 616e 6765 203d 204e 6f6e  c.Exchange = Non
+000013a0: 650a 2020 2020 2020 2020 7365 6c66 2e5f  e.        self._
+000013b0: 6d61 726b 6574 733a 2044 6963 7420 3d20  markets: Dict = 
+000013c0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+000013d0: 5f74 7261 6469 6e67 5f66 6565 733a 2044  _trading_fees: D
+000013e0: 6963 745b 7374 722c 2041 6e79 5d20 3d20  ict[str, Any] = 
+000013f0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00001400: 5f6c 6576 6572 6167 655f 7469 6572 733a  _leverage_tiers:
+00001410: 2044 6963 745b 7374 722c 204c 6973 745b   Dict[str, List[
+00001420: 4469 6374 5d5d 203d 207b 7d0a 2020 2020  Dict]] = {}.    
+00001430: 2020 2020 2320 4c6f 636b 2065 7665 6e74      # Lock event
+00001440: 206c 6f6f 702e 2054 6869 7320 6973 206e   loop. This is n
+00001450: 6563 6573 7361 7279 2074 6f20 6176 6f69  ecessary to avoi
+00001460: 6420 7261 6365 2d63 6f6e 6469 7469 6f6e  d race-condition
+00001470: 7320 7768 656e 2075 7369 6e67 2066 6f72  s when using for
+00001480: 6365 2a20 636f 6d6d 616e 6473 0a20 2020  ce* commands.   
+00001490: 2020 2020 2023 2044 7565 2074 6f20 6675       # Due to fu
+000014a0: 6e64 696e 6720 6665 6520 6665 7463 6869  nding fee fetchi
+000014b0: 6e67 2e0a 2020 2020 2020 2020 7365 6c66  ng..        self
+000014c0: 2e5f 6c6f 6f70 5f6c 6f63 6b20 3d20 4c6f  ._loop_lock = Lo
+000014d0: 636b 2829 0a20 2020 2020 2020 2073 656c  ck().        sel
+000014e0: 662e 6c6f 6f70 203d 2073 656c 662e 5f69  f.loop = self._i
+000014f0: 6e69 745f 6173 796e 635f 6c6f 6f70 2829  nit_async_loop()
+00001500: 0a20 2020 2020 2020 2073 656c 662e 5f63  .        self._c
+00001510: 6f6e 6669 673a 2043 6f6e 6669 6720 3d20  onfig: Config = 
+00001520: 7b7d 0a0a 2020 2020 2020 2020 7365 6c66  {}..        self
+00001530: 2e5f 636f 6e66 6967 2e75 7064 6174 6528  ._config.update(
+00001540: 636f 6e66 6967 290a 0a20 2020 2020 2020  config)..       
+00001550: 2023 2048 6f6c 6473 206c 6173 7420 6361   # Holds last ca
+00001560: 6e64 6c65 2072 6566 7265 7368 6564 2074  ndle refreshed t
+00001570: 696d 6520 6f66 2065 6163 6820 7061 6972  ime of each pair
+00001580: 0a20 2020 2020 2020 2073 656c 662e 5f70  .        self._p
+00001590: 6169 7273 5f6c 6173 745f 7265 6672 6573  airs_last_refres
+000015a0: 685f 7469 6d65 3a20 4469 6374 5b50 6169  h_time: Dict[Pai
+000015b0: 7257 6974 6854 696d 6566 7261 6d65 2c20  rWithTimeframe, 
+000015c0: 696e 745d 203d 207b 7d0a 2020 2020 2020  int] = {}.      
+000015d0: 2020 2320 5469 6d65 7374 616d 7020 6f66    # Timestamp of
+000015e0: 206c 6173 7420 6d61 726b 6574 7320 7265   last markets re
+000015f0: 6672 6573 680a 2020 2020 2020 2020 7365  fresh.        se
+00001600: 6c66 2e5f 6c61 7374 5f6d 6172 6b65 7473  lf._last_markets
+00001610: 5f72 6566 7265 7368 3a20 696e 7420 3d20  _refresh: int = 
+00001620: 300a 0a20 2020 2020 2020 2023 2043 6163  0..        # Cac
+00001630: 6865 2066 6f72 2031 3020 6d69 6e75 7465  he for 10 minute
+00001640: 7320 2e2e 2e0a 2020 2020 2020 2020 7365  s ....        se
+00001650: 6c66 2e5f 6361 6368 655f 6c6f 636b 203d  lf._cache_lock =
+00001660: 204c 6f63 6b28 290a 2020 2020 2020 2020   Lock().        
+00001670: 7365 6c66 2e5f 6665 7463 685f 7469 636b  self._fetch_tick
+00001680: 6572 735f 6361 6368 653a 2054 544c 4361  ers_cache: TTLCa
+00001690: 6368 6520 3d20 5454 4c43 6163 6865 286d  che = TTLCache(m
+000016a0: 6178 7369 7a65 3d32 2c20 7474 6c3d 3630  axsize=2, ttl=60
+000016b0: 202a 2031 3029 0a20 2020 2020 2020 2023   * 10).        #
+000016c0: 2043 6163 6865 2076 616c 7565 7320 666f   Cache values fo
+000016d0: 7220 3138 3030 2074 6f20 6176 6f69 6420  r 1800 to avoid 
+000016e0: 6672 6571 7565 6e74 2070 6f6c 6c69 6e67  frequent polling
+000016f0: 206f 6620 7468 6520 6578 6368 616e 6765   of the exchange
+00001700: 2066 6f72 2070 7269 6365 730a 2020 2020   for prices.    
+00001710: 2020 2020 2320 4361 6368 696e 6720 6f6e      # Caching on
+00001720: 6c79 2061 7070 6c69 6573 2074 6f20 5250  ly applies to RP
+00001730: 4320 6d65 7468 6f64 732c 2073 6f20 7072  C methods, so pr
+00001740: 6963 6573 2066 6f72 206f 7065 6e20 7472  ices for open tr
+00001750: 6164 6573 2061 7265 2073 7469 6c6c 0a20  ades are still. 
+00001760: 2020 2020 2020 2023 2072 6566 7265 7368         # refresh
+00001770: 6564 206f 6e63 6520 6576 6572 7920 6974  ed once every it
+00001780: 6572 6174 696f 6e2e 0a20 2020 2020 2020  eration..       
+00001790: 2073 656c 662e 5f65 7869 745f 7261 7465   self._exit_rate
+000017a0: 5f63 6163 6865 3a20 5454 4c43 6163 6865  _cache: TTLCache
+000017b0: 203d 2054 544c 4361 6368 6528 6d61 7873   = TTLCache(maxs
+000017c0: 697a 653d 3130 302c 2074 746c 3d31 3830  ize=100, ttl=180
+000017d0: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+000017e0: 5f65 6e74 7279 5f72 6174 655f 6361 6368  _entry_rate_cach
+000017f0: 653a 2054 544c 4361 6368 6520 3d20 5454  e: TTLCache = TT
+00001800: 4c43 6163 6865 286d 6178 7369 7a65 3d31  LCache(maxsize=1
+00001810: 3030 2c20 7474 6c3d 3138 3030 290a 0a20  00, ttl=1800).. 
+00001820: 2020 2020 2020 2023 2048 6f6c 6473 2063         # Holds c
+00001830: 616e 646c 6573 0a20 2020 2020 2020 2073  andles.        s
+00001840: 656c 662e 5f6b 6c69 6e65 733a 2044 6963  elf._klines: Dic
+00001850: 745b 5061 6972 5769 7468 5469 6d65 6672  t[PairWithTimefr
+00001860: 616d 652c 2044 6174 6146 7261 6d65 5d20  ame, DataFrame] 
+00001870: 3d20 7b7d 0a0a 2020 2020 2020 2020 2320  = {}..        # 
+00001880: 486f 6c64 7320 616c 6c20 6f70 656e 2073  Holds all open s
+00001890: 656c 6c20 6f72 6465 7273 2066 6f72 2064  ell orders for d
+000018a0: 7279 5f72 756e 0a20 2020 2020 2020 2073  ry_run.        s
+000018b0: 656c 662e 5f64 7279 5f72 756e 5f6f 7065  elf._dry_run_ope
+000018c0: 6e5f 6f72 6465 7273 3a20 4469 6374 5b73  n_orders: Dict[s
+000018d0: 7472 2c20 416e 795d 203d 207b 7d0a 0a20  tr, Any] = {}.. 
+000018e0: 2020 2020 2020 2069 6620 636f 6e66 6967         if config
+000018f0: 5b27 6472 795f 7275 6e27 5d3a 0a20 2020  ['dry_run']:.   
+00001900: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00001910: 696e 666f 2827 496e 7374 616e 6365 2069  info('Instance i
+00001920: 7320 7275 6e6e 696e 6720 7769 7468 2064  s running with d
+00001930: 7279 5f72 756e 2065 6e61 626c 6564 2729  ry_run enabled')
+00001940: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+00001950: 696e 666f 2866 2255 7369 6e67 2043 4358  info(f"Using CCX
+00001960: 5420 7b63 6378 742e 5f5f 7665 7273 696f  T {ccxt.__versio
+00001970: 6e5f 5f7d 2229 0a20 2020 2020 2020 2065  n__}").        e
+00001980: 7863 6861 6e67 655f 636f 6e66 3a20 4469  xchange_conf: Di
+00001990: 6374 5b73 7472 2c20 416e 795d 203d 2065  ct[str, Any] = e
+000019a0: 7863 6861 6e67 655f 636f 6e66 6967 2069  xchange_config i
+000019b0: 6620 6578 6368 616e 6765 5f63 6f6e 6669  f exchange_confi
+000019c0: 6720 656c 7365 2063 6f6e 6669 675b 2765  g else config['e
+000019d0: 7863 6861 6e67 6527 5d0a 2020 2020 2020  xchange'].      
+000019e0: 2020 7265 6d6f 7665 5f65 7863 6861 6e67    remove_exchang
+000019f0: 655f 6372 6564 656e 7469 616c 7328 6578  e_credentials(ex
+00001a00: 6368 616e 6765 5f63 6f6e 662c 2063 6f6e  change_conf, con
+00001a10: 6669 672e 6765 7428 2764 7279 5f72 756e  fig.get('dry_run
+00001a20: 272c 2046 616c 7365 2929 0a20 2020 2020  ', False)).     
+00001a30: 2020 2073 656c 662e 6c6f 675f 7265 7370     self.log_resp
+00001a40: 6f6e 7365 7320 3d20 6578 6368 616e 6765  onses = exchange
+00001a50: 5f63 6f6e 662e 6765 7428 276c 6f67 5f72  _conf.get('log_r
+00001a60: 6573 706f 6e73 6573 272c 2046 616c 7365  esponses', False
+00001a70: 290a 0a20 2020 2020 2020 2023 204c 6576  )..        # Lev
+00001a80: 6572 6167 6520 7072 6f70 6572 7469 6573  erage properties
+00001a90: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
+00001aa0: 6164 696e 675f 6d6f 6465 3a20 5472 6164  ading_mode: Trad
+00001ab0: 696e 674d 6f64 6520 3d20 636f 6e66 6967  ingMode = config
+00001ac0: 2e67 6574 2827 7472 6164 696e 675f 6d6f  .get('trading_mo
+00001ad0: 6465 272c 2054 7261 6469 6e67 4d6f 6465  de', TradingMode
+00001ae0: 2e53 504f 5429 0a20 2020 2020 2020 2073  .SPOT).        s
+00001af0: 656c 662e 6d61 7267 696e 5f6d 6f64 653a  elf.margin_mode:
+00001b00: 204d 6172 6769 6e4d 6f64 6520 3d20 280a   MarginMode = (.
+00001b10: 2020 2020 2020 2020 2020 2020 4d61 7267              Marg
+00001b20: 696e 4d6f 6465 2863 6f6e 6669 672e 6765  inMode(config.ge
+00001b30: 7428 276d 6172 6769 6e5f 6d6f 6465 2729  t('margin_mode')
+00001b40: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00001b50: 2063 6f6e 6669 672e 6765 7428 276d 6172   config.get('mar
+00001b60: 6769 6e5f 6d6f 6465 2729 0a20 2020 2020  gin_mode').     
+00001b70: 2020 2020 2020 2065 6c73 6520 4d61 7267         else Marg
+00001b80: 696e 4d6f 6465 2e4e 4f4e 450a 2020 2020  inMode.NONE.    
+00001b90: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00001ba0: 6c66 2e6c 6971 7569 6461 7469 6f6e 5f62  lf.liquidation_b
+00001bb0: 7566 6665 7220 3d20 636f 6e66 6967 2e67  uffer = config.g
+00001bc0: 6574 2827 6c69 7175 6964 6174 696f 6e5f  et('liquidation_
+00001bd0: 6275 6666 6572 272c 2030 2e30 3529 0a0a  buffer', 0.05)..
+00001be0: 2020 2020 2020 2020 2320 4465 6570 206d          # Deep m
+00001bf0: 6572 6765 2066 745f 6861 7320 7769 7468  erge ft_has with
+00001c00: 2064 6566 6175 6c74 2066 745f 6861 7320   default ft_has 
+00001c10: 6f70 7469 6f6e 730a 2020 2020 2020 2020  options.        
+00001c20: 7365 6c66 2e5f 6674 5f68 6173 203d 2064  self._ft_has = d
+00001c30: 6565 705f 6d65 7267 655f 6469 6374 7328  eep_merge_dicts(
+00001c40: 7365 6c66 2e5f 6674 5f68 6173 2c20 6465  self._ft_has, de
+00001c50: 6570 636f 7079 2873 656c 662e 5f66 745f  epcopy(self._ft_
+00001c60: 6861 735f 6465 6661 756c 7429 290a 2020  has_default)).  
+00001c70: 2020 2020 2020 6966 2073 656c 662e 7472        if self.tr
+00001c80: 6164 696e 675f 6d6f 6465 203d 3d20 5472  ading_mode == Tr
+00001c90: 6164 696e 674d 6f64 652e 4655 5455 5245  adingMode.FUTURE
+00001ca0: 533a 0a20 2020 2020 2020 2020 2020 2073  S:.            s
+00001cb0: 656c 662e 5f66 745f 6861 7320 3d20 6465  elf._ft_has = de
+00001cc0: 6570 5f6d 6572 6765 5f64 6963 7473 2873  ep_merge_dicts(s
+00001cd0: 656c 662e 5f66 745f 6861 735f 6675 7475  elf._ft_has_futu
+00001ce0: 7265 732c 2073 656c 662e 5f66 745f 6861  res, self._ft_ha
+00001cf0: 7329 0a20 2020 2020 2020 2069 6620 6578  s).        if ex
+00001d00: 6368 616e 6765 5f63 6f6e 662e 6765 7428  change_conf.get(
+00001d10: 275f 6674 5f68 6173 5f70 6172 616d 7327  '_ft_has_params'
+00001d20: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00001d30: 656c 662e 5f66 745f 6861 7320 3d20 6465  elf._ft_has = de
+00001d40: 6570 5f6d 6572 6765 5f64 6963 7473 2865  ep_merge_dicts(e
+00001d50: 7863 6861 6e67 655f 636f 6e66 2e67 6574  xchange_conf.get
+00001d60: 2827 5f66 745f 6861 735f 7061 7261 6d73  ('_ft_has_params
+00001d70: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00001d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001da0: 7365 6c66 2e5f 6674 5f68 6173 290a 2020  self._ft_has).  
+00001db0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00001dc0: 2e69 6e66 6f28 224f 7665 7272 6964 696e  .info("Overridin
+00001dd0: 6720 6578 6368 616e 6765 2e5f 6674 5f68  g exchange._ft_h
+00001de0: 6173 2077 6974 6820 636f 6e66 6967 2070  as with config p
+00001df0: 6172 616d 732c 2072 6573 756c 743a 2025  arams, result: %
+00001e00: 7322 2c20 7365 6c66 2e5f 6674 5f68 6173  s", self._ft_has
+00001e10: 290a 0a20 2020 2020 2020 2023 2041 7373  )..        # Ass
+00001e20: 6967 6e20 7468 6973 2064 6972 6563 746c  ign this directl
+00001e30: 7920 666f 7220 6561 7379 2061 6363 6573  y for easy acces
+00001e40: 730a 2020 2020 2020 2020 7365 6c66 2e5f  s.        self._
+00001e50: 6f68 6c63 765f 7061 7274 6961 6c5f 6361  ohlcv_partial_ca
+00001e60: 6e64 6c65 203d 2073 656c 662e 5f66 745f  ndle = self._ft_
+00001e70: 6861 735b 276f 686c 6376 5f70 6172 7469  has['ohlcv_parti
+00001e80: 616c 5f63 616e 646c 6527 5d0a 0a20 2020  al_candle']..   
+00001e90: 2020 2020 2073 656c 662e 5f74 7261 6465       self._trade
+00001ea0: 735f 7061 6769 6e61 7469 6f6e 203d 2073  s_pagination = s
+00001eb0: 656c 662e 5f66 745f 6861 735b 2774 7261  elf._ft_has['tra
+00001ec0: 6465 735f 7061 6769 6e61 7469 6f6e 275d  des_pagination']
+00001ed0: 0a20 2020 2020 2020 2073 656c 662e 5f74  .        self._t
+00001ee0: 7261 6465 735f 7061 6769 6e61 7469 6f6e  rades_pagination
+00001ef0: 5f61 7267 203d 2073 656c 662e 5f66 745f  _arg = self._ft_
+00001f00: 6861 735b 2774 7261 6465 735f 7061 6769  has['trades_pagi
+00001f10: 6e61 7469 6f6e 5f61 7267 275d 0a0a 2020  nation_arg']..  
+00001f20: 2020 2020 2020 2320 496e 6974 6961 6c69        # Initiali
+00001f30: 7a65 2063 6378 7420 6f62 6a65 6374 730a  ze ccxt objects.
+00001f40: 2020 2020 2020 2020 6363 7874 5f63 6f6e          ccxt_con
+00001f50: 6669 6720 3d20 7365 6c66 2e5f 6363 7874  fig = self._ccxt
+00001f60: 5f63 6f6e 6669 670a 2020 2020 2020 2020  _config.        
+00001f70: 6363 7874 5f63 6f6e 6669 6720 3d20 6465  ccxt_config = de
+00001f80: 6570 5f6d 6572 6765 5f64 6963 7473 2865  ep_merge_dicts(e
+00001f90: 7863 6861 6e67 655f 636f 6e66 2e67 6574  xchange_conf.get
+00001fa0: 2827 6363 7874 5f63 6f6e 6669 6727 2c20  ('ccxt_config', 
+00001fb0: 7b7d 292c 2063 6378 745f 636f 6e66 6967  {}), ccxt_config
+00001fc0: 290a 2020 2020 2020 2020 6363 7874 5f63  ).        ccxt_c
+00001fd0: 6f6e 6669 6720 3d20 6465 6570 5f6d 6572  onfig = deep_mer
+00001fe0: 6765 5f64 6963 7473 2865 7863 6861 6e67  ge_dicts(exchang
+00001ff0: 655f 636f 6e66 2e67 6574 2827 6363 7874  e_conf.get('ccxt
+00002000: 5f73 796e 635f 636f 6e66 6967 272c 207b  _sync_config', {
+00002010: 7d29 2c20 6363 7874 5f63 6f6e 6669 6729  }), ccxt_config)
+00002020: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+00002030: 6170 6920 3d20 7365 6c66 2e5f 696e 6974  api = self._init
+00002040: 5f63 6378 7428 6578 6368 616e 6765 5f63  _ccxt(exchange_c
+00002050: 6f6e 662c 2063 6378 745f 6b77 6172 6773  onf, ccxt_kwargs
+00002060: 3d63 6378 745f 636f 6e66 6967 290a 0a20  =ccxt_config).. 
+00002070: 2020 2020 2020 2063 6378 745f 6173 796e         ccxt_asyn
+00002080: 635f 636f 6e66 6967 203d 2073 656c 662e  c_config = self.
+00002090: 5f63 6378 745f 636f 6e66 6967 0a20 2020  _ccxt_config.   
+000020a0: 2020 2020 2063 6378 745f 6173 796e 635f       ccxt_async_
+000020b0: 636f 6e66 6967 203d 2064 6565 705f 6d65  config = deep_me
+000020c0: 7267 655f 6469 6374 7328 6578 6368 616e  rge_dicts(exchan
+000020d0: 6765 5f63 6f6e 662e 6765 7428 2763 6378  ge_conf.get('ccx
+000020e0: 745f 636f 6e66 6967 272c 207b 7d29 2c0a  t_config', {}),.
+000020f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002110: 2020 2020 2020 2020 2020 2020 2063 6378               ccx
+00002120: 745f 6173 796e 635f 636f 6e66 6967 290a  t_async_config).
+00002130: 2020 2020 2020 2020 6363 7874 5f61 7379          ccxt_asy
+00002140: 6e63 5f63 6f6e 6669 6720 3d20 6465 6570  nc_config = deep
+00002150: 5f6d 6572 6765 5f64 6963 7473 2865 7863  _merge_dicts(exc
+00002160: 6861 6e67 655f 636f 6e66 2e67 6574 2827  hange_conf.get('
+00002170: 6363 7874 5f61 7379 6e63 5f63 6f6e 6669  ccxt_async_confi
+00002180: 6727 2c20 7b7d 292c 0a20 2020 2020 2020  g', {}),.       
+00002190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000021a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000021b0: 2020 2020 2020 6363 7874 5f61 7379 6e63        ccxt_async
+000021c0: 5f63 6f6e 6669 6729 0a20 2020 2020 2020  _config).       
+000021d0: 2073 656c 662e 5f61 7069 5f61 7379 6e63   self._api_async
+000021e0: 203d 2073 656c 662e 5f69 6e69 745f 6363   = self._init_cc
+000021f0: 7874 280a 2020 2020 2020 2020 2020 2020  xt(.            
+00002200: 6578 6368 616e 6765 5f63 6f6e 662c 2063  exchange_conf, c
+00002210: 6378 745f 6173 796e 632c 2063 6378 745f  cxt_async, ccxt_
+00002220: 6b77 6172 6773 3d63 6378 745f 6173 796e  kwargs=ccxt_asyn
+00002230: 635f 636f 6e66 6967 290a 0a20 2020 2020  c_config)..     
+00002240: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
+00002250: 2755 7369 6e67 2045 7863 6861 6e67 6520  'Using Exchange 
+00002260: 227b 7365 6c66 2e6e 616d 657d 2227 290a  "{self.name}"').
+00002270: 2020 2020 2020 2020 7365 6c66 2e72 6571          self.req
+00002280: 7569 7265 645f 6361 6e64 6c65 5f63 616c  uired_candle_cal
+00002290: 6c5f 636f 756e 7420 3d20 310a 2020 2020  l_count = 1.    
+000022a0: 2020 2020 6966 2076 616c 6964 6174 653a      if validate:
+000022b0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+000022c0: 6e69 7469 616c 206d 6172 6b65 7473 206c  nitial markets l
+000022d0: 6f61 640a 2020 2020 2020 2020 2020 2020  oad.            
+000022e0: 7365 6c66 2e5f 6c6f 6164 5f6d 6172 6b65  self._load_marke
+000022f0: 7473 2829 0a20 2020 2020 2020 2020 2020  ts().           
+00002300: 2073 656c 662e 7661 6c69 6461 7465 5f63   self.validate_c
+00002310: 6f6e 6669 6728 636f 6e66 6967 290a 2020  onfig(config).  
+00002320: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00002330: 7374 6172 7475 705f 6361 6e64 6c65 5f63  startup_candle_c
+00002340: 6f75 6e74 3a20 696e 7420 3d20 636f 6e66  ount: int = conf
+00002350: 6967 2e67 6574 2827 7374 6172 7475 705f  ig.get('startup_
+00002360: 6361 6e64 6c65 5f63 6f75 6e74 272c 2030  candle_count', 0
+00002370: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00002380: 6c66 2e72 6571 7569 7265 645f 6361 6e64  lf.required_cand
+00002390: 6c65 5f63 616c 6c5f 636f 756e 7420 3d20  le_call_count = 
+000023a0: 7365 6c66 2e76 616c 6964 6174 655f 7265  self.validate_re
+000023b0: 7175 6972 6564 5f73 7461 7274 7570 5f63  quired_startup_c
+000023c0: 616e 646c 6573 280a 2020 2020 2020 2020  andles(.        
+000023d0: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
+000023e0: 6172 7475 705f 6361 6e64 6c65 5f63 6f75  artup_candle_cou
+000023f0: 6e74 2c20 636f 6e66 6967 2e67 6574 2827  nt, config.get('
+00002400: 7469 6d65 6672 616d 6527 2c20 2727 2929  timeframe', ''))
+00002410: 0a0a 2020 2020 2020 2020 2320 436f 6e76  ..        # Conv
+00002420: 6572 7473 2074 6865 2069 6e74 6572 7661  erts the interva
+00002430: 6c20 7072 6f76 6964 6564 2069 6e20 6d69  l provided in mi
+00002440: 6e75 7465 7320 696e 2063 6f6e 6669 6720  nutes in config 
+00002450: 746f 2073 6563 6f6e 6473 0a20 2020 2020  to seconds.     
+00002460: 2020 2073 656c 662e 6d61 726b 6574 735f     self.markets_
+00002470: 7265 6672 6573 685f 696e 7465 7276 616c  refresh_interval
+00002480: 3a20 696e 7420 3d20 6578 6368 616e 6765  : int = exchange
+00002490: 5f63 6f6e 662e 6765 7428 0a20 2020 2020  _conf.get(.     
+000024a0: 2020 2020 2020 2022 6d61 726b 6574 735f         "markets_
+000024b0: 7265 6672 6573 685f 696e 7465 7276 616c  refresh_interval
+000024c0: 222c 2036 3029 202a 2036 300a 0a20 2020  ", 60) * 60..   
+000024d0: 2020 2020 2069 6620 7365 6c66 2e74 7261       if self.tra
+000024e0: 6469 6e67 5f6d 6f64 6520 213d 2054 7261  ding_mode != Tra
+000024f0: 6469 6e67 4d6f 6465 2e53 504f 5420 616e  dingMode.SPOT an
+00002500: 6420 6c6f 6164 5f6c 6576 6572 6167 655f  d load_leverage_
+00002510: 7469 6572 733a 0a20 2020 2020 2020 2020  tiers:.         
+00002520: 2020 2073 656c 662e 6669 6c6c 5f6c 6576     self.fill_lev
+00002530: 6572 6167 655f 7469 6572 7328 290a 2020  erage_tiers().  
+00002540: 2020 2020 2020 7365 6c66 2e61 6464 6974        self.addit
+00002550: 696f 6e61 6c5f 6578 6368 616e 6765 5f69  ional_exchange_i
+00002560: 6e69 7428 290a 0a20 2020 2064 6566 205f  nit()..    def _
+00002570: 5f64 656c 5f5f 2873 656c 6629 3a0a 2020  _del__(self):.  
+00002580: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00002590: 2020 4465 7374 7275 6374 6f72 202d 2063    Destructor - c
+000025a0: 6c65 616e 2075 7020 6173 796e 6320 7374  lean up async st
+000025b0: 7566 660a 2020 2020 2020 2020 2222 220a  uff.        """.
+000025c0: 2020 2020 2020 2020 7365 6c66 2e63 6c6f          self.clo
+000025d0: 7365 2829 0a0a 2020 2020 6465 6620 636c  se()..    def cl
+000025e0: 6f73 6528 7365 6c66 293a 0a20 2020 2020  ose(self):.     
+000025f0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00002600: 2245 7863 6861 6e67 6520 6f62 6a65 6374  "Exchange object
+00002610: 2064 6573 7472 6f79 6564 2c20 636c 6f73   destroyed, clos
+00002620: 696e 6720 6173 796e 6320 6c6f 6f70 2229  ing async loop")
+00002630: 0a20 2020 2020 2020 2069 6620 2873 656c  .        if (sel
+00002640: 662e 5f61 7069 5f61 7379 6e63 2061 6e64  f._api_async and
+00002650: 2069 6e73 7065 6374 2e69 7363 6f72 6f75   inspect.iscorou
+00002660: 7469 6e65 6675 6e63 7469 6f6e 2873 656c  tinefunction(sel
+00002670: 662e 5f61 7069 5f61 7379 6e63 2e63 6c6f  f._api_async.clo
+00002680: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+00002690: 2020 2020 616e 6420 7365 6c66 2e5f 6170      and self._ap
+000026a0: 695f 6173 796e 632e 7365 7373 696f 6e29  i_async.session)
+000026b0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+000026c0: 6767 6572 2e64 6562 7567 2822 436c 6f73  gger.debug("Clos
+000026d0: 696e 6720 6173 796e 6320 6363 7874 2073  ing async ccxt s
+000026e0: 6573 7369 6f6e 2e22 290a 2020 2020 2020  ession.").      
+000026f0: 2020 2020 2020 7365 6c66 2e6c 6f6f 702e        self.loop.
+00002700: 7275 6e5f 756e 7469 6c5f 636f 6d70 6c65  run_until_comple
+00002710: 7465 2873 656c 662e 5f61 7069 5f61 7379  te(self._api_asy
+00002720: 6e63 2e63 6c6f 7365 2829 290a 2020 2020  nc.close()).    
+00002730: 2020 2020 6966 2073 656c 662e 6c6f 6f70      if self.loop
+00002740: 2061 6e64 206e 6f74 2073 656c 662e 6c6f   and not self.lo
+00002750: 6f70 2e69 735f 636c 6f73 6564 2829 3a0a  op.is_closed():.
+00002760: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00002770: 2e6c 6f6f 702e 636c 6f73 6528 290a 0a20  .loop.close().. 
+00002780: 2020 2064 6566 205f 696e 6974 5f61 7379     def _init_asy
+00002790: 6e63 5f6c 6f6f 7028 7365 6c66 2920 2d3e  nc_loop(self) ->
+000027a0: 2061 7379 6e63 696f 2e41 6273 7472 6163   asyncio.Abstrac
+000027b0: 7445 7665 6e74 4c6f 6f70 3a0a 2020 2020  tEventLoop:.    
+000027c0: 2020 2020 6c6f 6f70 203d 2061 7379 6e63      loop = async
+000027d0: 696f 2e6e 6577 5f65 7665 6e74 5f6c 6f6f  io.new_event_loo
+000027e0: 7028 290a 2020 2020 2020 2020 6173 796e  p().        asyn
+000027f0: 6369 6f2e 7365 745f 6576 656e 745f 6c6f  cio.set_event_lo
+00002800: 6f70 286c 6f6f 7029 0a20 2020 2020 2020  op(loop).       
+00002810: 2072 6574 7572 6e20 6c6f 6f70 0a0a 2020   return loop..  
+00002820: 2020 6465 6620 7661 6c69 6461 7465 5f63    def validate_c
+00002830: 6f6e 6669 6728 7365 6c66 2c20 636f 6e66  onfig(self, conf
+00002840: 6967 293a 0a20 2020 2020 2020 2023 2043  ig):.        # C
+00002850: 6865 636b 2069 6620 7469 6d65 6672 616d  heck if timefram
+00002860: 6520 6973 2061 7661 696c 6162 6c65 0a20  e is available. 
+00002870: 2020 2020 2020 2073 656c 662e 7661 6c69         self.vali
+00002880: 6461 7465 5f74 696d 6566 7261 6d65 7328  date_timeframes(
+00002890: 636f 6e66 6967 2e67 6574 2827 7469 6d65  config.get('time
+000028a0: 6672 616d 6527 2929 0a0a 2020 2020 2020  frame'))..      
+000028b0: 2020 2320 4368 6563 6b20 6966 2061 6c6c    # Check if all
+000028c0: 2070 6169 7273 2061 7265 2061 7661 696c   pairs are avail
+000028d0: 6162 6c65 0a20 2020 2020 2020 2073 656c  able.        sel
+000028e0: 662e 7661 6c69 6461 7465 5f73 7461 6b65  f.validate_stake
+000028f0: 6375 7272 656e 6379 2863 6f6e 6669 675b  currency(config[
+00002900: 2773 7461 6b65 5f63 7572 7265 6e63 7927  'stake_currency'
+00002910: 5d29 0a20 2020 2020 2020 2069 6620 6e6f  ]).        if no
+00002920: 7420 636f 6e66 6967 5b27 6578 6368 616e  t config['exchan
+00002930: 6765 275d 2e67 6574 2827 736b 6970 5f70  ge'].get('skip_p
+00002940: 6169 725f 7661 6c69 6461 7469 6f6e 2729  air_validation')
+00002950: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00002960: 6c66 2e76 616c 6964 6174 655f 7061 6972  lf.validate_pair
+00002970: 7328 636f 6e66 6967 5b27 6578 6368 616e  s(config['exchan
+00002980: 6765 275d 5b27 7061 6972 5f77 6869 7465  ge']['pair_white
+00002990: 6c69 7374 275d 290a 2020 2020 2020 2020  list']).        
+000029a0: 7365 6c66 2e76 616c 6964 6174 655f 6f72  self.validate_or
+000029b0: 6465 7274 7970 6573 2863 6f6e 6669 672e  dertypes(config.
+000029c0: 6765 7428 276f 7264 6572 5f74 7970 6573  get('order_types
+000029d0: 272c 207b 7d29 290a 2020 2020 2020 2020  ', {})).        
+000029e0: 7365 6c66 2e76 616c 6964 6174 655f 6f72  self.validate_or
+000029f0: 6465 725f 7469 6d65 5f69 6e5f 666f 7263  der_time_in_forc
+00002a00: 6528 636f 6e66 6967 2e67 6574 2827 6f72  e(config.get('or
+00002a10: 6465 725f 7469 6d65 5f69 6e5f 666f 7263  der_time_in_forc
+00002a20: 6527 2c20 7b7d 2929 0a20 2020 2020 2020  e', {})).       
+00002a30: 2073 656c 662e 7661 6c69 6461 7465 5f74   self.validate_t
+00002a40: 7261 6469 6e67 5f6d 6f64 655f 616e 645f  rading_mode_and_
+00002a50: 6d61 7267 696e 5f6d 6f64 6528 7365 6c66  margin_mode(self
+00002a60: 2e74 7261 6469 6e67 5f6d 6f64 652c 2073  .trading_mode, s
+00002a70: 656c 662e 6d61 7267 696e 5f6d 6f64 6529  elf.margin_mode)
+00002a80: 0a20 2020 2020 2020 2073 656c 662e 7661  .        self.va
+00002a90: 6c69 6461 7465 5f70 7269 6369 6e67 2863  lidate_pricing(c
+00002aa0: 6f6e 6669 675b 2765 7869 745f 7072 6963  onfig['exit_pric
+00002ab0: 696e 6727 5d29 0a20 2020 2020 2020 2073  ing']).        s
+00002ac0: 656c 662e 7661 6c69 6461 7465 5f70 7269  elf.validate_pri
+00002ad0: 6369 6e67 2863 6f6e 6669 675b 2765 6e74  cing(config['ent
+00002ae0: 7279 5f70 7269 6369 6e67 275d 290a 0a20  ry_pricing']).. 
+00002af0: 2020 2064 6566 205f 696e 6974 5f63 6378     def _init_ccx
+00002b00: 7428 7365 6c66 2c20 6578 6368 616e 6765  t(self, exchange
+00002b10: 5f63 6f6e 6669 673a 2044 6963 745b 7374  _config: Dict[st
+00002b20: 722c 2041 6e79 5d2c 2063 6378 745f 6d6f  r, Any], ccxt_mo
+00002b30: 6475 6c65 3a20 4363 7874 4d6f 6475 6c65  dule: CcxtModule
+00002b40: 5479 7065 203d 2063 6378 742c 0a20 2020  Type = ccxt,.   
+00002b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b60: 6363 7874 5f6b 7761 7267 733a 2044 6963  ccxt_kwargs: Dic
+00002b70: 7420 3d20 7b7d 2920 2d3e 2063 6378 742e  t = {}) -> ccxt.
+00002b80: 4578 6368 616e 6765 3a0a 2020 2020 2020  Exchange:.      
+00002b90: 2020 2222 220a 2020 2020 2020 2020 496e    """.        In
+00002ba0: 6974 6961 6c69 7a65 2063 6378 7420 7769  itialize ccxt wi
+00002bb0: 7468 2067 6976 656e 2063 6f6e 6669 6720  th given config 
+00002bc0: 616e 6420 7265 7475 726e 2076 616c 6964  and return valid
+00002bd0: 0a20 2020 2020 2020 2063 6378 7420 696e  .        ccxt in
+00002be0: 7374 616e 6365 2e0a 2020 2020 2020 2020  stance..        
+00002bf0: 2222 220a 2020 2020 2020 2020 2320 4669  """.        # Fi
+00002c00: 6e64 206d 6174 6368 696e 6720 636c 6173  nd matching clas
+00002c10: 7320 666f 7220 7468 6520 6769 7665 6e20  s for the given 
+00002c20: 6578 6368 616e 6765 206e 616d 650a 2020  exchange name.  
+00002c30: 2020 2020 2020 6e61 6d65 203d 2065 7863        name = exc
+00002c40: 6861 6e67 655f 636f 6e66 6967 5b27 6e61  hange_config['na
+00002c50: 6d65 275d 0a0a 2020 2020 2020 2020 6966  me']..        if
+00002c60: 206e 6f74 2069 735f 6578 6368 616e 6765   not is_exchange
+00002c70: 5f6b 6e6f 776e 5f63 6378 7428 6e61 6d65  _known_ccxt(name
+00002c80: 2c20 6363 7874 5f6d 6f64 756c 6529 3a0a  , ccxt_module):.
+00002c90: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00002ca0: 6520 4f70 6572 6174 696f 6e61 6c45 7863  e OperationalExc
+00002cb0: 6570 7469 6f6e 2866 2745 7863 6861 6e67  eption(f'Exchang
+00002cc0: 6520 7b6e 616d 657d 2069 7320 6e6f 7420  e {name} is not 
+00002cd0: 7375 7070 6f72 7465 6420 6279 2063 6378  supported by ccx
+00002ce0: 7427 290a 0a20 2020 2020 2020 2065 785f  t')..        ex_
+00002cf0: 636f 6e66 6967 203d 207b 0a20 2020 2020  config = {.     
+00002d00: 2020 2020 2020 2027 6170 694b 6579 273a         'apiKey':
+00002d10: 2065 7863 6861 6e67 655f 636f 6e66 6967   exchange_config
+00002d20: 2e67 6574 2827 6b65 7927 292c 0a20 2020  .get('key'),.   
+00002d30: 2020 2020 2020 2020 2027 7365 6372 6574           'secret
+00002d40: 273a 2065 7863 6861 6e67 655f 636f 6e66  ': exchange_conf
+00002d50: 6967 2e67 6574 2827 7365 6372 6574 2729  ig.get('secret')
+00002d60: 2c0a 2020 2020 2020 2020 2020 2020 2770  ,.            'p
+00002d70: 6173 7377 6f72 6427 3a20 6578 6368 616e  assword': exchan
+00002d80: 6765 5f63 6f6e 6669 672e 6765 7428 2770  ge_config.get('p
+00002d90: 6173 7377 6f72 6427 292c 0a20 2020 2020  assword'),.     
+00002da0: 2020 2020 2020 2027 7569 6427 3a20 6578         'uid': ex
+00002db0: 6368 616e 6765 5f63 6f6e 6669 672e 6765  change_config.ge
+00002dc0: 7428 2775 6964 272c 2027 2729 2c0a 2020  t('uid', ''),.  
+00002dd0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00002de0: 6966 2063 6378 745f 6b77 6172 6773 3a0a  if ccxt_kwargs:.
+00002df0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00002e00: 6572 2e69 6e66 6f28 2741 7070 6c79 696e  er.info('Applyin
+00002e10: 6720 6164 6469 7469 6f6e 616c 2063 6378  g additional ccx
+00002e20: 7420 636f 6e66 6967 3a20 2573 272c 2063  t config: %s', c
+00002e30: 6378 745f 6b77 6172 6773 290a 2020 2020  cxt_kwargs).    
+00002e40: 2020 2020 6966 2073 656c 662e 5f63 6378      if self._ccx
+00002e50: 745f 7061 7261 6d73 3a0a 2020 2020 2020  t_params:.      
+00002e60: 2020 2020 2020 2320 496e 6a65 6374 2073        # Inject s
+00002e70: 7461 7469 6320 6f70 7469 6f6e 7320 6166  tatic options af
+00002e80: 7465 7220 7468 6520 6162 6f76 6520 6f75  ter the above ou
+00002e90: 7470 7574 2074 6f20 6e6f 7420 636f 6e66  tput to not conf
+00002ea0: 7573 6520 7573 6572 732e 0a20 2020 2020  use users..     
+00002eb0: 2020 2020 2020 2063 6378 745f 6b77 6172         ccxt_kwar
+00002ec0: 6773 203d 2064 6565 705f 6d65 7267 655f  gs = deep_merge_
+00002ed0: 6469 6374 7328 7365 6c66 2e5f 6363 7874  dicts(self._ccxt
+00002ee0: 5f70 6172 616d 732c 2063 6378 745f 6b77  _params, ccxt_kw
+00002ef0: 6172 6773 290a 2020 2020 2020 2020 6966  args).        if
+00002f00: 2063 6378 745f 6b77 6172 6773 3a0a 2020   ccxt_kwargs:.  
+00002f10: 2020 2020 2020 2020 2020 6578 5f63 6f6e            ex_con
+00002f20: 6669 672e 7570 6461 7465 2863 6378 745f  fig.update(ccxt_
+00002f30: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+00002f40: 7472 793a 0a0a 2020 2020 2020 2020 2020  try:..          
+00002f50: 2020 6170 6920 3d20 6765 7461 7474 7228    api = getattr(
+00002f60: 6363 7874 5f6d 6f64 756c 652c 206e 616d  ccxt_module, nam
+00002f70: 652e 6c6f 7765 7228 2929 2865 785f 636f  e.lower())(ex_co
+00002f80: 6e66 6967 290a 2020 2020 2020 2020 6578  nfig).        ex
+00002f90: 6365 7074 2028 4b65 7945 7272 6f72 2c20  cept (KeyError, 
+00002fa0: 4174 7472 6962 7574 6545 7272 6f72 2920  AttributeError) 
+00002fb0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00002fc0: 2020 7261 6973 6520 4f70 6572 6174 696f    raise Operatio
+00002fd0: 6e61 6c45 7863 6570 7469 6f6e 2866 2745  nalException(f'E
+00002fe0: 7863 6861 6e67 6520 7b6e 616d 657d 2069  xchange {name} i
+00002ff0: 7320 6e6f 7420 7375 7070 6f72 7465 6427  s not supported'
+00003000: 2920 6672 6f6d 2065 0a20 2020 2020 2020  ) from e.       
+00003010: 2065 7863 6570 7420 6363 7874 2e42 6173   except ccxt.Bas
+00003020: 6545 7272 6f72 2061 7320 653a 0a20 2020  eError as e:.   
+00003030: 2020 2020 2020 2020 2072 6169 7365 204f           raise O
+00003040: 7065 7261 7469 6f6e 616c 4578 6365 7074  perationalExcept
+00003050: 696f 6e28 6622 496e 6974 6961 6c69 7a61  ion(f"Initializa
+00003060: 7469 6f6e 206f 6620 6363 7874 2066 6169  tion of ccxt fai
+00003070: 6c65 642e 2052 6561 736f 6e3a 207b 657d  led. Reason: {e}
+00003080: 2229 2066 726f 6d20 650a 0a20 2020 2020  ") from e..     
+00003090: 2020 2073 656c 662e 7365 745f 7361 6e64     self.set_sand
+000030a0: 626f 7828 6170 692c 2065 7863 6861 6e67  box(api, exchang
+000030b0: 655f 636f 6e66 6967 2c20 6e61 6d65 290a  e_config, name).
+000030c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000030d0: 6170 690a 0a20 2020 2040 7072 6f70 6572  api..    @proper
+000030e0: 7479 0a20 2020 2064 6566 205f 6363 7874  ty.    def _ccxt
+000030f0: 5f63 6f6e 6669 6728 7365 6c66 2920 2d3e  _config(self) ->
+00003100: 2044 6963 743a 0a20 2020 2020 2020 2023   Dict:.        #
+00003110: 2050 6172 616d 6574 6572 7320 746f 2061   Parameters to a
+00003120: 6464 2064 6972 6563 746c 7920 746f 2063  dd directly to c
+00003130: 6378 7420 7379 6e63 2f61 7379 6e63 2069  cxt sync/async i
+00003140: 6e69 7469 616c 697a 6174 696f 6e2e 0a20  nitialization.. 
+00003150: 2020 2020 2020 2069 6620 7365 6c66 2e74         if self.t
+00003160: 7261 6469 6e67 5f6d 6f64 6520 3d3d 2054  rading_mode == T
+00003170: 7261 6469 6e67 4d6f 6465 2e4d 4152 4749  radingMode.MARGI
+00003180: 4e3a 0a20 2020 2020 2020 2020 2020 2072  N:.            r
+00003190: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+000031a0: 2020 2020 2020 2020 226f 7074 696f 6e73          "options
+000031b0: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+000031c0: 2020 2020 2020 2020 2022 6465 6661 756c           "defaul
+000031d0: 7454 7970 6522 3a20 226d 6172 6769 6e22  tType": "margin"
+000031e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000031f0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00003200: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+00003210: 6c66 2e74 7261 6469 6e67 5f6d 6f64 6520  lf.trading_mode 
+00003220: 3d3d 2054 7261 6469 6e67 4d6f 6465 2e46  == TradingMode.F
+00003230: 5554 5552 4553 3a0a 2020 2020 2020 2020  UTURES:.        
+00003240: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
+00003250: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
+00003260: 7469 6f6e 7322 3a20 7b0a 2020 2020 2020  tions": {.      
+00003270: 2020 2020 2020 2020 2020 2020 2020 2264                "d
+00003280: 6566 6175 6c74 5479 7065 223a 2073 656c  efaultType": sel
+00003290: 662e 5f66 745f 6861 735b 2263 6378 745f  f._ft_has["ccxt_
+000032a0: 6675 7475 7265 735f 6e61 6d65 225d 0a20  futures_name"]. 
+000032b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000032c0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+000032d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000032e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000032f0: 7b7d 0a0a 2020 2020 4070 726f 7065 7274  {}..    @propert
+00003300: 790a 2020 2020 6465 6620 6e61 6d65 2873  y.    def name(s
+00003310: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+00003320: 2020 2020 2022 2222 6578 6368 616e 6765       """exchange
+00003330: 204e 616d 6520 2866 726f 6d20 6363 7874   Name (from ccxt
+00003340: 2922 2222 0a20 2020 2020 2020 2072 6574  )""".        ret
+00003350: 7572 6e20 7365 6c66 2e5f 6170 692e 6e61  urn self._api.na
+00003360: 6d65 0a0a 2020 2020 4070 726f 7065 7274  me..    @propert
+00003370: 790a 2020 2020 6465 6620 6964 2873 656c  y.    def id(sel
+00003380: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
+00003390: 2020 2022 2222 6578 6368 616e 6765 2063     """exchange c
+000033a0: 6378 7420 6964 2222 220a 2020 2020 2020  cxt id""".      
+000033b0: 2020 7265 7475 726e 2073 656c 662e 5f61    return self._a
+000033c0: 7069 2e69 640a 0a20 2020 2040 7072 6f70  pi.id..    @prop
+000033d0: 6572 7479 0a20 2020 2064 6566 2074 696d  erty.    def tim
+000033e0: 6566 7261 6d65 7328 7365 6c66 2920 2d3e  eframes(self) ->
+000033f0: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
+00003400: 2020 2020 7265 7475 726e 206c 6973 7428      return list(
+00003410: 2873 656c 662e 5f61 7069 2e74 696d 6566  (self._api.timef
+00003420: 7261 6d65 7320 6f72 207b 7d29 2e6b 6579  rames or {}).key
+00003430: 7328 2929 0a0a 2020 2020 4070 726f 7065  s())..    @prope
+00003440: 7274 790a 2020 2020 6465 6620 6d61 726b  rty.    def mark
+00003450: 6574 7328 7365 6c66 2920 2d3e 2044 6963  ets(self) -> Dic
+00003460: 743a 0a20 2020 2020 2020 2022 2222 6578  t:.        """ex
+00003470: 6368 616e 6765 2063 6378 7420 6d61 726b  change ccxt mark
+00003480: 6574 7322 2222 0a20 2020 2020 2020 2069  ets""".        i
+00003490: 6620 6e6f 7420 7365 6c66 2e5f 6d61 726b  f not self._mark
+000034a0: 6574 733a 0a20 2020 2020 2020 2020 2020  ets:.           
+000034b0: 206c 6f67 6765 722e 696e 666f 2822 4d61   logger.info("Ma
+000034c0: 726b 6574 7320 7765 7265 206e 6f74 206c  rkets were not l
+000034d0: 6f61 6465 642e 204c 6f61 6469 6e67 2074  oaded. Loading t
+000034e0: 6865 6d20 6e6f 772e 2e22 290a 2020 2020  hem now..").    
+000034f0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00003500: 6164 5f6d 6172 6b65 7473 2829 0a20 2020  ad_markets().   
+00003510: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00003520: 2e5f 6d61 726b 6574 730a 0a20 2020 2040  ._markets..    @
+00003530: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00003540: 2070 7265 6369 7369 6f6e 4d6f 6465 2873   precisionMode(s
+00003550: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
+00003560: 2020 2020 2022 2222 6578 6368 616e 6765       """exchange
+00003570: 2063 6378 7420 7072 6563 6973 696f 6e4d   ccxt precisionM
+00003580: 6f64 6522 2222 0a20 2020 2020 2020 2072  ode""".        r
+00003590: 6574 7572 6e20 7365 6c66 2e5f 6170 692e  eturn self._api.
+000035a0: 7072 6563 6973 696f 6e4d 6f64 650a 0a20  precisionMode.. 
+000035b0: 2020 2064 6566 2061 6464 6974 696f 6e61     def additiona
+000035c0: 6c5f 6578 6368 616e 6765 5f69 6e69 7428  l_exchange_init(
+000035d0: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
+000035e0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000035f0: 2020 2041 6464 6974 696f 6e61 6c20 6578     Additional ex
+00003600: 6368 616e 6765 2069 6e69 7469 616c 697a  change initializ
+00003610: 6174 696f 6e20 6c6f 6769 632e 0a20 2020  ation logic..   
+00003620: 2020 2020 202e 6170 6920 7769 6c6c 2062       .api will b
+00003630: 6520 6176 6169 6c61 626c 6520 6174 2074  e available at t
+00003640: 6869 7320 706f 696e 742e 0a20 2020 2020  his point..     
+00003650: 2020 204d 7573 7420 6265 206f 7665 7272     Must be overr
+00003660: 6964 6465 6e20 696e 2063 6869 6c64 206d  idden in child m
+00003670: 6574 686f 6473 2069 6620 7265 7175 6972  ethods if requir
+00003680: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
+00003690: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+000036a0: 2020 6465 6620 5f6c 6f67 5f65 7863 6861    def _log_excha
+000036b0: 6e67 655f 7265 7370 6f6e 7365 2873 656c  nge_response(sel
+000036c0: 662c 2065 6e64 706f 696e 742c 2072 6573  f, endpoint, res
+000036d0: 706f 6e73 6529 202d 3e20 4e6f 6e65 3a0a  ponse) -> None:.
+000036e0: 2020 2020 2020 2020 2222 2220 4c6f 6720          """ Log 
+000036f0: 6578 6368 616e 6765 2072 6573 706f 6e73  exchange respons
+00003700: 6573 2022 2222 0a20 2020 2020 2020 2069  es """.        i
+00003710: 6620 7365 6c66 2e6c 6f67 5f72 6573 706f  f self.log_respo
+00003720: 6e73 6573 3a0a 2020 2020 2020 2020 2020  nses:.          
+00003730: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
+00003740: 4150 4920 7b65 6e64 706f 696e 747d 3a20  API {endpoint}: 
+00003750: 7b72 6573 706f 6e73 657d 2229 0a0a 2020  {response}")..  
+00003760: 2020 6465 6620 6f68 6c63 765f 6361 6e64    def ohlcv_cand
+00003770: 6c65 5f6c 696d 6974 280a 2020 2020 2020  le_limit(.      
+00003780: 2020 2020 2020 7365 6c66 2c20 7469 6d65        self, time
+00003790: 6672 616d 653a 2073 7472 2c20 6361 6e64  frame: str, cand
+000037a0: 6c65 5f74 7970 653a 2043 616e 646c 6554  le_type: CandleT
+000037b0: 7970 652c 2073 696e 6365 5f6d 733a 204f  ype, since_ms: O
+000037c0: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
+000037d0: 6f6e 6529 202d 3e20 696e 743a 0a20 2020  one) -> int:.   
+000037e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000037f0: 2045 7863 6861 6e67 6520 6f68 6c63 7620   Exchange ohlcv 
+00003800: 6361 6e64 6c65 206c 696d 6974 0a20 2020  candle limit.   
+00003810: 2020 2020 2055 7365 7320 6f68 6c63 765f       Uses ohlcv_
 00003820: 6361 6e64 6c65 5f6c 696d 6974 5f70 6572  candle_limit_per
-00003830: 5f74 696d 6566 7261 6d65 272c 207b 7d29  _timeframe', {})
-00003840: 2e67 6574 280a 2020 2020 2020 2020 2020  .get(.          
-00003850: 2020 7469 6d65 6672 616d 652c 2073 656c    timeframe, sel
-00003860: 662e 5f66 745f 6861 732e 6765 7428 276f  f._ft_has.get('o
-00003870: 686c 6376 5f63 616e 646c 655f 6c69 6d69  hlcv_candle_limi
-00003880: 7427 2929 290a 0a20 2020 2064 6566 2067  t')))..    def g
-00003890: 6574 5f6d 6172 6b65 7473 2873 656c 662c  et_markets(self,
-000038a0: 2062 6173 655f 6375 7272 656e 6369 6573   base_currencies
-000038b0: 3a20 4c69 7374 5b73 7472 5d20 3d20 5b5d  : List[str] = []
-000038c0: 2c20 7175 6f74 655f 6375 7272 656e 6369  , quote_currenci
-000038d0: 6573 3a20 4c69 7374 5b73 7472 5d20 3d20  es: List[str] = 
-000038e0: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-000038f0: 2020 2020 2020 2020 7370 6f74 5f6f 6e6c          spot_onl
-00003900: 793a 2062 6f6f 6c20 3d20 4661 6c73 652c  y: bool = False,
-00003910: 206d 6172 6769 6e5f 6f6e 6c79 3a20 626f   margin_only: bo
-00003920: 6f6c 203d 2046 616c 7365 2c20 6675 7475  ol = False, futu
-00003930: 7265 735f 6f6e 6c79 3a20 626f 6f6c 203d  res_only: bool =
-00003940: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-00003950: 2020 2020 2020 2020 2020 2020 7472 6164              trad
-00003960: 6162 6c65 5f6f 6e6c 793a 2062 6f6f 6c20  able_only: bool 
-00003970: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-00003980: 2020 2020 2020 2020 2020 2020 6163 7469              acti
-00003990: 7665 5f6f 6e6c 793a 2062 6f6f 6c20 3d20  ve_only: bool = 
-000039a0: 4661 6c73 6529 202d 3e20 4469 6374 5b73  False) -> Dict[s
-000039b0: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
-000039c0: 2020 2222 220a 2020 2020 2020 2020 5265    """.        Re
-000039d0: 7475 726e 2065 7863 6861 6e67 6520 6363  turn exchange cc
-000039e0: 7874 206d 6172 6b65 7473 2c20 6669 6c74  xt markets, filt
-000039f0: 6572 6564 206f 7574 2062 7920 6261 7365  ered out by base
-00003a00: 2063 7572 7265 6e63 7920 616e 6420 7175   currency and qu
-00003a10: 6f74 6520 6375 7272 656e 6379 0a20 2020  ote currency.   
-00003a20: 2020 2020 2069 6620 7468 6973 2077 6173       if this was
-00003a30: 2072 6571 7565 7374 6564 2069 6e20 7061   requested in pa
-00003a40: 7261 6d65 7465 7273 2e0a 2020 2020 2020  rameters..      
-00003a50: 2020 2222 220a 2020 2020 2020 2020 6d61    """.        ma
-00003a60: 726b 6574 7320 3d20 7365 6c66 2e6d 6172  rkets = self.mar
-00003a70: 6b65 7473 0a20 2020 2020 2020 2069 6620  kets.        if 
-00003a80: 6e6f 7420 6d61 726b 6574 733a 0a20 2020  not markets:.   
-00003a90: 2020 2020 2020 2020 2072 6169 7365 204f           raise O
-00003aa0: 7065 7261 7469 6f6e 616c 4578 6365 7074  perationalExcept
-00003ab0: 696f 6e28 224d 6172 6b65 7473 2077 6572  ion("Markets wer
-00003ac0: 6520 6e6f 7420 6c6f 6164 6564 2e22 290a  e not loaded.").
-00003ad0: 0a20 2020 2020 2020 2069 6620 6261 7365  .        if base
-00003ae0: 5f63 7572 7265 6e63 6965 733a 0a20 2020  _currencies:.   
-00003af0: 2020 2020 2020 2020 206d 6172 6b65 7473           markets
-00003b00: 203d 207b 6b3a 2076 2066 6f72 206b 2c20   = {k: v for k, 
-00003b10: 7620 696e 206d 6172 6b65 7473 2e69 7465  v in markets.ite
-00003b20: 6d73 2829 2069 6620 765b 2762 6173 6527  ms() if v['base'
-00003b30: 5d20 696e 2062 6173 655f 6375 7272 656e  ] in base_curren
-00003b40: 6369 6573 7d0a 2020 2020 2020 2020 6966  cies}.        if
-00003b50: 2071 756f 7465 5f63 7572 7265 6e63 6965   quote_currencie
-00003b60: 733a 0a20 2020 2020 2020 2020 2020 206d  s:.            m
-00003b70: 6172 6b65 7473 203d 207b 6b3a 2076 2066  arkets = {k: v f
-00003b80: 6f72 206b 2c20 7620 696e 206d 6172 6b65  or k, v in marke
-00003b90: 7473 2e69 7465 6d73 2829 2069 6620 765b  ts.items() if v[
-00003ba0: 2771 756f 7465 275d 2069 6e20 7175 6f74  'quote'] in quot
-00003bb0: 655f 6375 7272 656e 6369 6573 7d0a 2020  e_currencies}.  
-00003bc0: 2020 2020 2020 6966 2074 7261 6461 626c        if tradabl
-00003bd0: 655f 6f6e 6c79 3a0a 2020 2020 2020 2020  e_only:.        
-00003be0: 2020 2020 6d61 726b 6574 7320 3d20 7b6b      markets = {k
-00003bf0: 3a20 7620 666f 7220 6b2c 2076 2069 6e20  : v for k, v in 
-00003c00: 6d61 726b 6574 732e 6974 656d 7328 2920  markets.items() 
-00003c10: 6966 2073 656c 662e 6d61 726b 6574 5f69  if self.market_i
-00003c20: 735f 7472 6164 6162 6c65 2876 297d 0a20  s_tradable(v)}. 
-00003c30: 2020 2020 2020 2069 6620 7370 6f74 5f6f         if spot_o
-00003c40: 6e6c 793a 0a20 2020 2020 2020 2020 2020  nly:.           
-00003c50: 206d 6172 6b65 7473 203d 207b 6b3a 2076   markets = {k: v
-00003c60: 2066 6f72 206b 2c20 7620 696e 206d 6172   for k, v in mar
-00003c70: 6b65 7473 2e69 7465 6d73 2829 2069 6620  kets.items() if 
-00003c80: 7365 6c66 2e6d 6172 6b65 745f 6973 5f73  self.market_is_s
-00003c90: 706f 7428 7629 7d0a 2020 2020 2020 2020  pot(v)}.        
-00003ca0: 6966 206d 6172 6769 6e5f 6f6e 6c79 3a0a  if margin_only:.
-00003cb0: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
-00003cc0: 6574 7320 3d20 7b6b 3a20 7620 666f 7220  ets = {k: v for 
-00003cd0: 6b2c 2076 2069 6e20 6d61 726b 6574 732e  k, v in markets.
-00003ce0: 6974 656d 7328 2920 6966 2073 656c 662e  items() if self.
-00003cf0: 6d61 726b 6574 5f69 735f 6d61 7267 696e  market_is_margin
-00003d00: 2876 297d 0a20 2020 2020 2020 2069 6620  (v)}.        if 
-00003d10: 6675 7475 7265 735f 6f6e 6c79 3a0a 2020  futures_only:.  
-00003d20: 2020 2020 2020 2020 2020 6d61 726b 6574            market
-00003d30: 7320 3d20 7b6b 3a20 7620 666f 7220 6b2c  s = {k: v for k,
-00003d40: 2076 2069 6e20 6d61 726b 6574 732e 6974   v in markets.it
-00003d50: 656d 7328 2920 6966 2073 656c 662e 6d61  ems() if self.ma
-00003d60: 726b 6574 5f69 735f 6675 7475 7265 2876  rket_is_future(v
-00003d70: 297d 0a20 2020 2020 2020 2069 6620 6163  )}.        if ac
-00003d80: 7469 7665 5f6f 6e6c 793a 0a20 2020 2020  tive_only:.     
-00003d90: 2020 2020 2020 206d 6172 6b65 7473 203d         markets =
-00003da0: 207b 6b3a 2076 2066 6f72 206b 2c20 7620   {k: v for k, v 
-00003db0: 696e 206d 6172 6b65 7473 2e69 7465 6d73  in markets.items
-00003dc0: 2829 2069 6620 6d61 726b 6574 5f69 735f  () if market_is_
-00003dd0: 6163 7469 7665 2876 297d 0a20 2020 2020  active(v)}.     
-00003de0: 2020 2072 6574 7572 6e20 6d61 726b 6574     return market
-00003df0: 730a 0a20 2020 2064 6566 2067 6574 5f71  s..    def get_q
-00003e00: 756f 7465 5f63 7572 7265 6e63 6965 7328  uote_currencies(
-00003e10: 7365 6c66 2920 2d3e 204c 6973 745b 7374  self) -> List[st
-00003e20: 725d 3a0a 2020 2020 2020 2020 2222 220a  r]:.        """.
-00003e30: 2020 2020 2020 2020 5265 7475 726e 2061          Return a
-00003e40: 206c 6973 7420 6f66 2073 7570 706f 7274   list of support
-00003e50: 6564 2071 756f 7465 2063 7572 7265 6e63  ed quote currenc
-00003e60: 6965 730a 2020 2020 2020 2020 2222 220a  ies.        """.
-00003e70: 2020 2020 2020 2020 6d61 726b 6574 7320          markets 
-00003e80: 3d20 7365 6c66 2e6d 6172 6b65 7473 0a20  = self.markets. 
-00003e90: 2020 2020 2020 2072 6574 7572 6e20 736f         return so
-00003ea0: 7274 6564 2873 6574 285b 785b 2771 756f  rted(set([x['quo
-00003eb0: 7465 275d 2066 6f72 205f 2c20 7820 696e  te'] for _, x in
-00003ec0: 206d 6172 6b65 7473 2e69 7465 6d73 2829   markets.items()
-00003ed0: 5d29 290a 0a20 2020 2064 6566 2067 6574  ]))..    def get
-00003ee0: 5f70 6169 725f 7175 6f74 655f 6375 7272  _pair_quote_curr
-00003ef0: 656e 6379 2873 656c 662c 2070 6169 723a  ency(self, pair:
-00003f00: 2073 7472 2920 2d3e 2073 7472 3a0a 2020   str) -> str:.  
-00003f10: 2020 2020 2020 2222 2220 5265 7475 726e        """ Return
-00003f20: 2061 2070 6169 7227 7320 7175 6f74 6520   a pair's quote 
-00003f30: 6375 7272 656e 6379 2028 6261 7365 2f71  currency (base/q
-00003f40: 756f 7465 3a73 6574 746c 656d 656e 7429  uote:settlement)
-00003f50: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-00003f60: 7572 6e20 7365 6c66 2e6d 6172 6b65 7473  urn self.markets
-00003f70: 2e67 6574 2870 6169 722c 207b 7d29 2e67  .get(pair, {}).g
-00003f80: 6574 2827 7175 6f74 6527 2c20 2727 290a  et('quote', '').
-00003f90: 0a20 2020 2064 6566 2067 6574 5f70 6169  .    def get_pai
-00003fa0: 725f 6261 7365 5f63 7572 7265 6e63 7928  r_base_currency(
-00003fb0: 7365 6c66 2c20 7061 6972 3a20 7374 7229  self, pair: str)
-00003fc0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00003fd0: 2022 2222 2052 6574 7572 6e20 6120 7061   """ Return a pa
-00003fe0: 6972 2773 2062 6173 6520 6375 7272 656e  ir's base curren
-00003ff0: 6379 2028 6261 7365 2f71 756f 7465 3a73  cy (base/quote:s
-00004000: 6574 746c 656d 656e 7429 2022 2222 0a20  ettlement) """. 
-00004010: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00004020: 6c66 2e6d 6172 6b65 7473 2e67 6574 2870  lf.markets.get(p
-00004030: 6169 722c 207b 7d29 2e67 6574 2827 6261  air, {}).get('ba
-00004040: 7365 272c 2027 2729 0a0a 2020 2020 6465  se', '')..    de
-00004050: 6620 6d61 726b 6574 5f69 735f 6675 7475  f market_is_futu
-00004060: 7265 2873 656c 662c 206d 6172 6b65 743a  re(self, market:
-00004070: 2044 6963 745b 7374 722c 2041 6e79 5d29   Dict[str, Any])
-00004080: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-00004090: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
-000040a0: 2020 2020 2020 206d 6172 6b65 742e 6765         market.ge
-000040b0: 7428 7365 6c66 2e5f 6674 5f68 6173 5b22  t(self._ft_has["
-000040c0: 6363 7874 5f66 7574 7572 6573 5f6e 616d  ccxt_futures_nam
-000040d0: 6522 5d2c 2046 616c 7365 2920 6973 2054  e"], False) is T
-000040e0: 7275 6520 616e 640a 2020 2020 2020 2020  rue and.        
-000040f0: 2020 2020 6d61 726b 6574 2e67 6574 2827      market.get('
-00004100: 6c69 6e65 6172 272c 2046 616c 7365 2920  linear', False) 
-00004110: 6973 2054 7275 650a 2020 2020 2020 2020  is True.        
-00004120: 290a 0a20 2020 2064 6566 206d 6172 6b65  )..    def marke
-00004130: 745f 6973 5f73 706f 7428 7365 6c66 2c20  t_is_spot(self, 
-00004140: 6d61 726b 6574 3a20 4469 6374 5b73 7472  market: Dict[str
-00004150: 2c20 416e 795d 2920 2d3e 2062 6f6f 6c3a  , Any]) -> bool:
-00004160: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00004170: 6d61 726b 6574 2e67 6574 2827 7370 6f74  market.get('spot
-00004180: 272c 2046 616c 7365 2920 6973 2054 7275  ', False) is Tru
-00004190: 650a 0a20 2020 2064 6566 206d 6172 6b65  e..    def marke
-000041a0: 745f 6973 5f6d 6172 6769 6e28 7365 6c66  t_is_margin(self
-000041b0: 2c20 6d61 726b 6574 3a20 4469 6374 5b73  , market: Dict[s
-000041c0: 7472 2c20 416e 795d 2920 2d3e 2062 6f6f  tr, Any]) -> boo
-000041d0: 6c3a 0a20 2020 2020 2020 2072 6574 7572  l:.        retur
-000041e0: 6e20 6d61 726b 6574 2e67 6574 2827 6d61  n market.get('ma
-000041f0: 7267 696e 272c 2046 616c 7365 2920 6973  rgin', False) is
-00004200: 2054 7275 650a 0a20 2020 2064 6566 206d   True..    def m
-00004210: 6172 6b65 745f 6973 5f74 7261 6461 626c  arket_is_tradabl
-00004220: 6528 7365 6c66 2c20 6d61 726b 6574 3a20  e(self, market: 
-00004230: 4469 6374 5b73 7472 2c20 416e 795d 2920  Dict[str, Any]) 
-00004240: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
-00004250: 2022 2222 0a20 2020 2020 2020 2043 6865   """.        Che
-00004260: 636b 2069 6620 7468 6520 6d61 726b 6574  ck if the market
-00004270: 2073 796d 626f 6c20 6973 2074 7261 6461   symbol is trada
-00004280: 626c 6520 6279 2046 7265 7174 7261 6465  ble by Freqtrade
-00004290: 2e0a 2020 2020 2020 2020 456e 7375 7265  ..        Ensure
-000042a0: 7320 7468 6174 2043 6f6e 6669 6775 7265  s that Configure
-000042b0: 6420 6d6f 6465 2061 6c69 676e 7320 746f  d mode aligns to
-000042c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000042d0: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
-000042e0: 2020 2020 2020 2020 2020 6d61 726b 6574            market
-000042f0: 2e67 6574 2827 7175 6f74 6527 2c20 4e6f  .get('quote', No
-00004300: 6e65 2920 6973 206e 6f74 204e 6f6e 650a  ne) is not None.
-00004310: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00004320: 6d61 726b 6574 2e67 6574 2827 6261 7365  market.get('base
-00004330: 272c 204e 6f6e 6529 2069 7320 6e6f 7420  ', None) is not 
-00004340: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00004350: 2061 6e64 2028 7365 6c66 2e70 7265 6369   and (self.preci
-00004360: 7369 6f6e 4d6f 6465 2021 3d20 5449 434b  sionMode != TICK
-00004370: 5f53 495a 450a 2020 2020 2020 2020 2020  _SIZE.          
-00004380: 2020 2020 2020 2023 2054 6f6f 206c 6f77         # Too low
-00004390: 2070 7265 6369 7369 6f6e 2077 696c 6c20   precision will 
-000043a0: 6661 6c73 6966 7920 6361 6c63 756c 6174  falsify calculat
-000043b0: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
-000043c0: 2020 2020 2020 6f72 206d 6172 6b65 742e        or market.
-000043d0: 6765 7428 2770 7265 6369 7369 6f6e 272c  get('precision',
-000043e0: 207b 7d29 2e67 6574 2827 7072 6963 6527   {}).get('price'
-000043f0: 2920 3e20 3165 2d31 3129 0a20 2020 2020  ) > 1e-11).     
-00004400: 2020 2020 2020 2061 6e64 2028 2873 656c         and ((sel
-00004410: 662e 7472 6164 696e 675f 6d6f 6465 203d  f.trading_mode =
-00004420: 3d20 5472 6164 696e 674d 6f64 652e 5350  = TradingMode.SP
-00004430: 4f54 2061 6e64 2073 656c 662e 6d61 726b  OT and self.mark
-00004440: 6574 5f69 735f 7370 6f74 286d 6172 6b65  et_is_spot(marke
-00004450: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
-00004460: 2020 2020 206f 7220 2873 656c 662e 7472       or (self.tr
-00004470: 6164 696e 675f 6d6f 6465 203d 3d20 5472  ading_mode == Tr
-00004480: 6164 696e 674d 6f64 652e 4d41 5247 494e  adingMode.MARGIN
-00004490: 2061 6e64 2073 656c 662e 6d61 726b 6574   and self.market
-000044a0: 5f69 735f 6d61 7267 696e 286d 6172 6b65  _is_margin(marke
-000044b0: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
-000044c0: 2020 2020 206f 7220 2873 656c 662e 7472       or (self.tr
-000044d0: 6164 696e 675f 6d6f 6465 203d 3d20 5472  ading_mode == Tr
-000044e0: 6164 696e 674d 6f64 652e 4655 5455 5245  adingMode.FUTURE
-000044f0: 5320 616e 6420 7365 6c66 2e6d 6172 6b65  S and self.marke
-00004500: 745f 6973 5f66 7574 7572 6528 6d61 726b  t_is_future(mark
-00004510: 6574 2929 290a 2020 2020 2020 2020 290a  et))).        ).
-00004520: 0a20 2020 2064 6566 206b 6c69 6e65 7328  .    def klines(
-00004530: 7365 6c66 2c20 7061 6972 5f69 6e74 6572  self, pair_inter
-00004540: 7661 6c3a 2050 6169 7257 6974 6854 696d  val: PairWithTim
-00004550: 6566 7261 6d65 2c20 636f 7079 3a20 626f  eframe, copy: bo
-00004560: 6f6c 203d 2054 7275 6529 202d 3e20 4461  ol = True) -> Da
-00004570: 7461 4672 616d 653a 0a20 2020 2020 2020  taFrame:.       
-00004580: 2069 6620 7061 6972 5f69 6e74 6572 7661   if pair_interva
-00004590: 6c20 696e 2073 656c 662e 5f6b 6c69 6e65  l in self._kline
-000045a0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-000045b0: 6574 7572 6e20 7365 6c66 2e5f 6b6c 696e  eturn self._klin
-000045c0: 6573 5b70 6169 725f 696e 7465 7276 616c  es[pair_interval
-000045d0: 5d2e 636f 7079 2829 2069 6620 636f 7079  ].copy() if copy
-000045e0: 2065 6c73 6520 7365 6c66 2e5f 6b6c 696e   else self._klin
-000045f0: 6573 5b70 6169 725f 696e 7465 7276 616c  es[pair_interval
-00004600: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-00004610: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00004620: 726e 2044 6174 6146 7261 6d65 2829 0a0a  rn DataFrame()..
-00004630: 2020 2020 6465 6620 6765 745f 636f 6e74      def get_cont
-00004640: 7261 6374 5f73 697a 6528 7365 6c66 2c20  ract_size(self, 
-00004650: 7061 6972 3a20 7374 7229 202d 3e20 4f70  pair: str) -> Op
-00004660: 7469 6f6e 616c 5b66 6c6f 6174 5d3a 0a20  tional[float]:. 
-00004670: 2020 2020 2020 2069 6620 7365 6c66 2e74         if self.t
-00004680: 7261 6469 6e67 5f6d 6f64 6520 3d3d 2054  rading_mode == T
-00004690: 7261 6469 6e67 4d6f 6465 2e46 5554 5552  radingMode.FUTUR
-000046a0: 4553 3a0a 2020 2020 2020 2020 2020 2020  ES:.            
-000046b0: 6d61 726b 6574 203d 2073 656c 662e 6d61  market = self.ma
-000046c0: 726b 6574 732e 6765 7428 7061 6972 2c20  rkets.get(pair, 
-000046d0: 7b7d 290a 2020 2020 2020 2020 2020 2020  {}).            
-000046e0: 636f 6e74 7261 6374 5f73 697a 653a 2066  contract_size: f
-000046f0: 6c6f 6174 203d 2031 2e30 0a20 2020 2020  loat = 1.0.     
-00004700: 2020 2020 2020 2069 6620 6e6f 7420 6d61         if not ma
-00004710: 726b 6574 3a0a 2020 2020 2020 2020 2020  rket:.          
-00004720: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00004730: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00004740: 206d 6172 6b65 742e 6765 7428 2763 6f6e   market.get('con
-00004750: 7472 6163 7453 697a 6527 2920 6973 206e  tractSize') is n
-00004760: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00004770: 2020 2020 2020 2020 2023 2063 6378 7420           # ccxt 
-00004780: 6861 7320 636f 6e74 7261 6374 5369 7a65  has contractSize
-00004790: 2069 6e20 6d61 726b 6574 7320 6173 2073   in markets as s
-000047a0: 7472 696e 670a 2020 2020 2020 2020 2020  tring.          
-000047b0: 2020 2020 2020 636f 6e74 7261 6374 5f73        contract_s
-000047c0: 697a 6520 3d20 666c 6f61 7428 6d61 726b  ize = float(mark
-000047d0: 6574 5b27 636f 6e74 7261 6374 5369 7a65  et['contractSize
-000047e0: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
-000047f0: 7265 7475 726e 2063 6f6e 7472 6163 745f  return contract_
-00004800: 7369 7a65 0a20 2020 2020 2020 2065 6c73  size.        els
-00004810: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00004820: 6574 7572 6e20 310a 0a20 2020 2064 6566  eturn 1..    def
-00004830: 205f 7472 6164 6573 5f63 6f6e 7472 6163   _trades_contrac
-00004840: 7473 5f74 6f5f 616d 6f75 6e74 2873 656c  ts_to_amount(sel
-00004850: 662c 2074 7261 6465 733a 204c 6973 7429  f, trades: List)
-00004860: 202d 3e20 4c69 7374 3a0a 2020 2020 2020   -> List:.      
-00004870: 2020 6966 206c 656e 2874 7261 6465 7329    if len(trades)
-00004880: 203e 2030 2061 6e64 2027 7379 6d62 6f6c   > 0 and 'symbol
-00004890: 2720 696e 2074 7261 6465 735b 305d 3a0a  ' in trades[0]:.
-000048a0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-000048b0: 7261 6374 5f73 697a 6520 3d20 7365 6c66  ract_size = self
-000048c0: 2e67 6574 5f63 6f6e 7472 6163 745f 7369  .get_contract_si
-000048d0: 7a65 2874 7261 6465 735b 305d 5b27 7379  ze(trades[0]['sy
-000048e0: 6d62 6f6c 275d 290a 2020 2020 2020 2020  mbol']).        
-000048f0: 2020 2020 6966 2063 6f6e 7472 6163 745f      if contract_
-00004900: 7369 7a65 2021 3d20 313a 0a20 2020 2020  size != 1:.     
-00004910: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-00004920: 7261 6465 2069 6e20 7472 6164 6573 3a0a  rade in trades:.
-00004930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004940: 2020 2020 7472 6164 655b 2761 6d6f 756e      trade['amoun
-00004950: 7427 5d20 3d20 7472 6164 655b 2761 6d6f  t'] = trade['amo
-00004960: 756e 7427 5d20 2a20 636f 6e74 7261 6374  unt'] * contract
-00004970: 5f73 697a 650a 2020 2020 2020 2020 7265  _size.        re
-00004980: 7475 726e 2074 7261 6465 730a 0a20 2020  turn trades..   
-00004990: 2064 6566 205f 6f72 6465 725f 636f 6e74   def _order_cont
-000049a0: 7261 6374 735f 746f 5f61 6d6f 756e 7428  racts_to_amount(
-000049b0: 7365 6c66 2c20 6f72 6465 723a 2044 6963  self, order: Dic
-000049c0: 7429 202d 3e20 4469 6374 3a0a 2020 2020  t) -> Dict:.    
-000049d0: 2020 2020 6966 2027 7379 6d62 6f6c 2720      if 'symbol' 
-000049e0: 696e 206f 7264 6572 2061 6e64 206f 7264  in order and ord
-000049f0: 6572 5b27 7379 6d62 6f6c 275d 2069 7320  er['symbol'] is 
-00004a00: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00004a10: 2020 2020 2020 636f 6e74 7261 6374 5f73        contract_s
-00004a20: 697a 6520 3d20 7365 6c66 2e67 6574 5f63  ize = self.get_c
-00004a30: 6f6e 7472 6163 745f 7369 7a65 286f 7264  ontract_size(ord
-00004a40: 6572 5b27 7379 6d62 6f6c 275d 290a 2020  er['symbol']).  
-00004a50: 2020 2020 2020 2020 2020 6966 2063 6f6e            if con
-00004a60: 7472 6163 745f 7369 7a65 2021 3d20 313a  tract_size != 1:
-00004a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004a80: 2066 6f72 2070 726f 7020 696e 2073 656c   for prop in sel
-00004a90: 662e 5f66 745f 6861 732e 6765 7428 276f  f._ft_has.get('o
-00004aa0: 7264 6572 5f70 726f 7073 5f69 6e5f 636f  rder_props_in_co
-00004ab0: 6e74 7261 6374 7327 2c20 5b5d 293a 0a20  ntracts', []):. 
-00004ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ad0: 2020 2069 6620 7072 6f70 2069 6e20 6f72     if prop in or
-00004ae0: 6465 7220 616e 6420 6f72 6465 725b 7072  der and order[pr
-00004af0: 6f70 5d20 6973 206e 6f74 204e 6f6e 653a  op] is not None:
-00004b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004b10: 2020 2020 2020 2020 206f 7264 6572 5b70           order[p
-00004b20: 726f 705d 203d 206f 7264 6572 5b70 726f  rop] = order[pro
-00004b30: 705d 202a 2063 6f6e 7472 6163 745f 7369  p] * contract_si
-00004b40: 7a65 0a20 2020 2020 2020 2072 6574 7572  ze.        retur
-00004b50: 6e20 6f72 6465 720a 0a20 2020 2064 6566  n order..    def
-00004b60: 205f 616d 6f75 6e74 5f74 6f5f 636f 6e74   _amount_to_cont
-00004b70: 7261 6374 7328 7365 6c66 2c20 7061 6972  racts(self, pair
-00004b80: 3a20 7374 722c 2061 6d6f 756e 743a 2066  : str, amount: f
-00004b90: 6c6f 6174 2920 2d3e 2066 6c6f 6174 3a0a  loat) -> float:.
-00004ba0: 0a20 2020 2020 2020 2063 6f6e 7472 6163  .        contrac
-00004bb0: 745f 7369 7a65 203d 2073 656c 662e 6765  t_size = self.ge
-00004bc0: 745f 636f 6e74 7261 6374 5f73 697a 6528  t_contract_size(
-00004bd0: 7061 6972 290a 2020 2020 2020 2020 7265  pair).        re
-00004be0: 7475 726e 2061 6d6f 756e 745f 746f 5f63  turn amount_to_c
-00004bf0: 6f6e 7472 6163 7473 2861 6d6f 756e 742c  ontracts(amount,
-00004c00: 2063 6f6e 7472 6163 745f 7369 7a65 290a   contract_size).
-00004c10: 0a20 2020 2064 6566 205f 636f 6e74 7261  .    def _contra
-00004c20: 6374 735f 746f 5f61 6d6f 756e 7428 7365  cts_to_amount(se
-00004c30: 6c66 2c20 7061 6972 3a20 7374 722c 206e  lf, pair: str, n
-00004c40: 756d 5f63 6f6e 7472 6163 7473 3a20 666c  um_contracts: fl
-00004c50: 6f61 7429 202d 3e20 666c 6f61 743a 0a0a  oat) -> float:..
-00004c60: 2020 2020 2020 2020 636f 6e74 7261 6374          contract
-00004c70: 5f73 697a 6520 3d20 7365 6c66 2e67 6574  _size = self.get
-00004c80: 5f63 6f6e 7472 6163 745f 7369 7a65 2870  _contract_size(p
-00004c90: 6169 7229 0a20 2020 2020 2020 2072 6574  air).        ret
-00004ca0: 7572 6e20 636f 6e74 7261 6374 735f 746f  urn contracts_to
-00004cb0: 5f61 6d6f 756e 7428 6e75 6d5f 636f 6e74  _amount(num_cont
-00004cc0: 7261 6374 732c 2063 6f6e 7472 6163 745f  racts, contract_
-00004cd0: 7369 7a65 290a 0a20 2020 2064 6566 2061  size)..    def a
-00004ce0: 6d6f 756e 745f 746f 5f63 6f6e 7472 6163  mount_to_contrac
-00004cf0: 745f 7072 6563 6973 696f 6e28 7365 6c66  t_precision(self
-00004d00: 2c20 7061 6972 3a20 7374 722c 2061 6d6f  , pair: str, amo
-00004d10: 756e 743a 2066 6c6f 6174 2920 2d3e 2066  unt: float) -> f
-00004d20: 6c6f 6174 3a0a 2020 2020 2020 2020 2222  loat:.        ""
-00004d30: 220a 2020 2020 2020 2020 4865 6c70 6572  ".        Helper
-00004d40: 2077 7261 7070 6572 2061 726f 756e 6420   wrapper around 
-00004d50: 616d 6f75 6e74 5f74 6f5f 636f 6e74 7261  amount_to_contra
-00004d60: 6374 5f70 7265 6369 7369 6f6e 0a20 2020  ct_precision.   
-00004d70: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00004d80: 2063 6f6e 7472 6163 745f 7369 7a65 203d   contract_size =
-00004d90: 2073 656c 662e 6765 745f 636f 6e74 7261   self.get_contra
-00004da0: 6374 5f73 697a 6528 7061 6972 290a 0a20  ct_size(pair).. 
-00004db0: 2020 2020 2020 2072 6574 7572 6e20 616d         return am
-00004dc0: 6f75 6e74 5f74 6f5f 636f 6e74 7261 6374  ount_to_contract
-00004dd0: 5f70 7265 6369 7369 6f6e 2861 6d6f 756e  _precision(amoun
-00004de0: 742c 2073 656c 662e 6765 745f 7072 6563  t, self.get_prec
-00004df0: 6973 696f 6e5f 616d 6f75 6e74 2870 6169  ision_amount(pai
-00004e00: 7229 2c0a 2020 2020 2020 2020 2020 2020  r),.            
-00004e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004e30: 7365 6c66 2e70 7265 6369 7369 6f6e 4d6f  self.precisionMo
-00004e40: 6465 2c20 636f 6e74 7261 6374 5f73 697a  de, contract_siz
-00004e50: 6529 0a0a 2020 2020 6465 6620 7365 745f  e)..    def set_
-00004e60: 7361 6e64 626f 7828 7365 6c66 2c20 6170  sandbox(self, ap
-00004e70: 693a 2063 6378 742e 4578 6368 616e 6765  i: ccxt.Exchange
-00004e80: 2c20 6578 6368 616e 6765 5f63 6f6e 6669  , exchange_confi
-00004e90: 673a 2064 6963 742c 206e 616d 653a 2073  g: dict, name: s
-00004ea0: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
-00004eb0: 2020 2020 2069 6620 6578 6368 616e 6765       if exchange
-00004ec0: 5f63 6f6e 6669 672e 6765 7428 2773 616e  _config.get('san
-00004ed0: 6462 6f78 2729 3a0a 2020 2020 2020 2020  dbox'):.        
-00004ee0: 2020 2020 6966 2061 7069 2e75 726c 732e      if api.urls.
-00004ef0: 6765 7428 2774 6573 7427 293a 0a20 2020  get('test'):.   
-00004f00: 2020 2020 2020 2020 2020 2020 2061 7069               api
-00004f10: 2e75 726c 735b 2761 7069 275d 203d 2061  .urls['api'] = a
-00004f20: 7069 2e75 726c 735b 2774 6573 7427 5d0a  pi.urls['test'].
-00004f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f40: 6c6f 6767 6572 2e69 6e66 6f28 2245 6e61  logger.info("Ena
-00004f50: 626c 6564 2053 616e 6462 6f78 2041 5049  bled Sandbox API
-00004f60: 206f 6e20 2573 222c 206e 616d 6529 0a20   on %s", name). 
-00004f70: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00004f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004f90: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-00004fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004fb0: 2020 2020 2066 224e 6f20 5361 6e64 626f       f"No Sandbo
-00004fc0: 7820 5552 4c20 696e 2043 4358 5420 666f  x URL in CCXT fo
-00004fd0: 7220 7b6e 616d 657d 2c20 6578 6974 696e  r {name}, exitin
-00004fe0: 672e 2050 6c65 6173 6520 6368 6563 6b20  g. Please check 
-00004ff0: 796f 7572 2063 6f6e 6669 672e 6a73 6f6e  your config.json
-00005000: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00005010: 2020 2072 6169 7365 204f 7065 7261 7469     raise Operati
-00005020: 6f6e 616c 4578 6365 7074 696f 6e28 6627  onalException(f'
-00005030: 4578 6368 616e 6765 207b 6e61 6d65 7d20  Exchange {name} 
-00005040: 646f 6573 206e 6f74 2070 726f 7669 6465  does not provide
-00005050: 2061 2073 616e 6462 6f78 2061 7069 2729   a sandbox api')
-00005060: 0a0a 2020 2020 6465 6620 5f6c 6f61 645f  ..    def _load_
-00005070: 6173 796e 635f 6d61 726b 6574 7328 7365  async_markets(se
-00005080: 6c66 2c20 7265 6c6f 6164 3a20 626f 6f6c  lf, reload: bool
-00005090: 203d 2046 616c 7365 2920 2d3e 204e 6f6e   = False) -> Non
-000050a0: 653a 0a20 2020 2020 2020 2074 7279 3a0a  e:.        try:.
-000050b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000050c0: 656c 662e 5f61 7069 5f61 7379 6e63 3a0a  elf._api_async:.
-000050d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000050e0: 7365 6c66 2e6c 6f6f 702e 7275 6e5f 756e  self.loop.run_un
-000050f0: 7469 6c5f 636f 6d70 6c65 7465 280a 2020  til_complete(.  
-00005100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005110: 2020 7365 6c66 2e5f 6170 695f 6173 796e    self._api_asyn
-00005120: 632e 6c6f 6164 5f6d 6172 6b65 7473 2872  c.load_markets(r
-00005130: 656c 6f61 643d 7265 6c6f 6164 2c20 7061  eload=reload, pa
-00005140: 7261 6d73 3d7b 7d29 290a 0a20 2020 2020  rams={}))..     
-00005150: 2020 2065 7863 6570 7420 2861 7379 6e63     except (async
-00005160: 696f 2e54 696d 656f 7574 4572 726f 722c  io.TimeoutError,
-00005170: 2063 6378 742e 4261 7365 4572 726f 7229   ccxt.BaseError)
-00005180: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00005190: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-000051a0: 6728 2743 6f75 6c64 206e 6f74 206c 6f61  g('Could not loa
-000051b0: 6420 6173 796e 6320 6d61 726b 6574 732e  d async markets.
-000051c0: 2052 6561 736f 6e3a 2025 7327 2c20 6529   Reason: %s', e)
-000051d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000051e0: 7572 6e0a 0a20 2020 2064 6566 205f 6c6f  urn..    def _lo
-000051f0: 6164 5f6d 6172 6b65 7473 2873 656c 6629  ad_markets(self)
-00005200: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00005210: 2020 2222 2220 496e 6974 6961 6c69 7a65    """ Initialize
-00005220: 206d 6172 6b65 7473 2062 6f74 6820 7379   markets both sy
-00005230: 6e63 2061 6e64 2061 7379 6e63 2022 2222  nc and async """
-00005240: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00005250: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00005260: 6d61 726b 6574 7320 3d20 7365 6c66 2e5f  markets = self._
-00005270: 6170 692e 6c6f 6164 5f6d 6172 6b65 7473  api.load_markets
-00005280: 2870 6172 616d 733d 7b7d 290a 2020 2020  (params={}).    
-00005290: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-000052a0: 6164 5f61 7379 6e63 5f6d 6172 6b65 7473  ad_async_markets
-000052b0: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
-000052c0: 656c 662e 5f6c 6173 745f 6d61 726b 6574  elf._last_market
-000052d0: 735f 7265 6672 6573 6820 3d20 6172 726f  s_refresh = arro
-000052e0: 772e 7574 636e 6f77 2829 2e69 6e74 5f74  w.utcnow().int_t
-000052f0: 696d 6573 7461 6d70 0a20 2020 2020 2020  imestamp.       
-00005300: 2020 2020 2069 6620 7365 6c66 2e5f 6674       if self._ft
-00005310: 5f68 6173 5b27 6e65 6564 735f 7472 6164  _has['needs_trad
-00005320: 696e 675f 6665 6573 275d 3a0a 2020 2020  ing_fees']:.    
-00005330: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005340: 2e5f 7472 6164 696e 675f 6665 6573 203d  ._trading_fees =
-00005350: 2073 656c 662e 6665 7463 685f 7472 6164   self.fetch_trad
-00005360: 696e 675f 6665 6573 2829 0a0a 2020 2020  ing_fees()..    
-00005370: 2020 2020 6578 6365 7074 2063 6378 742e      except ccxt.
-00005380: 4261 7365 4572 726f 723a 0a20 2020 2020  BaseError:.     
-00005390: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-000053a0: 6365 7074 696f 6e28 2755 6e61 626c 6520  ception('Unable 
-000053b0: 746f 2069 6e69 7469 616c 697a 6520 6d61  to initialize ma
-000053c0: 726b 6574 732e 2729 0a0a 2020 2020 6465  rkets.')..    de
-000053d0: 6620 7265 6c6f 6164 5f6d 6172 6b65 7473  f reload_markets
-000053e0: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
-000053f0: 2020 2020 2020 2020 2222 2252 656c 6f61          """Reloa
-00005400: 6420 6d61 726b 6574 7320 626f 7468 2073  d markets both s
-00005410: 796e 6320 616e 6420 6173 796e 6320 6966  ync and async if
-00005420: 2072 6566 7265 7368 2069 6e74 6572 7661   refresh interva
-00005430: 6c20 6861 7320 7061 7373 6564 2022 2222  l has passed """
-00005440: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-00005450: 2077 6865 7468 6572 206d 6172 6b65 7473   whether markets
-00005460: 2068 6176 6520 746f 2062 6520 7265 6c6f   have to be relo
-00005470: 6164 6564 0a20 2020 2020 2020 2069 6620  aded.        if 
-00005480: 2873 656c 662e 5f6c 6173 745f 6d61 726b  (self._last_mark
-00005490: 6574 735f 7265 6672 6573 6820 3e20 3029  ets_refresh > 0)
-000054a0: 2061 6e64 2028 0a20 2020 2020 2020 2020   and (.         
-000054b0: 2020 2020 2020 2073 656c 662e 5f6c 6173         self._las
-000054c0: 745f 6d61 726b 6574 735f 7265 6672 6573  t_markets_refres
-000054d0: 6820 2b20 7365 6c66 2e6d 6172 6b65 7473  h + self.markets
-000054e0: 5f72 6566 7265 7368 5f69 6e74 6572 7661  _refresh_interva
-000054f0: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-00005500: 2020 3e20 6172 726f 772e 7574 636e 6f77    > arrow.utcnow
-00005510: 2829 2e69 6e74 5f74 696d 6573 7461 6d70  ().int_timestamp
-00005520: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00005530: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
-00005540: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00005550: 2250 6572 666f 726d 696e 6720 7363 6865  "Performing sche
-00005560: 6475 6c65 6420 6d61 726b 6574 2072 656c  duled market rel
-00005570: 6f61 642e 2e22 290a 2020 2020 2020 2020  oad..").        
-00005580: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00005590: 2073 656c 662e 5f6d 6172 6b65 7473 203d   self._markets =
-000055a0: 2073 656c 662e 5f61 7069 2e6c 6f61 645f   self._api.load_
-000055b0: 6d61 726b 6574 7328 7265 6c6f 6164 3d54  markets(reload=T
-000055c0: 7275 652c 2070 6172 616d 733d 7b7d 290a  rue, params={}).
-000055d0: 2020 2020 2020 2020 2020 2020 2320 416c              # Al
-000055e0: 736f 2072 656c 6f61 6420 6173 796e 6320  so reload async 
-000055f0: 6d61 726b 6574 7320 746f 2061 766f 6964  markets to avoid
-00005600: 2069 7373 7565 7320 7769 7468 206e 6577   issues with new
-00005610: 6c79 206c 6973 7465 6420 7061 6972 730a  ly listed pairs.
-00005620: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005630: 2e5f 6c6f 6164 5f61 7379 6e63 5f6d 6172  ._load_async_mar
-00005640: 6b65 7473 2872 656c 6f61 643d 5472 7565  kets(reload=True
-00005650: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00005660: 6c66 2e5f 6c61 7374 5f6d 6172 6b65 7473  lf._last_markets
-00005670: 5f72 6566 7265 7368 203d 2061 7272 6f77  _refresh = arrow
-00005680: 2e75 7463 6e6f 7728 292e 696e 745f 7469  .utcnow().int_ti
-00005690: 6d65 7374 616d 700a 2020 2020 2020 2020  mestamp.        
-000056a0: 2020 2020 7365 6c66 2e66 696c 6c5f 6c65      self.fill_le
-000056b0: 7665 7261 6765 5f74 6965 7273 2829 0a20  verage_tiers(). 
-000056c0: 2020 2020 2020 2065 7863 6570 7420 6363         except cc
-000056d0: 7874 2e42 6173 6545 7272 6f72 3a0a 2020  xt.BaseError:.  
-000056e0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000056f0: 2e65 7863 6570 7469 6f6e 2822 436f 756c  .exception("Coul
-00005700: 6420 6e6f 7420 7265 6c6f 6164 206d 6172  d not reload mar
-00005710: 6b65 7473 2e22 290a 0a20 2020 2064 6566  kets.")..    def
-00005720: 2076 616c 6964 6174 655f 7374 616b 6563   validate_stakec
-00005730: 7572 7265 6e63 7928 7365 6c66 2c20 7374  urrency(self, st
-00005740: 616b 655f 6375 7272 656e 6379 3a20 7374  ake_currency: st
-00005750: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
-00005760: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00005770: 4368 6563 6b73 2073 7461 6b65 2d63 7572  Checks stake-cur
-00005780: 7265 6e63 7920 6167 6169 6e73 7420 6176  rency against av
-00005790: 6169 6c61 626c 6520 6375 7272 656e 6369  ailable currenci
-000057a0: 6573 206f 6e20 7468 6520 6578 6368 616e  es on the exchan
-000057b0: 6765 2e0a 2020 2020 2020 2020 4f6e 6c79  ge..        Only
-000057c0: 2072 756e 7320 6f6e 2073 7461 7274 7570   runs on startup
-000057d0: 2e20 4966 206d 6172 6b65 7473 2068 6176  . If markets hav
-000057e0: 6520 6e6f 7420 6265 656e 206c 6f61 6465  e not been loade
-000057f0: 642c 2074 6865 7265 2773 2062 6565 6e20  d, there's been 
-00005800: 6120 7072 6f62 6c65 6d20 7769 7468 0a20  a problem with. 
-00005810: 2020 2020 2020 2074 6865 2063 6f6e 6e65         the conne
-00005820: 6374 696f 6e20 746f 2074 6865 2065 7863  ction to the exc
-00005830: 6861 6e67 652e 0a20 2020 2020 2020 203a  hange..        :
-00005840: 7061 7261 6d20 7374 616b 655f 6375 7272  param stake_curr
-00005850: 656e 6379 3a20 5374 616b 652d 6375 7272  ency: Stake-curr
-00005860: 656e 6379 2074 6f20 7661 6c69 6461 7465  ency to validate
-00005870: 0a20 2020 2020 2020 203a 7261 6973 653a  .        :raise:
-00005880: 204f 7065 7261 7469 6f6e 616c 4578 6365   OperationalExce
-00005890: 7074 696f 6e20 6966 2073 7461 6b65 2d63  ption if stake-c
-000058a0: 7572 7265 6e63 7920 6973 206e 6f74 2061  urrency is not a
-000058b0: 7661 696c 6162 6c65 2e0a 2020 2020 2020  vailable..      
-000058c0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-000058d0: 206e 6f74 2073 656c 662e 5f6d 6172 6b65   not self._marke
-000058e0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-000058f0: 7261 6973 6520 4f70 6572 6174 696f 6e61  raise Operationa
-00005900: 6c45 7863 6570 7469 6f6e 280a 2020 2020  lException(.    
-00005910: 2020 2020 2020 2020 2020 2020 2743 6f75              'Cou
-00005920: 6c64 206e 6f74 206c 6f61 6420 6d61 726b  ld not load mark
-00005930: 6574 732c 2074 6865 7265 666f 7265 2063  ets, therefore c
-00005940: 616e 6e6f 7420 7374 6172 742e 2027 0a20  annot start. '. 
-00005950: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00005960: 506c 6561 7365 2069 6e76 6573 7469 6761  Please investiga
-00005970: 7465 2074 6865 2061 626f 7665 2065 7272  te the above err
-00005980: 6f72 2066 6f72 206d 6f72 6520 6465 7461  or for more deta
-00005990: 696c 732e 270a 2020 2020 2020 2020 2020  ils.'.          
-000059a0: 2020 290a 2020 2020 2020 2020 7175 6f74    ).        quot
-000059b0: 655f 6375 7272 656e 6369 6573 203d 2073  e_currencies = s
-000059c0: 656c 662e 6765 745f 7175 6f74 655f 6375  elf.get_quote_cu
-000059d0: 7272 656e 6369 6573 2829 0a20 2020 2020  rrencies().     
-000059e0: 2020 2069 6620 7374 616b 655f 6375 7272     if stake_curr
-000059f0: 656e 6379 206e 6f74 2069 6e20 7175 6f74  ency not in quot
-00005a00: 655f 6375 7272 656e 6369 6573 3a0a 2020  e_currencies:.  
-00005a10: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00005a20: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
-00005a30: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-00005a40: 2020 2020 2020 6622 7b73 7461 6b65 5f63        f"{stake_c
-00005a50: 7572 7265 6e63 797d 2069 7320 6e6f 7420  urrency} is not 
-00005a60: 6176 6169 6c61 626c 6520 6173 2073 7461  available as sta
-00005a70: 6b65 206f 6e20 7b73 656c 662e 6e61 6d65  ke on {self.name
-00005a80: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
-00005a90: 2020 2020 2066 2241 7661 696c 6162 6c65       f"Available
-00005aa0: 2063 7572 7265 6e63 6965 7320 6172 653a   currencies are:
-00005ab0: 207b 272c 2027 2e6a 6f69 6e28 7175 6f74   {', '.join(quot
-00005ac0: 655f 6375 7272 656e 6369 6573 297d 2229  e_currencies)}")
-00005ad0: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-00005ae0: 7465 5f70 6169 7273 2873 656c 662c 2070  te_pairs(self, p
-00005af0: 6169 7273 3a20 4c69 7374 5b73 7472 5d29  airs: List[str])
-00005b00: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00005b10: 2020 2222 220a 2020 2020 2020 2020 4368    """.        Ch
-00005b20: 6563 6b73 2069 6620 616c 6c20 6769 7665  ecks if all give
-00005b30: 6e20 7061 6972 7320 6172 6520 7472 6164  n pairs are trad
-00005b40: 6162 6c65 206f 6e20 7468 6520 6375 7272  able on the curr
-00005b50: 656e 7420 6578 6368 616e 6765 2e0a 2020  ent exchange..  
-00005b60: 2020 2020 2020 3a70 6172 616d 2070 6169        :param pai
-00005b70: 7273 3a20 6c69 7374 206f 6620 7061 6972  rs: list of pair
-00005b80: 730a 2020 2020 2020 2020 3a72 6169 7365  s.        :raise
-00005b90: 3a20 4f70 6572 6174 696f 6e61 6c45 7863  : OperationalExc
-00005ba0: 6570 7469 6f6e 2069 6620 6f6e 6520 7061  eption if one pa
-00005bb0: 6972 2069 7320 6e6f 7420 6176 6169 6c61  ir is not availa
-00005bc0: 626c 650a 2020 2020 2020 2020 3a72 6574  ble.        :ret
-00005bd0: 7572 6e3a 204e 6f6e 650a 2020 2020 2020  urn: None.      
-00005be0: 2020 2222 220a 0a20 2020 2020 2020 2069    """..        i
-00005bf0: 6620 6e6f 7420 7365 6c66 2e6d 6172 6b65  f not self.marke
-00005c00: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00005c10: 6c6f 6767 6572 2e77 6172 6e69 6e67 2827  logger.warning('
-00005c20: 556e 6162 6c65 2074 6f20 7661 6c69 6461  Unable to valida
-00005c30: 7465 2070 6169 7273 2028 6173 7375 6d69  te pairs (assumi
-00005c40: 6e67 2074 6865 7920 6172 6520 636f 7272  ng they are corr
-00005c50: 6563 7429 2e27 290a 2020 2020 2020 2020  ect).').        
-00005c60: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-00005c70: 2020 2065 7874 656e 6465 645f 7061 6972     extended_pair
-00005c80: 7320 3d20 6578 7061 6e64 5f70 6169 726c  s = expand_pairl
-00005c90: 6973 7428 7061 6972 732c 206c 6973 7428  ist(pairs, list(
-00005ca0: 7365 6c66 2e6d 6172 6b65 7473 292c 206b  self.markets), k
-00005cb0: 6565 705f 696e 7661 6c69 643d 5472 7565  eep_invalid=True
-00005cc0: 290a 2020 2020 2020 2020 696e 7661 6c69  ).        invali
-00005cd0: 645f 7061 6972 7320 3d20 5b5d 0a20 2020  d_pairs = [].   
-00005ce0: 2020 2020 2066 6f72 2070 6169 7220 696e       for pair in
-00005cf0: 2065 7874 656e 6465 645f 7061 6972 733a   extended_pairs:
-00005d00: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-00005d10: 6f74 653a 2063 6378 7420 6861 7320 4261  ote: ccxt has Ba
-00005d20: 7365 4375 7272 656e 6379 2f51 756f 7465  seCurrency/Quote
-00005d30: 4375 7272 656e 6379 2066 6f72 6d61 7420  Currency format 
-00005d40: 666f 7220 7061 6972 730a 2020 2020 2020  for pairs.      
-00005d50: 2020 2020 2020 6966 2073 656c 662e 6d61        if self.ma
-00005d60: 726b 6574 7320 616e 6420 7061 6972 206e  rkets and pair n
-00005d70: 6f74 2069 6e20 7365 6c66 2e6d 6172 6b65  ot in self.marke
-00005d80: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00005d90: 2020 2020 7261 6973 6520 4f70 6572 6174      raise Operat
-00005da0: 696f 6e61 6c45 7863 6570 7469 6f6e 280a  ionalException(.
-00005db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005dc0: 2020 2020 6627 5061 6972 207b 7061 6972      f'Pair {pair
-00005dd0: 7d20 6973 206e 6f74 2061 7661 696c 6162  } is not availab
-00005de0: 6c65 206f 6e20 7b73 656c 662e 6e61 6d65  le on {self.name
-00005df0: 7d20 7b73 656c 662e 7472 6164 696e 675f  } {self.trading_
-00005e00: 6d6f 6465 2e76 616c 7565 7d2e 2027 0a20  mode.value}. '. 
-00005e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e20: 2020 2066 2750 6c65 6173 6520 7265 6d6f     f'Please remo
-00005e30: 7665 207b 7061 6972 7d20 6672 6f6d 2079  ve {pair} from y
-00005e40: 6f75 7220 7768 6974 656c 6973 742e 2729  our whitelist.')
-00005e50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00005e60: 2020 2320 4672 6f6d 2063 6378 7420 446f    # From ccxt Do
-00005e70: 6375 6d65 6e74 6174 696f 6e3a 0a20 2020  cumentation:.   
-00005e80: 2020 2020 2020 2020 2020 2020 2023 206d               # m
-00005e90: 6172 6b65 7473 2e69 6e66 6f3a 2041 6e20  arkets.info: An 
-00005ea0: 6173 736f 6369 6174 6976 6520 6172 7261  associative arra
-00005eb0: 7920 6f66 206e 6f6e 2d63 6f6d 6d6f 6e20  y of non-common 
-00005ec0: 6d61 726b 6574 2070 726f 7065 7274 6965  market propertie
-00005ed0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00005ee0: 2020 2023 2069 6e63 6c75 6469 6e67 2066     # including f
-00005ef0: 6565 732c 2072 6174 6573 2c20 6c69 6d69  ees, rates, limi
-00005f00: 7473 2061 6e64 206f 7468 6572 2067 656e  ts and other gen
-00005f10: 6572 616c 206d 6172 6b65 7420 696e 666f  eral market info
-00005f20: 726d 6174 696f 6e2e 0a20 2020 2020 2020  rmation..       
-00005f30: 2020 2020 2020 2020 2023 2054 6865 2069           # The i
-00005f40: 6e74 6572 6e61 6c20 696e 666f 2061 7272  nternal info arr
-00005f50: 6179 2069 7320 6469 6666 6572 656e 7420  ay is different 
-00005f60: 666f 7220 6561 6368 2070 6172 7469 6375  for each particu
-00005f70: 6c61 7220 6d61 726b 6574 2c0a 2020 2020  lar market,.    
-00005f80: 2020 2020 2020 2020 2020 2020 2320 6974              # it
-00005f90: 7320 636f 6e74 656e 7473 2064 6570 656e  s contents depen
-00005fa0: 6420 6f6e 2074 6865 2065 7863 6861 6e67  d on the exchang
-00005fb0: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
-00005fc0: 2020 2023 2049 7420 6361 6e20 616c 736f     # It can also
-00005fd0: 2062 6520 6120 7374 7269 6e67 206f 7220   be a string or 
-00005fe0: 7369 6d69 6c61 7220 2e2e 2e20 736f 2077  similar ... so w
-00005ff0: 6520 6e65 6564 2074 6f20 7665 7269 6679  e need to verify
-00006000: 2074 6861 7420 6669 7273 742e 0a20 2020   that first..   
-00006010: 2020 2020 2020 2020 2065 6c69 6620 2869           elif (i
-00006020: 7369 6e73 7461 6e63 6528 7365 6c66 2e6d  sinstance(self.m
-00006030: 6172 6b65 7473 5b70 6169 725d 2e67 6574  arkets[pair].get
-00006040: 2827 696e 666f 2729 2c20 6469 6374 290a  ('info'), dict).
-00006050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006060: 2020 616e 6420 7365 6c66 2e6d 6172 6b65    and self.marke
-00006070: 7473 5b70 6169 725d 2e67 6574 2827 696e  ts[pair].get('in
-00006080: 666f 272c 207b 7d29 2e67 6574 2827 7072  fo', {}).get('pr
-00006090: 6f68 6962 6974 6564 496e 272c 2046 616c  ohibitedIn', Fal
-000060a0: 7365 2929 3a0a 2020 2020 2020 2020 2020  se)):.          
-000060b0: 2020 2020 2020 2320 5761 726e 2075 7365        # Warn use
-000060c0: 7273 2061 626f 7574 2072 6573 7472 6963  rs about restric
-000060d0: 7465 6420 7061 6972 7320 696e 2077 6869  ted pairs in whi
-000060e0: 7465 6c69 7374 2e0a 2020 2020 2020 2020  telist..        
-000060f0: 2020 2020 2020 2020 2320 5765 2063 616e          # We can
-00006100: 6e6f 7420 6465 7465 726d 696e 6520 7265  not determine re
-00006110: 6c69 6162 6c79 2069 6620 5573 6572 7320  liably if Users 
-00006120: 6172 6520 6166 6665 6374 6564 2e0a 2020  are affected..  
-00006130: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00006140: 6767 6572 2e77 6172 6e69 6e67 2866 2250  gger.warning(f"P
-00006150: 6169 7220 7b70 6169 727d 2069 7320 7265  air {pair} is re
-00006160: 7374 7269 6374 6564 2066 6f72 2073 6f6d  stricted for som
-00006170: 6520 7573 6572 7320 6f6e 2074 6869 7320  e users on this 
-00006180: 6578 6368 616e 6765 2e22 0a20 2020 2020  exchange.".     
-00006190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061a0: 2020 2020 2020 2020 2020 6622 506c 6561            f"Plea
-000061b0: 7365 2063 6865 636b 2069 6620 796f 7520  se check if you 
-000061c0: 6172 6520 696d 7061 6374 6564 2062 7920  are impacted by 
-000061d0: 7468 6973 2072 6573 7472 6963 7469 6f6e  this restriction
-000061e0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-000061f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006200: 2020 6622 6f6e 2074 6865 2065 7863 6861    f"on the excha
-00006210: 6e67 6520 616e 6420 6576 656e 7475 616c  nge and eventual
-00006220: 6c79 2072 656d 6f76 6520 7b70 6169 727d  ly remove {pair}
-00006230: 2066 726f 6d20 796f 7572 2077 6869 7465   from your white
-00006240: 6c69 7374 2e22 290a 2020 2020 2020 2020  list.").        
-00006250: 2020 2020 6966 2028 7365 6c66 2e5f 636f      if (self._co
-00006260: 6e66 6967 5b27 7374 616b 655f 6375 7272  nfig['stake_curr
-00006270: 656e 6379 275d 2061 6e64 0a20 2020 2020  ency'] and.     
-00006280: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00006290: 656c 662e 6765 745f 7061 6972 5f71 756f  elf.get_pair_quo
-000062a0: 7465 5f63 7572 7265 6e63 7928 7061 6972  te_currency(pair
-000062b0: 2920 213d 2073 656c 662e 5f63 6f6e 6669  ) != self._confi
-000062c0: 675b 2773 7461 6b65 5f63 7572 7265 6e63  g['stake_currenc
-000062d0: 7927 5d29 3a0a 2020 2020 2020 2020 2020  y']):.          
-000062e0: 2020 2020 2020 696e 7661 6c69 645f 7061        invalid_pa
-000062f0: 6972 732e 6170 7065 6e64 2870 6169 7229  irs.append(pair)
-00006300: 0a20 2020 2020 2020 2069 6620 696e 7661  .        if inva
-00006310: 6c69 645f 7061 6972 733a 0a20 2020 2020  lid_pairs:.     
-00006320: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
-00006330: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
-00006340: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00006350: 2020 2066 2253 7461 6b65 2d63 7572 7265     f"Stake-curre
-00006360: 6e63 7920 277b 7365 6c66 2e5f 636f 6e66  ncy '{self._conf
-00006370: 6967 5b27 7374 616b 655f 6375 7272 656e  ig['stake_curren
-00006380: 6379 275d 7d27 206e 6f74 2063 6f6d 7061  cy']}' not compa
-00006390: 7469 626c 6520 7769 7468 2022 0a20 2020  tible with ".   
-000063a0: 2020 2020 2020 2020 2020 2020 2066 2270               f"p
-000063b0: 6169 722d 7768 6974 656c 6973 742e 2050  air-whitelist. P
-000063c0: 6c65 6173 6520 7265 6d6f 7665 2074 6865  lease remove the
-000063d0: 2066 6f6c 6c6f 7769 6e67 2070 6169 7273   following pairs
-000063e0: 3a20 7b69 6e76 616c 6964 5f70 6169 7273  : {invalid_pairs
-000063f0: 7d22 290a 0a20 2020 2064 6566 2067 6574  }")..    def get
-00006400: 5f76 616c 6964 5f70 6169 725f 636f 6d62  _valid_pair_comb
-00006410: 696e 6174 696f 6e28 7365 6c66 2c20 6375  ination(self, cu
-00006420: 7272 5f31 3a20 7374 722c 2063 7572 725f  rr_1: str, curr_
-00006430: 323a 2073 7472 2920 2d3e 2073 7472 3a0a  2: str) -> str:.
-00006440: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00006450: 2020 2020 4765 7420 7661 6c69 6420 7061      Get valid pa
-00006460: 6972 2063 6f6d 6269 6e61 7469 6f6e 206f  ir combination o
-00006470: 6620 6375 7272 5f31 2061 6e64 2063 7572  f curr_1 and cur
-00006480: 725f 3220 6279 2074 7279 696e 6720 626f  r_2 by trying bo
-00006490: 7468 2063 6f6d 6269 6e61 7469 6f6e 732e  th combinations.
-000064a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000064b0: 2020 2020 2066 6f72 2070 6169 7220 696e       for pair in
-000064c0: 205b 6622 7b63 7572 725f 317d 2f7b 6375   [f"{curr_1}/{cu
-000064d0: 7272 5f32 7d22 2c20 6622 7b63 7572 725f  rr_2}", f"{curr_
-000064e0: 327d 2f7b 6375 7272 5f31 7d22 5d3a 0a20  2}/{curr_1}"]:. 
-000064f0: 2020 2020 2020 2020 2020 2069 6620 7061             if pa
-00006500: 6972 2069 6e20 7365 6c66 2e6d 6172 6b65  ir in self.marke
-00006510: 7473 2061 6e64 2073 656c 662e 6d61 726b  ts and self.mark
-00006520: 6574 735b 7061 6972 5d2e 6765 7428 2761  ets[pair].get('a
-00006530: 6374 6976 6527 293a 0a20 2020 2020 2020  ctive'):.       
-00006540: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00006550: 7061 6972 0a20 2020 2020 2020 2072 6169  pair.        rai
-00006560: 7365 2045 7863 6861 6e67 6545 7272 6f72  se ExchangeError
-00006570: 2866 2243 6f75 6c64 206e 6f74 2063 6f6d  (f"Could not com
-00006580: 6269 6e65 207b 6375 7272 5f31 7d20 616e  bine {curr_1} an
-00006590: 6420 7b63 7572 725f 327d 2074 6f20 6765  d {curr_2} to ge
-000065a0: 7420 6120 7661 6c69 6420 7061 6972 2e22  t a valid pair."
-000065b0: 290a 0a20 2020 2064 6566 2076 616c 6964  )..    def valid
-000065c0: 6174 655f 7469 6d65 6672 616d 6573 2873  ate_timeframes(s
-000065d0: 656c 662c 2074 696d 6566 7261 6d65 3a20  elf, timeframe: 
-000065e0: 4f70 7469 6f6e 616c 5b73 7472 5d29 202d  Optional[str]) -
-000065f0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00006600: 2222 220a 2020 2020 2020 2020 4368 6563  """.        Chec
-00006610: 6b20 6966 2074 696d 6566 7261 6d65 2066  k if timeframe f
-00006620: 726f 6d20 636f 6e66 6967 2069 7320 6120  rom config is a 
-00006630: 7375 7070 6f72 7465 6420 7469 6d65 6672  supported timefr
-00006640: 616d 6520 6f6e 2074 6865 2065 7863 6861  ame on the excha
-00006650: 6e67 650a 2020 2020 2020 2020 2222 220a  nge.        """.
-00006660: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
-00006670: 6173 6174 7472 2873 656c 662e 5f61 7069  asattr(self._api
-00006680: 2c20 2274 696d 6566 7261 6d65 7322 2920  , "timeframes") 
-00006690: 6f72 2073 656c 662e 5f61 7069 2e74 696d  or self._api.tim
-000066a0: 6566 7261 6d65 7320 6973 204e 6f6e 653a  eframes is None:
-000066b0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-000066c0: 6620 7469 6d65 6672 616d 6573 2061 7474  f timeframes att
-000066d0: 7269 6275 7465 2069 7320 6d69 7373 696e  ribute is missin
-000066e0: 6720 286f 7220 6973 204e 6f6e 6529 2c20  g (or is None), 
-000066f0: 7468 6520 6578 6368 616e 6765 2070 726f  the exchange pro
-00006700: 6261 626c 790a 2020 2020 2020 2020 2020  bably.          
-00006710: 2020 2320 6861 7320 6e6f 2066 6574 6368    # has no fetch
-00006720: 4f48 4c43 5620 6d65 7468 6f64 2e0a 2020  OHLCV method..  
-00006730: 2020 2020 2020 2020 2020 2320 5468 6572            # Ther
-00006740: 6566 6f72 6520 7765 2061 6c73 6f20 7368  efore we also sh
-00006750: 6f77 2074 6861 742e 0a20 2020 2020 2020  ow that..       
-00006760: 2020 2020 2072 6169 7365 204f 7065 7261       raise Opera
-00006770: 7469 6f6e 616c 4578 6365 7074 696f 6e28  tionalException(
-00006780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006790: 2066 2254 6865 2063 6378 7420 6c69 6272   f"The ccxt libr
-000067a0: 6172 7920 646f 6573 206e 6f74 2070 726f  ary does not pro
-000067b0: 7669 6465 2074 6865 206c 6973 7420 6f66  vide the list of
-000067c0: 2074 696d 6566 7261 6d65 7320 220a 2020   timeframes ".  
-000067d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000067e0: 666f 7220 7468 6520 6578 6368 616e 6765  for the exchange
-000067f0: 207b 7365 6c66 2e6e 616d 657d 2061 6e64   {self.name} and
-00006800: 2074 6869 7320 6578 6368 616e 6765 2022   this exchange "
-00006810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006820: 2066 2269 7320 7468 6572 6566 6f72 6520   f"is therefore 
-00006830: 6e6f 7420 7375 7070 6f72 7465 642e 2063  not supported. c
-00006840: 6378 7420 6665 7463 684f 484c 4356 3a20  cxt fetchOHLCV: 
-00006850: 7b73 656c 662e 6578 6368 616e 6765 5f68  {self.exchange_h
-00006860: 6173 2827 6665 7463 684f 484c 4356 2729  as('fetchOHLCV')
-00006870: 7d22 290a 0a20 2020 2020 2020 2069 6620  }")..        if 
-00006880: 7469 6d65 6672 616d 6520 616e 6420 2874  timeframe and (t
-00006890: 696d 6566 7261 6d65 206e 6f74 2069 6e20  imeframe not in 
-000068a0: 7365 6c66 2e74 696d 6566 7261 6d65 7329  self.timeframes)
-000068b0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-000068c0: 6973 6520 4f70 6572 6174 696f 6e61 6c45  ise OperationalE
-000068d0: 7863 6570 7469 6f6e 280a 2020 2020 2020  xception(.      
-000068e0: 2020 2020 2020 2020 2020 6622 496e 7661            f"Inva
-000068f0: 6c69 6420 7469 6d65 6672 616d 6520 277b  lid timeframe '{
-00006900: 7469 6d65 6672 616d 657d 272e 2054 6869  timeframe}'. Thi
-00006910: 7320 6578 6368 616e 6765 2073 7570 706f  s exchange suppo
-00006920: 7274 733a 207b 7365 6c66 2e74 696d 6566  rts: {self.timef
-00006930: 7261 6d65 737d 2229 0a0a 2020 2020 2020  rames}")..      
-00006940: 2020 6966 2074 696d 6566 7261 6d65 2061    if timeframe a
-00006950: 6e64 2074 696d 6566 7261 6d65 5f74 6f5f  nd timeframe_to_
-00006960: 6d69 6e75 7465 7328 7469 6d65 6672 616d  minutes(timefram
-00006970: 6529 203c 2031 3a0a 2020 2020 2020 2020  e) < 1:.        
-00006980: 2020 2020 7261 6973 6520 4f70 6572 6174      raise Operat
-00006990: 696f 6e61 6c45 7863 6570 7469 6f6e 2822  ionalException("
-000069a0: 5469 6d65 6672 616d 6573 203c 2031 6d20  Timeframes < 1m 
-000069b0: 6172 6520 6375 7272 656e 746c 7920 6e6f  are currently no
-000069c0: 7420 7375 7070 6f72 7465 6420 6279 2046  t supported by F
-000069d0: 7265 7174 7261 6465 2e22 290a 0a20 2020  reqtrade.")..   
-000069e0: 2064 6566 2076 616c 6964 6174 655f 6f72   def validate_or
-000069f0: 6465 7274 7970 6573 2873 656c 662c 206f  dertypes(self, o
-00006a00: 7264 6572 5f74 7970 6573 3a20 4469 6374  rder_types: Dict
-00006a10: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00006a20: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
-00006a30: 6865 636b 7320 6966 206f 7264 6572 2d74  hecks if order-t
-00006a40: 7970 6573 2063 6f6e 6669 6775 7265 6420  ypes configured 
-00006a50: 696e 2073 7472 6174 6567 792f 636f 6e66  in strategy/conf
-00006a60: 6967 2061 7265 2073 7570 706f 7274 6564  ig are supported
-00006a70: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00006a80: 2020 2020 2069 6620 616e 7928 7620 3d3d       if any(v ==
-00006a90: 2027 6d61 726b 6574 2720 666f 7220 6b2c   'market' for k,
-00006aa0: 2076 2069 6e20 6f72 6465 725f 7479 7065   v in order_type
-00006ab0: 732e 6974 656d 7328 2929 3a0a 2020 2020  s.items()):.    
-00006ac0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00006ad0: 656c 662e 6578 6368 616e 6765 5f68 6173  elf.exchange_has
-00006ae0: 2827 6372 6561 7465 4d61 726b 6574 4f72  ('createMarketOr
-00006af0: 6465 7227 293a 0a20 2020 2020 2020 2020  der'):.         
-00006b00: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
-00006b10: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
-00006b20: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-00006b30: 2020 2020 2020 2066 2745 7863 6861 6e67         f'Exchang
-00006b40: 6520 7b73 656c 662e 6e61 6d65 7d20 646f  e {self.name} do
-00006b50: 6573 206e 6f74 2073 7570 706f 7274 206d  es not support m
-00006b60: 6172 6b65 7420 6f72 6465 7273 2e27 290a  arket orders.').
-00006b70: 2020 2020 2020 2020 7365 6c66 2e76 616c          self.val
-00006b80: 6964 6174 655f 7374 6f70 5f6f 7264 6572  idate_stop_order
-00006b90: 7479 7065 7328 6f72 6465 725f 7479 7065  types(order_type
-00006ba0: 7329 0a0a 2020 2020 6465 6620 7661 6c69  s)..    def vali
-00006bb0: 6461 7465 5f73 746f 705f 6f72 6465 7274  date_stop_ordert
-00006bc0: 7970 6573 2873 656c 662c 206f 7264 6572  ypes(self, order
-00006bd0: 5f74 7970 6573 3a20 4469 6374 2920 2d3e  _types: Dict) ->
-00006be0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00006bf0: 2222 0a20 2020 2020 2020 2056 616c 6964  "".        Valid
-00006c00: 6174 6520 7374 6f70 6c6f 7373 206f 7264  ate stoploss ord
-00006c10: 6572 2074 7970 6573 0a20 2020 2020 2020  er types.       
-00006c20: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-00006c30: 286f 7264 6572 5f74 7970 6573 2e67 6574  (order_types.get
-00006c40: 2822 7374 6f70 6c6f 7373 5f6f 6e5f 6578  ("stoploss_on_ex
-00006c50: 6368 616e 6765 2229 0a20 2020 2020 2020  change").       
-00006c60: 2020 2020 2020 2020 2061 6e64 206e 6f74           and not
-00006c70: 2073 656c 662e 5f66 745f 6861 732e 6765   self._ft_has.ge
-00006c80: 7428 2273 746f 706c 6f73 735f 6f6e 5f65  t("stoploss_on_e
-00006c90: 7863 6861 6e67 6522 2c20 4661 6c73 6529  xchange", False)
-00006ca0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00006cb0: 6169 7365 204f 7065 7261 7469 6f6e 616c  aise Operational
-00006cc0: 4578 6365 7074 696f 6e28 0a20 2020 2020  Exception(.     
-00006cd0: 2020 2020 2020 2020 2020 2066 274f 6e20             f'On 
-00006ce0: 6578 6368 616e 6765 2073 746f 706c 6f73  exchange stoplos
-00006cf0: 7320 6973 206e 6f74 2073 7570 706f 7274  s is not support
-00006d00: 6564 2066 6f72 207b 7365 6c66 2e6e 616d  ed for {self.nam
-00006d10: 657d 2e27 0a20 2020 2020 2020 2020 2020  e}.'.           
-00006d20: 2029 0a20 2020 2020 2020 2069 6620 7365   ).        if se
-00006d30: 6c66 2e74 7261 6469 6e67 5f6d 6f64 6520  lf.trading_mode 
-00006d40: 3d3d 2054 7261 6469 6e67 4d6f 6465 2e46  == TradingMode.F
-00006d50: 5554 5552 4553 3a0a 2020 2020 2020 2020  UTURES:.        
-00006d60: 2020 2020 7072 6963 655f 6d61 7070 696e      price_mappin
-00006d70: 6720 3d20 7365 6c66 2e5f 6674 5f68 6173  g = self._ft_has
-00006d80: 2e67 6574 2827 7374 6f70 5f70 7269 6365  .get('stop_price
-00006d90: 5f74 7970 655f 7661 6c75 655f 6d61 7070  _type_value_mapp
-00006da0: 696e 6727 2c20 7b7d 292e 6b65 7973 2829  ing', {}).keys()
-00006db0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00006dc0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00006dd0: 2020 6f72 6465 725f 7479 7065 732e 6765    order_types.ge
-00006de0: 7428 2273 746f 706c 6f73 735f 6f6e 5f65  t("stoploss_on_e
-00006df0: 7863 6861 6e67 6522 2c20 4661 6c73 6529  xchange", False)
-00006e00: 2069 7320 5472 7565 0a20 2020 2020 2020   is True.       
-00006e10: 2020 2020 2020 2020 2061 6e64 2027 7374           and 'st
-00006e20: 6f70 6c6f 7373 5f70 7269 6365 5f74 7970  oploss_price_typ
-00006e30: 6527 2069 6e20 6f72 6465 725f 7479 7065  e' in order_type
-00006e40: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00006e50: 2020 616e 6420 6f72 6465 725f 7479 7065    and order_type
-00006e60: 735b 2773 746f 706c 6f73 735f 7072 6963  s['stoploss_pric
-00006e70: 655f 7479 7065 275d 206e 6f74 2069 6e20  e_type'] not in 
-00006e80: 7072 6963 655f 6d61 7070 696e 670a 2020  price_mapping.  
-00006e90: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
-00006ea0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00006eb0: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
-00006ec0: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
-00006ed0: 2020 2020 2020 2020 2020 2020 2066 274f               f'O
-00006ee0: 6e20 6578 6368 616e 6765 2073 746f 706c  n exchange stopl
-00006ef0: 6f73 7320 7072 6963 6520 7479 7065 2069  oss price type i
-00006f00: 7320 6e6f 7420 7375 7070 6f72 7465 6420  s not supported 
-00006f10: 666f 7220 7b73 656c 662e 6e61 6d65 7d2e  for {self.name}.
-00006f20: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00006f30: 2020 290a 0a20 2020 2064 6566 2076 616c    )..    def val
-00006f40: 6964 6174 655f 7072 6963 696e 6728 7365  idate_pricing(se
-00006f50: 6c66 2c20 7072 6963 696e 673a 2044 6963  lf, pricing: Dic
-00006f60: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-00006f70: 2020 2020 6966 2070 7269 6369 6e67 2e67      if pricing.g
-00006f80: 6574 2827 7573 655f 6f72 6465 725f 626f  et('use_order_bo
-00006f90: 6f6b 272c 2046 616c 7365 2920 616e 6420  ok', False) and 
-00006fa0: 6e6f 7420 7365 6c66 2e65 7863 6861 6e67  not self.exchang
-00006fb0: 655f 6861 7328 2766 6574 6368 4c32 4f72  e_has('fetchL2Or
-00006fc0: 6465 7242 6f6f 6b27 293a 0a20 2020 2020  derBook'):.     
-00006fd0: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
-00006fe0: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
-00006ff0: 6e28 6627 4f72 6465 7262 6f6f 6b20 6e6f  n(f'Orderbook no
-00007000: 7420 6176 6169 6c61 626c 6520 666f 7220  t available for 
-00007010: 7b73 656c 662e 6e61 6d65 7d2e 2729 0a20  {self.name}.'). 
-00007020: 2020 2020 2020 2069 6620 286e 6f74 2070         if (not p
-00007030: 7269 6369 6e67 2e67 6574 2827 7573 655f  ricing.get('use_
-00007040: 6f72 6465 725f 626f 6f6b 272c 2046 616c  order_book', Fal
-00007050: 7365 2920 616e 6420 280a 2020 2020 2020  se) and (.      
-00007060: 2020 2020 2020 2020 2020 6e6f 7420 7365            not se
-00007070: 6c66 2e65 7863 6861 6e67 655f 6861 7328  lf.exchange_has(
-00007080: 2766 6574 6368 5469 636b 6572 2729 0a20  'fetchTicker'). 
-00007090: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000070a0: 7220 6e6f 7420 7365 6c66 2e5f 6674 5f68  r not self._ft_h
-000070b0: 6173 5b27 7469 636b 6572 735f 6861 7665  as['tickers_have
-000070c0: 5f70 7269 6365 275d 2929 3a0a 2020 2020  _price'])):.    
-000070d0: 2020 2020 2020 2020 7261 6973 6520 4f70          raise Op
-000070e0: 6572 6174 696f 6e61 6c45 7863 6570 7469  erationalExcepti
-000070f0: 6f6e 2866 2754 6963 6b65 7220 7072 6963  on(f'Ticker pric
-00007100: 696e 6720 6e6f 7420 6176 6169 6c61 626c  ing not availabl
-00007110: 6520 666f 7220 7b73 656c 662e 6e61 6d65  e for {self.name
-00007120: 7d2e 2729 0a0a 2020 2020 6465 6620 7661  }.')..    def va
-00007130: 6c69 6461 7465 5f6f 7264 6572 5f74 696d  lidate_order_tim
-00007140: 655f 696e 5f66 6f72 6365 2873 656c 662c  e_in_force(self,
-00007150: 206f 7264 6572 5f74 696d 655f 696e 5f66   order_time_in_f
-00007160: 6f72 6365 3a20 4469 6374 2920 2d3e 204e  orce: Dict) -> N
-00007170: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00007180: 0a20 2020 2020 2020 2043 6865 636b 7320  .        Checks 
-00007190: 6966 206f 7264 6572 2074 696d 6520 696e  if order time in
-000071a0: 2066 6f72 6365 2063 6f6e 6669 6775 7265   force configure
-000071b0: 6420 696e 2073 7472 6174 6567 792f 636f  d in strategy/co
-000071c0: 6e66 6967 2061 7265 2073 7570 706f 7274  nfig are support
-000071d0: 6564 0a20 2020 2020 2020 2022 2222 0a20  ed.        """. 
-000071e0: 2020 2020 2020 2069 6620 616e 7928 762e         if any(v.
-000071f0: 7570 7065 7228 2920 6e6f 7420 696e 2073  upper() not in s
-00007200: 656c 662e 5f66 745f 6861 735b 226f 7264  elf._ft_has["ord
-00007210: 6572 5f74 696d 655f 696e 5f66 6f72 6365  er_time_in_force
-00007220: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-00007230: 2020 666f 7220 6b2c 2076 2069 6e20 6f72    for k, v in or
-00007240: 6465 725f 7469 6d65 5f69 6e5f 666f 7263  der_time_in_forc
-00007250: 652e 6974 656d 7328 2929 3a0a 2020 2020  e.items()):.    
-00007260: 2020 2020 2020 2020 7261 6973 6520 4f70          raise Op
-00007270: 6572 6174 696f 6e61 6c45 7863 6570 7469  erationalExcepti
-00007280: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-00007290: 2020 2020 6627 5469 6d65 2069 6e20 666f      f'Time in fo
-000072a0: 7263 6520 706f 6c69 6369 6573 2061 7265  rce policies are
-000072b0: 206e 6f74 2073 7570 706f 7274 6564 2066   not supported f
-000072c0: 6f72 207b 7365 6c66 2e6e 616d 657d 2079  or {self.name} y
-000072d0: 6574 2e27 290a 0a20 2020 2064 6566 2076  et.')..    def v
-000072e0: 616c 6964 6174 655f 7265 7175 6972 6564  alidate_required
-000072f0: 5f73 7461 7274 7570 5f63 616e 646c 6573  _startup_candles
-00007300: 2873 656c 662c 2073 7461 7274 7570 5f63  (self, startup_c
-00007310: 616e 646c 6573 3a20 696e 742c 2074 696d  andles: int, tim
-00007320: 6566 7261 6d65 3a20 7374 7229 202d 3e20  eframe: str) -> 
-00007330: 696e 743a 0a20 2020 2020 2020 2022 2222  int:.        """
-00007340: 0a20 2020 2020 2020 2043 6865 636b 7320  .        Checks 
-00007350: 6966 2072 6571 7569 7265 6420 7374 6172  if required star
-00007360: 7475 705f 6361 6e64 6c65 7320 6973 206d  tup_candles is m
-00007370: 6f72 6520 7468 616e 206f 686c 6376 5f63  ore than ohlcv_c
-00007380: 616e 646c 655f 6c69 6d69 7428 292e 0a20  andle_limit().. 
-00007390: 2020 2020 2020 2052 6571 7569 7265 7320         Requires 
-000073a0: 6120 6772 6163 652d 7065 7269 6f64 206f  a grace-period o
-000073b0: 6620 3520 6361 6e64 6c65 7320 2d20 736f  f 5 candles - so
-000073c0: 2061 2073 7461 7274 7570 2d70 6572 696f   a startup-perio
-000073d0: 6420 7570 2074 6f20 3439 3420 6973 2061  d up to 494 is a
-000073e0: 6c6c 6f77 6564 2062 7920 6465 6661 756c  llowed by defaul
-000073f0: 742e 0a20 2020 2020 2020 2022 2222 0a0a  t..        """..
-00007400: 2020 2020 2020 2020 6361 6e64 6c65 5f6c          candle_l
-00007410: 696d 6974 203d 2073 656c 662e 6f68 6c63  imit = self.ohlc
-00007420: 765f 6361 6e64 6c65 5f6c 696d 6974 280a  v_candle_limit(.
-00007430: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-00007440: 6672 616d 652c 2073 656c 662e 5f63 6f6e  frame, self._con
-00007450: 6669 675b 2763 616e 646c 655f 7479 7065  fig['candle_type
-00007460: 5f64 6566 275d 2c0a 2020 2020 2020 2020  _def'],.        
-00007470: 2020 2020 696e 7428 6461 7465 5f6d 696e      int(date_min
-00007480: 7573 5f63 616e 646c 6573 2874 696d 6566  us_candles(timef
-00007490: 7261 6d65 2c20 7374 6172 7475 705f 6361  rame, startup_ca
-000074a0: 6e64 6c65 7329 2e74 696d 6573 7461 6d70  ndles).timestamp
-000074b0: 2829 202a 2031 3030 3029 0a20 2020 2020  () * 1000).     
-000074c0: 2020 2020 2020 2069 6620 7469 6d65 6672         if timefr
-000074d0: 616d 6520 656c 7365 204e 6f6e 6529 0a20  ame else None). 
-000074e0: 2020 2020 2020 2023 2052 6571 7569 7265         # Require
-000074f0: 206f 6e65 206d 6f72 6520 6361 6e64 6c65   one more candle
-00007500: 202d 2074 6f20 6163 636f 756e 7420 666f   - to account fo
-00007510: 7220 7468 6520 7374 696c 6c20 6f70 656e  r the still open
-00007520: 2063 616e 646c 652e 0a20 2020 2020 2020   candle..       
-00007530: 2063 616e 646c 655f 636f 756e 7420 3d20   candle_count = 
-00007540: 7374 6172 7475 705f 6361 6e64 6c65 7320  startup_candles 
-00007550: 2b20 310a 2020 2020 2020 2020 2320 416c  + 1.        # Al
-00007560: 6c6f 7720 3520 6361 6c6c 7320 746f 2074  low 5 calls to t
-00007570: 6865 2065 7863 6861 6e67 6520 7065 7220  he exchange per 
-00007580: 7061 6972 0a20 2020 2020 2020 2072 6571  pair.        req
-00007590: 7569 7265 645f 6361 6e64 6c65 5f63 616c  uired_candle_cal
-000075a0: 6c5f 636f 756e 7420 3d20 696e 7428 0a20  l_count = int(. 
-000075b0: 2020 2020 2020 2020 2020 2028 6361 6e64             (cand
-000075c0: 6c65 5f63 6f75 6e74 202f 2063 616e 646c  le_count / candl
-000075d0: 655f 6c69 6d69 7429 202b 2028 3020 6966  e_limit) + (0 if
-000075e0: 2063 616e 646c 655f 636f 756e 7420 2520   candle_count % 
-000075f0: 6361 6e64 6c65 5f6c 696d 6974 203d 3d20  candle_limit == 
-00007600: 3020 656c 7365 2031 2929 0a20 2020 2020  0 else 1)).     
-00007610: 2020 2069 6620 7365 6c66 2e5f 6674 5f68     if self._ft_h
-00007620: 6173 5b27 6f68 6c63 765f 6861 735f 6869  as['ohlcv_has_hi
-00007630: 7374 6f72 7927 5d3a 0a0a 2020 2020 2020  story']:..      
-00007640: 2020 2020 2020 6966 2072 6571 7569 7265        if require
-00007650: 645f 6361 6e64 6c65 5f63 616c 6c5f 636f  d_candle_call_co
-00007660: 756e 7420 3e20 353a 0a20 2020 2020 2020  unt > 5:.       
-00007670: 2020 2020 2020 2020 2023 204f 6e6c 7920           # Only 
-00007680: 616c 6c6f 7720 3520 6361 6c6c 7320 7065  allow 5 calls pe
-00007690: 7220 7061 6972 2074 6f20 736f 6d65 7768  r pair to somewh
-000076a0: 6174 206c 696d 6974 2074 6865 2069 6d70  at limit the imp
-000076b0: 6163 740a 2020 2020 2020 2020 2020 2020  act.            
-000076c0: 2020 2020 7261 6973 6520 4f70 6572 6174      raise Operat
-000076d0: 696f 6e61 6c45 7863 6570 7469 6f6e 280a  ionalException(.
-000076e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076f0: 2020 2020 6622 5468 6973 2073 7472 6174      f"This strat
-00007700: 6567 7920 7265 7175 6972 6573 207b 7374  egy requires {st
-00007710: 6172 7475 705f 6361 6e64 6c65 737d 2063  artup_candles} c
-00007720: 616e 646c 6573 2074 6f20 7374 6172 742c  andles to start,
-00007730: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00007740: 2020 2020 2020 2022 7768 6963 6820 6973         "which is
-00007750: 206d 6f72 6520 7468 616e 2035 7820 220a   more than 5x ".
-00007760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007770: 2020 2020 6622 7468 6520 616d 6f75 6e74      f"the amount
-00007780: 206f 6620 6361 6e64 6c65 7320 7b73 656c   of candles {sel
-00007790: 662e 6e61 6d65 7d20 7072 6f76 6964 6573  f.name} provides
-000077a0: 2066 6f72 207b 7469 6d65 6672 616d 657d   for {timeframe}
-000077b0: 2e22 290a 2020 2020 2020 2020 656c 6966  .").        elif
-000077c0: 2072 6571 7569 7265 645f 6361 6e64 6c65   required_candle
-000077d0: 5f63 616c 6c5f 636f 756e 7420 3e20 313a  _call_count > 1:
-000077e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-000077f0: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
-00007800: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
-00007810: 2020 2020 2020 2020 2066 2254 6869 7320           f"This 
-00007820: 7374 7261 7465 6779 2072 6571 7569 7265  strategy require
-00007830: 7320 7b73 7461 7274 7570 5f63 616e 646c  s {startup_candl
-00007840: 6573 7d20 6361 6e64 6c65 7320 746f 2073  es} candles to s
-00007850: 7461 7274 2c20 7768 6963 6820 6973 206d  tart, which is m
-00007860: 6f72 6520 7468 616e 2022 0a20 2020 2020  ore than ".     
-00007870: 2020 2020 2020 2020 2020 2066 2274 6865             f"the
-00007880: 2061 6d6f 756e 7420 6f66 2063 616e 646c   amount of candl
-00007890: 6573 207b 7365 6c66 2e6e 616d 657d 2070  es {self.name} p
-000078a0: 726f 7669 6465 7320 666f 7220 7b74 696d  rovides for {tim
-000078b0: 6566 7261 6d65 7d2e 2229 0a20 2020 2020  eframe}.").     
-000078c0: 2020 2069 6620 7265 7175 6972 6564 5f63     if required_c
-000078d0: 616e 646c 655f 6361 6c6c 5f63 6f75 6e74  andle_call_count
-000078e0: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
-000078f0: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-00007900: 2866 2255 7369 6e67 207b 7265 7175 6972  (f"Using {requir
-00007910: 6564 5f63 616e 646c 655f 6361 6c6c 5f63  ed_candle_call_c
-00007920: 6f75 6e74 7d20 6361 6c6c 7320 746f 2067  ount} calls to g
-00007930: 6574 204f 484c 4356 2e20 220a 2020 2020  et OHLCV. ".    
-00007940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007950: 2020 2020 2020 2066 2254 6869 7320 6361         f"This ca
-00007960: 6e20 7265 7375 6c74 2069 6e20 736c 6f77  n result in slow
-00007970: 6572 206f 7065 7261 7469 6f6e 7320 666f  er operations fo
-00007980: 7220 7468 6520 626f 742e 2050 6c65 6173  r the bot. Pleas
-00007990: 6520 6368 6563 6b20 220a 2020 2020 2020  e check ".      
-000079a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079b0: 2020 2020 2066 2269 6620 796f 7520 7265       f"if you re
-000079c0: 616c 6c79 206e 6565 6420 7b73 7461 7274  ally need {start
-000079d0: 7570 5f63 616e 646c 6573 7d20 6361 6e64  up_candles} cand
-000079e0: 6c65 7320 666f 7220 796f 7572 2073 7472  les for your str
-000079f0: 6174 6567 7922 290a 2020 2020 2020 2020  ategy").        
-00007a00: 7265 7475 726e 2072 6571 7569 7265 645f  return required_
-00007a10: 6361 6e64 6c65 5f63 616c 6c5f 636f 756e  candle_call_coun
-00007a20: 740a 0a20 2020 2064 6566 2076 616c 6964  t..    def valid
-00007a30: 6174 655f 7472 6164 696e 675f 6d6f 6465  ate_trading_mode
-00007a40: 5f61 6e64 5f6d 6172 6769 6e5f 6d6f 6465  _and_margin_mode
-00007a50: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00007a60: 2020 2020 2020 2020 7472 6164 696e 675f          trading_
-00007a70: 6d6f 6465 3a20 5472 6164 696e 674d 6f64  mode: TradingMod
-00007a80: 652c 0a20 2020 2020 2020 206d 6172 6769  e,.        margi
-00007a90: 6e5f 6d6f 6465 3a20 4f70 7469 6f6e 616c  n_mode: Optional
-00007aa0: 5b4d 6172 6769 6e4d 6f64 655d 2020 2320  [MarginMode]  # 
-00007ab0: 4f6e 6c79 204e 6f6e 6520 7768 656e 2074  Only None when t
-00007ac0: 7261 6469 6e67 5f6d 6f64 6520 3d20 5472  rading_mode = Tr
-00007ad0: 6164 696e 674d 6f64 652e 5350 4f54 0a20  adingMode.SPOT. 
-00007ae0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-00007af0: 220a 2020 2020 2020 2020 4368 6563 6b73  ".        Checks
-00007b00: 2069 6620 6672 6571 7472 6164 6520 6361   if freqtrade ca
-00007b10: 6e20 7065 7266 6f72 6d20 7472 6164 6573  n perform trades
-00007b20: 2075 7369 6e67 2074 6865 2063 6f6e 6669   using the confi
-00007b30: 6775 7265 640a 2020 2020 2020 2020 7472  gured.        tr
-00007b40: 6164 696e 6720 6d6f 6465 284d 6172 6769  ading mode(Margi
-00007b50: 6e2c 2046 7574 7572 6573 2920 616e 6420  n, Futures) and 
-00007b60: 4d61 7267 696e 4d6f 6465 2843 726f 7373  MarginMode(Cross
-00007b70: 2c20 4973 6f6c 6174 6564 290a 2020 2020  , Isolated).    
-00007b80: 2020 2020 5468 726f 7773 204f 7065 7261      Throws Opera
-00007b90: 7469 6f6e 616c 4578 6365 7074 696f 6e3a  tionalException:
-00007ba0: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
-00007bb0: 7468 6520 7472 6164 696e 675f 6d6f 6465  the trading_mode
-00007bc0: 2f6d 6172 6769 6e5f 6d6f 6465 2074 7970  /margin_mode typ
-00007bd0: 6520 6172 6520 6e6f 7420 7375 7070 6f72  e are not suppor
-00007be0: 7465 6420 6279 2066 7265 7174 7261 6465  ted by freqtrade
-00007bf0: 206f 6e20 7468 6973 2065 7863 6861 6e67   on this exchang
-00007c00: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-00007c10: 2020 2020 2020 6966 2074 7261 6469 6e67        if trading
-00007c20: 5f6d 6f64 6520 213d 2054 7261 6469 6e67  _mode != Trading
-00007c30: 4d6f 6465 2e53 504f 5420 616e 6420 280a  Mode.SPOT and (.
-00007c40: 2020 2020 2020 2020 2020 2020 2874 7261              (tra
-00007c50: 6469 6e67 5f6d 6f64 652c 206d 6172 6769  ding_mode, margi
-00007c60: 6e5f 6d6f 6465 2920 6e6f 7420 696e 2073  n_mode) not in s
-00007c70: 656c 662e 5f73 7570 706f 7274 6564 5f74  elf._supported_t
-00007c80: 7261 6469 6e67 5f6d 6f64 655f 6d61 7267  rading_mode_marg
-00007c90: 696e 5f70 6169 7273 0a20 2020 2020 2020  in_pairs.       
-00007ca0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00007cb0: 6d6d 5f76 616c 7565 203d 206d 6172 6769  mm_value = margi
-00007cc0: 6e5f 6d6f 6465 2061 6e64 206d 6172 6769  n_mode and margi
-00007cd0: 6e5f 6d6f 6465 2e76 616c 7565 0a20 2020  n_mode.value.   
-00007ce0: 2020 2020 2020 2020 2072 6169 7365 204f           raise O
-00007cf0: 7065 7261 7469 6f6e 616c 4578 6365 7074  perationalExcept
-00007d00: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-00007d10: 2020 2020 2066 2246 7265 7174 7261 6465       f"Freqtrade
-00007d20: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00007d30: 7420 7b6d 6d5f 7661 6c75 657d 207b 7472  t {mm_value} {tr
-00007d40: 6164 696e 675f 6d6f 6465 2e76 616c 7565  ading_mode.value
-00007d50: 7d20 6f6e 207b 7365 6c66 2e6e 616d 657d  } on {self.name}
-00007d60: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00007d70: 0a20 2020 2064 6566 2067 6574 5f6f 7074  .    def get_opt
-00007d80: 696f 6e28 7365 6c66 2c20 7061 7261 6d3a  ion(self, param:
-00007d90: 2073 7472 2c20 6465 6661 756c 743a 204f   str, default: O
-00007da0: 7074 696f 6e61 6c5b 416e 795d 203d 204e  ptional[Any] = N
-00007db0: 6f6e 6529 202d 3e20 416e 793a 0a20 2020  one) -> Any:.   
-00007dc0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00007dd0: 2047 6574 2070 6172 616d 6574 6572 2076   Get parameter v
-00007de0: 616c 7565 2066 726f 6d20 5f66 745f 6861  alue from _ft_ha
-00007df0: 730a 2020 2020 2020 2020 2222 220a 2020  s.        """.  
-00007e00: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00007e10: 662e 5f66 745f 6861 732e 6765 7428 7061  f._ft_has.get(pa
-00007e20: 7261 6d2c 2064 6566 6175 6c74 290a 0a20  ram, default).. 
-00007e30: 2020 2064 6566 2065 7863 6861 6e67 655f     def exchange_
-00007e40: 6861 7328 7365 6c66 2c20 656e 6470 6f69  has(self, endpoi
-00007e50: 6e74 3a20 7374 7229 202d 3e20 626f 6f6c  nt: str) -> bool
-00007e60: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00007e70: 2020 2020 2020 4368 6563 6b73 2069 6620        Checks if 
-00007e80: 6578 6368 616e 6765 2069 6d70 6c65 6d65  exchange impleme
-00007e90: 6e74 7320 6120 7370 6563 6966 6963 2041  nts a specific A
-00007ea0: 5049 2065 6e64 706f 696e 742e 0a20 2020  PI endpoint..   
-00007eb0: 2020 2020 2057 7261 7070 6572 2061 726f       Wrapper aro
-00007ec0: 756e 6420 6363 7874 2027 6861 7327 2061  und ccxt 'has' a
-00007ed0: 7474 7269 6275 7465 0a20 2020 2020 2020  ttribute.       
-00007ee0: 203a 7061 7261 6d20 656e 6470 6f69 6e74   :param endpoint
-00007ef0: 3a20 4e61 6d65 206f 6620 656e 6470 6f69  : Name of endpoi
-00007f00: 6e74 2028 652e 672e 2027 6665 7463 684f  nt (e.g. 'fetchO
-00007f10: 484c 4356 272c 2027 6665 7463 6854 6963  HLCV', 'fetchTic
-00007f20: 6b65 7273 2729 0a20 2020 2020 2020 203a  kers').        :
-00007f30: 7265 7475 726e 3a20 626f 6f6c 0a20 2020  return: bool.   
-00007f40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00007f50: 2072 6574 7572 6e20 656e 6470 6f69 6e74   return endpoint
-00007f60: 2069 6e20 7365 6c66 2e5f 6170 692e 6861   in self._api.ha
-00007f70: 7320 616e 6420 7365 6c66 2e5f 6170 692e  s and self._api.
-00007f80: 6861 735b 656e 6470 6f69 6e74 5d0a 0a20  has[endpoint].. 
-00007f90: 2020 2064 6566 2067 6574 5f70 7265 6369     def get_preci
-00007fa0: 7369 6f6e 5f61 6d6f 756e 7428 7365 6c66  sion_amount(self
-00007fb0: 2c20 7061 6972 3a20 7374 7229 202d 3e20  , pair: str) -> 
-00007fc0: 4f70 7469 6f6e 616c 5b66 6c6f 6174 5d3a  Optional[float]:
-00007fd0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00007fe0: 2020 2020 2052 6574 7572 6e73 2074 6865       Returns the
-00007ff0: 2061 6d6f 756e 7420 7072 6563 6973 696f   amount precisio
-00008000: 6e20 6f66 2074 6865 2065 7863 6861 6e67  n of the exchang
-00008010: 652e 0a20 2020 2020 2020 203a 7061 7261  e..        :para
-00008020: 6d20 7061 6972 3a20 5061 6972 2074 6f20  m pair: Pair to 
-00008030: 6765 7420 7072 6563 6973 696f 6e20 666f  get precision fo
-00008040: 720a 2020 2020 2020 2020 3a72 6574 7572  r.        :retur
-00008050: 6e3a 2070 7265 6369 7369 6f6e 2066 6f72  n: precision for
-00008060: 2061 6d6f 756e 7420 6f72 204e 6f6e 652e   amount or None.
-00008070: 204d 7573 7420 6265 2075 7365 6420 696e   Must be used in
-00008080: 2063 6f6d 6269 6e61 7469 6f6e 2077 6974   combination wit
-00008090: 6820 7072 6563 6973 696f 6e4d 6f64 650a  h precisionMode.
-000080a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000080b0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000080c0: 6d61 726b 6574 732e 6765 7428 7061 6972  markets.get(pair
-000080d0: 2c20 7b7d 292e 6765 7428 2770 7265 6369  , {}).get('preci
-000080e0: 7369 6f6e 272c 207b 7d29 2e67 6574 2827  sion', {}).get('
-000080f0: 616d 6f75 6e74 272c 204e 6f6e 6529 0a0a  amount', None)..
-00008100: 2020 2020 6465 6620 6765 745f 7072 6563      def get_prec
-00008110: 6973 696f 6e5f 7072 6963 6528 7365 6c66  ision_price(self
-00008120: 2c20 7061 6972 3a20 7374 7229 202d 3e20  , pair: str) -> 
-00008130: 4f70 7469 6f6e 616c 5b66 6c6f 6174 5d3a  Optional[float]:
-00008140: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00008150: 2020 2020 2052 6574 7572 6e73 2074 6865       Returns the
-00008160: 2070 7269 6365 2070 7265 6369 7369 6f6e   price precision
-00008170: 206f 6620 7468 6520 6578 6368 616e 6765   of the exchange
-00008180: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00008190: 2070 6169 723a 2050 6169 7220 746f 2067   pair: Pair to g
-000081a0: 6574 2070 7265 6369 7369 6f6e 2066 6f72  et precision for
-000081b0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-000081c0: 3a20 7072 6563 6973 696f 6e20 666f 7220  : precision for 
-000081d0: 7072 6963 6520 6f72 204e 6f6e 652e 204d  price or None. M
-000081e0: 7573 7420 6265 2075 7365 6420 696e 2063  ust be used in c
-000081f0: 6f6d 6269 6e61 7469 6f6e 2077 6974 6820  ombination with 
-00008200: 7072 6563 6973 696f 6e4d 6f64 650a 2020  precisionMode.  
-00008210: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00008220: 2020 7265 7475 726e 2073 656c 662e 6d61    return self.ma
-00008230: 726b 6574 732e 6765 7428 7061 6972 2c20  rkets.get(pair, 
-00008240: 7b7d 292e 6765 7428 2770 7265 6369 7369  {}).get('precisi
-00008250: 6f6e 272c 207b 7d29 2e67 6574 2827 7072  on', {}).get('pr
-00008260: 6963 6527 2c20 4e6f 6e65 290a 0a20 2020  ice', None)..   
-00008270: 2064 6566 2061 6d6f 756e 745f 746f 5f70   def amount_to_p
-00008280: 7265 6369 7369 6f6e 2873 656c 662c 2070  recision(self, p
-00008290: 6169 723a 2073 7472 2c20 616d 6f75 6e74  air: str, amount
-000082a0: 3a20 666c 6f61 7429 202d 3e20 666c 6f61  : float) -> floa
-000082b0: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
-000082c0: 2020 2020 2020 2052 6574 7572 6e73 2074         Returns t
-000082d0: 6865 2061 6d6f 756e 7420 746f 2062 7579  he amount to buy
-000082e0: 206f 7220 7365 6c6c 2074 6f20 6120 7072   or sell to a pr
-000082f0: 6563 6973 696f 6e20 7468 6520 4578 6368  ecision the Exch
-00008300: 616e 6765 2061 6363 6570 7473 0a0a 2020  ange accepts..  
-00008310: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00008320: 2020 7265 7475 726e 2061 6d6f 756e 745f    return amount_
-00008330: 746f 5f70 7265 6369 7369 6f6e 2861 6d6f  to_precision(amo
-00008340: 756e 742c 2073 656c 662e 6765 745f 7072  unt, self.get_pr
-00008350: 6563 6973 696f 6e5f 616d 6f75 6e74 2870  ecision_amount(p
-00008360: 6169 7229 2c20 7365 6c66 2e70 7265 6369  air), self.preci
-00008370: 7369 6f6e 4d6f 6465 290a 0a20 2020 2064  sionMode)..    d
-00008380: 6566 2070 7269 6365 5f74 6f5f 7072 6563  ef price_to_prec
-00008390: 6973 696f 6e28 7365 6c66 2c20 7061 6972  ision(self, pair
-000083a0: 3a20 7374 722c 2070 7269 6365 3a20 666c  : str, price: fl
-000083b0: 6f61 742c 202a 2c20 726f 756e 6469 6e67  oat, *, rounding
-000083c0: 5f6d 6f64 653a 2069 6e74 203d 2052 4f55  _mode: int = ROU
-000083d0: 4e44 2920 2d3e 2066 6c6f 6174 3a0a 2020  ND) -> float:.  
-000083e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000083f0: 2020 5265 7475 726e 7320 7468 6520 7072    Returns the pr
-00008400: 6963 6520 726f 756e 6465 6420 746f 2074  ice rounded to t
-00008410: 6865 2070 7265 6369 7369 6f6e 2074 6865  he precision the
-00008420: 2045 7863 6861 6e67 6520 6163 6365 7074   Exchange accept
-00008430: 732e 0a20 2020 2020 2020 2054 6865 2064  s..        The d
-00008440: 6566 6175 6c74 2070 7269 6365 5f72 6f75  efault price_rou
-00008450: 6e64 696e 675f 6d6f 6465 2069 6e20 636f  nding_mode in co
-00008460: 6e66 2069 7320 524f 554e 442e 0a20 2020  nf is ROUND..   
-00008470: 2020 2020 2046 6f72 2073 746f 706c 6f73       For stoplos
-00008480: 7320 6361 6c63 756c 6174 696f 6e73 2c20  s calculations, 
-00008490: 6d75 7374 2075 7365 2052 4f55 4e44 5f55  must use ROUND_U
-000084a0: 5020 666f 7220 6c6f 6e67 732c 2061 6e64  P for longs, and
-000084b0: 2052 4f55 4e44 5f44 4f57 4e20 666f 7220   ROUND_DOWN for 
-000084c0: 7368 6f72 7473 2e0a 2020 2020 2020 2020  shorts..        
-000084d0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-000084e0: 726e 2070 7269 6365 5f74 6f5f 7072 6563  rn price_to_prec
-000084f0: 6973 696f 6e28 7072 6963 652c 2073 656c  ision(price, sel
-00008500: 662e 6765 745f 7072 6563 6973 696f 6e5f  f.get_precision_
-00008510: 7072 6963 6528 7061 6972 292c 0a20 2020  price(pair),.   
-00008520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008530: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00008540: 656c 662e 7072 6563 6973 696f 6e4d 6f64  elf.precisionMod
-00008550: 652c 2072 6f75 6e64 696e 675f 6d6f 6465  e, rounding_mode
-00008560: 3d72 6f75 6e64 696e 675f 6d6f 6465 290a  =rounding_mode).
-00008570: 0a20 2020 2064 6566 2070 7269 6365 5f67  .    def price_g
-00008580: 6574 5f6f 6e65 5f70 6970 2873 656c 662c  et_one_pip(self,
-00008590: 2070 6169 723a 2073 7472 2c20 7072 6963   pair: str, pric
-000085a0: 653a 2066 6c6f 6174 2920 2d3e 2066 6c6f  e: float) -> flo
-000085b0: 6174 3a0a 2020 2020 2020 2020 2222 220a  at:.        """.
-000085c0: 2020 2020 2020 2020 4765 7427 7320 7468          Get's th
-000085d0: 6520 2231 2070 6970 2220 7661 6c75 6520  e "1 pip" value 
-000085e0: 666f 7220 7468 6973 2070 6169 722e 0a20  for this pair.. 
-000085f0: 2020 2020 2020 2055 7365 6420 696e 2050         Used in P
-00008600: 7269 6365 4669 6c74 6572 2074 6f20 6361  riceFilter to ca
-00008610: 6c63 756c 6174 6520 7468 6520 3170 6970  lculate the 1pip
-00008620: 206d 6f76 656d 656e 7473 2e0a 2020 2020   movements..    
-00008630: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00008640: 7072 6563 6973 696f 6e20 3d20 7365 6c66  precision = self
-00008650: 2e6d 6172 6b65 7473 5b70 6169 725d 5b27  .markets[pair]['
-00008660: 7072 6563 6973 696f 6e27 5d5b 2770 7269  precision']['pri
-00008670: 6365 275d 0a20 2020 2020 2020 2069 6620  ce'].        if 
-00008680: 7365 6c66 2e70 7265 6369 7369 6f6e 4d6f  self.precisionMo
-00008690: 6465 203d 3d20 5449 434b 5f53 495a 453a  de == TICK_SIZE:
-000086a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000086b0: 7572 6e20 7072 6563 6973 696f 6e0a 2020  urn precision.  
-000086c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000086d0: 2020 2020 2020 2020 7265 7475 726e 2031          return 1
-000086e0: 202f 2070 6f77 2831 302c 2070 7265 6369   / pow(10, preci
-000086f0: 7369 6f6e 290a 0a20 2020 2064 6566 2067  sion)..    def g
-00008700: 6574 5f6d 696e 5f70 6169 725f 7374 616b  et_min_pair_stak
-00008710: 655f 616d 6f75 6e74 280a 2020 2020 2020  e_amount(.      
-00008720: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00008730: 7061 6972 3a20 7374 722c 0a20 2020 2020  pair: str,.     
-00008740: 2020 2070 7269 6365 3a20 666c 6f61 742c     price: float,
-00008750: 0a20 2020 2020 2020 2073 746f 706c 6f73  .        stoplos
-00008760: 733a 2066 6c6f 6174 2c0a 2020 2020 2020  s: float,.      
-00008770: 2020 6c65 7665 7261 6765 3a20 4f70 7469    leverage: Opti
-00008780: 6f6e 616c 5b66 6c6f 6174 5d20 3d20 312e  onal[float] = 1.
-00008790: 300a 2020 2020 2920 2d3e 204f 7074 696f  0.    ) -> Optio
-000087a0: 6e61 6c5b 666c 6f61 745d 3a0a 2020 2020  nal[float]:.    
-000087b0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000087c0: 5f67 6574 5f73 7461 6b65 5f61 6d6f 756e  _get_stake_amoun
-000087d0: 745f 6c69 6d69 7428 7061 6972 2c20 7072  t_limit(pair, pr
-000087e0: 6963 652c 2073 746f 706c 6f73 732c 2027  ice, stoploss, '
-000087f0: 6d69 6e27 2c20 6c65 7665 7261 6765 290a  min', leverage).
-00008800: 0a20 2020 2064 6566 2067 6574 5f6d 6178  .    def get_max
-00008810: 5f70 6169 725f 7374 616b 655f 616d 6f75  _pair_stake_amou
-00008820: 6e74 2873 656c 662c 2070 6169 723a 2073  nt(self, pair: s
-00008830: 7472 2c20 7072 6963 653a 2066 6c6f 6174  tr, price: float
-00008840: 2c20 6c65 7665 7261 6765 3a20 666c 6f61  , leverage: floa
-00008850: 7420 3d20 312e 3029 202d 3e20 666c 6f61  t = 1.0) -> floa
-00008860: 743a 0a20 2020 2020 2020 206d 6178 5f73  t:.        max_s
-00008870: 7461 6b65 5f61 6d6f 756e 7420 3d20 7365  take_amount = se
-00008880: 6c66 2e5f 6765 745f 7374 616b 655f 616d  lf._get_stake_am
-00008890: 6f75 6e74 5f6c 696d 6974 2870 6169 722c  ount_limit(pair,
-000088a0: 2070 7269 6365 2c20 302e 302c 2027 6d61   price, 0.0, 'ma
-000088b0: 7827 2c20 6c65 7665 7261 6765 290a 2020  x', leverage).  
-000088c0: 2020 2020 2020 6966 206d 6178 5f73 7461        if max_sta
-000088d0: 6b65 5f61 6d6f 756e 7420 6973 204e 6f6e  ke_amount is Non
-000088e0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-000088f0: 202a 2053 686f 756c 6420 6e65 7665 7220   * Should never 
-00008900: 6265 2065 7865 6375 7465 640a 2020 2020  be executed.    
-00008910: 2020 2020 2020 2020 7261 6973 6520 4f70          raise Op
-00008920: 6572 6174 696f 6e61 6c45 7863 6570 7469  erationalExcepti
-00008930: 6f6e 2866 277b 7365 6c66 2e6e 616d 657d  on(f'{self.name}
-00008940: 2e67 6574 5f6d 6178 5f70 6169 725f 7374  .get_max_pair_st
-00008950: 616b 655f 616d 6f75 6e74 2073 686f 756c  ake_amount shoul
-00008960: 6427 0a20 2020 2020 2020 2020 2020 2020  d'.             
-00008970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008980: 2020 2020 2020 2020 2020 276e 6576 6572            'never
-00008990: 2073 6574 206d 6178 5f73 7461 6b65 5f61   set max_stake_a
-000089a0: 6d6f 756e 7420 746f 204e 6f6e 6527 290a  mount to None').
-000089b0: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-000089c0: 6178 5f73 7461 6b65 5f61 6d6f 756e 740a  ax_stake_amount.
-000089d0: 0a20 2020 2064 6566 205f 6765 745f 7374  .    def _get_st
-000089e0: 616b 655f 616d 6f75 6e74 5f6c 696d 6974  ake_amount_limit
-000089f0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00008a00: 2020 2020 2020 2020 7061 6972 3a20 7374          pair: st
-00008a10: 722c 0a20 2020 2020 2020 2070 7269 6365  r,.        price
-00008a20: 3a20 666c 6f61 742c 0a20 2020 2020 2020  : float,.       
-00008a30: 2073 746f 706c 6f73 733a 2066 6c6f 6174   stoploss: float
-00008a40: 2c0a 2020 2020 2020 2020 6c69 6d69 743a  ,.        limit:
-00008a50: 204c 6974 6572 616c 5b27 6d69 6e27 2c20   Literal['min', 
-00008a60: 276d 6178 275d 2c0a 2020 2020 2020 2020  'max'],.        
-00008a70: 6c65 7665 7261 6765 3a20 4f70 7469 6f6e  leverage: Option
-00008a80: 616c 5b66 6c6f 6174 5d20 3d20 312e 300a  al[float] = 1.0.
-00008a90: 2020 2020 2920 2d3e 204f 7074 696f 6e61      ) -> Optiona
-00008aa0: 6c5b 666c 6f61 745d 3a0a 0a20 2020 2020  l[float]:..     
-00008ab0: 2020 2069 734d 696e 203d 206c 696d 6974     isMin = limit
-00008ac0: 203d 3d20 276d 696e 270a 0a20 2020 2020   == 'min'..     
-00008ad0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00008ae0: 2020 2020 6d61 726b 6574 203d 2073 656c      market = sel
-00008af0: 662e 6d61 726b 6574 735b 7061 6972 5d0a  f.markets[pair].
-00008b00: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00008b10: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00008b20: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00008b30: 4572 726f 7228 6622 4361 6e27 7420 6765  Error(f"Can't ge
-00008b40: 7420 6d61 726b 6574 2069 6e66 6f72 6d61  t market informa
-00008b50: 7469 6f6e 2066 6f72 2073 796d 626f 6c20  tion for symbol 
-00008b60: 7b70 6169 727d 2229 0a0a 2020 2020 2020  {pair}")..      
-00008b70: 2020 6966 2069 734d 696e 3a0a 2020 2020    if isMin:.    
-00008b80: 2020 2020 2020 2020 2320 7265 7365 7276          # reserv
-00008b90: 6520 736f 6d65 2070 6572 6365 6e74 2064  e some percent d
-00008ba0: 6566 696e 6564 2069 6e20 636f 6e66 6967  efined in config
-00008bb0: 2028 3525 2064 6566 6175 6c74 2920 2b20   (5% default) + 
-00008bc0: 7374 6f70 6c6f 7373 0a20 2020 2020 2020  stoploss.       
-00008bd0: 2020 2020 206d 6172 6769 6e5f 7265 7365       margin_rese
-00008be0: 7276 653a 2066 6c6f 6174 203d 2031 2e30  rve: float = 1.0
-00008bf0: 202b 2073 656c 662e 5f63 6f6e 6669 672e   + self._config.
-00008c00: 6765 7428 2761 6d6f 756e 745f 7265 7365  get('amount_rese
-00008c10: 7276 655f 7065 7263 656e 7427 2c0a 2020  rve_percent',.  
-00008c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c50: 2020 2020 2020 2020 2044 4546 4155 4c54           DEFAULT
-00008c60: 5f41 4d4f 554e 545f 5245 5345 5256 455f  _AMOUNT_RESERVE_
-00008c70: 5045 5243 454e 5429 0a20 2020 2020 2020  PERCENT).       
-00008c80: 2020 2020 2073 746f 706c 6f73 735f 7265       stoploss_re
-00008c90: 7365 7276 6520 3d20 280a 2020 2020 2020  serve = (.      
-00008ca0: 2020 2020 2020 2020 2020 6d61 7267 696e            margin
-00008cb0: 5f72 6573 6572 7665 202f 2028 3120 2d20  _reserve / (1 - 
-00008cc0: 6162 7328 7374 6f70 6c6f 7373 2929 2069  abs(stoploss)) i
-00008cd0: 6620 6162 7328 7374 6f70 6c6f 7373 2920  f abs(stoploss) 
-00008ce0: 213d 2031 2065 6c73 6520 312e 350a 2020  != 1 else 1.5.  
-00008cf0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00008d00: 2020 2020 2020 2020 2320 6974 2073 686f          # it sho
-00008d10: 756c 6420 6e6f 7420 6265 206d 6f72 6520  uld not be more 
-00008d20: 7468 616e 2035 3025 0a20 2020 2020 2020  than 50%.       
-00008d30: 2020 2020 2073 746f 706c 6f73 735f 7265       stoploss_re
-00008d40: 7365 7276 6520 3d20 6d61 7828 6d69 6e28  serve = max(min(
-00008d50: 7374 6f70 6c6f 7373 5f72 6573 6572 7665  stoploss_reserve
-00008d60: 2c20 312e 3529 2c20 3129 0a20 2020 2020  , 1.5), 1).     
-00008d70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00008d80: 2020 2020 206d 6172 6769 6e5f 7265 7365       margin_rese
-00008d90: 7276 6520 3d20 312e 300a 2020 2020 2020  rve = 1.0.      
-00008da0: 2020 2020 2020 7374 6f70 6c6f 7373 5f72        stoploss_r
-00008db0: 6573 6572 7665 203d 2031 2e30 0a0a 2020  eserve = 1.0..  
-00008dc0: 2020 2020 2020 7374 616b 655f 6c69 6d69        stake_limi
-00008dd0: 7473 203d 205b 5d0a 2020 2020 2020 2020  ts = [].        
-00008de0: 6c69 6d69 7473 203d 206d 6172 6b65 745b  limits = market[
-00008df0: 276c 696d 6974 7327 5d0a 2020 2020 2020  'limits'].      
-00008e00: 2020 6966 2028 6c69 6d69 7473 5b27 636f    if (limits['co
-00008e10: 7374 275d 5b6c 696d 6974 5d20 6973 206e  st'][limit] is n
-00008e20: 6f74 204e 6f6e 6529 3a0a 2020 2020 2020  ot None):.      
-00008e30: 2020 2020 2020 7374 616b 655f 6c69 6d69        stake_limi
-00008e40: 7473 2e61 7070 656e 6428 0a20 2020 2020  ts.append(.     
-00008e50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00008e60: 5f63 6f6e 7472 6163 7473 5f74 6f5f 616d  _contracts_to_am
-00008e70: 6f75 6e74 2870 6169 722c 206c 696d 6974  ount(pair, limit
-00008e80: 735b 2763 6f73 7427 5d5b 6c69 6d69 745d  s['cost'][limit]
-00008e90: 2920 2a20 7374 6f70 6c6f 7373 5f72 6573  ) * stoploss_res
-00008ea0: 6572 7665 0a20 2020 2020 2020 2020 2020  erve.           
-00008eb0: 2029 0a0a 2020 2020 2020 2020 6966 2028   )..        if (
-00008ec0: 6c69 6d69 7473 5b27 616d 6f75 6e74 275d  limits['amount']
-00008ed0: 5b6c 696d 6974 5d20 6973 206e 6f74 204e  [limit] is not N
-00008ee0: 6f6e 6529 3a0a 2020 2020 2020 2020 2020  one):.          
-00008ef0: 2020 7374 616b 655f 6c69 6d69 7473 2e61    stake_limits.a
-00008f00: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
-00008f10: 2020 2020 2020 2073 656c 662e 5f63 6f6e         self._con
-00008f20: 7472 6163 7473 5f74 6f5f 616d 6f75 6e74  tracts_to_amount
-00008f30: 2870 6169 722c 206c 696d 6974 735b 2761  (pair, limits['a
-00008f40: 6d6f 756e 7427 5d5b 6c69 6d69 745d 2920  mount'][limit]) 
-00008f50: 2a20 7072 6963 6520 2a20 6d61 7267 696e  * price * margin
-00008f60: 5f72 6573 6572 7665 0a20 2020 2020 2020  _reserve.       
-00008f70: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00008f80: 6966 206e 6f74 2073 7461 6b65 5f6c 696d  if not stake_lim
-00008f90: 6974 733a 0a20 2020 2020 2020 2020 2020  its:.           
-00008fa0: 2072 6574 7572 6e20 4e6f 6e65 2069 6620   return None if 
-00008fb0: 6973 4d69 6e20 656c 7365 2066 6c6f 6174  isMin else float
-00008fc0: 2827 696e 6627 290a 0a20 2020 2020 2020  ('inf')..       
-00008fd0: 2023 2054 6865 2076 616c 7565 2072 6574   # The value ret
-00008fe0: 7572 6e65 6420 7368 6f75 6c64 2073 6174  urned should sat
-00008ff0: 6973 6679 2062 6f74 6820 6c69 6d69 7473  isfy both limits
-00009000: 3a20 666f 7220 616d 6f75 6e74 2028 6261  : for amount (ba
-00009010: 7365 2063 7572 7265 6e63 7929 2061 6e64  se currency) and
-00009020: 0a20 2020 2020 2020 2023 2066 6f72 2063  .        # for c
-00009030: 6f73 7420 2871 756f 7465 2c20 7374 616b  ost (quote, stak
-00009040: 6520 6375 7272 656e 6379 292c 2073 6f20  e currency), so 
-00009050: 6d61 7828 2920 6973 2075 7365 6420 6865  max() is used he
-00009060: 7265 2e0a 2020 2020 2020 2020 2320 5365  re..        # Se
-00009070: 6520 616c 736f 2023 3235 3735 2061 7420  e also #2575 at 
-00009080: 6769 7468 7562 2e0a 2020 2020 2020 2020  github..        
-00009090: 7265 7475 726e 2073 656c 662e 5f67 6574  return self._get
-000090a0: 5f73 7461 6b65 5f61 6d6f 756e 745f 636f  _stake_amount_co
-000090b0: 6e73 6964 6572 696e 675f 6c65 7665 7261  nsidering_levera
-000090c0: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
-000090d0: 6d61 7828 7374 616b 655f 6c69 6d69 7473  max(stake_limits
-000090e0: 2920 6966 2069 734d 696e 2065 6c73 6520  ) if isMin else 
-000090f0: 6d69 6e28 7374 616b 655f 6c69 6d69 7473  min(stake_limits
-00009100: 292c 0a20 2020 2020 2020 2020 2020 206c  ),.            l
-00009110: 6576 6572 6167 6520 6f72 2031 2e30 0a20  everage or 1.0. 
-00009120: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00009130: 6620 5f67 6574 5f73 7461 6b65 5f61 6d6f  f _get_stake_amo
-00009140: 756e 745f 636f 6e73 6964 6572 696e 675f  unt_considering_
-00009150: 6c65 7665 7261 6765 2873 656c 662c 2073  leverage(self, s
-00009160: 7461 6b65 5f61 6d6f 756e 743a 2066 6c6f  take_amount: flo
-00009170: 6174 2c20 6c65 7665 7261 6765 3a20 666c  at, leverage: fl
-00009180: 6f61 7429 202d 3e20 666c 6f61 743a 0a20  oat) -> float:. 
-00009190: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000091a0: 2020 2054 616b 6573 2074 6865 206d 696e     Takes the min
-000091b0: 696d 756d 2073 7461 6b65 2061 6d6f 756e  imum stake amoun
-000091c0: 7420 666f 7220 6120 7061 6972 2077 6974  t for a pair wit
-000091d0: 6820 6e6f 206c 6576 6572 6167 6520 616e  h no leverage an
-000091e0: 6420 7265 7475 726e 7320 7468 6520 6d69  d returns the mi
-000091f0: 6e69 6d75 6d0a 2020 2020 2020 2020 7374  nimum.        st
-00009200: 616b 6520 616d 6f75 6e74 2077 6865 6e20  ake amount when 
-00009210: 6c65 7665 7261 6765 2069 7320 636f 6e73  leverage is cons
-00009220: 6964 6572 6564 0a20 2020 2020 2020 203a  idered.        :
-00009230: 7061 7261 6d20 7374 616b 655f 616d 6f75  param stake_amou
-00009240: 6e74 3a20 5468 6520 7374 616b 6520 616d  nt: The stake am
-00009250: 6f75 6e74 2066 6f72 2061 2070 6169 7220  ount for a pair 
-00009260: 6265 666f 7265 206c 6576 6572 6167 6520  before leverage 
-00009270: 6973 2063 6f6e 7369 6465 7265 640a 2020  is considered.  
-00009280: 2020 2020 2020 3a70 6172 616d 206c 6576        :param lev
-00009290: 6572 6167 653a 2054 6865 2061 6d6f 756e  erage: The amoun
-000092a0: 7420 6f66 206c 6576 6572 6167 6520 6265  t of leverage be
-000092b0: 696e 6720 7573 6564 206f 6e20 7468 6520  ing used on the 
-000092c0: 6375 7272 656e 7420 7472 6164 650a 2020  current trade.  
-000092d0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000092e0: 2020 7265 7475 726e 2073 7461 6b65 5f61    return stake_a
-000092f0: 6d6f 756e 7420 2f20 6c65 7665 7261 6765  mount / leverage
-00009300: 0a0a 2020 2020 2320 4472 792d 7275 6e20  ..    # Dry-run 
-00009310: 6d65 7468 6f64 730a 0a20 2020 2064 6566  methods..    def
-00009320: 2063 7265 6174 655f 6472 795f 7275 6e5f   create_dry_run_
-00009330: 6f72 6465 7228 7365 6c66 2c20 7061 6972  order(self, pair
-00009340: 3a20 7374 722c 206f 7264 6572 7479 7065  : str, ordertype
-00009350: 3a20 7374 722c 2073 6964 653a 2073 7472  : str, side: str
-00009360: 2c20 616d 6f75 6e74 3a20 666c 6f61 742c  , amount: float,
-00009370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009380: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00009390: 7465 3a20 666c 6f61 742c 206c 6576 6572  te: float, lever
-000093a0: 6167 653a 2066 6c6f 6174 2c20 7061 7261  age: float, para
-000093b0: 6d73 3a20 4469 6374 203d 207b 7d2c 0a20  ms: Dict = {},. 
-000093c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093d0: 2020 2020 2020 2020 2020 2020 7374 6f70              stop
-000093e0: 5f6c 6f73 733a 2062 6f6f 6c20 3d20 4661  _loss: bool = Fa
-000093f0: 6c73 6529 202d 3e20 4469 6374 5b73 7472  lse) -> Dict[str
-00009400: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
-00009410: 6f72 6465 725f 6964 203d 2066 2764 7279  order_id = f'dry
-00009420: 5f72 756e 5f7b 7369 6465 7d5f 7b64 6174  _run_{side}_{dat
-00009430: 6574 696d 652e 6e6f 7728 292e 7469 6d65  etime.now().time
-00009440: 7374 616d 7028 297d 270a 2020 2020 2020  stamp()}'.      
-00009450: 2020 2320 526f 756e 6469 6e67 2068 6572    # Rounding her
-00009460: 6520 6d75 7374 2072 6573 7065 6374 2074  e must respect t
-00009470: 6f20 636f 6e74 7261 6374 2073 697a 6573  o contract sizes
-00009480: 0a20 2020 2020 2020 205f 616d 6f75 6e74  .        _amount
-00009490: 203d 2073 656c 662e 5f63 6f6e 7472 6163   = self._contrac
-000094a0: 7473 5f74 6f5f 616d 6f75 6e74 280a 2020  ts_to_amount(.  
-000094b0: 2020 2020 2020 2020 2020 7061 6972 2c20            pair, 
-000094c0: 7365 6c66 2e61 6d6f 756e 745f 746f 5f70  self.amount_to_p
-000094d0: 7265 6369 7369 6f6e 2870 6169 722c 2073  recision(pair, s
-000094e0: 656c 662e 5f61 6d6f 756e 745f 746f 5f63  elf._amount_to_c
-000094f0: 6f6e 7472 6163 7473 2870 6169 722c 2061  ontracts(pair, a
-00009500: 6d6f 756e 7429 2929 0a20 2020 2020 2020  mount))).       
-00009510: 2064 7279 5f6f 7264 6572 3a20 4469 6374   dry_order: Dict
-00009520: 5b73 7472 2c20 416e 795d 203d 207b 0a20  [str, Any] = {. 
-00009530: 2020 2020 2020 2020 2020 2027 6964 273a             'id':
-00009540: 206f 7264 6572 5f69 642c 0a20 2020 2020   order_id,.     
-00009550: 2020 2020 2020 2027 7379 6d62 6f6c 273a         'symbol':
-00009560: 2070 6169 722c 0a20 2020 2020 2020 2020   pair,.         
-00009570: 2020 2027 7072 6963 6527 3a20 7261 7465     'price': rate
-00009580: 2c0a 2020 2020 2020 2020 2020 2020 2761  ,.            'a
-00009590: 7665 7261 6765 273a 2072 6174 652c 0a20  verage': rate,. 
-000095a0: 2020 2020 2020 2020 2020 2027 616d 6f75             'amou
-000095b0: 6e74 273a 205f 616d 6f75 6e74 2c0a 2020  nt': _amount,.  
-000095c0: 2020 2020 2020 2020 2020 2763 6f73 7427            'cost'
-000095d0: 3a20 5f61 6d6f 756e 7420 2a20 7261 7465  : _amount * rate
-000095e0: 2c0a 2020 2020 2020 2020 2020 2020 2774  ,.            't
-000095f0: 7970 6527 3a20 6f72 6465 7274 7970 652c  ype': ordertype,
-00009600: 0a20 2020 2020 2020 2020 2020 2027 7369  .            'si
-00009610: 6465 273a 2073 6964 652c 0a20 2020 2020  de': side,.     
-00009620: 2020 2020 2020 2027 6669 6c6c 6564 273a         'filled':
-00009630: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
-00009640: 2772 656d 6169 6e69 6e67 273a 205f 616d  'remaining': _am
-00009650: 6f75 6e74 2c0a 2020 2020 2020 2020 2020  ount,.          
-00009660: 2020 2764 6174 6574 696d 6527 3a20 6172    'datetime': ar
-00009670: 726f 772e 7574 636e 6f77 2829 2e73 7472  row.utcnow().str
-00009680: 6674 696d 6528 2725 592d 256d 2d25 6454  ftime('%Y-%m-%dT
-00009690: 2548 3a25 4d3a 2553 2e25 665a 2729 2c0a  %H:%M:%S.%fZ'),.
-000096a0: 2020 2020 2020 2020 2020 2020 2774 696d              'tim
-000096b0: 6573 7461 6d70 273a 2061 7272 6f77 2e75  estamp': arrow.u
-000096c0: 7463 6e6f 7728 292e 696e 745f 7469 6d65  tcnow().int_time
-000096d0: 7374 616d 7020 2a20 3130 3030 2c0a 2020  stamp * 1000,.  
-000096e0: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
-000096f0: 7327 3a20 226f 7065 6e22 2c0a 2020 2020  s': "open",.    
-00009700: 2020 2020 2020 2020 2766 6565 273a 204e          'fee': N
-00009710: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00009720: 2027 696e 666f 273a 207b 7d2c 0a20 2020   'info': {},.   
-00009730: 2020 2020 2020 2020 2027 6c65 7665 7261           'levera
-00009740: 6765 273a 206c 6576 6572 6167 650a 2020  ge': leverage.  
-00009750: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00009760: 6966 2073 746f 705f 6c6f 7373 3a0a 2020  if stop_loss:.  
-00009770: 2020 2020 2020 2020 2020 6472 795f 6f72            dry_or
-00009780: 6465 725b 2269 6e66 6f22 5d20 3d20 7b22  der["info"] = {"
-00009790: 7374 6f70 5072 6963 6522 3a20 6472 795f  stopPrice": dry_
-000097a0: 6f72 6465 725b 2270 7269 6365 225d 7d0a  order["price"]}.
-000097b0: 2020 2020 2020 2020 2020 2020 6472 795f              dry_
-000097c0: 6f72 6465 725b 2273 746f 7050 7269 6365  order["stopPrice
-000097d0: 225d 203d 2064 7279 5f6f 7264 6572 5b22  "] = dry_order["
-000097e0: 7072 6963 6522 5d0a 2020 2020 2020 2020  price"].        
-000097f0: 2020 2020 2320 576f 726b 6172 6f75 6e64      # Workaround
-00009800: 2074 6f20 6176 6f69 6420 6669 6c6c 696e   to avoid fillin
-00009810: 6720 7374 6f70 6c6f 7373 206f 7264 6572  g stoploss order
-00009820: 7320 696d 6d65 6469 6174 656c 790a 2020  s immediately.  
-00009830: 2020 2020 2020 2020 2020 6472 795f 6f72            dry_or
-00009840: 6465 725b 2266 745f 6f72 6465 725f 7479  der["ft_order_ty
-00009850: 7065 225d 203d 2022 7374 6f70 6c6f 7373  pe"] = "stoploss
-00009860: 220a 2020 2020 2020 2020 6f72 6465 7262  ".        orderb
-00009870: 6f6f 6b3a 204f 7074 696f 6e61 6c5b 4f72  ook: Optional[Or
-00009880: 6465 7242 6f6f 6b5d 203d 204e 6f6e 650a  derBook] = None.
-00009890: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000098a0: 6578 6368 616e 6765 5f68 6173 2827 6665  exchange_has('fe
-000098b0: 7463 684c 324f 7264 6572 426f 6f6b 2729  tchL2OrderBook')
-000098c0: 3a0a 2020 2020 2020 2020 2020 2020 6f72  :.            or
-000098d0: 6465 7262 6f6f 6b20 3d20 7365 6c66 2e66  derbook = self.f
-000098e0: 6574 6368 5f6c 325f 6f72 6465 725f 626f  etch_l2_order_bo
-000098f0: 6f6b 2870 6169 722c 2032 3029 0a20 2020  ok(pair, 20).   
-00009900: 2020 2020 2069 6620 6f72 6465 7274 7970       if ordertyp
-00009910: 6520 3d3d 2022 6c69 6d69 7422 2061 6e64  e == "limit" and
-00009920: 206f 7264 6572 626f 6f6b 3a0a 2020 2020   orderbook:.    
-00009930: 2020 2020 2020 2020 2320 416c 6c6f 7720          # Allow 
-00009940: 6120 3325 2070 7269 6365 2064 6966 6665  a 3% price diffe
-00009950: 7265 6e63 650a 2020 2020 2020 2020 2020  rence.          
-00009960: 2020 616c 6c6f 7765 645f 6469 6666 203d    allowed_diff =
-00009970: 2030 2e30 330a 2020 2020 2020 2020 2020   0.03.          
-00009980: 2020 6966 2073 656c 662e 5f64 7279 5f69    if self._dry_i
-00009990: 735f 7072 6963 655f 6372 6f73 7365 6428  s_price_crossed(
-000099a0: 7061 6972 2c20 7369 6465 2c20 7261 7465  pair, side, rate
-000099b0: 2c20 6f72 6465 7262 6f6f 6b2c 2061 6c6c  , orderbook, all
-000099c0: 6f77 6564 5f64 6966 6629 3a0a 2020 2020  owed_diff):.    
-000099d0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-000099e0: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
-000099f0: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
-00009a00: 6f6e 7665 7274 6564 206f 7264 6572 207b  onverted order {
-00009a10: 7061 6972 7d20 746f 206d 6172 6b65 7420  pair} to market 
-00009a20: 6f72 6465 7220 6475 6520 746f 2070 7269  order due to pri
-00009a30: 6365 207b 7261 7465 7d20 6372 6f73 7369  ce {rate} crossi
-00009a40: 6e67 2073 7072 6561 6420 220a 2020 2020  ng spread ".    
-00009a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009a60: 6622 6279 206d 6f72 6520 7468 616e 207b  f"by more than {
-00009a70: 616c 6c6f 7765 645f 6469 6666 3a2e 3225  allowed_diff:.2%
-00009a80: 7d2e 2229 0a20 2020 2020 2020 2020 2020  }.").           
-00009a90: 2020 2020 2064 7279 5f6f 7264 6572 5b22       dry_order["
-00009aa0: 7479 7065 225d 203d 2022 6d61 726b 6574  type"] = "market
-00009ab0: 220a 0a20 2020 2020 2020 2069 6620 6472  "..        if dr
-00009ac0: 795f 6f72 6465 725b 2274 7970 6522 5d20  y_order["type"] 
-00009ad0: 3d3d 2022 6d61 726b 6574 2220 616e 6420  == "market" and 
-00009ae0: 6e6f 7420 6472 795f 6f72 6465 722e 6765  not dry_order.ge
-00009af0: 7428 2266 745f 6f72 6465 725f 7479 7065  t("ft_order_type
-00009b00: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00009b10: 2320 5570 6461 7465 206d 6172 6b65 7420  # Update market 
-00009b20: 6f72 6465 7220 7072 6963 696e 670a 2020  order pricing.  
-00009b30: 2020 2020 2020 2020 2020 6176 6572 6167            averag
-00009b40: 6520 3d20 7365 6c66 2e67 6574 5f64 7279  e = self.get_dry
-00009b50: 5f6d 6172 6b65 745f 6669 6c6c 5f70 7269  _market_fill_pri
-00009b60: 6365 2870 6169 722c 2073 6964 652c 2061  ce(pair, side, a
-00009b70: 6d6f 756e 742c 2072 6174 652c 206f 7264  mount, rate, ord
-00009b80: 6572 626f 6f6b 290a 2020 2020 2020 2020  erbook).        
-00009b90: 2020 2020 6472 795f 6f72 6465 722e 7570      dry_order.up
-00009ba0: 6461 7465 287b 0a20 2020 2020 2020 2020  date({.         
-00009bb0: 2020 2020 2020 2027 6176 6572 6167 6527         'average'
-00009bc0: 3a20 6176 6572 6167 652c 0a20 2020 2020  : average,.     
-00009bd0: 2020 2020 2020 2020 2020 2027 6669 6c6c             'fill
-00009be0: 6564 273a 205f 616d 6f75 6e74 2c0a 2020  ed': _amount,.  
-00009bf0: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-00009c00: 656d 6169 6e69 6e67 273a 2030 2e30 2c0a  emaining': 0.0,.
-00009c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c20: 2773 7461 7475 7327 3a20 2263 6c6f 7365  'status': "close
-00009c30: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-00009c40: 2020 2020 2763 6f73 7427 3a20 2864 7279      'cost': (dry
-00009c50: 5f6f 7264 6572 5b27 616d 6f75 6e74 275d  _order['amount']
-00009c60: 202a 2061 7665 7261 6765 290a 2020 2020   * average).    
-00009c70: 2020 2020 2020 2020 7d29 0a20 2020 2020          }).     
-00009c80: 2020 2020 2020 2023 206d 6172 6b65 7420         # market 
-00009c90: 6f72 6465 7273 2077 696c 6c20 616c 7761  orders will alwa
-00009ca0: 7973 2069 6e63 7572 7220 7461 6b65 7220  ys incurr taker 
-00009cb0: 6665 6573 0a20 2020 2020 2020 2020 2020  fees.           
-00009cc0: 2064 7279 5f6f 7264 6572 203d 2073 656c   dry_order = sel
-00009cd0: 662e 6164 645f 6472 795f 6f72 6465 725f  f.add_dry_order_
-00009ce0: 6665 6528 7061 6972 2c20 6472 795f 6f72  fee(pair, dry_or
-00009cf0: 6465 722c 2027 7461 6b65 7227 290a 0a20  der, 'taker').. 
-00009d00: 2020 2020 2020 2064 7279 5f6f 7264 6572         dry_order
-00009d10: 203d 2073 656c 662e 6368 6563 6b5f 6472   = self.check_dr
-00009d20: 795f 6c69 6d69 745f 6f72 6465 725f 6669  y_limit_order_fi
-00009d30: 6c6c 6564 280a 2020 2020 2020 2020 2020  lled(.          
-00009d40: 2020 6472 795f 6f72 6465 722c 2069 6d6d    dry_order, imm
-00009d50: 6564 6961 7465 3d54 7275 652c 206f 7264  ediate=True, ord
-00009d60: 6572 626f 6f6b 3d6f 7264 6572 626f 6f6b  erbook=orderbook
-00009d70: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00009d80: 5f64 7279 5f72 756e 5f6f 7065 6e5f 6f72  _dry_run_open_or
-00009d90: 6465 7273 5b64 7279 5f6f 7264 6572 5b22  ders[dry_order["
-00009da0: 6964 225d 5d20 3d20 6472 795f 6f72 6465  id"]] = dry_orde
-00009db0: 720a 2020 2020 2020 2020 2320 436f 7079  r.        # Copy
-00009dc0: 206f 7264 6572 2061 6e64 2063 6c6f 7365   order and close
-00009dd0: 2069 7420 2d20 736f 2074 6865 2072 6574   it - so the ret
-00009de0: 7572 6e65 6420 6f72 6465 7220 6973 206f  urned order is o
-00009df0: 7065 6e20 756e 6c65 7373 2069 7427 7320  pen unless it's 
-00009e00: 6120 6d61 726b 6574 206f 7264 6572 0a20  a market order. 
-00009e10: 2020 2020 2020 2072 6574 7572 6e20 6472         return dr
-00009e20: 795f 6f72 6465 720a 0a20 2020 2064 6566  y_order..    def
-00009e30: 2061 6464 5f64 7279 5f6f 7264 6572 5f66   add_dry_order_f
-00009e40: 6565 280a 2020 2020 2020 2020 7365 6c66  ee(.        self
-00009e50: 2c0a 2020 2020 2020 2020 7061 6972 3a20  ,.        pair: 
-00009e60: 7374 722c 0a20 2020 2020 2020 2064 7279  str,.        dry
-00009e70: 5f6f 7264 6572 3a20 4469 6374 5b73 7472  _order: Dict[str
-00009e80: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
-00009e90: 7461 6b65 725f 6f72 5f6d 616b 6572 3a20  taker_or_maker: 
-00009ea0: 4d61 6b65 7254 616b 6572 2c0a 2020 2020  MakerTaker,.    
-00009eb0: 2920 2d3e 2044 6963 745b 7374 722c 2041  ) -> Dict[str, A
-00009ec0: 6e79 5d3a 0a20 2020 2020 2020 2066 6565  ny]:.        fee
-00009ed0: 203d 2073 656c 662e 6765 745f 6665 6528   = self.get_fee(
-00009ee0: 7061 6972 2c20 7461 6b65 725f 6f72 5f6d  pair, taker_or_m
-00009ef0: 616b 6572 3d74 616b 6572 5f6f 725f 6d61  aker=taker_or_ma
-00009f00: 6b65 7229 0a20 2020 2020 2020 2064 7279  ker).        dry
-00009f10: 5f6f 7264 6572 2e75 7064 6174 6528 7b0a  _order.update({.
-00009f20: 2020 2020 2020 2020 2020 2020 2766 6565              'fee
-00009f30: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-00009f40: 2020 2020 2027 6375 7272 656e 6379 273a       'currency':
-00009f50: 2073 656c 662e 6765 745f 7061 6972 5f71   self.get_pair_q
-00009f60: 756f 7465 5f63 7572 7265 6e63 7928 7061  uote_currency(pa
-00009f70: 6972 292c 0a20 2020 2020 2020 2020 2020  ir),.           
-00009f80: 2020 2020 2027 636f 7374 273a 2064 7279       'cost': dry
-00009f90: 5f6f 7264 6572 5b27 636f 7374 275d 202a  _order['cost'] *
-00009fa0: 2066 6565 2c0a 2020 2020 2020 2020 2020   fee,.          
-00009fb0: 2020 2020 2020 2772 6174 6527 3a20 6665        'rate': fe
-00009fc0: 650a 2020 2020 2020 2020 2020 2020 7d0a  e.            }.
-00009fd0: 2020 2020 2020 2020 7d29 0a20 2020 2020          }).     
-00009fe0: 2020 2072 6574 7572 6e20 6472 795f 6f72     return dry_or
-00009ff0: 6465 720a 0a20 2020 2064 6566 2067 6574  der..    def get
-0000a000: 5f64 7279 5f6d 6172 6b65 745f 6669 6c6c  _dry_market_fill
-0000a010: 5f70 7269 6365 2873 656c 662c 2070 6169  _price(self, pai
-0000a020: 723a 2073 7472 2c20 7369 6465 3a20 7374  r: str, side: st
-0000a030: 722c 2061 6d6f 756e 743a 2066 6c6f 6174  r, amount: float
-0000a040: 2c20 7261 7465 3a20 666c 6f61 742c 0a20  , rate: float,. 
-0000a050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a070: 206f 7264 6572 626f 6f6b 3a20 4f70 7469   orderbook: Opti
-0000a080: 6f6e 616c 5b4f 7264 6572 426f 6f6b 5d29  onal[OrderBook])
-0000a090: 202d 3e20 666c 6f61 743a 0a20 2020 2020   -> float:.     
-0000a0a0: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
-0000a0b0: 6574 2074 6865 206d 6172 6b65 7420 6f72  et the market or
-0000a0c0: 6465 7220 6669 6c6c 2070 7269 6365 2062  der fill price b
-0000a0d0: 6173 6564 206f 6e20 6f72 6465 7262 6f6f  ased on orderboo
-0000a0e0: 6b20 696e 7465 7270 6f6c 6174 696f 6e0a  k interpolation.
-0000a0f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000a100: 2020 2020 6966 2073 656c 662e 6578 6368      if self.exch
-0000a110: 616e 6765 5f68 6173 2827 6665 7463 684c  ange_has('fetchL
-0000a120: 324f 7264 6572 426f 6f6b 2729 3a0a 2020  2OrderBook'):.  
-0000a130: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0000a140: 206f 7264 6572 626f 6f6b 3a0a 2020 2020   orderbook:.    
-0000a150: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
-0000a160: 7262 6f6f 6b20 3d20 7365 6c66 2e66 6574  rbook = self.fet
-0000a170: 6368 5f6c 325f 6f72 6465 725f 626f 6f6b  ch_l2_order_book
-0000a180: 2870 6169 722c 2032 3029 0a20 2020 2020  (pair, 20).     
-0000a190: 2020 2020 2020 206f 625f 7479 7065 3a20         ob_type: 
-0000a1a0: 4f42 4c69 7465 7261 6c20 3d20 2761 736b  OBLiteral = 'ask
-0000a1b0: 7327 2069 6620 7369 6465 203d 3d20 2762  s' if side == 'b
-0000a1c0: 7579 2720 656c 7365 2027 6269 6473 270a  uy' else 'bids'.
-0000a1d0: 2020 2020 2020 2020 2020 2020 736c 6970              slip
-0000a1e0: 7061 6765 203d 2030 2e30 350a 2020 2020  page = 0.05.    
-0000a1f0: 2020 2020 2020 2020 6d61 785f 736c 6970          max_slip
-0000a200: 7061 6765 5f76 616c 203d 2072 6174 6520  page_val = rate 
-0000a210: 2a20 2828 3120 2b20 736c 6970 7061 6765  * ((1 + slippage
-0000a220: 2920 6966 2073 6964 6520 3d3d 2027 6275  ) if side == 'bu
-0000a230: 7927 2065 6c73 6520 2831 202d 2073 6c69  y' else (1 - sli
-0000a240: 7070 6167 6529 290a 0a20 2020 2020 2020  ppage))..       
-0000a250: 2020 2020 2072 656d 6169 6e69 6e67 5f61       remaining_a
-0000a260: 6d6f 756e 7420 3d20 616d 6f75 6e74 0a20  mount = amount. 
-0000a270: 2020 2020 2020 2020 2020 2066 696c 6c65             fille
-0000a280: 645f 616d 6f75 6e74 203d 2030 2e30 0a20  d_amount = 0.0. 
-0000a290: 2020 2020 2020 2020 2020 2062 6f6f 6b5f             book_
-0000a2a0: 656e 7472 795f 7072 6963 6520 3d20 302e  entry_price = 0.
-0000a2b0: 300a 2020 2020 2020 2020 2020 2020 666f  0.            fo
-0000a2c0: 7220 626f 6f6b 5f65 6e74 7279 2069 6e20  r book_entry in 
-0000a2d0: 6f72 6465 7262 6f6f 6b5b 6f62 5f74 7970  orderbook[ob_typ
-0000a2e0: 655d 3a0a 2020 2020 2020 2020 2020 2020  e]:.            
-0000a2f0: 2020 2020 626f 6f6b 5f65 6e74 7279 5f70      book_entry_p
-0000a300: 7269 6365 203d 2062 6f6f 6b5f 656e 7472  rice = book_entr
-0000a310: 795b 305d 0a20 2020 2020 2020 2020 2020  y[0].           
-0000a320: 2020 2020 2062 6f6f 6b5f 656e 7472 795f       book_entry_
-0000a330: 636f 696e 5f76 6f6c 756d 6520 3d20 626f  coin_volume = bo
-0000a340: 6f6b 5f65 6e74 7279 5b31 5d0a 2020 2020  ok_entry[1].    
-0000a350: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0000a360: 656d 6169 6e69 6e67 5f61 6d6f 756e 7420  emaining_amount 
-0000a370: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-0000a380: 2020 2020 2020 2020 2069 6620 7265 6d61           if rema
-0000a390: 696e 696e 675f 616d 6f75 6e74 203c 2062  ining_amount < b
-0000a3a0: 6f6f 6b5f 656e 7472 795f 636f 696e 5f76  ook_entry_coin_v
-0000a3b0: 6f6c 756d 653a 0a20 2020 2020 2020 2020  olume:.         
-0000a3c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000a3d0: 204f 7264 6572 626f 6f6b 2061 7420 7468   Orderbook at th
-0000a3e0: 6973 2073 6c6f 7420 6269 6767 6572 2074  is slot bigger t
-0000a3f0: 6861 6e20 7265 6d61 696e 696e 6720 616d  han remaining am
-0000a400: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
-0000a410: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-0000a420: 6c65 645f 616d 6f75 6e74 202b 3d20 7265  led_amount += re
-0000a430: 6d61 696e 696e 675f 616d 6f75 6e74 202a  maining_amount *
-0000a440: 2062 6f6f 6b5f 656e 7472 795f 7072 6963   book_entry_pric
-0000a450: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000a460: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0000a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a480: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4a0: 2020 6669 6c6c 6564 5f61 6d6f 756e 7420    filled_amount 
-0000a4b0: 2b3d 2062 6f6f 6b5f 656e 7472 795f 636f  += book_entry_co
-0000a4c0: 696e 5f76 6f6c 756d 6520 2a20 626f 6f6b  in_volume * book
-0000a4d0: 5f65 6e74 7279 5f70 7269 6365 0a20 2020  _entry_price.   
-0000a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a4f0: 2072 656d 6169 6e69 6e67 5f61 6d6f 756e   remaining_amoun
-0000a500: 7420 2d3d 2062 6f6f 6b5f 656e 7472 795f  t -= book_entry_
-0000a510: 636f 696e 5f76 6f6c 756d 650a 2020 2020  coin_volume.    
-0000a520: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000a530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a540: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-0000a550: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000a560: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000a570: 4966 2072 656d 6169 6e69 6e67 5f61 6d6f  If remaining_amo
-0000a580: 756e 7420 7761 736e 2774 2063 6f6e 7375  unt wasn't consu
-0000a590: 6d65 6420 636f 6d70 6c65 7465 6c79 2028  med completely (
-0000a5a0: 6272 6561 6b20 7761 7320 6e6f 7420 6361  break was not ca
-0000a5b0: 6c6c 6564 290a 2020 2020 2020 2020 2020  lled).          
-0000a5c0: 2020 2020 2020 6669 6c6c 6564 5f61 6d6f        filled_amo
-0000a5d0: 756e 7420 2b3d 2072 656d 6169 6e69 6e67  unt += remaining
-0000a5e0: 5f61 6d6f 756e 7420 2a20 626f 6f6b 5f65  _amount * book_e
-0000a5f0: 6e74 7279 5f70 7269 6365 0a20 2020 2020  ntry_price.     
-0000a600: 2020 2020 2020 2066 6f72 6563 6173 745f         forecast_
-0000a610: 6176 675f 6669 6c6c 6564 5f70 7269 6365  avg_filled_price
-0000a620: 203d 206d 6178 2866 696c 6c65 645f 616d   = max(filled_am
-0000a630: 6f75 6e74 2c20 3029 202f 2061 6d6f 756e  ount, 0) / amoun
-0000a640: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-0000a650: 4c69 6d69 7420 6d61 782e 2073 6c69 7070  Limit max. slipp
-0000a660: 6167 6520 746f 2073 7065 6369 6669 6564  age to specified
-0000a670: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
-0000a680: 2020 2069 6620 7369 6465 203d 3d20 2762     if side == 'b
-0000a690: 7579 273a 0a20 2020 2020 2020 2020 2020  uy':.           
-0000a6a0: 2020 2020 2066 6f72 6563 6173 745f 6176       forecast_av
-0000a6b0: 675f 6669 6c6c 6564 5f70 7269 6365 203d  g_filled_price =
-0000a6c0: 206d 696e 2866 6f72 6563 6173 745f 6176   min(forecast_av
-0000a6d0: 675f 6669 6c6c 6564 5f70 7269 6365 2c20  g_filled_price, 
-0000a6e0: 6d61 785f 736c 6970 7061 6765 5f76 616c  max_slippage_val
-0000a6f0: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
-0000a700: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000a710: 2020 2020 2066 6f72 6563 6173 745f 6176       forecast_av
-0000a720: 675f 6669 6c6c 6564 5f70 7269 6365 203d  g_filled_price =
-0000a730: 206d 6178 2866 6f72 6563 6173 745f 6176   max(forecast_av
-0000a740: 675f 6669 6c6c 6564 5f70 7269 6365 2c20  g_filled_price, 
-0000a750: 6d61 785f 736c 6970 7061 6765 5f76 616c  max_slippage_val
-0000a760: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
-0000a770: 6574 7572 6e20 7365 6c66 2e70 7269 6365  eturn self.price
-0000a780: 5f74 6f5f 7072 6563 6973 696f 6e28 7061  _to_precision(pa
-0000a790: 6972 2c20 666f 7265 6361 7374 5f61 7667  ir, forecast_avg
-0000a7a0: 5f66 696c 6c65 645f 7072 6963 6529 0a0a  _filled_price)..
-0000a7b0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-0000a7c0: 6174 650a 0a20 2020 2064 6566 205f 6472  ate..    def _dr
-0000a7d0: 795f 6973 5f70 7269 6365 5f63 726f 7373  y_is_price_cross
-0000a7e0: 6564 2873 656c 662c 2070 6169 723a 2073  ed(self, pair: s
-0000a7f0: 7472 2c20 7369 6465 3a20 7374 722c 206c  tr, side: str, l
-0000a800: 696d 6974 3a20 666c 6f61 742c 0a20 2020  imit: float,.   
-0000a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a820: 2020 2020 2020 2020 2020 206f 7264 6572             order
-0000a830: 626f 6f6b 3a20 4f70 7469 6f6e 616c 5b4f  book: Optional[O
-0000a840: 7264 6572 426f 6f6b 5d20 3d20 4e6f 6e65  rderBook] = None
-0000a850: 2c20 6f66 6673 6574 3a20 666c 6f61 7420  , offset: float 
-0000a860: 3d20 302e 3029 202d 3e20 626f 6f6c 3a0a  = 0.0) -> bool:.
-0000a870: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0000a880: 656c 662e 6578 6368 616e 6765 5f68 6173  elf.exchange_has
-0000a890: 2827 6665 7463 684c 324f 7264 6572 426f  ('fetchL2OrderBo
-0000a8a0: 6f6b 2729 3a0a 2020 2020 2020 2020 2020  ok'):.          
-0000a8b0: 2020 7265 7475 726e 2054 7275 650a 2020    return True.  
-0000a8c0: 2020 2020 2020 6966 206e 6f74 206f 7264        if not ord
-0000a8d0: 6572 626f 6f6b 3a0a 2020 2020 2020 2020  erbook:.        
-0000a8e0: 2020 2020 6f72 6465 7262 6f6f 6b20 3d20      orderbook = 
-0000a8f0: 7365 6c66 2e66 6574 6368 5f6c 325f 6f72  self.fetch_l2_or
-0000a900: 6465 725f 626f 6f6b 2870 6169 722c 2031  der_book(pair, 1
-0000a910: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
-0000a920: 2020 2020 2020 2020 2020 2069 6620 7369             if si
-0000a930: 6465 203d 3d20 2762 7579 273a 0a20 2020  de == 'buy':.   
-0000a940: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0000a950: 6365 203d 206f 7264 6572 626f 6f6b 5b27  ce = orderbook['
-0000a960: 6173 6b73 275d 5b30 5d5b 305d 0a20 2020  asks'][0][0].   
-0000a970: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000a980: 6c69 6d69 7420 2a20 2831 202d 206f 6666  limit * (1 - off
-0000a990: 7365 7429 203e 3d20 7072 6963 653a 0a20  set) >= price:. 
-0000a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a9b0: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
-0000a9c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000a9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a9e0: 2070 7269 6365 203d 206f 7264 6572 626f   price = orderbo
-0000a9f0: 6f6b 5b27 6269 6473 275d 5b30 5d5b 305d  ok['bids'][0][0]
-0000aa00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aa10: 2069 6620 6c69 6d69 7420 2a20 2831 202b   if limit * (1 +
-0000aa20: 206f 6666 7365 7429 203c 3d20 7072 6963   offset) <= pric
-0000aa30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000aa40: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-0000aa50: 7565 0a20 2020 2020 2020 2065 7863 6570  ue.        excep
-0000aa60: 7420 496e 6465 7845 7272 6f72 3a0a 2020  t IndexError:.  
-0000aa70: 2020 2020 2020 2020 2020 2320 4967 6e6f            # Igno
-0000aa80: 7265 2065 6d70 7479 206f 7264 6572 626f  re empty orderbo
-0000aa90: 6f6b 7320 7768 656e 2066 696c 6c69 6e67  oks when filling
-0000aaa0: 202d 2063 616e 2062 6520 6669 6c6c 6564   - can be filled
-0000aab0: 2077 6974 6820 7468 6520 6e65 7874 2069   with the next i
-0000aac0: 7465 7261 7469 6f6e 2e0a 2020 2020 2020  teration..      
-0000aad0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-0000aae0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0000aaf0: 0a20 2020 2064 6566 2063 6865 636b 5f64  .    def check_d
-0000ab00: 7279 5f6c 696d 6974 5f6f 7264 6572 5f66  ry_limit_order_f
-0000ab10: 696c 6c65 6428 0a20 2020 2020 2020 2020  illed(.         
-0000ab20: 2020 2073 656c 662c 206f 7264 6572 3a20     self, order: 
-0000ab30: 4469 6374 5b73 7472 2c20 416e 795d 2c20  Dict[str, Any], 
-0000ab40: 696d 6d65 6469 6174 653a 2062 6f6f 6c20  immediate: bool 
-0000ab50: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-0000ab60: 2020 2020 206f 7264 6572 626f 6f6b 3a20       orderbook: 
-0000ab70: 4f70 7469 6f6e 616c 5b4f 7264 6572 426f  Optional[OrderBo
-0000ab80: 6f6b 5d20 3d20 4e6f 6e65 2920 2d3e 2044  ok] = None) -> D
-0000ab90: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-0000aba0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000abb0: 2020 2043 6865 636b 2064 7279 2d72 756e     Check dry-run
-0000abc0: 206c 696d 6974 206f 7264 6572 2066 696c   limit order fil
-0000abd0: 6c20 616e 6420 7570 6461 7465 2066 6565  l and update fee
-0000abe0: 2028 6966 2069 7420 6669 6c6c 6564 292e   (if it filled).
-0000abf0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000ac00: 2020 2020 2069 6620 286f 7264 6572 5b27       if (order['
-0000ac10: 7374 6174 7573 275d 2021 3d20 2263 6c6f  status'] != "clo
-0000ac20: 7365 6422 0a20 2020 2020 2020 2020 2020  sed".           
-0000ac30: 2020 2020 2061 6e64 206f 7264 6572 5b27       and order['
-0000ac40: 7479 7065 275d 2069 6e20 5b22 6c69 6d69  type'] in ["limi
-0000ac50: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
-0000ac60: 2020 2020 616e 6420 6e6f 7420 6f72 6465      and not orde
-0000ac70: 722e 6765 7428 2766 745f 6f72 6465 725f  r.get('ft_order_
-0000ac80: 7479 7065 2729 293a 0a20 2020 2020 2020  type')):.       
-0000ac90: 2020 2020 2070 6169 7220 3d20 6f72 6465       pair = orde
-0000aca0: 725b 2773 796d 626f 6c27 5d0a 2020 2020  r['symbol'].    
-0000acb0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000acc0: 5f64 7279 5f69 735f 7072 6963 655f 6372  _dry_is_price_cr
-0000acd0: 6f73 7365 6428 7061 6972 2c20 6f72 6465  ossed(pair, orde
-0000ace0: 725b 2773 6964 6527 5d2c 206f 7264 6572  r['side'], order
-0000acf0: 5b27 7072 6963 6527 5d2c 206f 7264 6572  ['price'], order
-0000ad00: 626f 6f6b 293a 0a20 2020 2020 2020 2020  book):.         
-0000ad10: 2020 2020 2020 206f 7264 6572 2e75 7064         order.upd
-0000ad20: 6174 6528 7b0a 2020 2020 2020 2020 2020  ate({.          
-0000ad30: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
-0000ad40: 7327 3a20 2763 6c6f 7365 6427 2c0a 2020  s': 'closed',.  
-0000ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad60: 2020 2766 696c 6c65 6427 3a20 6f72 6465    'filled': orde
-0000ad70: 725b 2761 6d6f 756e 7427 5d2c 0a20 2020  r['amount'],.   
-0000ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad90: 2027 7265 6d61 696e 696e 6727 3a20 302c   'remaining': 0,
-0000ada0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000adb0: 207d 290a 0a20 2020 2020 2020 2020 2020   })..           
-0000adc0: 2020 2020 2073 656c 662e 6164 645f 6472       self.add_dr
-0000add0: 795f 6f72 6465 725f 6665 6528 0a20 2020  y_order_fee(.   
-0000ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adf0: 2070 6169 722c 0a20 2020 2020 2020 2020   pair,.         
-0000ae00: 2020 2020 2020 2020 2020 206f 7264 6572             order
-0000ae10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ae20: 2020 2020 2020 2774 616b 6572 2720 6966        'taker' if
-0000ae30: 2069 6d6d 6564 6961 7465 2065 6c73 6520   immediate else 
-0000ae40: 276d 616b 6572 272c 0a20 2020 2020 2020  'maker',.       
-0000ae50: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0000ae60: 2020 2020 7265 7475 726e 206f 7264 6572      return order
-0000ae70: 0a0a 2020 2020 6465 6620 6665 7463 685f  ..    def fetch_
-0000ae80: 6472 795f 7275 6e5f 6f72 6465 7228 7365  dry_run_order(se
-0000ae90: 6c66 2c20 6f72 6465 725f 6964 2920 2d3e  lf, order_id) ->
-0000aea0: 2044 6963 745b 7374 722c 2041 6e79 5d3a   Dict[str, Any]:
-0000aeb0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000aec0: 2020 2020 2052 6574 7572 6e20 6472 792d       Return dry-
-0000aed0: 7275 6e20 6f72 6465 720a 2020 2020 2020  run order.      
-0000aee0: 2020 4f6e 6c79 2063 616c 6c20 6966 2072    Only call if r
-0000aef0: 756e 6e69 6e67 2069 6e20 6472 792d 7275  unning in dry-ru
-0000af00: 6e20 6d6f 6465 2e0a 2020 2020 2020 2020  n mode..        
-0000af10: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-0000af20: 0a20 2020 2020 2020 2020 2020 206f 7264  .            ord
-0000af30: 6572 203d 2073 656c 662e 5f64 7279 5f72  er = self._dry_r
-0000af40: 756e 5f6f 7065 6e5f 6f72 6465 7273 5b6f  un_open_orders[o
-0000af50: 7264 6572 5f69 645d 0a20 2020 2020 2020  rder_id].       
-0000af60: 2020 2020 206f 7264 6572 203d 2073 656c       order = sel
-0000af70: 662e 6368 6563 6b5f 6472 795f 6c69 6d69  f.check_dry_limi
-0000af80: 745f 6f72 6465 725f 6669 6c6c 6564 286f  t_order_filled(o
-0000af90: 7264 6572 290a 2020 2020 2020 2020 2020  rder).          
-0000afa0: 2020 7265 7475 726e 206f 7264 6572 0a20    return order. 
-0000afb0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-0000afc0: 7945 7272 6f72 2061 7320 653a 0a20 2020  yError as e:.   
-0000afd0: 2020 2020 2020 2020 2066 726f 6d20 6672           from fr
-0000afe0: 6571 7472 6164 652e 7065 7273 6973 7465  eqtrade.persiste
-0000aff0: 6e63 6520 696d 706f 7274 204f 7264 6572  nce import Order
-0000b000: 0a20 2020 2020 2020 2020 2020 206f 7264  .            ord
-0000b010: 6572 203d 204f 7264 6572 2e6f 7264 6572  er = Order.order
-0000b020: 5f62 795f 6964 286f 7264 6572 5f69 6429  _by_id(order_id)
-0000b030: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000b040: 6f72 6465 723a 0a20 2020 2020 2020 2020  order:.         
-0000b050: 2020 2020 2020 2063 6378 745f 6f72 6465         ccxt_orde
-0000b060: 7220 3d20 6f72 6465 722e 746f 5f63 6378  r = order.to_ccx
-0000b070: 745f 6f62 6a65 6374 2829 0a20 2020 2020  t_object().     
-0000b080: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000b090: 5f64 7279 5f72 756e 5f6f 7065 6e5f 6f72  _dry_run_open_or
-0000b0a0: 6465 7273 5b6f 7264 6572 5f69 645d 203d  ders[order_id] =
-0000b0b0: 2063 6378 745f 6f72 6465 720a 2020 2020   ccxt_order.    
-0000b0c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000b0d0: 726e 2063 6378 745f 6f72 6465 720a 2020  rn ccxt_order.  
-0000b0e0: 2020 2020 2020 2020 2020 2320 4772 6163            # Grac
-0000b0f0: 6566 756c 6c79 2068 616e 646c 6520 6572  efully handle er
-0000b100: 726f 7273 2077 6974 6820 6472 792d 7275  rors with dry-ru
-0000b110: 6e20 6f72 6465 7273 2e0a 2020 2020 2020  n orders..      
-0000b120: 2020 2020 2020 7261 6973 6520 496e 7661        raise Inva
-0000b130: 6c69 644f 7264 6572 4578 6365 7074 696f  lidOrderExceptio
-0000b140: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-0000b150: 2020 2066 2754 7269 6564 2074 6f20 6765     f'Tried to ge
-0000b160: 7420 616e 2069 6e76 616c 6964 2064 7279  t an invalid dry
-0000b170: 2d72 756e 2d6f 7264 6572 2028 6964 3a20  -run-order (id: 
-0000b180: 7b6f 7264 6572 5f69 647d 292e 204d 6573  {order_id}). Mes
-0000b190: 7361 6765 3a20 7b65 7d27 2920 6672 6f6d  sage: {e}') from
-0000b1a0: 2065 0a0a 2020 2020 2320 4f72 6465 7220   e..    # Order 
-0000b1b0: 6861 6e64 6c69 6e67 0a0a 2020 2020 6465  handling..    de
-0000b1c0: 6620 5f6c 6576 5f70 7265 7028 7365 6c66  f _lev_prep(self
-0000b1d0: 2c20 7061 6972 3a20 7374 722c 206c 6576  , pair: str, lev
-0000b1e0: 6572 6167 653a 2066 6c6f 6174 2c20 7369  erage: float, si
-0000b1f0: 6465 3a20 4275 7953 656c 6c2c 2061 6363  de: BuySell, acc
-0000b200: 6570 745f 6661 696c 3a20 626f 6f6c 203d  ept_fail: bool =
-0000b210: 2046 616c 7365 293a 0a20 2020 2020 2020   False):.       
-0000b220: 2069 6620 7365 6c66 2e74 7261 6469 6e67   if self.trading
-0000b230: 5f6d 6f64 6520 213d 2054 7261 6469 6e67  _mode != Trading
-0000b240: 4d6f 6465 2e53 504f 543a 0a20 2020 2020  Mode.SPOT:.     
-0000b250: 2020 2020 2020 2073 656c 662e 7365 745f         self.set_
-0000b260: 6d61 7267 696e 5f6d 6f64 6528 7061 6972  margin_mode(pair
-0000b270: 2c20 7365 6c66 2e6d 6172 6769 6e5f 6d6f  , self.margin_mo
-0000b280: 6465 2c20 6163 6365 7074 5f66 6169 6c29  de, accept_fail)
-0000b290: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000b2a0: 662e 5f73 6574 5f6c 6576 6572 6167 6528  f._set_leverage(
-0000b2b0: 6c65 7665 7261 6765 2c20 7061 6972 2c20  leverage, pair, 
-0000b2c0: 6163 6365 7074 5f66 6169 6c29 0a0a 2020  accept_fail)..  
-0000b2d0: 2020 6465 6620 5f67 6574 5f70 6172 616d    def _get_param
-0000b2e0: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-0000b2f0: 0a20 2020 2020 2020 2073 6964 653a 2042  .        side: B
-0000b300: 7579 5365 6c6c 2c0a 2020 2020 2020 2020  uySell,.        
-0000b310: 6f72 6465 7274 7970 653a 2073 7472 2c0a  ordertype: str,.
-0000b320: 2020 2020 2020 2020 6c65 7665 7261 6765          leverage
-0000b330: 3a20 666c 6f61 742c 0a20 2020 2020 2020  : float,.       
-0000b340: 2072 6564 7563 654f 6e6c 793a 2062 6f6f   reduceOnly: boo
-0000b350: 6c2c 0a20 2020 2020 2020 2074 696d 655f  l,.        time_
-0000b360: 696e 5f66 6f72 6365 3a20 7374 7220 3d20  in_force: str = 
-0000b370: 2747 5443 272c 0a20 2020 2029 202d 3e20  'GTC',.    ) -> 
-0000b380: 4469 6374 3a0a 2020 2020 2020 2020 7061  Dict:.        pa
-0000b390: 7261 6d73 203d 2073 656c 662e 5f70 6172  rams = self._par
-0000b3a0: 616d 732e 636f 7079 2829 0a20 2020 2020  ams.copy().     
-0000b3b0: 2020 2069 6620 7469 6d65 5f69 6e5f 666f     if time_in_fo
-0000b3c0: 7263 6520 213d 2027 4754 4327 2061 6e64  rce != 'GTC' and
-0000b3d0: 206f 7264 6572 7479 7065 2021 3d20 276d   ordertype != 'm
-0000b3e0: 6172 6b65 7427 3a0a 2020 2020 2020 2020  arket':.        
-0000b3f0: 2020 2020 7061 7261 6d73 2e75 7064 6174      params.updat
-0000b400: 6528 7b27 7469 6d65 496e 466f 7263 6527  e({'timeInForce'
-0000b410: 3a20 7469 6d65 5f69 6e5f 666f 7263 652e  : time_in_force.
-0000b420: 7570 7065 7228 297d 290a 2020 2020 2020  upper()}).      
-0000b430: 2020 6966 2072 6564 7563 654f 6e6c 793a    if reduceOnly:
-0000b440: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-0000b450: 616d 732e 7570 6461 7465 287b 2772 6564  ams.update({'red
-0000b460: 7563 654f 6e6c 7927 3a20 5472 7565 7d29  uceOnly': True})
-0000b470: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b480: 7061 7261 6d73 0a0a 2020 2020 6465 6620  params..    def 
-0000b490: 5f6f 7264 6572 5f6e 6565 6473 5f70 7269  _order_needs_pri
-0000b4a0: 6365 2873 656c 662c 206f 7264 6572 7479  ce(self, orderty
-0000b4b0: 7065 3a20 7374 7229 202d 3e20 626f 6f6c  pe: str) -> bool
-0000b4c0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000b4d0: 2028 0a20 2020 2020 2020 2020 2020 206f   (.            o
-0000b4e0: 7264 6572 7479 7065 2021 3d20 276d 6172  rdertype != 'mar
-0000b4f0: 6b65 7427 0a20 2020 2020 2020 2020 2020  ket'.           
-0000b500: 206f 7220 7365 6c66 2e5f 6170 692e 6f70   or self._api.op
-0000b510: 7469 6f6e 732e 6765 7428 2263 7265 6174  tions.get("creat
-0000b520: 654d 6172 6b65 7442 7579 4f72 6465 7252  eMarketBuyOrderR
-0000b530: 6571 7569 7265 7350 7269 6365 222c 2046  equiresPrice", F
-0000b540: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
-0000b550: 2020 6f72 2073 656c 662e 5f66 745f 6861    or self._ft_ha
-0000b560: 732e 6765 7428 276d 6172 6b65 744f 7264  s.get('marketOrd
-0000b570: 6572 5265 7175 6972 6573 5072 6963 6527  erRequiresPrice'
-0000b580: 2c20 4661 6c73 6529 0a20 2020 2020 2020  , False).       
-0000b590: 2029 0a0a 2020 2020 6465 6620 6372 6561   )..    def crea
-0000b5a0: 7465 5f6f 7264 6572 280a 2020 2020 2020  te_order(.      
-0000b5b0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0000b5c0: 2a2c 0a20 2020 2020 2020 2070 6169 723a  *,.        pair:
-0000b5d0: 2073 7472 2c0a 2020 2020 2020 2020 6f72   str,.        or
-0000b5e0: 6465 7274 7970 653a 2073 7472 2c0a 2020  dertype: str,.  
-0000b5f0: 2020 2020 2020 7369 6465 3a20 4275 7953        side: BuyS
-0000b600: 656c 6c2c 0a20 2020 2020 2020 2061 6d6f  ell,.        amo
-0000b610: 756e 743a 2066 6c6f 6174 2c0a 2020 2020  unt: float,.    
-0000b620: 2020 2020 7261 7465 3a20 666c 6f61 742c      rate: float,
-0000b630: 0a20 2020 2020 2020 206c 6576 6572 6167  .        leverag
-0000b640: 653a 2066 6c6f 6174 2c0a 2020 2020 2020  e: float,.      
-0000b650: 2020 7265 6475 6365 4f6e 6c79 3a20 626f    reduceOnly: bo
-0000b660: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-0000b670: 2020 2020 7469 6d65 5f69 6e5f 666f 7263      time_in_forc
-0000b680: 653a 2073 7472 203d 2027 4754 4327 2c0a  e: str = 'GTC',.
-0000b690: 2020 2020 2920 2d3e 2044 6963 743a 0a20      ) -> Dict:. 
-0000b6a0: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-0000b6b0: 636f 6e66 6967 5b27 6472 795f 7275 6e27  config['dry_run'
-0000b6c0: 5d3a 0a20 2020 2020 2020 2020 2020 2064  ]:.            d
-0000b6d0: 7279 5f6f 7264 6572 203d 2073 656c 662e  ry_order = self.
-0000b6e0: 6372 6561 7465 5f64 7279 5f72 756e 5f6f  create_dry_run_o
-0000b6f0: 7264 6572 280a 2020 2020 2020 2020 2020  rder(.          
-0000b700: 2020 2020 2020 7061 6972 2c20 6f72 6465        pair, orde
-0000b710: 7274 7970 652c 2073 6964 652c 2061 6d6f  rtype, side, amo
-0000b720: 756e 742c 2073 656c 662e 7072 6963 655f  unt, self.price_
-0000b730: 746f 5f70 7265 6369 7369 6f6e 2870 6169  to_precision(pai
-0000b740: 722c 2072 6174 6529 2c20 6c65 7665 7261  r, rate), levera
-0000b750: 6765 290a 2020 2020 2020 2020 2020 2020  ge).            
-0000b760: 7265 7475 726e 2064 7279 5f6f 7264 6572  return dry_order
-0000b770: 0a0a 2020 2020 2020 2020 7061 7261 6d73  ..        params
-0000b780: 203d 2073 656c 662e 5f67 6574 5f70 6172   = self._get_par
-0000b790: 616d 7328 7369 6465 2c20 6f72 6465 7274  ams(side, ordert
-0000b7a0: 7970 652c 206c 6576 6572 6167 652c 2072  ype, leverage, r
-0000b7b0: 6564 7563 654f 6e6c 792c 2074 696d 655f  educeOnly, time_
-0000b7c0: 696e 5f66 6f72 6365 290a 0a20 2020 2020  in_force)..     
-0000b7d0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000b7e0: 2020 2020 2320 5365 7420 7468 6520 7072      # Set the pr
-0000b7f0: 6563 6973 696f 6e20 666f 7220 616d 6f75  ecision for amou
-0000b800: 6e74 2061 6e64 2070 7269 6365 2872 6174  nt and price(rat
-0000b810: 6529 2061 7320 6163 6365 7074 6564 2062  e) as accepted b
-0000b820: 7920 7468 6520 6578 6368 616e 6765 0a20  y the exchange. 
-0000b830: 2020 2020 2020 2020 2020 2061 6d6f 756e             amoun
-0000b840: 7420 3d20 7365 6c66 2e61 6d6f 756e 745f  t = self.amount_
-0000b850: 746f 5f70 7265 6369 7369 6f6e 2870 6169  to_precision(pai
-0000b860: 722c 2073 656c 662e 5f61 6d6f 756e 745f  r, self._amount_
-0000b870: 746f 5f63 6f6e 7472 6163 7473 2870 6169  to_contracts(pai
-0000b880: 722c 2061 6d6f 756e 7429 290a 2020 2020  r, amount)).    
-0000b890: 2020 2020 2020 2020 6e65 6564 735f 7072          needs_pr
-0000b8a0: 6963 6520 3d20 7365 6c66 2e5f 6f72 6465  ice = self._orde
-0000b8b0: 725f 6e65 6564 735f 7072 6963 6528 6f72  r_needs_price(or
-0000b8c0: 6465 7274 7970 6529 0a20 2020 2020 2020  dertype).       
-0000b8d0: 2020 2020 2072 6174 655f 666f 725f 6f72       rate_for_or
-0000b8e0: 6465 7220 3d20 7365 6c66 2e70 7269 6365  der = self.price
-0000b8f0: 5f74 6f5f 7072 6563 6973 696f 6e28 7061  _to_precision(pa
-0000b900: 6972 2c20 7261 7465 2920 6966 206e 6565  ir, rate) if nee
-0000b910: 6473 5f70 7269 6365 2065 6c73 6520 4e6f  ds_price else No
-0000b920: 6e65 0a0a 2020 2020 2020 2020 2020 2020  ne..            
-0000b930: 6966 206e 6f74 2072 6564 7563 654f 6e6c  if not reduceOnl
-0000b940: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000b950: 2020 2073 656c 662e 5f6c 6576 5f70 7265     self._lev_pre
-0000b960: 7028 7061 6972 2c20 6c65 7665 7261 6765  p(pair, leverage
-0000b970: 2c20 7369 6465 290a 0a20 2020 2020 2020  , side)..       
-0000b980: 2020 2020 206f 7264 6572 203d 2073 656c       order = sel
-0000b990: 662e 5f61 7069 2e63 7265 6174 655f 6f72  f._api.create_or
-0000b9a0: 6465 7228 0a20 2020 2020 2020 2020 2020  der(.           
-0000b9b0: 2020 2020 2070 6169 722c 0a20 2020 2020       pair,.     
-0000b9c0: 2020 2020 2020 2020 2020 206f 7264 6572             order
-0000b9d0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
-0000b9e0: 2020 2020 2020 7369 6465 2c0a 2020 2020        side,.    
-0000b9f0: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
-0000ba00: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0000ba10: 2020 2020 7261 7465 5f66 6f72 5f6f 7264      rate_for_ord
-0000ba20: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-0000ba30: 2020 2020 7061 7261 6d73 2c0a 2020 2020      params,.    
-0000ba40: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000ba50: 2020 2020 2020 7365 6c66 2e5f 6c6f 675f        self._log_
-0000ba60: 6578 6368 616e 6765 5f72 6573 706f 6e73  exchange_respons
-0000ba70: 6528 2763 7265 6174 655f 6f72 6465 7227  e('create_order'
-0000ba80: 2c20 6f72 6465 7229 0a20 2020 2020 2020  , order).       
-0000ba90: 2020 2020 206f 7264 6572 203d 2073 656c       order = sel
-0000baa0: 662e 5f6f 7264 6572 5f63 6f6e 7472 6163  f._order_contrac
-0000bab0: 7473 5f74 6f5f 616d 6f75 6e74 286f 7264  ts_to_amount(ord
-0000bac0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-0000bad0: 7265 7475 726e 206f 7264 6572 0a0a 2020  return order..  
-0000bae0: 2020 2020 2020 6578 6365 7074 2063 6378        except ccx
-0000baf0: 742e 496e 7375 6666 6963 6965 6e74 4675  t.InsufficientFu
-0000bb00: 6e64 7320 6173 2065 3a0a 2020 2020 2020  nds as e:.      
-0000bb10: 2020 2020 2020 7261 6973 6520 496e 7375        raise Insu
-0000bb20: 6666 6963 6965 6e74 4675 6e64 7345 7272  fficientFundsErr
-0000bb30: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000bb40: 2020 2020 6627 496e 7375 6666 6963 6965      f'Insufficie
-0000bb50: 6e74 2066 756e 6473 2074 6f20 6372 6561  nt funds to crea
-0000bb60: 7465 207b 6f72 6465 7274 7970 657d 207b  te {ordertype} {
-0000bb70: 7369 6465 7d20 6f72 6465 7220 6f6e 206d  side} order on m
-0000bb80: 6172 6b65 7420 7b70 6169 727d 2e20 270a  arket {pair}. '.
-0000bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bba0: 6627 5472 6965 6420 746f 207b 7369 6465  f'Tried to {side
-0000bbb0: 7d20 616d 6f75 6e74 207b 616d 6f75 6e74  } amount {amount
-0000bbc0: 7d20 6174 2072 6174 6520 7b72 6174 657d  } at rate {rate}
-0000bbd0: 2e27 0a20 2020 2020 2020 2020 2020 2020  .'.             
-0000bbe0: 2020 2066 274d 6573 7361 6765 3a20 7b65     f'Message: {e
-0000bbf0: 7d27 2920 6672 6f6d 2065 0a20 2020 2020  }') from e.     
-0000bc00: 2020 2065 7863 6570 7420 6363 7874 2e49     except ccxt.I
-0000bc10: 6e76 616c 6964 4f72 6465 7220 6173 2065  nvalidOrder as e
-0000bc20: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000bc30: 6973 6520 496e 7661 6c69 644f 7264 6572  ise InvalidOrder
-0000bc40: 4578 6365 7074 696f 6e28 0a20 2020 2020  Exception(.     
-0000bc50: 2020 2020 2020 2020 2020 2066 2743 6f75             f'Cou
-0000bc60: 6c64 206e 6f74 2063 7265 6174 6520 7b6f  ld not create {o
-0000bc70: 7264 6572 7479 7065 7d20 7b73 6964 657d  rdertype} {side}
-0000bc80: 206f 7264 6572 206f 6e20 6d61 726b 6574   order on market
-0000bc90: 207b 7061 6972 7d2e 2027 0a20 2020 2020   {pair}. '.     
-0000bca0: 2020 2020 2020 2020 2020 2066 2754 7269             f'Tri
-0000bcb0: 6564 2074 6f20 7b73 6964 657d 2061 6d6f  ed to {side} amo
-0000bcc0: 756e 7420 7b61 6d6f 756e 747d 2061 7420  unt {amount} at 
-0000bcd0: 7261 7465 207b 7261 7465 7d2e 2027 0a20  rate {rate}. '. 
-0000bce0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000bcf0: 274d 6573 7361 6765 3a20 7b65 7d27 2920  'Message: {e}') 
-0000bd00: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
-0000bd10: 7863 6570 7420 6363 7874 2e44 446f 5350  xcept ccxt.DDoSP
-0000bd20: 726f 7465 6374 696f 6e20 6173 2065 3a0a  rotection as e:.
-0000bd30: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000bd40: 6520 4444 6f73 5072 6f74 6563 7469 6f6e  e DDosProtection
-0000bd50: 2865 2920 6672 6f6d 2065 0a20 2020 2020  (e) from e.     
-0000bd60: 2020 2065 7863 6570 7420 2863 6378 742e     except (ccxt.
-0000bd70: 4e65 7477 6f72 6b45 7272 6f72 2c20 6363  NetworkError, cc
-0000bd80: 7874 2e45 7863 6861 6e67 6545 7272 6f72  xt.ExchangeError
-0000bd90: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
-0000bda0: 2020 2020 7261 6973 6520 5465 6d70 6f72      raise Tempor
-0000bdb0: 6172 7945 7272 6f72 280a 2020 2020 2020  aryError(.      
-0000bdc0: 2020 2020 2020 2020 2020 6627 436f 756c            f'Coul
-0000bdd0: 6420 6e6f 7420 706c 6163 6520 7b73 6964  d not place {sid
-0000bde0: 657d 206f 7264 6572 2064 7565 2074 6f20  e} order due to 
-0000bdf0: 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  {e.__class__.__n
-0000be00: 616d 655f 5f7d 2e20 4d65 7373 6167 653a  ame__}. Message:
-0000be10: 207b 657d 2729 2066 726f 6d20 650a 2020   {e}') from e.  
-0000be20: 2020 2020 2020 6578 6365 7074 2063 6378        except ccx
-0000be30: 742e 4261 7365 4572 726f 7220 6173 2065  t.BaseError as e
-0000be40: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000be50: 6973 6520 4f70 6572 6174 696f 6e61 6c45  ise OperationalE
-0000be60: 7863 6570 7469 6f6e 2865 2920 6672 6f6d  xception(e) from
-0000be70: 2065 0a0a 2020 2020 6465 6620 7374 6f70   e..    def stop
-0000be80: 6c6f 7373 5f61 646a 7573 7428 7365 6c66  loss_adjust(self
-0000be90: 2c20 7374 6f70 5f6c 6f73 733a 2066 6c6f  , stop_loss: flo
-0000bea0: 6174 2c20 6f72 6465 723a 2044 6963 742c  at, order: Dict,
-0000beb0: 2073 6964 653a 2073 7472 2920 2d3e 2062   side: str) -> b
-0000bec0: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
-0000bed0: 0a20 2020 2020 2020 2056 6572 6966 7920  .        Verify 
-0000bee0: 7374 6f70 5f6c 6f73 7320 6167 6169 6e73  stop_loss agains
-0000bef0: 7420 7374 6f70 6c6f 7373 2d6f 7264 6572  t stoploss-order
-0000bf00: 2076 616c 7565 2028 6c69 6d69 7420 6f72   value (limit or
-0000bf10: 2070 7269 6365 290a 2020 2020 2020 2020   price).        
-0000bf20: 5265 7475 726e 7320 5472 7565 2069 6620  Returns True if 
-0000bf30: 6164 6a75 7374 6d65 6e74 2069 7320 6e65  adjustment is ne
-0000bf40: 6365 7373 6172 792e 0a20 2020 2020 2020  cessary..       
-0000bf50: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-0000bf60: 6e6f 7420 7365 6c66 2e5f 6674 5f68 6173  not self._ft_has
-0000bf70: 2e67 6574 2827 7374 6f70 6c6f 7373 5f6f  .get('stoploss_o
-0000bf80: 6e5f 6578 6368 616e 6765 2729 3a0a 2020  n_exchange'):.  
-0000bf90: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000bfa0: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
-0000bfb0: 7469 6f6e 2866 2273 746f 706c 6f73 7320  tion(f"stoploss 
-0000bfc0: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-0000bfd0: 6564 2066 6f72 207b 7365 6c66 2e6e 616d  ed for {self.nam
-0000bfe0: 657d 2e22 290a 2020 2020 2020 2020 7072  e}.").        pr
-0000bff0: 6963 655f 7061 7261 6d20 3d20 7365 6c66  ice_param = self
-0000c000: 2e5f 6674 5f68 6173 5b27 7374 6f70 5f70  ._ft_has['stop_p
-0000c010: 7269 6365 5f70 6172 616d 275d 0a20 2020  rice_param'].   
-0000c020: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
-0000c030: 2020 2020 2020 2020 2020 6f72 6465 722e            order.
-0000c040: 6765 7428 7072 6963 655f 7061 7261 6d2c  get(price_param,
-0000c050: 204e 6f6e 6529 2069 7320 4e6f 6e65 0a20   None) is None. 
-0000c060: 2020 2020 2020 2020 2020 206f 7220 2828             or ((
-0000c070: 7369 6465 203d 3d20 2273 656c 6c22 2061  side == "sell" a
-0000c080: 6e64 2073 746f 705f 6c6f 7373 203e 2066  nd stop_loss > f
-0000c090: 6c6f 6174 286f 7264 6572 5b70 7269 6365  loat(order[price
-0000c0a0: 5f70 6172 616d 5d29 2920 6f72 0a20 2020  _param])) or.   
-0000c0b0: 2020 2020 2020 2020 2020 2020 2028 7369               (si
-0000c0c0: 6465 203d 3d20 2262 7579 2220 616e 6420  de == "buy" and 
-0000c0d0: 7374 6f70 5f6c 6f73 7320 3c20 666c 6f61  stop_loss < floa
-0000c0e0: 7428 6f72 6465 725b 7072 6963 655f 7061  t(order[price_pa
-0000c0f0: 7261 6d5d 2929 290a 2020 2020 2020 2020  ram]))).        
-0000c100: 290a 0a20 2020 2064 6566 205f 6765 745f  )..    def _get_
-0000c110: 7374 6f70 5f6f 7264 6572 5f74 7970 6528  stop_order_type(
-0000c120: 7365 6c66 2c20 7573 6572 5f6f 7264 6572  self, user_order
-0000c130: 5f74 7970 6529 202d 3e20 5475 706c 655b  _type) -> Tuple[
-0000c140: 7374 722c 2073 7472 5d3a 0a0a 2020 2020  str, str]:..    
-0000c150: 2020 2020 6176 6169 6c61 626c 655f 6f72      available_or
-0000c160: 6465 725f 5479 7065 733a 2044 6963 745b  der_Types: Dict[
-0000c170: 7374 722c 2073 7472 5d20 3d20 7365 6c66  str, str] = self
-0000c180: 2e5f 6674 5f68 6173 5b22 7374 6f70 6c6f  ._ft_has["stoplo
-0000c190: 7373 5f6f 7264 6572 5f74 7970 6573 225d  ss_order_types"]
-0000c1a0: 0a0a 2020 2020 2020 2020 6966 2075 7365  ..        if use
-0000c1b0: 725f 6f72 6465 725f 7479 7065 2069 6e20  r_order_type in 
-0000c1c0: 6176 6169 6c61 626c 655f 6f72 6465 725f  available_order_
-0000c1d0: 5479 7065 732e 6b65 7973 2829 3a0a 2020  Types.keys():.  
-0000c1e0: 2020 2020 2020 2020 2020 6f72 6465 7274            ordert
-0000c1f0: 7970 6520 3d20 6176 6169 6c61 626c 655f  ype = available_
-0000c200: 6f72 6465 725f 5479 7065 735b 7573 6572  order_Types[user
-0000c210: 5f6f 7264 6572 5f74 7970 655d 0a20 2020  _order_type].   
-0000c220: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000c230: 2020 2020 2020 2023 204f 7468 6572 7769         # Otherwi
-0000c240: 7365 2070 6963 6b20 6f6e 6c79 206f 6e65  se pick only one
-0000c250: 2061 7661 696c 6162 6c65 0a20 2020 2020   available.     
-0000c260: 2020 2020 2020 206f 7264 6572 7479 7065         ordertype
-0000c270: 203d 206c 6973 7428 6176 6169 6c61 626c   = list(availabl
-0000c280: 655f 6f72 6465 725f 5479 7065 732e 7661  e_order_Types.va
-0000c290: 6c75 6573 2829 295b 305d 0a20 2020 2020  lues())[0].     
-0000c2a0: 2020 2020 2020 2075 7365 725f 6f72 6465         user_orde
-0000c2b0: 725f 7479 7065 203d 206c 6973 7428 6176  r_type = list(av
-0000c2c0: 6169 6c61 626c 655f 6f72 6465 725f 5479  ailable_order_Ty
-0000c2d0: 7065 732e 6b65 7973 2829 295b 305d 0a20  pes.keys())[0]. 
-0000c2e0: 2020 2020 2020 2072 6574 7572 6e20 6f72         return or
-0000c2f0: 6465 7274 7970 652c 2075 7365 725f 6f72  dertype, user_or
-0000c300: 6465 725f 7479 7065 0a0a 2020 2020 6465  der_type..    de
-0000c310: 6620 5f67 6574 5f73 746f 705f 6c69 6d69  f _get_stop_limi
-0000c320: 745f 7261 7465 2873 656c 662c 2073 746f  t_rate(self, sto
-0000c330: 705f 7072 6963 653a 2066 6c6f 6174 2c20  p_price: float, 
-0000c340: 6f72 6465 725f 7479 7065 733a 2044 6963  order_types: Dic
-0000c350: 742c 2073 6964 653a 2073 7472 2920 2d3e  t, side: str) ->
-0000c360: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
-0000c370: 2320 4c69 6d69 7420 7072 6963 6520 7468  # Limit price th
-0000c380: 7265 7368 6f6c 643a 2041 7320 6c69 6d69  reshold: As limi
-0000c390: 7420 7072 6963 6520 7368 6f75 6c64 2061  t price should a
-0000c3a0: 6c77 6179 7320 6265 2062 656c 6f77 2073  lways be below s
-0000c3b0: 746f 702d 7072 6963 650a 2020 2020 2020  top-price.      
-0000c3c0: 2020 6c69 6d69 745f 7072 6963 655f 7063    limit_price_pc
-0000c3d0: 7420 3d20 6f72 6465 725f 7479 7065 732e  t = order_types.
-0000c3e0: 6765 7428 2773 746f 706c 6f73 735f 6f6e  get('stoploss_on
-0000c3f0: 5f65 7863 6861 6e67 655f 6c69 6d69 745f  _exchange_limit_
-0000c400: 7261 7469 6f27 2c20 302e 3939 290a 2020  ratio', 0.99).  
-0000c410: 2020 2020 2020 6966 2073 6964 6520 3d3d        if side ==
-0000c420: 2022 7365 6c6c 223a 0a20 2020 2020 2020   "sell":.       
-0000c430: 2020 2020 206c 696d 6974 5f72 6174 6520       limit_rate 
-0000c440: 3d20 7374 6f70 5f70 7269 6365 202a 206c  = stop_price * l
-0000c450: 696d 6974 5f70 7269 6365 5f70 6374 0a20  imit_price_pct. 
-0000c460: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000c470: 2020 2020 2020 2020 206c 696d 6974 5f72           limit_r
-0000c480: 6174 6520 3d20 7374 6f70 5f70 7269 6365  ate = stop_price
-0000c490: 202a 2028 3220 2d20 6c69 6d69 745f 7072   * (2 - limit_pr
-0000c4a0: 6963 655f 7063 7429 0a0a 2020 2020 2020  ice_pct)..      
-0000c4b0: 2020 6261 645f 7374 6f70 5f70 7269 6365    bad_stop_price
-0000c4c0: 203d 2028 2873 746f 705f 7072 6963 6520   = ((stop_price 
-0000c4d0: 3c3d 206c 696d 6974 5f72 6174 6529 2069  <= limit_rate) i
-0000c4e0: 6620 7369 6465 203d 3d0a 2020 2020 2020  f side ==.      
-0000c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c500: 2020 2020 2273 656c 6c22 2065 6c73 6520      "sell" else 
-0000c510: 2873 746f 705f 7072 6963 6520 3e3d 206c  (stop_price >= l
-0000c520: 696d 6974 5f72 6174 6529 290a 2020 2020  imit_rate)).    
-0000c530: 2020 2020 2320 456e 7375 7265 2072 6174      # Ensure rat
-0000c540: 6520 6973 206c 6573 7320 7468 616e 2073  e is less than s
-0000c550: 746f 7020 7072 6963 650a 2020 2020 2020  top price.      
-0000c560: 2020 6966 2062 6164 5f73 746f 705f 7072    if bad_stop_pr
-0000c570: 6963 653a 0a20 2020 2020 2020 2020 2020  ice:.           
-0000c580: 2023 2054 6869 7320 6361 6e20 666f 7220   # This can for 
-0000c590: 6578 616d 706c 6520 6861 7070 656e 2069  example happen i
-0000c5a0: 6620 7468 6520 7374 6f70 202f 206c 6971  f the stop / liq
-0000c5b0: 7569 6461 7469 6f6e 2070 7269 6365 2069  uidation price i
-0000c5c0: 7320 7365 7420 746f 2030 0a20 2020 2020  s set to 0.     
-0000c5d0: 2020 2020 2020 2023 2057 6869 6368 2069         # Which i
-0000c5e0: 7320 706f 7373 6962 6c65 2069 6620 6120  s possible if a 
-0000c5f0: 6d61 726b 6574 2d6f 7264 6572 2063 6c6f  market-order clo
-0000c600: 7365 7320 7269 6768 7420 6177 6179 2e0a  ses right away..
-0000c610: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-0000c620: 6520 496e 7661 6c69 644f 7264 6572 4578  e InvalidOrderEx
-0000c630: 6365 7074 696f 6e20 7769 6c6c 2062 7562  ception will bub
-0000c640: 626c 6520 7570 2074 6f20 6578 6974 5f70  ble up to exit_p
-0000c650: 6f73 6974 696f 6e73 2c20 7768 6572 6520  ositions, where 
-0000c660: 6974 2077 696c 6c20 6265 0a20 2020 2020  it will be.     
-0000c670: 2020 2020 2020 2023 2068 616e 646c 6564         # handled
-0000c680: 2067 7261 6365 6675 6c6c 792e 0a20 2020   gracefully..   
-0000c690: 2020 2020 2020 2020 2072 6169 7365 2049           raise I
-0000c6a0: 6e76 616c 6964 4f72 6465 7245 7863 6570  nvalidOrderExcep
-0000c6b0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-0000c6c0: 2020 2020 2020 2249 6e20 7374 6f70 6c6f        "In stoplo
-0000c6d0: 7373 206c 696d 6974 206f 7264 6572 2c20  ss limit order, 
-0000c6e0: 7374 6f70 2070 7269 6365 2073 686f 756c  stop price shoul
-0000c6f0: 6420 6265 206d 6f72 6520 7468 616e 206c  d be more than l
-0000c700: 696d 6974 2070 7269 6365 2e20 220a 2020  imit price. ".  
-0000c710: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0000c720: 5374 6f70 2070 7269 6365 3a20 7b73 746f  Stop price: {sto
-0000c730: 705f 7072 6963 657d 2c20 4c69 6d69 7420  p_price}, Limit 
-0000c740: 7072 6963 653a 207b 6c69 6d69 745f 7261  price: {limit_ra
-0000c750: 7465 7d2c 2022 0a20 2020 2020 2020 2020  te}, ".         
-0000c760: 2020 2020 2020 2066 224c 696d 6974 2050         f"Limit P
-0000c770: 7269 6365 2070 6374 3a20 7b6c 696d 6974  rice pct: {limit
-0000c780: 5f70 7269 6365 5f70 6374 7d22 0a20 2020  _price_pct}".   
-0000c790: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0000c7a0: 2020 2020 2020 2072 6574 7572 6e20 6c69         return li
-0000c7b0: 6d69 745f 7261 7465 0a0a 2020 2020 6465  mit_rate..    de
-0000c7c0: 6620 5f67 6574 5f73 746f 705f 7061 7261  f _get_stop_para
-0000c7d0: 6d73 2873 656c 662c 2073 6964 653a 2042  ms(self, side: B
-0000c7e0: 7579 5365 6c6c 2c20 6f72 6465 7274 7970  uySell, ordertyp
-0000c7f0: 653a 2073 7472 2c20 7374 6f70 5f70 7269  e: str, stop_pri
-0000c800: 6365 3a20 666c 6f61 7429 202d 3e20 4469  ce: float) -> Di
-0000c810: 6374 3a0a 2020 2020 2020 2020 7061 7261  ct:.        para
-0000c820: 6d73 203d 2073 656c 662e 5f70 6172 616d  ms = self._param
-0000c830: 732e 636f 7079 2829 0a20 2020 2020 2020  s.copy().       
-0000c840: 2023 2056 6572 6966 7920 6966 2073 746f   # Verify if sto
-0000c850: 7050 7269 6365 2077 6f72 6b73 2066 6f72  pPrice works for
-0000c860: 2079 6f75 7220 6578 6368 616e 6765 2c20   your exchange, 
-0000c870: 656c 7365 2063 6f6e 6669 6775 7265 2073  else configure s
-0000c880: 746f 705f 7072 6963 655f 7061 7261 6d0a  top_price_param.
-0000c890: 2020 2020 2020 2020 7061 7261 6d73 2e75          params.u
-0000c8a0: 7064 6174 6528 7b73 656c 662e 5f66 745f  pdate({self._ft_
-0000c8b0: 6861 735b 2773 746f 705f 7072 6963 655f  has['stop_price_
-0000c8c0: 7061 7261 6d27 5d3a 2073 746f 705f 7072  param']: stop_pr
-0000c8d0: 6963 657d 290a 2020 2020 2020 2020 7265  ice}).        re
-0000c8e0: 7475 726e 2070 6172 616d 730a 0a20 2020  turn params..   
-0000c8f0: 2040 7265 7472 6965 7228 7265 7472 6965   @retrier(retrie
-0000c900: 733d 3029 0a20 2020 2064 6566 2063 7265  s=0).    def cre
-0000c910: 6174 655f 7374 6f70 6c6f 7373 2873 656c  ate_stoploss(sel
-0000c920: 662c 2070 6169 723a 2073 7472 2c20 616d  f, pair: str, am
-0000c930: 6f75 6e74 3a20 666c 6f61 742c 2073 746f  ount: float, sto
-0000c940: 705f 7072 6963 653a 2066 6c6f 6174 2c20  p_price: float, 
-0000c950: 6f72 6465 725f 7479 7065 733a 2044 6963  order_types: Dic
-0000c960: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0000c970: 2020 2020 2020 2020 2020 2073 6964 653a             side:
-0000c980: 2042 7579 5365 6c6c 2c20 6c65 7665 7261   BuySell, levera
-0000c990: 6765 3a20 666c 6f61 7429 202d 3e20 4469  ge: float) -> Di
-0000c9a0: 6374 3a0a 2020 2020 2020 2020 2222 220a  ct:.        """.
-0000c9b0: 2020 2020 2020 2020 6372 6561 7465 7320          creates 
-0000c9c0: 6120 7374 6f70 6c6f 7373 206f 7264 6572  a stoploss order
-0000c9d0: 2e0a 2020 2020 2020 2020 7265 7175 6972  ..        requir
-0000c9e0: 6573 2060 5f66 745f 6861 735b 2773 746f  es `_ft_has['sto
-0000c9f0: 706c 6f73 735f 6f72 6465 725f 7479 7065  ploss_order_type
-0000ca00: 7327 5d60 2074 6f20 6265 2073 6574 2061  s']` to be set a
-0000ca10: 7320 6120 6469 6374 206d 6170 7069 6e67  s a dict mapping
-0000ca20: 206c 696d 6974 2061 6e64 206d 6172 6b65   limit and marke
-0000ca30: 740a 2020 2020 2020 2020 2020 2020 746f  t.            to
-0000ca40: 2074 6865 2063 6f72 7265 7370 6f6e 6469   the correspondi
-0000ca50: 6e67 2065 7863 6861 6e67 6520 7479 7065  ng exchange type
-0000ca60: 2e0a 0a20 2020 2020 2020 2054 6865 2070  ...        The p
-0000ca70: 7265 6369 7365 206f 7264 6572 7479 7065  recise ordertype
-0000ca80: 2069 7320 6465 7465 726d 696e 6564 2062   is determined b
-0000ca90: 7920 7468 6520 6f72 6465 725f 7479 7065  y the order_type
-0000caa0: 7320 6469 6374 206f 7220 6578 6368 616e  s dict or exchan
-0000cab0: 6765 2064 6566 6175 6c74 2e0a 0a20 2020  ge default...   
-0000cac0: 2020 2020 2054 6865 2065 7863 6570 7469       The excepti
-0000cad0: 6f6e 2062 656c 6f77 2073 686f 756c 6420  on below should 
-0000cae0: 6e65 7665 7220 7261 6973 652c 2073 696e  never raise, sin
-0000caf0: 6365 2077 6520 6469 7361 6c6c 6f77 0a20  ce we disallow. 
-0000cb00: 2020 2020 2020 2073 7461 7274 696e 6720         starting 
-0000cb10: 7468 6520 626f 7420 696e 2076 616c 6964  the bot in valid
-0000cb20: 6174 655f 6f72 6465 7274 7970 6573 2829  ate_ordertypes()
-0000cb30: 0a0a 2020 2020 2020 2020 5468 6973 206d  ..        This m
-0000cb40: 6179 2077 6f72 6b20 7769 7468 2061 206c  ay work with a l
-0000cb50: 696d 6974 6564 206e 756d 6265 7220 6f66  imited number of
-0000cb60: 206f 7468 6572 2065 7863 6861 6e67 6573   other exchanges
-0000cb70: 2c20 6275 7420 636f 7272 6563 7420 776f  , but correct wo
-0000cb80: 726b 696e 670a 2020 2020 2020 2020 2020  rking.          
-0000cb90: 2020 6e65 6564 7320 746f 2062 6520 7465    needs to be te
-0000cba0: 7374 6564 2069 6e64 6976 6964 7561 6c6c  sted individuall
-0000cbb0: 792e 0a20 2020 2020 2020 2057 4152 4e49  y..        WARNI
-0000cbc0: 4e47 3a20 7365 7474 696e 6720 6073 746f  NG: setting `sto
-0000cbd0: 706c 6f73 735f 6f6e 5f65 7863 6861 6e67  ploss_on_exchang
-0000cbe0: 6560 2074 6f20 5472 7565 2077 696c 6c20  e` to True will 
-0000cbf0: 4e4f 5420 6175 746f 2d65 6e61 626c 6520  NOT auto-enable 
-0000cc00: 7374 6f70 6c6f 7373 206f 6e20 6578 6368  stoploss on exch
-0000cc10: 616e 6765 2e0a 2020 2020 2020 2020 2020  ange..          
-0000cc20: 2020 6073 746f 706c 6f73 735f 6164 6a75    `stoploss_adju
-0000cc30: 7374 6020 6d75 7374 2073 7469 6c6c 2062  st` must still b
-0000cc40: 6520 696d 706c 656d 656e 7465 6420 666f  e implemented fo
-0000cc50: 7220 7468 6973 2074 6f20 776f 726b 2e0a  r this to work..
-0000cc60: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000cc70: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-0000cc80: 5f66 745f 6861 735b 2773 746f 706c 6f73  _ft_has['stoplos
-0000cc90: 735f 6f6e 5f65 7863 6861 6e67 6527 5d3a  s_on_exchange']:
-0000cca0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000ccb0: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
-0000ccc0: 6365 7074 696f 6e28 6622 7374 6f70 6c6f  ception(f"stoplo
-0000ccd0: 7373 2069 7320 6e6f 7420 696d 706c 656d  ss is not implem
-0000cce0: 656e 7465 6420 666f 7220 7b73 656c 662e  ented for {self.
-0000ccf0: 6e61 6d65 7d2e 2229 0a0a 2020 2020 2020  name}.")..      
-0000cd00: 2020 7573 6572 5f6f 7264 6572 5f74 7970    user_order_typ
-0000cd10: 6520 3d20 6f72 6465 725f 7479 7065 732e  e = order_types.
-0000cd20: 6765 7428 2773 746f 706c 6f73 7327 2c20  get('stoploss', 
-0000cd30: 276d 6172 6b65 7427 290a 2020 2020 2020  'market').      
-0000cd40: 2020 6f72 6465 7274 7970 652c 2075 7365    ordertype, use
-0000cd50: 725f 6f72 6465 725f 7479 7065 203d 2073  r_order_type = s
-0000cd60: 656c 662e 5f67 6574 5f73 746f 705f 6f72  elf._get_stop_or
-0000cd70: 6465 725f 7479 7065 2875 7365 725f 6f72  der_type(user_or
-0000cd80: 6465 725f 7479 7065 290a 2020 2020 2020  der_type).      
-0000cd90: 2020 726f 756e 645f 6d6f 6465 203d 2052    round_mode = R
-0000cda0: 4f55 4e44 5f44 4f57 4e20 6966 2073 6964  OUND_DOWN if sid
-0000cdb0: 6520 3d3d 2027 6275 7927 2065 6c73 6520  e == 'buy' else 
-0000cdc0: 524f 554e 445f 5550 0a20 2020 2020 2020  ROUND_UP.       
-0000cdd0: 2073 746f 705f 7072 6963 655f 6e6f 726d   stop_price_norm
-0000cde0: 203d 2073 656c 662e 7072 6963 655f 746f   = self.price_to
-0000cdf0: 5f70 7265 6369 7369 6f6e 2870 6169 722c  _precision(pair,
-0000ce00: 2073 746f 705f 7072 6963 652c 2072 6f75   stop_price, rou
-0000ce10: 6e64 696e 675f 6d6f 6465 3d72 6f75 6e64  nding_mode=round
-0000ce20: 5f6d 6f64 6529 0a20 2020 2020 2020 206c  _mode).        l
-0000ce30: 696d 6974 5f72 6174 6520 3d20 4e6f 6e65  imit_rate = None
-0000ce40: 0a20 2020 2020 2020 2069 6620 7573 6572  .        if user
-0000ce50: 5f6f 7264 6572 5f74 7970 6520 3d3d 2027  _order_type == '
-0000ce60: 6c69 6d69 7427 3a0a 2020 2020 2020 2020  limit':.        
-0000ce70: 2020 2020 6c69 6d69 745f 7261 7465 203d      limit_rate =
-0000ce80: 2073 656c 662e 5f67 6574 5f73 746f 705f   self._get_stop_
-0000ce90: 6c69 6d69 745f 7261 7465 2873 746f 705f  limit_rate(stop_
-0000cea0: 7072 6963 652c 206f 7264 6572 5f74 7970  price, order_typ
-0000ceb0: 6573 2c20 7369 6465 290a 2020 2020 2020  es, side).      
-0000cec0: 2020 2020 2020 6c69 6d69 745f 7261 7465        limit_rate
-0000ced0: 203d 2073 656c 662e 7072 6963 655f 746f   = self.price_to
-0000cee0: 5f70 7265 6369 7369 6f6e 2870 6169 722c  _precision(pair,
-0000cef0: 206c 696d 6974 5f72 6174 652c 2072 6f75   limit_rate, rou
-0000cf00: 6e64 696e 675f 6d6f 6465 3d72 6f75 6e64  nding_mode=round
-0000cf10: 5f6d 6f64 6529 0a0a 2020 2020 2020 2020  _mode)..        
-0000cf20: 6966 2073 656c 662e 5f63 6f6e 6669 675b  if self._config[
-0000cf30: 2764 7279 5f72 756e 275d 3a0a 2020 2020  'dry_run']:.    
-0000cf40: 2020 2020 2020 2020 6472 795f 6f72 6465          dry_orde
-0000cf50: 7220 3d20 7365 6c66 2e63 7265 6174 655f  r = self.create_
-0000cf60: 6472 795f 7275 6e5f 6f72 6465 7228 0a20  dry_run_order(. 
-0000cf70: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000cf80: 6169 722c 0a20 2020 2020 2020 2020 2020  air,.           
-0000cf90: 2020 2020 206f 7264 6572 7479 7065 2c0a       ordertype,.
-0000cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cfb0: 7369 6465 2c0a 2020 2020 2020 2020 2020  side,.          
-0000cfc0: 2020 2020 2020 616d 6f75 6e74 2c0a 2020        amount,.  
-0000cfd0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0000cfe0: 6f70 5f70 7269 6365 5f6e 6f72 6d2c 0a20  op_price_norm,. 
-0000cff0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000d000: 746f 705f 6c6f 7373 3d54 7275 652c 0a20  top_loss=True,. 
-0000d010: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000d020: 6576 6572 6167 653d 6c65 7665 7261 6765  everage=leverage
-0000d030: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0000d040: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000d050: 726e 2064 7279 5f6f 7264 6572 0a0a 2020  rn dry_order..  
-0000d060: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000d070: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
-0000d080: 7365 6c66 2e5f 6765 745f 7374 6f70 5f70  self._get_stop_p
-0000d090: 6172 616d 7328 7369 6465 3d73 6964 652c  arams(side=side,
-0000d0a0: 206f 7264 6572 7479 7065 3d6f 7264 6572   ordertype=order
-0000d0b0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
-0000d0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0e0: 2073 746f 705f 7072 6963 653d 7374 6f70   stop_price=stop
-0000d0f0: 5f70 7269 6365 5f6e 6f72 6d29 0a20 2020  _price_norm).   
-0000d100: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0000d110: 2e74 7261 6469 6e67 5f6d 6f64 6520 3d3d  .trading_mode ==
-0000d120: 2054 7261 6469 6e67 4d6f 6465 2e46 5554   TradingMode.FUT
-0000d130: 5552 4553 3a0a 2020 2020 2020 2020 2020  URES:.          
-0000d140: 2020 2020 2020 7061 7261 6d73 5b27 7265        params['re
-0000d150: 6475 6365 4f6e 6c79 275d 203d 2054 7275  duceOnly'] = Tru
-0000d160: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000d170: 2020 6966 2027 7374 6f70 6c6f 7373 5f70    if 'stoploss_p
-0000d180: 7269 6365 5f74 7970 6527 2069 6e20 6f72  rice_type' in or
-0000d190: 6465 725f 7479 7065 7320 616e 6420 2773  der_types and 's
-0000d1a0: 746f 705f 7072 6963 655f 7479 7065 5f66  top_price_type_f
-0000d1b0: 6965 6c64 2720 696e 2073 656c 662e 5f66  ield' in self._f
-0000d1c0: 745f 6861 733a 0a20 2020 2020 2020 2020  t_has:.         
-0000d1d0: 2020 2020 2020 2020 2020 2070 7269 6365             price
-0000d1e0: 5f74 7970 6520 3d20 7365 6c66 2e5f 6674  _type = self._ft
-0000d1f0: 5f68 6173 5b27 7374 6f70 5f70 7269 6365  _has['stop_price
-0000d200: 5f74 7970 655f 7661 6c75 655f 6d61 7070  _type_value_mapp
-0000d210: 696e 6727 5d5b 0a20 2020 2020 2020 2020  ing'][.         
-0000d220: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0000d230: 7264 6572 5f74 7970 6573 2e67 6574 2827  rder_types.get('
-0000d240: 7374 6f70 6c6f 7373 5f70 7269 6365 5f74  stoploss_price_t
-0000d250: 7970 6527 2c20 5072 6963 6554 7970 652e  ype', PriceType.
-0000d260: 4c41 5354 295d 0a20 2020 2020 2020 2020  LAST)].         
-0000d270: 2020 2020 2020 2020 2020 2070 6172 616d             param
-0000d280: 735b 7365 6c66 2e5f 6674 5f68 6173 5b27  s[self._ft_has['
-0000d290: 7374 6f70 5f70 7269 6365 5f74 7970 655f  stop_price_type_
-0000d2a0: 6669 656c 6427 5d5d 203d 2070 7269 6365  field']] = price
-0000d2b0: 5f74 7970 650a 0a20 2020 2020 2020 2020  _type..         
-0000d2c0: 2020 2061 6d6f 756e 7420 3d20 7365 6c66     amount = self
-0000d2d0: 2e61 6d6f 756e 745f 746f 5f70 7265 6369  .amount_to_preci
-0000d2e0: 7369 6f6e 2870 6169 722c 2073 656c 662e  sion(pair, self.
-0000d2f0: 5f61 6d6f 756e 745f 746f 5f63 6f6e 7472  _amount_to_contr
-0000d300: 6163 7473 2870 6169 722c 2061 6d6f 756e  acts(pair, amoun
-0000d310: 7429 290a 0a20 2020 2020 2020 2020 2020  t))..           
-0000d320: 2073 656c 662e 5f6c 6576 5f70 7265 7028   self._lev_prep(
-0000d330: 7061 6972 2c20 6c65 7665 7261 6765 2c20  pair, leverage, 
-0000d340: 7369 6465 2c20 6163 6365 7074 5f66 6169  side, accept_fai
-0000d350: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
-0000d360: 2020 2020 6f72 6465 7220 3d20 7365 6c66      order = self
-0000d370: 2e5f 6170 692e 6372 6561 7465 5f6f 7264  ._api.create_ord
-0000d380: 6572 2873 796d 626f 6c3d 7061 6972 2c20  er(symbol=pair, 
-0000d390: 7479 7065 3d6f 7264 6572 7479 7065 2c20  type=ordertype, 
-0000d3a0: 7369 6465 3d73 6964 652c 0a20 2020 2020  side=side,.     
-0000d3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3d0: 2020 2020 2020 616d 6f75 6e74 3d61 6d6f        amount=amo
-0000d3e0: 756e 742c 2070 7269 6365 3d6c 696d 6974  unt, price=limit
-0000d3f0: 5f72 6174 652c 2070 6172 616d 733d 7061  _rate, params=pa
-0000d400: 7261 6d73 290a 2020 2020 2020 2020 2020  rams).          
-0000d410: 2020 7365 6c66 2e5f 6c6f 675f 6578 6368    self._log_exch
-0000d420: 616e 6765 5f72 6573 706f 6e73 6528 2763  ange_response('c
-0000d430: 7265 6174 655f 7374 6f70 6c6f 7373 5f6f  reate_stoploss_o
-0000d440: 7264 6572 272c 206f 7264 6572 290a 2020  rder', order).  
-0000d450: 2020 2020 2020 2020 2020 6f72 6465 7220            order 
-0000d460: 3d20 7365 6c66 2e5f 6f72 6465 725f 636f  = self._order_co
-0000d470: 6e74 7261 6374 735f 746f 5f61 6d6f 756e  ntracts_to_amoun
-0000d480: 7428 6f72 6465 7229 0a20 2020 2020 2020  t(order).       
-0000d490: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-0000d4a0: 2866 2273 746f 706c 6f73 7320 7b75 7365  (f"stoploss {use
-0000d4b0: 725f 6f72 6465 725f 7479 7065 7d20 6f72  r_order_type} or
-0000d4c0: 6465 7220 6164 6465 6420 666f 7220 7b70  der added for {p
-0000d4d0: 6169 727d 2e20 220a 2020 2020 2020 2020  air}. ".        
-0000d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4f0: 6622 7374 6f70 2070 7269 6365 3a20 7b73  f"stop price: {s
-0000d500: 746f 705f 7072 6963 657d 2e20 6c69 6d69  top_price}. limi
-0000d510: 743a 207b 6c69 6d69 745f 7261 7465 7d22  t: {limit_rate}"
-0000d520: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0000d530: 7475 726e 206f 7264 6572 0a20 2020 2020  turn order.     
-0000d540: 2020 2065 7863 6570 7420 6363 7874 2e49     except ccxt.I
-0000d550: 6e73 7566 6669 6369 656e 7446 756e 6473  nsufficientFunds
-0000d560: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0000d570: 2020 2072 6169 7365 2049 6e73 7566 6669     raise Insuffi
-0000d580: 6369 656e 7446 756e 6473 4572 726f 7228  cientFundsError(
-0000d590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d5a0: 2066 2749 6e73 7566 6669 6369 656e 7420   f'Insufficient 
-0000d5b0: 6675 6e64 7320 746f 2063 7265 6174 6520  funds to create 
-0000d5c0: 7b6f 7264 6572 7479 7065 7d20 7365 6c6c  {ordertype} sell
-0000d5d0: 206f 7264 6572 206f 6e20 6d61 726b 6574   order on market
-0000d5e0: 207b 7061 6972 7d2e 2027 0a20 2020 2020   {pair}. '.     
-0000d5f0: 2020 2020 2020 2020 2020 2066 2754 7269             f'Tri
-0000d600: 6564 2074 6f20 7365 6c6c 2061 6d6f 756e  ed to sell amoun
-0000d610: 7420 7b61 6d6f 756e 747d 2061 7420 7261  t {amount} at ra
-0000d620: 7465 207b 6c69 6d69 745f 7261 7465 7d2e  te {limit_rate}.
-0000d630: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000d640: 2020 2066 274d 6573 7361 6765 3a20 7b65     f'Message: {e
-0000d650: 7d27 2920 6672 6f6d 2065 0a20 2020 2020  }') from e.     
-0000d660: 2020 2065 7863 6570 7420 6363 7874 2e49     except ccxt.I
-0000d670: 6e76 616c 6964 4f72 6465 7220 6173 2065  nvalidOrder as e
-0000d680: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0000d690: 4572 726f 7273 3a0a 2020 2020 2020 2020  Errors:.        
-0000d6a0: 2020 2020 2320 604f 7264 6572 2077 6f75      # `Order wou
-0000d6b0: 6c64 2074 7269 6767 6572 2069 6d6d 6564  ld trigger immed
-0000d6c0: 6961 7465 6c79 2e60 0a20 2020 2020 2020  iately.`.       
-0000d6d0: 2020 2020 2072 6169 7365 2049 6e76 616c       raise Inval
-0000d6e0: 6964 4f72 6465 7245 7863 6570 7469 6f6e  idOrderException
-0000d6f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000d700: 2020 6627 436f 756c 6420 6e6f 7420 6372    f'Could not cr
-0000d710: 6561 7465 207b 6f72 6465 7274 7970 657d  eate {ordertype}
-0000d720: 2073 656c 6c20 6f72 6465 7220 6f6e 206d   sell order on m
-0000d730: 6172 6b65 7420 7b70 6169 727d 2e20 270a  arket {pair}. '.
-0000d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d750: 6627 5472 6965 6420 746f 2073 656c 6c20  f'Tried to sell 
-0000d760: 616d 6f75 6e74 207b 616d 6f75 6e74 7d20  amount {amount} 
-0000d770: 6174 2072 6174 6520 7b6c 696d 6974 5f72  at rate {limit_r
-0000d780: 6174 657d 2e20 270a 2020 2020 2020 2020  ate}. '.        
-0000d790: 2020 2020 2020 2020 6627 4d65 7373 6167          f'Messag
-0000d7a0: 653a 207b 657d 2729 2066 726f 6d20 650a  e: {e}') from e.
-0000d7b0: 2020 2020 2020 2020 6578 6365 7074 2063          except c
-0000d7c0: 6378 742e 4444 6f53 5072 6f74 6563 7469  cxt.DDoSProtecti
-0000d7d0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-0000d7e0: 2020 2020 2072 6169 7365 2044 446f 7350       raise DDosP
-0000d7f0: 726f 7465 6374 696f 6e28 6529 2066 726f  rotection(e) fro
-0000d800: 6d20 650a 2020 2020 2020 2020 6578 6365  m e.        exce
-0000d810: 7074 2028 6363 7874 2e4e 6574 776f 726b  pt (ccxt.Network
-0000d820: 4572 726f 722c 2063 6378 742e 4578 6368  Error, ccxt.Exch
-0000d830: 616e 6765 4572 726f 7229 2061 7320 653a  angeError) as e:
-0000d840: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000d850: 7365 2054 656d 706f 7261 7279 4572 726f  se TemporaryErro
-0000d860: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0000d870: 2020 2066 2243 6f75 6c64 206e 6f74 2070     f"Could not p
-0000d880: 6c61 6365 2073 746f 706c 6f73 7320 6f72  lace stoploss or
-0000d890: 6465 7220 6475 6520 746f 207b 652e 5f5f  der due to {e.__
-0000d8a0: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
-0000d8b0: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
-0000d8c0: 2020 2020 2066 224d 6573 7361 6765 3a20       f"Message: 
-0000d8d0: 7b65 7d22 2920 6672 6f6d 2065 0a20 2020  {e}") from e.   
-0000d8e0: 2020 2020 2065 7863 6570 7420 6363 7874       except ccxt
-0000d8f0: 2e42 6173 6545 7272 6f72 2061 7320 653a  .BaseError as e:
-0000d900: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000d910: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
-0000d920: 6365 7074 696f 6e28 6529 2066 726f 6d20  ception(e) from 
-0000d930: 650a 0a20 2020 2040 7265 7472 6965 7228  e..    @retrier(
-0000d940: 7265 7472 6965 733d 4150 495f 4645 5443  retries=API_FETC
-0000d950: 485f 4f52 4445 525f 5245 5452 595f 434f  H_ORDER_RETRY_CO
-0000d960: 554e 5429 0a20 2020 2064 6566 2066 6574  UNT).    def fet
-0000d970: 6368 5f6f 7264 6572 2873 656c 662c 206f  ch_order(self, o
-0000d980: 7264 6572 5f69 643a 2073 7472 2c20 7061  rder_id: str, pa
-0000d990: 6972 3a20 7374 722c 2070 6172 616d 733a  ir: str, params:
-0000d9a0: 2044 6963 7420 3d20 7b7d 2920 2d3e 2044   Dict = {}) -> D
-0000d9b0: 6963 743a 0a20 2020 2020 2020 2069 6620  ict:.        if 
-0000d9c0: 7365 6c66 2e5f 636f 6e66 6967 5b27 6472  self._config['dr
-0000d9d0: 795f 7275 6e27 5d3a 0a20 2020 2020 2020  y_run']:.       
-0000d9e0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0000d9f0: 2e66 6574 6368 5f64 7279 5f72 756e 5f6f  .fetch_dry_run_o
-0000da00: 7264 6572 286f 7264 6572 5f69 6429 0a20  rder(order_id). 
-0000da10: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000da20: 2020 2020 2020 2020 6f72 6465 7220 3d20          order = 
-0000da30: 7365 6c66 2e5f 6170 692e 6665 7463 685f  self._api.fetch_
-0000da40: 6f72 6465 7228 6f72 6465 725f 6964 2c20  order(order_id, 
-0000da50: 7061 6972 2c20 7061 7261 6d73 3d70 6172  pair, params=par
-0000da60: 616d 7329 0a20 2020 2020 2020 2020 2020  ams).           
-0000da70: 2073 656c 662e 5f6c 6f67 5f65 7863 6861   self._log_excha
-0000da80: 6e67 655f 7265 7370 6f6e 7365 2827 6665  nge_response('fe
-0000da90: 7463 685f 6f72 6465 7227 2c20 6f72 6465  tch_order', orde
-0000daa0: 7229 0a20 2020 2020 2020 2020 2020 206f  r).            o
-0000dab0: 7264 6572 203d 2073 656c 662e 5f6f 7264  rder = self._ord
-0000dac0: 6572 5f63 6f6e 7472 6163 7473 5f74 6f5f  er_contracts_to_
-0000dad0: 616d 6f75 6e74 286f 7264 6572 290a 2020  amount(order).  
-0000dae0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000daf0: 206f 7264 6572 0a20 2020 2020 2020 2065   order.        e
-0000db00: 7863 6570 7420 6363 7874 2e4f 7264 6572  xcept ccxt.Order
-0000db10: 4e6f 7446 6f75 6e64 2061 7320 653a 0a20  NotFound as e:. 
-0000db20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000db30: 2052 6574 7279 6162 6c65 4f72 6465 7245   RetryableOrderE
-0000db40: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000db50: 2020 2020 2020 6627 4f72 6465 7220 6e6f        f'Order no
-0000db60: 7420 666f 756e 6420 2870 6169 723a 207b  t found (pair: {
-0000db70: 7061 6972 7d20 6964 3a20 7b6f 7264 6572  pair} id: {order
-0000db80: 5f69 647d 292e 204d 6573 7361 6765 3a20  _id}). Message: 
-0000db90: 7b65 7d27 2920 6672 6f6d 2065 0a20 2020  {e}') from e.   
-0000dba0: 2020 2020 2065 7863 6570 7420 6363 7874       except ccxt
-0000dbb0: 2e49 6e76 616c 6964 4f72 6465 7220 6173  .InvalidOrder as
-0000dbc0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0000dbd0: 7261 6973 6520 496e 7661 6c69 644f 7264  raise InvalidOrd
-0000dbe0: 6572 4578 6365 7074 696f 6e28 0a20 2020  erException(.   
-0000dbf0: 2020 2020 2020 2020 2020 2020 2066 2754               f'T
-0000dc00: 7269 6564 2074 6f20 6765 7420 616e 2069  ried to get an i
-0000dc10: 6e76 616c 6964 206f 7264 6572 2028 7061  nvalid order (pa
-0000dc20: 6972 3a20 7b70 6169 727d 2069 643a 207b  ir: {pair} id: {
-0000dc30: 6f72 6465 725f 6964 7d29 2e20 4d65 7373  order_id}). Mess
-0000dc40: 6167 653a 207b 657d 2729 2066 726f 6d20  age: {e}') from 
-0000dc50: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
-0000dc60: 2063 6378 742e 4444 6f53 5072 6f74 6563   ccxt.DDoSProtec
-0000dc70: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0000dc80: 2020 2020 2020 2072 6169 7365 2044 446f         raise DDo
-0000dc90: 7350 726f 7465 6374 696f 6e28 6529 2066  sProtection(e) f
-0000dca0: 726f 6d20 650a 2020 2020 2020 2020 6578  rom e.        ex
-0000dcb0: 6365 7074 2028 6363 7874 2e4e 6574 776f  cept (ccxt.Netwo
-0000dcc0: 726b 4572 726f 722c 2063 6378 742e 4578  rkError, ccxt.Ex
-0000dcd0: 6368 616e 6765 4572 726f 7229 2061 7320  changeError) as 
-0000dce0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000dcf0: 6169 7365 2054 656d 706f 7261 7279 4572  aise TemporaryEr
-0000dd00: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0000dd10: 2020 2020 2066 2743 6f75 6c64 206e 6f74       f'Could not
-0000dd20: 2067 6574 206f 7264 6572 2064 7565 2074   get order due t
-0000dd30: 6f20 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f  o {e.__class__._
-0000dd40: 5f6e 616d 655f 5f7d 2e20 4d65 7373 6167  _name__}. Messag
-0000dd50: 653a 207b 657d 2729 2066 726f 6d20 650a  e: {e}') from e.
-0000dd60: 2020 2020 2020 2020 6578 6365 7074 2063          except c
-0000dd70: 6378 742e 4261 7365 4572 726f 7220 6173  cxt.BaseError as
-0000dd80: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0000dd90: 7261 6973 6520 4f70 6572 6174 696f 6e61  raise Operationa
-0000dda0: 6c45 7863 6570 7469 6f6e 2865 2920 6672  lException(e) fr
-0000ddb0: 6f6d 2065 0a0a 2020 2020 6465 6620 6665  om e..    def fe
-0000ddc0: 7463 685f 7374 6f70 6c6f 7373 5f6f 7264  tch_stoploss_ord
-0000ddd0: 6572 2873 656c 662c 206f 7264 6572 5f69  er(self, order_i
-0000dde0: 643a 2073 7472 2c20 7061 6972 3a20 7374  d: str, pair: st
-0000ddf0: 722c 2070 6172 616d 733a 2044 6963 7420  r, params: Dict 
-0000de00: 3d20 7b7d 2920 2d3e 2044 6963 743a 0a20  = {}) -> Dict:. 
-0000de10: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0000de20: 6c66 2e66 6574 6368 5f6f 7264 6572 286f  lf.fetch_order(o
-0000de30: 7264 6572 5f69 642c 2070 6169 722c 2070  rder_id, pair, p
-0000de40: 6172 616d 7329 0a0a 2020 2020 6465 6620  arams)..    def 
-0000de50: 6665 7463 685f 6f72 6465 725f 6f72 5f73  fetch_order_or_s
-0000de60: 746f 706c 6f73 735f 6f72 6465 7228 7365  toploss_order(se
-0000de70: 6c66 2c20 6f72 6465 725f 6964 3a20 7374  lf, order_id: st
-0000de80: 722c 2070 6169 723a 2073 7472 2c0a 2020  r, pair: str,.  
-0000de90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000deb0: 2020 2020 7374 6f70 6c6f 7373 5f6f 7264      stoploss_ord
-0000dec0: 6572 3a20 626f 6f6c 203d 2046 616c 7365  er: bool = False
-0000ded0: 2920 2d3e 2044 6963 743a 0a20 2020 2020  ) -> Dict:.     
-0000dee0: 2020 2022 2222 0a20 2020 2020 2020 2053     """.        S
-0000def0: 696d 706c 6520 7772 6170 7065 7220 6361  imple wrapper ca
-0000df00: 6c6c 696e 6720 6569 7468 6572 2066 6574  lling either fet
-0000df10: 6368 5f6f 7264 6572 206f 7220 6665 7463  ch_order or fetc
-0000df20: 685f 7374 6f70 6c6f 7373 5f6f 7264 6572  h_stoploss_order
-0000df30: 2064 6570 656e 6469 6e67 206f 6e0a 2020   depending on.  
-0000df40: 2020 2020 2020 7468 6520 7374 6f70 6c6f        the stoplo
-0000df50: 7373 5f6f 7264 6572 2070 6172 616d 6574  ss_order paramet
-0000df60: 6572 0a20 2020 2020 2020 203a 7061 7261  er.        :para
-0000df70: 6d20 6f72 6465 725f 6964 3a20 4f72 6465  m order_id: Orde
-0000df80: 7249 6420 746f 2066 6574 6368 206f 7264  rId to fetch ord
-0000df90: 6572 0a20 2020 2020 2020 203a 7061 7261  er.        :para
-0000dfa0: 6d20 7061 6972 3a20 5061 6972 2063 6f72  m pair: Pair cor
-0000dfb0: 7265 7370 6f6e 6469 6e67 2074 6f20 6f72  responding to or
-0000dfc0: 6465 725f 6964 0a20 2020 2020 2020 203a  der_id.        :
-0000dfd0: 7061 7261 6d20 7374 6f70 6c6f 7373 5f6f  param stoploss_o
-0000dfe0: 7264 6572 3a20 4966 2074 7275 652c 2075  rder: If true, u
-0000dff0: 7365 7320 6665 7463 685f 7374 6f70 6c6f  ses fetch_stoplo
-0000e000: 7373 5f6f 7264 6572 2c20 6f74 6865 7277  ss_order, otherw
-0000e010: 6973 6520 6665 7463 685f 6f72 6465 722e  ise fetch_order.
-0000e020: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000e030: 2020 2020 2069 6620 7374 6f70 6c6f 7373       if stoploss
-0000e040: 5f6f 7264 6572 3a0a 2020 2020 2020 2020  _order:.        
-0000e050: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000e060: 6665 7463 685f 7374 6f70 6c6f 7373 5f6f  fetch_stoploss_o
-0000e070: 7264 6572 286f 7264 6572 5f69 642c 2070  rder(order_id, p
-0000e080: 6169 7229 0a20 2020 2020 2020 2072 6574  air).        ret
-0000e090: 7572 6e20 7365 6c66 2e66 6574 6368 5f6f  urn self.fetch_o
-0000e0a0: 7264 6572 286f 7264 6572 5f69 642c 2070  rder(order_id, p
-0000e0b0: 6169 7229 0a0a 2020 2020 6465 6620 6368  air)..    def ch
-0000e0c0: 6563 6b5f 6f72 6465 725f 6361 6e63 656c  eck_order_cancel
-0000e0d0: 6564 5f65 6d70 7479 2873 656c 662c 206f  ed_empty(self, o
-0000e0e0: 7264 6572 3a20 4469 6374 2920 2d3e 2062  rder: Dict) -> b
-0000e0f0: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
-0000e100: 0a20 2020 2020 2020 2056 6572 6966 7920  .        Verify 
-0000e110: 6966 2061 6e20 6f72 6465 7220 6861 7320  if an order has 
-0000e120: 6265 656e 2063 616e 6365 6c6c 6564 2077  been cancelled w
-0000e130: 6974 686f 7574 2062 6569 6e67 2070 6172  ithout being par
-0000e140: 7469 616c 6c79 2066 696c 6c65 640a 2020  tially filled.  
-0000e150: 2020 2020 2020 3a70 6172 616d 206f 7264        :param ord
-0000e160: 6572 3a20 4f72 6465 7220 6469 6374 2061  er: Order dict a
-0000e170: 7320 7265 7475 726e 6564 2066 726f 6d20  s returned from 
-0000e180: 6665 7463 685f 6f72 6465 7228 290a 2020  fetch_order().  
-0000e190: 2020 2020 2020 3a72 6574 7572 6e3a 2054        :return: T
-0000e1a0: 7275 6520 6966 206f 7264 6572 2068 6173  rue if order has
-0000e1b0: 2062 6565 6e20 6361 6e63 656c 6c65 6420   been cancelled 
-0000e1c0: 7769 7468 6f75 7420 6265 696e 6720 6669  without being fi
-0000e1d0: 6c6c 6564 2c20 4661 6c73 6520 6f74 6865  lled, False othe
-0000e1e0: 7277 6973 652e 0a20 2020 2020 2020 2022  rwise..        "
-0000e1f0: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-0000e200: 6e20 286f 7264 6572 2e67 6574 2827 7374  n (order.get('st
-0000e210: 6174 7573 2729 2069 6e20 4e4f 4e5f 4f50  atus') in NON_OP
-0000e220: 454e 5f45 5843 4841 4e47 455f 5354 4154  EN_EXCHANGE_STAT
-0000e230: 4553 0a20 2020 2020 2020 2020 2020 2020  ES.             
-0000e240: 2020 2061 6e64 206f 7264 6572 2e67 6574     and order.get
-0000e250: 2827 6669 6c6c 6564 2729 203d 3d20 302e  ('filled') == 0.
-0000e260: 3029 0a0a 2020 2020 4072 6574 7269 6572  0)..    @retrier
-0000e270: 0a20 2020 2064 6566 2063 616e 6365 6c5f  .    def cancel_
-0000e280: 6f72 6465 7228 7365 6c66 2c20 6f72 6465  order(self, orde
-0000e290: 725f 6964 3a20 7374 722c 2070 6169 723a  r_id: str, pair:
-0000e2a0: 2073 7472 2c20 7061 7261 6d73 3a20 4469   str, params: Di
-0000e2b0: 6374 203d 207b 7d29 202d 3e20 4469 6374  ct = {}) -> Dict
-0000e2c0: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
-0000e2d0: 662e 5f63 6f6e 6669 675b 2764 7279 5f72  f._config['dry_r
-0000e2e0: 756e 275d 3a0a 2020 2020 2020 2020 2020  un']:.          
-0000e2f0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000e300: 2020 2020 2020 206f 7264 6572 203d 2073         order = s
-0000e310: 656c 662e 6665 7463 685f 6472 795f 7275  elf.fetch_dry_ru
-0000e320: 6e5f 6f72 6465 7228 6f72 6465 725f 6964  n_order(order_id
-0000e330: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000e340: 2020 206f 7264 6572 2e75 7064 6174 6528     order.update(
-0000e350: 7b27 7374 6174 7573 273a 2027 6361 6e63  {'status': 'canc
-0000e360: 656c 6564 272c 2027 6669 6c6c 6564 273a  eled', 'filled':
-0000e370: 2030 2e30 2c20 2772 656d 6169 6e69 6e67   0.0, 'remaining
-0000e380: 273a 206f 7264 6572 5b27 616d 6f75 6e74  ': order['amount
-0000e390: 275d 7d29 0a20 2020 2020 2020 2020 2020  ']}).           
-0000e3a0: 2020 2020 2072 6574 7572 6e20 6f72 6465       return orde
-0000e3b0: 720a 2020 2020 2020 2020 2020 2020 6578  r.            ex
-0000e3c0: 6365 7074 2049 6e76 616c 6964 4f72 6465  cept InvalidOrde
-0000e3d0: 7245 7863 6570 7469 6f6e 3a0a 2020 2020  rException:.    
-0000e3e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000e3f0: 726e 207b 7d0a 0a20 2020 2020 2020 2074  rn {}..        t
-0000e400: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000e410: 6f72 6465 7220 3d20 7365 6c66 2e5f 6170  order = self._ap
-0000e420: 692e 6361 6e63 656c 5f6f 7264 6572 286f  i.cancel_order(o
-0000e430: 7264 6572 5f69 642c 2070 6169 722c 2070  rder_id, pair, p
-0000e440: 6172 616d 733d 7061 7261 6d73 290a 2020  arams=params).  
-0000e450: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0000e460: 6c6f 675f 6578 6368 616e 6765 5f72 6573  log_exchange_res
-0000e470: 706f 6e73 6528 2763 616e 6365 6c5f 6f72  ponse('cancel_or
-0000e480: 6465 7227 2c20 6f72 6465 7229 0a20 2020  der', order).   
-0000e490: 2020 2020 2020 2020 206f 7264 6572 203d           order =
-0000e4a0: 2073 656c 662e 5f6f 7264 6572 5f63 6f6e   self._order_con
-0000e4b0: 7472 6163 7473 5f74 6f5f 616d 6f75 6e74  tracts_to_amount
-0000e4c0: 286f 7264 6572 290a 2020 2020 2020 2020  (order).        
-0000e4d0: 2020 2020 7265 7475 726e 206f 7264 6572      return order
-0000e4e0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0000e4f0: 6363 7874 2e49 6e76 616c 6964 4f72 6465  ccxt.InvalidOrde
-0000e500: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
-0000e510: 2020 2020 7261 6973 6520 496e 7661 6c69      raise Invali
-0000e520: 644f 7264 6572 4578 6365 7074 696f 6e28  dOrderException(
-0000e530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e540: 2066 2743 6f75 6c64 206e 6f74 2063 616e   f'Could not can
-0000e550: 6365 6c20 6f72 6465 722e 204d 6573 7361  cel order. Messa
-0000e560: 6765 3a20 7b65 7d27 2920 6672 6f6d 2065  ge: {e}') from e
-0000e570: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0000e580: 6363 7874 2e44 446f 5350 726f 7465 6374  ccxt.DDoSProtect
-0000e590: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-0000e5a0: 2020 2020 2020 7261 6973 6520 4444 6f73        raise DDos
-0000e5b0: 5072 6f74 6563 7469 6f6e 2865 2920 6672  Protection(e) fr
-0000e5c0: 6f6d 2065 0a20 2020 2020 2020 2065 7863  om e.        exc
-0000e5d0: 6570 7420 2863 6378 742e 4e65 7477 6f72  ept (ccxt.Networ
-0000e5e0: 6b45 7272 6f72 2c20 6363 7874 2e45 7863  kError, ccxt.Exc
-0000e5f0: 6861 6e67 6545 7272 6f72 2920 6173 2065  hangeError) as e
-0000e600: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000e610: 6973 6520 5465 6d70 6f72 6172 7945 7272  ise TemporaryErr
-0000e620: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000e630: 2020 2020 6627 436f 756c 6420 6e6f 7420      f'Could not 
-0000e640: 6361 6e63 656c 206f 7264 6572 2064 7565  cancel order due
-0000e650: 2074 6f20 7b65 2e5f 5f63 6c61 7373 5f5f   to {e.__class__
-0000e660: 2e5f 5f6e 616d 655f 5f7d 2e20 4d65 7373  .__name__}. Mess
-0000e670: 6167 653a 207b 657d 2729 2066 726f 6d20  age: {e}') from 
-0000e680: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
-0000e690: 2063 6378 742e 4261 7365 4572 726f 7220   ccxt.BaseError 
-0000e6a0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0000e6b0: 2020 7261 6973 6520 4f70 6572 6174 696f    raise Operatio
-0000e6c0: 6e61 6c45 7863 6570 7469 6f6e 2865 2920  nalException(e) 
-0000e6d0: 6672 6f6d 2065 0a0a 2020 2020 6465 6620  from e..    def 
-0000e6e0: 6361 6e63 656c 5f73 746f 706c 6f73 735f  cancel_stoploss_
-0000e6f0: 6f72 6465 7228 7365 6c66 2c20 6f72 6465  order(self, orde
-0000e700: 725f 6964 3a20 7374 722c 2070 6169 723a  r_id: str, pair:
-0000e710: 2073 7472 2c20 7061 7261 6d73 3a20 4469   str, params: Di
-0000e720: 6374 203d 207b 7d29 202d 3e20 4469 6374  ct = {}) -> Dict
-0000e730: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000e740: 2073 656c 662e 6361 6e63 656c 5f6f 7264   self.cancel_ord
-0000e750: 6572 286f 7264 6572 5f69 642c 2070 6169  er(order_id, pai
-0000e760: 722c 2070 6172 616d 7329 0a0a 2020 2020  r, params)..    
-0000e770: 6465 6620 6973 5f63 616e 6365 6c5f 6f72  def is_cancel_or
-0000e780: 6465 725f 7265 7375 6c74 5f73 7569 7461  der_result_suita
-0000e790: 626c 6528 7365 6c66 2c20 636f 7264 6572  ble(self, corder
-0000e7a0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-0000e7b0: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-0000e7c0: 616e 6365 2863 6f72 6465 722c 2064 6963  ance(corder, dic
-0000e7d0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-0000e7e0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
-0000e7f0: 2020 2020 2020 7265 7175 6972 6564 203d        required =
-0000e800: 2028 2766 6565 272c 2027 7374 6174 7573   ('fee', 'status
-0000e810: 272c 2027 616d 6f75 6e74 2729 0a20 2020  ', 'amount').   
-0000e820: 2020 2020 2072 6574 7572 6e20 616c 6c28       return all(
-0000e830: 636f 7264 6572 2e67 6574 286b 2c20 4e6f  corder.get(k, No
-0000e840: 6e65 2920 6973 206e 6f74 204e 6f6e 6520  ne) is not None 
-0000e850: 666f 7220 6b20 696e 2072 6571 7569 7265  for k in require
-0000e860: 6429 0a0a 2020 2020 6465 6620 6361 6e63  d)..    def canc
-0000e870: 656c 5f6f 7264 6572 5f77 6974 685f 7265  el_order_with_re
-0000e880: 7375 6c74 2873 656c 662c 206f 7264 6572  sult(self, order
-0000e890: 5f69 643a 2073 7472 2c20 7061 6972 3a20  _id: str, pair: 
-0000e8a0: 7374 722c 2061 6d6f 756e 743a 2066 6c6f  str, amount: flo
-0000e8b0: 6174 2920 2d3e 2044 6963 743a 0a20 2020  at) -> Dict:.   
-0000e8c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000e8d0: 2043 616e 6365 6c20 6f72 6465 7220 7265   Cancel order re
-0000e8e0: 7475 726e 696e 6720 6120 7265 7375 6c74  turning a result
-0000e8f0: 2e0a 2020 2020 2020 2020 4372 6561 7465  ..        Create
-0000e900: 7320 6120 6661 6b65 2072 6573 756c 7420  s a fake result 
-0000e910: 6966 2063 616e 6365 6c20 6f72 6465 7220  if cancel order 
-0000e920: 7265 7475 726e 7320 6120 6e6f 6e2d 7573  returns a non-us
-0000e930: 6162 6c65 2072 6573 756c 740a 2020 2020  able result.    
-0000e940: 2020 2020 616e 6420 6665 7463 685f 6f72      and fetch_or
-0000e950: 6465 7220 646f 6573 206e 6f74 2077 6f72  der does not wor
-0000e960: 6b20 2863 6572 7461 696e 2065 7863 6861  k (certain excha
-0000e970: 6e67 6573 2064 6f6e 2774 2072 6574 7572  nges don't retur
-0000e980: 6e20 6361 6e63 656c 6c65 6420 6f72 6465  n cancelled orde
-0000e990: 7273 290a 2020 2020 2020 2020 3a70 6172  rs).        :par
-0000e9a0: 616d 206f 7264 6572 5f69 643a 204f 7264  am order_id: Ord
-0000e9b0: 6572 6964 2074 6f20 6361 6e63 656c 0a20  erid to cancel. 
-0000e9c0: 2020 2020 2020 203a 7061 7261 6d20 7061         :param pa
-0000e9d0: 6972 3a20 5061 6972 2063 6f72 7265 7370  ir: Pair corresp
-0000e9e0: 6f6e 6469 6e67 2074 6f20 6f72 6465 725f  onding to order_
-0000e9f0: 6964 0a20 2020 2020 2020 203a 7061 7261  id.        :para
-0000ea00: 6d20 616d 6f75 6e74 3a20 416d 6f75 6e74  m amount: Amount
-0000ea10: 2074 6f20 7573 6520 666f 7220 6661 6b65   to use for fake
-0000ea20: 2072 6573 706f 6e73 650a 2020 2020 2020   response.      
-0000ea30: 2020 3a72 6574 7572 6e3a 2052 6573 756c    :return: Resul
-0000ea40: 7420 6672 6f6d 2065 6974 6865 7220 6361  t from either ca
-0000ea50: 6e63 656c 5f6f 7264 6572 2069 6620 7573  ncel_order if us
-0000ea60: 6162 6c65 2c20 6f72 2066 6574 6368 5f6f  able, or fetch_o
-0000ea70: 7264 6572 0a20 2020 2020 2020 2022 2222  rder.        """
-0000ea80: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000ea90: 2020 2020 2020 2020 2020 636f 7264 6572            corder
-0000eaa0: 203d 2073 656c 662e 6361 6e63 656c 5f6f   = self.cancel_o
-0000eab0: 7264 6572 286f 7264 6572 5f69 642c 2070  rder(order_id, p
-0000eac0: 6169 7229 0a20 2020 2020 2020 2020 2020  air).           
-0000ead0: 2069 6620 7365 6c66 2e69 735f 6361 6e63   if self.is_canc
-0000eae0: 656c 5f6f 7264 6572 5f72 6573 756c 745f  el_order_result_
-0000eaf0: 7375 6974 6162 6c65 2863 6f72 6465 7229  suitable(corder)
-0000eb00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000eb10: 2020 7265 7475 726e 2063 6f72 6465 720a    return corder.
-0000eb20: 2020 2020 2020 2020 6578 6365 7074 2049          except I
-0000eb30: 6e76 616c 6964 4f72 6465 7245 7863 6570  nvalidOrderExcep
-0000eb40: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-0000eb50: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-0000eb60: 2866 2243 6f75 6c64 206e 6f74 2063 616e  (f"Could not can
-0000eb70: 6365 6c20 6f72 6465 7220 7b6f 7264 6572  cel order {order
-0000eb80: 5f69 647d 2066 6f72 207b 7061 6972 7d2e  _id} for {pair}.
-0000eb90: 2229 0a20 2020 2020 2020 2074 7279 3a0a  ").        try:.
-0000eba0: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
-0000ebb0: 7220 3d20 7365 6c66 2e66 6574 6368 5f6f  r = self.fetch_o
-0000ebc0: 7264 6572 286f 7264 6572 5f69 642c 2070  rder(order_id, p
-0000ebd0: 6169 7229 0a20 2020 2020 2020 2065 7863  air).        exc
-0000ebe0: 6570 7420 496e 7661 6c69 644f 7264 6572  ept InvalidOrder
-0000ebf0: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-0000ec00: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-0000ec10: 726e 696e 6728 6622 436f 756c 6420 6e6f  rning(f"Could no
-0000ec20: 7420 6665 7463 6820 6361 6e63 656c 6c65  t fetch cancelle
-0000ec30: 6420 6f72 6465 7220 7b6f 7264 6572 5f69  d order {order_i
-0000ec40: 647d 2e22 290a 2020 2020 2020 2020 2020  d}.").          
-0000ec50: 2020 6f72 6465 7220 3d20 7b0a 2020 2020    order = {.    
-0000ec60: 2020 2020 2020 2020 2020 2020 2769 6427              'id'
-0000ec70: 3a20 6f72 6465 725f 6964 2c0a 2020 2020  : order_id,.    
-0000ec80: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
-0000ec90: 7475 7327 3a20 2763 616e 6365 6c65 6427  tus': 'canceled'
-0000eca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ecb0: 2020 2761 6d6f 756e 7427 3a20 616d 6f75    'amount': amou
-0000ecc0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0000ecd0: 2020 2020 2766 696c 6c65 6427 3a20 302e      'filled': 0.
-0000ece0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-0000ecf0: 2020 2027 6665 6527 3a20 7b7d 2c0a 2020     'fee': {},.  
-0000ed00: 2020 2020 2020 2020 2020 2020 2020 2769                'i
-0000ed10: 6e66 6f27 3a20 7b7d 0a20 2020 2020 2020  nfo': {}.       
-0000ed20: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0000ed30: 7265 7475 726e 206f 7264 6572 0a0a 2020  return order..  
-0000ed40: 2020 6465 6620 6361 6e63 656c 5f73 746f    def cancel_sto
-0000ed50: 706c 6f73 735f 6f72 6465 725f 7769 7468  ploss_order_with
-0000ed60: 5f72 6573 756c 7428 7365 6c66 2c20 6f72  _result(self, or
-0000ed70: 6465 725f 6964 3a20 7374 722c 2070 6169  der_id: str, pai
-0000ed80: 723a 2073 7472 2c20 616d 6f75 6e74 3a20  r: str, amount: 
-0000ed90: 666c 6f61 7429 202d 3e20 4469 6374 3a0a  float) -> Dict:.
-0000eda0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000edb0: 2020 2020 4361 6e63 656c 2073 746f 706c      Cancel stopl
-0000edc0: 6f73 7320 6f72 6465 7220 7265 7475 726e  oss order return
-0000edd0: 696e 6720 6120 7265 7375 6c74 2e0a 2020  ing a result..  
-0000ede0: 2020 2020 2020 4372 6561 7465 7320 6120        Creates a 
-0000edf0: 6661 6b65 2072 6573 756c 7420 6966 2063  fake result if c
-0000ee00: 616e 6365 6c20 6f72 6465 7220 7265 7475  ancel order retu
-0000ee10: 726e 7320 6120 6e6f 6e2d 7573 6162 6c65  rns a non-usable
-0000ee20: 2072 6573 756c 740a 2020 2020 2020 2020   result.        
-0000ee30: 616e 6420 6665 7463 685f 6f72 6465 7220  and fetch_order 
-0000ee40: 646f 6573 206e 6f74 2077 6f72 6b20 2863  does not work (c
-0000ee50: 6572 7461 696e 2065 7863 6861 6e67 6573  ertain exchanges
-0000ee60: 2064 6f6e 2774 2072 6574 7572 6e20 6361   don't return ca
-0000ee70: 6e63 656c 6c65 6420 6f72 6465 7273 290a  ncelled orders).
-0000ee80: 2020 2020 2020 2020 3a70 6172 616d 206f          :param o
-0000ee90: 7264 6572 5f69 643a 2073 746f 706c 6f73  rder_id: stoplos
-0000eea0: 732d 6f72 6465 722d 6964 2074 6f20 6361  s-order-id to ca
-0000eeb0: 6e63 656c 0a20 2020 2020 2020 203a 7061  ncel.        :pa
-0000eec0: 7261 6d20 7061 6972 3a20 5061 6972 2063  ram pair: Pair c
-0000eed0: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
-0000eee0: 6f72 6465 725f 6964 0a20 2020 2020 2020  order_id.       
-0000eef0: 203a 7061 7261 6d20 616d 6f75 6e74 3a20   :param amount: 
-0000ef00: 416d 6f75 6e74 2074 6f20 7573 6520 666f  Amount to use fo
-0000ef10: 7220 6661 6b65 2072 6573 706f 6e73 650a  r fake response.
-0000ef20: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-0000ef30: 2052 6573 756c 7420 6672 6f6d 2065 6974   Result from eit
-0000ef40: 6865 7220 6361 6e63 656c 5f6f 7264 6572  her cancel_order
-0000ef50: 2069 6620 7573 6162 6c65 2c20 6f72 2066   if usable, or f
-0000ef60: 6574 6368 5f6f 7264 6572 0a20 2020 2020  etch_order.     
-0000ef70: 2020 2022 2222 0a20 2020 2020 2020 2063     """.        c
-0000ef80: 6f72 6465 7220 3d20 7365 6c66 2e63 616e  order = self.can
-0000ef90: 6365 6c5f 7374 6f70 6c6f 7373 5f6f 7264  cel_stoploss_ord
-0000efa0: 6572 286f 7264 6572 5f69 642c 2070 6169  er(order_id, pai
-0000efb0: 7229 0a20 2020 2020 2020 2069 6620 7365  r).        if se
-0000efc0: 6c66 2e69 735f 6361 6e63 656c 5f6f 7264  lf.is_cancel_ord
-0000efd0: 6572 5f72 6573 756c 745f 7375 6974 6162  er_result_suitab
-0000efe0: 6c65 2863 6f72 6465 7229 3a0a 2020 2020  le(corder):.    
-0000eff0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-0000f000: 6f72 6465 720a 2020 2020 2020 2020 7472  order.        tr
-0000f010: 793a 0a20 2020 2020 2020 2020 2020 206f  y:.            o
-0000f020: 7264 6572 203d 2073 656c 662e 6665 7463  rder = self.fetc
-0000f030: 685f 7374 6f70 6c6f 7373 5f6f 7264 6572  h_stoploss_order
-0000f040: 286f 7264 6572 5f69 642c 2070 6169 7229  (order_id, pair)
-0000f050: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0000f060: 496e 7661 6c69 644f 7264 6572 4578 6365  InvalidOrderExce
-0000f070: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
-0000f080: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-0000f090: 6728 6622 436f 756c 6420 6e6f 7420 6665  g(f"Could not fe
-0000f0a0: 7463 6820 6361 6e63 656c 6c65 6420 7374  tch cancelled st
-0000f0b0: 6f70 6c6f 7373 206f 7264 6572 207b 6f72  oploss order {or
-0000f0c0: 6465 725f 6964 7d2e 2229 0a20 2020 2020  der_id}.").     
-0000f0d0: 2020 2020 2020 206f 7264 6572 203d 207b         order = {
-0000f0e0: 2766 6565 273a 207b 7d2c 2027 7374 6174  'fee': {}, 'stat
-0000f0f0: 7573 273a 2027 6361 6e63 656c 6564 272c  us': 'canceled',
-0000f100: 2027 616d 6f75 6e74 273a 2061 6d6f 756e   'amount': amoun
-0000f110: 742c 2027 696e 666f 273a 207b 7d7d 0a0a  t, 'info': {}}..
-0000f120: 2020 2020 2020 2020 7265 7475 726e 206f          return o
-0000f130: 7264 6572 0a0a 2020 2020 4072 6574 7269  rder..    @retri
-0000f140: 6572 0a20 2020 2064 6566 2067 6574 5f62  er.    def get_b
-0000f150: 616c 616e 6365 7328 7365 6c66 2920 2d3e  alances(self) ->
-0000f160: 2064 6963 743a 0a0a 2020 2020 2020 2020   dict:..        
-0000f170: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000f180: 2062 616c 616e 6365 7320 3d20 7365 6c66   balances = self
-0000f190: 2e5f 6170 692e 6665 7463 685f 6261 6c61  ._api.fetch_bala
-0000f1a0: 6e63 6528 290a 2020 2020 2020 2020 2020  nce().          
-0000f1b0: 2020 2320 5265 6d6f 7665 2061 6464 6974    # Remove addit
-0000f1c0: 696f 6e61 6c20 696e 666f 2066 726f 6d20  ional info from 
-0000f1d0: 6363 7874 2072 6573 756c 7473 0a20 2020  ccxt results.   
-0000f1e0: 2020 2020 2020 2020 2062 616c 616e 6365           balance
-0000f1f0: 732e 706f 7028 2269 6e66 6f22 2c20 4e6f  s.pop("info", No
-0000f200: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-0000f210: 6261 6c61 6e63 6573 2e70 6f70 2822 6672  balances.pop("fr
-0000f220: 6565 222c 204e 6f6e 6529 0a20 2020 2020  ee", None).     
-0000f230: 2020 2020 2020 2062 616c 616e 6365 732e         balances.
-0000f240: 706f 7028 2274 6f74 616c 222c 204e 6f6e  pop("total", Non
-0000f250: 6529 0a20 2020 2020 2020 2020 2020 2062  e).            b
-0000f260: 616c 616e 6365 732e 706f 7028 2275 7365  alances.pop("use
-0000f270: 6422 2c20 4e6f 6e65 290a 0a20 2020 2020  d", None)..     
-0000f280: 2020 2020 2020 2072 6574 7572 6e20 6261         return ba
-0000f290: 6c61 6e63 6573 0a20 2020 2020 2020 2065  lances.        e
-0000f2a0: 7863 6570 7420 6363 7874 2e44 446f 5350  xcept ccxt.DDoSP
-0000f2b0: 726f 7465 6374 696f 6e20 6173 2065 3a0a  rotection as e:.
-0000f2c0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000f2d0: 6520 4444 6f73 5072 6f74 6563 7469 6f6e  e DDosProtection
-0000f2e0: 2865 2920 6672 6f6d 2065 0a20 2020 2020  (e) from e.     
-0000f2f0: 2020 2065 7863 6570 7420 2863 6378 742e     except (ccxt.
-0000f300: 4e65 7477 6f72 6b45 7272 6f72 2c20 6363  NetworkError, cc
-0000f310: 7874 2e45 7863 6861 6e67 6545 7272 6f72  xt.ExchangeError
-0000f320: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
-0000f330: 2020 2020 7261 6973 6520 5465 6d70 6f72      raise Tempor
-0000f340: 6172 7945 7272 6f72 280a 2020 2020 2020  aryError(.      
-0000f350: 2020 2020 2020 2020 2020 6627 436f 756c            f'Coul
-0000f360: 6420 6e6f 7420 6765 7420 6261 6c61 6e63  d not get balanc
-0000f370: 6520 6475 6520 746f 207b 652e 5f5f 636c  e due to {e.__cl
-0000f380: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d2e  ass__.__name__}.
-0000f390: 204d 6573 7361 6765 3a20 7b65 7d27 2920   Message: {e}') 
-0000f3a0: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
-0000f3b0: 7863 6570 7420 6363 7874 2e42 6173 6545  xcept ccxt.BaseE
-0000f3c0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-0000f3d0: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
-0000f3e0: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
-0000f3f0: 6e28 6529 2066 726f 6d20 650a 0a20 2020  n(e) from e..   
-0000f400: 2040 7265 7472 6965 720a 2020 2020 6465   @retrier.    de
-0000f410: 6620 6665 7463 685f 706f 7369 7469 6f6e  f fetch_position
-0000f420: 7328 7365 6c66 2c20 7061 6972 3a20 4f70  s(self, pair: Op
-0000f430: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-0000f440: 6e65 2920 2d3e 204c 6973 745b 4469 6374  ne) -> List[Dict
-0000f450: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-0000f460: 2020 2020 2020 2046 6574 6368 2070 6f73         Fetch pos
-0000f470: 6974 696f 6e73 2066 726f 6d20 7468 6520  itions from the 
-0000f480: 6578 6368 616e 6765 2e0a 2020 2020 2020  exchange..      
-0000f490: 2020 4966 206e 6f20 7061 6972 2069 7320    If no pair is 
-0000f4a0: 6769 7665 6e2c 2061 6c6c 2070 6f73 6974  given, all posit
-0000f4b0: 696f 6e73 2061 7265 2072 6574 7572 6e65  ions are returne
-0000f4c0: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
-0000f4d0: 6d20 7061 6972 3a20 5061 6972 2066 6f72  m pair: Pair for
-0000f4e0: 2074 6865 2071 7565 7279 0a20 2020 2020   the query.     
-0000f4f0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-0000f500: 6620 7365 6c66 2e5f 636f 6e66 6967 5b27  f self._config['
-0000f510: 6472 795f 7275 6e27 5d20 6f72 2073 656c  dry_run'] or sel
-0000f520: 662e 7472 6164 696e 675f 6d6f 6465 2021  f.trading_mode !
-0000f530: 3d20 5472 6164 696e 674d 6f64 652e 4655  = TradingMode.FU
-0000f540: 5455 5245 533a 0a20 2020 2020 2020 2020  TURES:.         
-0000f550: 2020 2072 6574 7572 6e20 5b5d 0a20 2020     return [].   
-0000f560: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000f570: 2020 2020 2020 7379 6d62 6f6c 7320 3d20        symbols = 
-0000f580: 5b5d 0a20 2020 2020 2020 2020 2020 2069  [].            i
-0000f590: 6620 7061 6972 3a0a 2020 2020 2020 2020  f pair:.        
-0000f5a0: 2020 2020 2020 2020 7379 6d62 6f6c 732e          symbols.
-0000f5b0: 6170 7065 6e64 2870 6169 7229 0a20 2020  append(pair).   
-0000f5c0: 2020 2020 2020 2020 2070 6f73 6974 696f           positio
-0000f5d0: 6e73 3a20 4c69 7374 5b44 6963 745d 203d  ns: List[Dict] =
-0000f5e0: 2073 656c 662e 5f61 7069 2e66 6574 6368   self._api.fetch
-0000f5f0: 5f70 6f73 6974 696f 6e73 2873 796d 626f  _positions(symbo
-0000f600: 6c73 290a 2020 2020 2020 2020 2020 2020  ls).            
-0000f610: 7365 6c66 2e5f 6c6f 675f 6578 6368 616e  self._log_exchan
-0000f620: 6765 5f72 6573 706f 6e73 6528 2766 6574  ge_response('fet
-0000f630: 6368 5f70 6f73 6974 696f 6e73 272c 2070  ch_positions', p
-0000f640: 6f73 6974 696f 6e73 290a 2020 2020 2020  ositions).      
-0000f650: 2020 2020 2020 7265 7475 726e 2070 6f73        return pos
-0000f660: 6974 696f 6e73 0a20 2020 2020 2020 2065  itions.        e
-0000f670: 7863 6570 7420 6363 7874 2e44 446f 5350  xcept ccxt.DDoSP
-0000f680: 726f 7465 6374 696f 6e20 6173 2065 3a0a  rotection as e:.
-0000f690: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000f6a0: 6520 4444 6f73 5072 6f74 6563 7469 6f6e  e DDosProtection
-0000f6b0: 2865 2920 6672 6f6d 2065 0a20 2020 2020  (e) from e.     
-0000f6c0: 2020 2065 7863 6570 7420 2863 6378 742e     except (ccxt.
-0000f6d0: 4e65 7477 6f72 6b45 7272 6f72 2c20 6363  NetworkError, cc
-0000f6e0: 7874 2e45 7863 6861 6e67 6545 7272 6f72  xt.ExchangeError
-0000f6f0: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
-0000f700: 2020 2020 7261 6973 6520 5465 6d70 6f72      raise Tempor
-0000f710: 6172 7945 7272 6f72 280a 2020 2020 2020  aryError(.      
-0000f720: 2020 2020 2020 2020 2020 6627 436f 756c            f'Coul
-0000f730: 6420 6e6f 7420 6765 7420 706f 7369 7469  d not get positi
-0000f740: 6f6e 7320 6475 6520 746f 207b 652e 5f5f  ons due to {e.__
-0000f750: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
-0000f760: 7d2e 204d 6573 7361 6765 3a20 7b65 7d27  }. Message: {e}'
-0000f770: 2920 6672 6f6d 2065 0a20 2020 2020 2020  ) from e.       
-0000f780: 2065 7863 6570 7420 6363 7874 2e42 6173   except ccxt.Bas
-0000f790: 6545 7272 6f72 2061 7320 653a 0a20 2020  eError as e:.   
-0000f7a0: 2020 2020 2020 2020 2072 6169 7365 204f           raise O
-0000f7b0: 7065 7261 7469 6f6e 616c 4578 6365 7074  perationalExcept
-0000f7c0: 696f 6e28 6529 2066 726f 6d20 650a 0a20  ion(e) from e.. 
-0000f7d0: 2020 2040 7265 7472 6965 720a 2020 2020     @retrier.    
-0000f7e0: 6465 6620 6665 7463 685f 7472 6164 696e  def fetch_tradin
-0000f7f0: 675f 6665 6573 2873 656c 6629 202d 3e20  g_fees(self) -> 
-0000f800: 4469 6374 5b73 7472 2c20 416e 795d 3a0a  Dict[str, Any]:.
-0000f810: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000f820: 2020 2020 4665 7463 6820 7573 6572 2061      Fetch user a
-0000f830: 6363 6f75 6e74 2074 7261 6469 6e67 2066  ccount trading f
-0000f840: 6565 730a 2020 2020 2020 2020 4361 6e20  ees.        Can 
-0000f850: 6265 2063 6163 6865 642c 2073 686f 756c  be cached, shoul
-0000f860: 6420 6e6f 7420 7570 6461 7465 206f 6674  d not update oft
-0000f870: 656e 2e0a 2020 2020 2020 2020 2222 220a  en..        """.
-0000f880: 2020 2020 2020 2020 6966 2028 7365 6c66          if (self
-0000f890: 2e5f 636f 6e66 6967 5b27 6472 795f 7275  ._config['dry_ru
-0000f8a0: 6e27 5d20 6f72 2073 656c 662e 7472 6164  n'] or self.trad
-0000f8b0: 696e 675f 6d6f 6465 2021 3d20 5472 6164  ing_mode != Trad
-0000f8c0: 696e 674d 6f64 652e 4655 5455 5245 530a  ingMode.FUTURES.
-0000f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8e0: 6f72 206e 6f74 2073 656c 662e 6578 6368  or not self.exch
-0000f8f0: 616e 6765 5f68 6173 2827 6665 7463 6854  ange_has('fetchT
-0000f900: 7261 6469 6e67 4665 6573 2729 293a 0a20  radingFees')):. 
-0000f910: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f920: 6e20 7b7d 0a20 2020 2020 2020 2074 7279  n {}.        try
-0000f930: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-0000f940: 6164 696e 675f 6665 6573 3a20 4469 6374  ading_fees: Dict
-0000f950: 5b73 7472 2c20 416e 795d 203d 2073 656c  [str, Any] = sel
-0000f960: 662e 5f61 7069 2e66 6574 6368 5f74 7261  f._api.fetch_tra
-0000f970: 6469 6e67 5f66 6565 7328 290a 2020 2020  ding_fees().    
-0000f980: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-0000f990: 675f 6578 6368 616e 6765 5f72 6573 706f  g_exchange_respo
-0000f9a0: 6e73 6528 2766 6574 6368 5f74 7261 6469  nse('fetch_tradi
-0000f9b0: 6e67 5f66 6565 7327 2c20 7472 6164 696e  ng_fees', tradin
-0000f9c0: 675f 6665 6573 290a 2020 2020 2020 2020  g_fees).        
-0000f9d0: 2020 2020 7265 7475 726e 2074 7261 6469      return tradi
-0000f9e0: 6e67 5f66 6565 730a 2020 2020 2020 2020  ng_fees.        
-0000f9f0: 6578 6365 7074 2063 6378 742e 4444 6f53  except ccxt.DDoS
-0000fa00: 5072 6f74 6563 7469 6f6e 2061 7320 653a  Protection as e:
-0000fa10: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000fa20: 7365 2044 446f 7350 726f 7465 6374 696f  se DDosProtectio
-0000fa30: 6e28 6529 2066 726f 6d20 650a 2020 2020  n(e) from e.    
-0000fa40: 2020 2020 6578 6365 7074 2028 6363 7874      except (ccxt
-0000fa50: 2e4e 6574 776f 726b 4572 726f 722c 2063  .NetworkError, c
-0000fa60: 6378 742e 4578 6368 616e 6765 4572 726f  cxt.ExchangeErro
-0000fa70: 7229 2061 7320 653a 0a20 2020 2020 2020  r) as e:.       
-0000fa80: 2020 2020 2072 6169 7365 2054 656d 706f       raise Tempo
-0000fa90: 7261 7279 4572 726f 7228 0a20 2020 2020  raryError(.     
-0000faa0: 2020 2020 2020 2020 2020 2066 2743 6f75             f'Cou
-0000fab0: 6c64 206e 6f74 2066 6574 6368 2074 7261  ld not fetch tra
-0000fac0: 6469 6e67 2066 6565 7320 6475 6520 746f  ding fees due to
-0000fad0: 207b 652e 5f5f 636c 6173 735f 5f2e 5f5f   {e.__class__.__
-0000fae0: 6e61 6d65 5f5f 7d2e 204d 6573 7361 6765  name__}. Message
-0000faf0: 3a20 7b65 7d27 2920 6672 6f6d 2065 0a20  : {e}') from e. 
-0000fb00: 2020 2020 2020 2065 7863 6570 7420 6363         except cc
-0000fb10: 7874 2e42 6173 6545 7272 6f72 2061 7320  xt.BaseError as 
-0000fb20: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000fb30: 6169 7365 204f 7065 7261 7469 6f6e 616c  aise Operational
-0000fb40: 4578 6365 7074 696f 6e28 6529 2066 726f  Exception(e) fro
-0000fb50: 6d20 650a 0a20 2020 2040 7265 7472 6965  m e..    @retrie
-0000fb60: 720a 2020 2020 6465 6620 6665 7463 685f  r.    def fetch_
-0000fb70: 6269 6473 5f61 736b 7328 7365 6c66 2c20  bids_asks(self, 
-0000fb80: 7379 6d62 6f6c 733a 204f 7074 696f 6e61  symbols: Optiona
-0000fb90: 6c5b 4c69 7374 5b73 7472 5d5d 203d 204e  l[List[str]] = N
-0000fba0: 6f6e 652c 2063 6163 6865 643a 2062 6f6f  one, cached: boo
-0000fbb0: 6c20 3d20 4661 6c73 6529 202d 3e20 4469  l = False) -> Di
-0000fbc0: 6374 3a0a 2020 2020 2020 2020 2222 220a  ct:.        """.
-0000fbd0: 2020 2020 2020 2020 3a70 6172 616d 2063          :param c
-0000fbe0: 6163 6865 643a 2041 6c6c 6f77 2063 6163  ached: Allow cac
-0000fbf0: 6865 6420 7265 7375 6c74 0a20 2020 2020  hed result.     
-0000fc00: 2020 203a 7265 7475 726e 3a20 6665 7463     :return: fetc
-0000fc10: 685f 7469 636b 6572 7320 7265 7375 6c74  h_tickers result
-0000fc20: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000fc30: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-0000fc40: 2e65 7863 6861 6e67 655f 6861 7328 2766  .exchange_has('f
-0000fc50: 6574 6368 4269 6473 4173 6b73 2729 3a0a  etchBidsAsks'):.
-0000fc60: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000fc70: 726e 207b 7d0a 2020 2020 2020 2020 6966  rn {}.        if
-0000fc80: 2063 6163 6865 643a 0a20 2020 2020 2020   cached:.       
-0000fc90: 2020 2020 2077 6974 6820 7365 6c66 2e5f       with self._
-0000fca0: 6361 6368 655f 6c6f 636b 3a0a 2020 2020  cache_lock:.    
-0000fcb0: 2020 2020 2020 2020 2020 2020 7469 636b              tick
-0000fcc0: 6572 7320 3d20 7365 6c66 2e5f 6665 7463  ers = self._fetc
-0000fcd0: 685f 7469 636b 6572 735f 6361 6368 652e  h_tickers_cache.
-0000fce0: 6765 7428 2766 6574 6368 5f62 6964 735f  get('fetch_bids_
-0000fcf0: 6173 6b73 2729 0a20 2020 2020 2020 2020  asks').         
-0000fd00: 2020 2069 6620 7469 636b 6572 733a 0a20     if tickers:. 
-0000fd10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000fd20: 6574 7572 6e20 7469 636b 6572 730a 2020  eturn tickers.  
-0000fd30: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000fd40: 2020 2020 2020 2074 6963 6b65 7273 203d         tickers =
-0000fd50: 2073 656c 662e 5f61 7069 2e66 6574 6368   self._api.fetch
-0000fd60: 5f62 6964 735f 6173 6b73 2873 796d 626f  _bids_asks(symbo
-0000fd70: 6c73 290a 2020 2020 2020 2020 2020 2020  ls).            
-0000fd80: 7769 7468 2073 656c 662e 5f63 6163 6865  with self._cache
-0000fd90: 5f6c 6f63 6b3a 0a20 2020 2020 2020 2020  _lock:.         
-0000fda0: 2020 2020 2020 2073 656c 662e 5f66 6574         self._fet
-0000fdb0: 6368 5f74 6963 6b65 7273 5f63 6163 6865  ch_tickers_cache
-0000fdc0: 5b27 6665 7463 685f 6269 6473 5f61 736b  ['fetch_bids_ask
-0000fdd0: 7327 5d20 3d20 7469 636b 6572 730a 2020  s'] = tickers.  
-0000fde0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000fdf0: 2074 6963 6b65 7273 0a20 2020 2020 2020   tickers.       
-0000fe00: 2065 7863 6570 7420 6363 7874 2e4e 6f74   except ccxt.Not
-0000fe10: 5375 7070 6f72 7465 6420 6173 2065 3a0a  Supported as e:.
-0000fe20: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000fe30: 6520 4f70 6572 6174 696f 6e61 6c45 7863  e OperationalExc
-0000fe40: 6570 7469 6f6e 280a 2020 2020 2020 2020  eption(.        
-0000fe50: 2020 2020 2020 2020 6627 4578 6368 616e          f'Exchan
-0000fe60: 6765 207b 7365 6c66 2e5f 6170 692e 6e61  ge {self._api.na
-0000fe70: 6d65 7d20 646f 6573 206e 6f74 2073 7570  me} does not sup
-0000fe80: 706f 7274 2066 6574 6368 696e 6720 6269  port fetching bi
-0000fe90: 6473 2f61 736b 7320 696e 2062 6174 6368  ds/asks in batch
-0000fea0: 2e20 270a 2020 2020 2020 2020 2020 2020  . '.            
-0000feb0: 2020 2020 6627 4d65 7373 6167 653a 207b      f'Message: {
-0000fec0: 657d 2729 2066 726f 6d20 650a 2020 2020  e}') from e.    
-0000fed0: 2020 2020 6578 6365 7074 2063 6378 742e      except ccxt.
-0000fee0: 4444 6f53 5072 6f74 6563 7469 6f6e 2061  DDoSProtection a
-0000fef0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-0000ff00: 2072 6169 7365 2044 446f 7350 726f 7465   raise DDosProte
-0000ff10: 6374 696f 6e28 6529 2066 726f 6d20 650a  ction(e) from e.
-0000ff20: 2020 2020 2020 2020 6578 6365 7074 2028          except (
-0000ff30: 6363 7874 2e4e 6574 776f 726b 4572 726f  ccxt.NetworkErro
-0000ff40: 722c 2063 6378 742e 4578 6368 616e 6765  r, ccxt.Exchange
-0000ff50: 4572 726f 7229 2061 7320 653a 0a20 2020  Error) as e:.   
-0000ff60: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-0000ff70: 656d 706f 7261 7279 4572 726f 7228 0a20  emporaryError(. 
-0000ff80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000ff90: 2743 6f75 6c64 206e 6f74 206c 6f61 6420  'Could not load 
-0000ffa0: 6269 6473 2f61 736b 7320 6475 6520 746f  bids/asks due to
-0000ffb0: 207b 652e 5f5f 636c 6173 735f 5f2e 5f5f   {e.__class__.__
-0000ffc0: 6e61 6d65 5f5f 7d2e 204d 6573 7361 6765  name__}. Message
-0000ffd0: 3a20 7b65 7d27 2920 6672 6f6d 2065 0a20  : {e}') from e. 
-0000ffe0: 2020 2020 2020 2065 7863 6570 7420 6363         except cc
-0000fff0: 7874 2e42 6173 6545 7272 6f72 2061 7320  xt.BaseError as 
-00010000: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00010010: 6169 7365 204f 7065 7261 7469 6f6e 616c  aise Operational
-00010020: 4578 6365 7074 696f 6e28 6529 2066 726f  Exception(e) fro
-00010030: 6d20 650a 0a20 2020 2040 7265 7472 6965  m e..    @retrie
-00010040: 720a 2020 2020 6465 6620 6765 745f 7469  r.    def get_ti
-00010050: 636b 6572 7328 7365 6c66 2c20 7379 6d62  ckers(self, symb
-00010060: 6f6c 733a 204f 7074 696f 6e61 6c5b 4c69  ols: Optional[Li
-00010070: 7374 5b73 7472 5d5d 203d 204e 6f6e 652c  st[str]] = None,
-00010080: 2063 6163 6865 643a 2062 6f6f 6c20 3d20   cached: bool = 
-00010090: 4661 6c73 6529 202d 3e20 5469 636b 6572  False) -> Ticker
-000100a0: 733a 0a20 2020 2020 2020 2022 2222 0a20  s:.        """. 
-000100b0: 2020 2020 2020 203a 7061 7261 6d20 6361         :param ca
-000100c0: 6368 6564 3a20 416c 6c6f 7720 6361 6368  ched: Allow cach
-000100d0: 6564 2072 6573 756c 740a 2020 2020 2020  ed result.      
-000100e0: 2020 3a72 6574 7572 6e3a 2066 6574 6368    :return: fetch
-000100f0: 5f74 6963 6b65 7273 2072 6573 756c 740a  _tickers result.
-00010100: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00010110: 2020 2020 7469 636b 6572 733a 2054 6963      tickers: Tic
-00010120: 6b65 7273 0a20 2020 2020 2020 2069 6620  kers.        if 
-00010130: 6e6f 7420 7365 6c66 2e65 7863 6861 6e67  not self.exchang
-00010140: 655f 6861 7328 2766 6574 6368 5469 636b  e_has('fetchTick
-00010150: 6572 7327 293a 0a20 2020 2020 2020 2020  ers'):.         
-00010160: 2020 2072 6574 7572 6e20 7b7d 0a20 2020     return {}.   
-00010170: 2020 2020 2069 6620 6361 6368 6564 3a0a       if cached:.
-00010180: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00010190: 2073 656c 662e 5f63 6163 6865 5f6c 6f63   self._cache_loc
-000101a0: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
-000101b0: 2020 2074 6963 6b65 7273 203d 2073 656c     tickers = sel
-000101c0: 662e 5f66 6574 6368 5f74 6963 6b65 7273  f._fetch_tickers
-000101d0: 5f63 6163 6865 2e67 6574 2827 6665 7463  _cache.get('fetc
-000101e0: 685f 7469 636b 6572 7327 2920 2023 2074  h_tickers')  # t
-000101f0: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-00010200: 2020 2020 2020 2020 6966 2074 6963 6b65          if ticke
-00010210: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00010220: 2020 2020 7265 7475 726e 2074 6963 6b65      return ticke
-00010230: 7273 0a20 2020 2020 2020 2074 7279 3a0a  rs.        try:.
-00010240: 2020 2020 2020 2020 2020 2020 7469 636b              tick
-00010250: 6572 7320 3d20 7365 6c66 2e5f 6170 692e  ers = self._api.
-00010260: 6665 7463 685f 7469 636b 6572 7328 7379  fetch_tickers(sy
-00010270: 6d62 6f6c 7329 0a20 2020 2020 2020 2020  mbols).         
-00010280: 2020 2077 6974 6820 7365 6c66 2e5f 6361     with self._ca
-00010290: 6368 655f 6c6f 636b 3a0a 2020 2020 2020  che_lock:.      
-000102a0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000102b0: 6665 7463 685f 7469 636b 6572 735f 6361  fetch_tickers_ca
-000102c0: 6368 655b 2766 6574 6368 5f74 6963 6b65  che['fetch_ticke
-000102d0: 7273 275d 203d 2074 6963 6b65 7273 0a20  rs'] = tickers. 
-000102e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000102f0: 6e20 7469 636b 6572 730a 2020 2020 2020  n tickers.      
-00010300: 2020 6578 6365 7074 2063 6378 742e 4e6f    except ccxt.No
-00010310: 7453 7570 706f 7274 6564 2061 7320 653a  tSupported as e:
-00010320: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00010330: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
-00010340: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
-00010350: 2020 2020 2020 2020 2066 2745 7863 6861           f'Excha
-00010360: 6e67 6520 7b73 656c 662e 5f61 7069 2e6e  nge {self._api.n
-00010370: 616d 657d 2064 6f65 7320 6e6f 7420 7375  ame} does not su
-00010380: 7070 6f72 7420 6665 7463 6869 6e67 2074  pport fetching t
-00010390: 6963 6b65 7273 2069 6e20 6261 7463 682e  ickers in batch.
-000103a0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000103b0: 2020 2066 274d 6573 7361 6765 3a20 7b65     f'Message: {e
-000103c0: 7d27 2920 6672 6f6d 2065 0a20 2020 2020  }') from e.     
-000103d0: 2020 2065 7863 6570 7420 6363 7874 2e44     except ccxt.D
-000103e0: 446f 5350 726f 7465 6374 696f 6e20 6173  DoSProtection as
-000103f0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00010400: 7261 6973 6520 4444 6f73 5072 6f74 6563  raise DDosProtec
-00010410: 7469 6f6e 2865 2920 6672 6f6d 2065 0a20  tion(e) from e. 
-00010420: 2020 2020 2020 2065 7863 6570 7420 2863         except (c
-00010430: 6378 742e 4e65 7477 6f72 6b45 7272 6f72  cxt.NetworkError
-00010440: 2c20 6363 7874 2e45 7863 6861 6e67 6545  , ccxt.ExchangeE
-00010450: 7272 6f72 2920 6173 2065 3a0a 2020 2020  rror) as e:.    
-00010460: 2020 2020 2020 2020 7261 6973 6520 5465          raise Te
-00010470: 6d70 6f72 6172 7945 7272 6f72 280a 2020  mporaryError(.  
-00010480: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00010490: 436f 756c 6420 6e6f 7420 6c6f 6164 2074  Could not load t
-000104a0: 6963 6b65 7273 2064 7565 2074 6f20 7b65  ickers due to {e
-000104b0: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
-000104c0: 655f 5f7d 2e20 4d65 7373 6167 653a 207b  e__}. Message: {
-000104d0: 657d 2729 2066 726f 6d20 650a 2020 2020  e}') from e.    
-000104e0: 2020 2020 6578 6365 7074 2063 6378 742e      except ccxt.
-000104f0: 4261 7365 4572 726f 7220 6173 2065 3a0a  BaseError as e:.
-00010500: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00010510: 6520 4f70 6572 6174 696f 6e61 6c45 7863  e OperationalExc
-00010520: 6570 7469 6f6e 2865 2920 6672 6f6d 2065  eption(e) from e
-00010530: 0a0a 2020 2020 2320 5072 6963 696e 6720  ..    # Pricing 
-00010540: 696e 666f 0a0a 2020 2020 4072 6574 7269  info..    @retri
-00010550: 6572 0a20 2020 2064 6566 2066 6574 6368  er.    def fetch
-00010560: 5f74 6963 6b65 7228 7365 6c66 2c20 7061  _ticker(self, pa
-00010570: 6972 3a20 7374 7229 202d 3e20 5469 636b  ir: str) -> Tick
-00010580: 6572 3a0a 2020 2020 2020 2020 7472 793a  er:.        try:
-00010590: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000105a0: 2870 6169 7220 6e6f 7420 696e 2073 656c  (pair not in sel
-000105b0: 662e 6d61 726b 6574 7320 6f72 0a20 2020  f.markets or.   
-000105c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105d0: 2073 656c 662e 6d61 726b 6574 735b 7061   self.markets[pa
-000105e0: 6972 5d2e 6765 7428 2761 6374 6976 6527  ir].get('active'
-000105f0: 2c20 4661 6c73 6529 2069 7320 4661 6c73  , False) is Fals
-00010600: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00010610: 2020 2020 7261 6973 6520 4578 6368 616e      raise Exchan
-00010620: 6765 4572 726f 7228 6622 5061 6972 207b  geError(f"Pair {
-00010630: 7061 6972 7d20 6e6f 7420 6176 6169 6c61  pair} not availa
-00010640: 626c 6522 290a 2020 2020 2020 2020 2020  ble").          
-00010650: 2020 6461 7461 3a20 5469 636b 6572 203d    data: Ticker =
-00010660: 2073 656c 662e 5f61 7069 2e66 6574 6368   self._api.fetch
-00010670: 5f74 6963 6b65 7228 7061 6972 290a 2020  _ticker(pair).  
-00010680: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00010690: 2064 6174 610a 2020 2020 2020 2020 6578   data.        ex
-000106a0: 6365 7074 2063 6378 742e 4444 6f53 5072  cept ccxt.DDoSPr
-000106b0: 6f74 6563 7469 6f6e 2061 7320 653a 0a20  otection as e:. 
-000106c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000106d0: 2044 446f 7350 726f 7465 6374 696f 6e28   DDosProtection(
-000106e0: 6529 2066 726f 6d20 650a 2020 2020 2020  e) from e.      
-000106f0: 2020 6578 6365 7074 2028 6363 7874 2e4e    except (ccxt.N
-00010700: 6574 776f 726b 4572 726f 722c 2063 6378  etworkError, ccx
-00010710: 742e 4578 6368 616e 6765 4572 726f 7229  t.ExchangeError)
-00010720: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00010730: 2020 2072 6169 7365 2054 656d 706f 7261     raise Tempora
-00010740: 7279 4572 726f 7228 0a20 2020 2020 2020  ryError(.       
-00010750: 2020 2020 2020 2020 2066 2743 6f75 6c64           f'Could
-00010760: 206e 6f74 206c 6f61 6420 7469 636b 6572   not load ticker
-00010770: 2064 7565 2074 6f20 7b65 2e5f 5f63 6c61   due to {e.__cla
-00010780: 7373 5f5f 2e5f 5f6e 616d 655f 5f7d 2e20  ss__.__name__}. 
-00010790: 4d65 7373 6167 653a 207b 657d 2729 2066  Message: {e}') f
-000107a0: 726f 6d20 650a 2020 2020 2020 2020 6578  rom e.        ex
-000107b0: 6365 7074 2063 6378 742e 4261 7365 4572  cept ccxt.BaseEr
-000107c0: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
-000107d0: 2020 2020 2020 7261 6973 6520 4f70 6572        raise Oper
-000107e0: 6174 696f 6e61 6c45 7863 6570 7469 6f6e  ationalException
-000107f0: 2865 2920 6672 6f6d 2065 0a0a 2020 2020  (e) from e..    
-00010800: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-00010810: 2020 6465 6620 6765 745f 6e65 7874 5f6c    def get_next_l
-00010820: 696d 6974 5f69 6e5f 6c69 7374 286c 696d  imit_in_list(lim
-00010830: 6974 3a20 696e 742c 206c 696d 6974 5f72  it: int, limit_r
-00010840: 616e 6765 3a20 4f70 7469 6f6e 616c 5b4c  ange: Optional[L
-00010850: 6973 745b 696e 745d 5d2c 0a20 2020 2020  ist[int]],.     
-00010860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010870: 2020 2020 2020 2020 2020 7261 6e67 655f            range_
-00010880: 7265 7175 6972 6564 3a20 626f 6f6c 203d  required: bool =
-00010890: 2054 7275 6529 3a0a 2020 2020 2020 2020   True):.        
-000108a0: 2222 220a 2020 2020 2020 2020 4765 7420  """.        Get 
-000108b0: 6e65 7874 2067 7265 6174 6572 2076 616c  next greater val
-000108c0: 7565 2069 6e20 7468 6520 6c69 7374 2e0a  ue in the list..
-000108d0: 2020 2020 2020 2020 5573 6564 2062 7920          Used by 
-000108e0: 6665 7463 685f 6c32 5f6f 7264 6572 5f62  fetch_l2_order_b
-000108f0: 6f6f 6b20 6966 2074 6865 2061 7069 206f  ook if the api o
-00010900: 6e6c 7920 7375 7070 6f72 7473 2061 206c  nly supports a l
-00010910: 696d 6974 6564 2072 616e 6765 0a20 2020  imited range.   
-00010920: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00010930: 2069 6620 6e6f 7420 6c69 6d69 745f 7261   if not limit_ra
-00010940: 6e67 653a 0a20 2020 2020 2020 2020 2020  nge:.           
-00010950: 2072 6574 7572 6e20 6c69 6d69 740a 0a20   return limit.. 
-00010960: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00010970: 6d69 6e28 5b78 2066 6f72 2078 2069 6e20  min([x for x in 
-00010980: 6c69 6d69 745f 7261 6e67 6520 6966 206c  limit_range if l
-00010990: 696d 6974 203c 3d20 785d 202b 205b 6d61  imit <= x] + [ma
-000109a0: 7828 6c69 6d69 745f 7261 6e67 6529 5d29  x(limit_range)])
-000109b0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000109c0: 7261 6e67 655f 7265 7175 6972 6564 2061  range_required a
-000109d0: 6e64 206c 696d 6974 203e 2072 6573 756c  nd limit > resul
-000109e0: 743a 0a20 2020 2020 2020 2020 2020 2023  t:.            #
-000109f0: 2052 616e 6765 2069 7320 6e6f 7420 7265   Range is not re
-00010a00: 7175 6972 6564 202d 2077 6520 6361 6e20  quired - we can 
-00010a10: 7573 6520 4e6f 6e65 2061 7320 7061 7261  use None as para
-00010a20: 6d65 7465 722e 0a20 2020 2020 2020 2020  meter..         
-00010a30: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
-00010a40: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00010a50: 7375 6c74 0a0a 2020 2020 4072 6574 7269  sult..    @retri
-00010a60: 6572 0a20 2020 2064 6566 2066 6574 6368  er.    def fetch
-00010a70: 5f6c 325f 6f72 6465 725f 626f 6f6b 2873  _l2_order_book(s
-00010a80: 656c 662c 2070 6169 723a 2073 7472 2c20  elf, pair: str, 
-00010a90: 6c69 6d69 743a 2069 6e74 203d 2031 3030  limit: int = 100
-00010aa0: 2920 2d3e 204f 7264 6572 426f 6f6b 3a0a  ) -> OrderBook:.
-00010ab0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00010ac0: 2020 2020 4765 7420 4c32 206f 7264 6572      Get L2 order
-00010ad0: 2062 6f6f 6b20 6672 6f6d 2065 7863 6861   book from excha
-00010ae0: 6e67 652e 0a20 2020 2020 2020 2043 616e  nge..        Can
-00010af0: 2062 6520 6c69 6d69 7465 6420 746f 2061   be limited to a
-00010b00: 2063 6572 7461 696e 2061 6d6f 756e 7420   certain amount 
-00010b10: 2869 6620 7375 7070 6f72 7465 6429 2e0a  (if supported)..
-00010b20: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
-00010b30: 6120 6469 6374 2069 6e20 7468 6520 666f  a dict in the fo
-00010b40: 726d 6174 0a20 2020 2020 2020 207b 2761  rmat.        {'a
-00010b50: 736b 7327 3a20 5b70 7269 6365 2c20 766f  sks': [price, vo
-00010b60: 6c75 6d65 5d2c 2027 6269 6473 273a 205b  lume], 'bids': [
-00010b70: 7072 6963 652c 2076 6f6c 756d 655d 7d0a  price, volume]}.
-00010b80: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00010b90: 2020 2020 6c69 6d69 7431 203d 2073 656c      limit1 = sel
-00010ba0: 662e 6765 745f 6e65 7874 5f6c 696d 6974  f.get_next_limit
-00010bb0: 5f69 6e5f 6c69 7374 286c 696d 6974 2c20  _in_list(limit, 
-00010bc0: 7365 6c66 2e5f 6674 5f68 6173 5b27 6c32  self._ft_has['l2
-00010bd0: 5f6c 696d 6974 5f72 616e 6765 275d 2c0a  _limit_range'],.
-00010be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c00: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00010c10: 662e 5f66 745f 6861 735b 276c 325f 6c69  f._ft_has['l2_li
-00010c20: 6d69 745f 7261 6e67 655f 7265 7175 6972  mit_range_requir
-00010c30: 6564 275d 290a 2020 2020 2020 2020 7472  ed']).        tr
-00010c40: 793a 0a0a 2020 2020 2020 2020 2020 2020  y:..            
-00010c50: 7265 7475 726e 2073 656c 662e 5f61 7069  return self._api
-00010c60: 2e66 6574 6368 5f6c 325f 6f72 6465 725f  .fetch_l2_order_
-00010c70: 626f 6f6b 2870 6169 722c 206c 696d 6974  book(pair, limit
-00010c80: 3129 0a20 2020 2020 2020 2065 7863 6570  1).        excep
-00010c90: 7420 6363 7874 2e4e 6f74 5375 7070 6f72  t ccxt.NotSuppor
-00010ca0: 7465 6420 6173 2065 3a0a 2020 2020 2020  ted as e:.      
-00010cb0: 2020 2020 2020 7261 6973 6520 4f70 6572        raise Oper
-00010cc0: 6174 696f 6e61 6c45 7863 6570 7469 6f6e  ationalException
-00010cd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00010ce0: 2020 6627 4578 6368 616e 6765 207b 7365    f'Exchange {se
-00010cf0: 6c66 2e5f 6170 692e 6e61 6d65 7d20 646f  lf._api.name} do
-00010d00: 6573 206e 6f74 2073 7570 706f 7274 2066  es not support f
-00010d10: 6574 6368 696e 6720 6f72 6465 7220 626f  etching order bo
-00010d20: 6f6b 2e27 0a20 2020 2020 2020 2020 2020  ok.'.           
-00010d30: 2020 2020 2066 274d 6573 7361 6765 3a20       f'Message: 
-00010d40: 7b65 7d27 2920 6672 6f6d 2065 0a20 2020  {e}') from e.   
-00010d50: 2020 2020 2065 7863 6570 7420 6363 7874       except ccxt
-00010d60: 2e44 446f 5350 726f 7465 6374 696f 6e20  .DDoSProtection 
-00010d70: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00010d80: 2020 7261 6973 6520 4444 6f73 5072 6f74    raise DDosProt
-00010d90: 6563 7469 6f6e 2865 2920 6672 6f6d 2065  ection(e) from e
-00010da0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00010db0: 2863 6378 742e 4e65 7477 6f72 6b45 7272  (ccxt.NetworkErr
-00010dc0: 6f72 2c20 6363 7874 2e45 7863 6861 6e67  or, ccxt.Exchang
-00010dd0: 6545 7272 6f72 2920 6173 2065 3a0a 2020  eError) as e:.  
-00010de0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00010df0: 5465 6d70 6f72 6172 7945 7272 6f72 280a  TemporaryError(.
-00010e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e10: 6627 436f 756c 6420 6e6f 7420 6765 7420  f'Could not get 
-00010e20: 6f72 6465 7220 626f 6f6b 2064 7565 2074  order book due t
-00010e30: 6f20 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f  o {e.__class__._
-00010e40: 5f6e 616d 655f 5f7d 2e20 4d65 7373 6167  _name__}. Messag
-00010e50: 653a 207b 657d 2729 2066 726f 6d20 650a  e: {e}') from e.
-00010e60: 2020 2020 2020 2020 6578 6365 7074 2063          except c
-00010e70: 6378 742e 4261 7365 4572 726f 7220 6173  cxt.BaseError as
-00010e80: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00010e90: 7261 6973 6520 4f70 6572 6174 696f 6e61  raise Operationa
-00010ea0: 6c45 7863 6570 7469 6f6e 2865 2920 6672  lException(e) fr
-00010eb0: 6f6d 2065 0a0a 2020 2020 6465 6620 5f67  om e..    def _g
-00010ec0: 6574 5f70 7269 6365 5f73 6964 6528 7365  et_price_side(se
-00010ed0: 6c66 2c20 7369 6465 3a20 7374 722c 2069  lf, side: str, i
-00010ee0: 735f 7368 6f72 743a 2062 6f6f 6c2c 2063  s_short: bool, c
-00010ef0: 6f6e 665f 7374 7261 7465 6779 3a20 4469  onf_strategy: Di
-00010f00: 6374 2920 2d3e 2042 6964 4173 6b3a 0a20  ct) -> BidAsk:. 
-00010f10: 2020 2020 2020 2070 7269 6365 5f73 6964         price_sid
-00010f20: 6520 3d20 636f 6e66 5f73 7472 6174 6567  e = conf_strateg
-00010f30: 795b 2770 7269 6365 5f73 6964 6527 5d0a  y['price_side'].
-00010f40: 0a20 2020 2020 2020 2069 6620 7072 6963  .        if pric
-00010f50: 655f 7369 6465 2069 6e20 2827 7361 6d65  e_side in ('same
-00010f60: 272c 2027 6f74 6865 7227 293a 0a20 2020  ', 'other'):.   
-00010f70: 2020 2020 2020 2020 2070 7269 6365 5f6d           price_m
-00010f80: 6170 203d 207b 0a20 2020 2020 2020 2020  ap = {.         
-00010f90: 2020 2020 2020 2028 2765 6e74 7279 272c         ('entry',
-00010fa0: 2027 6c6f 6e67 272c 2027 7361 6d65 2729   'long', 'same')
-00010fb0: 3a20 2762 6964 272c 0a20 2020 2020 2020  : 'bid',.       
-00010fc0: 2020 2020 2020 2020 2028 2765 6e74 7279           ('entry
-00010fd0: 272c 2027 6c6f 6e67 272c 2027 6f74 6865  ', 'long', 'othe
-00010fe0: 7227 293a 2027 6173 6b27 2c0a 2020 2020  r'): 'ask',.    
-00010ff0: 2020 2020 2020 2020 2020 2020 2827 656e              ('en
-00011000: 7472 7927 2c20 2773 686f 7274 272c 2027  try', 'short', '
-00011010: 7361 6d65 2729 3a20 2761 736b 272c 0a20  same'): 'ask',. 
-00011020: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00011030: 2765 6e74 7279 272c 2027 7368 6f72 7427  'entry', 'short'
-00011040: 2c20 276f 7468 6572 2729 3a20 2762 6964  , 'other'): 'bid
-00011050: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00011060: 2020 2028 2765 7869 7427 2c20 276c 6f6e     ('exit', 'lon
-00011070: 6727 2c20 2773 616d 6527 293a 2027 6173  g', 'same'): 'as
-00011080: 6b27 2c0a 2020 2020 2020 2020 2020 2020  k',.            
-00011090: 2020 2020 2827 6578 6974 272c 2027 6c6f      ('exit', 'lo
-000110a0: 6e67 272c 2027 6f74 6865 7227 293a 2027  ng', 'other'): '
-000110b0: 6269 6427 2c0a 2020 2020 2020 2020 2020  bid',.          
-000110c0: 2020 2020 2020 2827 6578 6974 272c 2027        ('exit', '
-000110d0: 7368 6f72 7427 2c20 2773 616d 6527 293a  short', 'same'):
-000110e0: 2027 6269 6427 2c0a 2020 2020 2020 2020   'bid',.        
-000110f0: 2020 2020 2020 2020 2827 6578 6974 272c          ('exit',
-00011100: 2027 7368 6f72 7427 2c20 276f 7468 6572   'short', 'other
-00011110: 2729 3a20 2761 736b 272c 0a20 2020 2020  '): 'ask',.     
-00011120: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00011130: 2020 2020 2070 7269 6365 5f73 6964 6520       price_side 
-00011140: 3d20 7072 6963 655f 6d61 705b 2873 6964  = price_map[(sid
-00011150: 652c 2027 7368 6f72 7427 2069 6620 6973  e, 'short' if is
-00011160: 5f73 686f 7274 2065 6c73 6520 276c 6f6e  _short else 'lon
-00011170: 6727 2c20 7072 6963 655f 7369 6465 295d  g', price_side)]
-00011180: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00011190: 7072 6963 655f 7369 6465 0a0a 2020 2020  price_side..    
-000111a0: 6465 6620 6765 745f 7261 7465 2873 656c  def get_rate(sel
-000111b0: 662c 2070 6169 723a 2073 7472 2c20 7265  f, pair: str, re
-000111c0: 6672 6573 683a 2062 6f6f 6c2c 0a20 2020  fresh: bool,.   
-000111d0: 2020 2020 2020 2020 2020 2020 2020 7369                si
-000111e0: 6465 3a20 456e 7472 7945 7869 742c 2069  de: EntryExit, i
-000111f0: 735f 7368 6f72 743a 2062 6f6f 6c2c 0a20  s_short: bool,. 
-00011200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011210: 6f72 6465 725f 626f 6f6b 3a20 4f70 7469  order_book: Opti
-00011220: 6f6e 616c 5b4f 7264 6572 426f 6f6b 5d20  onal[OrderBook] 
-00011230: 3d20 4e6f 6e65 2c20 7469 636b 6572 3a20  = None, ticker: 
-00011240: 4f70 7469 6f6e 616c 5b54 6963 6b65 725d  Optional[Ticker]
-00011250: 203d 204e 6f6e 6529 202d 3e20 666c 6f61   = None) -> floa
-00011260: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
-00011270: 2020 2020 2020 2043 616c 6375 6c61 7465         Calculate
-00011280: 7320 6269 642f 6173 6b20 7461 7267 6574  s bid/ask target
-00011290: 0a20 2020 2020 2020 2062 6964 2072 6174  .        bid rat
-000112a0: 6520 2d20 6265 7477 6565 6e20 6375 7272  e - between curr
-000112b0: 656e 7420 6173 6b20 7072 6963 6520 616e  ent ask price an
-000112c0: 6420 6c61 7374 2070 7269 6365 0a20 2020  d last price.   
-000112d0: 2020 2020 2061 736b 2072 6174 6520 2d20       ask rate - 
-000112e0: 6569 7468 6572 2075 7369 6e67 2074 6963  either using tic
-000112f0: 6b65 7220 6269 6420 6f72 2066 6972 7374  ker bid or first
-00011300: 2062 6964 2062 6173 6564 206f 6e20 6f72   bid based on or
-00011310: 6465 7262 6f6f 6b0a 2020 2020 2020 2020  derbook.        
-00011320: 6f72 2072 656d 6169 6e20 7374 6174 6963  or remain static
-00011330: 2069 6e20 616e 7920 6f74 6865 7220 6361   in any other ca
-00011340: 7365 2073 696e 6365 2069 7427 7320 6e6f  se since it's no
-00011350: 7420 7570 6461 7469 6e67 2e0a 2020 2020  t updating..    
-00011360: 2020 2020 3a70 6172 616d 2070 6169 723a      :param pair:
-00011370: 2050 6169 7220 746f 2067 6574 2072 6174   Pair to get rat
-00011380: 6520 666f 720a 2020 2020 2020 2020 3a70  e for.        :p
-00011390: 6172 616d 2072 6566 7265 7368 3a20 616c  aram refresh: al
-000113a0: 6c6f 7720 6361 6368 6564 2064 6174 610a  low cached data.
-000113b0: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
-000113c0: 6964 653a 2022 6275 7922 206f 7220 2273  ide: "buy" or "s
-000113d0: 656c 6c22 0a20 2020 2020 2020 203a 7265  ell".        :re
-000113e0: 7475 726e 3a20 666c 6f61 743a 2050 7269  turn: float: Pri
-000113f0: 6365 0a20 2020 2020 2020 203a 7261 6973  ce.        :rais
-00011400: 6573 2050 7269 6369 6e67 4572 726f 7220  es PricingError 
-00011410: 6966 206f 7264 6572 626f 6f6b 2070 7269  if orderbook pri
-00011420: 6365 2063 6f75 6c64 206e 6f74 2062 6520  ce could not be 
-00011430: 6465 7465 726d 696e 6564 2e0a 2020 2020  determined..    
-00011440: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00011450: 6e61 6d65 203d 2073 6964 652e 6361 7069  name = side.capi
-00011460: 7461 6c69 7a65 2829 0a20 2020 2020 2020  talize().       
-00011470: 2073 7472 6174 5f6e 616d 6520 3d20 2765   strat_name = 'e
-00011480: 6e74 7279 5f70 7269 6369 6e67 2720 6966  ntry_pricing' if
-00011490: 2073 6964 6520 3d3d 2022 656e 7472 7922   side == "entry"
-000114a0: 2065 6c73 6520 2765 7869 745f 7072 6963   else 'exit_pric
-000114b0: 696e 6727 0a0a 2020 2020 2020 2020 6361  ing'..        ca
-000114c0: 6368 655f 7261 7465 3a20 5454 4c43 6163  che_rate: TTLCac
-000114d0: 6865 203d 2073 656c 662e 5f65 6e74 7279  he = self._entry
-000114e0: 5f72 6174 655f 6361 6368 6520 6966 2073  _rate_cache if s
-000114f0: 6964 6520 3d3d 2022 656e 7472 7922 2065  ide == "entry" e
-00011500: 6c73 6520 7365 6c66 2e5f 6578 6974 5f72  lse self._exit_r
-00011510: 6174 655f 6361 6368 650a 2020 2020 2020  ate_cache.      
-00011520: 2020 6966 206e 6f74 2072 6566 7265 7368    if not refresh
-00011530: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-00011540: 7468 2073 656c 662e 5f63 6163 6865 5f6c  th self._cache_l
-00011550: 6f63 6b3a 0a20 2020 2020 2020 2020 2020  ock:.           
-00011560: 2020 2020 2072 6174 6520 3d20 6361 6368       rate = cach
-00011570: 655f 7261 7465 2e67 6574 2870 6169 7229  e_rate.get(pair)
-00011580: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-00011590: 6865 636b 2069 6620 6361 6368 6520 6861  heck if cache ha
-000115a0: 7320 6265 656e 2069 6e76 616c 6964 6174  s been invalidat
-000115b0: 6564 0a20 2020 2020 2020 2020 2020 2069  ed.            i
-000115c0: 6620 7261 7465 3a0a 2020 2020 2020 2020  f rate:.        
-000115d0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-000115e0: 6562 7567 2866 2255 7369 6e67 2063 6163  ebug(f"Using cac
-000115f0: 6865 6420 7b73 6964 657d 2072 6174 6520  hed {side} rate 
-00011600: 666f 7220 7b70 6169 727d 2e22 290a 2020  for {pair}.").  
-00011610: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00011620: 7475 726e 2072 6174 650a 0a20 2020 2020  turn rate..     
-00011630: 2020 2063 6f6e 665f 7374 7261 7465 6779     conf_strategy
-00011640: 203d 2073 656c 662e 5f63 6f6e 6669 672e   = self._config.
-00011650: 6765 7428 7374 7261 745f 6e61 6d65 2c20  get(strat_name, 
-00011660: 7b7d 290a 0a20 2020 2020 2020 2070 7269  {})..        pri
-00011670: 6365 5f73 6964 6520 3d20 7365 6c66 2e5f  ce_side = self._
-00011680: 6765 745f 7072 6963 655f 7369 6465 2873  get_price_side(s
-00011690: 6964 652c 2069 735f 7368 6f72 742c 2063  ide, is_short, c
-000116a0: 6f6e 665f 7374 7261 7465 6779 290a 0a20  onf_strategy).. 
-000116b0: 2020 2020 2020 2070 7269 6365 5f73 6964         price_sid
-000116c0: 655f 776f 7264 203d 2070 7269 6365 5f73  e_word = price_s
-000116d0: 6964 652e 6361 7069 7461 6c69 7a65 2829  ide.capitalize()
-000116e0: 0a0a 2020 2020 2020 2020 6966 2063 6f6e  ..        if con
-000116f0: 665f 7374 7261 7465 6779 2e67 6574 2827  f_strategy.get('
-00011700: 7573 655f 6f72 6465 725f 626f 6f6b 272c  use_order_book',
-00011710: 2046 616c 7365 293a 0a0a 2020 2020 2020   False):..      
-00011720: 2020 2020 2020 6f72 6465 725f 626f 6f6b        order_book
-00011730: 5f74 6f70 203d 2063 6f6e 665f 7374 7261  _top = conf_stra
-00011740: 7465 6779 2e67 6574 2827 6f72 6465 725f  tegy.get('order_
-00011750: 626f 6f6b 5f74 6f70 272c 2031 290a 2020  book_top', 1).  
-00011760: 2020 2020 2020 2020 2020 6966 206f 7264            if ord
-00011770: 6572 5f62 6f6f 6b20 6973 204e 6f6e 653a  er_book is None:
-00011780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011790: 206f 7264 6572 5f62 6f6f 6b20 3d20 7365   order_book = se
-000117a0: 6c66 2e66 6574 6368 5f6c 325f 6f72 6465  lf.fetch_l2_orde
-000117b0: 725f 626f 6f6b 2870 6169 722c 206f 7264  r_book(pair, ord
-000117c0: 6572 5f62 6f6f 6b5f 746f 7029 0a20 2020  er_book_top).   
-000117d0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-000117e0: 6465 6275 6728 276f 7264 6572 5f62 6f6f  debug('order_boo
-000117f0: 6b20 2573 272c 206f 7264 6572 5f62 6f6f  k %s', order_boo
-00011800: 6b29 0a20 2020 2020 2020 2020 2020 2023  k).            #
-00011810: 2074 6f70 2031 203d 2069 6e64 6578 2030   top 1 = index 0
-00011820: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00011830: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011840: 2020 6f62 7369 6465 3a20 4f42 4c69 7465    obside: OBLite
-00011850: 7261 6c20 3d20 2762 6964 7327 2069 6620  ral = 'bids' if 
-00011860: 7072 6963 655f 7369 6465 203d 3d20 2762  price_side == 'b
-00011870: 6964 2720 656c 7365 2027 6173 6b73 270a  id' else 'asks'.
-00011880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011890: 7261 7465 203d 206f 7264 6572 5f62 6f6f  rate = order_boo
-000118a0: 6b5b 6f62 7369 6465 5d5b 6f72 6465 725f  k[obside][order_
-000118b0: 626f 6f6b 5f74 6f70 202d 2031 5d5b 305d  book_top - 1][0]
-000118c0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-000118d0: 6570 7420 2849 6e64 6578 4572 726f 722c  ept (IndexError,
-000118e0: 204b 6579 4572 726f 7229 2061 7320 653a   KeyError) as e:
-000118f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011900: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-00011910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011920: 2020 2020 2066 227b 7061 6972 7d20 2d20       f"{pair} - 
-00011930: 7b6e 616d 657d 2050 7269 6365 2061 7420  {name} Price at 
-00011940: 6c6f 6361 7469 6f6e 207b 6f72 6465 725f  location {order_
-00011950: 626f 6f6b 5f74 6f70 7d20 6672 6f6d 206f  book_top} from o
-00011960: 7264 6572 626f 6f6b 2022 0a20 2020 2020  rderbook ".     
-00011970: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00011980: 2263 6f75 6c64 206e 6f74 2062 6520 6465  "could not be de
-00011990: 7465 726d 696e 6564 2e20 4f72 6465 7262  termined. Orderb
-000119a0: 6f6f 6b3a 207b 6f72 6465 725f 626f 6f6b  ook: {order_book
-000119b0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-000119c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000119d0: 2020 2020 2072 6169 7365 2050 7269 6369       raise Prici
-000119e0: 6e67 4572 726f 7220 6672 6f6d 2065 0a20  ngError from e. 
-000119f0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00011a00: 722e 6465 6275 6728 6622 7b70 6169 727d  r.debug(f"{pair}
-00011a10: 202d 207b 6e61 6d65 7d20 7072 6963 6520   - {name} price 
-00011a20: 6672 6f6d 206f 7264 6572 626f 6f6b 207b  from orderbook {
-00011a30: 7072 6963 655f 7369 6465 5f77 6f72 647d  price_side_word}
-00011a40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00011a50: 2020 2020 2020 2020 2020 2066 2273 6964             f"sid
-00011a60: 6520 2d20 746f 7020 7b6f 7264 6572 5f62  e - top {order_b
-00011a70: 6f6f 6b5f 746f 707d 206f 7264 6572 2062  ook_top} order b
-00011a80: 6f6f 6b20 7b73 6964 657d 2072 6174 6520  ook {side} rate 
-00011a90: 7b72 6174 653a 2e38 667d 2229 0a20 2020  {rate:.8f}").   
-00011aa0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00011ab0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-00011ac0: 6275 6728 6622 5573 696e 6720 4c61 7374  bug(f"Using Last
-00011ad0: 207b 7072 6963 655f 7369 6465 5f77 6f72   {price_side_wor
-00011ae0: 647d 202f 204c 6173 7420 5072 6963 6522  d} / Last Price"
-00011af0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00011b00: 2074 6963 6b65 7220 6973 204e 6f6e 653a   ticker is None:
-00011b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011b20: 2074 6963 6b65 7220 3d20 7365 6c66 2e66   ticker = self.f
-00011b30: 6574 6368 5f74 6963 6b65 7228 7061 6972  etch_ticker(pair
-00011b40: 290a 2020 2020 2020 2020 2020 2020 7469  ).            ti
-00011b50: 636b 6572 5f72 6174 6520 3d20 7469 636b  cker_rate = tick
-00011b60: 6572 5b70 7269 6365 5f73 6964 655d 0a20  er[price_side]. 
-00011b70: 2020 2020 2020 2020 2020 2069 6620 7469             if ti
-00011b80: 636b 6572 5b27 6c61 7374 275d 2061 6e64  cker['last'] and
-00011b90: 2074 6963 6b65 725f 7261 7465 3a0a 2020   ticker_rate:.  
-00011ba0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00011bb0: 2073 6964 6520 3d3d 2027 656e 7472 7927   side == 'entry'
-00011bc0: 2061 6e64 2074 6963 6b65 725f 7261 7465   and ticker_rate
-00011bd0: 203e 2074 6963 6b65 725b 276c 6173 7427   > ticker['last'
-00011be0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-00011bf0: 2020 2020 2020 2062 616c 616e 6365 203d         balance =
-00011c00: 2063 6f6e 665f 7374 7261 7465 6779 2e67   conf_strategy.g
-00011c10: 6574 2827 7072 6963 655f 6c61 7374 5f62  et('price_last_b
-00011c20: 616c 616e 6365 272c 2030 2e30 290a 2020  alance', 0.0).  
-00011c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c40: 2020 7469 636b 6572 5f72 6174 6520 3d20    ticker_rate = 
-00011c50: 7469 636b 6572 5f72 6174 6520 2b20 6261  ticker_rate + ba
-00011c60: 6c61 6e63 6520 2a20 2874 6963 6b65 725b  lance * (ticker[
-00011c70: 276c 6173 7427 5d20 2d20 7469 636b 6572  'last'] - ticker
-00011c80: 5f72 6174 6529 0a20 2020 2020 2020 2020  _rate).         
-00011c90: 2020 2020 2020 2065 6c69 6620 7369 6465         elif side
-00011ca0: 203d 3d20 2765 7869 7427 2061 6e64 2074   == 'exit' and t
-00011cb0: 6963 6b65 725f 7261 7465 203c 2074 6963  icker_rate < tic
-00011cc0: 6b65 725b 276c 6173 7427 5d3a 0a20 2020  ker['last']:.   
-00011cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ce0: 2062 616c 616e 6365 203d 2063 6f6e 665f   balance = conf_
-00011cf0: 7374 7261 7465 6779 2e67 6574 2827 7072  strategy.get('pr
-00011d00: 6963 655f 6c61 7374 5f62 616c 616e 6365  ice_last_balance
-00011d10: 272c 2030 2e30 290a 2020 2020 2020 2020  ', 0.0).        
-00011d20: 2020 2020 2020 2020 2020 2020 7469 636b              tick
-00011d30: 6572 5f72 6174 6520 3d20 7469 636b 6572  er_rate = ticker
-00011d40: 5f72 6174 6520 2d20 6261 6c61 6e63 6520  _rate - balance 
-00011d50: 2a20 2874 6963 6b65 725f 7261 7465 202d  * (ticker_rate -
-00011d60: 2074 6963 6b65 725b 276c 6173 7427 5d29   ticker['last'])
-00011d70: 0a20 2020 2020 2020 2020 2020 2072 6174  .            rat
-00011d80: 6520 3d20 7469 636b 6572 5f72 6174 650a  e = ticker_rate.
-00011d90: 0a20 2020 2020 2020 2069 6620 7261 7465  .        if rate
-00011da0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00011db0: 2020 2020 2020 7261 6973 6520 5072 6963        raise Pric
-00011dc0: 696e 6745 7272 6f72 2866 227b 6e61 6d65  ingError(f"{name
-00011dd0: 7d2d 5261 7465 2066 6f72 207b 7061 6972  }-Rate for {pair
-00011de0: 7d20 7761 7320 656d 7074 792e 2229 0a20  } was empty."). 
-00011df0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-00011e00: 2e5f 6361 6368 655f 6c6f 636b 3a0a 2020  ._cache_lock:.  
-00011e10: 2020 2020 2020 2020 2020 6361 6368 655f            cache_
-00011e20: 7261 7465 5b70 6169 725d 203d 2072 6174  rate[pair] = rat
-00011e30: 650a 0a20 2020 2020 2020 2072 6574 7572  e..        retur
-00011e40: 6e20 7261 7465 0a0a 2020 2020 6465 6620  n rate..    def 
-00011e50: 6765 745f 7261 7465 7328 7365 6c66 2c20  get_rates(self, 
-00011e60: 7061 6972 3a20 7374 722c 2072 6566 7265  pair: str, refre
-00011e70: 7368 3a20 626f 6f6c 2c20 6973 5f73 686f  sh: bool, is_sho
-00011e80: 7274 3a20 626f 6f6c 2920 2d3e 2054 7570  rt: bool) -> Tup
-00011e90: 6c65 5b66 6c6f 6174 2c20 666c 6f61 745d  le[float, float]
-00011ea0: 3a0a 2020 2020 2020 2020 656e 7472 795f  :.        entry_
-00011eb0: 7261 7465 203d 204e 6f6e 650a 2020 2020  rate = None.    
-00011ec0: 2020 2020 6578 6974 5f72 6174 6520 3d20      exit_rate = 
-00011ed0: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
-00011ee0: 6e6f 7420 7265 6672 6573 683a 0a20 2020  not refresh:.   
-00011ef0: 2020 2020 2020 2020 2077 6974 6820 7365           with se
-00011f00: 6c66 2e5f 6361 6368 655f 6c6f 636b 3a0a  lf._cache_lock:.
-00011f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011f20: 656e 7472 795f 7261 7465 203d 2073 656c  entry_rate = sel
-00011f30: 662e 5f65 6e74 7279 5f72 6174 655f 6361  f._entry_rate_ca
-00011f40: 6368 652e 6765 7428 7061 6972 290a 2020  che.get(pair).  
-00011f50: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00011f60: 6974 5f72 6174 6520 3d20 7365 6c66 2e5f  it_rate = self._
-00011f70: 6578 6974 5f72 6174 655f 6361 6368 652e  exit_rate_cache.
-00011f80: 6765 7428 7061 6972 290a 2020 2020 2020  get(pair).      
-00011f90: 2020 2020 2020 6966 2065 6e74 7279 5f72        if entry_r
-00011fa0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00011fb0: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-00011fc0: 6728 6622 5573 696e 6720 6361 6368 6564  g(f"Using cached
-00011fd0: 2062 7579 2072 6174 6520 666f 7220 7b70   buy rate for {p
-00011fe0: 6169 727d 2e22 290a 2020 2020 2020 2020  air}.").        
-00011ff0: 2020 2020 6966 2065 7869 745f 7261 7465      if exit_rate
-00012000: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012010: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
-00012020: 2255 7369 6e67 2063 6163 6865 6420 7365  "Using cached se
-00012030: 6c6c 2072 6174 6520 666f 7220 7b70 6169  ll rate for {pai
-00012040: 727d 2e22 290a 0a20 2020 2020 2020 2065  r}.")..        e
-00012050: 6e74 7279 5f70 7269 6369 6e67 203d 2073  ntry_pricing = s
-00012060: 656c 662e 5f63 6f6e 6669 672e 6765 7428  elf._config.get(
-00012070: 2765 6e74 7279 5f70 7269 6369 6e67 272c  'entry_pricing',
-00012080: 207b 7d29 0a20 2020 2020 2020 2065 7869   {}).        exi
-00012090: 745f 7072 6963 696e 6720 3d20 7365 6c66  t_pricing = self
-000120a0: 2e5f 636f 6e66 6967 2e67 6574 2827 6578  ._config.get('ex
-000120b0: 6974 5f70 7269 6369 6e67 272c 207b 7d29  it_pricing', {})
-000120c0: 0a20 2020 2020 2020 206f 7264 6572 5f62  .        order_b
-000120d0: 6f6f 6b20 3d20 7469 636b 6572 203d 204e  ook = ticker = N
-000120e0: 6f6e 650a 2020 2020 2020 2020 6966 206e  one.        if n
-000120f0: 6f74 2065 6e74 7279 5f72 6174 6520 616e  ot entry_rate an
-00012100: 6420 656e 7472 795f 7072 6963 696e 672e  d entry_pricing.
-00012110: 6765 7428 2775 7365 5f6f 7264 6572 5f62  get('use_order_b
-00012120: 6f6f 6b27 2c20 4661 6c73 6529 3a0a 2020  ook', False):.  
-00012130: 2020 2020 2020 2020 2020 6f72 6465 725f            order_
-00012140: 626f 6f6b 5f74 6f70 203d 206d 6178 2865  book_top = max(e
-00012150: 6e74 7279 5f70 7269 6369 6e67 2e67 6574  ntry_pricing.get
-00012160: 2827 6f72 6465 725f 626f 6f6b 5f74 6f70  ('order_book_top
-00012170: 272c 2031 292c 0a20 2020 2020 2020 2020  ', 1),.         
-00012180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012190: 2020 2020 2020 2020 6578 6974 5f70 7269          exit_pri
-000121a0: 6369 6e67 2e67 6574 2827 6f72 6465 725f  cing.get('order_
-000121b0: 626f 6f6b 5f74 6f70 272c 2031 2929 0a20  book_top', 1)). 
-000121c0: 2020 2020 2020 2020 2020 206f 7264 6572             order
-000121d0: 5f62 6f6f 6b20 3d20 7365 6c66 2e66 6574  _book = self.fet
-000121e0: 6368 5f6c 325f 6f72 6465 725f 626f 6f6b  ch_l2_order_book
-000121f0: 2870 6169 722c 206f 7264 6572 5f62 6f6f  (pair, order_boo
-00012200: 6b5f 746f 7029 0a20 2020 2020 2020 2020  k_top).         
-00012210: 2020 2065 6e74 7279 5f72 6174 6520 3d20     entry_rate = 
-00012220: 7365 6c66 2e67 6574 5f72 6174 6528 7061  self.get_rate(pa
-00012230: 6972 2c20 7265 6672 6573 682c 2027 656e  ir, refresh, 'en
-00012240: 7472 7927 2c20 6973 5f73 686f 7274 2c20  try', is_short, 
-00012250: 6f72 6465 725f 626f 6f6b 3d6f 7264 6572  order_book=order
-00012260: 5f62 6f6f 6b29 0a20 2020 2020 2020 2065  _book).        e
-00012270: 6c69 6620 6e6f 7420 656e 7472 795f 7261  lif not entry_ra
-00012280: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00012290: 7469 636b 6572 203d 2073 656c 662e 6665  ticker = self.fe
-000122a0: 7463 685f 7469 636b 6572 2870 6169 7229  tch_ticker(pair)
-000122b0: 0a20 2020 2020 2020 2020 2020 2065 6e74  .            ent
-000122c0: 7279 5f72 6174 6520 3d20 7365 6c66 2e67  ry_rate = self.g
-000122d0: 6574 5f72 6174 6528 7061 6972 2c20 7265  et_rate(pair, re
-000122e0: 6672 6573 682c 2027 656e 7472 7927 2c20  fresh, 'entry', 
-000122f0: 6973 5f73 686f 7274 2c20 7469 636b 6572  is_short, ticker
-00012300: 3d74 6963 6b65 7229 0a20 2020 2020 2020  =ticker).       
-00012310: 2069 6620 6e6f 7420 6578 6974 5f72 6174   if not exit_rat
-00012320: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
-00012330: 7869 745f 7261 7465 203d 2073 656c 662e  xit_rate = self.
-00012340: 6765 745f 7261 7465 2870 6169 722c 2072  get_rate(pair, r
-00012350: 6566 7265 7368 2c20 2765 7869 7427 2c0a  efresh, 'exit',.
-00012360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012380: 2020 2020 2020 6973 5f73 686f 7274 2c20        is_short, 
-00012390: 6f72 6465 725f 626f 6f6b 3d6f 7264 6572  order_book=order
-000123a0: 5f62 6f6f 6b2c 2074 6963 6b65 723d 7469  _book, ticker=ti
-000123b0: 636b 6572 290a 2020 2020 2020 2020 7265  cker).        re
-000123c0: 7475 726e 2065 6e74 7279 5f72 6174 652c  turn entry_rate,
-000123d0: 2065 7869 745f 7261 7465 0a0a 2020 2020   exit_rate..    
-000123e0: 2320 4665 6520 6861 6e64 6c69 6e67 0a0a  # Fee handling..
-000123f0: 2020 2020 4072 6574 7269 6572 0a20 2020      @retrier.   
-00012400: 2064 6566 2067 6574 5f74 7261 6465 735f   def get_trades_
-00012410: 666f 725f 6f72 6465 7228 7365 6c66 2c20  for_order(self, 
-00012420: 6f72 6465 725f 6964 3a20 7374 722c 2070  order_id: str, p
-00012430: 6169 723a 2073 7472 2c20 7369 6e63 653a  air: str, since:
-00012440: 2064 6174 6574 696d 652c 0a20 2020 2020   datetime,.     
-00012450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012460: 2020 2020 2020 2020 7061 7261 6d73 3a20          params: 
-00012470: 4f70 7469 6f6e 616c 5b44 6963 745d 203d  Optional[Dict] =
-00012480: 204e 6f6e 6529 202d 3e20 4c69 7374 3a0a   None) -> List:.
-00012490: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000124a0: 2020 2020 4665 7463 6820 4f72 6465 7273      Fetch Orders
-000124b0: 2075 7369 6e67 2074 6865 2022 6665 7463   using the "fetc
-000124c0: 685f 6d79 5f74 7261 6465 7322 2065 6e64  h_my_trades" end
-000124d0: 706f 696e 7420 616e 6420 6669 6c74 6572  point and filter
-000124e0: 2074 6865 6d20 6279 206f 7264 6572 2d69   them by order-i
-000124f0: 642e 0a20 2020 2020 2020 2054 6865 2022  d..        The "
-00012500: 7369 6e63 6522 2061 7267 756d 656e 7420  since" argument 
-00012510: 7061 7373 6564 2069 6e20 6973 2063 6f6d  passed in is com
-00012520: 696e 6720 6672 6f6d 2074 6865 2064 6174  ing from the dat
-00012530: 6162 6173 6520 616e 6420 6973 2069 6e20  abase and is in 
-00012540: 5554 432c 0a20 2020 2020 2020 2061 7320  UTC,.        as 
-00012550: 7469 6d65 7a6f 6e65 2d6e 6174 6976 6520  timezone-native 
-00012560: 6461 7465 7469 6d65 206f 626a 6563 742e  datetime object.
-00012570: 0a20 2020 2020 2020 2046 726f 6d20 7468  .        From th
-00012580: 6520 7079 7468 6f6e 2064 6f63 756d 656e  e python documen
-00012590: 7461 7469 6f6e 3a0a 2020 2020 2020 2020  tation:.        
-000125a0: 2020 2020 3e20 4e61 6976 6520 6461 7465      > Naive date
-000125b0: 7469 6d65 2069 6e73 7461 6e63 6573 2061  time instances a
-000125c0: 7265 2061 7373 756d 6564 2074 6f20 7265  re assumed to re
-000125d0: 7072 6573 656e 7420 6c6f 6361 6c20 7469  present local ti
-000125e0: 6d65 0a20 2020 2020 2020 2054 6865 7265  me.        There
-000125f0: 666f 7265 2c20 6361 6c6c 696e 6720 2273  fore, calling "s
-00012600: 696e 6365 2e74 696d 6573 7461 6d70 2829  ince.timestamp()
-00012610: 2220 7769 6c6c 2067 6574 2074 6865 2055  " will get the U
-00012620: 5443 2074 696d 6573 7461 6d70 2c20 6166  TC timestamp, af
-00012630: 7465 7220 6170 706c 7969 6e67 2074 6865  ter applying the
-00012640: 0a20 2020 2020 2020 2074 7261 6e73 666f  .        transfo
-00012650: 726d 6174 696f 6e20 6672 6f6d 206c 6f63  rmation from loc
-00012660: 616c 2074 696d 657a 6f6e 6520 746f 2055  al timezone to U
-00012670: 5443 2e0a 2020 2020 2020 2020 5468 6973  TC..        This
-00012680: 2077 6f72 6b73 2066 6f72 2074 696d 657a   works for timez
-00012690: 6f6e 6573 2055 5443 2b20 7369 6e63 6520  ones UTC+ since 
-000126a0: 7468 656e 2074 6865 2072 6573 756c 7420  then the result 
-000126b0: 7769 6c6c 2063 6f6e 7461 696e 2074 7261  will contain tra
-000126c0: 6465 7320 6672 6f6d 2061 2066 6577 2068  des from a few h
-000126d0: 6f75 7273 0a20 2020 2020 2020 2069 6e73  ours.        ins
-000126e0: 7465 6164 206f 6620 6672 6f6d 2074 6865  tead of from the
-000126f0: 206c 6173 7420 3520 7365 636f 6e64 732c   last 5 seconds,
-00012700: 2068 6f77 6576 6572 2066 6169 6c73 2066   however fails f
-00012710: 6f72 2055 5443 2d20 7469 6d65 7a6f 6e65  or UTC- timezone
-00012720: 732c 0a20 2020 2020 2020 2073 696e 6365  s,.        since
-00012730: 2077 6527 7265 2074 6865 6e20 6173 6b69   we're then aski
-00012740: 6e67 2066 6f72 2074 7261 6465 7320 7769  ng for trades wi
-00012750: 7468 2061 2022 7369 6e63 6522 2061 7267  th a "since" arg
-00012760: 756d 656e 7420 696e 2074 6865 2066 7574  ument in the fut
-00012770: 7572 652e 0a0a 2020 2020 2020 2020 3a70  ure...        :p
-00012780: 6172 616d 206f 7264 6572 5f69 6420 6f72  aram order_id or
-00012790: 6465 725f 6964 3a20 4f72 6465 722d 6964  der_id: Order-id
-000127a0: 2061 7320 6769 7665 6e20 7768 656e 2063   as given when c
-000127b0: 7265 6174 696e 6720 7468 6520 6f72 6465  reating the orde
-000127c0: 720a 2020 2020 2020 2020 3a70 6172 616d  r.        :param
-000127d0: 2070 6169 723a 2050 6169 7220 7468 6520   pair: Pair the 
-000127e0: 6f72 6465 7220 6973 2066 6f72 0a20 2020  order is for.   
-000127f0: 2020 2020 203a 7061 7261 6d20 7369 6e63       :param sinc
-00012800: 653a 2064 6174 6574 696d 6520 6f62 6a65  e: datetime obje
-00012810: 6374 206f 6620 7468 6520 6f72 6465 7220  ct of the order 
-00012820: 6372 6561 7469 6f6e 2074 696d 652e 2041  creation time. A
-00012830: 7373 756d 6573 206f 626a 6563 7420 6973  ssumes object is
-00012840: 2069 6e20 5554 432e 0a20 2020 2020 2020   in UTC..       
-00012850: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-00012860: 7365 6c66 2e5f 636f 6e66 6967 5b27 6472  self._config['dr
-00012870: 795f 7275 6e27 5d3a 0a20 2020 2020 2020  y_run']:.       
-00012880: 2020 2020 2072 6574 7572 6e20 5b5d 0a20       return []. 
-00012890: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-000128a0: 6c66 2e65 7863 6861 6e67 655f 6861 7328  lf.exchange_has(
-000128b0: 2766 6574 6368 4d79 5472 6164 6573 2729  'fetchMyTrades')
-000128c0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000128d0: 7475 726e 205b 5d0a 2020 2020 2020 2020  turn [].        
-000128e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000128f0: 2023 2041 6c6c 6f77 2035 7320 6f66 6673   # Allow 5s offs
-00012900: 6574 2074 6f20 6361 7463 6820 736c 6967  et to catch slig
-00012910: 6874 2074 696d 6520 6f66 6673 6574 7320  ht time offsets 
-00012920: 2864 6973 636f 7665 7265 6420 696e 2023  (discovered in #
-00012930: 3131 3835 290a 2020 2020 2020 2020 2020  1185).          
-00012940: 2020 2320 7369 6e63 6520 6e65 6564 7320    # since needs 
-00012950: 746f 2062 6520 696e 7420 696e 206d 696c  to be int in mil
-00012960: 6c69 7365 636f 6e64 730a 2020 2020 2020  liseconds.      
-00012970: 2020 2020 2020 5f70 6172 616d 7320 3d20        _params = 
-00012980: 7061 7261 6d73 2069 6620 7061 7261 6d73  params if params
-00012990: 2065 6c73 6520 7b7d 0a20 2020 2020 2020   else {}.       
-000129a0: 2020 2020 206d 795f 7472 6164 6573 203d       my_trades =
-000129b0: 2073 656c 662e 5f61 7069 2e66 6574 6368   self._api.fetch
-000129c0: 5f6d 795f 7472 6164 6573 280a 2020 2020  _my_trades(.    
-000129d0: 2020 2020 2020 2020 2020 2020 7061 6972              pair
-000129e0: 2c20 696e 7428 2873 696e 6365 2e72 6570  , int((since.rep
-000129f0: 6c61 6365 2874 7a69 6e66 6f3d 7469 6d65  lace(tzinfo=time
-00012a00: 7a6f 6e65 2e75 7463 292e 7469 6d65 7374  zone.utc).timest
-00012a10: 616d 7028 2920 2d20 3529 202a 2031 3030  amp() - 5) * 100
-00012a20: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
-00012a30: 2020 2020 7061 7261 6d73 3d5f 7061 7261      params=_para
-00012a40: 6d73 290a 2020 2020 2020 2020 2020 2020  ms).            
-00012a50: 6d61 7463 6865 645f 7472 6164 6573 203d  matched_trades =
-00012a60: 205b 7472 6164 6520 666f 7220 7472 6164   [trade for trad
-00012a70: 6520 696e 206d 795f 7472 6164 6573 2069  e in my_trades i
-00012a80: 6620 7472 6164 655b 276f 7264 6572 275d  f trade['order']
-00012a90: 203d 3d20 6f72 6465 725f 6964 5d0a 0a20   == order_id].. 
-00012aa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00012ab0: 5f6c 6f67 5f65 7863 6861 6e67 655f 7265  _log_exchange_re
-00012ac0: 7370 6f6e 7365 2827 6765 745f 7472 6164  sponse('get_trad
-00012ad0: 6573 5f66 6f72 5f6f 7264 6572 272c 206d  es_for_order', m
-00012ae0: 6174 6368 6564 5f74 7261 6465 7329 0a0a  atched_trades)..
-00012af0: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
-00012b00: 6865 645f 7472 6164 6573 203d 2073 656c  hed_trades = sel
-00012b10: 662e 5f74 7261 6465 735f 636f 6e74 7261  f._trades_contra
-00012b20: 6374 735f 746f 5f61 6d6f 756e 7428 6d61  cts_to_amount(ma
-00012b30: 7463 6865 645f 7472 6164 6573 290a 0a20  tched_trades).. 
-00012b40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00012b50: 6e20 6d61 7463 6865 645f 7472 6164 6573  n matched_trades
-00012b60: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00012b70: 6363 7874 2e44 446f 5350 726f 7465 6374  ccxt.DDoSProtect
-00012b80: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00012b90: 2020 2020 2020 7261 6973 6520 4444 6f73        raise DDos
-00012ba0: 5072 6f74 6563 7469 6f6e 2865 2920 6672  Protection(e) fr
-00012bb0: 6f6d 2065 0a20 2020 2020 2020 2065 7863  om e.        exc
-00012bc0: 6570 7420 2863 6378 742e 4e65 7477 6f72  ept (ccxt.Networ
-00012bd0: 6b45 7272 6f72 2c20 6363 7874 2e45 7863  kError, ccxt.Exc
-00012be0: 6861 6e67 6545 7272 6f72 2920 6173 2065  hangeError) as e
-00012bf0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00012c00: 6973 6520 5465 6d70 6f72 6172 7945 7272  ise TemporaryErr
-00012c10: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00012c20: 2020 2020 6627 436f 756c 6420 6e6f 7420      f'Could not 
-00012c30: 6765 7420 7472 6164 6573 2064 7565 2074  get trades due t
-00012c40: 6f20 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f  o {e.__class__._
-00012c50: 5f6e 616d 655f 5f7d 2e20 4d65 7373 6167  _name__}. Messag
-00012c60: 653a 207b 657d 2729 2066 726f 6d20 650a  e: {e}') from e.
-00012c70: 2020 2020 2020 2020 6578 6365 7074 2063          except c
-00012c80: 6378 742e 4261 7365 4572 726f 7220 6173  cxt.BaseError as
-00012c90: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00012ca0: 7261 6973 6520 4f70 6572 6174 696f 6e61  raise Operationa
-00012cb0: 6c45 7863 6570 7469 6f6e 2865 2920 6672  lException(e) fr
-00012cc0: 6f6d 2065 0a0a 2020 2020 6465 6620 6765  om e..    def ge
-00012cd0: 745f 6f72 6465 725f 6964 5f63 6f6e 6469  t_order_id_condi
-00012ce0: 7469 6f6e 616c 2873 656c 662c 206f 7264  tional(self, ord
-00012cf0: 6572 3a20 4469 6374 5b73 7472 2c20 416e  er: Dict[str, An
-00012d00: 795d 2920 2d3e 2073 7472 3a0a 2020 2020  y]) -> str:.    
-00012d10: 2020 2020 7265 7475 726e 206f 7264 6572      return order
-00012d20: 5b27 6964 275d 0a0a 2020 2020 4072 6574  ['id']..    @ret
-00012d30: 7269 6572 0a20 2020 2064 6566 2067 6574  rier.    def get
-00012d40: 5f66 6565 2873 656c 662c 2073 796d 626f  _fee(self, symbo
-00012d50: 6c3a 2073 7472 2c20 7479 7065 3a20 7374  l: str, type: st
-00012d60: 7220 3d20 2727 2c20 7369 6465 3a20 7374  r = '', side: st
-00012d70: 7220 3d20 2727 2c20 616d 6f75 6e74 3a20  r = '', amount: 
-00012d80: 666c 6f61 7420 3d20 312c 0a20 2020 2020  float = 1,.     
-00012d90: 2020 2020 2020 2020 2020 2070 7269 6365             price
-00012da0: 3a20 666c 6f61 7420 3d20 312c 2074 616b  : float = 1, tak
-00012db0: 6572 5f6f 725f 6d61 6b65 723a 204d 616b  er_or_maker: Mak
-00012dc0: 6572 5461 6b65 7220 3d20 276d 616b 6572  erTaker = 'maker
-00012dd0: 2729 202d 3e20 666c 6f61 743a 0a20 2020  ') -> float:.   
-00012de0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00012df0: 2052 6574 7269 6576 6520 6665 6520 6672   Retrieve fee fr
-00012e00: 6f6d 2065 7863 6861 6e67 650a 2020 2020  om exchange.    
-00012e10: 2020 2020 3a70 6172 616d 2073 796d 626f      :param symbo
-00012e20: 6c3a 2050 6169 720a 2020 2020 2020 2020  l: Pair.        
-00012e30: 3a70 6172 616d 2074 7970 653a 2054 7970  :param type: Typ
-00012e40: 6520 6f66 206f 7264 6572 2028 6d61 726b  e of order (mark
-00012e50: 6574 2c20 6c69 6d69 742c 202e 2e2e 290a  et, limit, ...).
-00012e60: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
-00012e70: 6964 653a 2053 6964 6520 6f66 206f 7264  ide: Side of ord
-00012e80: 6572 2028 6275 792c 2073 656c 6c29 0a20  er (buy, sell). 
-00012e90: 2020 2020 2020 203a 7061 7261 6d20 616d         :param am
-00012ea0: 6f75 6e74 3a20 416d 6f75 6e74 206f 6620  ount: Amount of 
-00012eb0: 6f72 6465 720a 2020 2020 2020 2020 3a70  order.        :p
-00012ec0: 6172 616d 2070 7269 6365 3a20 5072 6963  aram price: Pric
-00012ed0: 6520 6f66 206f 7264 6572 0a20 2020 2020  e of order.     
-00012ee0: 2020 203a 7061 7261 6d20 7461 6b65 725f     :param taker_
-00012ef0: 6f72 5f6d 616b 6572 3a20 276d 616b 6572  or_maker: 'maker
-00012f00: 2720 6f72 2027 7461 6b65 7227 2028 6967  ' or 'taker' (ig
-00012f10: 6e6f 7265 6420 6966 2022 7479 7065 2220  nored if "type" 
-00012f20: 6973 2070 726f 7669 6465 6429 0a20 2020  is provided).   
-00012f30: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00012f40: 2069 6620 7479 7065 2061 6e64 2074 7970   if type and typ
-00012f50: 6520 3d3d 2027 6d61 726b 6574 273a 0a20  e == 'market':. 
-00012f60: 2020 2020 2020 2020 2020 2074 616b 6572             taker
-00012f70: 5f6f 725f 6d61 6b65 7220 3d20 2774 616b  _or_maker = 'tak
-00012f80: 6572 270a 2020 2020 2020 2020 7472 793a  er'.        try:
-00012f90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00012fa0: 7365 6c66 2e5f 636f 6e66 6967 5b27 6472  self._config['dr
-00012fb0: 795f 7275 6e27 5d20 616e 6420 7365 6c66  y_run'] and self
-00012fc0: 2e5f 636f 6e66 6967 2e67 6574 2827 6665  ._config.get('fe
-00012fd0: 6527 2c20 4e6f 6e65 2920 6973 206e 6f74  e', None) is not
-00012fe0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00012ff0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00013000: 6c66 2e5f 636f 6e66 6967 5b27 6665 6527  lf._config['fee'
-00013010: 5d0a 2020 2020 2020 2020 2020 2020 2320  ].            # 
-00013020: 7661 6c69 6461 7465 2074 6861 7420 6d61  validate that ma
-00013030: 726b 6574 7320 6172 6520 6c6f 6164 6564  rkets are loaded
-00013040: 2062 6566 6f72 6520 7472 7969 6e67 2074   before trying t
-00013050: 6f20 6765 7420 6665 650a 2020 2020 2020  o get fee.      
-00013060: 2020 2020 2020 6966 2073 656c 662e 5f61        if self._a
-00013070: 7069 2e6d 6172 6b65 7473 2069 7320 4e6f  pi.markets is No
-00013080: 6e65 206f 7220 6c65 6e28 7365 6c66 2e5f  ne or len(self._
-00013090: 6170 692e 6d61 726b 6574 7329 203d 3d20  api.markets) == 
-000130a0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-000130b0: 2020 2073 656c 662e 5f61 7069 2e6c 6f61     self._api.loa
-000130c0: 645f 6d61 726b 6574 7328 7061 7261 6d73  d_markets(params
-000130d0: 3d7b 7d29 0a0a 2020 2020 2020 2020 2020  ={})..          
-000130e0: 2020 7265 7475 726e 2073 656c 662e 5f61    return self._a
-000130f0: 7069 2e63 616c 6375 6c61 7465 5f66 6565  pi.calculate_fee
-00013100: 2873 796d 626f 6c3d 7379 6d62 6f6c 2c20  (symbol=symbol, 
-00013110: 7479 7065 3d74 7970 652c 2073 6964 653d  type=type, side=
-00013120: 7369 6465 2c20 616d 6f75 6e74 3d61 6d6f  side, amount=amo
-00013130: 756e 742c 0a20 2020 2020 2020 2020 2020  unt,.           
-00013140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013160: 7072 6963 653d 7072 6963 652c 2074 616b  price=price, tak
-00013170: 6572 4f72 4d61 6b65 723d 7461 6b65 725f  erOrMaker=taker_
-00013180: 6f72 5f6d 616b 6572 295b 2772 6174 6527  or_maker)['rate'
-00013190: 5d0a 2020 2020 2020 2020 6578 6365 7074  ].        except
-000131a0: 2063 6378 742e 4444 6f53 5072 6f74 6563   ccxt.DDoSProtec
-000131b0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-000131c0: 2020 2020 2020 2072 6169 7365 2044 446f         raise DDo
-000131d0: 7350 726f 7465 6374 696f 6e28 6529 2066  sProtection(e) f
-000131e0: 726f 6d20 650a 2020 2020 2020 2020 6578  rom e.        ex
-000131f0: 6365 7074 2028 6363 7874 2e4e 6574 776f  cept (ccxt.Netwo
-00013200: 726b 4572 726f 722c 2063 6378 742e 4578  rkError, ccxt.Ex
-00013210: 6368 616e 6765 4572 726f 7229 2061 7320  changeError) as 
-00013220: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00013230: 6169 7365 2054 656d 706f 7261 7279 4572  aise TemporaryEr
-00013240: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00013250: 2020 2020 2066 2743 6f75 6c64 206e 6f74       f'Could not
-00013260: 2067 6574 2066 6565 2069 6e66 6f20 6475   get fee info du
-00013270: 6520 746f 207b 652e 5f5f 636c 6173 735f  e to {e.__class_
-00013280: 5f2e 5f5f 6e61 6d65 5f5f 7d2e 204d 6573  _.__name__}. Mes
-00013290: 7361 6765 3a20 7b65 7d27 2920 6672 6f6d  sage: {e}') from
-000132a0: 2065 0a20 2020 2020 2020 2065 7863 6570   e.        excep
-000132b0: 7420 6363 7874 2e42 6173 6545 7272 6f72  t ccxt.BaseError
-000132c0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-000132d0: 2020 2072 6169 7365 204f 7065 7261 7469     raise Operati
-000132e0: 6f6e 616c 4578 6365 7074 696f 6e28 6529  onalException(e)
-000132f0: 2066 726f 6d20 650a 0a20 2020 2040 7374   from e..    @st
-00013300: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-00013310: 6566 206f 7264 6572 5f68 6173 5f66 6565  ef order_has_fee
-00013320: 286f 7264 6572 3a20 4469 6374 2920 2d3e  (order: Dict) ->
-00013330: 2062 6f6f 6c3a 0a20 2020 2020 2020 2022   bool:.        "
-00013340: 2222 0a20 2020 2020 2020 2056 6572 6966  "".        Verif
-00013350: 6965 7320 6966 2074 6865 2070 6173 7365  ies if the passe
-00013360: 6420 696e 206f 7264 6572 2064 6963 7420  d in order dict 
-00013370: 6861 7320 7468 6520 6e65 6564 6564 206b  has the needed k
-00013380: 6579 7320 746f 2065 7874 7261 6374 2066  eys to extract f
-00013390: 6565 732c 0a20 2020 2020 2020 2061 6e64  ees,.        and
-000133a0: 2074 6861 7420 7468 6573 6520 6b65 7973   that these keys
-000133b0: 2028 6375 7272 656e 6379 2c20 636f 7374   (currency, cost
-000133c0: 2920 6172 6520 6e6f 7420 656d 7074 792e  ) are not empty.
-000133d0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-000133e0: 6f72 6465 723a 204f 7264 6572 206f 7220  order: Order or 
-000133f0: 7472 6164 6520 286f 6e65 2074 7261 6465  trade (one trade
-00013400: 2920 6469 6374 0a20 2020 2020 2020 203a  ) dict.        :
-00013410: 7265 7475 726e 3a20 5472 7565 2069 6620  return: True if 
-00013420: 7468 6520 6665 6520 7375 6273 7472 7563  the fee substruc
-00013430: 7475 7265 2063 6f6e 7461 696e 7320 6375  ture contains cu
-00013440: 7272 656e 6379 2061 6e64 2063 6f73 742c  rrency and cost,
-00013450: 2066 616c 7365 206f 7468 6572 7769 7365   false otherwise
-00013460: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00013470: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
-00013480: 7374 616e 6365 286f 7264 6572 2c20 6469  stance(order, di
-00013490: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-000134a0: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
-000134b0: 2020 2020 2020 7265 7475 726e 2028 2766        return ('f
-000134c0: 6565 2720 696e 206f 7264 6572 2061 6e64  ee' in order and
-000134d0: 206f 7264 6572 5b27 6665 6527 5d20 6973   order['fee'] is
-000134e0: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
-000134f0: 2020 2020 2020 2020 2020 616e 6420 286f            and (o
-00013500: 7264 6572 5b27 6665 6527 5d2e 6b65 7973  rder['fee'].keys
-00013510: 2829 203e 3d20 7b27 6375 7272 656e 6379  () >= {'currency
-00013520: 272c 2027 636f 7374 277d 290a 2020 2020  ', 'cost'}).    
-00013530: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00013540: 6f72 6465 725b 2766 6565 275d 5b27 6375  order['fee']['cu
-00013550: 7272 656e 6379 275d 2069 7320 6e6f 7420  rrency'] is not 
-00013560: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00013570: 2020 2020 2061 6e64 206f 7264 6572 5b27       and order['
-00013580: 6665 6527 5d5b 2763 6f73 7427 5d20 6973  fee']['cost'] is
-00013590: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
-000135a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-000135b0: 2064 6566 2063 616c 6375 6c61 7465 5f66   def calculate_f
-000135c0: 6565 5f72 6174 6528 0a20 2020 2020 2020  ee_rate(.       
-000135d0: 2020 2020 2073 656c 662c 2066 6565 3a20       self, fee: 
-000135e0: 4469 6374 2c20 7379 6d62 6f6c 3a20 7374  Dict, symbol: st
-000135f0: 722c 2063 6f73 743a 2066 6c6f 6174 2c20  r, cost: float, 
-00013600: 616d 6f75 6e74 3a20 666c 6f61 7429 202d  amount: float) -
-00013610: 3e20 4f70 7469 6f6e 616c 5b66 6c6f 6174  > Optional[float
-00013620: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00013630: 2020 2020 2020 2043 616c 6375 6c61 7465         Calculate
-00013640: 2066 6565 2072 6174 6520 6966 2069 7427   fee rate if it'
-00013650: 7320 6e6f 7420 6769 7665 6e20 6279 2074  s not given by t
-00013660: 6865 2065 7863 6861 6e67 652e 0a20 2020  he exchange..   
-00013670: 2020 2020 203a 7061 7261 6d20 6665 653a       :param fee:
-00013680: 2063 6378 7420 4665 6520 6469 6374 202d   ccxt Fee dict -
-00013690: 206d 7573 7420 636f 6e74 6169 6e20 636f   must contain co
-000136a0: 7374 202f 2063 7572 7265 6e63 7920 2f20  st / currency / 
-000136b0: 7261 7465 0a20 2020 2020 2020 203a 7061  rate.        :pa
-000136c0: 7261 6d20 7379 6d62 6f6c 3a20 5379 6d62  ram symbol: Symb
-000136d0: 6f6c 206f 6620 7468 6520 6f72 6465 720a  ol of the order.
-000136e0: 2020 2020 2020 2020 3a70 6172 616d 2063          :param c
-000136f0: 6f73 743a 2054 6f74 616c 2063 6f73 7420  ost: Total cost 
-00013700: 6f66 2074 6865 206f 7264 6572 0a20 2020  of the order.   
-00013710: 2020 2020 203a 7061 7261 6d20 616d 6f75       :param amou
-00013720: 6e74 3a20 416d 6f75 6e74 206f 6620 7468  nt: Amount of th
-00013730: 6520 6f72 6465 720a 2020 2020 2020 2020  e order.        
-00013740: 2222 220a 2020 2020 2020 2020 6966 2066  """.        if f
-00013750: 6565 2e67 6574 2827 7261 7465 2729 2069  ee.get('rate') i
-00013760: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00013770: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00013780: 6565 2e67 6574 2827 7261 7465 2729 0a20  ee.get('rate'). 
-00013790: 2020 2020 2020 2066 6565 5f63 7572 7220         fee_curr 
-000137a0: 3d20 6665 652e 6765 7428 2763 7572 7265  = fee.get('curre
-000137b0: 6e63 7927 290a 2020 2020 2020 2020 6966  ncy').        if
-000137c0: 2066 6565 5f63 7572 7220 6973 204e 6f6e   fee_curr is Non
-000137d0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-000137e0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
-000137f0: 2020 2066 6565 5f63 6f73 7420 3d20 666c     fee_cost = fl
-00013800: 6f61 7428 6665 655b 2763 6f73 7427 5d29  oat(fee['cost'])
-00013810: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00013820: 2e5f 6674 5f68 6173 5b27 6665 655f 636f  ._ft_has['fee_co
-00013830: 7374 5f69 6e5f 636f 6e74 7261 6374 7327  st_in_contracts'
-00013840: 5d3a 0a20 2020 2020 2020 2020 2020 2023  ]:.            #
-00013850: 2043 6f6e 7665 7274 2063 6f73 7420 7669   Convert cost vi
-00013860: 6120 2263 6f6e 7472 6163 7473 2220 636f  a "contracts" co
-00013870: 6e76 6572 7369 6f6e 0a20 2020 2020 2020  nversion.       
-00013880: 2020 2020 2066 6565 5f63 6f73 7420 3d20       fee_cost = 
-00013890: 7365 6c66 2e5f 636f 6e74 7261 6374 735f  self._contracts_
-000138a0: 746f 5f61 6d6f 756e 7428 7379 6d62 6f6c  to_amount(symbol
-000138b0: 2c20 6665 655b 2763 6f73 7427 5d29 0a0a  , fee['cost'])..
-000138c0: 2020 2020 2020 2020 2320 4361 6c63 756c          # Calcul
-000138d0: 6174 6520 6665 6520 6261 7365 6420 6f6e  ate fee based on
-000138e0: 206f 7264 6572 2064 6574 6169 6c73 0a20   order details. 
-000138f0: 2020 2020 2020 2069 6620 6665 655f 6375         if fee_cu
-00013900: 7272 203d 3d20 7365 6c66 2e67 6574 5f70  rr == self.get_p
-00013910: 6169 725f 6261 7365 5f63 7572 7265 6e63  air_base_currenc
-00013920: 7928 7379 6d62 6f6c 293a 0a20 2020 2020  y(symbol):.     
-00013930: 2020 2020 2020 2023 2042 6173 6520 6375         # Base cu
-00013940: 7272 656e 6379 202d 2064 6976 6964 6520  rrency - divide 
-00013950: 6279 2061 6d6f 756e 740a 2020 2020 2020  by amount.      
-00013960: 2020 2020 2020 7265 7475 726e 2072 6f75        return rou
-00013970: 6e64 2866 6565 5f63 6f73 7420 2f20 616d  nd(fee_cost / am
-00013980: 6f75 6e74 2c20 3829 0a20 2020 2020 2020  ount, 8).       
-00013990: 2065 6c69 6620 6665 655f 6375 7272 203d   elif fee_curr =
-000139a0: 3d20 7365 6c66 2e67 6574 5f70 6169 725f  = self.get_pair_
-000139b0: 7175 6f74 655f 6375 7272 656e 6379 2873  quote_currency(s
-000139c0: 796d 626f 6c29 3a0a 2020 2020 2020 2020  ymbol):.        
-000139d0: 2020 2020 2320 5175 6f74 6520 6375 7272      # Quote curr
-000139e0: 656e 6379 202d 2064 6976 6964 6520 6279  ency - divide by
-000139f0: 2063 6f73 740a 2020 2020 2020 2020 2020   cost.          
-00013a00: 2020 7265 7475 726e 2072 6f75 6e64 2866    return round(f
-00013a10: 6565 5f63 6f73 7420 2f20 636f 7374 2c20  ee_cost / cost, 
-00013a20: 3829 2069 6620 636f 7374 2065 6c73 6520  8) if cost else 
-00013a30: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
-00013a40: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00013a50: 2049 6620 4665 6520 6375 7272 656e 6379   If Fee currency
-00013a60: 2069 7320 6120 6469 6666 6572 656e 7420   is a different 
-00013a70: 6375 7272 656e 6379 0a20 2020 2020 2020  currency.       
-00013a80: 2020 2020 2069 6620 6e6f 7420 636f 7374       if not cost
-00013a90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013aa0: 2020 2320 4966 2063 6f73 7420 6973 204e    # If cost is N
-00013ab0: 6f6e 6520 6f72 2030 2e30 202d 3e20 6661  one or 0.0 -> fa
-00013ac0: 6c73 792c 2072 6574 7572 6e20 4e6f 6e65  lsy, return None
-00013ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013ae0: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-00013af0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00013b00: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00013b10: 6d62 203d 2073 656c 662e 6765 745f 7661  mb = self.get_va
-00013b20: 6c69 645f 7061 6972 5f63 6f6d 6269 6e61  lid_pair_combina
-00013b30: 7469 6f6e 2866 6565 5f63 7572 722c 2073  tion(fee_curr, s
-00013b40: 656c 662e 5f63 6f6e 6669 675b 2773 7461  elf._config['sta
-00013b50: 6b65 5f63 7572 7265 6e63 7927 5d29 0a20  ke_currency']). 
-00013b60: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00013b70: 6963 6b20 3d20 7365 6c66 2e66 6574 6368  ick = self.fetch
-00013b80: 5f74 6963 6b65 7228 636f 6d62 290a 0a20  _ticker(comb).. 
-00013b90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00013ba0: 6565 5f74 6f5f 7175 6f74 655f 7261 7465  ee_to_quote_rate
-00013bb0: 203d 2073 6166 655f 7661 6c75 655f 6661   = safe_value_fa
-00013bc0: 6c6c 6261 636b 3228 7469 636b 2c20 7469  llback2(tick, ti
-00013bd0: 636b 2c20 276c 6173 7427 2c20 2761 736b  ck, 'last', 'ask
-00013be0: 2729 0a20 2020 2020 2020 2020 2020 2065  ').            e
-00013bf0: 7863 6570 7420 4578 6368 616e 6765 4572  xcept ExchangeEr
-00013c00: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00013c10: 2020 2020 2066 6565 5f74 6f5f 7175 6f74       fee_to_quot
-00013c20: 655f 7261 7465 203d 2073 656c 662e 5f63  e_rate = self._c
-00013c30: 6f6e 6669 675b 2765 7863 6861 6e67 6527  onfig['exchange'
-00013c40: 5d2e 6765 7428 2775 6e6b 6e6f 776e 5f66  ].get('unknown_f
-00013c50: 6565 5f72 6174 6527 2c20 4e6f 6e65 290a  ee_rate', None).
-00013c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013c70: 6966 206e 6f74 2066 6565 5f74 6f5f 7175  if not fee_to_qu
-00013c80: 6f74 655f 7261 7465 3a0a 2020 2020 2020  ote_rate:.      
-00013c90: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00013ca0: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
-00013cb0: 2020 2020 2020 7265 7475 726e 2072 6f75        return rou
-00013cc0: 6e64 2828 6665 655f 636f 7374 202a 2066  nd((fee_cost * f
-00013cd0: 6565 5f74 6f5f 7175 6f74 655f 7261 7465  ee_to_quote_rate
-00013ce0: 2920 2f20 636f 7374 2c20 3829 0a0a 2020  ) / cost, 8)..  
-00013cf0: 2020 6465 6620 6578 7472 6163 745f 636f    def extract_co
-00013d00: 7374 5f63 7572 725f 7261 7465 2873 656c  st_curr_rate(sel
-00013d10: 662c 2066 6565 3a20 4469 6374 2c20 7379  f, fee: Dict, sy
-00013d20: 6d62 6f6c 3a20 7374 722c 2063 6f73 743a  mbol: str, cost:
-00013d30: 2066 6c6f 6174 2c0a 2020 2020 2020 2020   float,.        
-00013d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d50: 2020 2020 2020 2061 6d6f 756e 743a 2066         amount: f
-00013d60: 6c6f 6174 2920 2d3e 2054 7570 6c65 5b66  loat) -> Tuple[f
-00013d70: 6c6f 6174 2c20 7374 722c 204f 7074 696f  loat, str, Optio
-00013d80: 6e61 6c5b 666c 6f61 745d 5d3a 0a20 2020  nal[float]]:.   
-00013d90: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00013da0: 2045 7874 7261 6374 2074 7570 6c65 206f   Extract tuple o
-00013db0: 6620 636f 7374 2c20 6375 7272 656e 6379  f cost, currency
-00013dc0: 2c20 7261 7465 2e0a 2020 2020 2020 2020  , rate..        
-00013dd0: 5265 7175 6972 6573 206f 7264 6572 5f68  Requires order_h
-00013de0: 6173 5f66 6565 2074 6f20 7275 6e20 6669  as_fee to run fi
-00013df0: 7273 7421 0a20 2020 2020 2020 203a 7061  rst!.        :pa
-00013e00: 7261 6d20 6665 653a 2063 6378 7420 4665  ram fee: ccxt Fe
-00013e10: 6520 6469 6374 202d 206d 7573 7420 636f  e dict - must co
-00013e20: 6e74 6169 6e20 636f 7374 202f 2063 7572  ntain cost / cur
-00013e30: 7265 6e63 7920 2f20 7261 7465 0a20 2020  rency / rate.   
-00013e40: 2020 2020 203a 7061 7261 6d20 7379 6d62       :param symb
-00013e50: 6f6c 3a20 5379 6d62 6f6c 206f 6620 7468  ol: Symbol of th
-00013e60: 6520 6f72 6465 720a 2020 2020 2020 2020  e order.        
-00013e70: 3a70 6172 616d 2063 6f73 743a 2054 6f74  :param cost: Tot
-00013e80: 616c 2063 6f73 7420 6f66 2074 6865 206f  al cost of the o
-00013e90: 7264 6572 0a20 2020 2020 2020 203a 7061  rder.        :pa
-00013ea0: 7261 6d20 616d 6f75 6e74 3a20 416d 6f75  ram amount: Amou
-00013eb0: 6e74 206f 6620 7468 6520 6f72 6465 720a  nt of the order.
-00013ec0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-00013ed0: 2054 7570 6c65 2077 6974 6820 636f 7374   Tuple with cost
-00013ee0: 2c20 6375 7272 656e 6379 2c20 7261 7465  , currency, rate
-00013ef0: 206f 6620 7468 6520 6769 7665 6e20 6665   of the given fe
-00013f00: 6520 6469 6374 0a20 2020 2020 2020 2022  e dict.        "
-00013f10: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-00013f20: 6e20 2866 6c6f 6174 2866 6565 5b27 636f  n (float(fee['co
-00013f30: 7374 275d 292c 0a20 2020 2020 2020 2020  st']),.         
-00013f40: 2020 2020 2020 2066 6565 5b27 6375 7272         fee['curr
-00013f50: 656e 6379 275d 2c0a 2020 2020 2020 2020  ency'],.        
-00013f60: 2020 2020 2020 2020 7365 6c66 2e63 616c          self.cal
-00013f70: 6375 6c61 7465 5f66 6565 5f72 6174 6528  culate_fee_rate(
-00013f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013f90: 2020 2020 2066 6565 2c0a 2020 2020 2020       fee,.      
-00013fa0: 2020 2020 2020 2020 2020 2020 2020 7379                sy
-00013fb0: 6d62 6f6c 2c0a 2020 2020 2020 2020 2020  mbol,.          
-00013fc0: 2020 2020 2020 2020 2020 636f 7374 2c0a            cost,.
-00013fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013fe0: 2020 2020 616d 6f75 6e74 0a20 2020 2020      amount.     
-00013ff0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00014000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014010: 2029 0a0a 2020 2020 2320 4869 7374 6f72   )..    # Histor
-00014020: 6963 2064 6174 610a 0a20 2020 2064 6566  ic data..    def
-00014030: 2067 6574 5f68 6973 746f 7269 635f 6f68   get_historic_oh
-00014040: 6c63 7628 7365 6c66 2c20 7061 6972 3a20  lcv(self, pair: 
-00014050: 7374 722c 2074 696d 6566 7261 6d65 3a20  str, timeframe: 
-00014060: 7374 722c 0a20 2020 2020 2020 2020 2020  str,.           
-00014070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014080: 7369 6e63 655f 6d73 3a20 696e 742c 2063  since_ms: int, c
-00014090: 616e 646c 655f 7479 7065 3a20 4361 6e64  andle_type: Cand
-000140a0: 6c65 5479 7065 2c0a 2020 2020 2020 2020  leType,.        
-000140b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140c0: 2020 2069 735f 6e65 775f 7061 6972 3a20     is_new_pair: 
-000140d0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-000140e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140f0: 2020 2020 2020 2020 2075 6e74 696c 5f6d           until_m
-00014100: 733a 204f 7074 696f 6e61 6c5b 696e 745d  s: Optional[int]
-00014110: 203d 204e 6f6e 6529 202d 3e20 4c69 7374   = None) -> List
-00014120: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00014130: 2020 2020 2020 4765 7420 6361 6e64 6c65        Get candle
-00014140: 2068 6973 746f 7279 2075 7369 6e67 2061   history using a
-00014150: 7379 6e63 696f 2061 6e64 2072 6574 7572  syncio and retur
-00014160: 6e73 2074 6865 206c 6973 7420 6f66 2063  ns the list of c
-00014170: 616e 646c 6573 2e0a 2020 2020 2020 2020  andles..        
-00014180: 4861 6e64 6c65 7320 616c 6c20 6173 796e  Handles all asyn
-00014190: 6320 776f 726b 2066 6f72 2074 6869 732e  c work for this.
-000141a0: 0a20 2020 2020 2020 2041 7379 6e63 206f  .        Async o
-000141b0: 7665 7220 6f6e 6520 7061 6972 2c20 6173  ver one pair, as
-000141c0: 7375 6d69 6e67 2077 6520 6765 7420 6073  suming we get `s
-000141d0: 656c 662e 6f68 6c63 765f 6361 6e64 6c65  elf.ohlcv_candle
-000141e0: 5f6c 696d 6974 2829 6020 6361 6e64 6c65  _limit()` candle
-000141f0: 7320 7065 7220 6361 6c6c 2e0a 2020 2020  s per call..    
-00014200: 2020 2020 3a70 6172 616d 2070 6169 723a      :param pair:
-00014210: 2050 6169 7220 746f 2064 6f77 6e6c 6f61   Pair to downloa
-00014220: 640a 2020 2020 2020 2020 3a70 6172 616d  d.        :param
-00014230: 2074 696d 6566 7261 6d65 3a20 5469 6d65   timeframe: Time
-00014240: 6672 616d 6520 746f 2067 6574 2064 6174  frame to get dat
-00014250: 6120 666f 720a 2020 2020 2020 2020 3a70  a for.        :p
-00014260: 6172 616d 2073 696e 6365 5f6d 733a 2054  aram since_ms: T
-00014270: 696d 6573 7461 6d70 2069 6e20 6d69 6c6c  imestamp in mill
-00014280: 6973 6563 6f6e 6473 2074 6f20 6765 7420  iseconds to get 
-00014290: 6869 7374 6f72 7920 6672 6f6d 0a20 2020  history from.   
-000142a0: 2020 2020 203a 7061 7261 6d20 756e 7469       :param unti
-000142b0: 6c5f 6d73 3a20 5469 6d65 7374 616d 7020  l_ms: Timestamp 
-000142c0: 696e 206d 696c 6c69 7365 636f 6e64 7320  in milliseconds 
-000142d0: 746f 2067 6574 2068 6973 746f 7279 2075  to get history u
-000142e0: 7020 746f 0a20 2020 2020 2020 203a 7061  p to.        :pa
-000142f0: 7261 6d20 6361 6e64 6c65 5f74 7970 653a  ram candle_type:
-00014300: 2027 272c 206d 6172 6b2c 2069 6e64 6578   '', mark, index
-00014310: 2c20 7072 656d 6975 6d49 6e64 6578 2c20  , premiumIndex, 
-00014320: 6f72 2066 756e 6469 6e67 5f72 6174 650a  or funding_rate.
-00014330: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-00014340: 204c 6973 7420 7769 7468 2063 616e 646c   List with candl
-00014350: 6520 284f 484c 4356 2920 6461 7461 0a20  e (OHLCV) data. 
-00014360: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00014370: 2020 2070 6169 722c 205f 2c20 5f2c 2064     pair, _, _, d
-00014380: 6174 612c 205f 203d 2073 656c 662e 6c6f  ata, _ = self.lo
-00014390: 6f70 2e72 756e 5f75 6e74 696c 5f63 6f6d  op.run_until_com
-000143a0: 706c 6574 6528 0a20 2020 2020 2020 2020  plete(.         
-000143b0: 2020 2073 656c 662e 5f61 7379 6e63 5f67     self._async_g
-000143c0: 6574 5f68 6973 746f 7269 635f 6f68 6c63  et_historic_ohlc
-000143d0: 7628 7061 6972 3d70 6169 722c 2074 696d  v(pair=pair, tim
-000143e0: 6566 7261 6d65 3d74 696d 6566 7261 6d65  eframe=timeframe
-000143f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014410: 2020 2020 2020 2020 2020 2020 2073 696e               sin
-00014420: 6365 5f6d 733d 7369 6e63 655f 6d73 2c20  ce_ms=since_ms, 
-00014430: 756e 7469 6c5f 6d73 3d75 6e74 696c 5f6d  until_ms=until_m
-00014440: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00014450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014460: 2020 2020 2020 2020 2020 2020 2020 6973                is
-00014470: 5f6e 6577 5f70 6169 723d 6973 5f6e 6577  _new_pair=is_new
-00014480: 5f70 6169 722c 2063 616e 646c 655f 7479  _pair, candle_ty
-00014490: 7065 3d63 616e 646c 655f 7479 7065 2929  pe=candle_type))
-000144a0: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-000144b0: 696e 666f 2866 2244 6f77 6e6c 6f61 6465  info(f"Downloade
-000144c0: 6420 6461 7461 2066 6f72 207b 7061 6972  d data for {pair
-000144d0: 7d20 7769 7468 206c 656e 6774 6820 7b6c  } with length {l
-000144e0: 656e 2864 6174 6129 7d2e 2229 0a20 2020  en(data)}.").   
-000144f0: 2020 2020 2072 6574 7572 6e20 6461 7461       return data
-00014500: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00014510: 5f61 7379 6e63 5f67 6574 5f68 6973 746f  _async_get_histo
-00014520: 7269 635f 6f68 6c63 7628 7365 6c66 2c20  ric_ohlcv(self, 
-00014530: 7061 6972 3a20 7374 722c 2074 696d 6566  pair: str, timef
-00014540: 7261 6d65 3a20 7374 722c 0a20 2020 2020  rame: str,.     
-00014550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014570: 2020 2073 696e 6365 5f6d 733a 2069 6e74     since_ms: int
-00014580: 2c20 6361 6e64 6c65 5f74 7970 653a 2043  , candle_type: C
-00014590: 616e 646c 6554 7970 652c 0a20 2020 2020  andleType,.     
-000145a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145c0: 2020 2069 735f 6e65 775f 7061 6972 3a20     is_new_pair: 
-000145d0: 626f 6f6c 203d 2046 616c 7365 2c20 7261  bool = False, ra
-000145e0: 6973 655f 3a20 626f 6f6c 203d 2046 616c  ise_: bool = Fal
-000145f0: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
-00014600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014610: 2020 2020 2020 2020 2020 2020 756e 7469              unti
-00014620: 6c5f 6d73 3a20 4f70 7469 6f6e 616c 5b69  l_ms: Optional[i
-00014630: 6e74 5d20 3d20 4e6f 6e65 0a20 2020 2020  nt] = None.     
-00014640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014660: 2020 2029 202d 3e20 4f48 4c43 5652 6573     ) -> OHLCVRes
-00014670: 706f 6e73 653a 0a20 2020 2020 2020 2022  ponse:.        "
-00014680: 2222 0a20 2020 2020 2020 2044 6f77 6e6c  "".        Downl
-00014690: 6f61 6420 6869 7374 6f72 6963 206f 686c  oad historic ohl
-000146a0: 6376 0a20 2020 2020 2020 203a 7061 7261  cv.        :para
-000146b0: 6d20 6973 5f6e 6577 5f70 6169 723a 2075  m is_new_pair: u
-000146c0: 7365 6420 6279 2062 696e 616e 6365 2073  sed by binance s
-000146d0: 7562 636c 6173 7320 746f 2061 6c6c 6f77  ubclass to allow
-000146e0: 2022 6661 7374 2220 6e65 7720 7061 6972   "fast" new pair
-000146f0: 2064 6f77 6e6c 6f61 6469 6e67 0a20 2020   downloading.   
-00014700: 2020 2020 203a 7061 7261 6d20 6361 6e64       :param cand
-00014710: 6c65 5f74 7970 653a 2041 6e79 206f 6620  le_type: Any of 
-00014720: 7468 6520 656e 756d 2043 616e 646c 6554  the enum CandleT
-00014730: 7970 6520 286d 7573 7420 6d61 7463 6820  ype (must match 
-00014740: 7472 6164 696e 6720 6d6f 6465 2129 0a20  trading mode!). 
-00014750: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00014760: 2020 2020 6f6e 655f 6361 6c6c 203d 2074      one_call = t
-00014770: 696d 6566 7261 6d65 5f74 6f5f 6d73 6563  imeframe_to_msec
-00014780: 7328 7469 6d65 6672 616d 6529 202a 2073  s(timeframe) * s
-00014790: 656c 662e 6f68 6c63 765f 6361 6e64 6c65  elf.ohlcv_candle
-000147a0: 5f6c 696d 6974 280a 2020 2020 2020 2020  _limit(.        
-000147b0: 2020 2020 7469 6d65 6672 616d 652c 2063      timeframe, c
-000147c0: 616e 646c 655f 7479 7065 2c20 7369 6e63  andle_type, sinc
-000147d0: 655f 6d73 290a 2020 2020 2020 2020 6c6f  e_ms).        lo
-000147e0: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-000147f0: 2020 2020 2020 2020 226f 6e65 5f63 616c          "one_cal
-00014800: 6c3a 2025 7320 6d73 6563 7320 2825 7329  l: %s msecs (%s)
-00014810: 222c 0a20 2020 2020 2020 2020 2020 206f  ",.            o
-00014820: 6e65 5f63 616c 6c2c 0a20 2020 2020 2020  ne_call,.       
-00014830: 2020 2020 2061 7272 6f77 2e75 7463 6e6f       arrow.utcno
-00014840: 7728 292e 7368 6966 7428 7365 636f 6e64  w().shift(second
-00014850: 733d 6f6e 655f 6361 6c6c 202f 2f20 3130  s=one_call // 10
-00014860: 3030 292e 6875 6d61 6e69 7a65 286f 6e6c  00).humanize(onl
-00014870: 795f 6469 7374 616e 6365 3d54 7275 6529  y_distance=True)
-00014880: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00014890: 2020 2069 6e70 7574 5f63 6f72 6f75 7469     input_corouti
-000148a0: 6e65 7320 3d20 5b73 656c 662e 5f61 7379  nes = [self._asy
-000148b0: 6e63 5f67 6574 5f63 616e 646c 655f 6869  nc_get_candle_hi
-000148c0: 7374 6f72 7928 0a20 2020 2020 2020 2020  story(.         
-000148d0: 2020 2070 6169 722c 2074 696d 6566 7261     pair, timefra
-000148e0: 6d65 2c20 6361 6e64 6c65 5f74 7970 652c  me, candle_type,
-000148f0: 2073 696e 6365 2920 666f 7220 7369 6e63   since) for sinc
-00014900: 6520 696e 0a20 2020 2020 2020 2020 2020  e in.           
-00014910: 2072 616e 6765 2873 696e 6365 5f6d 732c   range(since_ms,
-00014920: 2075 6e74 696c 5f6d 7320 6f72 2028 6172   until_ms or (ar
-00014930: 726f 772e 7574 636e 6f77 2829 2e69 6e74  row.utcnow().int
-00014940: 5f74 696d 6573 7461 6d70 202a 2031 3030  _timestamp * 100
-00014950: 3029 2c20 6f6e 655f 6361 6c6c 295d 0a0a  0), one_call)]..
-00014960: 2020 2020 2020 2020 6461 7461 3a20 4c69          data: Li
-00014970: 7374 203d 205b 5d0a 2020 2020 2020 2020  st = [].        
-00014980: 2320 4368 756e 6b20 7265 7175 6573 7473  # Chunk requests
-00014990: 2069 6e74 6f20 6261 7463 6865 7320 6f66   into batches of
-000149a0: 2031 3030 2074 6f20 6176 6f69 6420 6f76   100 to avoid ov
-000149b0: 6572 7765 6c6d 696e 6720 6363 7874 2054  erwelming ccxt T
-000149c0: 6872 6f74 746c 696e 670a 2020 2020 2020  hrottling.      
-000149d0: 2020 666f 7220 696e 7075 745f 636f 726f    for input_coro
-000149e0: 2069 6e20 6368 756e 6b73 2869 6e70 7574   in chunks(input
-000149f0: 5f63 6f72 6f75 7469 6e65 732c 2031 3030  _coroutines, 100
-00014a00: 293a 0a0a 2020 2020 2020 2020 2020 2020  ):..            
-00014a10: 7265 7375 6c74 7320 3d20 6177 6169 7420  results = await 
-00014a20: 6173 796e 6369 6f2e 6761 7468 6572 282a  asyncio.gather(*
-00014a30: 696e 7075 745f 636f 726f 2c20 7265 7475  input_coro, retu
-00014a40: 726e 5f65 7863 6570 7469 6f6e 733d 5472  rn_exceptions=Tr
-00014a50: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00014a60: 666f 7220 7265 7320 696e 2072 6573 756c  for res in resul
-00014a70: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00014a80: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00014a90: 6528 7265 732c 2045 7863 6570 7469 6f6e  e(res, Exception
-00014aa0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00014ab0: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00014ac0: 726e 696e 6728 6622 4173 796e 6320 636f  rning(f"Async co
-00014ad0: 6465 2072 6169 7365 6420 616e 2065 7863  de raised an exc
-00014ae0: 6570 7469 6f6e 3a20 7b72 6570 7228 7265  eption: {repr(re
-00014af0: 7329 7d22 290a 2020 2020 2020 2020 2020  s)}").          
-00014b00: 2020 2020 2020 2020 2020 6966 2072 6169            if rai
-00014b10: 7365 5f3a 0a20 2020 2020 2020 2020 2020  se_:.           
-00014b20: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00014b30: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00014b40: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00014b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00014b70: 2020 2020 2020 2020 2020 2320 4465 636f            # Deco
-00014b80: 6e73 7472 7563 7420 7475 706c 6520 6966  nstruct tuple if
-00014b90: 2069 7427 7320 6e6f 7420 616e 2065 7863   it's not an exc
-00014ba0: 6570 7469 6f6e 0a20 2020 2020 2020 2020  eption.         
-00014bb0: 2020 2020 2020 2020 2020 2070 2c20 5f2c             p, _,
-00014bc0: 2063 2c20 6e65 775f 6461 7461 2c20 5f20   c, new_data, _ 
-00014bd0: 3d20 7265 730a 2020 2020 2020 2020 2020  = res.          
-00014be0: 2020 2020 2020 2020 2020 6966 2070 203d            if p =
-00014bf0: 3d20 7061 6972 2061 6e64 2063 203d 3d20  = pair and c == 
-00014c00: 6361 6e64 6c65 5f74 7970 653a 0a20 2020  candle_type:.   
-00014c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c20: 2020 2020 2064 6174 612e 6578 7465 6e64       data.extend
-00014c30: 286e 6577 5f64 6174 6129 0a20 2020 2020  (new_data).     
-00014c40: 2020 2023 2053 6f72 7420 6461 7461 2061     # Sort data a
-00014c50: 6761 696e 2061 6674 6572 2065 7874 656e  gain after exten
-00014c60: 6469 6e67 2074 6865 2072 6573 756c 7420  ding the result 
-00014c70: 2d20 6162 6f76 6520 6361 6c6c 7320 7265  - above calls re
-00014c80: 7475 726e 2069 6e20 2261 7379 6e63 206f  turn in "async o
-00014c90: 7264 6572 220a 2020 2020 2020 2020 6461  rder".        da
-00014ca0: 7461 203d 2073 6f72 7465 6428 6461 7461  ta = sorted(data
-00014cb0: 2c20 6b65 793d 6c61 6d62 6461 2078 3a20  , key=lambda x: 
-00014cc0: 785b 305d 290a 2020 2020 2020 2020 7265  x[0]).        re
-00014cd0: 7475 726e 2070 6169 722c 2074 696d 6566  turn pair, timef
-00014ce0: 7261 6d65 2c20 6361 6e64 6c65 5f74 7970  rame, candle_typ
-00014cf0: 652c 2064 6174 612c 2073 656c 662e 5f6f  e, data, self._o
-00014d00: 686c 6376 5f70 6172 7469 616c 5f63 616e  hlcv_partial_can
-00014d10: 646c 650a 0a20 2020 2064 6566 205f 6275  dle..    def _bu
-00014d20: 696c 645f 636f 726f 7574 696e 6528 0a20  ild_coroutine(. 
-00014d30: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-00014d40: 2070 6169 723a 2073 7472 2c20 7469 6d65   pair: str, time
-00014d50: 6672 616d 653a 2073 7472 2c20 6361 6e64  frame: str, cand
-00014d60: 6c65 5f74 7970 653a 2043 616e 646c 6554  le_type: CandleT
-00014d70: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
-00014d80: 2073 696e 6365 5f6d 733a 204f 7074 696f   since_ms: Optio
-00014d90: 6e61 6c5b 696e 745d 2c20 6361 6368 653a  nal[int], cache:
-00014da0: 2062 6f6f 6c29 202d 3e20 436f 726f 7574   bool) -> Corout
-00014db0: 696e 655b 416e 792c 2041 6e79 2c20 4f48  ine[Any, Any, OH
-00014dc0: 4c43 5652 6573 706f 6e73 655d 3a0a 2020  LCVResponse]:.  
-00014dd0: 2020 2020 2020 6e6f 745f 616c 6c5f 6461        not_all_da
-00014de0: 7461 203d 2063 6163 6865 2061 6e64 2073  ta = cache and s
-00014df0: 656c 662e 7265 7175 6972 6564 5f63 616e  elf.required_can
-00014e00: 646c 655f 6361 6c6c 5f63 6f75 6e74 203e  dle_call_count >
-00014e10: 2031 0a20 2020 2020 2020 2069 6620 6361   1.        if ca
-00014e20: 6368 6520 616e 6420 2870 6169 722c 2074  che and (pair, t
-00014e30: 696d 6566 7261 6d65 2c20 6361 6e64 6c65  imeframe, candle
-00014e40: 5f74 7970 6529 2069 6e20 7365 6c66 2e5f  _type) in self._
-00014e50: 6b6c 696e 6573 3a0a 2020 2020 2020 2020  klines:.        
-00014e60: 2020 2020 6361 6e64 6c65 5f6c 696d 6974      candle_limit
-00014e70: 203d 2073 656c 662e 6f68 6c63 765f 6361   = self.ohlcv_ca
-00014e80: 6e64 6c65 5f6c 696d 6974 2874 696d 6566  ndle_limit(timef
-00014e90: 7261 6d65 2c20 6361 6e64 6c65 5f74 7970  rame, candle_typ
-00014ea0: 6529 0a20 2020 2020 2020 2020 2020 206d  e).            m
-00014eb0: 696e 5f64 6174 6520 3d20 6461 7465 5f6d  in_date = date_m
-00014ec0: 696e 7573 5f63 616e 646c 6573 2874 696d  inus_candles(tim
-00014ed0: 6566 7261 6d65 2c20 6361 6e64 6c65 5f6c  eframe, candle_l
-00014ee0: 696d 6974 202d 2035 292e 7469 6d65 7374  imit - 5).timest
-00014ef0: 616d 7028 290a 2020 2020 2020 2020 2020  amp().          
-00014f00: 2020 2320 4368 6563 6b20 6966 2031 2063    # Check if 1 c
-00014f10: 616c 6c20 6361 6e20 6765 7420 7573 2075  all can get us u
-00014f20: 7064 6174 6564 2063 616e 646c 6573 2077  pdated candles w
-00014f30: 6974 686f 7574 2068 6f6c 6520 696e 2074  ithout hole in t
-00014f40: 6865 2064 6174 612e 0a20 2020 2020 2020  he data..       
-00014f50: 2020 2020 2069 6620 6d69 6e5f 6461 7465       if min_date
-00014f60: 203c 2073 656c 662e 5f70 6169 7273 5f6c   < self._pairs_l
-00014f70: 6173 745f 7265 6672 6573 685f 7469 6d65  ast_refresh_time
-00014f80: 2e67 6574 2828 7061 6972 2c20 7469 6d65  .get((pair, time
-00014f90: 6672 616d 652c 2063 616e 646c 655f 7479  frame, candle_ty
-00014fa0: 7065 292c 2030 293a 0a20 2020 2020 2020  pe), 0):.       
-00014fb0: 2020 2020 2020 2020 2023 2043 6163 6865           # Cache
-00014fc0: 2063 616e 2062 6520 7573 6564 202d 2064   can be used - d
-00014fd0: 6f20 6f6e 652d 6f66 6620 6361 6c6c 2e0a  o one-off call..
-00014fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ff0: 6e6f 745f 616c 6c5f 6461 7461 203d 2046  not_all_data = F
-00015000: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-00015010: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00015020: 2020 2020 2020 2023 2054 696d 6520 6a75         # Time ju
-00015030: 6d70 2064 6574 6563 7465 642c 2065 7669  mp detected, evi
-00015040: 6374 2063 6163 6865 0a20 2020 2020 2020  ct cache.       
-00015050: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00015060: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-00015070: 2020 2020 2020 2020 2020 6622 5469 6d65            f"Time
-00015080: 206a 756d 7020 6465 7465 6374 6564 2e20   jump detected. 
-00015090: 4576 6963 7469 6e67 2063 6163 6865 2066  Evicting cache f
-000150a0: 6f72 207b 7061 6972 7d2c 207b 7469 6d65  or {pair}, {time
-000150b0: 6672 616d 657d 2c20 7b63 616e 646c 655f  frame}, {candle_
-000150c0: 7479 7065 7d22 290a 2020 2020 2020 2020  type}").        
-000150d0: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-000150e0: 2e5f 6b6c 696e 6573 5b28 7061 6972 2c20  ._klines[(pair, 
-000150f0: 7469 6d65 6672 616d 652c 2063 616e 646c  timeframe, candl
-00015100: 655f 7479 7065 295d 0a0a 2020 2020 2020  e_type)]..      
-00015110: 2020 6966 2028 6e6f 7420 7369 6e63 655f    if (not since_
-00015120: 6d73 2061 6e64 2028 7365 6c66 2e5f 6674  ms and (self._ft
-00015130: 5f68 6173 5b22 6f68 6c63 765f 7265 7175  _has["ohlcv_requ
-00015140: 6972 655f 7369 6e63 6522 5d20 6f72 206e  ire_since"] or n
-00015150: 6f74 5f61 6c6c 5f64 6174 6129 293a 0a20  ot_all_data)):. 
-00015160: 2020 2020 2020 2020 2020 2023 204d 756c             # Mul
-00015170: 7469 706c 6520 6361 6c6c 7320 666f 7220  tiple calls for 
-00015180: 6f6e 6520 7061 6972 202d 2074 6f20 6765  one pair - to ge
-00015190: 7420 6d6f 7265 2068 6973 746f 7279 0a20  t more history. 
-000151a0: 2020 2020 2020 2020 2020 206f 6e65 5f63             one_c
-000151b0: 616c 6c20 3d20 7469 6d65 6672 616d 655f  all = timeframe_
-000151c0: 746f 5f6d 7365 6373 2874 696d 6566 7261  to_msecs(timefra
-000151d0: 6d65 2920 2a20 7365 6c66 2e6f 686c 6376  me) * self.ohlcv
-000151e0: 5f63 616e 646c 655f 6c69 6d69 7428 0a20  _candle_limit(. 
-000151f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00015200: 696d 6566 7261 6d65 2c20 6361 6e64 6c65  imeframe, candle
-00015210: 5f74 7970 652c 2073 696e 6365 5f6d 7329  _type, since_ms)
-00015220: 0a20 2020 2020 2020 2020 2020 206d 6f76  .            mov
-00015230: 655f 746f 203d 206f 6e65 5f63 616c 6c20  e_to = one_call 
-00015240: 2a20 7365 6c66 2e72 6571 7569 7265 645f  * self.required_
-00015250: 6361 6e64 6c65 5f63 616c 6c5f 636f 756e  candle_call_coun
-00015260: 740a 2020 2020 2020 2020 2020 2020 6e6f  t.            no
-00015270: 7720 3d20 7469 6d65 6672 616d 655f 746f  w = timeframe_to
-00015280: 5f6e 6578 745f 6461 7465 2874 696d 6566  _next_date(timef
-00015290: 7261 6d65 290a 2020 2020 2020 2020 2020  rame).          
-000152a0: 2020 7369 6e63 655f 6d73 203d 2069 6e74    since_ms = int
-000152b0: 2828 6e6f 7720 2d20 7469 6d65 6465 6c74  ((now - timedelt
-000152c0: 6128 7365 636f 6e64 733d 6d6f 7665 5f74  a(seconds=move_t
-000152d0: 6f20 2f2f 2031 3030 3029 292e 7469 6d65  o // 1000)).time
-000152e0: 7374 616d 7028 2920 2a20 3130 3030 290a  stamp() * 1000).
-000152f0: 0a20 2020 2020 2020 2069 6620 7369 6e63  .        if sinc
-00015300: 655f 6d73 3a0a 2020 2020 2020 2020 2020  e_ms:.          
-00015310: 2020 7265 7475 726e 2073 656c 662e 5f61    return self._a
-00015320: 7379 6e63 5f67 6574 5f68 6973 746f 7269  sync_get_histori
-00015330: 635f 6f68 6c63 7628 0a20 2020 2020 2020  c_ohlcv(.       
-00015340: 2020 2020 2020 2020 2070 6169 722c 2074           pair, t
-00015350: 696d 6566 7261 6d65 2c20 7369 6e63 655f  imeframe, since_
-00015360: 6d73 3d73 696e 6365 5f6d 732c 2072 6169  ms=since_ms, rai
-00015370: 7365 5f3d 5472 7565 2c20 6361 6e64 6c65  se_=True, candle
-00015380: 5f74 7970 653d 6361 6e64 6c65 5f74 7970  _type=candle_typ
-00015390: 6529 0a20 2020 2020 2020 2065 6c73 653a  e).        else:
-000153a0: 0a20 2020 2020 2020 2020 2020 2023 204f  .            # O
-000153b0: 6e65 2063 616c 6c20 2e2e 2e20 2272 6567  ne call ... "reg
-000153c0: 756c 6172 2220 7265 6672 6573 680a 2020  ular" refresh.  
-000153d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000153e0: 2073 656c 662e 5f61 7379 6e63 5f67 6574   self._async_get
-000153f0: 5f63 616e 646c 655f 6869 7374 6f72 7928  _candle_history(
-00015400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015410: 2070 6169 722c 2074 696d 6566 7261 6d65   pair, timeframe
-00015420: 2c20 7369 6e63 655f 6d73 3d73 696e 6365  , since_ms=since
-00015430: 5f6d 732c 2063 616e 646c 655f 7479 7065  _ms, candle_type
-00015440: 3d63 616e 646c 655f 7479 7065 290a 0a20  =candle_type).. 
-00015450: 2020 2064 6566 205f 6275 696c 645f 6f68     def _build_oh
-00015460: 6c63 765f 646c 5f6a 6f62 7328 0a20 2020  lcv_dl_jobs(.   
-00015470: 2020 2020 2020 2020 2073 656c 662c 2070           self, p
-00015480: 6169 725f 6c69 7374 3a20 4c69 7374 5061  air_list: ListPa
-00015490: 6972 7357 6974 6854 696d 6566 7261 6d65  irsWithTimeframe
-000154a0: 732c 2073 696e 6365 5f6d 733a 204f 7074  s, since_ms: Opt
-000154b0: 696f 6e61 6c5b 696e 745d 2c0a 2020 2020  ional[int],.    
-000154c0: 2020 2020 2020 2020 6361 6368 653a 2062          cache: b
-000154d0: 6f6f 6c29 202d 3e20 5475 706c 655b 4c69  ool) -> Tuple[Li
-000154e0: 7374 5b43 6f72 6f75 7469 6e65 5d2c 204c  st[Coroutine], L
-000154f0: 6973 745b 5475 706c 655b 7374 722c 2073  ist[Tuple[str, s
-00015500: 7472 2c20 4361 6e64 6c65 5479 7065 5d5d  tr, CandleType]]
-00015510: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00015520: 2020 2020 2020 2042 7569 6c64 2043 6f72         Build Cor
-00015530: 6f75 7469 6e65 7320 746f 2065 7865 6375  outines to execu
-00015540: 7465 2061 7320 7061 7274 206f 6620 7265  te as part of re
-00015550: 6672 6573 685f 6c61 7465 7374 5f6f 686c  fresh_latest_ohl
-00015560: 6376 0a20 2020 2020 2020 2022 2222 0a20  cv.        """. 
-00015570: 2020 2020 2020 2069 6e70 7574 5f63 6f72         input_cor
-00015580: 6f75 7469 6e65 733a 204c 6973 745b 436f  outines: List[Co
-00015590: 726f 7574 696e 655b 416e 792c 2041 6e79  routine[Any, Any
-000155a0: 2c20 4f48 4c43 5652 6573 706f 6e73 655d  , OHLCVResponse]
-000155b0: 5d20 3d20 5b5d 0a20 2020 2020 2020 2063  ] = [].        c
-000155c0: 6163 6865 645f 7061 6972 7320 3d20 5b5d  ached_pairs = []
-000155d0: 0a20 2020 2020 2020 2066 6f72 2070 6169  .        for pai
-000155e0: 722c 2074 696d 6566 7261 6d65 2c20 6361  r, timeframe, ca
-000155f0: 6e64 6c65 5f74 7970 6520 696e 2073 6574  ndle_type in set
-00015600: 2870 6169 725f 6c69 7374 293a 0a20 2020  (pair_list):.   
-00015610: 2020 2020 2020 2020 2069 6620 2874 696d           if (tim
-00015620: 6566 7261 6d65 206e 6f74 2069 6e20 7365  eframe not in se
-00015630: 6c66 2e74 696d 6566 7261 6d65 730a 2020  lf.timeframes.  
-00015640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015650: 2020 616e 6420 6361 6e64 6c65 5f74 7970    and candle_typ
-00015660: 6520 696e 2028 4361 6e64 6c65 5479 7065  e in (CandleType
-00015670: 2e53 504f 542c 2043 616e 646c 6554 7970  .SPOT, CandleTyp
-00015680: 652e 4655 5455 5245 5329 293a 0a20 2020  e.FUTURES)):.   
-00015690: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-000156a0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
-000156b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156c0: 2066 2243 616e 6e6f 7420 646f 776e 6c6f   f"Cannot downlo
-000156d0: 6164 2028 7b70 6169 727d 2c20 7b74 696d  ad ({pair}, {tim
-000156e0: 6566 7261 6d65 7d29 2063 6f6d 6269 6e61  eframe}) combina
-000156f0: 7469 6f6e 2061 7320 7468 6973 2074 696d  tion as this tim
-00015700: 6566 7261 6d65 2069 7320 220a 2020 2020  eframe is ".    
-00015710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015720: 6622 6e6f 7420 6176 6169 6c61 626c 6520  f"not available 
-00015730: 6f6e 207b 7365 6c66 2e6e 616d 657d 2e20  on {self.name}. 
-00015740: 4176 6169 6c61 626c 6520 7469 6d65 6672  Available timefr
-00015750: 616d 6573 2061 7265 2022 0a20 2020 2020  ames are ".     
-00015760: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00015770: 227b 272c 2027 2e6a 6f69 6e28 7365 6c66  "{', '.join(self
-00015780: 2e74 696d 6566 7261 6d65 7329 7d2e 2229  .timeframes)}.")
-00015790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000157a0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-000157b0: 2020 2020 2020 2069 6620 2828 7061 6972         if ((pair
-000157c0: 2c20 7469 6d65 6672 616d 652c 2063 616e  , timeframe, can
-000157d0: 646c 655f 7479 7065 2920 6e6f 7420 696e  dle_type) not in
-000157e0: 2073 656c 662e 5f6b 6c69 6e65 7320 6f72   self._klines or
-000157f0: 206e 6f74 2063 6163 6865 0a20 2020 2020   not cache.     
-00015800: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00015810: 7220 7365 6c66 2e5f 6e6f 775f 6973 5f74  r self._now_is_t
-00015820: 696d 655f 746f 5f72 6566 7265 7368 2870  ime_to_refresh(p
-00015830: 6169 722c 2074 696d 6566 7261 6d65 2c20  air, timeframe, 
-00015840: 6361 6e64 6c65 5f74 7970 6529 293a 0a0a  candle_type)):..
-00015850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015860: 696e 7075 745f 636f 726f 7574 696e 6573  input_coroutines
-00015870: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
-00015880: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00015890: 662e 5f62 7569 6c64 5f63 6f72 6f75 7469  f._build_corouti
-000158a0: 6e65 2870 6169 722c 2074 696d 6566 7261  ne(pair, timefra
-000158b0: 6d65 2c20 6361 6e64 6c65 5f74 7970 652c  me, candle_type,
-000158c0: 2073 696e 6365 5f6d 732c 2063 6163 6865   since_ms, cache
-000158d0: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-000158e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000158f0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-00015900: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-00015910: 2020 2020 2020 2020 6622 5573 696e 6720          f"Using 
-00015920: 6361 6368 6564 2063 616e 646c 6520 284f  cached candle (O
-00015930: 484c 4356 2920 6461 7461 2066 6f72 207b  HLCV) data for {
-00015940: 7061 6972 7d2c 207b 7469 6d65 6672 616d  pair}, {timefram
-00015950: 657d 2c20 7b63 616e 646c 655f 7479 7065  e}, {candle_type
-00015960: 7d20 2e2e 2e22 0a20 2020 2020 2020 2020  } ...".         
-00015970: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00015980: 2020 2020 2020 2020 2063 6163 6865 645f           cached_
-00015990: 7061 6972 732e 6170 7065 6e64 2828 7061  pairs.append((pa
-000159a0: 6972 2c20 7469 6d65 6672 616d 652c 2063  ir, timeframe, c
-000159b0: 616e 646c 655f 7479 7065 2929 0a0a 2020  andle_type))..  
-000159c0: 2020 2020 2020 7265 7475 726e 2069 6e70        return inp
-000159d0: 7574 5f63 6f72 6f75 7469 6e65 732c 2063  ut_coroutines, c
-000159e0: 6163 6865 645f 7061 6972 730a 0a20 2020  ached_pairs..   
-000159f0: 2064 6566 205f 7072 6f63 6573 735f 6f68   def _process_oh
-00015a00: 6c63 765f 6466 2873 656c 662c 2070 6169  lcv_df(self, pai
-00015a10: 723a 2073 7472 2c20 7469 6d65 6672 616d  r: str, timefram
-00015a20: 653a 2073 7472 2c20 635f 7479 7065 3a20  e: str, c_type: 
-00015a30: 4361 6e64 6c65 5479 7065 2c20 7469 636b  CandleType, tick
-00015a40: 733a 204c 6973 745b 4c69 7374 5d2c 0a20  s: List[List],. 
-00015a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a60: 2020 2020 2020 2020 2063 6163 6865 3a20           cache: 
-00015a70: 626f 6f6c 2c20 6472 6f70 5f69 6e63 6f6d  bool, drop_incom
-00015a80: 706c 6574 653a 2062 6f6f 6c29 202d 3e20  plete: bool) -> 
-00015a90: 4461 7461 4672 616d 653a 0a20 2020 2020  DataFrame:.     
-00015aa0: 2020 2023 206b 6565 7069 6e67 206c 6173     # keeping las
-00015ab0: 7420 6361 6e64 6c65 2074 696d 6520 6173  t candle time as
-00015ac0: 206c 6173 7420 7265 6672 6573 6865 6420   last refreshed 
-00015ad0: 7469 6d65 206f 6620 7468 6520 7061 6972  time of the pair
-00015ae0: 0a20 2020 2020 2020 2069 6620 7469 636b  .        if tick
-00015af0: 7320 616e 6420 6361 6368 653a 0a20 2020  s and cache:.   
-00015b00: 2020 2020 2020 2020 2069 6478 203d 202d           idx = -
-00015b10: 3220 6966 2064 726f 705f 696e 636f 6d70  2 if drop_incomp
-00015b20: 6c65 7465 2061 6e64 206c 656e 2874 6963  lete and len(tic
-00015b30: 6b73 2920 3e20 3120 656c 7365 202d 310a  ks) > 1 else -1.
-00015b40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015b50: 2e5f 7061 6972 735f 6c61 7374 5f72 6566  ._pairs_last_ref
-00015b60: 7265 7368 5f74 696d 655b 2870 6169 722c  resh_time[(pair,
-00015b70: 2074 696d 6566 7261 6d65 2c20 635f 7479   timeframe, c_ty
-00015b80: 7065 295d 203d 2074 6963 6b73 5b69 6478  pe)] = ticks[idx
-00015b90: 5d5b 305d 202f 2f20 3130 3030 0a20 2020  ][0] // 1000.   
-00015ba0: 2020 2020 2023 206b 6565 7069 6e67 2070       # keeping p
-00015bb0: 6172 7365 6420 6461 7461 6672 616d 6520  arsed dataframe 
-00015bc0: 696e 2063 6163 6865 0a20 2020 2020 2020  in cache.       
-00015bd0: 206f 686c 6376 5f64 6620 3d20 6f68 6c63   ohlcv_df = ohlc
-00015be0: 765f 746f 5f64 6174 6166 7261 6d65 2874  v_to_dataframe(t
-00015bf0: 6963 6b73 2c20 7469 6d65 6672 616d 652c  icks, timeframe,
-00015c00: 2070 6169 723d 7061 6972 2c20 6669 6c6c   pair=pair, fill
-00015c10: 5f6d 6973 7369 6e67 3d54 7275 652c 0a20  _missing=True,. 
-00015c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c40: 2020 2020 2064 726f 705f 696e 636f 6d70       drop_incomp
-00015c50: 6c65 7465 3d64 726f 705f 696e 636f 6d70  lete=drop_incomp
-00015c60: 6c65 7465 290a 2020 2020 2020 2020 6966  lete).        if
-00015c70: 2063 6163 6865 3a0a 2020 2020 2020 2020   cache:.        
-00015c80: 2020 2020 6966 2028 7061 6972 2c20 7469      if (pair, ti
-00015c90: 6d65 6672 616d 652c 2063 5f74 7970 6529  meframe, c_type)
-00015ca0: 2069 6e20 7365 6c66 2e5f 6b6c 696e 6573   in self._klines
-00015cb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015cc0: 2020 6f6c 6420 3d20 7365 6c66 2e5f 6b6c    old = self._kl
-00015cd0: 696e 6573 5b28 7061 6972 2c20 7469 6d65  ines[(pair, time
-00015ce0: 6672 616d 652c 2063 5f74 7970 6529 5d0a  frame, c_type)].
-00015cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d00: 2320 5265 6173 7369 676e 2073 6f20 7765  # Reassign so we
-00015d10: 2072 6574 7572 6e20 7468 6520 7570 6461   return the upda
-00015d20: 7465 642c 2063 6f6d 6269 6e65 6420 6466  ted, combined df
-00015d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015d40: 206f 686c 6376 5f64 6620 3d20 636c 6561   ohlcv_df = clea
-00015d50: 6e5f 6f68 6c63 765f 6461 7461 6672 616d  n_ohlcv_datafram
-00015d60: 6528 636f 6e63 6174 285b 6f6c 642c 206f  e(concat([old, o
-00015d70: 686c 6376 5f64 665d 2c20 6178 6973 3d30  hlcv_df], axis=0
-00015d80: 292c 2074 696d 6566 7261 6d65 2c20 7061  ), timeframe, pa
-00015d90: 6972 2c0a 2020 2020 2020 2020 2020 2020  ir,.            
-00015da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015dc0: 2020 2020 2066 696c 6c5f 6d69 7373 696e       fill_missin
-00015dd0: 673d 5472 7565 2c20 6472 6f70 5f69 6e63  g=True, drop_inc
-00015de0: 6f6d 706c 6574 653d 4661 6c73 6529 0a20  omplete=False). 
-00015df0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00015e00: 616e 646c 655f 6c69 6d69 7420 3d20 7365  andle_limit = se
-00015e10: 6c66 2e6f 686c 6376 5f63 616e 646c 655f  lf.ohlcv_candle_
-00015e20: 6c69 6d69 7428 7469 6d65 6672 616d 652c  limit(timeframe,
-00015e30: 2073 656c 662e 5f63 6f6e 6669 675b 2763   self._config['c
-00015e40: 616e 646c 655f 7479 7065 5f64 6566 275d  andle_type_def']
-00015e50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015e60: 2020 2320 4167 6520 6f75 7420 6f6c 6420    # Age out old 
-00015e70: 6361 6e64 6c65 730a 2020 2020 2020 2020  candles.        
-00015e80: 2020 2020 2020 2020 6f68 6c63 765f 6466          ohlcv_df
-00015e90: 203d 206f 686c 6376 5f64 662e 7461 696c   = ohlcv_df.tail
-00015ea0: 2863 616e 646c 655f 6c69 6d69 7420 2b20  (candle_limit + 
-00015eb0: 7365 6c66 2e5f 7374 6172 7475 705f 6361  self._startup_ca
-00015ec0: 6e64 6c65 5f63 6f75 6e74 290a 2020 2020  ndle_count).    
-00015ed0: 2020 2020 2020 2020 2020 2020 6f68 6c63              ohlc
-00015ee0: 765f 6466 203d 206f 686c 6376 5f64 662e  v_df = ohlcv_df.
-00015ef0: 7265 7365 745f 696e 6465 7828 6472 6f70  reset_index(drop
-00015f00: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-00015f10: 2020 2020 2020 2073 656c 662e 5f6b 6c69         self._kli
-00015f20: 6e65 735b 2870 6169 722c 2074 696d 6566  nes[(pair, timef
-00015f30: 7261 6d65 2c20 635f 7479 7065 295d 203d  rame, c_type)] =
-00015f40: 206f 686c 6376 5f64 660a 2020 2020 2020   ohlcv_df.      
-00015f50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00015f60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00015f70: 2e5f 6b6c 696e 6573 5b28 7061 6972 2c20  ._klines[(pair, 
-00015f80: 7469 6d65 6672 616d 652c 2063 5f74 7970  timeframe, c_typ
-00015f90: 6529 5d20 3d20 6f68 6c63 765f 6466 0a20  e)] = ohlcv_df. 
-00015fa0: 2020 2020 2020 2072 6574 7572 6e20 6f68         return oh
-00015fb0: 6c63 765f 6466 0a0a 2020 2020 6465 6620  lcv_df..    def 
-00015fc0: 7265 6672 6573 685f 6c61 7465 7374 5f6f  refresh_latest_o
-00015fd0: 686c 6376 2873 656c 662c 2070 6169 725f  hlcv(self, pair_
-00015fe0: 6c69 7374 3a20 4c69 7374 5061 6972 7357  list: ListPairsW
-00015ff0: 6974 6854 696d 6566 7261 6d65 732c 202a  ithTimeframes, *
-00016000: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016010: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00016020: 696e 6365 5f6d 733a 204f 7074 696f 6e61  ince_ms: Optiona
-00016030: 6c5b 696e 745d 203d 204e 6f6e 652c 2063  l[int] = None, c
-00016040: 6163 6865 3a20 626f 6f6c 203d 2054 7275  ache: bool = Tru
-00016050: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00016060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016070: 6472 6f70 5f69 6e63 6f6d 706c 6574 653a  drop_incomplete:
-00016080: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
-00016090: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-000160a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160b0: 2020 2020 2920 2d3e 2044 6963 745b 5061      ) -> Dict[Pa
-000160c0: 6972 5769 7468 5469 6d65 6672 616d 652c  irWithTimeframe,
-000160d0: 2044 6174 6146 7261 6d65 5d3a 0a20 2020   DataFrame]:.   
-000160e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000160f0: 2052 6566 7265 7368 2069 6e2d 6d65 6d6f   Refresh in-memo
-00016100: 7279 204f 484c 4356 2061 7379 6e63 6872  ry OHLCV asynchr
-00016110: 6f6e 6f75 736c 7920 616e 6420 7365 7420  onously and set 
-00016120: 605f 6b6c 696e 6573 6020 7769 7468 2074  `_klines` with t
-00016130: 6865 2072 6573 756c 740a 2020 2020 2020  he result.      
-00016140: 2020 4c6f 6f70 7320 6173 796e 6368 726f    Loops asynchro
-00016150: 6e6f 7573 6c79 206f 7665 7220 7061 6972  nously over pair
-00016160: 5f6c 6973 7420 616e 6420 646f 776e 6c6f  _list and downlo
-00016170: 6164 7320 616c 6c20 7061 6972 7320 6173  ads all pairs as
-00016180: 796e 6320 2873 656d 692d 7061 7261 6c6c  ync (semi-parall
-00016190: 656c 292e 0a20 2020 2020 2020 204f 6e6c  el)..        Onl
-000161a0: 7920 7573 6564 2069 6e20 7468 6520 6461  y used in the da
-000161b0: 7461 7072 6f76 6964 6572 2e72 6566 7265  taprovider.refre
-000161c0: 7368 2829 206d 6574 686f 642e 0a20 2020  sh() method..   
-000161d0: 2020 2020 203a 7061 7261 6d20 7061 6972       :param pair
-000161e0: 5f6c 6973 743a 204c 6973 7420 6f66 2032  _list: List of 2
-000161f0: 2065 6c65 6d65 6e74 2074 7570 6c65 7320   element tuples 
-00016200: 636f 6e74 6169 6e69 6e67 2070 6169 722c  containing pair,
-00016210: 2069 6e74 6572 7661 6c20 746f 2072 6566   interval to ref
-00016220: 7265 7368 0a20 2020 2020 2020 203a 7061  resh.        :pa
-00016230: 7261 6d20 7369 6e63 655f 6d73 3a20 7469  ram since_ms: ti
-00016240: 6d65 2073 696e 6365 2077 6865 6e20 746f  me since when to
-00016250: 2064 6f77 6e6c 6f61 642c 2069 6e20 6d69   download, in mi
-00016260: 6c6c 6973 6563 6f6e 6473 0a20 2020 2020  lliseconds.     
-00016270: 2020 203a 7061 7261 6d20 6361 6368 653a     :param cache:
-00016280: 2041 7373 6967 6e20 7265 7375 6c74 2074   Assign result t
-00016290: 6f20 5f6b 6c69 6e65 732e 2055 7365 6675  o _klines. Usefu
-000162a0: 6c6c 2066 6f72 206f 6e65 2d6f 6666 2064  ll for one-off d
-000162b0: 6f77 6e6c 6f61 6473 206c 696b 6520 666f  ownloads like fo
-000162c0: 7220 7061 6972 6c69 7374 730a 2020 2020  r pairlists.    
-000162d0: 2020 2020 3a70 6172 616d 2064 726f 705f      :param drop_
-000162e0: 696e 636f 6d70 6c65 7465 3a20 436f 6e74  incomplete: Cont
-000162f0: 726f 6c20 6361 6e64 6c65 2064 726f 7070  rol candle dropp
-00016300: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
-00016310: 2053 7065 6369 6679 696e 6720 4e6f 6e65   Specifying None
-00016320: 2064 6566 6175 6c74 7320 746f 205f 6f68   defaults to _oh
-00016330: 6c63 765f 7061 7274 6961 6c5f 6361 6e64  lcv_partial_cand
-00016340: 6c65 0a20 2020 2020 2020 203a 7265 7475  le.        :retu
-00016350: 726e 3a20 4469 6374 206f 6620 5b7b 2870  rn: Dict of [{(p
-00016360: 6169 722c 2074 696d 6566 7261 6d65 293a  air, timeframe):
-00016370: 2044 6174 6166 7261 6d65 7d5d 0a20 2020   Dataframe}].   
-00016380: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00016390: 206c 6f67 6765 722e 6465 6275 6728 2252   logger.debug("R
-000163a0: 6566 7265 7368 696e 6720 6361 6e64 6c65  efreshing candle
-000163b0: 2028 4f48 4c43 5629 2064 6174 6120 666f   (OHLCV) data fo
-000163c0: 7220 2564 2070 6169 7273 222c 206c 656e  r %d pairs", len
-000163d0: 2870 6169 725f 6c69 7374 2929 0a0a 2020  (pair_list))..  
-000163e0: 2020 2020 2020 2320 4761 7468 6572 2063        # Gather c
-000163f0: 6f72 6f75 7469 6e65 7320 746f 2072 756e  oroutines to run
-00016400: 0a20 2020 2020 2020 2069 6e70 7574 5f63  .        input_c
-00016410: 6f72 6f75 7469 6e65 732c 2063 6163 6865  oroutines, cache
-00016420: 645f 7061 6972 7320 3d20 7365 6c66 2e5f  d_pairs = self._
-00016430: 6275 696c 645f 6f68 6c63 765f 646c 5f6a  build_ohlcv_dl_j
-00016440: 6f62 7328 7061 6972 5f6c 6973 742c 2073  obs(pair_list, s
-00016450: 696e 6365 5f6d 732c 2063 6163 6865 290a  ince_ms, cache).
-00016460: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
-00016470: 5f64 6620 3d20 7b7d 0a20 2020 2020 2020  _df = {}.       
-00016480: 2023 2043 6875 6e6b 2072 6571 7565 7374   # Chunk request
-00016490: 7320 696e 746f 2062 6174 6368 6573 206f  s into batches o
-000164a0: 6620 3130 3020 746f 2061 766f 6964 206f  f 100 to avoid o
-000164b0: 7665 7277 656c 6d69 6e67 2063 6378 7420  verwelming ccxt 
-000164c0: 5468 726f 7474 6c69 6e67 0a20 2020 2020  Throttling.     
-000164d0: 2020 2066 6f72 2069 6e70 7574 5f63 6f72     for input_cor
-000164e0: 6f20 696e 2063 6875 6e6b 7328 696e 7075  o in chunks(inpu
-000164f0: 745f 636f 726f 7574 696e 6573 2c20 3130  t_coroutines, 10
-00016500: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
-00016510: 6173 796e 6320 6465 6620 6761 7468 6572  async def gather
-00016520: 5f73 7475 6666 2829 3a0a 2020 2020 2020  _stuff():.      
-00016530: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00016540: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
-00016550: 6174 6865 7228 2a69 6e70 7574 5f63 6f72  ather(*input_cor
-00016560: 6f2c 2072 6574 7572 6e5f 6578 6365 7074  o, return_except
-00016570: 696f 6e73 3d54 7275 6529 0a0a 2020 2020  ions=True)..    
-00016580: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00016590: 662e 5f6c 6f6f 705f 6c6f 636b 3a0a 2020  f._loop_lock:.  
-000165a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000165b0: 7375 6c74 7320 3d20 7365 6c66 2e6c 6f6f  sults = self.loo
-000165c0: 702e 7275 6e5f 756e 7469 6c5f 636f 6d70  p.run_until_comp
-000165d0: 6c65 7465 2867 6174 6865 725f 7374 7566  lete(gather_stuf
-000165e0: 6628 2929 0a0a 2020 2020 2020 2020 2020  f())..          
-000165f0: 2020 666f 7220 7265 7320 696e 2072 6573    for res in res
-00016600: 756c 7473 3a0a 2020 2020 2020 2020 2020  ults:.          
-00016610: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00016620: 6e63 6528 7265 732c 2045 7863 6570 7469  nce(res, Excepti
-00016630: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
-00016640: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00016650: 7761 726e 696e 6728 6622 4173 796e 6320  warning(f"Async 
-00016660: 636f 6465 2072 6169 7365 6420 616e 2065  code raised an e
-00016670: 7863 6570 7469 6f6e 3a20 7b72 6570 7228  xception: {repr(
-00016680: 7265 7329 7d22 290a 2020 2020 2020 2020  res)}").        
-00016690: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-000166a0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-000166b0: 2020 2020 2023 2044 6563 6f6e 7374 7275       # Deconstru
-000166c0: 6374 2074 7570 6c65 2028 6861 7320 3520  ct tuple (has 5 
-000166d0: 656c 656d 656e 7473 290a 2020 2020 2020  elements).      
-000166e0: 2020 2020 2020 2020 2020 7061 6972 2c20            pair, 
-000166f0: 7469 6d65 6672 616d 652c 2063 5f74 7970  timeframe, c_typ
-00016700: 652c 2074 6963 6b73 2c20 6472 6f70 5f68  e, ticks, drop_h
-00016710: 696e 7420 3d20 7265 730a 2020 2020 2020  int = res.      
-00016720: 2020 2020 2020 2020 2020 6472 6f70 5f69            drop_i
-00016730: 6e63 6f6d 706c 6574 655f 203d 2064 726f  ncomplete_ = dro
-00016740: 705f 6869 6e74 2069 6620 6472 6f70 5f69  p_hint if drop_i
-00016750: 6e63 6f6d 706c 6574 6520 6973 204e 6f6e  ncomplete is Non
-00016760: 6520 656c 7365 2064 726f 705f 696e 636f  e else drop_inco
-00016770: 6d70 6c65 7465 0a20 2020 2020 2020 2020  mplete.         
-00016780: 2020 2020 2020 206f 686c 6376 5f64 6620         ohlcv_df 
-00016790: 3d20 7365 6c66 2e5f 7072 6f63 6573 735f  = self._process_
-000167a0: 6f68 6c63 765f 6466 280a 2020 2020 2020  ohlcv_df(.      
-000167b0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-000167c0: 6972 2c20 7469 6d65 6672 616d 652c 2063  ir, timeframe, c
-000167d0: 5f74 7970 652c 2074 6963 6b73 2c20 6361  _type, ticks, ca
-000167e0: 6368 652c 2064 726f 705f 696e 636f 6d70  che, drop_incomp
-000167f0: 6c65 7465 5f29 0a0a 2020 2020 2020 2020  lete_)..        
-00016800: 2020 2020 2020 2020 7265 7375 6c74 735f          results_
-00016810: 6466 5b28 7061 6972 2c20 7469 6d65 6672  df[(pair, timefr
-00016820: 616d 652c 2063 5f74 7970 6529 5d20 3d20  ame, c_type)] = 
-00016830: 6f68 6c63 765f 6466 0a0a 2020 2020 2020  ohlcv_df..      
-00016840: 2020 2320 5265 7475 726e 2063 6163 6865    # Return cache
-00016850: 6420 6b6c 696e 6573 0a20 2020 2020 2020  d klines.       
-00016860: 2066 6f72 2070 6169 722c 2074 696d 6566   for pair, timef
-00016870: 7261 6d65 2c20 635f 7479 7065 2069 6e20  rame, c_type in 
-00016880: 6361 6368 6564 5f70 6169 7273 3a0a 2020  cached_pairs:.  
-00016890: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-000168a0: 735f 6466 5b28 7061 6972 2c20 7469 6d65  s_df[(pair, time
-000168b0: 6672 616d 652c 2063 5f74 7970 6529 5d20  frame, c_type)] 
-000168c0: 3d20 7365 6c66 2e6b 6c69 6e65 7328 0a20  = self.klines(. 
-000168d0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000168e0: 7061 6972 2c20 7469 6d65 6672 616d 652c  pair, timeframe,
-000168f0: 2063 5f74 7970 6529 2c0a 2020 2020 2020   c_type),.      
-00016900: 2020 2020 2020 2020 2020 636f 7079 3d46            copy=F
-00016910: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-00016920: 2029 0a0a 2020 2020 2020 2020 7265 7475   )..        retu
-00016930: 726e 2072 6573 756c 7473 5f64 660a 0a20  rn results_df.. 
-00016940: 2020 2064 6566 205f 6e6f 775f 6973 5f74     def _now_is_t
-00016950: 696d 655f 746f 5f72 6566 7265 7368 2873  ime_to_refresh(s
-00016960: 656c 662c 2070 6169 723a 2073 7472 2c20  elf, pair: str, 
-00016970: 7469 6d65 6672 616d 653a 2073 7472 2c20  timeframe: str, 
-00016980: 6361 6e64 6c65 5f74 7970 653a 2043 616e  candle_type: Can
-00016990: 646c 6554 7970 6529 202d 3e20 626f 6f6c  dleType) -> bool
-000169a0: 3a0a 2020 2020 2020 2020 2320 5469 6d65  :.        # Time
-000169b0: 6672 616d 6520 696e 2073 6563 6f6e 6473  frame in seconds
-000169c0: 0a20 2020 2020 2020 2069 6e74 6572 7661  .        interva
-000169d0: 6c5f 696e 5f73 6563 203d 2074 696d 6566  l_in_sec = timef
-000169e0: 7261 6d65 5f74 6f5f 7365 636f 6e64 7328  rame_to_seconds(
-000169f0: 7469 6d65 6672 616d 6529 0a20 2020 2020  timeframe).     
-00016a00: 2020 2070 6c72 203d 2073 656c 662e 5f70     plr = self._p
-00016a10: 6169 7273 5f6c 6173 745f 7265 6672 6573  airs_last_refres
-00016a20: 685f 7469 6d65 2e67 6574 2828 7061 6972  h_time.get((pair
-00016a30: 2c20 7469 6d65 6672 616d 652c 2063 616e  , timeframe, can
-00016a40: 646c 655f 7479 7065 292c 2030 2920 2b20  dle_type), 0) + 
-00016a50: 696e 7465 7276 616c 5f69 6e5f 7365 630a  interval_in_sec.
-00016a60: 2020 2020 2020 2020 2320 6375 7272 656e          # curren
-00016a70: 742c 6163 7469 7665 2063 616e 646c 6520  t,active candle 
-00016a80: 6f70 656e 2064 6174 650a 2020 2020 2020  open date.      
-00016a90: 2020 6e6f 7720 3d20 696e 7428 7469 6d65    now = int(time
-00016aa0: 6672 616d 655f 746f 5f70 7265 765f 6461  frame_to_prev_da
-00016ab0: 7465 2874 696d 6566 7261 6d65 292e 7469  te(timeframe).ti
-00016ac0: 6d65 7374 616d 7028 2929 0a20 2020 2020  mestamp()).     
-00016ad0: 2020 2072 6574 7572 6e20 706c 7220 3c20     return plr < 
-00016ae0: 6e6f 770a 0a20 2020 2040 7265 7472 6965  now..    @retrie
-00016af0: 725f 6173 796e 630a 2020 2020 6173 796e  r_async.    asyn
-00016b00: 6320 6465 6620 5f61 7379 6e63 5f67 6574  c def _async_get
-00016b10: 5f63 616e 646c 655f 6869 7374 6f72 7928  _candle_history(
-00016b20: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00016b30: 2020 2020 2020 2070 6169 723a 2073 7472         pair: str
-00016b40: 2c0a 2020 2020 2020 2020 7469 6d65 6672  ,.        timefr
-00016b50: 616d 653a 2073 7472 2c0a 2020 2020 2020  ame: str,.      
-00016b60: 2020 6361 6e64 6c65 5f74 7970 653a 2043    candle_type: C
-00016b70: 616e 646c 6554 7970 652c 0a20 2020 2020  andleType,.     
-00016b80: 2020 2073 696e 6365 5f6d 733a 204f 7074     since_ms: Opt
-00016b90: 696f 6e61 6c5b 696e 745d 203d 204e 6f6e  ional[int] = Non
-00016ba0: 652c 0a20 2020 2029 202d 3e20 4f48 4c43  e,.    ) -> OHLC
-00016bb0: 5652 6573 706f 6e73 653a 0a20 2020 2020  VResponse:.     
-00016bc0: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
-00016bd0: 7379 6e63 6872 6f6e 6f75 736c 7920 6765  synchronously ge
-00016be0: 7420 6361 6e64 6c65 2068 6973 746f 7279  t candle history
-00016bf0: 2064 6174 6120 7573 696e 6720 6665 7463   data using fetc
-00016c00: 685f 6f68 6c63 760a 2020 2020 2020 2020  h_ohlcv.        
-00016c10: 3a70 6172 616d 2063 616e 646c 655f 7479  :param candle_ty
-00016c20: 7065 3a20 2727 2c20 6d61 726b 2c20 696e  pe: '', mark, in
-00016c30: 6465 782c 2070 7265 6d69 756d 496e 6465  dex, premiumInde
-00016c40: 782c 206f 7220 6675 6e64 696e 675f 7261  x, or funding_ra
-00016c50: 7465 0a20 2020 2020 2020 2072 6574 7572  te.        retur
-00016c60: 6e73 2074 7570 6c65 3a20 2870 6169 722c  ns tuple: (pair,
-00016c70: 2074 696d 6566 7261 6d65 2c20 6f68 6c63   timeframe, ohlc
-00016c80: 765f 6c69 7374 290a 2020 2020 2020 2020  v_list).        
-00016c90: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-00016ca0: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-00016cb0: 6574 6368 204f 484c 4356 2061 7379 6e63  etch OHLCV async
-00016cc0: 6872 6f6e 6f75 736c 790a 2020 2020 2020  hronously.      
-00016cd0: 2020 2020 2020 7320 3d20 2728 2720 2b20        s = '(' + 
-00016ce0: 6172 726f 772e 6765 7428 7369 6e63 655f  arrow.get(since_
-00016cf0: 6d73 202f 2f20 3130 3030 292e 6973 6f66  ms // 1000).isof
-00016d00: 6f72 6d61 7428 2920 2b20 2729 2027 2069  ormat() + ') ' i
-00016d10: 6620 7369 6e63 655f 6d73 2069 7320 6e6f  f since_ms is no
-00016d20: 7420 4e6f 6e65 2065 6c73 6520 2727 0a20  t None else ''. 
-00016d30: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00016d40: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
-00016d50: 2020 2020 2020 2020 2022 4665 7463 6869           "Fetchi
-00016d60: 6e67 2070 6169 7220 2573 2c20 2573 2c20  ng pair %s, %s, 
-00016d70: 696e 7465 7276 616c 2025 732c 2073 696e  interval %s, sin
-00016d80: 6365 2025 7320 2573 2e2e 2e22 2c0a 2020  ce %s %s...",.  
-00016d90: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00016da0: 6972 2c20 6361 6e64 6c65 5f74 7970 652c  ir, candle_type,
-00016db0: 2074 696d 6566 7261 6d65 2c20 7369 6e63   timeframe, sinc
-00016dc0: 655f 6d73 2c20 730a 2020 2020 2020 2020  e_ms, s.        
-00016dd0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00016de0: 2020 7061 7261 6d73 203d 2064 6565 7063    params = deepc
-00016df0: 6f70 7928 7365 6c66 2e5f 6674 5f68 6173  opy(self._ft_has
-00016e00: 2e67 6574 2827 6f68 6c63 765f 7061 7261  .get('ohlcv_para
-00016e10: 6d73 272c 207b 7d29 290a 2020 2020 2020  ms', {})).      
-00016e20: 2020 2020 2020 6361 6e64 6c65 5f6c 696d        candle_lim
-00016e30: 6974 203d 2073 656c 662e 6f68 6c63 765f  it = self.ohlcv_
-00016e40: 6361 6e64 6c65 5f6c 696d 6974 280a 2020  candle_limit(.  
-00016e50: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-00016e60: 6d65 6672 616d 652c 2063 616e 646c 655f  meframe, candle_
-00016e70: 7479 7065 3d63 616e 646c 655f 7479 7065  type=candle_type
-00016e80: 2c20 7369 6e63 655f 6d73 3d73 696e 6365  , since_ms=since
-00016e90: 5f6d 7329 0a0a 2020 2020 2020 2020 2020  _ms)..          
-00016ea0: 2020 6966 2063 616e 646c 655f 7479 7065    if candle_type
-00016eb0: 2061 6e64 2063 616e 646c 655f 7479 7065   and candle_type
-00016ec0: 2021 3d20 4361 6e64 6c65 5479 7065 2e53   != CandleType.S
-00016ed0: 504f 543a 0a20 2020 2020 2020 2020 2020  POT:.           
-00016ee0: 2020 2020 2070 6172 616d 732e 7570 6461       params.upda
-00016ef0: 7465 287b 2770 7269 6365 273a 2063 616e  te({'price': can
-00016f00: 646c 655f 7479 7065 2e76 616c 7565 7d29  dle_type.value})
-00016f10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00016f20: 6361 6e64 6c65 5f74 7970 6520 213d 2043  candle_type != C
-00016f30: 616e 646c 6554 7970 652e 4655 4e44 494e  andleType.FUNDIN
-00016f40: 475f 5241 5445 3a0a 2020 2020 2020 2020  G_RATE:.        
-00016f50: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
-00016f60: 7761 6974 2073 656c 662e 5f61 7069 5f61  wait self._api_a
-00016f70: 7379 6e63 2e66 6574 6368 5f6f 686c 6376  sync.fetch_ohlcv
-00016f80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00016f90: 2020 2020 2020 7061 6972 2c20 7469 6d65        pair, time
-00016fa0: 6672 616d 653d 7469 6d65 6672 616d 652c  frame=timeframe,
-00016fb0: 2073 696e 6365 3d73 696e 6365 5f6d 732c   since=since_ms,
-00016fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016fd0: 2020 2020 206c 696d 6974 3d63 616e 646c       limit=candl
-00016fe0: 655f 6c69 6d69 742c 2070 6172 616d 733d  e_limit, params=
-00016ff0: 7061 7261 6d73 290a 2020 2020 2020 2020  params).        
-00017000: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00017010: 2020 2020 2020 2020 2020 2320 4675 6e64            # Fund
-00017020: 696e 6720 7261 7465 0a20 2020 2020 2020  ing rate.       
-00017030: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
-00017040: 6177 6169 7420 7365 6c66 2e5f 6665 7463  await self._fetc
-00017050: 685f 6675 6e64 696e 675f 7261 7465 5f68  h_funding_rate_h
-00017060: 6973 746f 7279 280a 2020 2020 2020 2020  istory(.        
-00017070: 2020 2020 2020 2020 2020 2020 7061 6972              pair
-00017080: 3d70 6169 722c 0a20 2020 2020 2020 2020  =pair,.         
-00017090: 2020 2020 2020 2020 2020 2074 696d 6566             timef
-000170a0: 7261 6d65 3d74 696d 6566 7261 6d65 2c0a  rame=timeframe,.
-000170b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170c0: 2020 2020 6c69 6d69 743d 6361 6e64 6c65      limit=candle
-000170d0: 5f6c 696d 6974 2c0a 2020 2020 2020 2020  _limit,.        
-000170e0: 2020 2020 2020 2020 2020 2020 7369 6e63              sinc
-000170f0: 655f 6d73 3d73 696e 6365 5f6d 732c 0a20  e_ms=since_ms,. 
-00017100: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00017110: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-00017120: 6f6d 6520 6578 6368 616e 6765 7320 736f  ome exchanges so
-00017130: 7274 204f 484c 4356 2069 6e20 4153 4320  rt OHLCV in ASC 
-00017140: 6f72 6465 7220 616e 6420 6f74 6865 7273  order and others
-00017150: 2069 6e20 4445 5343 2e0a 2020 2020 2020   in DESC..      
-00017160: 2020 2020 2020 2320 4578 3a20 4269 7474        # Ex: Bitt
-00017170: 7265 7820 7265 7475 726e 7320 7468 6520  rex returns the 
-00017180: 6c69 7374 206f 6620 4f48 4c43 5620 696e  list of OHLCV in
-00017190: 2041 5343 206f 7264 6572 2028 6f6c 6465   ASC order (olde
-000171a0: 7374 2066 6972 7374 2c20 6e65 7765 7374  st first, newest
-000171b0: 206c 6173 7429 0a20 2020 2020 2020 2020   last).         
-000171c0: 2020 2023 2077 6869 6c65 2047 4441 5820     # while GDAX 
-000171d0: 7265 7475 726e 7320 7468 6520 6c69 7374  returns the list
-000171e0: 206f 6620 4f48 4c43 5620 696e 2044 4553   of OHLCV in DES
-000171f0: 4320 6f72 6465 7220 286e 6577 6573 7420  C order (newest 
-00017200: 6669 7273 742c 206f 6c64 6573 7420 6c61  first, oldest la
-00017210: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-00017220: 2320 4f6e 6c79 2073 6f72 7420 6966 206e  # Only sort if n
-00017230: 6563 6573 7361 7279 2074 6f20 7361 7665  ecessary to save
-00017240: 2063 6f6d 7075 7469 6e67 2074 696d 650a   computing time.
-00017250: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00017260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017270: 2069 6620 6461 7461 2061 6e64 2064 6174   if data and dat
-00017280: 615b 305d 5b30 5d20 3e20 6461 7461 5b2d  a[0][0] > data[-
-00017290: 315d 5b30 5d3a 0a20 2020 2020 2020 2020  1][0]:.         
-000172a0: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-000172b0: 3d20 736f 7274 6564 2864 6174 612c 206b  = sorted(data, k
-000172c0: 6579 3d6c 616d 6264 6120 783a 2078 5b30  ey=lambda x: x[0
-000172d0: 5d29 0a20 2020 2020 2020 2020 2020 2065  ]).            e
-000172e0: 7863 6570 7420 496e 6465 7845 7272 6f72  xcept IndexError
-000172f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017300: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
-00017310: 6f6e 2822 4572 726f 7220 6c6f 6164 696e  on("Error loadin
-00017320: 6720 2573 2e20 5265 7375 6c74 2077 6173  g %s. Result was
-00017330: 2025 732e 222c 2070 6169 722c 2064 6174   %s.", pair, dat
-00017340: 6129 0a20 2020 2020 2020 2020 2020 2020  a).             
-00017350: 2020 2072 6574 7572 6e20 7061 6972 2c20     return pair, 
-00017360: 7469 6d65 6672 616d 652c 2063 616e 646c  timeframe, candl
-00017370: 655f 7479 7065 2c20 5b5d 2c20 7365 6c66  e_type, [], self
-00017380: 2e5f 6f68 6c63 765f 7061 7274 6961 6c5f  ._ohlcv_partial_
-00017390: 6361 6e64 6c65 0a20 2020 2020 2020 2020  candle.         
-000173a0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-000173b0: 2244 6f6e 6520 6665 7463 6869 6e67 2070  "Done fetching p
-000173c0: 6169 7220 2573 2c20 696e 7465 7276 616c  air %s, interval
-000173d0: 2025 7320 2e2e 2e22 2c20 7061 6972 2c20   %s ...", pair, 
-000173e0: 7469 6d65 6672 616d 6529 0a20 2020 2020  timeframe).     
-000173f0: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
-00017400: 6972 2c20 7469 6d65 6672 616d 652c 2063  ir, timeframe, c
-00017410: 616e 646c 655f 7479 7065 2c20 6461 7461  andle_type, data
-00017420: 2c20 7365 6c66 2e5f 6f68 6c63 765f 7061  , self._ohlcv_pa
-00017430: 7274 6961 6c5f 6361 6e64 6c65 0a0a 2020  rtial_candle..  
-00017440: 2020 2020 2020 6578 6365 7074 2063 6378        except ccx
-00017450: 742e 4e6f 7453 7570 706f 7274 6564 2061  t.NotSupported a
-00017460: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00017470: 2072 6169 7365 204f 7065 7261 7469 6f6e   raise Operation
-00017480: 616c 4578 6365 7074 696f 6e28 0a20 2020  alException(.   
-00017490: 2020 2020 2020 2020 2020 2020 2066 2745               f'E
-000174a0: 7863 6861 6e67 6520 7b73 656c 662e 5f61  xchange {self._a
-000174b0: 7069 2e6e 616d 657d 2064 6f65 7320 6e6f  pi.name} does no
-000174c0: 7420 7375 7070 6f72 7420 6665 7463 6869  t support fetchi
-000174d0: 6e67 2068 6973 746f 7269 6361 6c20 270a  ng historical '.
-000174e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000174f0: 6627 6361 6e64 6c65 2028 4f48 4c43 5629  f'candle (OHLCV)
-00017500: 2064 6174 612e 204d 6573 7361 6765 3a20   data. Message: 
-00017510: 7b65 7d27 2920 6672 6f6d 2065 0a20 2020  {e}') from e.   
-00017520: 2020 2020 2065 7863 6570 7420 6363 7874       except ccxt
-00017530: 2e44 446f 5350 726f 7465 6374 696f 6e20  .DDoSProtection 
-00017540: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00017550: 2020 7261 6973 6520 4444 6f73 5072 6f74    raise DDosProt
-00017560: 6563 7469 6f6e 2865 2920 6672 6f6d 2065  ection(e) from e
-00017570: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00017580: 2863 6378 742e 4e65 7477 6f72 6b45 7272  (ccxt.NetworkErr
-00017590: 6f72 2c20 6363 7874 2e45 7863 6861 6e67  or, ccxt.Exchang
-000175a0: 6545 7272 6f72 2920 6173 2065 3a0a 2020  eError) as e:.  
-000175b0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000175c0: 5465 6d70 6f72 6172 7945 7272 6f72 2866  TemporaryError(f
-000175d0: 2743 6f75 6c64 206e 6f74 2066 6574 6368  'Could not fetch
-000175e0: 2068 6973 746f 7269 6361 6c20 6361 6e64   historical cand
-000175f0: 6c65 2028 4f48 4c43 5629 2064 6174 6120  le (OHLCV) data 
-00017600: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00017610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017620: 2020 2066 2766 6f72 2070 6169 7220 7b70     f'for pair {p
-00017630: 6169 727d 2064 7565 2074 6f20 7b65 2e5f  air} due to {e._
-00017640: 5f63 6c61 7373 5f5f 2e5f 5f6e 616d 655f  _class__.__name_
-00017650: 5f7d 2e20 270a 2020 2020 2020 2020 2020  _}. '.          
-00017660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017670: 2020 2020 2020 2066 274d 6573 7361 6765         f'Message
-00017680: 3a20 7b65 7d27 2920 6672 6f6d 2065 0a20  : {e}') from e. 
-00017690: 2020 2020 2020 2065 7863 6570 7420 6363         except cc
-000176a0: 7874 2e42 6173 6545 7272 6f72 2061 7320  xt.BaseError as 
-000176b0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-000176c0: 6169 7365 204f 7065 7261 7469 6f6e 616c  aise Operational
-000176d0: 4578 6365 7074 696f 6e28 6627 436f 756c  Exception(f'Coul
-000176e0: 6420 6e6f 7420 6665 7463 6820 6869 7374  d not fetch hist
-000176f0: 6f72 6963 616c 2063 616e 646c 6520 284f  orical candle (O
-00017700: 484c 4356 2920 6461 7461 2027 0a20 2020  HLCV) data '.   
-00017710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017730: 2020 2020 6627 666f 7220 7061 6972 207b      f'for pair {
-00017740: 7061 6972 7d2e 204d 6573 7361 6765 3a20  pair}. Message: 
-00017750: 7b65 7d27 2920 6672 6f6d 2065 0a0a 2020  {e}') from e..  
-00017760: 2020 6173 796e 6320 6465 6620 5f66 6574    async def _fet
-00017770: 6368 5f66 756e 6469 6e67 5f72 6174 655f  ch_funding_rate_
-00017780: 6869 7374 6f72 7928 0a20 2020 2020 2020  history(.       
-00017790: 2073 656c 662c 0a20 2020 2020 2020 2070   self,.        p
-000177a0: 6169 723a 2073 7472 2c0a 2020 2020 2020  air: str,.      
-000177b0: 2020 7469 6d65 6672 616d 653a 2073 7472    timeframe: str
-000177c0: 2c0a 2020 2020 2020 2020 6c69 6d69 743a  ,.        limit:
-000177d0: 2069 6e74 2c0a 2020 2020 2020 2020 7369   int,.        si
-000177e0: 6e63 655f 6d73 3a20 4f70 7469 6f6e 616c  nce_ms: Optional
-000177f0: 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a 2020  [int] = None,.  
-00017800: 2020 2920 2d3e 204c 6973 745b 4c69 7374    ) -> List[List
-00017810: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00017820: 2020 2020 2020 2046 6574 6368 2066 756e         Fetch fun
-00017830: 6469 6e67 2072 6174 6520 6869 7374 6f72  ding rate histor
-00017840: 7920 2d20 7573 6564 2074 6f20 7365 6c65  y - used to sele
-00017850: 6374 6976 656c 7920 6f76 6572 7269 6465  ctively override
-00017860: 2074 6869 7320 6279 2073 7562 636c 6173   this by subclas
-00017870: 7365 732e 0a20 2020 2020 2020 2022 2222  ses..        """
-00017880: 0a20 2020 2020 2020 2023 2046 756e 6469  .        # Fundi
-00017890: 6e67 2072 6174 650a 2020 2020 2020 2020  ng rate.        
-000178a0: 6461 7461 203d 2061 7761 6974 2073 656c  data = await sel
-000178b0: 662e 5f61 7069 5f61 7379 6e63 2e66 6574  f._api_async.fet
-000178c0: 6368 5f66 756e 6469 6e67 5f72 6174 655f  ch_funding_rate_
-000178d0: 6869 7374 6f72 7928 0a20 2020 2020 2020  history(.       
-000178e0: 2020 2020 2070 6169 722c 2073 696e 6365       pair, since
-000178f0: 3d73 696e 6365 5f6d 732c 0a20 2020 2020  =since_ms,.     
-00017900: 2020 2020 2020 206c 696d 6974 3d6c 696d         limit=lim
-00017910: 6974 290a 2020 2020 2020 2020 2320 436f  it).        # Co
-00017920: 6e76 6572 7420 6675 6e64 696e 6720 7261  nvert funding ra
-00017930: 7465 2074 6f20 6361 6e64 6c65 2070 6174  te to candle pat
-00017940: 7465 726e 0a20 2020 2020 2020 2064 6174  tern.        dat
-00017950: 6120 3d20 5b5b 785b 2774 696d 6573 7461  a = [[x['timesta
-00017960: 6d70 275d 2c20 785b 2766 756e 6469 6e67  mp'], x['funding
-00017970: 5261 7465 275d 2c20 302c 2030 2c20 302c  Rate'], 0, 0, 0,
-00017980: 2030 5d20 666f 7220 7820 696e 2064 6174   0] for x in dat
-00017990: 615d 0a20 2020 2020 2020 2072 6574 7572  a].        retur
-000179a0: 6e20 6461 7461 0a0a 2020 2020 2320 4665  n data..    # Fe
-000179b0: 7463 6820 6869 7374 6f72 6963 2074 7261  tch historic tra
-000179c0: 6465 730a 0a20 2020 2040 7265 7472 6965  des..    @retrie
-000179d0: 725f 6173 796e 630a 2020 2020 6173 796e  r_async.    asyn
-000179e0: 6320 6465 6620 5f61 7379 6e63 5f66 6574  c def _async_fet
-000179f0: 6368 5f74 7261 6465 7328 7365 6c66 2c20  ch_trades(self, 
-00017a00: 7061 6972 3a20 7374 722c 0a20 2020 2020  pair: str,.     
-00017a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a20: 2020 2020 2020 2020 2020 2020 2073 696e               sin
-00017a30: 6365 3a20 4f70 7469 6f6e 616c 5b69 6e74  ce: Optional[int
-00017a40: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-00017a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a60: 2020 2020 2020 2020 2020 2020 7061 7261              para
-00017a70: 6d73 3a20 4f70 7469 6f6e 616c 5b64 6963  ms: Optional[dic
-00017a80: 745d 203d 204e 6f6e 6529 202d 3e20 4c69  t] = None) -> Li
-00017a90: 7374 5b4c 6973 745d 3a0a 2020 2020 2020  st[List]:.      
-00017aa0: 2020 2222 220a 2020 2020 2020 2020 4173    """.        As
-00017ab0: 796e 6372 6f6e 6f75 736c 7920 6765 7473  yncronously gets
-00017ac0: 2074 7261 6465 2068 6973 746f 7279 2075   trade history u
-00017ad0: 7369 6e67 2066 6574 6368 5f74 7261 6465  sing fetch_trade
-00017ae0: 732e 0a20 2020 2020 2020 2048 616e 646c  s..        Handl
-00017af0: 6573 2065 7863 6861 6e67 6520 6572 726f  es exchange erro
-00017b00: 7273 2c20 646f 6573 206f 6e65 2063 616c  rs, does one cal
-00017b10: 6c20 746f 2074 6865 2065 7863 6861 6e67  l to the exchang
-00017b20: 652e 0a20 2020 2020 2020 203a 7061 7261  e..        :para
-00017b30: 6d20 7061 6972 3a20 5061 6972 2074 6f20  m pair: Pair to 
-00017b40: 6665 7463 6820 7472 6164 6520 6461 7461  fetch trade data
-00017b50: 2066 6f72 0a20 2020 2020 2020 203a 7061   for.        :pa
-00017b60: 7261 6d20 7369 6e63 653a 2053 696e 6365  ram since: Since
-00017b70: 2061 7320 696e 7465 6765 7220 7469 6d65   as integer time
-00017b80: 7374 616d 7020 696e 206d 696c 6c69 7365  stamp in millise
-00017b90: 636f 6e64 730a 2020 2020 2020 2020 7265  conds.        re
-00017ba0: 7475 726e 733a 204c 6973 7420 6f66 2064  turns: List of d
-00017bb0: 6963 7473 2063 6f6e 7461 696e 696e 6720  icts containing 
-00017bc0: 7472 6164 6573 0a20 2020 2020 2020 2022  trades.        "
-00017bd0: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
-00017be0: 2020 2020 2020 2020 2020 2020 2320 6665              # fe
-00017bf0: 7463 6820 7472 6164 6573 2061 7379 6e63  tch trades async
-00017c00: 6872 6f6e 6f75 736c 790a 2020 2020 2020  hronously.      
-00017c10: 2020 2020 2020 6966 2070 6172 616d 733a        if params:
-00017c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017c30: 206c 6f67 6765 722e 6465 6275 6728 2246   logger.debug("F
-00017c40: 6574 6368 696e 6720 7472 6164 6573 2066  etching trades f
-00017c50: 6f72 2070 6169 7220 2573 2c20 7061 7261  or pair %s, para
-00017c60: 6d73 3a20 2573 2022 2c20 7061 6972 2c20  ms: %s ", pair, 
-00017c70: 7061 7261 6d73 290a 2020 2020 2020 2020  params).        
-00017c80: 2020 2020 2020 2020 7472 6164 6573 203d          trades =
-00017c90: 2061 7761 6974 2073 656c 662e 5f61 7069   await self._api
-00017ca0: 5f61 7379 6e63 2e66 6574 6368 5f74 7261  _async.fetch_tra
-00017cb0: 6465 7328 7061 6972 2c20 7061 7261 6d73  des(pair, params
-00017cc0: 3d70 6172 616d 732c 206c 696d 6974 3d31  =params, limit=1
-00017cd0: 3030 3029 0a20 2020 2020 2020 2020 2020  000).           
-00017ce0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00017cf0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-00017d00: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00017d10: 2020 2020 2020 2020 2022 4665 7463 6869           "Fetchi
-00017d20: 6e67 2074 7261 6465 7320 666f 7220 7061  ng trades for pa
-00017d30: 6972 2025 732c 2073 696e 6365 2025 7320  ir %s, since %s 
-00017d40: 2573 2e2e 2e22 2c0a 2020 2020 2020 2020  %s...",.        
-00017d50: 2020 2020 2020 2020 2020 2020 7061 6972              pair
-00017d60: 2c20 7369 6e63 652c 0a20 2020 2020 2020  , since,.       
-00017d70: 2020 2020 2020 2020 2020 2020 2027 2827               '('
-00017d80: 202b 2061 7272 6f77 2e67 6574 2873 696e   + arrow.get(sin
-00017d90: 6365 202f 2f20 3130 3030 292e 6973 6f66  ce // 1000).isof
-00017da0: 6f72 6d61 7428 2920 2b20 2729 2027 2069  ormat() + ') ' i
-00017db0: 6620 7369 6e63 6520 6973 206e 6f74 204e  f since is not N
-00017dc0: 6f6e 6520 656c 7365 2027 270a 2020 2020  one else ''.    
-00017dd0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00017de0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00017df0: 6164 6573 203d 2061 7761 6974 2073 656c  ades = await sel
-00017e00: 662e 5f61 7069 5f61 7379 6e63 2e66 6574  f._api_async.fet
-00017e10: 6368 5f74 7261 6465 7328 7061 6972 2c20  ch_trades(pair, 
-00017e20: 7369 6e63 653d 7369 6e63 652c 206c 696d  since=since, lim
-00017e30: 6974 3d31 3030 3029 0a20 2020 2020 2020  it=1000).       
-00017e40: 2020 2020 2074 7261 6465 7320 3d20 7365       trades = se
-00017e50: 6c66 2e5f 7472 6164 6573 5f63 6f6e 7472  lf._trades_contr
-00017e60: 6163 7473 5f74 6f5f 616d 6f75 6e74 2874  acts_to_amount(t
-00017e70: 7261 6465 7329 0a20 2020 2020 2020 2020  rades).         
-00017e80: 2020 2072 6574 7572 6e20 7472 6164 6573     return trades
-00017e90: 5f64 6963 745f 746f 5f6c 6973 7428 7472  _dict_to_list(tr
-00017ea0: 6164 6573 290a 2020 2020 2020 2020 6578  ades).        ex
-00017eb0: 6365 7074 2063 6378 742e 4e6f 7453 7570  cept ccxt.NotSup
-00017ec0: 706f 7274 6564 2061 7320 653a 0a20 2020  ported as e:.   
-00017ed0: 2020 2020 2020 2020 2072 6169 7365 204f           raise O
-00017ee0: 7065 7261 7469 6f6e 616c 4578 6365 7074  perationalExcept
-00017ef0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-00017f00: 2020 2020 2066 2745 7863 6861 6e67 6520       f'Exchange 
-00017f10: 7b73 656c 662e 5f61 7069 2e6e 616d 657d  {self._api.name}
-00017f20: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00017f30: 7420 6665 7463 6869 6e67 2068 6973 746f  t fetching histo
-00017f40: 7269 6361 6c20 7472 6164 6520 6461 7461  rical trade data
-00017f50: 2e27 0a20 2020 2020 2020 2020 2020 2020  .'.             
-00017f60: 2020 2066 274d 6573 7361 6765 3a20 7b65     f'Message: {e
-00017f70: 7d27 2920 6672 6f6d 2065 0a20 2020 2020  }') from e.     
-00017f80: 2020 2065 7863 6570 7420 6363 7874 2e44     except ccxt.D
-00017f90: 446f 5350 726f 7465 6374 696f 6e20 6173  DoSProtection as
-00017fa0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00017fb0: 7261 6973 6520 4444 6f73 5072 6f74 6563  raise DDosProtec
-00017fc0: 7469 6f6e 2865 2920 6672 6f6d 2065 0a20  tion(e) from e. 
-00017fd0: 2020 2020 2020 2065 7863 6570 7420 2863         except (c
-00017fe0: 6378 742e 4e65 7477 6f72 6b45 7272 6f72  cxt.NetworkError
-00017ff0: 2c20 6363 7874 2e45 7863 6861 6e67 6545  , ccxt.ExchangeE
-00018000: 7272 6f72 2920 6173 2065 3a0a 2020 2020  rror) as e:.    
-00018010: 2020 2020 2020 2020 7261 6973 6520 5465          raise Te
-00018020: 6d70 6f72 6172 7945 7272 6f72 2866 2743  mporaryError(f'C
-00018030: 6f75 6c64 206e 6f74 206c 6f61 6420 7472  ould not load tr
-00018040: 6164 6520 6869 7374 6f72 7920 6475 6520  ade history due 
-00018050: 746f 207b 652e 5f5f 636c 6173 735f 5f2e  to {e.__class__.
-00018060: 5f5f 6e61 6d65 5f5f 7d2e 2027 0a20 2020  __name__}. '.   
-00018070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018080: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00018090: 4d65 7373 6167 653a 207b 657d 2729 2066  Message: {e}') f
-000180a0: 726f 6d20 650a 2020 2020 2020 2020 6578  rom e.        ex
-000180b0: 6365 7074 2063 6378 742e 4261 7365 4572  cept ccxt.BaseEr
-000180c0: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
-000180d0: 2020 2020 2020 7261 6973 6520 4f70 6572        raise Oper
-000180e0: 6174 696f 6e61 6c45 7863 6570 7469 6f6e  ationalException
-000180f0: 2866 2743 6f75 6c64 206e 6f74 2066 6574  (f'Could not fet
-00018100: 6368 2074 7261 6465 2064 6174 612e 204d  ch trade data. M
-00018110: 7367 3a20 7b65 7d27 2920 6672 6f6d 2065  sg: {e}') from e
-00018120: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00018130: 5f61 7379 6e63 5f67 6574 5f74 7261 6465  _async_get_trade
-00018140: 5f68 6973 746f 7279 5f69 6428 7365 6c66  _history_id(self
-00018150: 2c20 7061 6972 3a20 7374 722c 0a20 2020  , pair: str,.   
-00018160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018180: 2020 2020 2020 2075 6e74 696c 3a20 696e         until: in
-00018190: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-000181a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000181b0: 2020 2020 2020 2020 2020 2020 2073 696e               sin
-000181c0: 6365 3a20 4f70 7469 6f6e 616c 5b69 6e74  ce: Optional[int
-000181d0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-000181e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000181f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018200: 2020 2020 6672 6f6d 5f69 643a 204f 7074      from_id: Opt
-00018210: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
-00018220: 6529 202d 3e20 5475 706c 655b 7374 722c  e) -> Tuple[str,
-00018230: 204c 6973 745b 4c69 7374 5d5d 3a0a 2020   List[List]]:.  
-00018240: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00018250: 2020 4173 796e 6372 6f6e 6f75 736c 7920    Asyncronously 
-00018260: 6765 7473 2074 7261 6465 2068 6973 746f  gets trade histo
-00018270: 7279 2075 7369 6e67 2066 6574 6368 5f74  ry using fetch_t
-00018280: 7261 6465 730a 2020 2020 2020 2020 7573  rades.        us
-00018290: 6520 7468 6973 2077 6865 6e20 6578 6368  e this when exch
-000182a0: 616e 6765 2075 7365 7320 6964 2d62 6173  ange uses id-bas
-000182b0: 6564 2069 7465 7261 7469 6f6e 2028 6368  ed iteration (ch
-000182c0: 6563 6b20 6073 656c 662e 5f74 7261 6465  eck `self._trade
-000182d0: 735f 7061 6769 6e61 7469 6f6e 6029 0a20  s_pagination`). 
-000182e0: 2020 2020 2020 203a 7061 7261 6d20 7061         :param pa
-000182f0: 6972 3a20 5061 6972 2074 6f20 6665 7463  ir: Pair to fetc
-00018300: 6820 7472 6164 6520 6461 7461 2066 6f72  h trade data for
-00018310: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00018320: 7369 6e63 653a 2053 696e 6365 2061 7320  since: Since as 
-00018330: 696e 7465 6765 7220 7469 6d65 7374 616d  integer timestam
-00018340: 7020 696e 206d 696c 6c69 7365 636f 6e64  p in millisecond
-00018350: 730a 2020 2020 2020 2020 3a70 6172 616d  s.        :param
-00018360: 2075 6e74 696c 3a20 556e 7469 6c20 6173   until: Until as
-00018370: 2069 6e74 6567 6572 2074 696d 6573 7461   integer timesta
-00018380: 6d70 2069 6e20 6d69 6c6c 6973 6563 6f6e  mp in millisecon
-00018390: 6473 0a20 2020 2020 2020 203a 7061 7261  ds.        :para
-000183a0: 6d20 6672 6f6d 5f69 643a 2044 6f77 6e6c  m from_id: Downl
-000183b0: 6f61 6420 6461 7461 2073 7461 7274 696e  oad data startin
-000183c0: 6720 7769 7468 2049 4420 2869 6620 6964  g with ID (if id
-000183d0: 2069 7320 6b6e 6f77 6e29 2e20 4967 6e6f   is known). Igno
-000183e0: 7265 7320 2273 696e 6365 2220 6966 2073  res "since" if s
-000183f0: 6574 2e0a 2020 2020 2020 2020 7265 7475  et..        retu
-00018400: 726e 7320 7475 706c 653a 2028 7061 6972  rns tuple: (pair
-00018410: 2c20 7472 6164 6573 2d6c 6973 7429 0a20  , trades-list). 
-00018420: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00018430: 2020 2020 7472 6164 6573 3a20 4c69 7374      trades: List
-00018440: 5b4c 6973 745d 203d 205b 5d0a 0a20 2020  [List] = []..   
-00018450: 2020 2020 2069 6620 6e6f 7420 6672 6f6d       if not from
-00018460: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
-00018470: 2023 2046 6574 6368 2066 6972 7374 2065   # Fetch first e
-00018480: 6c65 6d65 6e74 7320 7573 696e 6720 7469  lements using ti
-00018490: 6d65 6261 7365 6420 6d65 7468 6f64 2074  mebased method t
-000184a0: 6f20 6765 7420 616e 2049 4420 746f 2070  o get an ID to p
-000184b0: 6167 696e 6174 6520 6f6e 0a20 2020 2020  aginate on.     
-000184c0: 2020 2020 2020 2023 2044 6570 656e 6469         # Dependi
-000184d0: 6e67 206f 6e20 7468 6520 4578 6368 616e  ng on the Exchan
-000184e0: 6765 2c20 7468 6973 2063 616e 2069 6e74  ge, this can int
-000184f0: 726f 6475 6365 2061 2064 7269 6674 2061  roduce a drift a
-00018500: 7420 7468 6520 7374 6172 7420 6f66 2074  t the start of t
-00018510: 6865 2069 6e74 6572 7661 6c0a 2020 2020  he interval.    
-00018520: 2020 2020 2020 2020 2320 6f66 2075 7020          # of up 
-00018530: 746f 2061 6e20 686f 7572 2e0a 2020 2020  to an hour..    
-00018540: 2020 2020 2020 2020 2320 652e 672e 2042          # e.g. B
-00018550: 696e 616e 6365 2072 6574 7572 6e73 2074  inance returns t
-00018560: 6865 2022 6c61 7374 2031 3030 3022 2063  he "last 1000" c
-00018570: 616e 646c 6573 2077 6974 6869 6e20 6120  andles within a 
-00018580: 3168 2074 696d 6520 696e 7465 7276 616c  1h time interval
-00018590: 0a20 2020 2020 2020 2020 2020 2023 202d  .            # -
-000185a0: 2073 6f20 7765 2077 696c 6c20 6d69 7373   so we will miss
-000185b0: 2074 6865 2066 6972 7374 2074 7261 6465   the first trade
-000185c0: 732e 0a20 2020 2020 2020 2020 2020 2074  s..            t
-000185d0: 203d 2061 7761 6974 2073 656c 662e 5f61   = await self._a
-000185e0: 7379 6e63 5f66 6574 6368 5f74 7261 6465  sync_fetch_trade
-000185f0: 7328 7061 6972 2c20 7369 6e63 653d 7369  s(pair, since=si
-00018600: 6e63 6529 0a20 2020 2020 2020 2020 2020  nce).           
-00018610: 2023 2044 4546 4155 4c54 5f54 5241 4445   # DEFAULT_TRADE
-00018620: 535f 434f 4c55 4d4e 533a 2030 202d 3e20  S_COLUMNS: 0 -> 
-00018630: 7469 6d65 7374 616d 700a 2020 2020 2020  timestamp.      
-00018640: 2020 2020 2020 2320 4445 4641 554c 545f        # DEFAULT_
-00018650: 5452 4144 4553 5f43 4f4c 554d 4e53 3a20  TRADES_COLUMNS: 
-00018660: 3120 2d3e 2069 640a 2020 2020 2020 2020  1 -> id.        
-00018670: 2020 2020 6672 6f6d 5f69 6420 3d20 745b      from_id = t[
-00018680: 2d31 5d5b 315d 0a20 2020 2020 2020 2020  -1][1].         
-00018690: 2020 2074 7261 6465 732e 6578 7465 6e64     trades.extend
-000186a0: 2874 5b3a 2d31 5d29 0a20 2020 2020 2020  (t[:-1]).       
-000186b0: 2077 6869 6c65 2054 7275 653a 0a20 2020   while True:.   
-000186c0: 2020 2020 2020 2020 2074 203d 2061 7761           t = awa
-000186d0: 6974 2073 656c 662e 5f61 7379 6e63 5f66  it self._async_f
-000186e0: 6574 6368 5f74 7261 6465 7328 7061 6972  etch_trades(pair
-000186f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018720: 2070 6172 616d 733d 7b73 656c 662e 5f74   params={self._t
-00018730: 7261 6465 735f 7061 6769 6e61 7469 6f6e  rades_pagination
-00018740: 5f61 7267 3a20 6672 6f6d 5f69 647d 290a  _arg: from_id}).
-00018750: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00018760: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018770: 2020 2320 536b 6970 206c 6173 7420 6964    # Skip last id
-00018780: 2073 696e 6365 2069 7473 2074 6865 206b   since its the k
-00018790: 6579 2066 6f72 2074 6865 206e 6578 7420  ey for the next 
-000187a0: 6361 6c6c 0a20 2020 2020 2020 2020 2020  call.           
-000187b0: 2020 2020 2074 7261 6465 732e 6578 7465       trades.exte
-000187c0: 6e64 2874 5b3a 2d31 5d29 0a20 2020 2020  nd(t[:-1]).     
-000187d0: 2020 2020 2020 2020 2020 2069 6620 6672             if fr
-000187e0: 6f6d 5f69 6420 3d3d 2074 5b2d 315d 5b31  om_id == t[-1][1
-000187f0: 5d20 6f72 2074 5b2d 315d 5b30 5d20 3e20  ] or t[-1][0] > 
-00018800: 756e 7469 6c3a 0a20 2020 2020 2020 2020  until:.         
-00018810: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00018820: 722e 6465 6275 6728 6622 5374 6f70 7069  r.debug(f"Stoppi
-00018830: 6e67 2062 6563 6175 7365 2066 726f 6d5f  ng because from_
-00018840: 6964 2064 6964 206e 6f74 2063 6861 6e67  id did not chang
-00018850: 652e 2022 0a20 2020 2020 2020 2020 2020  e. ".           
-00018860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018870: 2020 2020 2020 6622 5265 6163 6865 6420        f"Reached 
-00018880: 7b74 5b2d 315d 5b30 5d7d 203e 207b 756e  {t[-1][0]} > {un
-00018890: 7469 6c7d 2229 0a20 2020 2020 2020 2020  til}").         
-000188a0: 2020 2020 2020 2020 2020 2023 2052 6561             # Rea
-000188b0: 6368 6564 2074 6865 2065 6e64 206f 6620  ched the end of 
-000188c0: 7468 6520 6465 6669 6e65 642d 646f 776e  the defined-down
-000188d0: 6c6f 6164 2070 6572 696f 6420 2d20 6164  load period - ad
-000188e0: 6420 6c61 7374 2074 7261 6465 2061 7320  d last trade as 
-000188f0: 7765 6c6c 2e0a 2020 2020 2020 2020 2020  well..          
-00018900: 2020 2020 2020 2020 2020 7472 6164 6573            trades
-00018910: 2e65 7874 656e 6428 745b 2d31 3a5d 290a  .extend(t[-1:]).
-00018920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018930: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-00018940: 2020 2020 2020 2020 2020 2066 726f 6d5f             from_
-00018950: 6964 203d 2074 5b2d 315d 5b31 5d0a 2020  id = t[-1][1].  
-00018960: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00003830: 5f74 696d 6566 7261 6d65 2069 6620 7468  _timeframe if th
+00003840: 6520 6578 6368 616e 6765 2068 6173 2064  e exchange has d
+00003850: 6966 6665 7265 6e74 206c 696d 6974 730a  ifferent limits.
+00003860: 2020 2020 2020 2020 7065 7220 7469 6d65          per time
+00003870: 6672 616d 6520 2865 2e67 2e20 6269 7474  frame (e.g. bitt
+00003880: 7265 7829 2c20 6f74 6865 7277 6973 6520  rex), otherwise 
+00003890: 6661 6c6c 7320 6261 636b 2074 6f20 6f68  falls back to oh
+000038a0: 6c63 765f 6361 6e64 6c65 5f6c 696d 6974  lcv_candle_limit
+000038b0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000038c0: 7469 6d65 6672 616d 653a 2054 696d 6566  timeframe: Timef
+000038d0: 7261 6d65 2074 6f20 6368 6563 6b0a 2020  rame to check.  
+000038e0: 2020 2020 2020 3a70 6172 616d 2063 616e        :param can
+000038f0: 646c 655f 7479 7065 3a20 4361 6e64 6c65  dle_type: Candle
+00003900: 2d74 7970 650a 2020 2020 2020 2020 3a70  -type.        :p
+00003910: 6172 616d 2073 696e 6365 5f6d 733a 2053  aram since_ms: S
+00003920: 7461 7274 696e 6720 7469 6d65 7374 616d  tarting timestam
+00003930: 700a 2020 2020 2020 2020 3a72 6574 7572  p.        :retur
+00003940: 6e3a 2043 616e 646c 6520 6c69 6d69 7420  n: Candle limit 
+00003950: 6173 2069 6e74 6567 6572 0a20 2020 2020  as integer.     
+00003960: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00003970: 6574 7572 6e20 696e 7428 7365 6c66 2e5f  eturn int(self._
+00003980: 6674 5f68 6173 2e67 6574 2827 6f68 6c63  ft_has.get('ohlc
+00003990: 765f 6361 6e64 6c65 5f6c 696d 6974 5f70  v_candle_limit_p
+000039a0: 6572 5f74 696d 6566 7261 6d65 272c 207b  er_timeframe', {
+000039b0: 7d29 2e67 6574 280a 2020 2020 2020 2020  }).get(.        
+000039c0: 2020 2020 7469 6d65 6672 616d 652c 2073      timeframe, s
+000039d0: 656c 662e 5f66 745f 6861 732e 6765 7428  elf._ft_has.get(
+000039e0: 276f 686c 6376 5f63 616e 646c 655f 6c69  'ohlcv_candle_li
+000039f0: 6d69 7427 2929 290a 0a20 2020 2064 6566  mit')))..    def
+00003a00: 2067 6574 5f6d 6172 6b65 7473 2873 656c   get_markets(sel
+00003a10: 662c 2062 6173 655f 6375 7272 656e 6369  f, base_currenci
+00003a20: 6573 3a20 4c69 7374 5b73 7472 5d20 3d20  es: List[str] = 
+00003a30: 5b5d 2c20 7175 6f74 655f 6375 7272 656e  [], quote_curren
+00003a40: 6369 6573 3a20 4c69 7374 5b73 7472 5d20  cies: List[str] 
+00003a50: 3d20 5b5d 2c0a 2020 2020 2020 2020 2020  = [],.          
+00003a60: 2020 2020 2020 2020 2020 7370 6f74 5f6f            spot_o
+00003a70: 6e6c 793a 2062 6f6f 6c20 3d20 4661 6c73  nly: bool = Fals
+00003a80: 652c 206d 6172 6769 6e5f 6f6e 6c79 3a20  e, margin_only: 
+00003a90: 626f 6f6c 203d 2046 616c 7365 2c20 6675  bool = False, fu
+00003aa0: 7475 7265 735f 6f6e 6c79 3a20 626f 6f6c  tures_only: bool
+00003ab0: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+00003ac0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00003ad0: 6164 6162 6c65 5f6f 6e6c 793a 2062 6f6f  adable_only: boo
+00003ae0: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+00003af0: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+00003b00: 7469 7665 5f6f 6e6c 793a 2062 6f6f 6c20  tive_only: bool 
+00003b10: 3d20 4661 6c73 6529 202d 3e20 4469 6374  = False) -> Dict
+00003b20: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
+00003b30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00003b40: 5265 7475 726e 2065 7863 6861 6e67 6520  Return exchange 
+00003b50: 6363 7874 206d 6172 6b65 7473 2c20 6669  ccxt markets, fi
+00003b60: 6c74 6572 6564 206f 7574 2062 7920 6261  ltered out by ba
+00003b70: 7365 2063 7572 7265 6e63 7920 616e 6420  se currency and 
+00003b80: 7175 6f74 6520 6375 7272 656e 6379 0a20  quote currency. 
+00003b90: 2020 2020 2020 2069 6620 7468 6973 2077         if this w
+00003ba0: 6173 2072 6571 7565 7374 6564 2069 6e20  as requested in 
+00003bb0: 7061 7261 6d65 7465 7273 2e0a 2020 2020  parameters..    
+00003bc0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00003bd0: 6d61 726b 6574 7320 3d20 7365 6c66 2e6d  markets = self.m
+00003be0: 6172 6b65 7473 0a20 2020 2020 2020 2069  arkets.        i
+00003bf0: 6620 6e6f 7420 6d61 726b 6574 733a 0a20  f not markets:. 
+00003c00: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00003c10: 204f 7065 7261 7469 6f6e 616c 4578 6365   OperationalExce
+00003c20: 7074 696f 6e28 224d 6172 6b65 7473 2077  ption("Markets w
+00003c30: 6572 6520 6e6f 7420 6c6f 6164 6564 2e22  ere not loaded."
+00003c40: 290a 0a20 2020 2020 2020 2069 6620 6261  )..        if ba
+00003c50: 7365 5f63 7572 7265 6e63 6965 733a 0a20  se_currencies:. 
+00003c60: 2020 2020 2020 2020 2020 206d 6172 6b65             marke
+00003c70: 7473 203d 207b 6b3a 2076 2066 6f72 206b  ts = {k: v for k
+00003c80: 2c20 7620 696e 206d 6172 6b65 7473 2e69  , v in markets.i
+00003c90: 7465 6d73 2829 2069 6620 765b 2762 6173  tems() if v['bas
+00003ca0: 6527 5d20 696e 2062 6173 655f 6375 7272  e'] in base_curr
+00003cb0: 656e 6369 6573 7d0a 2020 2020 2020 2020  encies}.        
+00003cc0: 6966 2071 756f 7465 5f63 7572 7265 6e63  if quote_currenc
+00003cd0: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00003ce0: 206d 6172 6b65 7473 203d 207b 6b3a 2076   markets = {k: v
+00003cf0: 2066 6f72 206b 2c20 7620 696e 206d 6172   for k, v in mar
+00003d00: 6b65 7473 2e69 7465 6d73 2829 2069 6620  kets.items() if 
+00003d10: 765b 2771 756f 7465 275d 2069 6e20 7175  v['quote'] in qu
+00003d20: 6f74 655f 6375 7272 656e 6369 6573 7d0a  ote_currencies}.
+00003d30: 2020 2020 2020 2020 6966 2074 7261 6461          if trada
+00003d40: 626c 655f 6f6e 6c79 3a0a 2020 2020 2020  ble_only:.      
+00003d50: 2020 2020 2020 6d61 726b 6574 7320 3d20        markets = 
+00003d60: 7b6b 3a20 7620 666f 7220 6b2c 2076 2069  {k: v for k, v i
+00003d70: 6e20 6d61 726b 6574 732e 6974 656d 7328  n markets.items(
+00003d80: 2920 6966 2073 656c 662e 6d61 726b 6574  ) if self.market
+00003d90: 5f69 735f 7472 6164 6162 6c65 2876 297d  _is_tradable(v)}
+00003da0: 0a20 2020 2020 2020 2069 6620 7370 6f74  .        if spot
+00003db0: 5f6f 6e6c 793a 0a20 2020 2020 2020 2020  _only:.         
+00003dc0: 2020 206d 6172 6b65 7473 203d 207b 6b3a     markets = {k:
+00003dd0: 2076 2066 6f72 206b 2c20 7620 696e 206d   v for k, v in m
+00003de0: 6172 6b65 7473 2e69 7465 6d73 2829 2069  arkets.items() i
+00003df0: 6620 7365 6c66 2e6d 6172 6b65 745f 6973  f self.market_is
+00003e00: 5f73 706f 7428 7629 7d0a 2020 2020 2020  _spot(v)}.      
+00003e10: 2020 6966 206d 6172 6769 6e5f 6f6e 6c79    if margin_only
+00003e20: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
+00003e30: 726b 6574 7320 3d20 7b6b 3a20 7620 666f  rkets = {k: v fo
+00003e40: 7220 6b2c 2076 2069 6e20 6d61 726b 6574  r k, v in market
+00003e50: 732e 6974 656d 7328 2920 6966 2073 656c  s.items() if sel
+00003e60: 662e 6d61 726b 6574 5f69 735f 6d61 7267  f.market_is_marg
+00003e70: 696e 2876 297d 0a20 2020 2020 2020 2069  in(v)}.        i
+00003e80: 6620 6675 7475 7265 735f 6f6e 6c79 3a0a  f futures_only:.
+00003e90: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
+00003ea0: 6574 7320 3d20 7b6b 3a20 7620 666f 7220  ets = {k: v for 
+00003eb0: 6b2c 2076 2069 6e20 6d61 726b 6574 732e  k, v in markets.
+00003ec0: 6974 656d 7328 2920 6966 2073 656c 662e  items() if self.
+00003ed0: 6d61 726b 6574 5f69 735f 6675 7475 7265  market_is_future
+00003ee0: 2876 297d 0a20 2020 2020 2020 2069 6620  (v)}.        if 
+00003ef0: 6163 7469 7665 5f6f 6e6c 793a 0a20 2020  active_only:.   
+00003f00: 2020 2020 2020 2020 206d 6172 6b65 7473           markets
+00003f10: 203d 207b 6b3a 2076 2066 6f72 206b 2c20   = {k: v for k, 
+00003f20: 7620 696e 206d 6172 6b65 7473 2e69 7465  v in markets.ite
+00003f30: 6d73 2829 2069 6620 6d61 726b 6574 5f69  ms() if market_i
+00003f40: 735f 6163 7469 7665 2876 297d 0a20 2020  s_active(v)}.   
+00003f50: 2020 2020 2072 6574 7572 6e20 6d61 726b       return mark
+00003f60: 6574 730a 0a20 2020 2064 6566 2067 6574  ets..    def get
+00003f70: 5f71 756f 7465 5f63 7572 7265 6e63 6965  _quote_currencie
+00003f80: 7328 7365 6c66 2920 2d3e 204c 6973 745b  s(self) -> List[
+00003f90: 7374 725d 3a0a 2020 2020 2020 2020 2222  str]:.        ""
+00003fa0: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
+00003fb0: 2061 206c 6973 7420 6f66 2073 7570 706f   a list of suppo
+00003fc0: 7274 6564 2071 756f 7465 2063 7572 7265  rted quote curre
+00003fd0: 6e63 6965 730a 2020 2020 2020 2020 2222  ncies.        ""
+00003fe0: 220a 2020 2020 2020 2020 6d61 726b 6574  ".        market
+00003ff0: 7320 3d20 7365 6c66 2e6d 6172 6b65 7473  s = self.markets
+00004000: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00004010: 736f 7274 6564 2873 6574 285b 785b 2771  sorted(set([x['q
+00004020: 756f 7465 275d 2066 6f72 205f 2c20 7820  uote'] for _, x 
+00004030: 696e 206d 6172 6b65 7473 2e69 7465 6d73  in markets.items
+00004040: 2829 5d29 290a 0a20 2020 2064 6566 2067  ()]))..    def g
+00004050: 6574 5f70 6169 725f 7175 6f74 655f 6375  et_pair_quote_cu
+00004060: 7272 656e 6379 2873 656c 662c 2070 6169  rrency(self, pai
+00004070: 723a 2073 7472 2920 2d3e 2073 7472 3a0a  r: str) -> str:.
+00004080: 2020 2020 2020 2020 2222 2220 5265 7475          """ Retu
+00004090: 726e 2061 2070 6169 7227 7320 7175 6f74  rn a pair's quot
+000040a0: 6520 6375 7272 656e 6379 2028 6261 7365  e currency (base
+000040b0: 2f71 756f 7465 3a73 6574 746c 656d 656e  /quote:settlemen
+000040c0: 7429 2022 2222 0a20 2020 2020 2020 2072  t) """.        r
+000040d0: 6574 7572 6e20 7365 6c66 2e6d 6172 6b65  eturn self.marke
+000040e0: 7473 2e67 6574 2870 6169 722c 207b 7d29  ts.get(pair, {})
+000040f0: 2e67 6574 2827 7175 6f74 6527 2c20 2727  .get('quote', ''
+00004100: 290a 0a20 2020 2064 6566 2067 6574 5f70  )..    def get_p
+00004110: 6169 725f 6261 7365 5f63 7572 7265 6e63  air_base_currenc
+00004120: 7928 7365 6c66 2c20 7061 6972 3a20 7374  y(self, pair: st
+00004130: 7229 202d 3e20 7374 723a 0a20 2020 2020  r) -> str:.     
+00004140: 2020 2022 2222 2052 6574 7572 6e20 6120     """ Return a 
+00004150: 7061 6972 2773 2062 6173 6520 6375 7272  pair's base curr
+00004160: 656e 6379 2028 6261 7365 2f71 756f 7465  ency (base/quote
+00004170: 3a73 6574 746c 656d 656e 7429 2022 2222  :settlement) """
+00004180: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00004190: 7365 6c66 2e6d 6172 6b65 7473 2e67 6574  self.markets.get
+000041a0: 2870 6169 722c 207b 7d29 2e67 6574 2827  (pair, {}).get('
+000041b0: 6261 7365 272c 2027 2729 0a0a 2020 2020  base', '')..    
+000041c0: 6465 6620 6d61 726b 6574 5f69 735f 6675  def market_is_fu
+000041d0: 7475 7265 2873 656c 662c 206d 6172 6b65  ture(self, marke
+000041e0: 743a 2044 6963 745b 7374 722c 2041 6e79  t: Dict[str, Any
+000041f0: 5d29 202d 3e20 626f 6f6c 3a0a 2020 2020  ]) -> bool:.    
+00004200: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00004210: 2020 2020 2020 2020 206d 6172 6b65 742e           market.
+00004220: 6765 7428 7365 6c66 2e5f 6674 5f68 6173  get(self._ft_has
+00004230: 5b22 6363 7874 5f66 7574 7572 6573 5f6e  ["ccxt_futures_n
+00004240: 616d 6522 5d2c 2046 616c 7365 2920 6973  ame"], False) is
+00004250: 2054 7275 6520 616e 640a 2020 2020 2020   True and.      
+00004260: 2020 2020 2020 6d61 726b 6574 2e67 6574        market.get
+00004270: 2827 6c69 6e65 6172 272c 2046 616c 7365  ('linear', False
+00004280: 2920 6973 2054 7275 650a 2020 2020 2020  ) is True.      
+00004290: 2020 290a 0a20 2020 2064 6566 206d 6172    )..    def mar
+000042a0: 6b65 745f 6973 5f73 706f 7428 7365 6c66  ket_is_spot(self
+000042b0: 2c20 6d61 726b 6574 3a20 4469 6374 5b73  , market: Dict[s
+000042c0: 7472 2c20 416e 795d 2920 2d3e 2062 6f6f  tr, Any]) -> boo
+000042d0: 6c3a 0a20 2020 2020 2020 2072 6574 7572  l:.        retur
+000042e0: 6e20 6d61 726b 6574 2e67 6574 2827 7370  n market.get('sp
+000042f0: 6f74 272c 2046 616c 7365 2920 6973 2054  ot', False) is T
+00004300: 7275 650a 0a20 2020 2064 6566 206d 6172  rue..    def mar
+00004310: 6b65 745f 6973 5f6d 6172 6769 6e28 7365  ket_is_margin(se
+00004320: 6c66 2c20 6d61 726b 6574 3a20 4469 6374  lf, market: Dict
+00004330: 5b73 7472 2c20 416e 795d 2920 2d3e 2062  [str, Any]) -> b
+00004340: 6f6f 6c3a 0a20 2020 2020 2020 2072 6574  ool:.        ret
+00004350: 7572 6e20 6d61 726b 6574 2e67 6574 2827  urn market.get('
+00004360: 6d61 7267 696e 272c 2046 616c 7365 2920  margin', False) 
+00004370: 6973 2054 7275 650a 0a20 2020 2064 6566  is True..    def
+00004380: 206d 6172 6b65 745f 6973 5f74 7261 6461   market_is_trada
+00004390: 626c 6528 7365 6c66 2c20 6d61 726b 6574  ble(self, market
+000043a0: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
+000043b0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+000043c0: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+000043d0: 6865 636b 2069 6620 7468 6520 6d61 726b  heck if the mark
+000043e0: 6574 2073 796d 626f 6c20 6973 2074 7261  et symbol is tra
+000043f0: 6461 626c 6520 6279 2046 7265 7174 7261  dable by Freqtra
+00004400: 6465 2e0a 2020 2020 2020 2020 456e 7375  de..        Ensu
+00004410: 7265 7320 7468 6174 2043 6f6e 6669 6775  res that Configu
+00004420: 7265 6420 6d6f 6465 2061 6c69 676e 7320  red mode aligns 
+00004430: 746f 0a20 2020 2020 2020 2022 2222 0a20  to.        """. 
+00004440: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
+00004450: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
+00004460: 6574 2e67 6574 2827 7175 6f74 6527 2c20  et.get('quote', 
+00004470: 4e6f 6e65 2920 6973 206e 6f74 204e 6f6e  None) is not Non
+00004480: 650a 2020 2020 2020 2020 2020 2020 616e  e.            an
+00004490: 6420 6d61 726b 6574 2e67 6574 2827 6261  d market.get('ba
+000044a0: 7365 272c 204e 6f6e 6529 2069 7320 6e6f  se', None) is no
+000044b0: 7420 4e6f 6e65 0a20 2020 2020 2020 2020  t None.         
+000044c0: 2020 2061 6e64 2028 7365 6c66 2e70 7265     and (self.pre
+000044d0: 6369 7369 6f6e 4d6f 6465 2021 3d20 5449  cisionMode != TI
+000044e0: 434b 5f53 495a 450a 2020 2020 2020 2020  CK_SIZE.        
+000044f0: 2020 2020 2020 2020 2023 2054 6f6f 206c           # Too l
+00004500: 6f77 2070 7265 6369 7369 6f6e 2077 696c  ow precision wil
+00004510: 6c20 6661 6c73 6966 7920 6361 6c63 756c  l falsify calcul
+00004520: 6174 696f 6e73 0a20 2020 2020 2020 2020  ations.         
+00004530: 2020 2020 2020 2020 6f72 206d 6172 6b65          or marke
+00004540: 742e 6765 7428 2770 7265 6369 7369 6f6e  t.get('precision
+00004550: 272c 207b 7d29 2e67 6574 2827 7072 6963  ', {}).get('pric
+00004560: 6527 2920 3e20 3165 2d31 3129 0a20 2020  e') > 1e-11).   
+00004570: 2020 2020 2020 2020 2061 6e64 2028 2873           and ((s
+00004580: 656c 662e 7472 6164 696e 675f 6d6f 6465  elf.trading_mode
+00004590: 203d 3d20 5472 6164 696e 674d 6f64 652e   == TradingMode.
+000045a0: 5350 4f54 2061 6e64 2073 656c 662e 6d61  SPOT and self.ma
+000045b0: 726b 6574 5f69 735f 7370 6f74 286d 6172  rket_is_spot(mar
+000045c0: 6b65 7429 290a 2020 2020 2020 2020 2020  ket)).          
+000045d0: 2020 2020 2020 206f 7220 2873 656c 662e         or (self.
+000045e0: 7472 6164 696e 675f 6d6f 6465 203d 3d20  trading_mode == 
+000045f0: 5472 6164 696e 674d 6f64 652e 4d41 5247  TradingMode.MARG
+00004600: 494e 2061 6e64 2073 656c 662e 6d61 726b  IN and self.mark
+00004610: 6574 5f69 735f 6d61 7267 696e 286d 6172  et_is_margin(mar
+00004620: 6b65 7429 290a 2020 2020 2020 2020 2020  ket)).          
+00004630: 2020 2020 2020 206f 7220 2873 656c 662e         or (self.
+00004640: 7472 6164 696e 675f 6d6f 6465 203d 3d20  trading_mode == 
+00004650: 5472 6164 696e 674d 6f64 652e 4655 5455  TradingMode.FUTU
+00004660: 5245 5320 616e 6420 7365 6c66 2e6d 6172  RES and self.mar
+00004670: 6b65 745f 6973 5f66 7574 7572 6528 6d61  ket_is_future(ma
+00004680: 726b 6574 2929 290a 2020 2020 2020 2020  rket))).        
+00004690: 290a 0a20 2020 2064 6566 206b 6c69 6e65  )..    def kline
+000046a0: 7328 7365 6c66 2c20 7061 6972 5f69 6e74  s(self, pair_int
+000046b0: 6572 7661 6c3a 2050 6169 7257 6974 6854  erval: PairWithT
+000046c0: 696d 6566 7261 6d65 2c20 636f 7079 3a20  imeframe, copy: 
+000046d0: 626f 6f6c 203d 2054 7275 6529 202d 3e20  bool = True) -> 
+000046e0: 4461 7461 4672 616d 653a 0a20 2020 2020  DataFrame:.     
+000046f0: 2020 2069 6620 7061 6972 5f69 6e74 6572     if pair_inter
+00004700: 7661 6c20 696e 2073 656c 662e 5f6b 6c69  val in self._kli
+00004710: 6e65 733a 0a20 2020 2020 2020 2020 2020  nes:.           
+00004720: 2072 6574 7572 6e20 7365 6c66 2e5f 6b6c   return self._kl
+00004730: 696e 6573 5b70 6169 725f 696e 7465 7276  ines[pair_interv
+00004740: 616c 5d2e 636f 7079 2829 2069 6620 636f  al].copy() if co
+00004750: 7079 2065 6c73 6520 7365 6c66 2e5f 6b6c  py else self._kl
+00004760: 696e 6573 5b70 6169 725f 696e 7465 7276  ines[pair_interv
+00004770: 616c 5d0a 2020 2020 2020 2020 656c 7365  al].        else
+00004780: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00004790: 7475 726e 2044 6174 6146 7261 6d65 2829  turn DataFrame()
+000047a0: 0a0a 2020 2020 6465 6620 6765 745f 636f  ..    def get_co
+000047b0: 6e74 7261 6374 5f73 697a 6528 7365 6c66  ntract_size(self
+000047c0: 2c20 7061 6972 3a20 7374 7229 202d 3e20  , pair: str) -> 
+000047d0: 4f70 7469 6f6e 616c 5b66 6c6f 6174 5d3a  Optional[float]:
+000047e0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000047f0: 2e74 7261 6469 6e67 5f6d 6f64 6520 3d3d  .trading_mode ==
+00004800: 2054 7261 6469 6e67 4d6f 6465 2e46 5554   TradingMode.FUT
+00004810: 5552 4553 3a0a 2020 2020 2020 2020 2020  URES:.          
+00004820: 2020 6d61 726b 6574 203d 2073 656c 662e    market = self.
+00004830: 6d61 726b 6574 732e 6765 7428 7061 6972  markets.get(pair
+00004840: 2c20 7b7d 290a 2020 2020 2020 2020 2020  , {}).          
+00004850: 2020 636f 6e74 7261 6374 5f73 697a 653a    contract_size:
+00004860: 2066 6c6f 6174 203d 2031 2e30 0a20 2020   float = 1.0.   
+00004870: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00004880: 6d61 726b 6574 3a0a 2020 2020 2020 2020  market:.        
+00004890: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+000048a0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+000048b0: 6966 206d 6172 6b65 742e 6765 7428 2763  if market.get('c
+000048c0: 6f6e 7472 6163 7453 697a 6527 2920 6973  ontractSize') is
+000048d0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000048e0: 2020 2020 2020 2020 2020 2023 2063 6378             # ccx
+000048f0: 7420 6861 7320 636f 6e74 7261 6374 5369  t has contractSi
+00004900: 7a65 2069 6e20 6d61 726b 6574 7320 6173  ze in markets as
+00004910: 2073 7472 696e 670a 2020 2020 2020 2020   string.        
+00004920: 2020 2020 2020 2020 636f 6e74 7261 6374          contract
+00004930: 5f73 697a 6520 3d20 666c 6f61 7428 6d61  _size = float(ma
+00004940: 726b 6574 5b27 636f 6e74 7261 6374 5369  rket['contractSi
+00004950: 7a65 275d 290a 2020 2020 2020 2020 2020  ze']).          
+00004960: 2020 7265 7475 726e 2063 6f6e 7472 6163    return contrac
+00004970: 745f 7369 7a65 0a20 2020 2020 2020 2065  t_size.        e
+00004980: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00004990: 2072 6574 7572 6e20 310a 0a20 2020 2064   return 1..    d
+000049a0: 6566 205f 7472 6164 6573 5f63 6f6e 7472  ef _trades_contr
+000049b0: 6163 7473 5f74 6f5f 616d 6f75 6e74 2873  acts_to_amount(s
+000049c0: 656c 662c 2074 7261 6465 733a 204c 6973  elf, trades: Lis
+000049d0: 7429 202d 3e20 4c69 7374 3a0a 2020 2020  t) -> List:.    
+000049e0: 2020 2020 6966 206c 656e 2874 7261 6465      if len(trade
+000049f0: 7329 203e 2030 2061 6e64 2027 7379 6d62  s) > 0 and 'symb
+00004a00: 6f6c 2720 696e 2074 7261 6465 735b 305d  ol' in trades[0]
+00004a10: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00004a20: 6e74 7261 6374 5f73 697a 6520 3d20 7365  ntract_size = se
+00004a30: 6c66 2e67 6574 5f63 6f6e 7472 6163 745f  lf.get_contract_
+00004a40: 7369 7a65 2874 7261 6465 735b 305d 5b27  size(trades[0]['
+00004a50: 7379 6d62 6f6c 275d 290a 2020 2020 2020  symbol']).      
+00004a60: 2020 2020 2020 6966 2063 6f6e 7472 6163        if contrac
+00004a70: 745f 7369 7a65 2021 3d20 313a 0a20 2020  t_size != 1:.   
+00004a80: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00004a90: 2074 7261 6465 2069 6e20 7472 6164 6573   trade in trades
+00004aa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00004ab0: 2020 2020 2020 7472 6164 655b 2761 6d6f        trade['amo
+00004ac0: 756e 7427 5d20 3d20 7472 6164 655b 2761  unt'] = trade['a
+00004ad0: 6d6f 756e 7427 5d20 2a20 636f 6e74 7261  mount'] * contra
+00004ae0: 6374 5f73 697a 650a 2020 2020 2020 2020  ct_size.        
+00004af0: 7265 7475 726e 2074 7261 6465 730a 0a20  return trades.. 
+00004b00: 2020 2064 6566 205f 6f72 6465 725f 636f     def _order_co
+00004b10: 6e74 7261 6374 735f 746f 5f61 6d6f 756e  ntracts_to_amoun
+00004b20: 7428 7365 6c66 2c20 6f72 6465 723a 2044  t(self, order: D
+00004b30: 6963 7429 202d 3e20 4469 6374 3a0a 2020  ict) -> Dict:.  
+00004b40: 2020 2020 2020 6966 2027 7379 6d62 6f6c        if 'symbol
+00004b50: 2720 696e 206f 7264 6572 2061 6e64 206f  ' in order and o
+00004b60: 7264 6572 5b27 7379 6d62 6f6c 275d 2069  rder['symbol'] i
+00004b70: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00004b80: 2020 2020 2020 2020 636f 6e74 7261 6374          contract
+00004b90: 5f73 697a 6520 3d20 7365 6c66 2e67 6574  _size = self.get
+00004ba0: 5f63 6f6e 7472 6163 745f 7369 7a65 286f  _contract_size(o
+00004bb0: 7264 6572 5b27 7379 6d62 6f6c 275d 290a  rder['symbol']).
+00004bc0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00004bd0: 6f6e 7472 6163 745f 7369 7a65 2021 3d20  ontract_size != 
+00004be0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00004bf0: 2020 2066 6f72 2070 726f 7020 696e 2073     for prop in s
+00004c00: 656c 662e 5f66 745f 6861 732e 6765 7428  elf._ft_has.get(
+00004c10: 276f 7264 6572 5f70 726f 7073 5f69 6e5f  'order_props_in_
+00004c20: 636f 6e74 7261 6374 7327 2c20 5b5d 293a  contracts', []):
+00004c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004c40: 2020 2020 2069 6620 7072 6f70 2069 6e20       if prop in 
+00004c50: 6f72 6465 7220 616e 6420 6f72 6465 725b  order and order[
+00004c60: 7072 6f70 5d20 6973 206e 6f74 204e 6f6e  prop] is not Non
+00004c70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00004c80: 2020 2020 2020 2020 2020 206f 7264 6572             order
+00004c90: 5b70 726f 705d 203d 206f 7264 6572 5b70  [prop] = order[p
+00004ca0: 726f 705d 202a 2063 6f6e 7472 6163 745f  rop] * contract_
+00004cb0: 7369 7a65 0a20 2020 2020 2020 2072 6574  size.        ret
+00004cc0: 7572 6e20 6f72 6465 720a 0a20 2020 2064  urn order..    d
+00004cd0: 6566 205f 616d 6f75 6e74 5f74 6f5f 636f  ef _amount_to_co
+00004ce0: 6e74 7261 6374 7328 7365 6c66 2c20 7061  ntracts(self, pa
+00004cf0: 6972 3a20 7374 722c 2061 6d6f 756e 743a  ir: str, amount:
+00004d00: 2066 6c6f 6174 2920 2d3e 2066 6c6f 6174   float) -> float
+00004d10: 3a0a 0a20 2020 2020 2020 2063 6f6e 7472  :..        contr
+00004d20: 6163 745f 7369 7a65 203d 2073 656c 662e  act_size = self.
+00004d30: 6765 745f 636f 6e74 7261 6374 5f73 697a  get_contract_siz
+00004d40: 6528 7061 6972 290a 2020 2020 2020 2020  e(pair).        
+00004d50: 7265 7475 726e 2061 6d6f 756e 745f 746f  return amount_to
+00004d60: 5f63 6f6e 7472 6163 7473 2861 6d6f 756e  _contracts(amoun
+00004d70: 742c 2063 6f6e 7472 6163 745f 7369 7a65  t, contract_size
+00004d80: 290a 0a20 2020 2064 6566 205f 636f 6e74  )..    def _cont
+00004d90: 7261 6374 735f 746f 5f61 6d6f 756e 7428  racts_to_amount(
+00004da0: 7365 6c66 2c20 7061 6972 3a20 7374 722c  self, pair: str,
+00004db0: 206e 756d 5f63 6f6e 7472 6163 7473 3a20   num_contracts: 
+00004dc0: 666c 6f61 7429 202d 3e20 666c 6f61 743a  float) -> float:
+00004dd0: 0a0a 2020 2020 2020 2020 636f 6e74 7261  ..        contra
+00004de0: 6374 5f73 697a 6520 3d20 7365 6c66 2e67  ct_size = self.g
+00004df0: 6574 5f63 6f6e 7472 6163 745f 7369 7a65  et_contract_size
+00004e00: 2870 6169 7229 0a20 2020 2020 2020 2072  (pair).        r
+00004e10: 6574 7572 6e20 636f 6e74 7261 6374 735f  eturn contracts_
+00004e20: 746f 5f61 6d6f 756e 7428 6e75 6d5f 636f  to_amount(num_co
+00004e30: 6e74 7261 6374 732c 2063 6f6e 7472 6163  ntracts, contrac
+00004e40: 745f 7369 7a65 290a 0a20 2020 2064 6566  t_size)..    def
+00004e50: 2061 6d6f 756e 745f 746f 5f63 6f6e 7472   amount_to_contr
+00004e60: 6163 745f 7072 6563 6973 696f 6e28 7365  act_precision(se
+00004e70: 6c66 2c20 7061 6972 3a20 7374 722c 2061  lf, pair: str, a
+00004e80: 6d6f 756e 743a 2066 6c6f 6174 2920 2d3e  mount: float) ->
+00004e90: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
+00004ea0: 2222 220a 2020 2020 2020 2020 4865 6c70  """.        Help
+00004eb0: 6572 2077 7261 7070 6572 2061 726f 756e  er wrapper aroun
+00004ec0: 6420 616d 6f75 6e74 5f74 6f5f 636f 6e74  d amount_to_cont
+00004ed0: 7261 6374 5f70 7265 6369 7369 6f6e 0a20  ract_precision. 
+00004ee0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00004ef0: 2020 2063 6f6e 7472 6163 745f 7369 7a65     contract_size
+00004f00: 203d 2073 656c 662e 6765 745f 636f 6e74   = self.get_cont
+00004f10: 7261 6374 5f73 697a 6528 7061 6972 290a  ract_size(pair).
+00004f20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00004f30: 616d 6f75 6e74 5f74 6f5f 636f 6e74 7261  amount_to_contra
+00004f40: 6374 5f70 7265 6369 7369 6f6e 2861 6d6f  ct_precision(amo
+00004f50: 756e 742c 2073 656c 662e 6765 745f 7072  unt, self.get_pr
+00004f60: 6563 6973 696f 6e5f 616d 6f75 6e74 2870  ecision_amount(p
+00004f70: 6169 7229 2c0a 2020 2020 2020 2020 2020  air),.          
+00004f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004fa0: 2020 7365 6c66 2e70 7265 6369 7369 6f6e    self.precision
+00004fb0: 4d6f 6465 2c20 636f 6e74 7261 6374 5f73  Mode, contract_s
+00004fc0: 697a 6529 0a0a 2020 2020 6465 6620 7365  ize)..    def se
+00004fd0: 745f 7361 6e64 626f 7828 7365 6c66 2c20  t_sandbox(self, 
+00004fe0: 6170 693a 2063 6378 742e 4578 6368 616e  api: ccxt.Exchan
+00004ff0: 6765 2c20 6578 6368 616e 6765 5f63 6f6e  ge, exchange_con
+00005000: 6669 673a 2064 6963 742c 206e 616d 653a  fig: dict, name:
+00005010: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+00005020: 2020 2020 2020 2069 6620 6578 6368 616e         if exchan
+00005030: 6765 5f63 6f6e 6669 672e 6765 7428 2773  ge_config.get('s
+00005040: 616e 6462 6f78 2729 3a0a 2020 2020 2020  andbox'):.      
+00005050: 2020 2020 2020 6966 2061 7069 2e75 726c        if api.url
+00005060: 732e 6765 7428 2774 6573 7427 293a 0a20  s.get('test'):. 
+00005070: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00005080: 7069 2e75 726c 735b 2761 7069 275d 203d  pi.urls['api'] =
+00005090: 2061 7069 2e75 726c 735b 2774 6573 7427   api.urls['test'
+000050a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000050b0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2245    logger.info("E
+000050c0: 6e61 626c 6564 2053 616e 6462 6f78 2041  nabled Sandbox A
+000050d0: 5049 206f 6e20 2573 222c 206e 616d 6529  PI on %s", name)
+000050e0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000050f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00005100: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00005110: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00005120: 2020 2020 2020 2066 224e 6f20 5361 6e64         f"No Sand
+00005130: 626f 7820 5552 4c20 696e 2043 4358 5420  box URL in CCXT 
+00005140: 666f 7220 7b6e 616d 657d 2c20 6578 6974  for {name}, exit
+00005150: 696e 672e 2050 6c65 6173 6520 6368 6563  ing. Please chec
+00005160: 6b20 796f 7572 2063 6f6e 6669 672e 6a73  k your config.js
+00005170: 6f6e 2229 0a20 2020 2020 2020 2020 2020  on").           
+00005180: 2020 2020 2072 6169 7365 204f 7065 7261       raise Opera
+00005190: 7469 6f6e 616c 4578 6365 7074 696f 6e28  tionalException(
+000051a0: 6627 4578 6368 616e 6765 207b 6e61 6d65  f'Exchange {name
+000051b0: 7d20 646f 6573 206e 6f74 2070 726f 7669  } does not provi
+000051c0: 6465 2061 2073 616e 6462 6f78 2061 7069  de a sandbox api
+000051d0: 2729 0a0a 2020 2020 6465 6620 5f6c 6f61  ')..    def _loa
+000051e0: 645f 6173 796e 635f 6d61 726b 6574 7328  d_async_markets(
+000051f0: 7365 6c66 2c20 7265 6c6f 6164 3a20 626f  self, reload: bo
+00005200: 6f6c 203d 2046 616c 7365 2920 2d3e 204e  ol = False) -> N
+00005210: 6f6e 653a 0a20 2020 2020 2020 2074 7279  one:.        try
+00005220: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00005230: 2073 656c 662e 5f61 7069 5f61 7379 6e63   self._api_async
+00005240: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005250: 2020 7365 6c66 2e6c 6f6f 702e 7275 6e5f    self.loop.run_
+00005260: 756e 7469 6c5f 636f 6d70 6c65 7465 280a  until_complete(.
+00005270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005280: 2020 2020 7365 6c66 2e5f 6170 695f 6173      self._api_as
+00005290: 796e 632e 6c6f 6164 5f6d 6172 6b65 7473  ync.load_markets
+000052a0: 2872 656c 6f61 643d 7265 6c6f 6164 2c20  (reload=reload, 
+000052b0: 7061 7261 6d73 3d7b 7d29 290a 0a20 2020  params={}))..   
+000052c0: 2020 2020 2065 7863 6570 7420 2861 7379       except (asy
+000052d0: 6e63 696f 2e54 696d 656f 7574 4572 726f  ncio.TimeoutErro
+000052e0: 722c 2063 6378 742e 4261 7365 4572 726f  r, ccxt.BaseErro
+000052f0: 7229 2061 7320 653a 0a20 2020 2020 2020  r) as e:.       
+00005300: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
+00005310: 696e 6728 2743 6f75 6c64 206e 6f74 206c  ing('Could not l
+00005320: 6f61 6420 6173 796e 6320 6d61 726b 6574  oad async market
+00005330: 732e 2052 6561 736f 6e3a 2025 7327 2c20  s. Reason: %s', 
+00005340: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
+00005350: 6574 7572 6e0a 0a20 2020 2064 6566 205f  eturn..    def _
+00005360: 6c6f 6164 5f6d 6172 6b65 7473 2873 656c  load_markets(sel
+00005370: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
+00005380: 2020 2020 2222 2220 496e 6974 6961 6c69      """ Initiali
+00005390: 7a65 206d 6172 6b65 7473 2062 6f74 6820  ze markets both 
+000053a0: 7379 6e63 2061 6e64 2061 7379 6e63 2022  sync and async "
+000053b0: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
+000053c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000053d0: 2e5f 6d61 726b 6574 7320 3d20 7365 6c66  ._markets = self
+000053e0: 2e5f 6170 692e 6c6f 6164 5f6d 6172 6b65  ._api.load_marke
+000053f0: 7473 2870 6172 616d 733d 7b7d 290a 2020  ts(params={}).  
+00005400: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00005410: 6c6f 6164 5f61 7379 6e63 5f6d 6172 6b65  load_async_marke
+00005420: 7473 2829 0a20 2020 2020 2020 2020 2020  ts().           
+00005430: 2073 656c 662e 5f6c 6173 745f 6d61 726b   self._last_mark
+00005440: 6574 735f 7265 6672 6573 6820 3d20 6474  ets_refresh = dt
+00005450: 5f74 7328 290a 2020 2020 2020 2020 2020  _ts().          
+00005460: 2020 6966 2073 656c 662e 5f66 745f 6861    if self._ft_ha
+00005470: 735b 276e 6565 6473 5f74 7261 6469 6e67  s['needs_trading
+00005480: 5f66 6565 7327 5d3a 0a20 2020 2020 2020  _fees']:.       
+00005490: 2020 2020 2020 2020 2073 656c 662e 5f74           self._t
+000054a0: 7261 6469 6e67 5f66 6565 7320 3d20 7365  rading_fees = se
+000054b0: 6c66 2e66 6574 6368 5f74 7261 6469 6e67  lf.fetch_trading
+000054c0: 5f66 6565 7328 290a 0a20 2020 2020 2020  _fees()..       
+000054d0: 2065 7863 6570 7420 6363 7874 2e42 6173   except ccxt.Bas
+000054e0: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+000054f0: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
+00005500: 7469 6f6e 2827 556e 6162 6c65 2074 6f20  tion('Unable to 
+00005510: 696e 6974 6961 6c69 7a65 206d 6172 6b65  initialize marke
+00005520: 7473 2e27 290a 0a20 2020 2064 6566 2072  ts.')..    def r
+00005530: 656c 6f61 645f 6d61 726b 6574 7328 7365  eload_markets(se
+00005540: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
+00005550: 2020 2020 2022 2222 5265 6c6f 6164 206d       """Reload m
+00005560: 6172 6b65 7473 2062 6f74 6820 7379 6e63  arkets both sync
+00005570: 2061 6e64 2061 7379 6e63 2069 6620 7265   and async if re
+00005580: 6672 6573 6820 696e 7465 7276 616c 2068  fresh interval h
+00005590: 6173 2070 6173 7365 6420 2222 220a 2020  as passed """.  
+000055a0: 2020 2020 2020 2320 4368 6563 6b20 7768        # Check wh
+000055b0: 6574 6865 7220 6d61 726b 6574 7320 6861  ether markets ha
+000055c0: 7665 2074 6f20 6265 2072 656c 6f61 6465  ve to be reloade
+000055d0: 640a 2020 2020 2020 2020 6966 2028 7365  d.        if (se
+000055e0: 6c66 2e5f 6c61 7374 5f6d 6172 6b65 7473  lf._last_markets
+000055f0: 5f72 6566 7265 7368 203e 2030 2920 616e  _refresh > 0) an
+00005600: 6420 280a 2020 2020 2020 2020 2020 2020  d (.            
+00005610: 2020 2020 7365 6c66 2e5f 6c61 7374 5f6d      self._last_m
+00005620: 6172 6b65 7473 5f72 6566 7265 7368 202b  arkets_refresh +
+00005630: 2073 656c 662e 6d61 726b 6574 735f 7265   self.markets_re
+00005640: 6672 6573 685f 696e 7465 7276 616c 203e  fresh_interval >
+00005650: 2064 745f 7473 2829 293a 0a20 2020 2020   dt_ts()):.     
+00005660: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+00005670: 6e65 0a20 2020 2020 2020 206c 6f67 6765  ne.        logge
+00005680: 722e 6465 6275 6728 2250 6572 666f 726d  r.debug("Perform
+00005690: 696e 6720 7363 6865 6475 6c65 6420 6d61  ing scheduled ma
+000056a0: 726b 6574 2072 656c 6f61 642e 2e22 290a  rket reload..").
+000056b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000056c0: 2020 2020 2020 2020 2073 656c 662e 5f6d           self._m
+000056d0: 6172 6b65 7473 203d 2073 656c 662e 5f61  arkets = self._a
+000056e0: 7069 2e6c 6f61 645f 6d61 726b 6574 7328  pi.load_markets(
+000056f0: 7265 6c6f 6164 3d54 7275 652c 2070 6172  reload=True, par
+00005700: 616d 733d 7b7d 290a 2020 2020 2020 2020  ams={}).        
+00005710: 2020 2020 2320 416c 736f 2072 656c 6f61      # Also reloa
+00005720: 6420 6173 796e 6320 6d61 726b 6574 7320  d async markets 
+00005730: 746f 2061 766f 6964 2069 7373 7565 7320  to avoid issues 
+00005740: 7769 7468 206e 6577 6c79 206c 6973 7465  with newly liste
+00005750: 6420 7061 6972 730a 2020 2020 2020 2020  d pairs.        
+00005760: 2020 2020 7365 6c66 2e5f 6c6f 6164 5f61      self._load_a
+00005770: 7379 6e63 5f6d 6172 6b65 7473 2872 656c  sync_markets(rel
+00005780: 6f61 643d 5472 7565 290a 2020 2020 2020  oad=True).      
+00005790: 2020 2020 2020 7365 6c66 2e5f 6c61 7374        self._last
+000057a0: 5f6d 6172 6b65 7473 5f72 6566 7265 7368  _markets_refresh
+000057b0: 203d 2064 745f 7473 2829 0a20 2020 2020   = dt_ts().     
+000057c0: 2020 2020 2020 2073 656c 662e 6669 6c6c         self.fill
+000057d0: 5f6c 6576 6572 6167 655f 7469 6572 7328  _leverage_tiers(
+000057e0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+000057f0: 2063 6378 742e 4261 7365 4572 726f 723a   ccxt.BaseError:
+00005800: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00005810: 6765 722e 6578 6365 7074 696f 6e28 2243  ger.exception("C
+00005820: 6f75 6c64 206e 6f74 2072 656c 6f61 6420  ould not reload 
+00005830: 6d61 726b 6574 732e 2229 0a0a 2020 2020  markets.")..    
+00005840: 6465 6620 7661 6c69 6461 7465 5f73 7461  def validate_sta
+00005850: 6b65 6375 7272 656e 6379 2873 656c 662c  kecurrency(self,
+00005860: 2073 7461 6b65 5f63 7572 7265 6e63 793a   stake_currency:
+00005870: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+00005880: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00005890: 2020 2043 6865 636b 7320 7374 616b 652d     Checks stake-
+000058a0: 6375 7272 656e 6379 2061 6761 696e 7374  currency against
+000058b0: 2061 7661 696c 6162 6c65 2063 7572 7265   available curre
+000058c0: 6e63 6965 7320 6f6e 2074 6865 2065 7863  ncies on the exc
+000058d0: 6861 6e67 652e 0a20 2020 2020 2020 204f  hange..        O
+000058e0: 6e6c 7920 7275 6e73 206f 6e20 7374 6172  nly runs on star
+000058f0: 7475 702e 2049 6620 6d61 726b 6574 7320  tup. If markets 
+00005900: 6861 7665 206e 6f74 2062 6565 6e20 6c6f  have not been lo
+00005910: 6164 6564 2c20 7468 6572 6527 7320 6265  aded, there's be
+00005920: 656e 2061 2070 726f 626c 656d 2077 6974  en a problem wit
+00005930: 680a 2020 2020 2020 2020 7468 6520 636f  h.        the co
+00005940: 6e6e 6563 7469 6f6e 2074 6f20 7468 6520  nnection to the 
+00005950: 6578 6368 616e 6765 2e0a 2020 2020 2020  exchange..      
+00005960: 2020 3a70 6172 616d 2073 7461 6b65 5f63    :param stake_c
+00005970: 7572 7265 6e63 793a 2053 7461 6b65 2d63  urrency: Stake-c
+00005980: 7572 7265 6e63 7920 746f 2076 616c 6964  urrency to valid
+00005990: 6174 650a 2020 2020 2020 2020 3a72 6169  ate.        :rai
+000059a0: 7365 3a20 4f70 6572 6174 696f 6e61 6c45  se: OperationalE
+000059b0: 7863 6570 7469 6f6e 2069 6620 7374 616b  xception if stak
+000059c0: 652d 6375 7272 656e 6379 2069 7320 6e6f  e-currency is no
+000059d0: 7420 6176 6169 6c61 626c 652e 0a20 2020  t available..   
+000059e0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000059f0: 2069 6620 6e6f 7420 7365 6c66 2e5f 6d61   if not self._ma
+00005a00: 726b 6574 733a 0a20 2020 2020 2020 2020  rkets:.         
+00005a10: 2020 2072 6169 7365 204f 7065 7261 7469     raise Operati
+00005a20: 6f6e 616c 4578 6365 7074 696f 6e28 0a20  onalException(. 
+00005a30: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00005a40: 436f 756c 6420 6e6f 7420 6c6f 6164 206d  Could not load m
+00005a50: 6172 6b65 7473 2c20 7468 6572 6566 6f72  arkets, therefor
+00005a60: 6520 6361 6e6e 6f74 2073 7461 7274 2e20  e cannot start. 
+00005a70: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00005a80: 2020 2750 6c65 6173 6520 696e 7665 7374    'Please invest
+00005a90: 6967 6174 6520 7468 6520 6162 6f76 6520  igate the above 
+00005aa0: 6572 726f 7220 666f 7220 6d6f 7265 2064  error for more d
+00005ab0: 6574 6169 6c73 2e27 0a20 2020 2020 2020  etails.'.       
+00005ac0: 2020 2020 2029 0a20 2020 2020 2020 2071       ).        q
+00005ad0: 756f 7465 5f63 7572 7265 6e63 6965 7320  uote_currencies 
+00005ae0: 3d20 7365 6c66 2e67 6574 5f71 756f 7465  = self.get_quote
+00005af0: 5f63 7572 7265 6e63 6965 7328 290a 2020  _currencies().  
+00005b00: 2020 2020 2020 6966 2073 7461 6b65 5f63        if stake_c
+00005b10: 7572 7265 6e63 7920 6e6f 7420 696e 2071  urrency not in q
+00005b20: 756f 7465 5f63 7572 7265 6e63 6965 733a  uote_currencies:
+00005b30: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00005b40: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
+00005b50: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
+00005b60: 2020 2020 2020 2020 2066 227b 7374 616b           f"{stak
+00005b70: 655f 6375 7272 656e 6379 7d20 6973 206e  e_currency} is n
+00005b80: 6f74 2061 7661 696c 6162 6c65 2061 7320  ot available as 
+00005b90: 7374 616b 6520 6f6e 207b 7365 6c66 2e6e  stake on {self.n
+00005ba0: 616d 657d 2e20 220a 2020 2020 2020 2020  ame}. ".        
+00005bb0: 2020 2020 2020 2020 6622 4176 6169 6c61          f"Availa
+00005bc0: 626c 6520 6375 7272 656e 6369 6573 2061  ble currencies a
+00005bd0: 7265 3a20 7b27 2c20 272e 6a6f 696e 2871  re: {', '.join(q
+00005be0: 756f 7465 5f63 7572 7265 6e63 6965 7329  uote_currencies)
+00005bf0: 7d22 290a 0a20 2020 2064 6566 2076 616c  }")..    def val
+00005c00: 6964 6174 655f 7061 6972 7328 7365 6c66  idate_pairs(self
+00005c10: 2c20 7061 6972 733a 204c 6973 745b 7374  , pairs: List[st
+00005c20: 725d 2920 2d3e 204e 6f6e 653a 0a20 2020  r]) -> None:.   
+00005c30: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00005c40: 2043 6865 636b 7320 6966 2061 6c6c 2067   Checks if all g
+00005c50: 6976 656e 2070 6169 7273 2061 7265 2074  iven pairs are t
+00005c60: 7261 6461 626c 6520 6f6e 2074 6865 2063  radable on the c
+00005c70: 7572 7265 6e74 2065 7863 6861 6e67 652e  urrent exchange.
+00005c80: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00005c90: 7061 6972 733a 206c 6973 7420 6f66 2070  pairs: list of p
+00005ca0: 6169 7273 0a20 2020 2020 2020 203a 7261  airs.        :ra
+00005cb0: 6973 653a 204f 7065 7261 7469 6f6e 616c  ise: Operational
+00005cc0: 4578 6365 7074 696f 6e20 6966 206f 6e65  Exception if one
+00005cd0: 2070 6169 7220 6973 206e 6f74 2061 7661   pair is not ava
+00005ce0: 696c 6162 6c65 0a20 2020 2020 2020 203a  ilable.        :
+00005cf0: 7265 7475 726e 3a20 4e6f 6e65 0a20 2020  return: None.   
+00005d00: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00005d10: 2020 6966 206e 6f74 2073 656c 662e 6d61    if not self.ma
+00005d20: 726b 6574 733a 0a20 2020 2020 2020 2020  rkets:.         
+00005d30: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00005d40: 6728 2755 6e61 626c 6520 746f 2076 616c  g('Unable to val
+00005d50: 6964 6174 6520 7061 6972 7320 2861 7373  idate pairs (ass
+00005d60: 756d 696e 6720 7468 6579 2061 7265 2063  uming they are c
+00005d70: 6f72 7265 6374 292e 2729 0a20 2020 2020  orrect).').     
+00005d80: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00005d90: 2020 2020 2020 6578 7465 6e64 6564 5f70        extended_p
+00005da0: 6169 7273 203d 2065 7870 616e 645f 7061  airs = expand_pa
+00005db0: 6972 6c69 7374 2870 6169 7273 2c20 6c69  irlist(pairs, li
+00005dc0: 7374 2873 656c 662e 6d61 726b 6574 7329  st(self.markets)
+00005dd0: 2c20 6b65 6570 5f69 6e76 616c 6964 3d54  , keep_invalid=T
+00005de0: 7275 6529 0a20 2020 2020 2020 2069 6e76  rue).        inv
+00005df0: 616c 6964 5f70 6169 7273 203d 205b 5d0a  alid_pairs = [].
+00005e00: 2020 2020 2020 2020 666f 7220 7061 6972          for pair
+00005e10: 2069 6e20 6578 7465 6e64 6564 5f70 6169   in extended_pai
+00005e20: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+00005e30: 2320 4e6f 7465 3a20 6363 7874 2068 6173  # Note: ccxt has
+00005e40: 2042 6173 6543 7572 7265 6e63 792f 5175   BaseCurrency/Qu
+00005e50: 6f74 6543 7572 7265 6e63 7920 666f 726d  oteCurrency form
+00005e60: 6174 2066 6f72 2070 6169 7273 0a20 2020  at for pairs.   
+00005e70: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00005e80: 2e6d 6172 6b65 7473 2061 6e64 2070 6169  .markets and pai
+00005e90: 7220 6e6f 7420 696e 2073 656c 662e 6d61  r not in self.ma
+00005ea0: 726b 6574 733a 0a20 2020 2020 2020 2020  rkets:.         
+00005eb0: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
+00005ec0: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
+00005ed0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00005ee0: 2020 2020 2020 2066 2750 6169 7220 7b70         f'Pair {p
+00005ef0: 6169 727d 2069 7320 6e6f 7420 6176 6169  air} is not avai
+00005f00: 6c61 626c 6520 6f6e 207b 7365 6c66 2e6e  lable on {self.n
+00005f10: 616d 657d 207b 7365 6c66 2e74 7261 6469  ame} {self.tradi
+00005f20: 6e67 5f6d 6f64 652e 7661 6c75 657d 2e20  ng_mode.value}. 
+00005f30: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00005f40: 2020 2020 2020 6627 506c 6561 7365 2072        f'Please r
+00005f50: 656d 6f76 6520 7b70 6169 727d 2066 726f  emove {pair} fro
+00005f60: 6d20 796f 7572 2077 6869 7465 6c69 7374  m your whitelist
+00005f70: 2e27 290a 0a20 2020 2020 2020 2020 2020  .')..           
+00005f80: 2020 2020 2023 2046 726f 6d20 6363 7874       # From ccxt
+00005f90: 2044 6f63 756d 656e 7461 7469 6f6e 3a0a   Documentation:.
+00005fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005fb0: 2320 6d61 726b 6574 732e 696e 666f 3a20  # markets.info: 
+00005fc0: 416e 2061 7373 6f63 6961 7469 7665 2061  An associative a
+00005fd0: 7272 6179 206f 6620 6e6f 6e2d 636f 6d6d  rray of non-comm
+00005fe0: 6f6e 206d 6172 6b65 7420 7072 6f70 6572  on market proper
+00005ff0: 7469 6573 2c0a 2020 2020 2020 2020 2020  ties,.          
+00006000: 2020 2020 2020 2320 696e 636c 7564 696e        # includin
+00006010: 6720 6665 6573 2c20 7261 7465 732c 206c  g fees, rates, l
+00006020: 696d 6974 7320 616e 6420 6f74 6865 7220  imits and other 
+00006030: 6765 6e65 7261 6c20 6d61 726b 6574 2069  general market i
+00006040: 6e66 6f72 6d61 7469 6f6e 2e0a 2020 2020  nformation..    
+00006050: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+00006060: 6520 696e 7465 726e 616c 2069 6e66 6f20  e internal info 
+00006070: 6172 7261 7920 6973 2064 6966 6665 7265  array is differe
+00006080: 6e74 2066 6f72 2065 6163 6820 7061 7274  nt for each part
+00006090: 6963 756c 6172 206d 6172 6b65 742c 0a20  icular market,. 
+000060a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000060b0: 2069 7473 2063 6f6e 7465 6e74 7320 6465   its contents de
+000060c0: 7065 6e64 206f 6e20 7468 6520 6578 6368  pend on the exch
+000060d0: 616e 6765 2e0a 2020 2020 2020 2020 2020  ange..          
+000060e0: 2020 2020 2020 2320 4974 2063 616e 2061        # It can a
+000060f0: 6c73 6f20 6265 2061 2073 7472 696e 6720  lso be a string 
+00006100: 6f72 2073 696d 696c 6172 202e 2e2e 2073  or similar ... s
+00006110: 6f20 7765 206e 6565 6420 746f 2076 6572  o we need to ver
+00006120: 6966 7920 7468 6174 2066 6972 7374 2e0a  ify that first..
+00006130: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00006140: 2028 6973 696e 7374 616e 6365 2873 656c   (isinstance(sel
+00006150: 662e 6d61 726b 6574 735b 7061 6972 5d2e  f.markets[pair].
+00006160: 6765 7428 2769 6e66 6f27 292c 2064 6963  get('info'), dic
+00006170: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00006180: 2020 2020 2061 6e64 2073 656c 662e 6d61       and self.ma
+00006190: 726b 6574 735b 7061 6972 5d2e 6765 7428  rkets[pair].get(
+000061a0: 2769 6e66 6f27 2c20 7b7d 292e 6765 7428  'info', {}).get(
+000061b0: 2770 726f 6869 6269 7465 6449 6e27 2c20  'prohibitedIn', 
+000061c0: 4661 6c73 6529 293a 0a20 2020 2020 2020  False)):.       
+000061d0: 2020 2020 2020 2020 2023 2057 6172 6e20           # Warn 
+000061e0: 7573 6572 7320 6162 6f75 7420 7265 7374  users about rest
+000061f0: 7269 6374 6564 2070 6169 7273 2069 6e20  ricted pairs in 
+00006200: 7768 6974 656c 6973 742e 0a20 2020 2020  whitelist..     
+00006210: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
+00006220: 6361 6e6e 6f74 2064 6574 6572 6d69 6e65  cannot determine
+00006230: 2072 656c 6961 626c 7920 6966 2055 7365   reliably if Use
+00006240: 7273 2061 7265 2061 6666 6563 7465 642e  rs are affected.
+00006250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006260: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+00006270: 6622 5061 6972 207b 7061 6972 7d20 6973  f"Pair {pair} is
+00006280: 2072 6573 7472 6963 7465 6420 666f 7220   restricted for 
+00006290: 736f 6d65 2075 7365 7273 206f 6e20 7468  some users on th
+000062a0: 6973 2065 7863 6861 6e67 652e 220a 2020  is exchange.".  
+000062b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062c0: 2020 2020 2020 2020 2020 2020 2066 2250               f"P
+000062d0: 6c65 6173 6520 6368 6563 6b20 6966 2079  lease check if y
+000062e0: 6f75 2061 7265 2069 6d70 6163 7465 6420  ou are impacted 
+000062f0: 6279 2074 6869 7320 7265 7374 7269 6374  by this restrict
+00006300: 696f 6e20 220a 2020 2020 2020 2020 2020  ion ".          
+00006310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006320: 2020 2020 2066 226f 6e20 7468 6520 6578       f"on the ex
+00006330: 6368 616e 6765 2061 6e64 2065 7665 6e74  change and event
+00006340: 7561 6c6c 7920 7265 6d6f 7665 207b 7061  ually remove {pa
+00006350: 6972 7d20 6672 6f6d 2079 6f75 7220 7768  ir} from your wh
+00006360: 6974 656c 6973 742e 2229 0a20 2020 2020  itelist.").     
+00006370: 2020 2020 2020 2069 6620 2873 656c 662e         if (self.
+00006380: 5f63 6f6e 6669 675b 2773 7461 6b65 5f63  _config['stake_c
+00006390: 7572 7265 6e63 7927 5d20 616e 640a 2020  urrency'] and.  
+000063a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063b0: 2020 7365 6c66 2e67 6574 5f70 6169 725f    self.get_pair_
+000063c0: 7175 6f74 655f 6375 7272 656e 6379 2870  quote_currency(p
+000063d0: 6169 7229 2021 3d20 7365 6c66 2e5f 636f  air) != self._co
+000063e0: 6e66 6967 5b27 7374 616b 655f 6375 7272  nfig['stake_curr
+000063f0: 656e 6379 275d 293a 0a20 2020 2020 2020  ency']):.       
+00006400: 2020 2020 2020 2020 2069 6e76 616c 6964           invalid
+00006410: 5f70 6169 7273 2e61 7070 656e 6428 7061  _pairs.append(pa
+00006420: 6972 290a 2020 2020 2020 2020 6966 2069  ir).        if i
+00006430: 6e76 616c 6964 5f70 6169 7273 3a0a 2020  nvalid_pairs:.  
+00006440: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00006450: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
+00006460: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+00006470: 2020 2020 2020 6622 5374 616b 652d 6375        f"Stake-cu
+00006480: 7272 656e 6379 2027 7b73 656c 662e 5f63  rrency '{self._c
+00006490: 6f6e 6669 675b 2773 7461 6b65 5f63 7572  onfig['stake_cur
+000064a0: 7265 6e63 7927 5d7d 2720 6e6f 7420 636f  rency']}' not co
+000064b0: 6d70 6174 6962 6c65 2077 6974 6820 220a  mpatible with ".
+000064c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000064d0: 6622 7061 6972 2d77 6869 7465 6c69 7374  f"pair-whitelist
+000064e0: 2e20 506c 6561 7365 2072 656d 6f76 6520  . Please remove 
+000064f0: 7468 6520 666f 6c6c 6f77 696e 6720 7061  the following pa
+00006500: 6972 733a 207b 696e 7661 6c69 645f 7061  irs: {invalid_pa
+00006510: 6972 737d 2229 0a0a 2020 2020 6465 6620  irs}")..    def 
+00006520: 6765 745f 7661 6c69 645f 7061 6972 5f63  get_valid_pair_c
+00006530: 6f6d 6269 6e61 7469 6f6e 2873 656c 662c  ombination(self,
+00006540: 2063 7572 725f 313a 2073 7472 2c20 6375   curr_1: str, cu
+00006550: 7272 5f32 3a20 7374 7229 202d 3e20 7374  rr_2: str) -> st
+00006560: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
+00006570: 2020 2020 2020 2047 6574 2076 616c 6964         Get valid
+00006580: 2070 6169 7220 636f 6d62 696e 6174 696f   pair combinatio
+00006590: 6e20 6f66 2063 7572 725f 3120 616e 6420  n of curr_1 and 
+000065a0: 6375 7272 5f32 2062 7920 7472 7969 6e67  curr_2 by trying
+000065b0: 2062 6f74 6820 636f 6d62 696e 6174 696f   both combinatio
+000065c0: 6e73 2e0a 2020 2020 2020 2020 2222 220a  ns..        """.
+000065d0: 2020 2020 2020 2020 666f 7220 7061 6972          for pair
+000065e0: 2069 6e20 5b66 227b 6375 7272 5f31 7d2f   in [f"{curr_1}/
+000065f0: 7b63 7572 725f 327d 222c 2066 227b 6375  {curr_2}", f"{cu
+00006600: 7272 5f32 7d2f 7b63 7572 725f 317d 225d  rr_2}/{curr_1}"]
+00006610: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00006620: 2070 6169 7220 696e 2073 656c 662e 6d61   pair in self.ma
+00006630: 726b 6574 7320 616e 6420 7365 6c66 2e6d  rkets and self.m
+00006640: 6172 6b65 7473 5b70 6169 725d 2e67 6574  arkets[pair].get
+00006650: 2827 6163 7469 7665 2729 3a0a 2020 2020  ('active'):.    
+00006660: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00006670: 726e 2070 6169 720a 2020 2020 2020 2020  rn pair.        
+00006680: 7261 6973 6520 4578 6368 616e 6765 4572  raise ExchangeEr
+00006690: 726f 7228 6622 436f 756c 6420 6e6f 7420  ror(f"Could not 
+000066a0: 636f 6d62 696e 6520 7b63 7572 725f 317d  combine {curr_1}
+000066b0: 2061 6e64 207b 6375 7272 5f32 7d20 746f   and {curr_2} to
+000066c0: 2067 6574 2061 2076 616c 6964 2070 6169   get a valid pai
+000066d0: 722e 2229 0a0a 2020 2020 6465 6620 7661  r.")..    def va
+000066e0: 6c69 6461 7465 5f74 696d 6566 7261 6d65  lidate_timeframe
+000066f0: 7328 7365 6c66 2c20 7469 6d65 6672 616d  s(self, timefram
+00006700: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
+00006710: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00006720: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+00006730: 6865 636b 2069 6620 7469 6d65 6672 616d  heck if timefram
+00006740: 6520 6672 6f6d 2063 6f6e 6669 6720 6973  e from config is
+00006750: 2061 2073 7570 706f 7274 6564 2074 696d   a supported tim
+00006760: 6566 7261 6d65 206f 6e20 7468 6520 6578  eframe on the ex
+00006770: 6368 616e 6765 0a20 2020 2020 2020 2022  change.        "
+00006780: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+00006790: 7420 6861 7361 7474 7228 7365 6c66 2e5f  t hasattr(self._
+000067a0: 6170 692c 2022 7469 6d65 6672 616d 6573  api, "timeframes
+000067b0: 2229 206f 7220 7365 6c66 2e5f 6170 692e  ") or self._api.
+000067c0: 7469 6d65 6672 616d 6573 2069 7320 4e6f  timeframes is No
+000067d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000067e0: 2320 4966 2074 696d 6566 7261 6d65 7320  # If timeframes 
+000067f0: 6174 7472 6962 7574 6520 6973 206d 6973  attribute is mis
+00006800: 7369 6e67 2028 6f72 2069 7320 4e6f 6e65  sing (or is None
+00006810: 292c 2074 6865 2065 7863 6861 6e67 6520  ), the exchange 
+00006820: 7072 6f62 6162 6c79 0a20 2020 2020 2020  probably.       
+00006830: 2020 2020 2023 2068 6173 206e 6f20 6665       # has no fe
+00006840: 7463 684f 484c 4356 206d 6574 686f 642e  tchOHLCV method.
+00006850: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00006860: 6865 7265 666f 7265 2077 6520 616c 736f  herefore we also
+00006870: 2073 686f 7720 7468 6174 2e0a 2020 2020   show that..    
+00006880: 2020 2020 2020 2020 7261 6973 6520 4f70          raise Op
+00006890: 6572 6174 696f 6e61 6c45 7863 6570 7469  erationalExcepti
+000068a0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+000068b0: 2020 2020 6622 5468 6520 6363 7874 206c      f"The ccxt l
+000068c0: 6962 7261 7279 2064 6f65 7320 6e6f 7420  ibrary does not 
+000068d0: 7072 6f76 6964 6520 7468 6520 6c69 7374  provide the list
+000068e0: 206f 6620 7469 6d65 6672 616d 6573 2022   of timeframes "
+000068f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006900: 2066 2266 6f72 2074 6865 2065 7863 6861   f"for the excha
+00006910: 6e67 6520 7b73 656c 662e 6e61 6d65 7d20  nge {self.name} 
+00006920: 616e 6420 7468 6973 2065 7863 6861 6e67  and this exchang
+00006930: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+00006940: 2020 2020 6622 6973 2074 6865 7265 666f      f"is therefo
+00006950: 7265 206e 6f74 2073 7570 706f 7274 6564  re not supported
+00006960: 2e20 6363 7874 2066 6574 6368 4f48 4c43  . ccxt fetchOHLC
+00006970: 563a 207b 7365 6c66 2e65 7863 6861 6e67  V: {self.exchang
+00006980: 655f 6861 7328 2766 6574 6368 4f48 4c43  e_has('fetchOHLC
+00006990: 5627 297d 2229 0a0a 2020 2020 2020 2020  V')}")..        
+000069a0: 6966 2074 696d 6566 7261 6d65 2061 6e64  if timeframe and
+000069b0: 2028 7469 6d65 6672 616d 6520 6e6f 7420   (timeframe not 
+000069c0: 696e 2073 656c 662e 7469 6d65 6672 616d  in self.timefram
+000069d0: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
+000069e0: 2072 6169 7365 204f 7065 7261 7469 6f6e   raise Operation
+000069f0: 616c 4578 6365 7074 696f 6e28 0a20 2020  alException(.   
+00006a00: 2020 2020 2020 2020 2020 2020 2066 2249               f"I
+00006a10: 6e76 616c 6964 2074 696d 6566 7261 6d65  nvalid timeframe
+00006a20: 2027 7b74 696d 6566 7261 6d65 7d27 2e20   '{timeframe}'. 
+00006a30: 5468 6973 2065 7863 6861 6e67 6520 7375  This exchange su
+00006a40: 7070 6f72 7473 3a20 7b73 656c 662e 7469  pports: {self.ti
+00006a50: 6d65 6672 616d 6573 7d22 290a 0a20 2020  meframes}")..   
+00006a60: 2020 2020 2069 6620 7469 6d65 6672 616d       if timefram
+00006a70: 6520 616e 6420 7469 6d65 6672 616d 655f  e and timeframe_
+00006a80: 746f 5f6d 696e 7574 6573 2874 696d 6566  to_minutes(timef
+00006a90: 7261 6d65 2920 3c20 313a 0a20 2020 2020  rame) < 1:.     
+00006aa0: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
+00006ab0: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
+00006ac0: 6e28 2254 696d 6566 7261 6d65 7320 3c20  n("Timeframes < 
+00006ad0: 316d 2061 7265 2063 7572 7265 6e74 6c79  1m are currently
+00006ae0: 206e 6f74 2073 7570 706f 7274 6564 2062   not supported b
+00006af0: 7920 4672 6571 7472 6164 652e 2229 0a0a  y Freqtrade.")..
+00006b00: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
+00006b10: 5f6f 7264 6572 7479 7065 7328 7365 6c66  _ordertypes(self
+00006b20: 2c20 6f72 6465 725f 7479 7065 733a 2044  , order_types: D
+00006b30: 6963 7429 202d 3e20 4e6f 6e65 3a0a 2020  ict) -> None:.  
+00006b40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00006b50: 2020 4368 6563 6b73 2069 6620 6f72 6465    Checks if orde
+00006b60: 722d 7479 7065 7320 636f 6e66 6967 7572  r-types configur
+00006b70: 6564 2069 6e20 7374 7261 7465 6779 2f63  ed in strategy/c
+00006b80: 6f6e 6669 6720 6172 6520 7375 7070 6f72  onfig are suppor
+00006b90: 7465 640a 2020 2020 2020 2020 2222 220a  ted.        """.
+00006ba0: 2020 2020 2020 2020 6966 2061 6e79 2876          if any(v
+00006bb0: 203d 3d20 276d 6172 6b65 7427 2066 6f72   == 'market' for
+00006bc0: 206b 2c20 7620 696e 206f 7264 6572 5f74   k, v in order_t
+00006bd0: 7970 6573 2e69 7465 6d73 2829 293a 0a20  ypes.items()):. 
+00006be0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00006bf0: 7420 7365 6c66 2e65 7863 6861 6e67 655f  t self.exchange_
+00006c00: 6861 7328 2763 7265 6174 654d 6172 6b65  has('createMarke
+00006c10: 744f 7264 6572 2729 3a0a 2020 2020 2020  tOrder'):.      
+00006c20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00006c30: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
+00006c40: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+00006c50: 2020 2020 2020 2020 2020 6627 4578 6368            f'Exch
+00006c60: 616e 6765 207b 7365 6c66 2e6e 616d 657d  ange {self.name}
+00006c70: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00006c80: 7420 6d61 726b 6574 206f 7264 6572 732e  t market orders.
+00006c90: 2729 0a20 2020 2020 2020 2073 656c 662e  ').        self.
+00006ca0: 7661 6c69 6461 7465 5f73 746f 705f 6f72  validate_stop_or
+00006cb0: 6465 7274 7970 6573 286f 7264 6572 5f74  dertypes(order_t
+00006cc0: 7970 6573 290a 0a20 2020 2064 6566 2076  ypes)..    def v
+00006cd0: 616c 6964 6174 655f 7374 6f70 5f6f 7264  alidate_stop_ord
+00006ce0: 6572 7479 7065 7328 7365 6c66 2c20 6f72  ertypes(self, or
+00006cf0: 6465 725f 7479 7065 733a 2044 6963 7429  der_types: Dict)
+00006d00: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00006d10: 2020 2222 220a 2020 2020 2020 2020 5661    """.        Va
+00006d20: 6c69 6461 7465 2073 746f 706c 6f73 7320  lidate stoploss 
+00006d30: 6f72 6465 7220 7479 7065 730a 2020 2020  order types.    
+00006d40: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00006d50: 6966 2028 6f72 6465 725f 7479 7065 732e  if (order_types.
+00006d60: 6765 7428 2273 746f 706c 6f73 735f 6f6e  get("stoploss_on
+00006d70: 5f65 7863 6861 6e67 6522 290a 2020 2020  _exchange").    
+00006d80: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00006d90: 6e6f 7420 7365 6c66 2e5f 6674 5f68 6173  not self._ft_has
+00006da0: 2e67 6574 2822 7374 6f70 6c6f 7373 5f6f  .get("stoploss_o
+00006db0: 6e5f 6578 6368 616e 6765 222c 2046 616c  n_exchange", Fal
+00006dc0: 7365 2929 3a0a 2020 2020 2020 2020 2020  se)):.          
+00006dd0: 2020 7261 6973 6520 4f70 6572 6174 696f    raise Operatio
+00006de0: 6e61 6c45 7863 6570 7469 6f6e 280a 2020  nalException(.  
+00006df0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00006e00: 4f6e 2065 7863 6861 6e67 6520 7374 6f70  On exchange stop
+00006e10: 6c6f 7373 2069 7320 6e6f 7420 7375 7070  loss is not supp
+00006e20: 6f72 7465 6420 666f 7220 7b73 656c 662e  orted for {self.
+00006e30: 6e61 6d65 7d2e 270a 2020 2020 2020 2020  name}.'.        
+00006e40: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+00006e50: 2073 656c 662e 7472 6164 696e 675f 6d6f   self.trading_mo
+00006e60: 6465 203d 3d20 5472 6164 696e 674d 6f64  de == TradingMod
+00006e70: 652e 4655 5455 5245 533a 0a20 2020 2020  e.FUTURES:.     
+00006e80: 2020 2020 2020 2070 7269 6365 5f6d 6170         price_map
+00006e90: 7069 6e67 203d 2073 656c 662e 5f66 745f  ping = self._ft_
+00006ea0: 6861 732e 6765 7428 2773 746f 705f 7072  has.get('stop_pr
+00006eb0: 6963 655f 7479 7065 5f76 616c 7565 5f6d  ice_type_value_m
+00006ec0: 6170 7069 6e67 272c 207b 7d29 2e6b 6579  apping', {}).key
+00006ed0: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00006ee0: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
+00006ef0: 2020 2020 206f 7264 6572 5f74 7970 6573       order_types
+00006f00: 2e67 6574 2822 7374 6f70 6c6f 7373 5f6f  .get("stoploss_o
+00006f10: 6e5f 6578 6368 616e 6765 222c 2046 616c  n_exchange", Fal
+00006f20: 7365 2920 6973 2054 7275 650a 2020 2020  se) is True.    
+00006f30: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00006f40: 2773 746f 706c 6f73 735f 7072 6963 655f  'stoploss_price_
+00006f50: 7479 7065 2720 696e 206f 7264 6572 5f74  type' in order_t
+00006f60: 7970 6573 0a20 2020 2020 2020 2020 2020  ypes.           
+00006f70: 2020 2020 2061 6e64 206f 7264 6572 5f74       and order_t
+00006f80: 7970 6573 5b27 7374 6f70 6c6f 7373 5f70  ypes['stoploss_p
+00006f90: 7269 6365 5f74 7970 6527 5d20 6e6f 7420  rice_type'] not 
+00006fa0: 696e 2070 7269 6365 5f6d 6170 7069 6e67  in price_mapping
+00006fb0: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
+00006fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006fd0: 7261 6973 6520 4f70 6572 6174 696f 6e61  raise Operationa
+00006fe0: 6c45 7863 6570 7469 6f6e 280a 2020 2020  lException(.    
+00006ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007000: 6627 4f6e 2065 7863 6861 6e67 6520 7374  f'On exchange st
+00007010: 6f70 6c6f 7373 2070 7269 6365 2074 7970  oploss price typ
+00007020: 6520 6973 206e 6f74 2073 7570 706f 7274  e is not support
+00007030: 6564 2066 6f72 207b 7365 6c66 2e6e 616d  ed for {self.nam
+00007040: 657d 2e27 0a20 2020 2020 2020 2020 2020  e}.'.           
+00007050: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+00007060: 7661 6c69 6461 7465 5f70 7269 6369 6e67  validate_pricing
+00007070: 2873 656c 662c 2070 7269 6369 6e67 3a20  (self, pricing: 
+00007080: 4469 6374 2920 2d3e 204e 6f6e 653a 0a20  Dict) -> None:. 
+00007090: 2020 2020 2020 2069 6620 7072 6963 696e         if pricin
+000070a0: 672e 6765 7428 2775 7365 5f6f 7264 6572  g.get('use_order
+000070b0: 5f62 6f6f 6b27 2c20 4661 6c73 6529 2061  _book', False) a
+000070c0: 6e64 206e 6f74 2073 656c 662e 6578 6368  nd not self.exch
+000070d0: 616e 6765 5f68 6173 2827 6665 7463 684c  ange_has('fetchL
+000070e0: 324f 7264 6572 426f 6f6b 2729 3a0a 2020  2OrderBook'):.  
+000070f0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00007100: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
+00007110: 7469 6f6e 2866 274f 7264 6572 626f 6f6b  tion(f'Orderbook
+00007120: 206e 6f74 2061 7661 696c 6162 6c65 2066   not available f
+00007130: 6f72 207b 7365 6c66 2e6e 616d 657d 2e27  or {self.name}.'
+00007140: 290a 2020 2020 2020 2020 6966 2028 6e6f  ).        if (no
+00007150: 7420 7072 6963 696e 672e 6765 7428 2775  t pricing.get('u
+00007160: 7365 5f6f 7264 6572 5f62 6f6f 6b27 2c20  se_order_book', 
+00007170: 4661 6c73 6529 2061 6e64 2028 0a20 2020  False) and (.   
+00007180: 2020 2020 2020 2020 2020 2020 206e 6f74               not
+00007190: 2073 656c 662e 6578 6368 616e 6765 5f68   self.exchange_h
+000071a0: 6173 2827 6665 7463 6854 6963 6b65 7227  as('fetchTicker'
+000071b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000071c0: 2020 6f72 206e 6f74 2073 656c 662e 5f66    or not self._f
+000071d0: 745f 6861 735b 2774 6963 6b65 7273 5f68  t_has['tickers_h
+000071e0: 6176 655f 7072 6963 6527 5d29 293a 0a20  ave_price'])):. 
+000071f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00007200: 204f 7065 7261 7469 6f6e 616c 4578 6365   OperationalExce
+00007210: 7074 696f 6e28 6627 5469 636b 6572 2070  ption(f'Ticker p
+00007220: 7269 6369 6e67 206e 6f74 2061 7661 696c  ricing not avail
+00007230: 6162 6c65 2066 6f72 207b 7365 6c66 2e6e  able for {self.n
+00007240: 616d 657d 2e27 290a 0a20 2020 2064 6566  ame}.')..    def
+00007250: 2076 616c 6964 6174 655f 6f72 6465 725f   validate_order_
+00007260: 7469 6d65 5f69 6e5f 666f 7263 6528 7365  time_in_force(se
+00007270: 6c66 2c20 6f72 6465 725f 7469 6d65 5f69  lf, order_time_i
+00007280: 6e5f 666f 7263 653a 2044 6963 7429 202d  n_force: Dict) -
+00007290: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000072a0: 2222 220a 2020 2020 2020 2020 4368 6563  """.        Chec
+000072b0: 6b73 2069 6620 6f72 6465 7220 7469 6d65  ks if order time
+000072c0: 2069 6e20 666f 7263 6520 636f 6e66 6967   in force config
+000072d0: 7572 6564 2069 6e20 7374 7261 7465 6779  ured in strategy
+000072e0: 2f63 6f6e 6669 6720 6172 6520 7375 7070  /config are supp
+000072f0: 6f72 7465 640a 2020 2020 2020 2020 2222  orted.        ""
+00007300: 220a 2020 2020 2020 2020 6966 2061 6e79  ".        if any
+00007310: 2876 2e75 7070 6572 2829 206e 6f74 2069  (v.upper() not i
+00007320: 6e20 7365 6c66 2e5f 6674 5f68 6173 5b22  n self._ft_has["
+00007330: 6f72 6465 725f 7469 6d65 5f69 6e5f 666f  order_time_in_fo
+00007340: 7263 6522 5d0a 2020 2020 2020 2020 2020  rce"].          
+00007350: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
+00007360: 206f 7264 6572 5f74 696d 655f 696e 5f66   order_time_in_f
+00007370: 6f72 6365 2e69 7465 6d73 2829 293a 0a20  orce.items()):. 
+00007380: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00007390: 204f 7065 7261 7469 6f6e 616c 4578 6365   OperationalExce
+000073a0: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
+000073b0: 2020 2020 2020 2066 2754 696d 6520 696e         f'Time in
+000073c0: 2066 6f72 6365 2070 6f6c 6963 6965 7320   force policies 
+000073d0: 6172 6520 6e6f 7420 7375 7070 6f72 7465  are not supporte
+000073e0: 6420 666f 7220 7b73 656c 662e 6e61 6d65  d for {self.name
+000073f0: 7d20 7965 742e 2729 0a0a 2020 2020 6465  } yet.')..    de
+00007400: 6620 7661 6c69 6461 7465 5f72 6571 7569  f validate_requi
+00007410: 7265 645f 7374 6172 7475 705f 6361 6e64  red_startup_cand
+00007420: 6c65 7328 7365 6c66 2c20 7374 6172 7475  les(self, startu
+00007430: 705f 6361 6e64 6c65 733a 2069 6e74 2c20  p_candles: int, 
+00007440: 7469 6d65 6672 616d 653a 2073 7472 2920  timeframe: str) 
+00007450: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
+00007460: 2222 220a 2020 2020 2020 2020 4368 6563  """.        Chec
+00007470: 6b73 2069 6620 7265 7175 6972 6564 2073  ks if required s
+00007480: 7461 7274 7570 5f63 616e 646c 6573 2069  tartup_candles i
+00007490: 7320 6d6f 7265 2074 6861 6e20 6f68 6c63  s more than ohlc
+000074a0: 765f 6361 6e64 6c65 5f6c 696d 6974 2829  v_candle_limit()
+000074b0: 2e0a 2020 2020 2020 2020 5265 7175 6972  ..        Requir
+000074c0: 6573 2061 2067 7261 6365 2d70 6572 696f  es a grace-perio
+000074d0: 6420 6f66 2035 2063 616e 646c 6573 202d  d of 5 candles -
+000074e0: 2073 6f20 6120 7374 6172 7475 702d 7065   so a startup-pe
+000074f0: 7269 6f64 2075 7020 746f 2034 3934 2069  riod up to 494 i
+00007500: 7320 616c 6c6f 7765 6420 6279 2064 6566  s allowed by def
+00007510: 6175 6c74 2e0a 2020 2020 2020 2020 2222  ault..        ""
+00007520: 220a 0a20 2020 2020 2020 2063 616e 646c  "..        candl
+00007530: 655f 6c69 6d69 7420 3d20 7365 6c66 2e6f  e_limit = self.o
+00007540: 686c 6376 5f63 616e 646c 655f 6c69 6d69  hlcv_candle_limi
+00007550: 7428 0a20 2020 2020 2020 2020 2020 2074  t(.            t
+00007560: 696d 6566 7261 6d65 2c20 7365 6c66 2e5f  imeframe, self._
+00007570: 636f 6e66 6967 5b27 6361 6e64 6c65 5f74  config['candle_t
+00007580: 7970 655f 6465 6627 5d2c 0a20 2020 2020  ype_def'],.     
+00007590: 2020 2020 2020 2069 6e74 2864 6174 655f         int(date_
+000075a0: 6d69 6e75 735f 6361 6e64 6c65 7328 7469  minus_candles(ti
+000075b0: 6d65 6672 616d 652c 2073 7461 7274 7570  meframe, startup
+000075c0: 5f63 616e 646c 6573 292e 7469 6d65 7374  _candles).timest
+000075d0: 616d 7028 2920 2a20 3130 3030 290a 2020  amp() * 1000).  
+000075e0: 2020 2020 2020 2020 2020 6966 2074 696d            if tim
+000075f0: 6566 7261 6d65 2065 6c73 6520 4e6f 6e65  eframe else None
+00007600: 290a 2020 2020 2020 2020 2320 5265 7175  ).        # Requ
+00007610: 6972 6520 6f6e 6520 6d6f 7265 2063 616e  ire one more can
+00007620: 646c 6520 2d20 746f 2061 6363 6f75 6e74  dle - to account
+00007630: 2066 6f72 2074 6865 2073 7469 6c6c 206f   for the still o
+00007640: 7065 6e20 6361 6e64 6c65 2e0a 2020 2020  pen candle..    
+00007650: 2020 2020 6361 6e64 6c65 5f63 6f75 6e74      candle_count
+00007660: 203d 2073 7461 7274 7570 5f63 616e 646c   = startup_candl
+00007670: 6573 202b 2031 0a20 2020 2020 2020 2023  es + 1.        #
+00007680: 2041 6c6c 6f77 2035 2063 616c 6c73 2074   Allow 5 calls t
+00007690: 6f20 7468 6520 6578 6368 616e 6765 2070  o the exchange p
+000076a0: 6572 2070 6169 720a 2020 2020 2020 2020  er pair.        
+000076b0: 7265 7175 6972 6564 5f63 616e 646c 655f  required_candle_
+000076c0: 6361 6c6c 5f63 6f75 6e74 203d 2069 6e74  call_count = int
+000076d0: 280a 2020 2020 2020 2020 2020 2020 2863  (.            (c
+000076e0: 616e 646c 655f 636f 756e 7420 2f20 6361  andle_count / ca
+000076f0: 6e64 6c65 5f6c 696d 6974 2920 2b20 2830  ndle_limit) + (0
+00007700: 2069 6620 6361 6e64 6c65 5f63 6f75 6e74   if candle_count
+00007710: 2025 2063 616e 646c 655f 6c69 6d69 7420   % candle_limit 
+00007720: 3d3d 2030 2065 6c73 6520 3129 290a 2020  == 0 else 1)).  
+00007730: 2020 2020 2020 6966 2073 656c 662e 5f66        if self._f
+00007740: 745f 6861 735b 276f 686c 6376 5f68 6173  t_has['ohlcv_has
+00007750: 5f68 6973 746f 7279 275d 3a0a 0a20 2020  _history']:..   
+00007760: 2020 2020 2020 2020 2069 6620 7265 7175           if requ
+00007770: 6972 6564 5f63 616e 646c 655f 6361 6c6c  ired_candle_call
+00007780: 5f63 6f75 6e74 203e 2035 3a0a 2020 2020  _count > 5:.    
+00007790: 2020 2020 2020 2020 2020 2020 2320 4f6e              # On
+000077a0: 6c79 2061 6c6c 6f77 2035 2063 616c 6c73  ly allow 5 calls
+000077b0: 2070 6572 2070 6169 7220 746f 2073 6f6d   per pair to som
+000077c0: 6577 6861 7420 6c69 6d69 7420 7468 6520  ewhat limit the 
+000077d0: 696d 7061 6374 0a20 2020 2020 2020 2020  impact.         
+000077e0: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
+000077f0: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
+00007800: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00007810: 2020 2020 2020 2066 2254 6869 7320 7374         f"This st
+00007820: 7261 7465 6779 2072 6571 7569 7265 7320  rategy requires 
+00007830: 7b73 7461 7274 7570 5f63 616e 646c 6573  {startup_candles
+00007840: 7d20 6361 6e64 6c65 7320 746f 2073 7461  } candles to sta
+00007850: 7274 2c20 220a 2020 2020 2020 2020 2020  rt, ".          
+00007860: 2020 2020 2020 2020 2020 2277 6869 6368            "which
+00007870: 2069 7320 6d6f 7265 2074 6861 6e20 3578   is more than 5x
+00007880: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00007890: 2020 2020 2020 2066 2274 6865 2061 6d6f         f"the amo
+000078a0: 756e 7420 6f66 2063 616e 646c 6573 207b  unt of candles {
+000078b0: 7365 6c66 2e6e 616d 657d 2070 726f 7669  self.name} provi
+000078c0: 6465 7320 666f 7220 7b74 696d 6566 7261  des for {timefra
+000078d0: 6d65 7d2e 2229 0a20 2020 2020 2020 2065  me}.").        e
+000078e0: 6c69 6620 7265 7175 6972 6564 5f63 616e  lif required_can
+000078f0: 646c 655f 6361 6c6c 5f63 6f75 6e74 203e  dle_call_count >
+00007900: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00007910: 7261 6973 6520 4f70 6572 6174 696f 6e61  raise Operationa
+00007920: 6c45 7863 6570 7469 6f6e 280a 2020 2020  lException(.    
+00007930: 2020 2020 2020 2020 2020 2020 6622 5468              f"Th
+00007940: 6973 2073 7472 6174 6567 7920 7265 7175  is strategy requ
+00007950: 6972 6573 207b 7374 6172 7475 705f 6361  ires {startup_ca
+00007960: 6e64 6c65 737d 2063 616e 646c 6573 2074  ndles} candles t
+00007970: 6f20 7374 6172 742c 2077 6869 6368 2069  o start, which i
+00007980: 7320 6d6f 7265 2074 6861 6e20 220a 2020  s more than ".  
+00007990: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000079a0: 7468 6520 616d 6f75 6e74 206f 6620 6361  the amount of ca
+000079b0: 6e64 6c65 7320 7b73 656c 662e 6e61 6d65  ndles {self.name
+000079c0: 7d20 7072 6f76 6964 6573 2066 6f72 207b  } provides for {
+000079d0: 7469 6d65 6672 616d 657d 2e22 290a 2020  timeframe}.").  
+000079e0: 2020 2020 2020 6966 2072 6571 7569 7265        if require
+000079f0: 645f 6361 6e64 6c65 5f63 616c 6c5f 636f  d_candle_call_co
+00007a00: 756e 7420 3e20 313a 0a20 2020 2020 2020  unt > 1:.       
+00007a10: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
+00007a20: 696e 6728 6622 5573 696e 6720 7b72 6571  ing(f"Using {req
+00007a30: 7569 7265 645f 6361 6e64 6c65 5f63 616c  uired_candle_cal
+00007a40: 6c5f 636f 756e 747d 2063 616c 6c73 2074  l_count} calls t
+00007a50: 6f20 6765 7420 4f48 4c43 562e 2022 0a20  o get OHLCV. ". 
+00007a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a70: 2020 2020 2020 2020 2020 6622 5468 6973            f"This
+00007a80: 2063 616e 2072 6573 756c 7420 696e 2073   can result in s
+00007a90: 6c6f 7765 7220 6f70 6572 6174 696f 6e73  lower operations
+00007aa0: 2066 6f72 2074 6865 2062 6f74 2e20 506c   for the bot. Pl
+00007ab0: 6561 7365 2063 6865 636b 2022 0a20 2020  ease check ".   
+00007ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ad0: 2020 2020 2020 2020 6622 6966 2079 6f75          f"if you
+00007ae0: 2072 6561 6c6c 7920 6e65 6564 207b 7374   really need {st
+00007af0: 6172 7475 705f 6361 6e64 6c65 737d 2063  artup_candles} c
+00007b00: 616e 646c 6573 2066 6f72 2079 6f75 7220  andles for your 
+00007b10: 7374 7261 7465 6779 2229 0a20 2020 2020  strategy").     
+00007b20: 2020 2072 6574 7572 6e20 7265 7175 6972     return requir
+00007b30: 6564 5f63 616e 646c 655f 6361 6c6c 5f63  ed_candle_call_c
+00007b40: 6f75 6e74 0a0a 2020 2020 6465 6620 7661  ount..    def va
+00007b50: 6c69 6461 7465 5f74 7261 6469 6e67 5f6d  lidate_trading_m
+00007b60: 6f64 655f 616e 645f 6d61 7267 696e 5f6d  ode_and_margin_m
+00007b70: 6f64 6528 0a20 2020 2020 2020 2073 656c  ode(.        sel
+00007b80: 662c 0a20 2020 2020 2020 2074 7261 6469  f,.        tradi
+00007b90: 6e67 5f6d 6f64 653a 2054 7261 6469 6e67  ng_mode: Trading
+00007ba0: 4d6f 6465 2c0a 2020 2020 2020 2020 6d61  Mode,.        ma
+00007bb0: 7267 696e 5f6d 6f64 653a 204f 7074 696f  rgin_mode: Optio
+00007bc0: 6e61 6c5b 4d61 7267 696e 4d6f 6465 5d20  nal[MarginMode] 
+00007bd0: 2023 204f 6e6c 7920 4e6f 6e65 2077 6865   # Only None whe
+00007be0: 6e20 7472 6164 696e 675f 6d6f 6465 203d  n trading_mode =
+00007bf0: 2054 7261 6469 6e67 4d6f 6465 2e53 504f   TradingMode.SPO
+00007c00: 540a 2020 2020 293a 0a20 2020 2020 2020  T.    ):.       
+00007c10: 2022 2222 0a20 2020 2020 2020 2043 6865   """.        Che
+00007c20: 636b 7320 6966 2066 7265 7174 7261 6465  cks if freqtrade
+00007c30: 2063 616e 2070 6572 666f 726d 2074 7261   can perform tra
+00007c40: 6465 7320 7573 696e 6720 7468 6520 636f  des using the co
+00007c50: 6e66 6967 7572 6564 0a20 2020 2020 2020  nfigured.       
+00007c60: 2074 7261 6469 6e67 206d 6f64 6528 4d61   trading mode(Ma
+00007c70: 7267 696e 2c20 4675 7475 7265 7329 2061  rgin, Futures) a
+00007c80: 6e64 204d 6172 6769 6e4d 6f64 6528 4372  nd MarginMode(Cr
+00007c90: 6f73 732c 2049 736f 6c61 7465 6429 0a20  oss, Isolated). 
+00007ca0: 2020 2020 2020 2054 6872 6f77 7320 4f70         Throws Op
+00007cb0: 6572 6174 696f 6e61 6c45 7863 6570 7469  erationalExcepti
+00007cc0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00007cd0: 4966 2074 6865 2074 7261 6469 6e67 5f6d  If the trading_m
+00007ce0: 6f64 652f 6d61 7267 696e 5f6d 6f64 6520  ode/margin_mode 
+00007cf0: 7479 7065 2061 7265 206e 6f74 2073 7570  type are not sup
+00007d00: 706f 7274 6564 2062 7920 6672 6571 7472  ported by freqtr
+00007d10: 6164 6520 6f6e 2074 6869 7320 6578 6368  ade on this exch
+00007d20: 616e 6765 0a20 2020 2020 2020 2022 2222  ange.        """
+00007d30: 0a20 2020 2020 2020 2069 6620 7472 6164  .        if trad
+00007d40: 696e 675f 6d6f 6465 2021 3d20 5472 6164  ing_mode != Trad
+00007d50: 696e 674d 6f64 652e 5350 4f54 2061 6e64  ingMode.SPOT and
+00007d60: 2028 0a20 2020 2020 2020 2020 2020 2028   (.            (
+00007d70: 7472 6164 696e 675f 6d6f 6465 2c20 6d61  trading_mode, ma
+00007d80: 7267 696e 5f6d 6f64 6529 206e 6f74 2069  rgin_mode) not i
+00007d90: 6e20 7365 6c66 2e5f 7375 7070 6f72 7465  n self._supporte
+00007da0: 645f 7472 6164 696e 675f 6d6f 6465 5f6d  d_trading_mode_m
+00007db0: 6172 6769 6e5f 7061 6972 730a 2020 2020  argin_pairs.    
+00007dc0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+00007dd0: 2020 206d 6d5f 7661 6c75 6520 3d20 6d61     mm_value = ma
+00007de0: 7267 696e 5f6d 6f64 6520 616e 6420 6d61  rgin_mode and ma
+00007df0: 7267 696e 5f6d 6f64 652e 7661 6c75 650a  rgin_mode.value.
+00007e00: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00007e10: 6520 4f70 6572 6174 696f 6e61 6c45 7863  e OperationalExc
+00007e20: 6570 7469 6f6e 280a 2020 2020 2020 2020  eption(.        
+00007e30: 2020 2020 2020 2020 6622 4672 6571 7472          f"Freqtr
+00007e40: 6164 6520 646f 6573 206e 6f74 2073 7570  ade does not sup
+00007e50: 706f 7274 207b 6d6d 5f76 616c 7565 7d20  port {mm_value} 
+00007e60: 7b74 7261 6469 6e67 5f6d 6f64 652e 7661  {trading_mode.va
+00007e70: 6c75 657d 206f 6e20 7b73 656c 662e 6e61  lue} on {self.na
+00007e80: 6d65 7d22 0a20 2020 2020 2020 2020 2020  me}".           
+00007e90: 2029 0a0a 2020 2020 6465 6620 6765 745f   )..    def get_
+00007ea0: 6f70 7469 6f6e 2873 656c 662c 2070 6172  option(self, par
+00007eb0: 616d 3a20 7374 722c 2064 6566 6175 6c74  am: str, default
+00007ec0: 3a20 4f70 7469 6f6e 616c 5b41 6e79 5d20  : Optional[Any] 
+00007ed0: 3d20 4e6f 6e65 2920 2d3e 2041 6e79 3a0a  = None) -> Any:.
+00007ee0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00007ef0: 2020 2020 4765 7420 7061 7261 6d65 7465      Get paramete
+00007f00: 7220 7661 6c75 6520 6672 6f6d 205f 6674  r value from _ft
+00007f10: 5f68 6173 0a20 2020 2020 2020 2022 2222  _has.        """
+00007f20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00007f30: 7365 6c66 2e5f 6674 5f68 6173 2e67 6574  self._ft_has.get
+00007f40: 2870 6172 616d 2c20 6465 6661 756c 7429  (param, default)
+00007f50: 0a0a 2020 2020 6465 6620 6578 6368 616e  ..    def exchan
+00007f60: 6765 5f68 6173 2873 656c 662c 2065 6e64  ge_has(self, end
+00007f70: 706f 696e 743a 2073 7472 2920 2d3e 2062  point: str) -> b
+00007f80: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
+00007f90: 0a20 2020 2020 2020 2043 6865 636b 7320  .        Checks 
+00007fa0: 6966 2065 7863 6861 6e67 6520 696d 706c  if exchange impl
+00007fb0: 656d 656e 7473 2061 2073 7065 6369 6669  ements a specifi
+00007fc0: 6320 4150 4920 656e 6470 6f69 6e74 2e0a  c API endpoint..
+00007fd0: 2020 2020 2020 2020 5772 6170 7065 7220          Wrapper 
+00007fe0: 6172 6f75 6e64 2063 6378 7420 2768 6173  around ccxt 'has
+00007ff0: 2720 6174 7472 6962 7574 650a 2020 2020  ' attribute.    
+00008000: 2020 2020 3a70 6172 616d 2065 6e64 706f      :param endpo
+00008010: 696e 743a 204e 616d 6520 6f66 2065 6e64  int: Name of end
+00008020: 706f 696e 7420 2865 2e67 2e20 2766 6574  point (e.g. 'fet
+00008030: 6368 4f48 4c43 5627 2c20 2766 6574 6368  chOHLCV', 'fetch
+00008040: 5469 636b 6572 7327 290a 2020 2020 2020  Tickers').      
+00008050: 2020 3a72 6574 7572 6e3a 2062 6f6f 6c0a    :return: bool.
+00008060: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00008070: 2020 2020 7265 7475 726e 2065 6e64 706f      return endpo
+00008080: 696e 7420 696e 2073 656c 662e 5f61 7069  int in self._api
+00008090: 2e68 6173 2061 6e64 2073 656c 662e 5f61  .has and self._a
+000080a0: 7069 2e68 6173 5b65 6e64 706f 696e 745d  pi.has[endpoint]
+000080b0: 0a0a 2020 2020 6465 6620 6765 745f 7072  ..    def get_pr
+000080c0: 6563 6973 696f 6e5f 616d 6f75 6e74 2873  ecision_amount(s
+000080d0: 656c 662c 2070 6169 723a 2073 7472 2920  elf, pair: str) 
+000080e0: 2d3e 204f 7074 696f 6e61 6c5b 666c 6f61  -> Optional[floa
+000080f0: 745d 3a0a 2020 2020 2020 2020 2222 220a  t]:.        """.
+00008100: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+00008110: 7468 6520 616d 6f75 6e74 2070 7265 6369  the amount preci
+00008120: 7369 6f6e 206f 6620 7468 6520 6578 6368  sion of the exch
+00008130: 616e 6765 2e0a 2020 2020 2020 2020 3a70  ange..        :p
+00008140: 6172 616d 2070 6169 723a 2050 6169 7220  aram pair: Pair 
+00008150: 746f 2067 6574 2070 7265 6369 7369 6f6e  to get precision
+00008160: 2066 6f72 0a20 2020 2020 2020 203a 7265   for.        :re
+00008170: 7475 726e 3a20 7072 6563 6973 696f 6e20  turn: precision 
+00008180: 666f 7220 616d 6f75 6e74 206f 7220 4e6f  for amount or No
+00008190: 6e65 2e20 4d75 7374 2062 6520 7573 6564  ne. Must be used
+000081a0: 2069 6e20 636f 6d62 696e 6174 696f 6e20   in combination 
+000081b0: 7769 7468 2070 7265 6369 7369 6f6e 4d6f  with precisionMo
+000081c0: 6465 0a20 2020 2020 2020 2022 2222 0a20  de.        """. 
+000081d0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000081e0: 6c66 2e6d 6172 6b65 7473 2e67 6574 2870  lf.markets.get(p
+000081f0: 6169 722c 207b 7d29 2e67 6574 2827 7072  air, {}).get('pr
+00008200: 6563 6973 696f 6e27 2c20 7b7d 292e 6765  ecision', {}).ge
+00008210: 7428 2761 6d6f 756e 7427 2c20 4e6f 6e65  t('amount', None
+00008220: 290a 0a20 2020 2064 6566 2067 6574 5f70  )..    def get_p
+00008230: 7265 6369 7369 6f6e 5f70 7269 6365 2873  recision_price(s
+00008240: 656c 662c 2070 6169 723a 2073 7472 2920  elf, pair: str) 
+00008250: 2d3e 204f 7074 696f 6e61 6c5b 666c 6f61  -> Optional[floa
+00008260: 745d 3a0a 2020 2020 2020 2020 2222 220a  t]:.        """.
+00008270: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+00008280: 7468 6520 7072 6963 6520 7072 6563 6973  the price precis
+00008290: 696f 6e20 6f66 2074 6865 2065 7863 6861  ion of the excha
+000082a0: 6e67 652e 0a20 2020 2020 2020 203a 7061  nge..        :pa
+000082b0: 7261 6d20 7061 6972 3a20 5061 6972 2074  ram pair: Pair t
+000082c0: 6f20 6765 7420 7072 6563 6973 696f 6e20  o get precision 
+000082d0: 666f 720a 2020 2020 2020 2020 3a72 6574  for.        :ret
+000082e0: 7572 6e3a 2070 7265 6369 7369 6f6e 2066  urn: precision f
+000082f0: 6f72 2070 7269 6365 206f 7220 4e6f 6e65  or price or None
+00008300: 2e20 4d75 7374 2062 6520 7573 6564 2069  . Must be used i
+00008310: 6e20 636f 6d62 696e 6174 696f 6e20 7769  n combination wi
+00008320: 7468 2070 7265 6369 7369 6f6e 4d6f 6465  th precisionMode
+00008330: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00008340: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00008350: 2e6d 6172 6b65 7473 2e67 6574 2870 6169  .markets.get(pai
+00008360: 722c 207b 7d29 2e67 6574 2827 7072 6563  r, {}).get('prec
+00008370: 6973 696f 6e27 2c20 7b7d 292e 6765 7428  ision', {}).get(
+00008380: 2770 7269 6365 272c 204e 6f6e 6529 0a0a  'price', None)..
+00008390: 2020 2020 6465 6620 616d 6f75 6e74 5f74      def amount_t
+000083a0: 6f5f 7072 6563 6973 696f 6e28 7365 6c66  o_precision(self
+000083b0: 2c20 7061 6972 3a20 7374 722c 2061 6d6f  , pair: str, amo
+000083c0: 756e 743a 2066 6c6f 6174 2920 2d3e 2066  unt: float) -> f
+000083d0: 6c6f 6174 3a0a 2020 2020 2020 2020 2222  loat:.        ""
+000083e0: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
+000083f0: 7320 7468 6520 616d 6f75 6e74 2074 6f20  s the amount to 
+00008400: 6275 7920 6f72 2073 656c 6c20 746f 2061  buy or sell to a
+00008410: 2070 7265 6369 7369 6f6e 2074 6865 2045   precision the E
+00008420: 7863 6861 6e67 6520 6163 6365 7074 730a  xchange accepts.
+00008430: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00008440: 2020 2020 2072 6574 7572 6e20 616d 6f75       return amou
+00008450: 6e74 5f74 6f5f 7072 6563 6973 696f 6e28  nt_to_precision(
+00008460: 616d 6f75 6e74 2c20 7365 6c66 2e67 6574  amount, self.get
+00008470: 5f70 7265 6369 7369 6f6e 5f61 6d6f 756e  _precision_amoun
+00008480: 7428 7061 6972 292c 2073 656c 662e 7072  t(pair), self.pr
+00008490: 6563 6973 696f 6e4d 6f64 6529 0a0a 2020  ecisionMode)..  
+000084a0: 2020 6465 6620 7072 6963 655f 746f 5f70    def price_to_p
+000084b0: 7265 6369 7369 6f6e 2873 656c 662c 2070  recision(self, p
+000084c0: 6169 723a 2073 7472 2c20 7072 6963 653a  air: str, price:
+000084d0: 2066 6c6f 6174 2c20 2a2c 2072 6f75 6e64   float, *, round
+000084e0: 696e 675f 6d6f 6465 3a20 696e 7420 3d20  ing_mode: int = 
+000084f0: 524f 554e 4429 202d 3e20 666c 6f61 743a  ROUND) -> float:
+00008500: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00008510: 2020 2020 2052 6574 7572 6e73 2074 6865       Returns the
+00008520: 2070 7269 6365 2072 6f75 6e64 6564 2074   price rounded t
+00008530: 6f20 7468 6520 7072 6563 6973 696f 6e20  o the precision 
+00008540: 7468 6520 4578 6368 616e 6765 2061 6363  the Exchange acc
+00008550: 6570 7473 2e0a 2020 2020 2020 2020 5468  epts..        Th
+00008560: 6520 6465 6661 756c 7420 7072 6963 655f  e default price_
+00008570: 726f 756e 6469 6e67 5f6d 6f64 6520 696e  rounding_mode in
+00008580: 2063 6f6e 6620 6973 2052 4f55 4e44 2e0a   conf is ROUND..
+00008590: 2020 2020 2020 2020 466f 7220 7374 6f70          For stop
+000085a0: 6c6f 7373 2063 616c 6375 6c61 7469 6f6e  loss calculation
+000085b0: 732c 206d 7573 7420 7573 6520 524f 554e  s, must use ROUN
+000085c0: 445f 5550 2066 6f72 206c 6f6e 6773 2c20  D_UP for longs, 
+000085d0: 616e 6420 524f 554e 445f 444f 574e 2066  and ROUND_DOWN f
+000085e0: 6f72 2073 686f 7274 732e 0a20 2020 2020  or shorts..     
+000085f0: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00008600: 6574 7572 6e20 7072 6963 655f 746f 5f70  eturn price_to_p
+00008610: 7265 6369 7369 6f6e 2870 7269 6365 2c20  recision(price, 
+00008620: 7365 6c66 2e67 6574 5f70 7265 6369 7369  self.get_precisi
+00008630: 6f6e 5f70 7269 6365 2870 6169 7229 2c0a  on_price(pair),.
+00008640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008660: 2020 7365 6c66 2e70 7265 6369 7369 6f6e    self.precision
+00008670: 4d6f 6465 2c20 726f 756e 6469 6e67 5f6d  Mode, rounding_m
+00008680: 6f64 653d 726f 756e 6469 6e67 5f6d 6f64  ode=rounding_mod
+00008690: 6529 0a0a 2020 2020 6465 6620 7072 6963  e)..    def pric
+000086a0: 655f 6765 745f 6f6e 655f 7069 7028 7365  e_get_one_pip(se
+000086b0: 6c66 2c20 7061 6972 3a20 7374 722c 2070  lf, pair: str, p
+000086c0: 7269 6365 3a20 666c 6f61 7429 202d 3e20  rice: float) -> 
+000086d0: 666c 6f61 743a 0a20 2020 2020 2020 2022  float:.        "
+000086e0: 2222 0a20 2020 2020 2020 2047 6574 2773  "".        Get's
+000086f0: 2074 6865 2022 3120 7069 7022 2076 616c   the "1 pip" val
+00008700: 7565 2066 6f72 2074 6869 7320 7061 6972  ue for this pair
+00008710: 2e0a 2020 2020 2020 2020 5573 6564 2069  ..        Used i
+00008720: 6e20 5072 6963 6546 696c 7465 7220 746f  n PriceFilter to
+00008730: 2063 616c 6375 6c61 7465 2074 6865 2031   calculate the 1
+00008740: 7069 7020 6d6f 7665 6d65 6e74 732e 0a20  pip movements.. 
+00008750: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00008760: 2020 2070 7265 6369 7369 6f6e 203d 2073     precision = s
+00008770: 656c 662e 6d61 726b 6574 735b 7061 6972  elf.markets[pair
+00008780: 5d5b 2770 7265 6369 7369 6f6e 275d 5b27  ]['precision']['
+00008790: 7072 6963 6527 5d0a 2020 2020 2020 2020  price'].        
+000087a0: 6966 2073 656c 662e 7072 6563 6973 696f  if self.precisio
+000087b0: 6e4d 6f64 6520 3d3d 2054 4943 4b5f 5349  nMode == TICK_SI
+000087c0: 5a45 3a0a 2020 2020 2020 2020 2020 2020  ZE:.            
+000087d0: 7265 7475 726e 2070 7265 6369 7369 6f6e  return precision
+000087e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000087f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00008800: 6e20 3120 2f20 706f 7728 3130 2c20 7072  n 1 / pow(10, pr
+00008810: 6563 6973 696f 6e29 0a0a 2020 2020 6465  ecision)..    de
+00008820: 6620 6765 745f 6d69 6e5f 7061 6972 5f73  f get_min_pair_s
+00008830: 7461 6b65 5f61 6d6f 756e 7428 0a20 2020  take_amount(.   
+00008840: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00008850: 2020 2070 6169 723a 2073 7472 2c0a 2020     pair: str,.  
+00008860: 2020 2020 2020 7072 6963 653a 2066 6c6f        price: flo
+00008870: 6174 2c0a 2020 2020 2020 2020 7374 6f70  at,.        stop
+00008880: 6c6f 7373 3a20 666c 6f61 742c 0a20 2020  loss: float,.   
+00008890: 2020 2020 206c 6576 6572 6167 653a 204f       leverage: O
+000088a0: 7074 696f 6e61 6c5b 666c 6f61 745d 203d  ptional[float] =
+000088b0: 2031 2e30 0a20 2020 2029 202d 3e20 4f70   1.0.    ) -> Op
+000088c0: 7469 6f6e 616c 5b66 6c6f 6174 5d3a 0a20  tional[float]:. 
+000088d0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000088e0: 6c66 2e5f 6765 745f 7374 616b 655f 616d  lf._get_stake_am
+000088f0: 6f75 6e74 5f6c 696d 6974 2870 6169 722c  ount_limit(pair,
+00008900: 2070 7269 6365 2c20 7374 6f70 6c6f 7373   price, stoploss
+00008910: 2c20 276d 696e 272c 206c 6576 6572 6167  , 'min', leverag
+00008920: 6529 0a0a 2020 2020 6465 6620 6765 745f  e)..    def get_
+00008930: 6d61 785f 7061 6972 5f73 7461 6b65 5f61  max_pair_stake_a
+00008940: 6d6f 756e 7428 7365 6c66 2c20 7061 6972  mount(self, pair
+00008950: 3a20 7374 722c 2070 7269 6365 3a20 666c  : str, price: fl
+00008960: 6f61 742c 206c 6576 6572 6167 653a 2066  oat, leverage: f
+00008970: 6c6f 6174 203d 2031 2e30 2920 2d3e 2066  loat = 1.0) -> f
+00008980: 6c6f 6174 3a0a 2020 2020 2020 2020 6d61  loat:.        ma
+00008990: 785f 7374 616b 655f 616d 6f75 6e74 203d  x_stake_amount =
+000089a0: 2073 656c 662e 5f67 6574 5f73 7461 6b65   self._get_stake
+000089b0: 5f61 6d6f 756e 745f 6c69 6d69 7428 7061  _amount_limit(pa
+000089c0: 6972 2c20 7072 6963 652c 2030 2e30 2c20  ir, price, 0.0, 
+000089d0: 276d 6178 272c 206c 6576 6572 6167 6529  'max', leverage)
+000089e0: 0a20 2020 2020 2020 2069 6620 6d61 785f  .        if max_
+000089f0: 7374 616b 655f 616d 6f75 6e74 2069 7320  stake_amount is 
+00008a00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00008a10: 2020 2320 2a20 5368 6f75 6c64 206e 6576    # * Should nev
+00008a20: 6572 2062 6520 6578 6563 7574 6564 0a20  er be executed. 
+00008a30: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00008a40: 204f 7065 7261 7469 6f6e 616c 4578 6365   OperationalExce
+00008a50: 7074 696f 6e28 6627 7b73 656c 662e 6e61  ption(f'{self.na
+00008a60: 6d65 7d2e 6765 745f 6d61 785f 7061 6972  me}.get_max_pair
+00008a70: 5f73 7461 6b65 5f61 6d6f 756e 7420 7368  _stake_amount sh
+00008a80: 6f75 6c64 270a 2020 2020 2020 2020 2020  ould'.          
+00008a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008aa0: 2020 2020 2020 2020 2020 2020 2027 6e65               'ne
+00008ab0: 7665 7220 7365 7420 6d61 785f 7374 616b  ver set max_stak
+00008ac0: 655f 616d 6f75 6e74 2074 6f20 4e6f 6e65  e_amount to None
+00008ad0: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
+00008ae0: 6e20 6d61 785f 7374 616b 655f 616d 6f75  n max_stake_amou
+00008af0: 6e74 0a0a 2020 2020 6465 6620 5f67 6574  nt..    def _get
+00008b00: 5f73 7461 6b65 5f61 6d6f 756e 745f 6c69  _stake_amount_li
+00008b10: 6d69 7428 0a20 2020 2020 2020 2073 656c  mit(.        sel
+00008b20: 662c 0a20 2020 2020 2020 2070 6169 723a  f,.        pair:
+00008b30: 2073 7472 2c0a 2020 2020 2020 2020 7072   str,.        pr
+00008b40: 6963 653a 2066 6c6f 6174 2c0a 2020 2020  ice: float,.    
+00008b50: 2020 2020 7374 6f70 6c6f 7373 3a20 666c      stoploss: fl
+00008b60: 6f61 742c 0a20 2020 2020 2020 206c 696d  oat,.        lim
+00008b70: 6974 3a20 4c69 7465 7261 6c5b 276d 696e  it: Literal['min
+00008b80: 272c 2027 6d61 7827 5d2c 0a20 2020 2020  ', 'max'],.     
+00008b90: 2020 206c 6576 6572 6167 653a 204f 7074     leverage: Opt
+00008ba0: 696f 6e61 6c5b 666c 6f61 745d 203d 2031  ional[float] = 1
+00008bb0: 2e30 0a20 2020 2029 202d 3e20 4f70 7469  .0.    ) -> Opti
+00008bc0: 6f6e 616c 5b66 6c6f 6174 5d3a 0a0a 2020  onal[float]:..  
+00008bd0: 2020 2020 2020 6973 4d69 6e20 3d20 6c69        isMin = li
+00008be0: 6d69 7420 3d3d 2027 6d69 6e27 0a0a 2020  mit == 'min'..  
+00008bf0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00008c00: 2020 2020 2020 206d 6172 6b65 7420 3d20         market = 
+00008c10: 7365 6c66 2e6d 6172 6b65 7473 5b70 6169  self.markets[pai
+00008c20: 725d 0a20 2020 2020 2020 2065 7863 6570  r].        excep
+00008c30: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
+00008c40: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00008c50: 6c75 6545 7272 6f72 2866 2243 616e 2774  lueError(f"Can't
+00008c60: 2067 6574 206d 6172 6b65 7420 696e 666f   get market info
+00008c70: 726d 6174 696f 6e20 666f 7220 7379 6d62  rmation for symb
+00008c80: 6f6c 207b 7061 6972 7d22 290a 0a20 2020  ol {pair}")..   
+00008c90: 2020 2020 2069 6620 6973 4d69 6e3a 0a20       if isMin:. 
+00008ca0: 2020 2020 2020 2020 2020 2023 2072 6573             # res
+00008cb0: 6572 7665 2073 6f6d 6520 7065 7263 656e  erve some percen
+00008cc0: 7420 6465 6669 6e65 6420 696e 2063 6f6e  t defined in con
+00008cd0: 6669 6720 2835 2520 6465 6661 756c 7429  fig (5% default)
+00008ce0: 202b 2073 746f 706c 6f73 730a 2020 2020   + stoploss.    
+00008cf0: 2020 2020 2020 2020 6d61 7267 696e 5f72          margin_r
+00008d00: 6573 6572 7665 3a20 666c 6f61 7420 3d20  eserve: float = 
+00008d10: 312e 3020 2b20 7365 6c66 2e5f 636f 6e66  1.0 + self._conf
+00008d20: 6967 2e67 6574 2827 616d 6f75 6e74 5f72  ig.get('amount_r
+00008d30: 6573 6572 7665 5f70 6572 6365 6e74 272c  eserve_percent',
+00008d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d70: 2020 2020 2020 2020 2020 2020 4445 4641              DEFA
+00008d80: 554c 545f 414d 4f55 4e54 5f52 4553 4552  ULT_AMOUNT_RESER
+00008d90: 5645 5f50 4552 4345 4e54 290a 2020 2020  VE_PERCENT).    
+00008da0: 2020 2020 2020 2020 7374 6f70 6c6f 7373          stoploss
+00008db0: 5f72 6573 6572 7665 203d 2028 0a20 2020  _reserve = (.   
+00008dc0: 2020 2020 2020 2020 2020 2020 206d 6172               mar
+00008dd0: 6769 6e5f 7265 7365 7276 6520 2f20 2831  gin_reserve / (1
+00008de0: 202d 2061 6273 2873 746f 706c 6f73 7329   - abs(stoploss)
+00008df0: 2920 6966 2061 6273 2873 746f 706c 6f73  ) if abs(stoplos
+00008e00: 7329 2021 3d20 3120 656c 7365 2031 2e35  s) != 1 else 1.5
+00008e10: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00008e20: 2020 2020 2020 2020 2020 2023 2069 7420             # it 
+00008e30: 7368 6f75 6c64 206e 6f74 2062 6520 6d6f  should not be mo
+00008e40: 7265 2074 6861 6e20 3530 250a 2020 2020  re than 50%.    
+00008e50: 2020 2020 2020 2020 7374 6f70 6c6f 7373          stoploss
+00008e60: 5f72 6573 6572 7665 203d 206d 6178 286d  _reserve = max(m
+00008e70: 696e 2873 746f 706c 6f73 735f 7265 7365  in(stoploss_rese
+00008e80: 7276 652c 2031 2e35 292c 2031 290a 2020  rve, 1.5), 1).  
+00008e90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00008ea0: 2020 2020 2020 2020 6d61 7267 696e 5f72          margin_r
+00008eb0: 6573 6572 7665 203d 2031 2e30 0a20 2020  eserve = 1.0.   
+00008ec0: 2020 2020 2020 2020 2073 746f 706c 6f73           stoplos
+00008ed0: 735f 7265 7365 7276 6520 3d20 312e 300a  s_reserve = 1.0.
+00008ee0: 0a20 2020 2020 2020 2073 7461 6b65 5f6c  .        stake_l
+00008ef0: 696d 6974 7320 3d20 5b5d 0a20 2020 2020  imits = [].     
+00008f00: 2020 206c 696d 6974 7320 3d20 6d61 726b     limits = mark
+00008f10: 6574 5b27 6c69 6d69 7473 275d 0a20 2020  et['limits'].   
+00008f20: 2020 2020 2069 6620 286c 696d 6974 735b       if (limits[
+00008f30: 2763 6f73 7427 5d5b 6c69 6d69 745d 2069  'cost'][limit] i
+00008f40: 7320 6e6f 7420 4e6f 6e65 293a 0a20 2020  s not None):.   
+00008f50: 2020 2020 2020 2020 2073 7461 6b65 5f6c           stake_l
+00008f60: 696d 6974 732e 6170 7065 6e64 280a 2020  imits.append(.  
+00008f70: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00008f80: 6c66 2e5f 636f 6e74 7261 6374 735f 746f  lf._contracts_to
+00008f90: 5f61 6d6f 756e 7428 7061 6972 2c20 6c69  _amount(pair, li
+00008fa0: 6d69 7473 5b27 636f 7374 275d 5b6c 696d  mits['cost'][lim
+00008fb0: 6974 5d29 202a 2073 746f 706c 6f73 735f  it]) * stoploss_
+00008fc0: 7265 7365 7276 650a 2020 2020 2020 2020  reserve.        
+00008fd0: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
+00008fe0: 6620 286c 696d 6974 735b 2761 6d6f 756e  f (limits['amoun
+00008ff0: 7427 5d5b 6c69 6d69 745d 2069 7320 6e6f  t'][limit] is no
+00009000: 7420 4e6f 6e65 293a 0a20 2020 2020 2020  t None):.       
+00009010: 2020 2020 2073 7461 6b65 5f6c 696d 6974       stake_limit
+00009020: 732e 6170 7065 6e64 280a 2020 2020 2020  s.append(.      
+00009030: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00009040: 636f 6e74 7261 6374 735f 746f 5f61 6d6f  contracts_to_amo
+00009050: 756e 7428 7061 6972 2c20 6c69 6d69 7473  unt(pair, limits
+00009060: 5b27 616d 6f75 6e74 275d 5b6c 696d 6974  ['amount'][limit
+00009070: 5d29 202a 2070 7269 6365 202a 206d 6172  ]) * price * mar
+00009080: 6769 6e5f 7265 7365 7276 650a 2020 2020  gin_reserve.    
+00009090: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000090a0: 2020 2069 6620 6e6f 7420 7374 616b 655f     if not stake_
+000090b0: 6c69 6d69 7473 3a0a 2020 2020 2020 2020  limits:.        
+000090c0: 2020 2020 7265 7475 726e 204e 6f6e 6520      return None 
+000090d0: 6966 2069 734d 696e 2065 6c73 6520 666c  if isMin else fl
+000090e0: 6f61 7428 2769 6e66 2729 0a0a 2020 2020  oat('inf')..    
+000090f0: 2020 2020 2320 5468 6520 7661 6c75 6520      # The value 
+00009100: 7265 7475 726e 6564 2073 686f 756c 6420  returned should 
+00009110: 7361 7469 7366 7920 626f 7468 206c 696d  satisfy both lim
+00009120: 6974 733a 2066 6f72 2061 6d6f 756e 7420  its: for amount 
+00009130: 2862 6173 6520 6375 7272 656e 6379 2920  (base currency) 
+00009140: 616e 640a 2020 2020 2020 2020 2320 666f  and.        # fo
+00009150: 7220 636f 7374 2028 7175 6f74 652c 2073  r cost (quote, s
+00009160: 7461 6b65 2063 7572 7265 6e63 7929 2c20  take currency), 
+00009170: 736f 206d 6178 2829 2069 7320 7573 6564  so max() is used
+00009180: 2068 6572 652e 0a20 2020 2020 2020 2023   here..        #
+00009190: 2053 6565 2061 6c73 6f20 2332 3537 3520   See also #2575 
+000091a0: 6174 2067 6974 6875 622e 0a20 2020 2020  at github..     
+000091b0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+000091c0: 6765 745f 7374 616b 655f 616d 6f75 6e74  get_stake_amount
+000091d0: 5f63 6f6e 7369 6465 7269 6e67 5f6c 6576  _considering_lev
+000091e0: 6572 6167 6528 0a20 2020 2020 2020 2020  erage(.         
+000091f0: 2020 206d 6178 2873 7461 6b65 5f6c 696d     max(stake_lim
+00009200: 6974 7329 2069 6620 6973 4d69 6e20 656c  its) if isMin el
+00009210: 7365 206d 696e 2873 7461 6b65 5f6c 696d  se min(stake_lim
+00009220: 6974 7329 2c0a 2020 2020 2020 2020 2020  its),.          
+00009230: 2020 6c65 7665 7261 6765 206f 7220 312e    leverage or 1.
+00009240: 300a 2020 2020 2020 2020 290a 0a20 2020  0.        )..   
+00009250: 2064 6566 205f 6765 745f 7374 616b 655f   def _get_stake_
+00009260: 616d 6f75 6e74 5f63 6f6e 7369 6465 7269  amount_consideri
+00009270: 6e67 5f6c 6576 6572 6167 6528 7365 6c66  ng_leverage(self
+00009280: 2c20 7374 616b 655f 616d 6f75 6e74 3a20  , stake_amount: 
+00009290: 666c 6f61 742c 206c 6576 6572 6167 653a  float, leverage:
+000092a0: 2066 6c6f 6174 2920 2d3e 2066 6c6f 6174   float) -> float
+000092b0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+000092c0: 2020 2020 2020 5461 6b65 7320 7468 6520        Takes the 
+000092d0: 6d69 6e69 6d75 6d20 7374 616b 6520 616d  minimum stake am
+000092e0: 6f75 6e74 2066 6f72 2061 2070 6169 7220  ount for a pair 
+000092f0: 7769 7468 206e 6f20 6c65 7665 7261 6765  with no leverage
+00009300: 2061 6e64 2072 6574 7572 6e73 2074 6865   and returns the
+00009310: 206d 696e 696d 756d 0a20 2020 2020 2020   minimum.       
+00009320: 2073 7461 6b65 2061 6d6f 756e 7420 7768   stake amount wh
+00009330: 656e 206c 6576 6572 6167 6520 6973 2063  en leverage is c
+00009340: 6f6e 7369 6465 7265 640a 2020 2020 2020  onsidered.      
+00009350: 2020 3a70 6172 616d 2073 7461 6b65 5f61    :param stake_a
+00009360: 6d6f 756e 743a 2054 6865 2073 7461 6b65  mount: The stake
+00009370: 2061 6d6f 756e 7420 666f 7220 6120 7061   amount for a pa
+00009380: 6972 2062 6566 6f72 6520 6c65 7665 7261  ir before levera
+00009390: 6765 2069 7320 636f 6e73 6964 6572 6564  ge is considered
+000093a0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000093b0: 6c65 7665 7261 6765 3a20 5468 6520 616d  leverage: The am
+000093c0: 6f75 6e74 206f 6620 6c65 7665 7261 6765  ount of leverage
+000093d0: 2062 6569 6e67 2075 7365 6420 6f6e 2074   being used on t
+000093e0: 6865 2063 7572 7265 6e74 2074 7261 6465  he current trade
+000093f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00009400: 2020 2020 2072 6574 7572 6e20 7374 616b       return stak
+00009410: 655f 616d 6f75 6e74 202f 206c 6576 6572  e_amount / lever
+00009420: 6167 650a 0a20 2020 2023 2044 7279 2d72  age..    # Dry-r
+00009430: 756e 206d 6574 686f 6473 0a0a 2020 2020  un methods..    
+00009440: 6465 6620 6372 6561 7465 5f64 7279 5f72  def create_dry_r
+00009450: 756e 5f6f 7264 6572 2873 656c 662c 2070  un_order(self, p
+00009460: 6169 723a 2073 7472 2c20 6f72 6465 7274  air: str, ordert
+00009470: 7970 653a 2073 7472 2c20 7369 6465 3a20  ype: str, side: 
+00009480: 7374 722c 2061 6d6f 756e 743a 2066 6c6f  str, amount: flo
+00009490: 6174 2c0a 2020 2020 2020 2020 2020 2020  at,.            
+000094a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094b0: 2072 6174 653a 2066 6c6f 6174 2c20 6c65   rate: float, le
+000094c0: 7665 7261 6765 3a20 666c 6f61 742c 2070  verage: float, p
+000094d0: 6172 616d 733a 2044 6963 7420 3d20 7b7d  arams: Dict = {}
+000094e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000094f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00009500: 746f 705f 6c6f 7373 3a20 626f 6f6c 203d  top_loss: bool =
+00009510: 2046 616c 7365 2920 2d3e 2044 6963 745b   False) -> Dict[
+00009520: 7374 722c 2041 6e79 5d3a 0a20 2020 2020  str, Any]:.     
+00009530: 2020 206e 6f77 203d 2064 745f 6e6f 7728     now = dt_now(
+00009540: 290a 2020 2020 2020 2020 6f72 6465 725f  ).        order_
+00009550: 6964 203d 2066 2764 7279 5f72 756e 5f7b  id = f'dry_run_{
+00009560: 7369 6465 7d5f 7b6e 6f77 2e74 696d 6573  side}_{now.times
+00009570: 7461 6d70 2829 7d27 0a20 2020 2020 2020  tamp()}'.       
+00009580: 2023 2052 6f75 6e64 696e 6720 6865 7265   # Rounding here
+00009590: 206d 7573 7420 7265 7370 6563 7420 746f   must respect to
+000095a0: 2063 6f6e 7472 6163 7420 7369 7a65 730a   contract sizes.
+000095b0: 2020 2020 2020 2020 5f61 6d6f 756e 7420          _amount 
+000095c0: 3d20 7365 6c66 2e5f 636f 6e74 7261 6374  = self._contract
+000095d0: 735f 746f 5f61 6d6f 756e 7428 0a20 2020  s_to_amount(.   
+000095e0: 2020 2020 2020 2020 2070 6169 722c 2073           pair, s
+000095f0: 656c 662e 616d 6f75 6e74 5f74 6f5f 7072  elf.amount_to_pr
+00009600: 6563 6973 696f 6e28 7061 6972 2c20 7365  ecision(pair, se
+00009610: 6c66 2e5f 616d 6f75 6e74 5f74 6f5f 636f  lf._amount_to_co
+00009620: 6e74 7261 6374 7328 7061 6972 2c20 616d  ntracts(pair, am
+00009630: 6f75 6e74 2929 290a 2020 2020 2020 2020  ount))).        
+00009640: 6472 795f 6f72 6465 723a 2044 6963 745b  dry_order: Dict[
+00009650: 7374 722c 2041 6e79 5d20 3d20 7b0a 2020  str, Any] = {.  
+00009660: 2020 2020 2020 2020 2020 2769 6427 3a20            'id': 
+00009670: 6f72 6465 725f 6964 2c0a 2020 2020 2020  order_id,.      
+00009680: 2020 2020 2020 2773 796d 626f 6c27 3a20        'symbol': 
+00009690: 7061 6972 2c0a 2020 2020 2020 2020 2020  pair,.          
+000096a0: 2020 2770 7269 6365 273a 2072 6174 652c    'price': rate,
+000096b0: 0a20 2020 2020 2020 2020 2020 2027 6176  .            'av
+000096c0: 6572 6167 6527 3a20 7261 7465 2c0a 2020  erage': rate,.  
+000096d0: 2020 2020 2020 2020 2020 2761 6d6f 756e            'amoun
+000096e0: 7427 3a20 5f61 6d6f 756e 742c 0a20 2020  t': _amount,.   
+000096f0: 2020 2020 2020 2020 2027 636f 7374 273a           'cost':
+00009700: 205f 616d 6f75 6e74 202a 2072 6174 652c   _amount * rate,
+00009710: 0a20 2020 2020 2020 2020 2020 2027 7479  .            'ty
+00009720: 7065 273a 206f 7264 6572 7479 7065 2c0a  pe': ordertype,.
+00009730: 2020 2020 2020 2020 2020 2020 2773 6964              'sid
+00009740: 6527 3a20 7369 6465 2c0a 2020 2020 2020  e': side,.      
+00009750: 2020 2020 2020 2766 696c 6c65 6427 3a20        'filled': 
+00009760: 302c 0a20 2020 2020 2020 2020 2020 2027  0,.            '
+00009770: 7265 6d61 696e 696e 6727 3a20 5f61 6d6f  remaining': _amo
+00009780: 756e 742c 0a20 2020 2020 2020 2020 2020  unt,.           
+00009790: 2027 6461 7465 7469 6d65 273a 206e 6f77   'datetime': now
+000097a0: 2e73 7472 6674 696d 6528 2725 592d 256d  .strftime('%Y-%m
+000097b0: 2d25 6454 2548 3a25 4d3a 2553 2e25 665a  -%dT%H:%M:%S.%fZ
+000097c0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+000097d0: 2774 696d 6573 7461 6d70 273a 2064 745f  'timestamp': dt_
+000097e0: 7473 286e 6f77 292c 0a20 2020 2020 2020  ts(now),.       
+000097f0: 2020 2020 2027 7374 6174 7573 273a 2022       'status': "
+00009800: 6f70 656e 222c 0a20 2020 2020 2020 2020  open",.         
+00009810: 2020 2027 6665 6527 3a20 4e6f 6e65 2c0a     'fee': None,.
+00009820: 2020 2020 2020 2020 2020 2020 2769 6e66              'inf
+00009830: 6f27 3a20 7b7d 2c0a 2020 2020 2020 2020  o': {},.        
+00009840: 2020 2020 276c 6576 6572 6167 6527 3a20      'leverage': 
+00009850: 6c65 7665 7261 6765 0a20 2020 2020 2020  leverage.       
+00009860: 207d 0a20 2020 2020 2020 2069 6620 7374   }.        if st
+00009870: 6f70 5f6c 6f73 733a 0a20 2020 2020 2020  op_loss:.       
+00009880: 2020 2020 2064 7279 5f6f 7264 6572 5b22       dry_order["
+00009890: 696e 666f 225d 203d 207b 2273 746f 7050  info"] = {"stopP
+000098a0: 7269 6365 223a 2064 7279 5f6f 7264 6572  rice": dry_order
+000098b0: 5b22 7072 6963 6522 5d7d 0a20 2020 2020  ["price"]}.     
+000098c0: 2020 2020 2020 2064 7279 5f6f 7264 6572         dry_order
+000098d0: 5b73 656c 662e 5f66 745f 6861 735b 2773  [self._ft_has['s
+000098e0: 746f 705f 7072 6963 655f 7061 7261 6d27  top_price_param'
+000098f0: 5d5d 203d 2064 7279 5f6f 7264 6572 5b22  ]] = dry_order["
+00009900: 7072 6963 6522 5d0a 2020 2020 2020 2020  price"].        
+00009910: 2020 2020 2320 576f 726b 6172 6f75 6e64      # Workaround
+00009920: 2074 6f20 6176 6f69 6420 6669 6c6c 696e   to avoid fillin
+00009930: 6720 7374 6f70 6c6f 7373 206f 7264 6572  g stoploss order
+00009940: 7320 696d 6d65 6469 6174 656c 790a 2020  s immediately.  
+00009950: 2020 2020 2020 2020 2020 6472 795f 6f72            dry_or
+00009960: 6465 725b 2266 745f 6f72 6465 725f 7479  der["ft_order_ty
+00009970: 7065 225d 203d 2022 7374 6f70 6c6f 7373  pe"] = "stoploss
+00009980: 220a 2020 2020 2020 2020 6f72 6465 7262  ".        orderb
+00009990: 6f6f 6b3a 204f 7074 696f 6e61 6c5b 4f72  ook: Optional[Or
+000099a0: 6465 7242 6f6f 6b5d 203d 204e 6f6e 650a  derBook] = None.
+000099b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000099c0: 6578 6368 616e 6765 5f68 6173 2827 6665  exchange_has('fe
+000099d0: 7463 684c 324f 7264 6572 426f 6f6b 2729  tchL2OrderBook')
+000099e0: 3a0a 2020 2020 2020 2020 2020 2020 6f72  :.            or
+000099f0: 6465 7262 6f6f 6b20 3d20 7365 6c66 2e66  derbook = self.f
+00009a00: 6574 6368 5f6c 325f 6f72 6465 725f 626f  etch_l2_order_bo
+00009a10: 6f6b 2870 6169 722c 2032 3029 0a20 2020  ok(pair, 20).   
+00009a20: 2020 2020 2069 6620 6f72 6465 7274 7970       if ordertyp
+00009a30: 6520 3d3d 2022 6c69 6d69 7422 2061 6e64  e == "limit" and
+00009a40: 206f 7264 6572 626f 6f6b 3a0a 2020 2020   orderbook:.    
+00009a50: 2020 2020 2020 2020 2320 416c 6c6f 7720          # Allow 
+00009a60: 6120 3325 2070 7269 6365 2064 6966 6665  a 3% price diffe
+00009a70: 7265 6e63 650a 2020 2020 2020 2020 2020  rence.          
+00009a80: 2020 616c 6c6f 7765 645f 6469 6666 203d    allowed_diff =
+00009a90: 2030 2e30 330a 2020 2020 2020 2020 2020   0.03.          
+00009aa0: 2020 6966 2073 656c 662e 5f64 7279 5f69    if self._dry_i
+00009ab0: 735f 7072 6963 655f 6372 6f73 7365 6428  s_price_crossed(
+00009ac0: 7061 6972 2c20 7369 6465 2c20 7261 7465  pair, side, rate
+00009ad0: 2c20 6f72 6465 7262 6f6f 6b2c 2061 6c6c  , orderbook, all
+00009ae0: 6f77 6564 5f64 6966 6629 3a0a 2020 2020  owed_diff):.    
+00009af0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00009b00: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+00009b10: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
+00009b20: 6f6e 7665 7274 6564 206f 7264 6572 207b  onverted order {
+00009b30: 7061 6972 7d20 746f 206d 6172 6b65 7420  pair} to market 
+00009b40: 6f72 6465 7220 6475 6520 746f 2070 7269  order due to pri
+00009b50: 6365 207b 7261 7465 7d20 6372 6f73 7369  ce {rate} crossi
+00009b60: 6e67 2073 7072 6561 6420 220a 2020 2020  ng spread ".    
+00009b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b80: 6622 6279 206d 6f72 6520 7468 616e 207b  f"by more than {
+00009b90: 616c 6c6f 7765 645f 6469 6666 3a2e 3225  allowed_diff:.2%
+00009ba0: 7d2e 2229 0a20 2020 2020 2020 2020 2020  }.").           
+00009bb0: 2020 2020 2064 7279 5f6f 7264 6572 5b22       dry_order["
+00009bc0: 7479 7065 225d 203d 2022 6d61 726b 6574  type"] = "market
+00009bd0: 220a 0a20 2020 2020 2020 2069 6620 6472  "..        if dr
+00009be0: 795f 6f72 6465 725b 2274 7970 6522 5d20  y_order["type"] 
+00009bf0: 3d3d 2022 6d61 726b 6574 2220 616e 6420  == "market" and 
+00009c00: 6e6f 7420 6472 795f 6f72 6465 722e 6765  not dry_order.ge
+00009c10: 7428 2266 745f 6f72 6465 725f 7479 7065  t("ft_order_type
+00009c20: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00009c30: 2320 5570 6461 7465 206d 6172 6b65 7420  # Update market 
+00009c40: 6f72 6465 7220 7072 6963 696e 670a 2020  order pricing.  
+00009c50: 2020 2020 2020 2020 2020 6176 6572 6167            averag
+00009c60: 6520 3d20 7365 6c66 2e67 6574 5f64 7279  e = self.get_dry
+00009c70: 5f6d 6172 6b65 745f 6669 6c6c 5f70 7269  _market_fill_pri
+00009c80: 6365 2870 6169 722c 2073 6964 652c 2061  ce(pair, side, a
+00009c90: 6d6f 756e 742c 2072 6174 652c 206f 7264  mount, rate, ord
+00009ca0: 6572 626f 6f6b 290a 2020 2020 2020 2020  erbook).        
+00009cb0: 2020 2020 6472 795f 6f72 6465 722e 7570      dry_order.up
+00009cc0: 6461 7465 287b 0a20 2020 2020 2020 2020  date({.         
+00009cd0: 2020 2020 2020 2027 6176 6572 6167 6527         'average'
+00009ce0: 3a20 6176 6572 6167 652c 0a20 2020 2020  : average,.     
+00009cf0: 2020 2020 2020 2020 2020 2027 6669 6c6c             'fill
+00009d00: 6564 273a 205f 616d 6f75 6e74 2c0a 2020  ed': _amount,.  
+00009d10: 2020 2020 2020 2020 2020 2020 2020 2772                'r
+00009d20: 656d 6169 6e69 6e67 273a 2030 2e30 2c0a  emaining': 0.0,.
+00009d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d40: 2773 7461 7475 7327 3a20 2263 6c6f 7365  'status': "close
+00009d50: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+00009d60: 2020 2020 2763 6f73 7427 3a20 2864 7279      'cost': (dry
+00009d70: 5f6f 7264 6572 5b27 616d 6f75 6e74 275d  _order['amount']
+00009d80: 202a 2061 7665 7261 6765 290a 2020 2020   * average).    
+00009d90: 2020 2020 2020 2020 7d29 0a20 2020 2020          }).     
+00009da0: 2020 2020 2020 2023 206d 6172 6b65 7420         # market 
+00009db0: 6f72 6465 7273 2077 696c 6c20 616c 7761  orders will alwa
+00009dc0: 7973 2069 6e63 7572 7220 7461 6b65 7220  ys incurr taker 
+00009dd0: 6665 6573 0a20 2020 2020 2020 2020 2020  fees.           
+00009de0: 2064 7279 5f6f 7264 6572 203d 2073 656c   dry_order = sel
+00009df0: 662e 6164 645f 6472 795f 6f72 6465 725f  f.add_dry_order_
+00009e00: 6665 6528 7061 6972 2c20 6472 795f 6f72  fee(pair, dry_or
+00009e10: 6465 722c 2027 7461 6b65 7227 290a 0a20  der, 'taker').. 
+00009e20: 2020 2020 2020 2064 7279 5f6f 7264 6572         dry_order
+00009e30: 203d 2073 656c 662e 6368 6563 6b5f 6472   = self.check_dr
+00009e40: 795f 6c69 6d69 745f 6f72 6465 725f 6669  y_limit_order_fi
+00009e50: 6c6c 6564 280a 2020 2020 2020 2020 2020  lled(.          
+00009e60: 2020 6472 795f 6f72 6465 722c 2069 6d6d    dry_order, imm
+00009e70: 6564 6961 7465 3d54 7275 652c 206f 7264  ediate=True, ord
+00009e80: 6572 626f 6f6b 3d6f 7264 6572 626f 6f6b  erbook=orderbook
+00009e90: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00009ea0: 5f64 7279 5f72 756e 5f6f 7065 6e5f 6f72  _dry_run_open_or
+00009eb0: 6465 7273 5b64 7279 5f6f 7264 6572 5b22  ders[dry_order["
+00009ec0: 6964 225d 5d20 3d20 6472 795f 6f72 6465  id"]] = dry_orde
+00009ed0: 720a 2020 2020 2020 2020 2320 436f 7079  r.        # Copy
+00009ee0: 206f 7264 6572 2061 6e64 2063 6c6f 7365   order and close
+00009ef0: 2069 7420 2d20 736f 2074 6865 2072 6574   it - so the ret
+00009f00: 7572 6e65 6420 6f72 6465 7220 6973 206f  urned order is o
+00009f10: 7065 6e20 756e 6c65 7373 2069 7427 7320  pen unless it's 
+00009f20: 6120 6d61 726b 6574 206f 7264 6572 0a20  a market order. 
+00009f30: 2020 2020 2020 2072 6574 7572 6e20 6472         return dr
+00009f40: 795f 6f72 6465 720a 0a20 2020 2064 6566  y_order..    def
+00009f50: 2061 6464 5f64 7279 5f6f 7264 6572 5f66   add_dry_order_f
+00009f60: 6565 280a 2020 2020 2020 2020 7365 6c66  ee(.        self
+00009f70: 2c0a 2020 2020 2020 2020 7061 6972 3a20  ,.        pair: 
+00009f80: 7374 722c 0a20 2020 2020 2020 2064 7279  str,.        dry
+00009f90: 5f6f 7264 6572 3a20 4469 6374 5b73 7472  _order: Dict[str
+00009fa0: 2c20 416e 795d 2c0a 2020 2020 2020 2020  , Any],.        
+00009fb0: 7461 6b65 725f 6f72 5f6d 616b 6572 3a20  taker_or_maker: 
+00009fc0: 4d61 6b65 7254 616b 6572 2c0a 2020 2020  MakerTaker,.    
+00009fd0: 2920 2d3e 2044 6963 745b 7374 722c 2041  ) -> Dict[str, A
+00009fe0: 6e79 5d3a 0a20 2020 2020 2020 2066 6565  ny]:.        fee
+00009ff0: 203d 2073 656c 662e 6765 745f 6665 6528   = self.get_fee(
+0000a000: 7061 6972 2c20 7461 6b65 725f 6f72 5f6d  pair, taker_or_m
+0000a010: 616b 6572 3d74 616b 6572 5f6f 725f 6d61  aker=taker_or_ma
+0000a020: 6b65 7229 0a20 2020 2020 2020 2064 7279  ker).        dry
+0000a030: 5f6f 7264 6572 2e75 7064 6174 6528 7b0a  _order.update({.
+0000a040: 2020 2020 2020 2020 2020 2020 2766 6565              'fee
+0000a050: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+0000a060: 2020 2020 2027 6375 7272 656e 6379 273a       'currency':
+0000a070: 2073 656c 662e 6765 745f 7061 6972 5f71   self.get_pair_q
+0000a080: 756f 7465 5f63 7572 7265 6e63 7928 7061  uote_currency(pa
+0000a090: 6972 292c 0a20 2020 2020 2020 2020 2020  ir),.           
+0000a0a0: 2020 2020 2027 636f 7374 273a 2064 7279       'cost': dry
+0000a0b0: 5f6f 7264 6572 5b27 636f 7374 275d 202a  _order['cost'] *
+0000a0c0: 2066 6565 2c0a 2020 2020 2020 2020 2020   fee,.          
+0000a0d0: 2020 2020 2020 2772 6174 6527 3a20 6665        'rate': fe
+0000a0e0: 650a 2020 2020 2020 2020 2020 2020 7d0a  e.            }.
+0000a0f0: 2020 2020 2020 2020 7d29 0a20 2020 2020          }).     
+0000a100: 2020 2072 6574 7572 6e20 6472 795f 6f72     return dry_or
+0000a110: 6465 720a 0a20 2020 2064 6566 2067 6574  der..    def get
+0000a120: 5f64 7279 5f6d 6172 6b65 745f 6669 6c6c  _dry_market_fill
+0000a130: 5f70 7269 6365 2873 656c 662c 2070 6169  _price(self, pai
+0000a140: 723a 2073 7472 2c20 7369 6465 3a20 7374  r: str, side: st
+0000a150: 722c 2061 6d6f 756e 743a 2066 6c6f 6174  r, amount: float
+0000a160: 2c20 7261 7465 3a20 666c 6f61 742c 0a20  , rate: float,. 
+0000a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a190: 206f 7264 6572 626f 6f6b 3a20 4f70 7469   orderbook: Opti
+0000a1a0: 6f6e 616c 5b4f 7264 6572 426f 6f6b 5d29  onal[OrderBook])
+0000a1b0: 202d 3e20 666c 6f61 743a 0a20 2020 2020   -> float:.     
+0000a1c0: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
+0000a1d0: 6574 2074 6865 206d 6172 6b65 7420 6f72  et the market or
+0000a1e0: 6465 7220 6669 6c6c 2070 7269 6365 2062  der fill price b
+0000a1f0: 6173 6564 206f 6e20 6f72 6465 7262 6f6f  ased on orderboo
+0000a200: 6b20 696e 7465 7270 6f6c 6174 696f 6e0a  k interpolation.
+0000a210: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000a220: 2020 2020 6966 2073 656c 662e 6578 6368      if self.exch
+0000a230: 616e 6765 5f68 6173 2827 6665 7463 684c  ange_has('fetchL
+0000a240: 324f 7264 6572 426f 6f6b 2729 3a0a 2020  2OrderBook'):.  
+0000a250: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0000a260: 206f 7264 6572 626f 6f6b 3a0a 2020 2020   orderbook:.    
+0000a270: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
+0000a280: 7262 6f6f 6b20 3d20 7365 6c66 2e66 6574  rbook = self.fet
+0000a290: 6368 5f6c 325f 6f72 6465 725f 626f 6f6b  ch_l2_order_book
+0000a2a0: 2870 6169 722c 2032 3029 0a20 2020 2020  (pair, 20).     
+0000a2b0: 2020 2020 2020 206f 625f 7479 7065 3a20         ob_type: 
+0000a2c0: 4f42 4c69 7465 7261 6c20 3d20 2761 736b  OBLiteral = 'ask
+0000a2d0: 7327 2069 6620 7369 6465 203d 3d20 2762  s' if side == 'b
+0000a2e0: 7579 2720 656c 7365 2027 6269 6473 270a  uy' else 'bids'.
+0000a2f0: 2020 2020 2020 2020 2020 2020 736c 6970              slip
+0000a300: 7061 6765 203d 2030 2e30 350a 2020 2020  page = 0.05.    
+0000a310: 2020 2020 2020 2020 6d61 785f 736c 6970          max_slip
+0000a320: 7061 6765 5f76 616c 203d 2072 6174 6520  page_val = rate 
+0000a330: 2a20 2828 3120 2b20 736c 6970 7061 6765  * ((1 + slippage
+0000a340: 2920 6966 2073 6964 6520 3d3d 2027 6275  ) if side == 'bu
+0000a350: 7927 2065 6c73 6520 2831 202d 2073 6c69  y' else (1 - sli
+0000a360: 7070 6167 6529 290a 0a20 2020 2020 2020  ppage))..       
+0000a370: 2020 2020 2072 656d 6169 6e69 6e67 5f61       remaining_a
+0000a380: 6d6f 756e 7420 3d20 616d 6f75 6e74 0a20  mount = amount. 
+0000a390: 2020 2020 2020 2020 2020 2066 696c 6c65             fille
+0000a3a0: 645f 616d 6f75 6e74 203d 2030 2e30 0a20  d_amount = 0.0. 
+0000a3b0: 2020 2020 2020 2020 2020 2062 6f6f 6b5f             book_
+0000a3c0: 656e 7472 795f 7072 6963 6520 3d20 302e  entry_price = 0.
+0000a3d0: 300a 2020 2020 2020 2020 2020 2020 666f  0.            fo
+0000a3e0: 7220 626f 6f6b 5f65 6e74 7279 2069 6e20  r book_entry in 
+0000a3f0: 6f72 6465 7262 6f6f 6b5b 6f62 5f74 7970  orderbook[ob_typ
+0000a400: 655d 3a0a 2020 2020 2020 2020 2020 2020  e]:.            
+0000a410: 2020 2020 626f 6f6b 5f65 6e74 7279 5f70      book_entry_p
+0000a420: 7269 6365 203d 2062 6f6f 6b5f 656e 7472  rice = book_entr
+0000a430: 795b 305d 0a20 2020 2020 2020 2020 2020  y[0].           
+0000a440: 2020 2020 2062 6f6f 6b5f 656e 7472 795f       book_entry_
+0000a450: 636f 696e 5f76 6f6c 756d 6520 3d20 626f  coin_volume = bo
+0000a460: 6f6b 5f65 6e74 7279 5b31 5d0a 2020 2020  ok_entry[1].    
+0000a470: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+0000a480: 656d 6169 6e69 6e67 5f61 6d6f 756e 7420  emaining_amount 
+0000a490: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+0000a4a0: 2020 2020 2020 2020 2069 6620 7265 6d61           if rema
+0000a4b0: 696e 696e 675f 616d 6f75 6e74 203c 2062  ining_amount < b
+0000a4c0: 6f6f 6b5f 656e 7472 795f 636f 696e 5f76  ook_entry_coin_v
+0000a4d0: 6f6c 756d 653a 0a20 2020 2020 2020 2020  olume:.         
+0000a4e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000a4f0: 204f 7264 6572 626f 6f6b 2061 7420 7468   Orderbook at th
+0000a500: 6973 2073 6c6f 7420 6269 6767 6572 2074  is slot bigger t
+0000a510: 6861 6e20 7265 6d61 696e 696e 6720 616d  han remaining am
+0000a520: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
+0000a530: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+0000a540: 6c65 645f 616d 6f75 6e74 202b 3d20 7265  led_amount += re
+0000a550: 6d61 696e 696e 675f 616d 6f75 6e74 202a  maining_amount *
+0000a560: 2062 6f6f 6b5f 656e 7472 795f 7072 6963   book_entry_pric
+0000a570: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000a580: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+0000a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5c0: 2020 6669 6c6c 6564 5f61 6d6f 756e 7420    filled_amount 
+0000a5d0: 2b3d 2062 6f6f 6b5f 656e 7472 795f 636f  += book_entry_co
+0000a5e0: 696e 5f76 6f6c 756d 6520 2a20 626f 6f6b  in_volume * book
+0000a5f0: 5f65 6e74 7279 5f70 7269 6365 0a20 2020  _entry_price.   
+0000a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a610: 2072 656d 6169 6e69 6e67 5f61 6d6f 756e   remaining_amoun
+0000a620: 7420 2d3d 2062 6f6f 6b5f 656e 7472 795f  t -= book_entry_
+0000a630: 636f 696e 5f76 6f6c 756d 650a 2020 2020  coin_volume.    
+0000a640: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000a650: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a660: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
+0000a670: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000a680: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000a690: 4966 2072 656d 6169 6e69 6e67 5f61 6d6f  If remaining_amo
+0000a6a0: 756e 7420 7761 736e 2774 2063 6f6e 7375  unt wasn't consu
+0000a6b0: 6d65 6420 636f 6d70 6c65 7465 6c79 2028  med completely (
+0000a6c0: 6272 6561 6b20 7761 7320 6e6f 7420 6361  break was not ca
+0000a6d0: 6c6c 6564 290a 2020 2020 2020 2020 2020  lled).          
+0000a6e0: 2020 2020 2020 6669 6c6c 6564 5f61 6d6f        filled_amo
+0000a6f0: 756e 7420 2b3d 2072 656d 6169 6e69 6e67  unt += remaining
+0000a700: 5f61 6d6f 756e 7420 2a20 626f 6f6b 5f65  _amount * book_e
+0000a710: 6e74 7279 5f70 7269 6365 0a20 2020 2020  ntry_price.     
+0000a720: 2020 2020 2020 2066 6f72 6563 6173 745f         forecast_
+0000a730: 6176 675f 6669 6c6c 6564 5f70 7269 6365  avg_filled_price
+0000a740: 203d 206d 6178 2866 696c 6c65 645f 616d   = max(filled_am
+0000a750: 6f75 6e74 2c20 3029 202f 2061 6d6f 756e  ount, 0) / amoun
+0000a760: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+0000a770: 4c69 6d69 7420 6d61 782e 2073 6c69 7070  Limit max. slipp
+0000a780: 6167 6520 746f 2073 7065 6369 6669 6564  age to specified
+0000a790: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
+0000a7a0: 2020 2069 6620 7369 6465 203d 3d20 2762     if side == 'b
+0000a7b0: 7579 273a 0a20 2020 2020 2020 2020 2020  uy':.           
+0000a7c0: 2020 2020 2066 6f72 6563 6173 745f 6176       forecast_av
+0000a7d0: 675f 6669 6c6c 6564 5f70 7269 6365 203d  g_filled_price =
+0000a7e0: 206d 696e 2866 6f72 6563 6173 745f 6176   min(forecast_av
+0000a7f0: 675f 6669 6c6c 6564 5f70 7269 6365 2c20  g_filled_price, 
+0000a800: 6d61 785f 736c 6970 7061 6765 5f76 616c  max_slippage_val
+0000a810: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
+0000a820: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000a830: 2020 2020 2066 6f72 6563 6173 745f 6176       forecast_av
+0000a840: 675f 6669 6c6c 6564 5f70 7269 6365 203d  g_filled_price =
+0000a850: 206d 6178 2866 6f72 6563 6173 745f 6176   max(forecast_av
+0000a860: 675f 6669 6c6c 6564 5f70 7269 6365 2c20  g_filled_price, 
+0000a870: 6d61 785f 736c 6970 7061 6765 5f76 616c  max_slippage_val
+0000a880: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
+0000a890: 6574 7572 6e20 7365 6c66 2e70 7269 6365  eturn self.price
+0000a8a0: 5f74 6f5f 7072 6563 6973 696f 6e28 7061  _to_precision(pa
+0000a8b0: 6972 2c20 666f 7265 6361 7374 5f61 7667  ir, forecast_avg
+0000a8c0: 5f66 696c 6c65 645f 7072 6963 6529 0a0a  _filled_price)..
+0000a8d0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0000a8e0: 6174 650a 0a20 2020 2064 6566 205f 6472  ate..    def _dr
+0000a8f0: 795f 6973 5f70 7269 6365 5f63 726f 7373  y_is_price_cross
+0000a900: 6564 2873 656c 662c 2070 6169 723a 2073  ed(self, pair: s
+0000a910: 7472 2c20 7369 6465 3a20 7374 722c 206c  tr, side: str, l
+0000a920: 696d 6974 3a20 666c 6f61 742c 0a20 2020  imit: float,.   
+0000a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a940: 2020 2020 2020 2020 2020 206f 7264 6572             order
+0000a950: 626f 6f6b 3a20 4f70 7469 6f6e 616c 5b4f  book: Optional[O
+0000a960: 7264 6572 426f 6f6b 5d20 3d20 4e6f 6e65  rderBook] = None
+0000a970: 2c20 6f66 6673 6574 3a20 666c 6f61 7420  , offset: float 
+0000a980: 3d20 302e 3029 202d 3e20 626f 6f6c 3a0a  = 0.0) -> bool:.
+0000a990: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0000a9a0: 656c 662e 6578 6368 616e 6765 5f68 6173  elf.exchange_has
+0000a9b0: 2827 6665 7463 684c 324f 7264 6572 426f  ('fetchL2OrderBo
+0000a9c0: 6f6b 2729 3a0a 2020 2020 2020 2020 2020  ok'):.          
+0000a9d0: 2020 7265 7475 726e 2054 7275 650a 2020    return True.  
+0000a9e0: 2020 2020 2020 6966 206e 6f74 206f 7264        if not ord
+0000a9f0: 6572 626f 6f6b 3a0a 2020 2020 2020 2020  erbook:.        
+0000aa00: 2020 2020 6f72 6465 7262 6f6f 6b20 3d20      orderbook = 
+0000aa10: 7365 6c66 2e66 6574 6368 5f6c 325f 6f72  self.fetch_l2_or
+0000aa20: 6465 725f 626f 6f6b 2870 6169 722c 2031  der_book(pair, 1
+0000aa30: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+0000aa40: 2020 2020 2020 2020 2020 2069 6620 7369             if si
+0000aa50: 6465 203d 3d20 2762 7579 273a 0a20 2020  de == 'buy':.   
+0000aa60: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0000aa70: 6365 203d 206f 7264 6572 626f 6f6b 5b27  ce = orderbook['
+0000aa80: 6173 6b73 275d 5b30 5d5b 305d 0a20 2020  asks'][0][0].   
+0000aa90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000aaa0: 6c69 6d69 7420 2a20 2831 202d 206f 6666  limit * (1 - off
+0000aab0: 7365 7429 203e 3d20 7072 6963 653a 0a20  set) >= price:. 
+0000aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aad0: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
+0000aae0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000aaf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ab00: 2070 7269 6365 203d 206f 7264 6572 626f   price = orderbo
+0000ab10: 6f6b 5b27 6269 6473 275d 5b30 5d5b 305d  ok['bids'][0][0]
+0000ab20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ab30: 2069 6620 6c69 6d69 7420 2a20 2831 202b   if limit * (1 +
+0000ab40: 206f 6666 7365 7429 203c 3d20 7072 6963   offset) <= pric
+0000ab50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000ab60: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+0000ab70: 7565 0a20 2020 2020 2020 2065 7863 6570  ue.        excep
+0000ab80: 7420 496e 6465 7845 7272 6f72 3a0a 2020  t IndexError:.  
+0000ab90: 2020 2020 2020 2020 2020 2320 4967 6e6f            # Igno
+0000aba0: 7265 2065 6d70 7479 206f 7264 6572 626f  re empty orderbo
+0000abb0: 6f6b 7320 7768 656e 2066 696c 6c69 6e67  oks when filling
+0000abc0: 202d 2063 616e 2062 6520 6669 6c6c 6564   - can be filled
+0000abd0: 2077 6974 6820 7468 6520 6e65 7874 2069   with the next i
+0000abe0: 7465 7261 7469 6f6e 2e0a 2020 2020 2020  teration..      
+0000abf0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+0000ac00: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+0000ac10: 0a20 2020 2064 6566 2063 6865 636b 5f64  .    def check_d
+0000ac20: 7279 5f6c 696d 6974 5f6f 7264 6572 5f66  ry_limit_order_f
+0000ac30: 696c 6c65 6428 0a20 2020 2020 2020 2020  illed(.         
+0000ac40: 2020 2073 656c 662c 206f 7264 6572 3a20     self, order: 
+0000ac50: 4469 6374 5b73 7472 2c20 416e 795d 2c20  Dict[str, Any], 
+0000ac60: 696d 6d65 6469 6174 653a 2062 6f6f 6c20  immediate: bool 
+0000ac70: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+0000ac80: 2020 2020 206f 7264 6572 626f 6f6b 3a20       orderbook: 
+0000ac90: 4f70 7469 6f6e 616c 5b4f 7264 6572 426f  Optional[OrderBo
+0000aca0: 6f6b 5d20 3d20 4e6f 6e65 2920 2d3e 2044  ok] = None) -> D
+0000acb0: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+0000acc0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000acd0: 2020 2043 6865 636b 2064 7279 2d72 756e     Check dry-run
+0000ace0: 206c 696d 6974 206f 7264 6572 2066 696c   limit order fil
+0000acf0: 6c20 616e 6420 7570 6461 7465 2066 6565  l and update fee
+0000ad00: 2028 6966 2069 7420 6669 6c6c 6564 292e   (if it filled).
+0000ad10: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000ad20: 2020 2020 2069 6620 286f 7264 6572 5b27       if (order['
+0000ad30: 7374 6174 7573 275d 2021 3d20 2263 6c6f  status'] != "clo
+0000ad40: 7365 6422 0a20 2020 2020 2020 2020 2020  sed".           
+0000ad50: 2020 2020 2061 6e64 206f 7264 6572 5b27       and order['
+0000ad60: 7479 7065 275d 2069 6e20 5b22 6c69 6d69  type'] in ["limi
+0000ad70: 7422 5d0a 2020 2020 2020 2020 2020 2020  t"].            
+0000ad80: 2020 2020 616e 6420 6e6f 7420 6f72 6465      and not orde
+0000ad90: 722e 6765 7428 2766 745f 6f72 6465 725f  r.get('ft_order_
+0000ada0: 7479 7065 2729 293a 0a20 2020 2020 2020  type')):.       
+0000adb0: 2020 2020 2070 6169 7220 3d20 6f72 6465       pair = orde
+0000adc0: 725b 2773 796d 626f 6c27 5d0a 2020 2020  r['symbol'].    
+0000add0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000ade0: 5f64 7279 5f69 735f 7072 6963 655f 6372  _dry_is_price_cr
+0000adf0: 6f73 7365 6428 7061 6972 2c20 6f72 6465  ossed(pair, orde
+0000ae00: 725b 2773 6964 6527 5d2c 206f 7264 6572  r['side'], order
+0000ae10: 5b27 7072 6963 6527 5d2c 206f 7264 6572  ['price'], order
+0000ae20: 626f 6f6b 293a 0a20 2020 2020 2020 2020  book):.         
+0000ae30: 2020 2020 2020 206f 7264 6572 2e75 7064         order.upd
+0000ae40: 6174 6528 7b0a 2020 2020 2020 2020 2020  ate({.          
+0000ae50: 2020 2020 2020 2020 2020 2773 7461 7475            'statu
+0000ae60: 7327 3a20 2763 6c6f 7365 6427 2c0a 2020  s': 'closed',.  
+0000ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ae80: 2020 2766 696c 6c65 6427 3a20 6f72 6465    'filled': orde
+0000ae90: 725b 2761 6d6f 756e 7427 5d2c 0a20 2020  r['amount'],.   
+0000aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aeb0: 2027 7265 6d61 696e 696e 6727 3a20 302c   'remaining': 0,
+0000aec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000aed0: 207d 290a 0a20 2020 2020 2020 2020 2020   })..           
+0000aee0: 2020 2020 2073 656c 662e 6164 645f 6472       self.add_dr
+0000aef0: 795f 6f72 6465 725f 6665 6528 0a20 2020  y_order_fee(.   
+0000af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af10: 2070 6169 722c 0a20 2020 2020 2020 2020   pair,.         
+0000af20: 2020 2020 2020 2020 2020 206f 7264 6572             order
+0000af30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000af40: 2020 2020 2020 2774 616b 6572 2720 6966        'taker' if
+0000af50: 2069 6d6d 6564 6961 7465 2065 6c73 6520   immediate else 
+0000af60: 276d 616b 6572 272c 0a20 2020 2020 2020  'maker',.       
+0000af70: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0000af80: 2020 2020 7265 7475 726e 206f 7264 6572      return order
+0000af90: 0a0a 2020 2020 6465 6620 6665 7463 685f  ..    def fetch_
+0000afa0: 6472 795f 7275 6e5f 6f72 6465 7228 7365  dry_run_order(se
+0000afb0: 6c66 2c20 6f72 6465 725f 6964 2920 2d3e  lf, order_id) ->
+0000afc0: 2044 6963 745b 7374 722c 2041 6e79 5d3a   Dict[str, Any]:
+0000afd0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000afe0: 2020 2020 2052 6574 7572 6e20 6472 792d       Return dry-
+0000aff0: 7275 6e20 6f72 6465 720a 2020 2020 2020  run order.      
+0000b000: 2020 4f6e 6c79 2063 616c 6c20 6966 2072    Only call if r
+0000b010: 756e 6e69 6e67 2069 6e20 6472 792d 7275  unning in dry-ru
+0000b020: 6e20 6d6f 6465 2e0a 2020 2020 2020 2020  n mode..        
+0000b030: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
+0000b040: 0a20 2020 2020 2020 2020 2020 206f 7264  .            ord
+0000b050: 6572 203d 2073 656c 662e 5f64 7279 5f72  er = self._dry_r
+0000b060: 756e 5f6f 7065 6e5f 6f72 6465 7273 5b6f  un_open_orders[o
+0000b070: 7264 6572 5f69 645d 0a20 2020 2020 2020  rder_id].       
+0000b080: 2020 2020 206f 7264 6572 203d 2073 656c       order = sel
+0000b090: 662e 6368 6563 6b5f 6472 795f 6c69 6d69  f.check_dry_limi
+0000b0a0: 745f 6f72 6465 725f 6669 6c6c 6564 286f  t_order_filled(o
+0000b0b0: 7264 6572 290a 2020 2020 2020 2020 2020  rder).          
+0000b0c0: 2020 7265 7475 726e 206f 7264 6572 0a20    return order. 
+0000b0d0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+0000b0e0: 7945 7272 6f72 2061 7320 653a 0a20 2020  yError as e:.   
+0000b0f0: 2020 2020 2020 2020 2066 726f 6d20 6672           from fr
+0000b100: 6571 7472 6164 652e 7065 7273 6973 7465  eqtrade.persiste
+0000b110: 6e63 6520 696d 706f 7274 204f 7264 6572  nce import Order
+0000b120: 0a20 2020 2020 2020 2020 2020 206f 7264  .            ord
+0000b130: 6572 203d 204f 7264 6572 2e6f 7264 6572  er = Order.order
+0000b140: 5f62 795f 6964 286f 7264 6572 5f69 6429  _by_id(order_id)
+0000b150: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000b160: 6f72 6465 723a 0a20 2020 2020 2020 2020  order:.         
+0000b170: 2020 2020 2020 2063 6378 745f 6f72 6465         ccxt_orde
+0000b180: 7220 3d20 6f72 6465 722e 746f 5f63 6378  r = order.to_ccx
+0000b190: 745f 6f62 6a65 6374 2873 656c 662e 5f66  t_object(self._f
+0000b1a0: 745f 6861 735b 2773 746f 705f 7072 6963  t_has['stop_pric
+0000b1b0: 655f 7061 7261 6d27 5d29 0a20 2020 2020  e_param']).     
+0000b1c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000b1d0: 5f64 7279 5f72 756e 5f6f 7065 6e5f 6f72  _dry_run_open_or
+0000b1e0: 6465 7273 5b6f 7264 6572 5f69 645d 203d  ders[order_id] =
+0000b1f0: 2063 6378 745f 6f72 6465 720a 2020 2020   ccxt_order.    
+0000b200: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000b210: 726e 2063 6378 745f 6f72 6465 720a 2020  rn ccxt_order.  
+0000b220: 2020 2020 2020 2020 2020 2320 4772 6163            # Grac
+0000b230: 6566 756c 6c79 2068 616e 646c 6520 6572  efully handle er
+0000b240: 726f 7273 2077 6974 6820 6472 792d 7275  rors with dry-ru
+0000b250: 6e20 6f72 6465 7273 2e0a 2020 2020 2020  n orders..      
+0000b260: 2020 2020 2020 7261 6973 6520 496e 7661        raise Inva
+0000b270: 6c69 644f 7264 6572 4578 6365 7074 696f  lidOrderExceptio
+0000b280: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+0000b290: 2020 2066 2754 7269 6564 2074 6f20 6765     f'Tried to ge
+0000b2a0: 7420 616e 2069 6e76 616c 6964 2064 7279  t an invalid dry
+0000b2b0: 2d72 756e 2d6f 7264 6572 2028 6964 3a20  -run-order (id: 
+0000b2c0: 7b6f 7264 6572 5f69 647d 292e 204d 6573  {order_id}). Mes
+0000b2d0: 7361 6765 3a20 7b65 7d27 2920 6672 6f6d  sage: {e}') from
+0000b2e0: 2065 0a0a 2020 2020 2320 4f72 6465 7220   e..    # Order 
+0000b2f0: 6861 6e64 6c69 6e67 0a0a 2020 2020 6465  handling..    de
+0000b300: 6620 5f6c 6576 5f70 7265 7028 7365 6c66  f _lev_prep(self
+0000b310: 2c20 7061 6972 3a20 7374 722c 206c 6576  , pair: str, lev
+0000b320: 6572 6167 653a 2066 6c6f 6174 2c20 7369  erage: float, si
+0000b330: 6465 3a20 4275 7953 656c 6c2c 2061 6363  de: BuySell, acc
+0000b340: 6570 745f 6661 696c 3a20 626f 6f6c 203d  ept_fail: bool =
+0000b350: 2046 616c 7365 293a 0a20 2020 2020 2020   False):.       
+0000b360: 2069 6620 7365 6c66 2e74 7261 6469 6e67   if self.trading
+0000b370: 5f6d 6f64 6520 213d 2054 7261 6469 6e67  _mode != Trading
+0000b380: 4d6f 6465 2e53 504f 543a 0a20 2020 2020  Mode.SPOT:.     
+0000b390: 2020 2020 2020 2073 656c 662e 7365 745f         self.set_
+0000b3a0: 6d61 7267 696e 5f6d 6f64 6528 7061 6972  margin_mode(pair
+0000b3b0: 2c20 7365 6c66 2e6d 6172 6769 6e5f 6d6f  , self.margin_mo
+0000b3c0: 6465 2c20 6163 6365 7074 5f66 6169 6c29  de, accept_fail)
+0000b3d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000b3e0: 662e 5f73 6574 5f6c 6576 6572 6167 6528  f._set_leverage(
+0000b3f0: 6c65 7665 7261 6765 2c20 7061 6972 2c20  leverage, pair, 
+0000b400: 6163 6365 7074 5f66 6169 6c29 0a0a 2020  accept_fail)..  
+0000b410: 2020 6465 6620 5f67 6574 5f70 6172 616d    def _get_param
+0000b420: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+0000b430: 0a20 2020 2020 2020 2073 6964 653a 2042  .        side: B
+0000b440: 7579 5365 6c6c 2c0a 2020 2020 2020 2020  uySell,.        
+0000b450: 6f72 6465 7274 7970 653a 2073 7472 2c0a  ordertype: str,.
+0000b460: 2020 2020 2020 2020 6c65 7665 7261 6765          leverage
+0000b470: 3a20 666c 6f61 742c 0a20 2020 2020 2020  : float,.       
+0000b480: 2072 6564 7563 654f 6e6c 793a 2062 6f6f   reduceOnly: boo
+0000b490: 6c2c 0a20 2020 2020 2020 2074 696d 655f  l,.        time_
+0000b4a0: 696e 5f66 6f72 6365 3a20 7374 7220 3d20  in_force: str = 
+0000b4b0: 2747 5443 272c 0a20 2020 2029 202d 3e20  'GTC',.    ) -> 
+0000b4c0: 4469 6374 3a0a 2020 2020 2020 2020 7061  Dict:.        pa
+0000b4d0: 7261 6d73 203d 2073 656c 662e 5f70 6172  rams = self._par
+0000b4e0: 616d 732e 636f 7079 2829 0a20 2020 2020  ams.copy().     
+0000b4f0: 2020 2069 6620 7469 6d65 5f69 6e5f 666f     if time_in_fo
+0000b500: 7263 6520 213d 2027 4754 4327 2061 6e64  rce != 'GTC' and
+0000b510: 206f 7264 6572 7479 7065 2021 3d20 276d   ordertype != 'm
+0000b520: 6172 6b65 7427 3a0a 2020 2020 2020 2020  arket':.        
+0000b530: 2020 2020 7061 7261 6d73 2e75 7064 6174      params.updat
+0000b540: 6528 7b27 7469 6d65 496e 466f 7263 6527  e({'timeInForce'
+0000b550: 3a20 7469 6d65 5f69 6e5f 666f 7263 652e  : time_in_force.
+0000b560: 7570 7065 7228 297d 290a 2020 2020 2020  upper()}).      
+0000b570: 2020 6966 2072 6564 7563 654f 6e6c 793a    if reduceOnly:
+0000b580: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
+0000b590: 616d 732e 7570 6461 7465 287b 2772 6564  ams.update({'red
+0000b5a0: 7563 654f 6e6c 7927 3a20 5472 7565 7d29  uceOnly': True})
+0000b5b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000b5c0: 7061 7261 6d73 0a0a 2020 2020 6465 6620  params..    def 
+0000b5d0: 5f6f 7264 6572 5f6e 6565 6473 5f70 7269  _order_needs_pri
+0000b5e0: 6365 2873 656c 662c 206f 7264 6572 7479  ce(self, orderty
+0000b5f0: 7065 3a20 7374 7229 202d 3e20 626f 6f6c  pe: str) -> bool
+0000b600: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000b610: 2028 0a20 2020 2020 2020 2020 2020 206f   (.            o
+0000b620: 7264 6572 7479 7065 2021 3d20 276d 6172  rdertype != 'mar
+0000b630: 6b65 7427 0a20 2020 2020 2020 2020 2020  ket'.           
+0000b640: 206f 7220 7365 6c66 2e5f 6170 692e 6f70   or self._api.op
+0000b650: 7469 6f6e 732e 6765 7428 2263 7265 6174  tions.get("creat
+0000b660: 654d 6172 6b65 7442 7579 4f72 6465 7252  eMarketBuyOrderR
+0000b670: 6571 7569 7265 7350 7269 6365 222c 2046  equiresPrice", F
+0000b680: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
+0000b690: 2020 6f72 2073 656c 662e 5f66 745f 6861    or self._ft_ha
+0000b6a0: 732e 6765 7428 276d 6172 6b65 744f 7264  s.get('marketOrd
+0000b6b0: 6572 5265 7175 6972 6573 5072 6963 6527  erRequiresPrice'
+0000b6c0: 2c20 4661 6c73 6529 0a20 2020 2020 2020  , False).       
+0000b6d0: 2029 0a0a 2020 2020 6465 6620 6372 6561   )..    def crea
+0000b6e0: 7465 5f6f 7264 6572 280a 2020 2020 2020  te_order(.      
+0000b6f0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0000b700: 2a2c 0a20 2020 2020 2020 2070 6169 723a  *,.        pair:
+0000b710: 2073 7472 2c0a 2020 2020 2020 2020 6f72   str,.        or
+0000b720: 6465 7274 7970 653a 2073 7472 2c0a 2020  dertype: str,.  
+0000b730: 2020 2020 2020 7369 6465 3a20 4275 7953        side: BuyS
+0000b740: 656c 6c2c 0a20 2020 2020 2020 2061 6d6f  ell,.        amo
+0000b750: 756e 743a 2066 6c6f 6174 2c0a 2020 2020  unt: float,.    
+0000b760: 2020 2020 7261 7465 3a20 666c 6f61 742c      rate: float,
+0000b770: 0a20 2020 2020 2020 206c 6576 6572 6167  .        leverag
+0000b780: 653a 2066 6c6f 6174 2c0a 2020 2020 2020  e: float,.      
+0000b790: 2020 7265 6475 6365 4f6e 6c79 3a20 626f    reduceOnly: bo
+0000b7a0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+0000b7b0: 2020 2020 7469 6d65 5f69 6e5f 666f 7263      time_in_forc
+0000b7c0: 653a 2073 7472 203d 2027 4754 4327 2c0a  e: str = 'GTC',.
+0000b7d0: 2020 2020 2920 2d3e 2044 6963 743a 0a20      ) -> Dict:. 
+0000b7e0: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+0000b7f0: 636f 6e66 6967 5b27 6472 795f 7275 6e27  config['dry_run'
+0000b800: 5d3a 0a20 2020 2020 2020 2020 2020 2064  ]:.            d
+0000b810: 7279 5f6f 7264 6572 203d 2073 656c 662e  ry_order = self.
+0000b820: 6372 6561 7465 5f64 7279 5f72 756e 5f6f  create_dry_run_o
+0000b830: 7264 6572 280a 2020 2020 2020 2020 2020  rder(.          
+0000b840: 2020 2020 2020 7061 6972 2c20 6f72 6465        pair, orde
+0000b850: 7274 7970 652c 2073 6964 652c 2061 6d6f  rtype, side, amo
+0000b860: 756e 742c 2073 656c 662e 7072 6963 655f  unt, self.price_
+0000b870: 746f 5f70 7265 6369 7369 6f6e 2870 6169  to_precision(pai
+0000b880: 722c 2072 6174 6529 2c20 6c65 7665 7261  r, rate), levera
+0000b890: 6765 290a 2020 2020 2020 2020 2020 2020  ge).            
+0000b8a0: 7265 7475 726e 2064 7279 5f6f 7264 6572  return dry_order
+0000b8b0: 0a0a 2020 2020 2020 2020 7061 7261 6d73  ..        params
+0000b8c0: 203d 2073 656c 662e 5f67 6574 5f70 6172   = self._get_par
+0000b8d0: 616d 7328 7369 6465 2c20 6f72 6465 7274  ams(side, ordert
+0000b8e0: 7970 652c 206c 6576 6572 6167 652c 2072  ype, leverage, r
+0000b8f0: 6564 7563 654f 6e6c 792c 2074 696d 655f  educeOnly, time_
+0000b900: 696e 5f66 6f72 6365 290a 0a20 2020 2020  in_force)..     
+0000b910: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000b920: 2020 2020 2320 5365 7420 7468 6520 7072      # Set the pr
+0000b930: 6563 6973 696f 6e20 666f 7220 616d 6f75  ecision for amou
+0000b940: 6e74 2061 6e64 2070 7269 6365 2872 6174  nt and price(rat
+0000b950: 6529 2061 7320 6163 6365 7074 6564 2062  e) as accepted b
+0000b960: 7920 7468 6520 6578 6368 616e 6765 0a20  y the exchange. 
+0000b970: 2020 2020 2020 2020 2020 2061 6d6f 756e             amoun
+0000b980: 7420 3d20 7365 6c66 2e61 6d6f 756e 745f  t = self.amount_
+0000b990: 746f 5f70 7265 6369 7369 6f6e 2870 6169  to_precision(pai
+0000b9a0: 722c 2073 656c 662e 5f61 6d6f 756e 745f  r, self._amount_
+0000b9b0: 746f 5f63 6f6e 7472 6163 7473 2870 6169  to_contracts(pai
+0000b9c0: 722c 2061 6d6f 756e 7429 290a 2020 2020  r, amount)).    
+0000b9d0: 2020 2020 2020 2020 6e65 6564 735f 7072          needs_pr
+0000b9e0: 6963 6520 3d20 7365 6c66 2e5f 6f72 6465  ice = self._orde
+0000b9f0: 725f 6e65 6564 735f 7072 6963 6528 6f72  r_needs_price(or
+0000ba00: 6465 7274 7970 6529 0a20 2020 2020 2020  dertype).       
+0000ba10: 2020 2020 2072 6174 655f 666f 725f 6f72       rate_for_or
+0000ba20: 6465 7220 3d20 7365 6c66 2e70 7269 6365  der = self.price
+0000ba30: 5f74 6f5f 7072 6563 6973 696f 6e28 7061  _to_precision(pa
+0000ba40: 6972 2c20 7261 7465 2920 6966 206e 6565  ir, rate) if nee
+0000ba50: 6473 5f70 7269 6365 2065 6c73 6520 4e6f  ds_price else No
+0000ba60: 6e65 0a0a 2020 2020 2020 2020 2020 2020  ne..            
+0000ba70: 6966 206e 6f74 2072 6564 7563 654f 6e6c  if not reduceOnl
+0000ba80: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000ba90: 2020 2073 656c 662e 5f6c 6576 5f70 7265     self._lev_pre
+0000baa0: 7028 7061 6972 2c20 6c65 7665 7261 6765  p(pair, leverage
+0000bab0: 2c20 7369 6465 290a 0a20 2020 2020 2020  , side)..       
+0000bac0: 2020 2020 206f 7264 6572 203d 2073 656c       order = sel
+0000bad0: 662e 5f61 7069 2e63 7265 6174 655f 6f72  f._api.create_or
+0000bae0: 6465 7228 0a20 2020 2020 2020 2020 2020  der(.           
+0000baf0: 2020 2020 2070 6169 722c 0a20 2020 2020       pair,.     
+0000bb00: 2020 2020 2020 2020 2020 206f 7264 6572             order
+0000bb10: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+0000bb20: 2020 2020 2020 7369 6465 2c0a 2020 2020        side,.    
+0000bb30: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
+0000bb40: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0000bb50: 2020 2020 7261 7465 5f66 6f72 5f6f 7264      rate_for_ord
+0000bb60: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+0000bb70: 2020 2020 7061 7261 6d73 2c0a 2020 2020      params,.    
+0000bb80: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000bb90: 2020 2020 2020 7365 6c66 2e5f 6c6f 675f        self._log_
+0000bba0: 6578 6368 616e 6765 5f72 6573 706f 6e73  exchange_respons
+0000bbb0: 6528 2763 7265 6174 655f 6f72 6465 7227  e('create_order'
+0000bbc0: 2c20 6f72 6465 7229 0a20 2020 2020 2020  , order).       
+0000bbd0: 2020 2020 206f 7264 6572 203d 2073 656c       order = sel
+0000bbe0: 662e 5f6f 7264 6572 5f63 6f6e 7472 6163  f._order_contrac
+0000bbf0: 7473 5f74 6f5f 616d 6f75 6e74 286f 7264  ts_to_amount(ord
+0000bc00: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+0000bc10: 7265 7475 726e 206f 7264 6572 0a0a 2020  return order..  
+0000bc20: 2020 2020 2020 6578 6365 7074 2063 6378        except ccx
+0000bc30: 742e 496e 7375 6666 6963 6965 6e74 4675  t.InsufficientFu
+0000bc40: 6e64 7320 6173 2065 3a0a 2020 2020 2020  nds as e:.      
+0000bc50: 2020 2020 2020 7261 6973 6520 496e 7375        raise Insu
+0000bc60: 6666 6963 6965 6e74 4675 6e64 7345 7272  fficientFundsErr
+0000bc70: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000bc80: 2020 2020 6627 496e 7375 6666 6963 6965      f'Insufficie
+0000bc90: 6e74 2066 756e 6473 2074 6f20 6372 6561  nt funds to crea
+0000bca0: 7465 207b 6f72 6465 7274 7970 657d 207b  te {ordertype} {
+0000bcb0: 7369 6465 7d20 6f72 6465 7220 6f6e 206d  side} order on m
+0000bcc0: 6172 6b65 7420 7b70 6169 727d 2e20 270a  arket {pair}. '.
+0000bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bce0: 6627 5472 6965 6420 746f 207b 7369 6465  f'Tried to {side
+0000bcf0: 7d20 616d 6f75 6e74 207b 616d 6f75 6e74  } amount {amount
+0000bd00: 7d20 6174 2072 6174 6520 7b72 6174 657d  } at rate {rate}
+0000bd10: 2e27 0a20 2020 2020 2020 2020 2020 2020  .'.             
+0000bd20: 2020 2066 274d 6573 7361 6765 3a20 7b65     f'Message: {e
+0000bd30: 7d27 2920 6672 6f6d 2065 0a20 2020 2020  }') from e.     
+0000bd40: 2020 2065 7863 6570 7420 6363 7874 2e49     except ccxt.I
+0000bd50: 6e76 616c 6964 4f72 6465 7220 6173 2065  nvalidOrder as e
+0000bd60: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000bd70: 6973 6520 496e 7661 6c69 644f 7264 6572  ise InvalidOrder
+0000bd80: 4578 6365 7074 696f 6e28 0a20 2020 2020  Exception(.     
+0000bd90: 2020 2020 2020 2020 2020 2066 2743 6f75             f'Cou
+0000bda0: 6c64 206e 6f74 2063 7265 6174 6520 7b6f  ld not create {o
+0000bdb0: 7264 6572 7479 7065 7d20 7b73 6964 657d  rdertype} {side}
+0000bdc0: 206f 7264 6572 206f 6e20 6d61 726b 6574   order on market
+0000bdd0: 207b 7061 6972 7d2e 2027 0a20 2020 2020   {pair}. '.     
+0000bde0: 2020 2020 2020 2020 2020 2066 2754 7269             f'Tri
+0000bdf0: 6564 2074 6f20 7b73 6964 657d 2061 6d6f  ed to {side} amo
+0000be00: 756e 7420 7b61 6d6f 756e 747d 2061 7420  unt {amount} at 
+0000be10: 7261 7465 207b 7261 7465 7d2e 2027 0a20  rate {rate}. '. 
+0000be20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000be30: 274d 6573 7361 6765 3a20 7b65 7d27 2920  'Message: {e}') 
+0000be40: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
+0000be50: 7863 6570 7420 6363 7874 2e44 446f 5350  xcept ccxt.DDoSP
+0000be60: 726f 7465 6374 696f 6e20 6173 2065 3a0a  rotection as e:.
+0000be70: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000be80: 6520 4444 6f73 5072 6f74 6563 7469 6f6e  e DDosProtection
+0000be90: 2865 2920 6672 6f6d 2065 0a20 2020 2020  (e) from e.     
+0000bea0: 2020 2065 7863 6570 7420 2863 6378 742e     except (ccxt.
+0000beb0: 4e65 7477 6f72 6b45 7272 6f72 2c20 6363  NetworkError, cc
+0000bec0: 7874 2e45 7863 6861 6e67 6545 7272 6f72  xt.ExchangeError
+0000bed0: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
+0000bee0: 2020 2020 7261 6973 6520 5465 6d70 6f72      raise Tempor
+0000bef0: 6172 7945 7272 6f72 280a 2020 2020 2020  aryError(.      
+0000bf00: 2020 2020 2020 2020 2020 6627 436f 756c            f'Coul
+0000bf10: 6420 6e6f 7420 706c 6163 6520 7b73 6964  d not place {sid
+0000bf20: 657d 206f 7264 6572 2064 7565 2074 6f20  e} order due to 
+0000bf30: 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  {e.__class__.__n
+0000bf40: 616d 655f 5f7d 2e20 4d65 7373 6167 653a  ame__}. Message:
+0000bf50: 207b 657d 2729 2066 726f 6d20 650a 2020   {e}') from e.  
+0000bf60: 2020 2020 2020 6578 6365 7074 2063 6378        except ccx
+0000bf70: 742e 4261 7365 4572 726f 7220 6173 2065  t.BaseError as e
+0000bf80: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000bf90: 6973 6520 4f70 6572 6174 696f 6e61 6c45  ise OperationalE
+0000bfa0: 7863 6570 7469 6f6e 2865 2920 6672 6f6d  xception(e) from
+0000bfb0: 2065 0a0a 2020 2020 6465 6620 7374 6f70   e..    def stop
+0000bfc0: 6c6f 7373 5f61 646a 7573 7428 7365 6c66  loss_adjust(self
+0000bfd0: 2c20 7374 6f70 5f6c 6f73 733a 2066 6c6f  , stop_loss: flo
+0000bfe0: 6174 2c20 6f72 6465 723a 2044 6963 742c  at, order: Dict,
+0000bff0: 2073 6964 653a 2073 7472 2920 2d3e 2062   side: str) -> b
+0000c000: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
+0000c010: 0a20 2020 2020 2020 2056 6572 6966 7920  .        Verify 
+0000c020: 7374 6f70 5f6c 6f73 7320 6167 6169 6e73  stop_loss agains
+0000c030: 7420 7374 6f70 6c6f 7373 2d6f 7264 6572  t stoploss-order
+0000c040: 2076 616c 7565 2028 6c69 6d69 7420 6f72   value (limit or
+0000c050: 2070 7269 6365 290a 2020 2020 2020 2020   price).        
+0000c060: 5265 7475 726e 7320 5472 7565 2069 6620  Returns True if 
+0000c070: 6164 6a75 7374 6d65 6e74 2069 7320 6e65  adjustment is ne
+0000c080: 6365 7373 6172 792e 0a20 2020 2020 2020  cessary..       
+0000c090: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+0000c0a0: 6e6f 7420 7365 6c66 2e5f 6674 5f68 6173  not self._ft_has
+0000c0b0: 2e67 6574 2827 7374 6f70 6c6f 7373 5f6f  .get('stoploss_o
+0000c0c0: 6e5f 6578 6368 616e 6765 2729 3a0a 2020  n_exchange'):.  
+0000c0d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000c0e0: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
+0000c0f0: 7469 6f6e 2866 2273 746f 706c 6f73 7320  tion(f"stoploss 
+0000c100: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
+0000c110: 6564 2066 6f72 207b 7365 6c66 2e6e 616d  ed for {self.nam
+0000c120: 657d 2e22 290a 2020 2020 2020 2020 7072  e}.").        pr
+0000c130: 6963 655f 7061 7261 6d20 3d20 7365 6c66  ice_param = self
+0000c140: 2e5f 6674 5f68 6173 5b27 7374 6f70 5f70  ._ft_has['stop_p
+0000c150: 7269 6365 5f70 6172 616d 275d 0a20 2020  rice_param'].   
+0000c160: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
+0000c170: 2020 2020 2020 2020 2020 6f72 6465 722e            order.
+0000c180: 6765 7428 7072 6963 655f 7061 7261 6d2c  get(price_param,
+0000c190: 204e 6f6e 6529 2069 7320 4e6f 6e65 0a20   None) is None. 
+0000c1a0: 2020 2020 2020 2020 2020 206f 7220 2828             or ((
+0000c1b0: 7369 6465 203d 3d20 2273 656c 6c22 2061  side == "sell" a
+0000c1c0: 6e64 2073 746f 705f 6c6f 7373 203e 2066  nd stop_loss > f
+0000c1d0: 6c6f 6174 286f 7264 6572 5b70 7269 6365  loat(order[price
+0000c1e0: 5f70 6172 616d 5d29 2920 6f72 0a20 2020  _param])) or.   
+0000c1f0: 2020 2020 2020 2020 2020 2020 2028 7369               (si
+0000c200: 6465 203d 3d20 2262 7579 2220 616e 6420  de == "buy" and 
+0000c210: 7374 6f70 5f6c 6f73 7320 3c20 666c 6f61  stop_loss < floa
+0000c220: 7428 6f72 6465 725b 7072 6963 655f 7061  t(order[price_pa
+0000c230: 7261 6d5d 2929 290a 2020 2020 2020 2020  ram]))).        
+0000c240: 290a 0a20 2020 2064 6566 205f 6765 745f  )..    def _get_
+0000c250: 7374 6f70 5f6f 7264 6572 5f74 7970 6528  stop_order_type(
+0000c260: 7365 6c66 2c20 7573 6572 5f6f 7264 6572  self, user_order
+0000c270: 5f74 7970 6529 202d 3e20 5475 706c 655b  _type) -> Tuple[
+0000c280: 7374 722c 2073 7472 5d3a 0a0a 2020 2020  str, str]:..    
+0000c290: 2020 2020 6176 6169 6c61 626c 655f 6f72      available_or
+0000c2a0: 6465 725f 5479 7065 733a 2044 6963 745b  der_Types: Dict[
+0000c2b0: 7374 722c 2073 7472 5d20 3d20 7365 6c66  str, str] = self
+0000c2c0: 2e5f 6674 5f68 6173 5b22 7374 6f70 6c6f  ._ft_has["stoplo
+0000c2d0: 7373 5f6f 7264 6572 5f74 7970 6573 225d  ss_order_types"]
+0000c2e0: 0a0a 2020 2020 2020 2020 6966 2075 7365  ..        if use
+0000c2f0: 725f 6f72 6465 725f 7479 7065 2069 6e20  r_order_type in 
+0000c300: 6176 6169 6c61 626c 655f 6f72 6465 725f  available_order_
+0000c310: 5479 7065 732e 6b65 7973 2829 3a0a 2020  Types.keys():.  
+0000c320: 2020 2020 2020 2020 2020 6f72 6465 7274            ordert
+0000c330: 7970 6520 3d20 6176 6169 6c61 626c 655f  ype = available_
+0000c340: 6f72 6465 725f 5479 7065 735b 7573 6572  order_Types[user
+0000c350: 5f6f 7264 6572 5f74 7970 655d 0a20 2020  _order_type].   
+0000c360: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000c370: 2020 2020 2020 2023 204f 7468 6572 7769         # Otherwi
+0000c380: 7365 2070 6963 6b20 6f6e 6c79 206f 6e65  se pick only one
+0000c390: 2061 7661 696c 6162 6c65 0a20 2020 2020   available.     
+0000c3a0: 2020 2020 2020 206f 7264 6572 7479 7065         ordertype
+0000c3b0: 203d 206c 6973 7428 6176 6169 6c61 626c   = list(availabl
+0000c3c0: 655f 6f72 6465 725f 5479 7065 732e 7661  e_order_Types.va
+0000c3d0: 6c75 6573 2829 295b 305d 0a20 2020 2020  lues())[0].     
+0000c3e0: 2020 2020 2020 2075 7365 725f 6f72 6465         user_orde
+0000c3f0: 725f 7479 7065 203d 206c 6973 7428 6176  r_type = list(av
+0000c400: 6169 6c61 626c 655f 6f72 6465 725f 5479  ailable_order_Ty
+0000c410: 7065 732e 6b65 7973 2829 295b 305d 0a20  pes.keys())[0]. 
+0000c420: 2020 2020 2020 2072 6574 7572 6e20 6f72         return or
+0000c430: 6465 7274 7970 652c 2075 7365 725f 6f72  dertype, user_or
+0000c440: 6465 725f 7479 7065 0a0a 2020 2020 6465  der_type..    de
+0000c450: 6620 5f67 6574 5f73 746f 705f 6c69 6d69  f _get_stop_limi
+0000c460: 745f 7261 7465 2873 656c 662c 2073 746f  t_rate(self, sto
+0000c470: 705f 7072 6963 653a 2066 6c6f 6174 2c20  p_price: float, 
+0000c480: 6f72 6465 725f 7479 7065 733a 2044 6963  order_types: Dic
+0000c490: 742c 2073 6964 653a 2073 7472 2920 2d3e  t, side: str) ->
+0000c4a0: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
+0000c4b0: 2320 4c69 6d69 7420 7072 6963 6520 7468  # Limit price th
+0000c4c0: 7265 7368 6f6c 643a 2041 7320 6c69 6d69  reshold: As limi
+0000c4d0: 7420 7072 6963 6520 7368 6f75 6c64 2061  t price should a
+0000c4e0: 6c77 6179 7320 6265 2062 656c 6f77 2073  lways be below s
+0000c4f0: 746f 702d 7072 6963 650a 2020 2020 2020  top-price.      
+0000c500: 2020 6c69 6d69 745f 7072 6963 655f 7063    limit_price_pc
+0000c510: 7420 3d20 6f72 6465 725f 7479 7065 732e  t = order_types.
+0000c520: 6765 7428 2773 746f 706c 6f73 735f 6f6e  get('stoploss_on
+0000c530: 5f65 7863 6861 6e67 655f 6c69 6d69 745f  _exchange_limit_
+0000c540: 7261 7469 6f27 2c20 302e 3939 290a 2020  ratio', 0.99).  
+0000c550: 2020 2020 2020 6966 2073 6964 6520 3d3d        if side ==
+0000c560: 2022 7365 6c6c 223a 0a20 2020 2020 2020   "sell":.       
+0000c570: 2020 2020 206c 696d 6974 5f72 6174 6520       limit_rate 
+0000c580: 3d20 7374 6f70 5f70 7269 6365 202a 206c  = stop_price * l
+0000c590: 696d 6974 5f70 7269 6365 5f70 6374 0a20  imit_price_pct. 
+0000c5a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000c5b0: 2020 2020 2020 2020 206c 696d 6974 5f72           limit_r
+0000c5c0: 6174 6520 3d20 7374 6f70 5f70 7269 6365  ate = stop_price
+0000c5d0: 202a 2028 3220 2d20 6c69 6d69 745f 7072   * (2 - limit_pr
+0000c5e0: 6963 655f 7063 7429 0a0a 2020 2020 2020  ice_pct)..      
+0000c5f0: 2020 6261 645f 7374 6f70 5f70 7269 6365    bad_stop_price
+0000c600: 203d 2028 2873 746f 705f 7072 6963 6520   = ((stop_price 
+0000c610: 3c3d 206c 696d 6974 5f72 6174 6529 2069  <= limit_rate) i
+0000c620: 6620 7369 6465 203d 3d0a 2020 2020 2020  f side ==.      
+0000c630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c640: 2020 2020 2273 656c 6c22 2065 6c73 6520      "sell" else 
+0000c650: 2873 746f 705f 7072 6963 6520 3e3d 206c  (stop_price >= l
+0000c660: 696d 6974 5f72 6174 6529 290a 2020 2020  imit_rate)).    
+0000c670: 2020 2020 2320 456e 7375 7265 2072 6174      # Ensure rat
+0000c680: 6520 6973 206c 6573 7320 7468 616e 2073  e is less than s
+0000c690: 746f 7020 7072 6963 650a 2020 2020 2020  top price.      
+0000c6a0: 2020 6966 2062 6164 5f73 746f 705f 7072    if bad_stop_pr
+0000c6b0: 6963 653a 0a20 2020 2020 2020 2020 2020  ice:.           
+0000c6c0: 2023 2054 6869 7320 6361 6e20 666f 7220   # This can for 
+0000c6d0: 6578 616d 706c 6520 6861 7070 656e 2069  example happen i
+0000c6e0: 6620 7468 6520 7374 6f70 202f 206c 6971  f the stop / liq
+0000c6f0: 7569 6461 7469 6f6e 2070 7269 6365 2069  uidation price i
+0000c700: 7320 7365 7420 746f 2030 0a20 2020 2020  s set to 0.     
+0000c710: 2020 2020 2020 2023 2057 6869 6368 2069         # Which i
+0000c720: 7320 706f 7373 6962 6c65 2069 6620 6120  s possible if a 
+0000c730: 6d61 726b 6574 2d6f 7264 6572 2063 6c6f  market-order clo
+0000c740: 7365 7320 7269 6768 7420 6177 6179 2e0a  ses right away..
+0000c750: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+0000c760: 6520 496e 7661 6c69 644f 7264 6572 4578  e InvalidOrderEx
+0000c770: 6365 7074 696f 6e20 7769 6c6c 2062 7562  ception will bub
+0000c780: 626c 6520 7570 2074 6f20 6578 6974 5f70  ble up to exit_p
+0000c790: 6f73 6974 696f 6e73 2c20 7768 6572 6520  ositions, where 
+0000c7a0: 6974 2077 696c 6c20 6265 0a20 2020 2020  it will be.     
+0000c7b0: 2020 2020 2020 2023 2068 616e 646c 6564         # handled
+0000c7c0: 2067 7261 6365 6675 6c6c 792e 0a20 2020   gracefully..   
+0000c7d0: 2020 2020 2020 2020 2072 6169 7365 2049           raise I
+0000c7e0: 6e76 616c 6964 4f72 6465 7245 7863 6570  nvalidOrderExcep
+0000c7f0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+0000c800: 2020 2020 2020 2249 6e20 7374 6f70 6c6f        "In stoplo
+0000c810: 7373 206c 696d 6974 206f 7264 6572 2c20  ss limit order, 
+0000c820: 7374 6f70 2070 7269 6365 2073 686f 756c  stop price shoul
+0000c830: 6420 6265 206d 6f72 6520 7468 616e 206c  d be more than l
+0000c840: 696d 6974 2070 7269 6365 2e20 220a 2020  imit price. ".  
+0000c850: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0000c860: 5374 6f70 2070 7269 6365 3a20 7b73 746f  Stop price: {sto
+0000c870: 705f 7072 6963 657d 2c20 4c69 6d69 7420  p_price}, Limit 
+0000c880: 7072 6963 653a 207b 6c69 6d69 745f 7261  price: {limit_ra
+0000c890: 7465 7d2c 2022 0a20 2020 2020 2020 2020  te}, ".         
+0000c8a0: 2020 2020 2020 2066 224c 696d 6974 2050         f"Limit P
+0000c8b0: 7269 6365 2070 6374 3a20 7b6c 696d 6974  rice pct: {limit
+0000c8c0: 5f70 7269 6365 5f70 6374 7d22 0a20 2020  _price_pct}".   
+0000c8d0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0000c8e0: 2020 2020 2020 2072 6574 7572 6e20 6c69         return li
+0000c8f0: 6d69 745f 7261 7465 0a0a 2020 2020 6465  mit_rate..    de
+0000c900: 6620 5f67 6574 5f73 746f 705f 7061 7261  f _get_stop_para
+0000c910: 6d73 2873 656c 662c 2073 6964 653a 2042  ms(self, side: B
+0000c920: 7579 5365 6c6c 2c20 6f72 6465 7274 7970  uySell, ordertyp
+0000c930: 653a 2073 7472 2c20 7374 6f70 5f70 7269  e: str, stop_pri
+0000c940: 6365 3a20 666c 6f61 7429 202d 3e20 4469  ce: float) -> Di
+0000c950: 6374 3a0a 2020 2020 2020 2020 7061 7261  ct:.        para
+0000c960: 6d73 203d 2073 656c 662e 5f70 6172 616d  ms = self._param
+0000c970: 732e 636f 7079 2829 0a20 2020 2020 2020  s.copy().       
+0000c980: 2023 2056 6572 6966 7920 6966 2073 746f   # Verify if sto
+0000c990: 7050 7269 6365 2077 6f72 6b73 2066 6f72  pPrice works for
+0000c9a0: 2079 6f75 7220 6578 6368 616e 6765 2c20   your exchange, 
+0000c9b0: 656c 7365 2063 6f6e 6669 6775 7265 2073  else configure s
+0000c9c0: 746f 705f 7072 6963 655f 7061 7261 6d0a  top_price_param.
+0000c9d0: 2020 2020 2020 2020 7061 7261 6d73 2e75          params.u
+0000c9e0: 7064 6174 6528 7b73 656c 662e 5f66 745f  pdate({self._ft_
+0000c9f0: 6861 735b 2773 746f 705f 7072 6963 655f  has['stop_price_
+0000ca00: 7061 7261 6d27 5d3a 2073 746f 705f 7072  param']: stop_pr
+0000ca10: 6963 657d 290a 2020 2020 2020 2020 7265  ice}).        re
+0000ca20: 7475 726e 2070 6172 616d 730a 0a20 2020  turn params..   
+0000ca30: 2040 7265 7472 6965 7228 7265 7472 6965   @retrier(retrie
+0000ca40: 733d 3029 0a20 2020 2064 6566 2063 7265  s=0).    def cre
+0000ca50: 6174 655f 7374 6f70 6c6f 7373 2873 656c  ate_stoploss(sel
+0000ca60: 662c 2070 6169 723a 2073 7472 2c20 616d  f, pair: str, am
+0000ca70: 6f75 6e74 3a20 666c 6f61 742c 2073 746f  ount: float, sto
+0000ca80: 705f 7072 6963 653a 2066 6c6f 6174 2c20  p_price: float, 
+0000ca90: 6f72 6465 725f 7479 7065 733a 2044 6963  order_types: Dic
+0000caa0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0000cab0: 2020 2020 2020 2020 2020 2073 6964 653a             side:
+0000cac0: 2042 7579 5365 6c6c 2c20 6c65 7665 7261   BuySell, levera
+0000cad0: 6765 3a20 666c 6f61 7429 202d 3e20 4469  ge: float) -> Di
+0000cae0: 6374 3a0a 2020 2020 2020 2020 2222 220a  ct:.        """.
+0000caf0: 2020 2020 2020 2020 6372 6561 7465 7320          creates 
+0000cb00: 6120 7374 6f70 6c6f 7373 206f 7264 6572  a stoploss order
+0000cb10: 2e0a 2020 2020 2020 2020 7265 7175 6972  ..        requir
+0000cb20: 6573 2060 5f66 745f 6861 735b 2773 746f  es `_ft_has['sto
+0000cb30: 706c 6f73 735f 6f72 6465 725f 7479 7065  ploss_order_type
+0000cb40: 7327 5d60 2074 6f20 6265 2073 6574 2061  s']` to be set a
+0000cb50: 7320 6120 6469 6374 206d 6170 7069 6e67  s a dict mapping
+0000cb60: 206c 696d 6974 2061 6e64 206d 6172 6b65   limit and marke
+0000cb70: 740a 2020 2020 2020 2020 2020 2020 746f  t.            to
+0000cb80: 2074 6865 2063 6f72 7265 7370 6f6e 6469   the correspondi
+0000cb90: 6e67 2065 7863 6861 6e67 6520 7479 7065  ng exchange type
+0000cba0: 2e0a 0a20 2020 2020 2020 2054 6865 2070  ...        The p
+0000cbb0: 7265 6369 7365 206f 7264 6572 7479 7065  recise ordertype
+0000cbc0: 2069 7320 6465 7465 726d 696e 6564 2062   is determined b
+0000cbd0: 7920 7468 6520 6f72 6465 725f 7479 7065  y the order_type
+0000cbe0: 7320 6469 6374 206f 7220 6578 6368 616e  s dict or exchan
+0000cbf0: 6765 2064 6566 6175 6c74 2e0a 0a20 2020  ge default...   
+0000cc00: 2020 2020 2054 6865 2065 7863 6570 7469       The excepti
+0000cc10: 6f6e 2062 656c 6f77 2073 686f 756c 6420  on below should 
+0000cc20: 6e65 7665 7220 7261 6973 652c 2073 696e  never raise, sin
+0000cc30: 6365 2077 6520 6469 7361 6c6c 6f77 0a20  ce we disallow. 
+0000cc40: 2020 2020 2020 2073 7461 7274 696e 6720         starting 
+0000cc50: 7468 6520 626f 7420 696e 2076 616c 6964  the bot in valid
+0000cc60: 6174 655f 6f72 6465 7274 7970 6573 2829  ate_ordertypes()
+0000cc70: 0a0a 2020 2020 2020 2020 5468 6973 206d  ..        This m
+0000cc80: 6179 2077 6f72 6b20 7769 7468 2061 206c  ay work with a l
+0000cc90: 696d 6974 6564 206e 756d 6265 7220 6f66  imited number of
+0000cca0: 206f 7468 6572 2065 7863 6861 6e67 6573   other exchanges
+0000ccb0: 2c20 6275 7420 636f 7272 6563 7420 776f  , but correct wo
+0000ccc0: 726b 696e 670a 2020 2020 2020 2020 2020  rking.          
+0000ccd0: 2020 6e65 6564 7320 746f 2062 6520 7465    needs to be te
+0000cce0: 7374 6564 2069 6e64 6976 6964 7561 6c6c  sted individuall
+0000ccf0: 792e 0a20 2020 2020 2020 2057 4152 4e49  y..        WARNI
+0000cd00: 4e47 3a20 7365 7474 696e 6720 6073 746f  NG: setting `sto
+0000cd10: 706c 6f73 735f 6f6e 5f65 7863 6861 6e67  ploss_on_exchang
+0000cd20: 6560 2074 6f20 5472 7565 2077 696c 6c20  e` to True will 
+0000cd30: 4e4f 5420 6175 746f 2d65 6e61 626c 6520  NOT auto-enable 
+0000cd40: 7374 6f70 6c6f 7373 206f 6e20 6578 6368  stoploss on exch
+0000cd50: 616e 6765 2e0a 2020 2020 2020 2020 2020  ange..          
+0000cd60: 2020 6073 746f 706c 6f73 735f 6164 6a75    `stoploss_adju
+0000cd70: 7374 6020 6d75 7374 2073 7469 6c6c 2062  st` must still b
+0000cd80: 6520 696d 706c 656d 656e 7465 6420 666f  e implemented fo
+0000cd90: 7220 7468 6973 2074 6f20 776f 726b 2e0a  r this to work..
+0000cda0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000cdb0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+0000cdc0: 5f66 745f 6861 735b 2773 746f 706c 6f73  _ft_has['stoplos
+0000cdd0: 735f 6f6e 5f65 7863 6861 6e67 6527 5d3a  s_on_exchange']:
+0000cde0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000cdf0: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
+0000ce00: 6365 7074 696f 6e28 6622 7374 6f70 6c6f  ception(f"stoplo
+0000ce10: 7373 2069 7320 6e6f 7420 696d 706c 656d  ss is not implem
+0000ce20: 656e 7465 6420 666f 7220 7b73 656c 662e  ented for {self.
+0000ce30: 6e61 6d65 7d2e 2229 0a0a 2020 2020 2020  name}.")..      
+0000ce40: 2020 7573 6572 5f6f 7264 6572 5f74 7970    user_order_typ
+0000ce50: 6520 3d20 6f72 6465 725f 7479 7065 732e  e = order_types.
+0000ce60: 6765 7428 2773 746f 706c 6f73 7327 2c20  get('stoploss', 
+0000ce70: 276d 6172 6b65 7427 290a 2020 2020 2020  'market').      
+0000ce80: 2020 6f72 6465 7274 7970 652c 2075 7365    ordertype, use
+0000ce90: 725f 6f72 6465 725f 7479 7065 203d 2073  r_order_type = s
+0000cea0: 656c 662e 5f67 6574 5f73 746f 705f 6f72  elf._get_stop_or
+0000ceb0: 6465 725f 7479 7065 2875 7365 725f 6f72  der_type(user_or
+0000cec0: 6465 725f 7479 7065 290a 2020 2020 2020  der_type).      
+0000ced0: 2020 726f 756e 645f 6d6f 6465 203d 2052    round_mode = R
+0000cee0: 4f55 4e44 5f44 4f57 4e20 6966 2073 6964  OUND_DOWN if sid
+0000cef0: 6520 3d3d 2027 6275 7927 2065 6c73 6520  e == 'buy' else 
+0000cf00: 524f 554e 445f 5550 0a20 2020 2020 2020  ROUND_UP.       
+0000cf10: 2073 746f 705f 7072 6963 655f 6e6f 726d   stop_price_norm
+0000cf20: 203d 2073 656c 662e 7072 6963 655f 746f   = self.price_to
+0000cf30: 5f70 7265 6369 7369 6f6e 2870 6169 722c  _precision(pair,
+0000cf40: 2073 746f 705f 7072 6963 652c 2072 6f75   stop_price, rou
+0000cf50: 6e64 696e 675f 6d6f 6465 3d72 6f75 6e64  nding_mode=round
+0000cf60: 5f6d 6f64 6529 0a20 2020 2020 2020 206c  _mode).        l
+0000cf70: 696d 6974 5f72 6174 6520 3d20 4e6f 6e65  imit_rate = None
+0000cf80: 0a20 2020 2020 2020 2069 6620 7573 6572  .        if user
+0000cf90: 5f6f 7264 6572 5f74 7970 6520 3d3d 2027  _order_type == '
+0000cfa0: 6c69 6d69 7427 3a0a 2020 2020 2020 2020  limit':.        
+0000cfb0: 2020 2020 6c69 6d69 745f 7261 7465 203d      limit_rate =
+0000cfc0: 2073 656c 662e 5f67 6574 5f73 746f 705f   self._get_stop_
+0000cfd0: 6c69 6d69 745f 7261 7465 2873 746f 705f  limit_rate(stop_
+0000cfe0: 7072 6963 652c 206f 7264 6572 5f74 7970  price, order_typ
+0000cff0: 6573 2c20 7369 6465 290a 2020 2020 2020  es, side).      
+0000d000: 2020 2020 2020 6c69 6d69 745f 7261 7465        limit_rate
+0000d010: 203d 2073 656c 662e 7072 6963 655f 746f   = self.price_to
+0000d020: 5f70 7265 6369 7369 6f6e 2870 6169 722c  _precision(pair,
+0000d030: 206c 696d 6974 5f72 6174 652c 2072 6f75   limit_rate, rou
+0000d040: 6e64 696e 675f 6d6f 6465 3d72 6f75 6e64  nding_mode=round
+0000d050: 5f6d 6f64 6529 0a0a 2020 2020 2020 2020  _mode)..        
+0000d060: 6966 2073 656c 662e 5f63 6f6e 6669 675b  if self._config[
+0000d070: 2764 7279 5f72 756e 275d 3a0a 2020 2020  'dry_run']:.    
+0000d080: 2020 2020 2020 2020 6472 795f 6f72 6465          dry_orde
+0000d090: 7220 3d20 7365 6c66 2e63 7265 6174 655f  r = self.create_
+0000d0a0: 6472 795f 7275 6e5f 6f72 6465 7228 0a20  dry_run_order(. 
+0000d0b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000d0c0: 6169 722c 0a20 2020 2020 2020 2020 2020  air,.           
+0000d0d0: 2020 2020 206f 7264 6572 7479 7065 2c0a       ordertype,.
+0000d0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d0f0: 7369 6465 2c0a 2020 2020 2020 2020 2020  side,.          
+0000d100: 2020 2020 2020 616d 6f75 6e74 2c0a 2020        amount,.  
+0000d110: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0000d120: 6f70 5f70 7269 6365 5f6e 6f72 6d2c 0a20  op_price_norm,. 
+0000d130: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000d140: 746f 705f 6c6f 7373 3d54 7275 652c 0a20  top_loss=True,. 
+0000d150: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0000d160: 6576 6572 6167 653d 6c65 7665 7261 6765  everage=leverage
+0000d170: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0000d180: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000d190: 726e 2064 7279 5f6f 7264 6572 0a0a 2020  rn dry_order..  
+0000d1a0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000d1b0: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
+0000d1c0: 7365 6c66 2e5f 6765 745f 7374 6f70 5f70  self._get_stop_p
+0000d1d0: 6172 616d 7328 7369 6465 3d73 6964 652c  arams(side=side,
+0000d1e0: 206f 7264 6572 7479 7065 3d6f 7264 6572   ordertype=order
+0000d1f0: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+0000d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d220: 2073 746f 705f 7072 6963 653d 7374 6f70   stop_price=stop
+0000d230: 5f70 7269 6365 5f6e 6f72 6d29 0a20 2020  _price_norm).   
+0000d240: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0000d250: 2e74 7261 6469 6e67 5f6d 6f64 6520 3d3d  .trading_mode ==
+0000d260: 2054 7261 6469 6e67 4d6f 6465 2e46 5554   TradingMode.FUT
+0000d270: 5552 4553 3a0a 2020 2020 2020 2020 2020  URES:.          
+0000d280: 2020 2020 2020 7061 7261 6d73 5b27 7265        params['re
+0000d290: 6475 6365 4f6e 6c79 275d 203d 2054 7275  duceOnly'] = Tru
+0000d2a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000d2b0: 2020 6966 2027 7374 6f70 6c6f 7373 5f70    if 'stoploss_p
+0000d2c0: 7269 6365 5f74 7970 6527 2069 6e20 6f72  rice_type' in or
+0000d2d0: 6465 725f 7479 7065 7320 616e 6420 2773  der_types and 's
+0000d2e0: 746f 705f 7072 6963 655f 7479 7065 5f66  top_price_type_f
+0000d2f0: 6965 6c64 2720 696e 2073 656c 662e 5f66  ield' in self._f
+0000d300: 745f 6861 733a 0a20 2020 2020 2020 2020  t_has:.         
+0000d310: 2020 2020 2020 2020 2020 2070 7269 6365             price
+0000d320: 5f74 7970 6520 3d20 7365 6c66 2e5f 6674  _type = self._ft
+0000d330: 5f68 6173 5b27 7374 6f70 5f70 7269 6365  _has['stop_price
+0000d340: 5f74 7970 655f 7661 6c75 655f 6d61 7070  _type_value_mapp
+0000d350: 696e 6727 5d5b 0a20 2020 2020 2020 2020  ing'][.         
+0000d360: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000d370: 7264 6572 5f74 7970 6573 2e67 6574 2827  rder_types.get('
+0000d380: 7374 6f70 6c6f 7373 5f70 7269 6365 5f74  stoploss_price_t
+0000d390: 7970 6527 2c20 5072 6963 6554 7970 652e  ype', PriceType.
+0000d3a0: 4c41 5354 295d 0a20 2020 2020 2020 2020  LAST)].         
+0000d3b0: 2020 2020 2020 2020 2020 2070 6172 616d             param
+0000d3c0: 735b 7365 6c66 2e5f 6674 5f68 6173 5b27  s[self._ft_has['
+0000d3d0: 7374 6f70 5f70 7269 6365 5f74 7970 655f  stop_price_type_
+0000d3e0: 6669 656c 6427 5d5d 203d 2070 7269 6365  field']] = price
+0000d3f0: 5f74 7970 650a 0a20 2020 2020 2020 2020  _type..         
+0000d400: 2020 2061 6d6f 756e 7420 3d20 7365 6c66     amount = self
+0000d410: 2e61 6d6f 756e 745f 746f 5f70 7265 6369  .amount_to_preci
+0000d420: 7369 6f6e 2870 6169 722c 2073 656c 662e  sion(pair, self.
+0000d430: 5f61 6d6f 756e 745f 746f 5f63 6f6e 7472  _amount_to_contr
+0000d440: 6163 7473 2870 6169 722c 2061 6d6f 756e  acts(pair, amoun
+0000d450: 7429 290a 0a20 2020 2020 2020 2020 2020  t))..           
+0000d460: 2073 656c 662e 5f6c 6576 5f70 7265 7028   self._lev_prep(
+0000d470: 7061 6972 2c20 6c65 7665 7261 6765 2c20  pair, leverage, 
+0000d480: 7369 6465 2c20 6163 6365 7074 5f66 6169  side, accept_fai
+0000d490: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
+0000d4a0: 2020 2020 6f72 6465 7220 3d20 7365 6c66      order = self
+0000d4b0: 2e5f 6170 692e 6372 6561 7465 5f6f 7264  ._api.create_ord
+0000d4c0: 6572 2873 796d 626f 6c3d 7061 6972 2c20  er(symbol=pair, 
+0000d4d0: 7479 7065 3d6f 7264 6572 7479 7065 2c20  type=ordertype, 
+0000d4e0: 7369 6465 3d73 6964 652c 0a20 2020 2020  side=side,.     
+0000d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d510: 2020 2020 2020 616d 6f75 6e74 3d61 6d6f        amount=amo
+0000d520: 756e 742c 2070 7269 6365 3d6c 696d 6974  unt, price=limit
+0000d530: 5f72 6174 652c 2070 6172 616d 733d 7061  _rate, params=pa
+0000d540: 7261 6d73 290a 2020 2020 2020 2020 2020  rams).          
+0000d550: 2020 7365 6c66 2e5f 6c6f 675f 6578 6368    self._log_exch
+0000d560: 616e 6765 5f72 6573 706f 6e73 6528 2763  ange_response('c
+0000d570: 7265 6174 655f 7374 6f70 6c6f 7373 5f6f  reate_stoploss_o
+0000d580: 7264 6572 272c 206f 7264 6572 290a 2020  rder', order).  
+0000d590: 2020 2020 2020 2020 2020 6f72 6465 7220            order 
+0000d5a0: 3d20 7365 6c66 2e5f 6f72 6465 725f 636f  = self._order_co
+0000d5b0: 6e74 7261 6374 735f 746f 5f61 6d6f 756e  ntracts_to_amoun
+0000d5c0: 7428 6f72 6465 7229 0a20 2020 2020 2020  t(order).       
+0000d5d0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0000d5e0: 2866 2273 746f 706c 6f73 7320 7b75 7365  (f"stoploss {use
+0000d5f0: 725f 6f72 6465 725f 7479 7065 7d20 6f72  r_order_type} or
+0000d600: 6465 7220 6164 6465 6420 666f 7220 7b70  der added for {p
+0000d610: 6169 727d 2e20 220a 2020 2020 2020 2020  air}. ".        
+0000d620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d630: 6622 7374 6f70 2070 7269 6365 3a20 7b73  f"stop price: {s
+0000d640: 746f 705f 7072 6963 657d 2e20 6c69 6d69  top_price}. limi
+0000d650: 743a 207b 6c69 6d69 745f 7261 7465 7d22  t: {limit_rate}"
+0000d660: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0000d670: 7475 726e 206f 7264 6572 0a20 2020 2020  turn order.     
+0000d680: 2020 2065 7863 6570 7420 6363 7874 2e49     except ccxt.I
+0000d690: 6e73 7566 6669 6369 656e 7446 756e 6473  nsufficientFunds
+0000d6a0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+0000d6b0: 2020 2072 6169 7365 2049 6e73 7566 6669     raise Insuffi
+0000d6c0: 6369 656e 7446 756e 6473 4572 726f 7228  cientFundsError(
+0000d6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d6e0: 2066 2749 6e73 7566 6669 6369 656e 7420   f'Insufficient 
+0000d6f0: 6675 6e64 7320 746f 2063 7265 6174 6520  funds to create 
+0000d700: 7b6f 7264 6572 7479 7065 7d20 7365 6c6c  {ordertype} sell
+0000d710: 206f 7264 6572 206f 6e20 6d61 726b 6574   order on market
+0000d720: 207b 7061 6972 7d2e 2027 0a20 2020 2020   {pair}. '.     
+0000d730: 2020 2020 2020 2020 2020 2066 2754 7269             f'Tri
+0000d740: 6564 2074 6f20 7365 6c6c 2061 6d6f 756e  ed to sell amoun
+0000d750: 7420 7b61 6d6f 756e 747d 2061 7420 7261  t {amount} at ra
+0000d760: 7465 207b 6c69 6d69 745f 7261 7465 7d2e  te {limit_rate}.
+0000d770: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0000d780: 2020 2066 274d 6573 7361 6765 3a20 7b65     f'Message: {e
+0000d790: 7d27 2920 6672 6f6d 2065 0a20 2020 2020  }') from e.     
+0000d7a0: 2020 2065 7863 6570 7420 6363 7874 2e49     except ccxt.I
+0000d7b0: 6e76 616c 6964 4f72 6465 7220 6173 2065  nvalidOrder as e
+0000d7c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0000d7d0: 4572 726f 7273 3a0a 2020 2020 2020 2020  Errors:.        
+0000d7e0: 2020 2020 2320 604f 7264 6572 2077 6f75      # `Order wou
+0000d7f0: 6c64 2074 7269 6767 6572 2069 6d6d 6564  ld trigger immed
+0000d800: 6961 7465 6c79 2e60 0a20 2020 2020 2020  iately.`.       
+0000d810: 2020 2020 2072 6169 7365 2049 6e76 616c       raise Inval
+0000d820: 6964 4f72 6465 7245 7863 6570 7469 6f6e  idOrderException
+0000d830: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000d840: 2020 6627 436f 756c 6420 6e6f 7420 6372    f'Could not cr
+0000d850: 6561 7465 207b 6f72 6465 7274 7970 657d  eate {ordertype}
+0000d860: 2073 656c 6c20 6f72 6465 7220 6f6e 206d   sell order on m
+0000d870: 6172 6b65 7420 7b70 6169 727d 2e20 270a  arket {pair}. '.
+0000d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d890: 6627 5472 6965 6420 746f 2073 656c 6c20  f'Tried to sell 
+0000d8a0: 616d 6f75 6e74 207b 616d 6f75 6e74 7d20  amount {amount} 
+0000d8b0: 6174 2072 6174 6520 7b6c 696d 6974 5f72  at rate {limit_r
+0000d8c0: 6174 657d 2e20 270a 2020 2020 2020 2020  ate}. '.        
+0000d8d0: 2020 2020 2020 2020 6627 4d65 7373 6167          f'Messag
+0000d8e0: 653a 207b 657d 2729 2066 726f 6d20 650a  e: {e}') from e.
+0000d8f0: 2020 2020 2020 2020 6578 6365 7074 2063          except c
+0000d900: 6378 742e 4444 6f53 5072 6f74 6563 7469  cxt.DDoSProtecti
+0000d910: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+0000d920: 2020 2020 2072 6169 7365 2044 446f 7350       raise DDosP
+0000d930: 726f 7465 6374 696f 6e28 6529 2066 726f  rotection(e) fro
+0000d940: 6d20 650a 2020 2020 2020 2020 6578 6365  m e.        exce
+0000d950: 7074 2028 6363 7874 2e4e 6574 776f 726b  pt (ccxt.Network
+0000d960: 4572 726f 722c 2063 6378 742e 4578 6368  Error, ccxt.Exch
+0000d970: 616e 6765 4572 726f 7229 2061 7320 653a  angeError) as e:
+0000d980: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000d990: 7365 2054 656d 706f 7261 7279 4572 726f  se TemporaryErro
+0000d9a0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000d9b0: 2020 2066 2243 6f75 6c64 206e 6f74 2070     f"Could not p
+0000d9c0: 6c61 6365 2073 746f 706c 6f73 7320 6f72  lace stoploss or
+0000d9d0: 6465 7220 6475 6520 746f 207b 652e 5f5f  der due to {e.__
+0000d9e0: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
+0000d9f0: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
+0000da00: 2020 2020 2066 224d 6573 7361 6765 3a20       f"Message: 
+0000da10: 7b65 7d22 2920 6672 6f6d 2065 0a20 2020  {e}") from e.   
+0000da20: 2020 2020 2065 7863 6570 7420 6363 7874       except ccxt
+0000da30: 2e42 6173 6545 7272 6f72 2061 7320 653a  .BaseError as e:
+0000da40: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000da50: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
+0000da60: 6365 7074 696f 6e28 6529 2066 726f 6d20  ception(e) from 
+0000da70: 650a 0a20 2020 2040 7265 7472 6965 7228  e..    @retrier(
+0000da80: 7265 7472 6965 733d 4150 495f 4645 5443  retries=API_FETC
+0000da90: 485f 4f52 4445 525f 5245 5452 595f 434f  H_ORDER_RETRY_CO
+0000daa0: 554e 5429 0a20 2020 2064 6566 2066 6574  UNT).    def fet
+0000dab0: 6368 5f6f 7264 6572 2873 656c 662c 206f  ch_order(self, o
+0000dac0: 7264 6572 5f69 643a 2073 7472 2c20 7061  rder_id: str, pa
+0000dad0: 6972 3a20 7374 722c 2070 6172 616d 733a  ir: str, params:
+0000dae0: 2044 6963 7420 3d20 7b7d 2920 2d3e 2044   Dict = {}) -> D
+0000daf0: 6963 743a 0a20 2020 2020 2020 2069 6620  ict:.        if 
+0000db00: 7365 6c66 2e5f 636f 6e66 6967 5b27 6472  self._config['dr
+0000db10: 795f 7275 6e27 5d3a 0a20 2020 2020 2020  y_run']:.       
+0000db20: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000db30: 2e66 6574 6368 5f64 7279 5f72 756e 5f6f  .fetch_dry_run_o
+0000db40: 7264 6572 286f 7264 6572 5f69 6429 0a20  rder(order_id). 
+0000db50: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000db60: 2020 2020 2020 2020 6f72 6465 7220 3d20          order = 
+0000db70: 7365 6c66 2e5f 6170 692e 6665 7463 685f  self._api.fetch_
+0000db80: 6f72 6465 7228 6f72 6465 725f 6964 2c20  order(order_id, 
+0000db90: 7061 6972 2c20 7061 7261 6d73 3d70 6172  pair, params=par
+0000dba0: 616d 7329 0a20 2020 2020 2020 2020 2020  ams).           
+0000dbb0: 2073 656c 662e 5f6c 6f67 5f65 7863 6861   self._log_excha
+0000dbc0: 6e67 655f 7265 7370 6f6e 7365 2827 6665  nge_response('fe
+0000dbd0: 7463 685f 6f72 6465 7227 2c20 6f72 6465  tch_order', orde
+0000dbe0: 7229 0a20 2020 2020 2020 2020 2020 206f  r).            o
+0000dbf0: 7264 6572 203d 2073 656c 662e 5f6f 7264  rder = self._ord
+0000dc00: 6572 5f63 6f6e 7472 6163 7473 5f74 6f5f  er_contracts_to_
+0000dc10: 616d 6f75 6e74 286f 7264 6572 290a 2020  amount(order).  
+0000dc20: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000dc30: 206f 7264 6572 0a20 2020 2020 2020 2065   order.        e
+0000dc40: 7863 6570 7420 6363 7874 2e4f 7264 6572  xcept ccxt.Order
+0000dc50: 4e6f 7446 6f75 6e64 2061 7320 653a 0a20  NotFound as e:. 
+0000dc60: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000dc70: 2052 6574 7279 6162 6c65 4f72 6465 7245   RetryableOrderE
+0000dc80: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000dc90: 2020 2020 2020 6627 4f72 6465 7220 6e6f        f'Order no
+0000dca0: 7420 666f 756e 6420 2870 6169 723a 207b  t found (pair: {
+0000dcb0: 7061 6972 7d20 6964 3a20 7b6f 7264 6572  pair} id: {order
+0000dcc0: 5f69 647d 292e 204d 6573 7361 6765 3a20  _id}). Message: 
+0000dcd0: 7b65 7d27 2920 6672 6f6d 2065 0a20 2020  {e}') from e.   
+0000dce0: 2020 2020 2065 7863 6570 7420 6363 7874       except ccxt
+0000dcf0: 2e49 6e76 616c 6964 4f72 6465 7220 6173  .InvalidOrder as
+0000dd00: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0000dd10: 7261 6973 6520 496e 7661 6c69 644f 7264  raise InvalidOrd
+0000dd20: 6572 4578 6365 7074 696f 6e28 0a20 2020  erException(.   
+0000dd30: 2020 2020 2020 2020 2020 2020 2066 2754               f'T
+0000dd40: 7269 6564 2074 6f20 6765 7420 616e 2069  ried to get an i
+0000dd50: 6e76 616c 6964 206f 7264 6572 2028 7061  nvalid order (pa
+0000dd60: 6972 3a20 7b70 6169 727d 2069 643a 207b  ir: {pair} id: {
+0000dd70: 6f72 6465 725f 6964 7d29 2e20 4d65 7373  order_id}). Mess
+0000dd80: 6167 653a 207b 657d 2729 2066 726f 6d20  age: {e}') from 
+0000dd90: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
+0000dda0: 2063 6378 742e 4444 6f53 5072 6f74 6563   ccxt.DDoSProtec
+0000ddb0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+0000ddc0: 2020 2020 2020 2072 6169 7365 2044 446f         raise DDo
+0000ddd0: 7350 726f 7465 6374 696f 6e28 6529 2066  sProtection(e) f
+0000dde0: 726f 6d20 650a 2020 2020 2020 2020 6578  rom e.        ex
+0000ddf0: 6365 7074 2028 6363 7874 2e4e 6574 776f  cept (ccxt.Netwo
+0000de00: 726b 4572 726f 722c 2063 6378 742e 4578  rkError, ccxt.Ex
+0000de10: 6368 616e 6765 4572 726f 7229 2061 7320  changeError) as 
+0000de20: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000de30: 6169 7365 2054 656d 706f 7261 7279 4572  aise TemporaryEr
+0000de40: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+0000de50: 2020 2020 2066 2743 6f75 6c64 206e 6f74       f'Could not
+0000de60: 2067 6574 206f 7264 6572 2064 7565 2074   get order due t
+0000de70: 6f20 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f  o {e.__class__._
+0000de80: 5f6e 616d 655f 5f7d 2e20 4d65 7373 6167  _name__}. Messag
+0000de90: 653a 207b 657d 2729 2066 726f 6d20 650a  e: {e}') from e.
+0000dea0: 2020 2020 2020 2020 6578 6365 7074 2063          except c
+0000deb0: 6378 742e 4261 7365 4572 726f 7220 6173  cxt.BaseError as
+0000dec0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0000ded0: 7261 6973 6520 4f70 6572 6174 696f 6e61  raise Operationa
+0000dee0: 6c45 7863 6570 7469 6f6e 2865 2920 6672  lException(e) fr
+0000def0: 6f6d 2065 0a0a 2020 2020 6465 6620 6665  om e..    def fe
+0000df00: 7463 685f 7374 6f70 6c6f 7373 5f6f 7264  tch_stoploss_ord
+0000df10: 6572 2873 656c 662c 206f 7264 6572 5f69  er(self, order_i
+0000df20: 643a 2073 7472 2c20 7061 6972 3a20 7374  d: str, pair: st
+0000df30: 722c 2070 6172 616d 733a 2044 6963 7420  r, params: Dict 
+0000df40: 3d20 7b7d 2920 2d3e 2044 6963 743a 0a20  = {}) -> Dict:. 
+0000df50: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000df60: 6c66 2e66 6574 6368 5f6f 7264 6572 286f  lf.fetch_order(o
+0000df70: 7264 6572 5f69 642c 2070 6169 722c 2070  rder_id, pair, p
+0000df80: 6172 616d 7329 0a0a 2020 2020 6465 6620  arams)..    def 
+0000df90: 6665 7463 685f 6f72 6465 725f 6f72 5f73  fetch_order_or_s
+0000dfa0: 746f 706c 6f73 735f 6f72 6465 7228 7365  toploss_order(se
+0000dfb0: 6c66 2c20 6f72 6465 725f 6964 3a20 7374  lf, order_id: st
+0000dfc0: 722c 2070 6169 723a 2073 7472 2c0a 2020  r, pair: str,.  
+0000dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dff0: 2020 2020 7374 6f70 6c6f 7373 5f6f 7264      stoploss_ord
+0000e000: 6572 3a20 626f 6f6c 203d 2046 616c 7365  er: bool = False
+0000e010: 2920 2d3e 2044 6963 743a 0a20 2020 2020  ) -> Dict:.     
+0000e020: 2020 2022 2222 0a20 2020 2020 2020 2053     """.        S
+0000e030: 696d 706c 6520 7772 6170 7065 7220 6361  imple wrapper ca
+0000e040: 6c6c 696e 6720 6569 7468 6572 2066 6574  lling either fet
+0000e050: 6368 5f6f 7264 6572 206f 7220 6665 7463  ch_order or fetc
+0000e060: 685f 7374 6f70 6c6f 7373 5f6f 7264 6572  h_stoploss_order
+0000e070: 2064 6570 656e 6469 6e67 206f 6e0a 2020   depending on.  
+0000e080: 2020 2020 2020 7468 6520 7374 6f70 6c6f        the stoplo
+0000e090: 7373 5f6f 7264 6572 2070 6172 616d 6574  ss_order paramet
+0000e0a0: 6572 0a20 2020 2020 2020 203a 7061 7261  er.        :para
+0000e0b0: 6d20 6f72 6465 725f 6964 3a20 4f72 6465  m order_id: Orde
+0000e0c0: 7249 6420 746f 2066 6574 6368 206f 7264  rId to fetch ord
+0000e0d0: 6572 0a20 2020 2020 2020 203a 7061 7261  er.        :para
+0000e0e0: 6d20 7061 6972 3a20 5061 6972 2063 6f72  m pair: Pair cor
+0000e0f0: 7265 7370 6f6e 6469 6e67 2074 6f20 6f72  responding to or
+0000e100: 6465 725f 6964 0a20 2020 2020 2020 203a  der_id.        :
+0000e110: 7061 7261 6d20 7374 6f70 6c6f 7373 5f6f  param stoploss_o
+0000e120: 7264 6572 3a20 4966 2074 7275 652c 2075  rder: If true, u
+0000e130: 7365 7320 6665 7463 685f 7374 6f70 6c6f  ses fetch_stoplo
+0000e140: 7373 5f6f 7264 6572 2c20 6f74 6865 7277  ss_order, otherw
+0000e150: 6973 6520 6665 7463 685f 6f72 6465 722e  ise fetch_order.
+0000e160: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000e170: 2020 2020 2069 6620 7374 6f70 6c6f 7373       if stoploss
+0000e180: 5f6f 7264 6572 3a0a 2020 2020 2020 2020  _order:.        
+0000e190: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000e1a0: 6665 7463 685f 7374 6f70 6c6f 7373 5f6f  fetch_stoploss_o
+0000e1b0: 7264 6572 286f 7264 6572 5f69 642c 2070  rder(order_id, p
+0000e1c0: 6169 7229 0a20 2020 2020 2020 2072 6574  air).        ret
+0000e1d0: 7572 6e20 7365 6c66 2e66 6574 6368 5f6f  urn self.fetch_o
+0000e1e0: 7264 6572 286f 7264 6572 5f69 642c 2070  rder(order_id, p
+0000e1f0: 6169 7229 0a0a 2020 2020 6465 6620 6368  air)..    def ch
+0000e200: 6563 6b5f 6f72 6465 725f 6361 6e63 656c  eck_order_cancel
+0000e210: 6564 5f65 6d70 7479 2873 656c 662c 206f  ed_empty(self, o
+0000e220: 7264 6572 3a20 4469 6374 2920 2d3e 2062  rder: Dict) -> b
+0000e230: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
+0000e240: 0a20 2020 2020 2020 2056 6572 6966 7920  .        Verify 
+0000e250: 6966 2061 6e20 6f72 6465 7220 6861 7320  if an order has 
+0000e260: 6265 656e 2063 616e 6365 6c6c 6564 2077  been cancelled w
+0000e270: 6974 686f 7574 2062 6569 6e67 2070 6172  ithout being par
+0000e280: 7469 616c 6c79 2066 696c 6c65 640a 2020  tially filled.  
+0000e290: 2020 2020 2020 3a70 6172 616d 206f 7264        :param ord
+0000e2a0: 6572 3a20 4f72 6465 7220 6469 6374 2061  er: Order dict a
+0000e2b0: 7320 7265 7475 726e 6564 2066 726f 6d20  s returned from 
+0000e2c0: 6665 7463 685f 6f72 6465 7228 290a 2020  fetch_order().  
+0000e2d0: 2020 2020 2020 3a72 6574 7572 6e3a 2054        :return: T
+0000e2e0: 7275 6520 6966 206f 7264 6572 2068 6173  rue if order has
+0000e2f0: 2062 6565 6e20 6361 6e63 656c 6c65 6420   been cancelled 
+0000e300: 7769 7468 6f75 7420 6265 696e 6720 6669  without being fi
+0000e310: 6c6c 6564 2c20 4661 6c73 6520 6f74 6865  lled, False othe
+0000e320: 7277 6973 652e 0a20 2020 2020 2020 2022  rwise..        "
+0000e330: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+0000e340: 6e20 286f 7264 6572 2e67 6574 2827 7374  n (order.get('st
+0000e350: 6174 7573 2729 2069 6e20 4e4f 4e5f 4f50  atus') in NON_OP
+0000e360: 454e 5f45 5843 4841 4e47 455f 5354 4154  EN_EXCHANGE_STAT
+0000e370: 4553 0a20 2020 2020 2020 2020 2020 2020  ES.             
+0000e380: 2020 2061 6e64 206f 7264 6572 2e67 6574     and order.get
+0000e390: 2827 6669 6c6c 6564 2729 203d 3d20 302e  ('filled') == 0.
+0000e3a0: 3029 0a0a 2020 2020 4072 6574 7269 6572  0)..    @retrier
+0000e3b0: 0a20 2020 2064 6566 2063 616e 6365 6c5f  .    def cancel_
+0000e3c0: 6f72 6465 7228 7365 6c66 2c20 6f72 6465  order(self, orde
+0000e3d0: 725f 6964 3a20 7374 722c 2070 6169 723a  r_id: str, pair:
+0000e3e0: 2073 7472 2c20 7061 7261 6d73 3a20 4469   str, params: Di
+0000e3f0: 6374 203d 207b 7d29 202d 3e20 4469 6374  ct = {}) -> Dict
+0000e400: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+0000e410: 662e 5f63 6f6e 6669 675b 2764 7279 5f72  f._config['dry_r
+0000e420: 756e 275d 3a0a 2020 2020 2020 2020 2020  un']:.          
+0000e430: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000e440: 2020 2020 2020 206f 7264 6572 203d 2073         order = s
+0000e450: 656c 662e 6665 7463 685f 6472 795f 7275  elf.fetch_dry_ru
+0000e460: 6e5f 6f72 6465 7228 6f72 6465 725f 6964  n_order(order_id
+0000e470: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0000e480: 2020 206f 7264 6572 2e75 7064 6174 6528     order.update(
+0000e490: 7b27 7374 6174 7573 273a 2027 6361 6e63  {'status': 'canc
+0000e4a0: 656c 6564 272c 2027 6669 6c6c 6564 273a  eled', 'filled':
+0000e4b0: 2030 2e30 2c20 2772 656d 6169 6e69 6e67   0.0, 'remaining
+0000e4c0: 273a 206f 7264 6572 5b27 616d 6f75 6e74  ': order['amount
+0000e4d0: 275d 7d29 0a20 2020 2020 2020 2020 2020  ']}).           
+0000e4e0: 2020 2020 2072 6574 7572 6e20 6f72 6465       return orde
+0000e4f0: 720a 2020 2020 2020 2020 2020 2020 6578  r.            ex
+0000e500: 6365 7074 2049 6e76 616c 6964 4f72 6465  cept InvalidOrde
+0000e510: 7245 7863 6570 7469 6f6e 3a0a 2020 2020  rException:.    
+0000e520: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000e530: 726e 207b 7d0a 0a20 2020 2020 2020 2074  rn {}..        t
+0000e540: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000e550: 6f72 6465 7220 3d20 7365 6c66 2e5f 6170  order = self._ap
+0000e560: 692e 6361 6e63 656c 5f6f 7264 6572 286f  i.cancel_order(o
+0000e570: 7264 6572 5f69 642c 2070 6169 722c 2070  rder_id, pair, p
+0000e580: 6172 616d 733d 7061 7261 6d73 290a 2020  arams=params).  
+0000e590: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0000e5a0: 6c6f 675f 6578 6368 616e 6765 5f72 6573  log_exchange_res
+0000e5b0: 706f 6e73 6528 2763 616e 6365 6c5f 6f72  ponse('cancel_or
+0000e5c0: 6465 7227 2c20 6f72 6465 7229 0a20 2020  der', order).   
+0000e5d0: 2020 2020 2020 2020 206f 7264 6572 203d           order =
+0000e5e0: 2073 656c 662e 5f6f 7264 6572 5f63 6f6e   self._order_con
+0000e5f0: 7472 6163 7473 5f74 6f5f 616d 6f75 6e74  tracts_to_amount
+0000e600: 286f 7264 6572 290a 2020 2020 2020 2020  (order).        
+0000e610: 2020 2020 7265 7475 726e 206f 7264 6572      return order
+0000e620: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000e630: 6363 7874 2e49 6e76 616c 6964 4f72 6465  ccxt.InvalidOrde
+0000e640: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+0000e650: 2020 2020 7261 6973 6520 496e 7661 6c69      raise Invali
+0000e660: 644f 7264 6572 4578 6365 7074 696f 6e28  dOrderException(
+0000e670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e680: 2066 2743 6f75 6c64 206e 6f74 2063 616e   f'Could not can
+0000e690: 6365 6c20 6f72 6465 722e 204d 6573 7361  cel order. Messa
+0000e6a0: 6765 3a20 7b65 7d27 2920 6672 6f6d 2065  ge: {e}') from e
+0000e6b0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000e6c0: 6363 7874 2e44 446f 5350 726f 7465 6374  ccxt.DDoSProtect
+0000e6d0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+0000e6e0: 2020 2020 2020 7261 6973 6520 4444 6f73        raise DDos
+0000e6f0: 5072 6f74 6563 7469 6f6e 2865 2920 6672  Protection(e) fr
+0000e700: 6f6d 2065 0a20 2020 2020 2020 2065 7863  om e.        exc
+0000e710: 6570 7420 2863 6378 742e 4e65 7477 6f72  ept (ccxt.Networ
+0000e720: 6b45 7272 6f72 2c20 6363 7874 2e45 7863  kError, ccxt.Exc
+0000e730: 6861 6e67 6545 7272 6f72 2920 6173 2065  hangeError) as e
+0000e740: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000e750: 6973 6520 5465 6d70 6f72 6172 7945 7272  ise TemporaryErr
+0000e760: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000e770: 2020 2020 6627 436f 756c 6420 6e6f 7420      f'Could not 
+0000e780: 6361 6e63 656c 206f 7264 6572 2064 7565  cancel order due
+0000e790: 2074 6f20 7b65 2e5f 5f63 6c61 7373 5f5f   to {e.__class__
+0000e7a0: 2e5f 5f6e 616d 655f 5f7d 2e20 4d65 7373  .__name__}. Mess
+0000e7b0: 6167 653a 207b 657d 2729 2066 726f 6d20  age: {e}') from 
+0000e7c0: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
+0000e7d0: 2063 6378 742e 4261 7365 4572 726f 7220   ccxt.BaseError 
+0000e7e0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+0000e7f0: 2020 7261 6973 6520 4f70 6572 6174 696f    raise Operatio
+0000e800: 6e61 6c45 7863 6570 7469 6f6e 2865 2920  nalException(e) 
+0000e810: 6672 6f6d 2065 0a0a 2020 2020 6465 6620  from e..    def 
+0000e820: 6361 6e63 656c 5f73 746f 706c 6f73 735f  cancel_stoploss_
+0000e830: 6f72 6465 7228 7365 6c66 2c20 6f72 6465  order(self, orde
+0000e840: 725f 6964 3a20 7374 722c 2070 6169 723a  r_id: str, pair:
+0000e850: 2073 7472 2c20 7061 7261 6d73 3a20 4469   str, params: Di
+0000e860: 6374 203d 207b 7d29 202d 3e20 4469 6374  ct = {}) -> Dict
+0000e870: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000e880: 2073 656c 662e 6361 6e63 656c 5f6f 7264   self.cancel_ord
+0000e890: 6572 286f 7264 6572 5f69 642c 2070 6169  er(order_id, pai
+0000e8a0: 722c 2070 6172 616d 7329 0a0a 2020 2020  r, params)..    
+0000e8b0: 6465 6620 6973 5f63 616e 6365 6c5f 6f72  def is_cancel_or
+0000e8c0: 6465 725f 7265 7375 6c74 5f73 7569 7461  der_result_suita
+0000e8d0: 626c 6528 7365 6c66 2c20 636f 7264 6572  ble(self, corder
+0000e8e0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+0000e8f0: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+0000e900: 616e 6365 2863 6f72 6465 722c 2064 6963  ance(corder, dic
+0000e910: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+0000e920: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
+0000e930: 2020 2020 2020 7265 7175 6972 6564 203d        required =
+0000e940: 2028 2766 6565 272c 2027 7374 6174 7573   ('fee', 'status
+0000e950: 272c 2027 616d 6f75 6e74 2729 0a20 2020  ', 'amount').   
+0000e960: 2020 2020 2072 6574 7572 6e20 616c 6c28       return all(
+0000e970: 636f 7264 6572 2e67 6574 286b 2c20 4e6f  corder.get(k, No
+0000e980: 6e65 2920 6973 206e 6f74 204e 6f6e 6520  ne) is not None 
+0000e990: 666f 7220 6b20 696e 2072 6571 7569 7265  for k in require
+0000e9a0: 6429 0a0a 2020 2020 6465 6620 6361 6e63  d)..    def canc
+0000e9b0: 656c 5f6f 7264 6572 5f77 6974 685f 7265  el_order_with_re
+0000e9c0: 7375 6c74 2873 656c 662c 206f 7264 6572  sult(self, order
+0000e9d0: 5f69 643a 2073 7472 2c20 7061 6972 3a20  _id: str, pair: 
+0000e9e0: 7374 722c 2061 6d6f 756e 743a 2066 6c6f  str, amount: flo
+0000e9f0: 6174 2920 2d3e 2044 6963 743a 0a20 2020  at) -> Dict:.   
+0000ea00: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000ea10: 2043 616e 6365 6c20 6f72 6465 7220 7265   Cancel order re
+0000ea20: 7475 726e 696e 6720 6120 7265 7375 6c74  turning a result
+0000ea30: 2e0a 2020 2020 2020 2020 4372 6561 7465  ..        Create
+0000ea40: 7320 6120 6661 6b65 2072 6573 756c 7420  s a fake result 
+0000ea50: 6966 2063 616e 6365 6c20 6f72 6465 7220  if cancel order 
+0000ea60: 7265 7475 726e 7320 6120 6e6f 6e2d 7573  returns a non-us
+0000ea70: 6162 6c65 2072 6573 756c 740a 2020 2020  able result.    
+0000ea80: 2020 2020 616e 6420 6665 7463 685f 6f72      and fetch_or
+0000ea90: 6465 7220 646f 6573 206e 6f74 2077 6f72  der does not wor
+0000eaa0: 6b20 2863 6572 7461 696e 2065 7863 6861  k (certain excha
+0000eab0: 6e67 6573 2064 6f6e 2774 2072 6574 7572  nges don't retur
+0000eac0: 6e20 6361 6e63 656c 6c65 6420 6f72 6465  n cancelled orde
+0000ead0: 7273 290a 2020 2020 2020 2020 3a70 6172  rs).        :par
+0000eae0: 616d 206f 7264 6572 5f69 643a 204f 7264  am order_id: Ord
+0000eaf0: 6572 6964 2074 6f20 6361 6e63 656c 0a20  erid to cancel. 
+0000eb00: 2020 2020 2020 203a 7061 7261 6d20 7061         :param pa
+0000eb10: 6972 3a20 5061 6972 2063 6f72 7265 7370  ir: Pair corresp
+0000eb20: 6f6e 6469 6e67 2074 6f20 6f72 6465 725f  onding to order_
+0000eb30: 6964 0a20 2020 2020 2020 203a 7061 7261  id.        :para
+0000eb40: 6d20 616d 6f75 6e74 3a20 416d 6f75 6e74  m amount: Amount
+0000eb50: 2074 6f20 7573 6520 666f 7220 6661 6b65   to use for fake
+0000eb60: 2072 6573 706f 6e73 650a 2020 2020 2020   response.      
+0000eb70: 2020 3a72 6574 7572 6e3a 2052 6573 756c    :return: Resul
+0000eb80: 7420 6672 6f6d 2065 6974 6865 7220 6361  t from either ca
+0000eb90: 6e63 656c 5f6f 7264 6572 2069 6620 7573  ncel_order if us
+0000eba0: 6162 6c65 2c20 6f72 2066 6574 6368 5f6f  able, or fetch_o
+0000ebb0: 7264 6572 0a20 2020 2020 2020 2022 2222  rder.        """
+0000ebc0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0000ebd0: 2020 2020 2020 2020 2020 636f 7264 6572            corder
+0000ebe0: 203d 2073 656c 662e 6361 6e63 656c 5f6f   = self.cancel_o
+0000ebf0: 7264 6572 286f 7264 6572 5f69 642c 2070  rder(order_id, p
+0000ec00: 6169 7229 0a20 2020 2020 2020 2020 2020  air).           
+0000ec10: 2069 6620 7365 6c66 2e69 735f 6361 6e63   if self.is_canc
+0000ec20: 656c 5f6f 7264 6572 5f72 6573 756c 745f  el_order_result_
+0000ec30: 7375 6974 6162 6c65 2863 6f72 6465 7229  suitable(corder)
+0000ec40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ec50: 2020 7265 7475 726e 2063 6f72 6465 720a    return corder.
+0000ec60: 2020 2020 2020 2020 6578 6365 7074 2049          except I
+0000ec70: 6e76 616c 6964 4f72 6465 7245 7863 6570  nvalidOrderExcep
+0000ec80: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+0000ec90: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+0000eca0: 2866 2243 6f75 6c64 206e 6f74 2063 616e  (f"Could not can
+0000ecb0: 6365 6c20 6f72 6465 7220 7b6f 7264 6572  cel order {order
+0000ecc0: 5f69 647d 2066 6f72 207b 7061 6972 7d2e  _id} for {pair}.
+0000ecd0: 2229 0a20 2020 2020 2020 2074 7279 3a0a  ").        try:.
+0000ece0: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
+0000ecf0: 7220 3d20 7365 6c66 2e66 6574 6368 5f6f  r = self.fetch_o
+0000ed00: 7264 6572 286f 7264 6572 5f69 642c 2070  rder(order_id, p
+0000ed10: 6169 7229 0a20 2020 2020 2020 2065 7863  air).        exc
+0000ed20: 6570 7420 496e 7661 6c69 644f 7264 6572  ept InvalidOrder
+0000ed30: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+0000ed40: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
+0000ed50: 726e 696e 6728 6622 436f 756c 6420 6e6f  rning(f"Could no
+0000ed60: 7420 6665 7463 6820 6361 6e63 656c 6c65  t fetch cancelle
+0000ed70: 6420 6f72 6465 7220 7b6f 7264 6572 5f69  d order {order_i
+0000ed80: 647d 2e22 290a 2020 2020 2020 2020 2020  d}.").          
+0000ed90: 2020 6f72 6465 7220 3d20 7b0a 2020 2020    order = {.    
+0000eda0: 2020 2020 2020 2020 2020 2020 2769 6427              'id'
+0000edb0: 3a20 6f72 6465 725f 6964 2c0a 2020 2020  : order_id,.    
+0000edc0: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
+0000edd0: 7475 7327 3a20 2763 616e 6365 6c65 6427  tus': 'canceled'
+0000ede0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000edf0: 2020 2761 6d6f 756e 7427 3a20 616d 6f75    'amount': amou
+0000ee00: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0000ee10: 2020 2020 2766 696c 6c65 6427 3a20 302e      'filled': 0.
+0000ee20: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+0000ee30: 2020 2027 6665 6527 3a20 7b7d 2c0a 2020     'fee': {},.  
+0000ee40: 2020 2020 2020 2020 2020 2020 2020 2769                'i
+0000ee50: 6e66 6f27 3a20 7b7d 0a20 2020 2020 2020  nfo': {}.       
+0000ee60: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0000ee70: 7265 7475 726e 206f 7264 6572 0a0a 2020  return order..  
+0000ee80: 2020 6465 6620 6361 6e63 656c 5f73 746f    def cancel_sto
+0000ee90: 706c 6f73 735f 6f72 6465 725f 7769 7468  ploss_order_with
+0000eea0: 5f72 6573 756c 7428 7365 6c66 2c20 6f72  _result(self, or
+0000eeb0: 6465 725f 6964 3a20 7374 722c 2070 6169  der_id: str, pai
+0000eec0: 723a 2073 7472 2c20 616d 6f75 6e74 3a20  r: str, amount: 
+0000eed0: 666c 6f61 7429 202d 3e20 4469 6374 3a0a  float) -> Dict:.
+0000eee0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000eef0: 2020 2020 4361 6e63 656c 2073 746f 706c      Cancel stopl
+0000ef00: 6f73 7320 6f72 6465 7220 7265 7475 726e  oss order return
+0000ef10: 696e 6720 6120 7265 7375 6c74 2e0a 2020  ing a result..  
+0000ef20: 2020 2020 2020 4372 6561 7465 7320 6120        Creates a 
+0000ef30: 6661 6b65 2072 6573 756c 7420 6966 2063  fake result if c
+0000ef40: 616e 6365 6c20 6f72 6465 7220 7265 7475  ancel order retu
+0000ef50: 726e 7320 6120 6e6f 6e2d 7573 6162 6c65  rns a non-usable
+0000ef60: 2072 6573 756c 740a 2020 2020 2020 2020   result.        
+0000ef70: 616e 6420 6665 7463 685f 6f72 6465 7220  and fetch_order 
+0000ef80: 646f 6573 206e 6f74 2077 6f72 6b20 2863  does not work (c
+0000ef90: 6572 7461 696e 2065 7863 6861 6e67 6573  ertain exchanges
+0000efa0: 2064 6f6e 2774 2072 6574 7572 6e20 6361   don't return ca
+0000efb0: 6e63 656c 6c65 6420 6f72 6465 7273 290a  ncelled orders).
+0000efc0: 2020 2020 2020 2020 3a70 6172 616d 206f          :param o
+0000efd0: 7264 6572 5f69 643a 2073 746f 706c 6f73  rder_id: stoplos
+0000efe0: 732d 6f72 6465 722d 6964 2074 6f20 6361  s-order-id to ca
+0000eff0: 6e63 656c 0a20 2020 2020 2020 203a 7061  ncel.        :pa
+0000f000: 7261 6d20 7061 6972 3a20 5061 6972 2063  ram pair: Pair c
+0000f010: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
+0000f020: 6f72 6465 725f 6964 0a20 2020 2020 2020  order_id.       
+0000f030: 203a 7061 7261 6d20 616d 6f75 6e74 3a20   :param amount: 
+0000f040: 416d 6f75 6e74 2074 6f20 7573 6520 666f  Amount to use fo
+0000f050: 7220 6661 6b65 2072 6573 706f 6e73 650a  r fake response.
+0000f060: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+0000f070: 2052 6573 756c 7420 6672 6f6d 2065 6974   Result from eit
+0000f080: 6865 7220 6361 6e63 656c 5f6f 7264 6572  her cancel_order
+0000f090: 2069 6620 7573 6162 6c65 2c20 6f72 2066   if usable, or f
+0000f0a0: 6574 6368 5f6f 7264 6572 0a20 2020 2020  etch_order.     
+0000f0b0: 2020 2022 2222 0a20 2020 2020 2020 2063     """.        c
+0000f0c0: 6f72 6465 7220 3d20 7365 6c66 2e63 616e  order = self.can
+0000f0d0: 6365 6c5f 7374 6f70 6c6f 7373 5f6f 7264  cel_stoploss_ord
+0000f0e0: 6572 286f 7264 6572 5f69 642c 2070 6169  er(order_id, pai
+0000f0f0: 7229 0a20 2020 2020 2020 2069 6620 7365  r).        if se
+0000f100: 6c66 2e69 735f 6361 6e63 656c 5f6f 7264  lf.is_cancel_ord
+0000f110: 6572 5f72 6573 756c 745f 7375 6974 6162  er_result_suitab
+0000f120: 6c65 2863 6f72 6465 7229 3a0a 2020 2020  le(corder):.    
+0000f130: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+0000f140: 6f72 6465 720a 2020 2020 2020 2020 7472  order.        tr
+0000f150: 793a 0a20 2020 2020 2020 2020 2020 206f  y:.            o
+0000f160: 7264 6572 203d 2073 656c 662e 6665 7463  rder = self.fetc
+0000f170: 685f 7374 6f70 6c6f 7373 5f6f 7264 6572  h_stoploss_order
+0000f180: 286f 7264 6572 5f69 642c 2070 6169 7229  (order_id, pair)
+0000f190: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000f1a0: 496e 7661 6c69 644f 7264 6572 4578 6365  InvalidOrderExce
+0000f1b0: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
+0000f1c0: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+0000f1d0: 6728 6622 436f 756c 6420 6e6f 7420 6665  g(f"Could not fe
+0000f1e0: 7463 6820 6361 6e63 656c 6c65 6420 7374  tch cancelled st
+0000f1f0: 6f70 6c6f 7373 206f 7264 6572 207b 6f72  oploss order {or
+0000f200: 6465 725f 6964 7d2e 2229 0a20 2020 2020  der_id}.").     
+0000f210: 2020 2020 2020 206f 7264 6572 203d 207b         order = {
+0000f220: 2766 6565 273a 207b 7d2c 2027 7374 6174  'fee': {}, 'stat
+0000f230: 7573 273a 2027 6361 6e63 656c 6564 272c  us': 'canceled',
+0000f240: 2027 616d 6f75 6e74 273a 2061 6d6f 756e   'amount': amoun
+0000f250: 742c 2027 696e 666f 273a 207b 7d7d 0a0a  t, 'info': {}}..
+0000f260: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+0000f270: 7264 6572 0a0a 2020 2020 4072 6574 7269  rder..    @retri
+0000f280: 6572 0a20 2020 2064 6566 2067 6574 5f62  er.    def get_b
+0000f290: 616c 616e 6365 7328 7365 6c66 2920 2d3e  alances(self) ->
+0000f2a0: 2064 6963 743a 0a0a 2020 2020 2020 2020   dict:..        
+0000f2b0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000f2c0: 2062 616c 616e 6365 7320 3d20 7365 6c66   balances = self
+0000f2d0: 2e5f 6170 692e 6665 7463 685f 6261 6c61  ._api.fetch_bala
+0000f2e0: 6e63 6528 290a 2020 2020 2020 2020 2020  nce().          
+0000f2f0: 2020 2320 5265 6d6f 7665 2061 6464 6974    # Remove addit
+0000f300: 696f 6e61 6c20 696e 666f 2066 726f 6d20  ional info from 
+0000f310: 6363 7874 2072 6573 756c 7473 0a20 2020  ccxt results.   
+0000f320: 2020 2020 2020 2020 2062 616c 616e 6365           balance
+0000f330: 732e 706f 7028 2269 6e66 6f22 2c20 4e6f  s.pop("info", No
+0000f340: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
+0000f350: 6261 6c61 6e63 6573 2e70 6f70 2822 6672  balances.pop("fr
+0000f360: 6565 222c 204e 6f6e 6529 0a20 2020 2020  ee", None).     
+0000f370: 2020 2020 2020 2062 616c 616e 6365 732e         balances.
+0000f380: 706f 7028 2274 6f74 616c 222c 204e 6f6e  pop("total", Non
+0000f390: 6529 0a20 2020 2020 2020 2020 2020 2062  e).            b
+0000f3a0: 616c 616e 6365 732e 706f 7028 2275 7365  alances.pop("use
+0000f3b0: 6422 2c20 4e6f 6e65 290a 0a20 2020 2020  d", None)..     
+0000f3c0: 2020 2020 2020 2072 6574 7572 6e20 6261         return ba
+0000f3d0: 6c61 6e63 6573 0a20 2020 2020 2020 2065  lances.        e
+0000f3e0: 7863 6570 7420 6363 7874 2e44 446f 5350  xcept ccxt.DDoSP
+0000f3f0: 726f 7465 6374 696f 6e20 6173 2065 3a0a  rotection as e:.
+0000f400: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000f410: 6520 4444 6f73 5072 6f74 6563 7469 6f6e  e DDosProtection
+0000f420: 2865 2920 6672 6f6d 2065 0a20 2020 2020  (e) from e.     
+0000f430: 2020 2065 7863 6570 7420 2863 6378 742e     except (ccxt.
+0000f440: 4e65 7477 6f72 6b45 7272 6f72 2c20 6363  NetworkError, cc
+0000f450: 7874 2e45 7863 6861 6e67 6545 7272 6f72  xt.ExchangeError
+0000f460: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
+0000f470: 2020 2020 7261 6973 6520 5465 6d70 6f72      raise Tempor
+0000f480: 6172 7945 7272 6f72 280a 2020 2020 2020  aryError(.      
+0000f490: 2020 2020 2020 2020 2020 6627 436f 756c            f'Coul
+0000f4a0: 6420 6e6f 7420 6765 7420 6261 6c61 6e63  d not get balanc
+0000f4b0: 6520 6475 6520 746f 207b 652e 5f5f 636c  e due to {e.__cl
+0000f4c0: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d2e  ass__.__name__}.
+0000f4d0: 204d 6573 7361 6765 3a20 7b65 7d27 2920   Message: {e}') 
+0000f4e0: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
+0000f4f0: 7863 6570 7420 6363 7874 2e42 6173 6545  xcept ccxt.BaseE
+0000f500: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+0000f510: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
+0000f520: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
+0000f530: 6e28 6529 2066 726f 6d20 650a 0a20 2020  n(e) from e..   
+0000f540: 2040 7265 7472 6965 720a 2020 2020 6465   @retrier.    de
+0000f550: 6620 6665 7463 685f 706f 7369 7469 6f6e  f fetch_position
+0000f560: 7328 7365 6c66 2c20 7061 6972 3a20 4f70  s(self, pair: Op
+0000f570: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+0000f580: 6e65 2920 2d3e 204c 6973 745b 4469 6374  ne) -> List[Dict
+0000f590: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+0000f5a0: 2020 2020 2020 2046 6574 6368 2070 6f73         Fetch pos
+0000f5b0: 6974 696f 6e73 2066 726f 6d20 7468 6520  itions from the 
+0000f5c0: 6578 6368 616e 6765 2e0a 2020 2020 2020  exchange..      
+0000f5d0: 2020 4966 206e 6f20 7061 6972 2069 7320    If no pair is 
+0000f5e0: 6769 7665 6e2c 2061 6c6c 2070 6f73 6974  given, all posit
+0000f5f0: 696f 6e73 2061 7265 2072 6574 7572 6e65  ions are returne
+0000f600: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
+0000f610: 6d20 7061 6972 3a20 5061 6972 2066 6f72  m pair: Pair for
+0000f620: 2074 6865 2071 7565 7279 0a20 2020 2020   the query.     
+0000f630: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+0000f640: 6620 7365 6c66 2e5f 636f 6e66 6967 5b27  f self._config['
+0000f650: 6472 795f 7275 6e27 5d20 6f72 2073 656c  dry_run'] or sel
+0000f660: 662e 7472 6164 696e 675f 6d6f 6465 2021  f.trading_mode !
+0000f670: 3d20 5472 6164 696e 674d 6f64 652e 4655  = TradingMode.FU
+0000f680: 5455 5245 533a 0a20 2020 2020 2020 2020  TURES:.         
+0000f690: 2020 2072 6574 7572 6e20 5b5d 0a20 2020     return [].   
+0000f6a0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000f6b0: 2020 2020 2020 7379 6d62 6f6c 7320 3d20        symbols = 
+0000f6c0: 5b5d 0a20 2020 2020 2020 2020 2020 2069  [].            i
+0000f6d0: 6620 7061 6972 3a0a 2020 2020 2020 2020  f pair:.        
+0000f6e0: 2020 2020 2020 2020 7379 6d62 6f6c 732e          symbols.
+0000f6f0: 6170 7065 6e64 2870 6169 7229 0a20 2020  append(pair).   
+0000f700: 2020 2020 2020 2020 2070 6f73 6974 696f           positio
+0000f710: 6e73 3a20 4c69 7374 5b44 6963 745d 203d  ns: List[Dict] =
+0000f720: 2073 656c 662e 5f61 7069 2e66 6574 6368   self._api.fetch
+0000f730: 5f70 6f73 6974 696f 6e73 2873 796d 626f  _positions(symbo
+0000f740: 6c73 290a 2020 2020 2020 2020 2020 2020  ls).            
+0000f750: 7365 6c66 2e5f 6c6f 675f 6578 6368 616e  self._log_exchan
+0000f760: 6765 5f72 6573 706f 6e73 6528 2766 6574  ge_response('fet
+0000f770: 6368 5f70 6f73 6974 696f 6e73 272c 2070  ch_positions', p
+0000f780: 6f73 6974 696f 6e73 290a 2020 2020 2020  ositions).      
+0000f790: 2020 2020 2020 7265 7475 726e 2070 6f73        return pos
+0000f7a0: 6974 696f 6e73 0a20 2020 2020 2020 2065  itions.        e
+0000f7b0: 7863 6570 7420 6363 7874 2e44 446f 5350  xcept ccxt.DDoSP
+0000f7c0: 726f 7465 6374 696f 6e20 6173 2065 3a0a  rotection as e:.
+0000f7d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000f7e0: 6520 4444 6f73 5072 6f74 6563 7469 6f6e  e DDosProtection
+0000f7f0: 2865 2920 6672 6f6d 2065 0a20 2020 2020  (e) from e.     
+0000f800: 2020 2065 7863 6570 7420 2863 6378 742e     except (ccxt.
+0000f810: 4e65 7477 6f72 6b45 7272 6f72 2c20 6363  NetworkError, cc
+0000f820: 7874 2e45 7863 6861 6e67 6545 7272 6f72  xt.ExchangeError
+0000f830: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
+0000f840: 2020 2020 7261 6973 6520 5465 6d70 6f72      raise Tempor
+0000f850: 6172 7945 7272 6f72 280a 2020 2020 2020  aryError(.      
+0000f860: 2020 2020 2020 2020 2020 6627 436f 756c            f'Coul
+0000f870: 6420 6e6f 7420 6765 7420 706f 7369 7469  d not get positi
+0000f880: 6f6e 7320 6475 6520 746f 207b 652e 5f5f  ons due to {e.__
+0000f890: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
+0000f8a0: 7d2e 204d 6573 7361 6765 3a20 7b65 7d27  }. Message: {e}'
+0000f8b0: 2920 6672 6f6d 2065 0a20 2020 2020 2020  ) from e.       
+0000f8c0: 2065 7863 6570 7420 6363 7874 2e42 6173   except ccxt.Bas
+0000f8d0: 6545 7272 6f72 2061 7320 653a 0a20 2020  eError as e:.   
+0000f8e0: 2020 2020 2020 2020 2072 6169 7365 204f           raise O
+0000f8f0: 7065 7261 7469 6f6e 616c 4578 6365 7074  perationalExcept
+0000f900: 696f 6e28 6529 2066 726f 6d20 650a 0a20  ion(e) from e.. 
+0000f910: 2020 2040 7265 7472 6965 7228 7265 7472     @retrier(retr
+0000f920: 6965 733d 3029 0a20 2020 2064 6566 2066  ies=0).    def f
+0000f930: 6574 6368 5f6f 7264 6572 7328 7365 6c66  etch_orders(self
+0000f940: 2c20 7061 6972 3a20 7374 722c 2073 696e  , pair: str, sin
+0000f950: 6365 3a20 6461 7465 7469 6d65 2920 2d3e  ce: datetime) ->
+0000f960: 204c 6973 745b 4469 6374 5d3a 0a20 2020   List[Dict]:.   
+0000f970: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000f980: 2046 6574 6368 2061 6c6c 206f 7264 6572   Fetch all order
+0000f990: 7320 666f 7220 6120 7061 6972 2022 7369  s for a pair "si
+0000f9a0: 6e63 6522 0a20 2020 2020 2020 203a 7061  nce".        :pa
+0000f9b0: 7261 6d20 7061 6972 3a20 5061 6972 2066  ram pair: Pair f
+0000f9c0: 6f72 2074 6865 2071 7565 7279 0a20 2020  or the query.   
+0000f9d0: 2020 2020 203a 7061 7261 6d20 7369 6e63       :param sinc
+0000f9e0: 653a 2053 7461 7274 696e 6720 7469 6d65  e: Starting time
+0000f9f0: 2066 6f72 2074 6865 2071 7565 7279 0a20   for the query. 
+0000fa00: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000fa10: 2020 2069 6620 7365 6c66 2e5f 636f 6e66     if self._conf
+0000fa20: 6967 5b27 6472 795f 7275 6e27 5d3a 0a20  ig['dry_run']:. 
+0000fa30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000fa40: 6e20 5b5d 0a0a 2020 2020 2020 2020 6465  n []..        de
+0000fa50: 6620 6665 7463 685f 6f72 6465 7273 5f65  f fetch_orders_e
+0000fa60: 6d75 6c61 7465 2829 202d 3e20 4c69 7374  mulate() -> List
+0000fa70: 5b44 6963 745d 3a0a 2020 2020 2020 2020  [Dict]:.        
+0000fa80: 2020 2020 6f72 6465 7273 203d 205b 5d0a      orders = [].
+0000fa90: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0000faa0: 656c 662e 6578 6368 616e 6765 5f68 6173  elf.exchange_has
+0000fab0: 2827 6665 7463 6843 6c6f 7365 644f 7264  ('fetchClosedOrd
+0000fac0: 6572 7327 293a 0a20 2020 2020 2020 2020  ers'):.         
+0000fad0: 2020 2020 2020 206f 7264 6572 7320 3d20         orders = 
+0000fae0: 7365 6c66 2e5f 6170 692e 6665 7463 685f  self._api.fetch_
+0000faf0: 636c 6f73 6564 5f6f 7264 6572 7328 7061  closed_orders(pa
+0000fb00: 6972 2c20 7369 6e63 653d 7369 6e63 655f  ir, since=since_
+0000fb10: 6d73 290a 2020 2020 2020 2020 2020 2020  ms).            
+0000fb20: 2020 2020 6966 2073 656c 662e 6578 6368      if self.exch
+0000fb30: 616e 6765 5f68 6173 2827 6665 7463 684f  ange_has('fetchO
+0000fb40: 7065 6e4f 7264 6572 7327 293a 0a20 2020  penOrders'):.   
+0000fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb60: 206f 7264 6572 735f 6f70 656e 203d 2073   orders_open = s
+0000fb70: 656c 662e 5f61 7069 2e66 6574 6368 5f6f  elf._api.fetch_o
+0000fb80: 7065 6e5f 6f72 6465 7273 2870 6169 722c  pen_orders(pair,
+0000fb90: 2073 696e 6365 3d73 696e 6365 5f6d 7329   since=since_ms)
+0000fba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fbb0: 2020 2020 206f 7264 6572 732e 6578 7465       orders.exte
+0000fbc0: 6e64 286f 7264 6572 735f 6f70 656e 290a  nd(orders_open).
+0000fbd0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000fbe0: 726e 206f 7264 6572 730a 0a20 2020 2020  rn orders..     
+0000fbf0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000fc00: 2020 2020 7369 6e63 655f 6d73 203d 2069      since_ms = i
+0000fc10: 6e74 2828 7369 6e63 652e 7469 6d65 7374  nt((since.timest
+0000fc20: 616d 7028 2920 2d20 3130 2920 2a20 3130  amp() - 10) * 10
+0000fc30: 3030 290a 2020 2020 2020 2020 2020 2020  00).            
+0000fc40: 6966 2073 656c 662e 6578 6368 616e 6765  if self.exchange
+0000fc50: 5f68 6173 2827 6665 7463 684f 7264 6572  _has('fetchOrder
+0000fc60: 7327 293a 0a20 2020 2020 2020 2020 2020  s'):.           
+0000fc70: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000fc80: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+0000fc90: 6465 7273 3a20 4c69 7374 5b44 6963 745d  ders: List[Dict]
+0000fca0: 203d 2073 656c 662e 5f61 7069 2e66 6574   = self._api.fet
+0000fcb0: 6368 5f6f 7264 6572 7328 7061 6972 2c20  ch_orders(pair, 
+0000fcc0: 7369 6e63 653d 7369 6e63 655f 6d73 290a  since=since_ms).
+0000fcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fce0: 6578 6365 7074 2063 6378 742e 4e6f 7453  except ccxt.NotS
+0000fcf0: 7570 706f 7274 6564 3a0a 2020 2020 2020  upported:.      
+0000fd00: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000fd10: 536f 6d65 2065 7863 6861 6e67 6573 2064  Some exchanges d
+0000fd20: 6f6e 2774 2073 7570 706f 7274 2066 6574  on't support fet
+0000fd30: 6368 4f72 6465 7273 0a20 2020 2020 2020  chOrders.       
+0000fd40: 2020 2020 2020 2020 2020 2020 2023 2061               # a
+0000fd50: 7474 656d 7074 2074 6f20 6665 7463 6820  ttempt to fetch 
+0000fd60: 6f70 656e 2061 6e64 2063 6c6f 7365 6420  open and closed 
+0000fd70: 6f72 6465 7273 2073 6570 6172 6174 656c  orders separatel
+0000fd80: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+0000fd90: 2020 2020 2020 6f72 6465 7273 203d 2066        orders = f
+0000fda0: 6574 6368 5f6f 7264 6572 735f 656d 756c  etch_orders_emul
+0000fdb0: 6174 6528 290a 2020 2020 2020 2020 2020  ate().          
+0000fdc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000fdd0: 2020 2020 2020 2020 6f72 6465 7273 203d          orders =
+0000fde0: 2066 6574 6368 5f6f 7264 6572 735f 656d   fetch_orders_em
+0000fdf0: 756c 6174 6528 290a 2020 2020 2020 2020  ulate().        
+0000fe00: 2020 2020 7365 6c66 2e5f 6c6f 675f 6578      self._log_ex
+0000fe10: 6368 616e 6765 5f72 6573 706f 6e73 6528  change_response(
+0000fe20: 2766 6574 6368 5f6f 7264 6572 7327 2c20  'fetch_orders', 
+0000fe30: 6f72 6465 7273 290a 2020 2020 2020 2020  orders).        
+0000fe40: 2020 2020 6f72 6465 7273 203d 205b 7365      orders = [se
+0000fe50: 6c66 2e5f 6f72 6465 725f 636f 6e74 7261  lf._order_contra
+0000fe60: 6374 735f 746f 5f61 6d6f 756e 7428 6f29  cts_to_amount(o)
+0000fe70: 2066 6f72 206f 2069 6e20 6f72 6465 7273   for o in orders
+0000fe80: 5d0a 2020 2020 2020 2020 2020 2020 7265  ].            re
+0000fe90: 7475 726e 206f 7264 6572 730a 2020 2020  turn orders.    
+0000fea0: 2020 2020 6578 6365 7074 2063 6378 742e      except ccxt.
+0000feb0: 4444 6f53 5072 6f74 6563 7469 6f6e 2061  DDoSProtection a
+0000fec0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0000fed0: 2072 6169 7365 2044 446f 7350 726f 7465   raise DDosProte
+0000fee0: 6374 696f 6e28 6529 2066 726f 6d20 650a  ction(e) from e.
+0000fef0: 2020 2020 2020 2020 6578 6365 7074 2028          except (
+0000ff00: 6363 7874 2e4e 6574 776f 726b 4572 726f  ccxt.NetworkErro
+0000ff10: 722c 2063 6378 742e 4578 6368 616e 6765  r, ccxt.Exchange
+0000ff20: 4572 726f 7229 2061 7320 653a 0a20 2020  Error) as e:.   
+0000ff30: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
+0000ff40: 656d 706f 7261 7279 4572 726f 7228 0a20  emporaryError(. 
+0000ff50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000ff60: 2743 6f75 6c64 206e 6f74 2066 6574 6368  'Could not fetch
+0000ff70: 2070 6f73 6974 696f 6e73 2064 7565 2074   positions due t
+0000ff80: 6f20 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f  o {e.__class__._
+0000ff90: 5f6e 616d 655f 5f7d 2e20 4d65 7373 6167  _name__}. Messag
+0000ffa0: 653a 207b 657d 2729 2066 726f 6d20 650a  e: {e}') from e.
+0000ffb0: 2020 2020 2020 2020 6578 6365 7074 2063          except c
+0000ffc0: 6378 742e 4261 7365 4572 726f 7220 6173  cxt.BaseError as
+0000ffd0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0000ffe0: 7261 6973 6520 4f70 6572 6174 696f 6e61  raise Operationa
+0000fff0: 6c45 7863 6570 7469 6f6e 2865 2920 6672  lException(e) fr
+00010000: 6f6d 2065 0a0a 2020 2020 4072 6574 7269  om e..    @retri
+00010010: 6572 0a20 2020 2064 6566 2066 6574 6368  er.    def fetch
+00010020: 5f74 7261 6469 6e67 5f66 6565 7328 7365  _trading_fees(se
+00010030: 6c66 2920 2d3e 2044 6963 745b 7374 722c  lf) -> Dict[str,
+00010040: 2041 6e79 5d3a 0a20 2020 2020 2020 2022   Any]:.        "
+00010050: 2222 0a20 2020 2020 2020 2046 6574 6368  "".        Fetch
+00010060: 2075 7365 7220 6163 636f 756e 7420 7472   user account tr
+00010070: 6164 696e 6720 6665 6573 0a20 2020 2020  ading fees.     
+00010080: 2020 2043 616e 2062 6520 6361 6368 6564     Can be cached
+00010090: 2c20 7368 6f75 6c64 206e 6f74 2075 7064  , should not upd
+000100a0: 6174 6520 6f66 7465 6e2e 0a20 2020 2020  ate often..     
+000100b0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+000100c0: 6620 2873 656c 662e 5f63 6f6e 6669 675b  f (self._config[
+000100d0: 2764 7279 5f72 756e 275d 206f 7220 7365  'dry_run'] or se
+000100e0: 6c66 2e74 7261 6469 6e67 5f6d 6f64 6520  lf.trading_mode 
+000100f0: 213d 2054 7261 6469 6e67 4d6f 6465 2e46  != TradingMode.F
+00010100: 5554 5552 4553 0a20 2020 2020 2020 2020  UTURES.         
+00010110: 2020 2020 2020 206f 7220 6e6f 7420 7365         or not se
+00010120: 6c66 2e65 7863 6861 6e67 655f 6861 7328  lf.exchange_has(
+00010130: 2766 6574 6368 5472 6164 696e 6746 6565  'fetchTradingFee
+00010140: 7327 2929 3a0a 2020 2020 2020 2020 2020  s')):.          
+00010150: 2020 7265 7475 726e 207b 7d0a 2020 2020    return {}.    
+00010160: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00010170: 2020 2020 2074 7261 6469 6e67 5f66 6565       trading_fee
+00010180: 733a 2044 6963 745b 7374 722c 2041 6e79  s: Dict[str, Any
+00010190: 5d20 3d20 7365 6c66 2e5f 6170 692e 6665  ] = self._api.fe
+000101a0: 7463 685f 7472 6164 696e 675f 6665 6573  tch_trading_fees
+000101b0: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+000101c0: 656c 662e 5f6c 6f67 5f65 7863 6861 6e67  elf._log_exchang
+000101d0: 655f 7265 7370 6f6e 7365 2827 6665 7463  e_response('fetc
+000101e0: 685f 7472 6164 696e 675f 6665 6573 272c  h_trading_fees',
+000101f0: 2074 7261 6469 6e67 5f66 6565 7329 0a20   trading_fees). 
+00010200: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00010210: 6e20 7472 6164 696e 675f 6665 6573 0a20  n trading_fees. 
+00010220: 2020 2020 2020 2065 7863 6570 7420 6363         except cc
+00010230: 7874 2e44 446f 5350 726f 7465 6374 696f  xt.DDoSProtectio
+00010240: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+00010250: 2020 2020 7261 6973 6520 4444 6f73 5072      raise DDosPr
+00010260: 6f74 6563 7469 6f6e 2865 2920 6672 6f6d  otection(e) from
+00010270: 2065 0a20 2020 2020 2020 2065 7863 6570   e.        excep
+00010280: 7420 2863 6378 742e 4e65 7477 6f72 6b45  t (ccxt.NetworkE
+00010290: 7272 6f72 2c20 6363 7874 2e45 7863 6861  rror, ccxt.Excha
+000102a0: 6e67 6545 7272 6f72 2920 6173 2065 3a0a  ngeError) as e:.
+000102b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000102c0: 6520 5465 6d70 6f72 6172 7945 7272 6f72  e TemporaryError
+000102d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000102e0: 2020 6627 436f 756c 6420 6e6f 7420 6665    f'Could not fe
+000102f0: 7463 6820 7472 6164 696e 6720 6665 6573  tch trading fees
+00010300: 2064 7565 2074 6f20 7b65 2e5f 5f63 6c61   due to {e.__cla
+00010310: 7373 5f5f 2e5f 5f6e 616d 655f 5f7d 2e20  ss__.__name__}. 
+00010320: 4d65 7373 6167 653a 207b 657d 2729 2066  Message: {e}') f
+00010330: 726f 6d20 650a 2020 2020 2020 2020 6578  rom e.        ex
+00010340: 6365 7074 2063 6378 742e 4261 7365 4572  cept ccxt.BaseEr
+00010350: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
+00010360: 2020 2020 2020 7261 6973 6520 4f70 6572        raise Oper
+00010370: 6174 696f 6e61 6c45 7863 6570 7469 6f6e  ationalException
+00010380: 2865 2920 6672 6f6d 2065 0a0a 2020 2020  (e) from e..    
+00010390: 4072 6574 7269 6572 0a20 2020 2064 6566  @retrier.    def
+000103a0: 2066 6574 6368 5f62 6964 735f 6173 6b73   fetch_bids_asks
+000103b0: 2873 656c 662c 2073 796d 626f 6c73 3a20  (self, symbols: 
+000103c0: 4f70 7469 6f6e 616c 5b4c 6973 745b 7374  Optional[List[st
+000103d0: 725d 5d20 3d20 4e6f 6e65 2c20 6361 6368  r]] = None, cach
+000103e0: 6564 3a20 626f 6f6c 203d 2046 616c 7365  ed: bool = False
+000103f0: 2920 2d3e 2044 6963 743a 0a20 2020 2020  ) -> Dict:.     
+00010400: 2020 2022 2222 0a20 2020 2020 2020 203a     """.        :
+00010410: 7061 7261 6d20 6361 6368 6564 3a20 416c  param cached: Al
+00010420: 6c6f 7720 6361 6368 6564 2072 6573 756c  low cached resul
+00010430: 740a 2020 2020 2020 2020 3a72 6574 7572  t.        :retur
+00010440: 6e3a 2066 6574 6368 5f74 6963 6b65 7273  n: fetch_tickers
+00010450: 2072 6573 756c 740a 2020 2020 2020 2020   result.        
+00010460: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
+00010470: 6f74 2073 656c 662e 6578 6368 616e 6765  ot self.exchange
+00010480: 5f68 6173 2827 6665 7463 6842 6964 7341  _has('fetchBidsA
+00010490: 736b 7327 293a 0a20 2020 2020 2020 2020  sks'):.         
+000104a0: 2020 2072 6574 7572 6e20 7b7d 0a20 2020     return {}.   
+000104b0: 2020 2020 2069 6620 6361 6368 6564 3a0a       if cached:.
+000104c0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+000104d0: 2073 656c 662e 5f63 6163 6865 5f6c 6f63   self._cache_loc
+000104e0: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
+000104f0: 2020 2074 6963 6b65 7273 203d 2073 656c     tickers = sel
+00010500: 662e 5f66 6574 6368 5f74 6963 6b65 7273  f._fetch_tickers
+00010510: 5f63 6163 6865 2e67 6574 2827 6665 7463  _cache.get('fetc
+00010520: 685f 6269 6473 5f61 736b 7327 290a 2020  h_bids_asks').  
+00010530: 2020 2020 2020 2020 2020 6966 2074 6963            if tic
+00010540: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+00010550: 2020 2020 2020 7265 7475 726e 2074 6963        return tic
+00010560: 6b65 7273 0a20 2020 2020 2020 2074 7279  kers.        try
+00010570: 3a0a 2020 2020 2020 2020 2020 2020 7469  :.            ti
+00010580: 636b 6572 7320 3d20 7365 6c66 2e5f 6170  ckers = self._ap
+00010590: 692e 6665 7463 685f 6269 6473 5f61 736b  i.fetch_bids_ask
+000105a0: 7328 7379 6d62 6f6c 7329 0a20 2020 2020  s(symbols).     
+000105b0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+000105c0: 2e5f 6361 6368 655f 6c6f 636b 3a0a 2020  ._cache_lock:.  
+000105d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000105e0: 6c66 2e5f 6665 7463 685f 7469 636b 6572  lf._fetch_ticker
+000105f0: 735f 6361 6368 655b 2766 6574 6368 5f62  s_cache['fetch_b
+00010600: 6964 735f 6173 6b73 275d 203d 2074 6963  ids_asks'] = tic
+00010610: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
+00010620: 2072 6574 7572 6e20 7469 636b 6572 730a   return tickers.
+00010630: 2020 2020 2020 2020 6578 6365 7074 2063          except c
+00010640: 6378 742e 4e6f 7453 7570 706f 7274 6564  cxt.NotSupported
+00010650: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00010660: 2020 2072 6169 7365 204f 7065 7261 7469     raise Operati
+00010670: 6f6e 616c 4578 6365 7074 696f 6e28 0a20  onalException(. 
+00010680: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010690: 2745 7863 6861 6e67 6520 7b73 656c 662e  'Exchange {self.
+000106a0: 5f61 7069 2e6e 616d 657d 2064 6f65 7320  _api.name} does 
+000106b0: 6e6f 7420 7375 7070 6f72 7420 6665 7463  not support fetc
+000106c0: 6869 6e67 2062 6964 732f 6173 6b73 2069  hing bids/asks i
+000106d0: 6e20 6261 7463 682e 2027 0a20 2020 2020  n batch. '.     
+000106e0: 2020 2020 2020 2020 2020 2066 274d 6573             f'Mes
+000106f0: 7361 6765 3a20 7b65 7d27 2920 6672 6f6d  sage: {e}') from
+00010700: 2065 0a20 2020 2020 2020 2065 7863 6570   e.        excep
+00010710: 7420 6363 7874 2e44 446f 5350 726f 7465  t ccxt.DDoSProte
+00010720: 6374 696f 6e20 6173 2065 3a0a 2020 2020  ction as e:.    
+00010730: 2020 2020 2020 2020 7261 6973 6520 4444          raise DD
+00010740: 6f73 5072 6f74 6563 7469 6f6e 2865 2920  osProtection(e) 
+00010750: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
+00010760: 7863 6570 7420 2863 6378 742e 4e65 7477  xcept (ccxt.Netw
+00010770: 6f72 6b45 7272 6f72 2c20 6363 7874 2e45  orkError, ccxt.E
+00010780: 7863 6861 6e67 6545 7272 6f72 2920 6173  xchangeError) as
+00010790: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+000107a0: 7261 6973 6520 5465 6d70 6f72 6172 7945  raise TemporaryE
+000107b0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000107c0: 2020 2020 2020 6627 436f 756c 6420 6e6f        f'Could no
+000107d0: 7420 6c6f 6164 2062 6964 732f 6173 6b73  t load bids/asks
+000107e0: 2064 7565 2074 6f20 7b65 2e5f 5f63 6c61   due to {e.__cla
+000107f0: 7373 5f5f 2e5f 5f6e 616d 655f 5f7d 2e20  ss__.__name__}. 
+00010800: 4d65 7373 6167 653a 207b 657d 2729 2066  Message: {e}') f
+00010810: 726f 6d20 650a 2020 2020 2020 2020 6578  rom e.        ex
+00010820: 6365 7074 2063 6378 742e 4261 7365 4572  cept ccxt.BaseEr
+00010830: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
+00010840: 2020 2020 2020 7261 6973 6520 4f70 6572        raise Oper
+00010850: 6174 696f 6e61 6c45 7863 6570 7469 6f6e  ationalException
+00010860: 2865 2920 6672 6f6d 2065 0a0a 2020 2020  (e) from e..    
+00010870: 4072 6574 7269 6572 0a20 2020 2064 6566  @retrier.    def
+00010880: 2067 6574 5f74 6963 6b65 7273 2873 656c   get_tickers(sel
+00010890: 662c 2073 796d 626f 6c73 3a20 4f70 7469  f, symbols: Opti
+000108a0: 6f6e 616c 5b4c 6973 745b 7374 725d 5d20  onal[List[str]] 
+000108b0: 3d20 4e6f 6e65 2c20 6361 6368 6564 3a20  = None, cached: 
+000108c0: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
+000108d0: 2054 6963 6b65 7273 3a0a 2020 2020 2020   Tickers:.      
+000108e0: 2020 2222 220a 2020 2020 2020 2020 3a70    """.        :p
+000108f0: 6172 616d 2063 6163 6865 643a 2041 6c6c  aram cached: All
+00010900: 6f77 2063 6163 6865 6420 7265 7375 6c74  ow cached result
+00010910: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00010920: 3a20 6665 7463 685f 7469 636b 6572 7320  : fetch_tickers 
+00010930: 7265 7375 6c74 0a20 2020 2020 2020 2022  result.        "
+00010940: 2222 0a20 2020 2020 2020 2074 6963 6b65  "".        ticke
+00010950: 7273 3a20 5469 636b 6572 730a 2020 2020  rs: Tickers.    
+00010960: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00010970: 6578 6368 616e 6765 5f68 6173 2827 6665  exchange_has('fe
+00010980: 7463 6854 6963 6b65 7273 2729 3a0a 2020  tchTickers'):.  
+00010990: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000109a0: 207b 7d0a 2020 2020 2020 2020 6966 2063   {}.        if c
+000109b0: 6163 6865 643a 0a20 2020 2020 2020 2020  ached:.         
+000109c0: 2020 2077 6974 6820 7365 6c66 2e5f 6361     with self._ca
+000109d0: 6368 655f 6c6f 636b 3a0a 2020 2020 2020  che_lock:.      
+000109e0: 2020 2020 2020 2020 2020 7469 636b 6572            ticker
+000109f0: 7320 3d20 7365 6c66 2e5f 6665 7463 685f  s = self._fetch_
+00010a00: 7469 636b 6572 735f 6361 6368 652e 6765  tickers_cache.ge
+00010a10: 7428 2766 6574 6368 5f74 6963 6b65 7273  t('fetch_tickers
+00010a20: 2729 2020 2320 7479 7065 3a20 6967 6e6f  ')  # type: igno
+00010a30: 7265 0a20 2020 2020 2020 2020 2020 2069  re.            i
+00010a40: 6620 7469 636b 6572 733a 0a20 2020 2020  f tickers:.     
+00010a50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00010a60: 6e20 7469 636b 6572 730a 2020 2020 2020  n tickers.      
+00010a70: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00010a80: 2020 2074 6963 6b65 7273 203d 2073 656c     tickers = sel
+00010a90: 662e 5f61 7069 2e66 6574 6368 5f74 6963  f._api.fetch_tic
+00010aa0: 6b65 7273 2873 796d 626f 6c73 290a 2020  kers(symbols).  
+00010ab0: 2020 2020 2020 2020 2020 7769 7468 2073            with s
+00010ac0: 656c 662e 5f63 6163 6865 5f6c 6f63 6b3a  elf._cache_lock:
+00010ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ae0: 2073 656c 662e 5f66 6574 6368 5f74 6963   self._fetch_tic
+00010af0: 6b65 7273 5f63 6163 6865 5b27 6665 7463  kers_cache['fetc
+00010b00: 685f 7469 636b 6572 7327 5d20 3d20 7469  h_tickers'] = ti
+00010b10: 636b 6572 730a 2020 2020 2020 2020 2020  ckers.          
+00010b20: 2020 7265 7475 726e 2074 6963 6b65 7273    return tickers
+00010b30: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00010b40: 6363 7874 2e4e 6f74 5375 7070 6f72 7465  ccxt.NotSupporte
+00010b50: 6420 6173 2065 3a0a 2020 2020 2020 2020  d as e:.        
+00010b60: 2020 2020 7261 6973 6520 4f70 6572 6174      raise Operat
+00010b70: 696f 6e61 6c45 7863 6570 7469 6f6e 280a  ionalException(.
+00010b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b90: 6627 4578 6368 616e 6765 207b 7365 6c66  f'Exchange {self
+00010ba0: 2e5f 6170 692e 6e61 6d65 7d20 646f 6573  ._api.name} does
+00010bb0: 206e 6f74 2073 7570 706f 7274 2066 6574   not support fet
+00010bc0: 6368 696e 6720 7469 636b 6572 7320 696e  ching tickers in
+00010bd0: 2062 6174 6368 2e20 270a 2020 2020 2020   batch. '.      
+00010be0: 2020 2020 2020 2020 2020 6627 4d65 7373            f'Mess
+00010bf0: 6167 653a 207b 657d 2729 2066 726f 6d20  age: {e}') from 
+00010c00: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
+00010c10: 2063 6378 742e 4444 6f53 5072 6f74 6563   ccxt.DDoSProtec
+00010c20: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00010c30: 2020 2020 2020 2072 6169 7365 2044 446f         raise DDo
+00010c40: 7350 726f 7465 6374 696f 6e28 6529 2066  sProtection(e) f
+00010c50: 726f 6d20 650a 2020 2020 2020 2020 6578  rom e.        ex
+00010c60: 6365 7074 2028 6363 7874 2e4e 6574 776f  cept (ccxt.Netwo
+00010c70: 726b 4572 726f 722c 2063 6378 742e 4578  rkError, ccxt.Ex
+00010c80: 6368 616e 6765 4572 726f 7229 2061 7320  changeError) as 
+00010c90: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00010ca0: 6169 7365 2054 656d 706f 7261 7279 4572  aise TemporaryEr
+00010cb0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00010cc0: 2020 2020 2066 2743 6f75 6c64 206e 6f74       f'Could not
+00010cd0: 206c 6f61 6420 7469 636b 6572 7320 6475   load tickers du
+00010ce0: 6520 746f 207b 652e 5f5f 636c 6173 735f  e to {e.__class_
+00010cf0: 5f2e 5f5f 6e61 6d65 5f5f 7d2e 204d 6573  _.__name__}. Mes
+00010d00: 7361 6765 3a20 7b65 7d27 2920 6672 6f6d  sage: {e}') from
+00010d10: 2065 0a20 2020 2020 2020 2065 7863 6570   e.        excep
+00010d20: 7420 6363 7874 2e42 6173 6545 7272 6f72  t ccxt.BaseError
+00010d30: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00010d40: 2020 2072 6169 7365 204f 7065 7261 7469     raise Operati
+00010d50: 6f6e 616c 4578 6365 7074 696f 6e28 6529  onalException(e)
+00010d60: 2066 726f 6d20 650a 0a20 2020 2023 2050   from e..    # P
+00010d70: 7269 6369 6e67 2069 6e66 6f0a 0a20 2020  ricing info..   
+00010d80: 2040 7265 7472 6965 720a 2020 2020 6465   @retrier.    de
+00010d90: 6620 6665 7463 685f 7469 636b 6572 2873  f fetch_ticker(s
+00010da0: 656c 662c 2070 6169 723a 2073 7472 2920  elf, pair: str) 
+00010db0: 2d3e 2054 6963 6b65 723a 0a20 2020 2020  -> Ticker:.     
+00010dc0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00010dd0: 2020 2020 6966 2028 7061 6972 206e 6f74      if (pair not
+00010de0: 2069 6e20 7365 6c66 2e6d 6172 6b65 7473   in self.markets
+00010df0: 206f 720a 2020 2020 2020 2020 2020 2020   or.            
+00010e00: 2020 2020 2020 2020 7365 6c66 2e6d 6172          self.mar
+00010e10: 6b65 7473 5b70 6169 725d 2e67 6574 2827  kets[pair].get('
+00010e20: 6163 7469 7665 272c 2046 616c 7365 2920  active', False) 
+00010e30: 6973 2046 616c 7365 293a 0a20 2020 2020  is False):.     
+00010e40: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00010e50: 2045 7863 6861 6e67 6545 7272 6f72 2866   ExchangeError(f
+00010e60: 2250 6169 7220 7b70 6169 727d 206e 6f74  "Pair {pair} not
+00010e70: 2061 7661 696c 6162 6c65 2229 0a20 2020   available").   
+00010e80: 2020 2020 2020 2020 2064 6174 613a 2054           data: T
+00010e90: 6963 6b65 7220 3d20 7365 6c66 2e5f 6170  icker = self._ap
+00010ea0: 692e 6665 7463 685f 7469 636b 6572 2870  i.fetch_ticker(p
+00010eb0: 6169 7229 0a20 2020 2020 2020 2020 2020  air).           
+00010ec0: 2072 6574 7572 6e20 6461 7461 0a20 2020   return data.   
+00010ed0: 2020 2020 2065 7863 6570 7420 6363 7874       except ccxt
+00010ee0: 2e44 446f 5350 726f 7465 6374 696f 6e20  .DDoSProtection 
+00010ef0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00010f00: 2020 7261 6973 6520 4444 6f73 5072 6f74    raise DDosProt
+00010f10: 6563 7469 6f6e 2865 2920 6672 6f6d 2065  ection(e) from e
+00010f20: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00010f30: 2863 6378 742e 4e65 7477 6f72 6b45 7272  (ccxt.NetworkErr
+00010f40: 6f72 2c20 6363 7874 2e45 7863 6861 6e67  or, ccxt.Exchang
+00010f50: 6545 7272 6f72 2920 6173 2065 3a0a 2020  eError) as e:.  
+00010f60: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00010f70: 5465 6d70 6f72 6172 7945 7272 6f72 280a  TemporaryError(.
+00010f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f90: 6627 436f 756c 6420 6e6f 7420 6c6f 6164  f'Could not load
+00010fa0: 2074 6963 6b65 7220 6475 6520 746f 207b   ticker due to {
+00010fb0: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
+00010fc0: 6d65 5f5f 7d2e 204d 6573 7361 6765 3a20  me__}. Message: 
+00010fd0: 7b65 7d27 2920 6672 6f6d 2065 0a20 2020  {e}') from e.   
+00010fe0: 2020 2020 2065 7863 6570 7420 6363 7874       except ccxt
+00010ff0: 2e42 6173 6545 7272 6f72 2061 7320 653a  .BaseError as e:
+00011000: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00011010: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
+00011020: 6365 7074 696f 6e28 6529 2066 726f 6d20  ception(e) from 
+00011030: 650a 0a20 2020 2040 7374 6174 6963 6d65  e..    @staticme
+00011040: 7468 6f64 0a20 2020 2064 6566 2067 6574  thod.    def get
+00011050: 5f6e 6578 745f 6c69 6d69 745f 696e 5f6c  _next_limit_in_l
+00011060: 6973 7428 6c69 6d69 743a 2069 6e74 2c20  ist(limit: int, 
+00011070: 6c69 6d69 745f 7261 6e67 653a 204f 7074  limit_range: Opt
+00011080: 696f 6e61 6c5b 4c69 7374 5b69 6e74 5d5d  ional[List[int]]
+00011090: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110b0: 2072 616e 6765 5f72 6571 7569 7265 643a   range_required:
+000110c0: 2062 6f6f 6c20 3d20 5472 7565 293a 0a20   bool = True):. 
+000110d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000110e0: 2020 2047 6574 206e 6578 7420 6772 6561     Get next grea
+000110f0: 7465 7220 7661 6c75 6520 696e 2074 6865  ter value in the
+00011100: 206c 6973 742e 0a20 2020 2020 2020 2055   list..        U
+00011110: 7365 6420 6279 2066 6574 6368 5f6c 325f  sed by fetch_l2_
+00011120: 6f72 6465 725f 626f 6f6b 2069 6620 7468  order_book if th
+00011130: 6520 6170 6920 6f6e 6c79 2073 7570 706f  e api only suppo
+00011140: 7274 7320 6120 6c69 6d69 7465 6420 7261  rts a limited ra
+00011150: 6e67 650a 2020 2020 2020 2020 2222 220a  nge.        """.
+00011160: 2020 2020 2020 2020 6966 206e 6f74 206c          if not l
+00011170: 696d 6974 5f72 616e 6765 3a0a 2020 2020  imit_range:.    
+00011180: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+00011190: 696d 6974 0a0a 2020 2020 2020 2020 7265  imit..        re
+000111a0: 7375 6c74 203d 206d 696e 285b 7820 666f  sult = min([x fo
+000111b0: 7220 7820 696e 206c 696d 6974 5f72 616e  r x in limit_ran
+000111c0: 6765 2069 6620 6c69 6d69 7420 3c3d 2078  ge if limit <= x
+000111d0: 5d20 2b20 5b6d 6178 286c 696d 6974 5f72  ] + [max(limit_r
+000111e0: 616e 6765 295d 290a 2020 2020 2020 2020  ange)]).        
+000111f0: 6966 206e 6f74 2072 616e 6765 5f72 6571  if not range_req
+00011200: 7569 7265 6420 616e 6420 6c69 6d69 7420  uired and limit 
+00011210: 3e20 7265 7375 6c74 3a0a 2020 2020 2020  > result:.      
+00011220: 2020 2020 2020 2320 5261 6e67 6520 6973        # Range is
+00011230: 206e 6f74 2072 6571 7569 7265 6420 2d20   not required - 
+00011240: 7765 2063 616e 2075 7365 204e 6f6e 6520  we can use None 
+00011250: 6173 2070 6172 616d 6574 6572 2e0a 2020  as parameter..  
+00011260: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00011270: 204e 6f6e 650a 2020 2020 2020 2020 7265   None.        re
+00011280: 7475 726e 2072 6573 756c 740a 0a20 2020  turn result..   
+00011290: 2040 7265 7472 6965 720a 2020 2020 6465   @retrier.    de
+000112a0: 6620 6665 7463 685f 6c32 5f6f 7264 6572  f fetch_l2_order
+000112b0: 5f62 6f6f 6b28 7365 6c66 2c20 7061 6972  _book(self, pair
+000112c0: 3a20 7374 722c 206c 696d 6974 3a20 696e  : str, limit: in
+000112d0: 7420 3d20 3130 3029 202d 3e20 4f72 6465  t = 100) -> Orde
+000112e0: 7242 6f6f 6b3a 0a20 2020 2020 2020 2022  rBook:.        "
+000112f0: 2222 0a20 2020 2020 2020 2047 6574 204c  "".        Get L
+00011300: 3220 6f72 6465 7220 626f 6f6b 2066 726f  2 order book fro
+00011310: 6d20 6578 6368 616e 6765 2e0a 2020 2020  m exchange..    
+00011320: 2020 2020 4361 6e20 6265 206c 696d 6974      Can be limit
+00011330: 6564 2074 6f20 6120 6365 7274 6169 6e20  ed to a certain 
+00011340: 616d 6f75 6e74 2028 6966 2073 7570 706f  amount (if suppo
+00011350: 7274 6564 292e 0a20 2020 2020 2020 2052  rted)..        R
+00011360: 6574 7572 6e73 2061 2064 6963 7420 696e  eturns a dict in
+00011370: 2074 6865 2066 6f72 6d61 740a 2020 2020   the format.    
+00011380: 2020 2020 7b27 6173 6b73 273a 205b 7072      {'asks': [pr
+00011390: 6963 652c 2076 6f6c 756d 655d 2c20 2762  ice, volume], 'b
+000113a0: 6964 7327 3a20 5b70 7269 6365 2c20 766f  ids': [price, vo
+000113b0: 6c75 6d65 5d7d 0a20 2020 2020 2020 2022  lume]}.        "
+000113c0: 2222 0a20 2020 2020 2020 206c 696d 6974  "".        limit
+000113d0: 3120 3d20 7365 6c66 2e67 6574 5f6e 6578  1 = self.get_nex
+000113e0: 745f 6c69 6d69 745f 696e 5f6c 6973 7428  t_limit_in_list(
+000113f0: 6c69 6d69 742c 2073 656c 662e 5f66 745f  limit, self._ft_
+00011400: 6861 735b 276c 325f 6c69 6d69 745f 7261  has['l2_limit_ra
+00011410: 6e67 6527 5d2c 0a20 2020 2020 2020 2020  nge'],.         
+00011420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011440: 2020 2020 7365 6c66 2e5f 6674 5f68 6173      self._ft_has
+00011450: 5b27 6c32 5f6c 696d 6974 5f72 616e 6765  ['l2_limit_range
+00011460: 5f72 6571 7569 7265 6427 5d29 0a20 2020  _required']).   
+00011470: 2020 2020 2074 7279 3a0a 0a20 2020 2020       try:..     
+00011480: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00011490: 6c66 2e5f 6170 692e 6665 7463 685f 6c32  lf._api.fetch_l2
+000114a0: 5f6f 7264 6572 5f62 6f6f 6b28 7061 6972  _order_book(pair
+000114b0: 2c20 6c69 6d69 7431 290a 2020 2020 2020  , limit1).      
+000114c0: 2020 6578 6365 7074 2063 6378 742e 4e6f    except ccxt.No
+000114d0: 7453 7570 706f 7274 6564 2061 7320 653a  tSupported as e:
+000114e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000114f0: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
+00011500: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
+00011510: 2020 2020 2020 2020 2066 2745 7863 6861           f'Excha
+00011520: 6e67 6520 7b73 656c 662e 5f61 7069 2e6e  nge {self._api.n
+00011530: 616d 657d 2064 6f65 7320 6e6f 7420 7375  ame} does not su
+00011540: 7070 6f72 7420 6665 7463 6869 6e67 206f  pport fetching o
+00011550: 7264 6572 2062 6f6f 6b2e 270a 2020 2020  rder book.'.    
+00011560: 2020 2020 2020 2020 2020 2020 6627 4d65              f'Me
+00011570: 7373 6167 653a 207b 657d 2729 2066 726f  ssage: {e}') fro
+00011580: 6d20 650a 2020 2020 2020 2020 6578 6365  m e.        exce
+00011590: 7074 2063 6378 742e 4444 6f53 5072 6f74  pt ccxt.DDoSProt
+000115a0: 6563 7469 6f6e 2061 7320 653a 0a20 2020  ection as e:.   
+000115b0: 2020 2020 2020 2020 2072 6169 7365 2044           raise D
+000115c0: 446f 7350 726f 7465 6374 696f 6e28 6529  DosProtection(e)
+000115d0: 2066 726f 6d20 650a 2020 2020 2020 2020   from e.        
+000115e0: 6578 6365 7074 2028 6363 7874 2e4e 6574  except (ccxt.Net
+000115f0: 776f 726b 4572 726f 722c 2063 6378 742e  workError, ccxt.
+00011600: 4578 6368 616e 6765 4572 726f 7229 2061  ExchangeError) a
+00011610: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00011620: 2072 6169 7365 2054 656d 706f 7261 7279   raise Temporary
+00011630: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00011640: 2020 2020 2020 2066 2743 6f75 6c64 206e         f'Could n
+00011650: 6f74 2067 6574 206f 7264 6572 2062 6f6f  ot get order boo
+00011660: 6b20 6475 6520 746f 207b 652e 5f5f 636c  k due to {e.__cl
+00011670: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d2e  ass__.__name__}.
+00011680: 204d 6573 7361 6765 3a20 7b65 7d27 2920   Message: {e}') 
+00011690: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
+000116a0: 7863 6570 7420 6363 7874 2e42 6173 6545  xcept ccxt.BaseE
+000116b0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+000116c0: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
+000116d0: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
+000116e0: 6e28 6529 2066 726f 6d20 650a 0a20 2020  n(e) from e..   
+000116f0: 2064 6566 205f 6765 745f 7072 6963 655f   def _get_price_
+00011700: 7369 6465 2873 656c 662c 2073 6964 653a  side(self, side:
+00011710: 2073 7472 2c20 6973 5f73 686f 7274 3a20   str, is_short: 
+00011720: 626f 6f6c 2c20 636f 6e66 5f73 7472 6174  bool, conf_strat
+00011730: 6567 793a 2044 6963 7429 202d 3e20 4269  egy: Dict) -> Bi
+00011740: 6441 736b 3a0a 2020 2020 2020 2020 7072  dAsk:.        pr
+00011750: 6963 655f 7369 6465 203d 2063 6f6e 665f  ice_side = conf_
+00011760: 7374 7261 7465 6779 5b27 7072 6963 655f  strategy['price_
+00011770: 7369 6465 275d 0a0a 2020 2020 2020 2020  side']..        
+00011780: 6966 2070 7269 6365 5f73 6964 6520 696e  if price_side in
+00011790: 2028 2773 616d 6527 2c20 276f 7468 6572   ('same', 'other
+000117a0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+000117b0: 7072 6963 655f 6d61 7020 3d20 7b0a 2020  price_map = {.  
+000117c0: 2020 2020 2020 2020 2020 2020 2020 2827                ('
+000117d0: 656e 7472 7927 2c20 276c 6f6e 6727 2c20  entry', 'long', 
+000117e0: 2773 616d 6527 293a 2027 6269 6427 2c0a  'same'): 'bid',.
+000117f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011800: 2827 656e 7472 7927 2c20 276c 6f6e 6727  ('entry', 'long'
+00011810: 2c20 276f 7468 6572 2729 3a20 2761 736b  , 'other'): 'ask
+00011820: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00011830: 2020 2028 2765 6e74 7279 272c 2027 7368     ('entry', 'sh
+00011840: 6f72 7427 2c20 2773 616d 6527 293a 2027  ort', 'same'): '
+00011850: 6173 6b27 2c0a 2020 2020 2020 2020 2020  ask',.          
+00011860: 2020 2020 2020 2827 656e 7472 7927 2c20        ('entry', 
+00011870: 2773 686f 7274 272c 2027 6f74 6865 7227  'short', 'other'
+00011880: 293a 2027 6269 6427 2c0a 2020 2020 2020  ): 'bid',.      
+00011890: 2020 2020 2020 2020 2020 2827 6578 6974            ('exit
+000118a0: 272c 2027 6c6f 6e67 272c 2027 7361 6d65  ', 'long', 'same
+000118b0: 2729 3a20 2761 736b 272c 0a20 2020 2020  '): 'ask',.     
+000118c0: 2020 2020 2020 2020 2020 2028 2765 7869             ('exi
+000118d0: 7427 2c20 276c 6f6e 6727 2c20 276f 7468  t', 'long', 'oth
+000118e0: 6572 2729 3a20 2762 6964 272c 0a20 2020  er'): 'bid',.   
+000118f0: 2020 2020 2020 2020 2020 2020 2028 2765               ('e
+00011900: 7869 7427 2c20 2773 686f 7274 272c 2027  xit', 'short', '
+00011910: 7361 6d65 2729 3a20 2762 6964 272c 0a20  same'): 'bid',. 
+00011920: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00011930: 2765 7869 7427 2c20 2773 686f 7274 272c  'exit', 'short',
+00011940: 2027 6f74 6865 7227 293a 2027 6173 6b27   'other'): 'ask'
+00011950: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
+00011960: 2020 2020 2020 2020 2020 2020 7072 6963              pric
+00011970: 655f 7369 6465 203d 2070 7269 6365 5f6d  e_side = price_m
+00011980: 6170 5b28 7369 6465 2c20 2773 686f 7274  ap[(side, 'short
+00011990: 2720 6966 2069 735f 7368 6f72 7420 656c  ' if is_short el
+000119a0: 7365 2027 6c6f 6e67 272c 2070 7269 6365  se 'long', price
+000119b0: 5f73 6964 6529 5d0a 2020 2020 2020 2020  _side)].        
+000119c0: 7265 7475 726e 2070 7269 6365 5f73 6964  return price_sid
+000119d0: 650a 0a20 2020 2064 6566 2067 6574 5f72  e..    def get_r
+000119e0: 6174 6528 7365 6c66 2c20 7061 6972 3a20  ate(self, pair: 
+000119f0: 7374 722c 2072 6566 7265 7368 3a20 626f  str, refresh: bo
+00011a00: 6f6c 2c0a 2020 2020 2020 2020 2020 2020  ol,.            
+00011a10: 2020 2020 2073 6964 653a 2045 6e74 7279       side: Entry
+00011a20: 4578 6974 2c20 6973 5f73 686f 7274 3a20  Exit, is_short: 
+00011a30: 626f 6f6c 2c0a 2020 2020 2020 2020 2020  bool,.          
+00011a40: 2020 2020 2020 206f 7264 6572 5f62 6f6f         order_boo
+00011a50: 6b3a 204f 7074 696f 6e61 6c5b 4f72 6465  k: Optional[Orde
+00011a60: 7242 6f6f 6b5d 203d 204e 6f6e 652c 2074  rBook] = None, t
+00011a70: 6963 6b65 723a 204f 7074 696f 6e61 6c5b  icker: Optional[
+00011a80: 5469 636b 6572 5d20 3d20 4e6f 6e65 2920  Ticker] = None) 
+00011a90: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
+00011aa0: 2020 2222 220a 2020 2020 2020 2020 4361    """.        Ca
+00011ab0: 6c63 756c 6174 6573 2062 6964 2f61 736b  lculates bid/ask
+00011ac0: 2074 6172 6765 740a 2020 2020 2020 2020   target.        
+00011ad0: 6269 6420 7261 7465 202d 2062 6574 7765  bid rate - betwe
+00011ae0: 656e 2063 7572 7265 6e74 2061 736b 2070  en current ask p
+00011af0: 7269 6365 2061 6e64 206c 6173 7420 7072  rice and last pr
+00011b00: 6963 650a 2020 2020 2020 2020 6173 6b20  ice.        ask 
+00011b10: 7261 7465 202d 2065 6974 6865 7220 7573  rate - either us
+00011b20: 696e 6720 7469 636b 6572 2062 6964 206f  ing ticker bid o
+00011b30: 7220 6669 7273 7420 6269 6420 6261 7365  r first bid base
+00011b40: 6420 6f6e 206f 7264 6572 626f 6f6b 0a20  d on orderbook. 
+00011b50: 2020 2020 2020 206f 7220 7265 6d61 696e         or remain
+00011b60: 2073 7461 7469 6320 696e 2061 6e79 206f   static in any o
+00011b70: 7468 6572 2063 6173 6520 7369 6e63 6520  ther case since 
+00011b80: 6974 2773 206e 6f74 2075 7064 6174 696e  it's not updatin
+00011b90: 672e 0a20 2020 2020 2020 203a 7061 7261  g..        :para
+00011ba0: 6d20 7061 6972 3a20 5061 6972 2074 6f20  m pair: Pair to 
+00011bb0: 6765 7420 7261 7465 2066 6f72 0a20 2020  get rate for.   
+00011bc0: 2020 2020 203a 7061 7261 6d20 7265 6672       :param refr
+00011bd0: 6573 683a 2061 6c6c 6f77 2063 6163 6865  esh: allow cache
+00011be0: 6420 6461 7461 0a20 2020 2020 2020 203a  d data.        :
+00011bf0: 7061 7261 6d20 7369 6465 3a20 2262 7579  param side: "buy
+00011c00: 2220 6f72 2022 7365 6c6c 220a 2020 2020  " or "sell".    
+00011c10: 2020 2020 3a72 6574 7572 6e3a 2066 6c6f      :return: flo
+00011c20: 6174 3a20 5072 6963 650a 2020 2020 2020  at: Price.      
+00011c30: 2020 3a72 6169 7365 7320 5072 6963 696e    :raises Pricin
+00011c40: 6745 7272 6f72 2069 6620 6f72 6465 7262  gError if orderb
+00011c50: 6f6f 6b20 7072 6963 6520 636f 756c 6420  ook price could 
+00011c60: 6e6f 7420 6265 2064 6574 6572 6d69 6e65  not be determine
+00011c70: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
+00011c80: 2020 2020 2020 206e 616d 6520 3d20 7369         name = si
+00011c90: 6465 2e63 6170 6974 616c 697a 6528 290a  de.capitalize().
+00011ca0: 2020 2020 2020 2020 7374 7261 745f 6e61          strat_na
+00011cb0: 6d65 203d 2027 656e 7472 795f 7072 6963  me = 'entry_pric
+00011cc0: 696e 6727 2069 6620 7369 6465 203d 3d20  ing' if side == 
+00011cd0: 2265 6e74 7279 2220 656c 7365 2027 6578  "entry" else 'ex
+00011ce0: 6974 5f70 7269 6369 6e67 270a 0a20 2020  it_pricing'..   
+00011cf0: 2020 2020 2063 6163 6865 5f72 6174 653a       cache_rate:
+00011d00: 2054 544c 4361 6368 6520 3d20 7365 6c66   TTLCache = self
+00011d10: 2e5f 656e 7472 795f 7261 7465 5f63 6163  ._entry_rate_cac
+00011d20: 6865 2069 6620 7369 6465 203d 3d20 2265  he if side == "e
+00011d30: 6e74 7279 2220 656c 7365 2073 656c 662e  ntry" else self.
+00011d40: 5f65 7869 745f 7261 7465 5f63 6163 6865  _exit_rate_cache
+00011d50: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00011d60: 7265 6672 6573 683a 0a20 2020 2020 2020  refresh:.       
+00011d70: 2020 2020 2077 6974 6820 7365 6c66 2e5f       with self._
+00011d80: 6361 6368 655f 6c6f 636b 3a0a 2020 2020  cache_lock:.    
+00011d90: 2020 2020 2020 2020 2020 2020 7261 7465              rate
+00011da0: 203d 2063 6163 6865 5f72 6174 652e 6765   = cache_rate.ge
+00011db0: 7428 7061 6972 290a 2020 2020 2020 2020  t(pair).        
+00011dc0: 2020 2020 2320 4368 6563 6b20 6966 2063      # Check if c
+00011dd0: 6163 6865 2068 6173 2062 6565 6e20 696e  ache has been in
+00011de0: 7661 6c69 6461 7465 640a 2020 2020 2020  validated.      
+00011df0: 2020 2020 2020 6966 2072 6174 653a 0a20        if rate:. 
+00011e00: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00011e10: 6f67 6765 722e 6465 6275 6728 6622 5573  ogger.debug(f"Us
+00011e20: 696e 6720 6361 6368 6564 207b 7369 6465  ing cached {side
+00011e30: 7d20 7261 7465 2066 6f72 207b 7061 6972  } rate for {pair
+00011e40: 7d2e 2229 0a20 2020 2020 2020 2020 2020  }.").           
+00011e50: 2020 2020 2072 6574 7572 6e20 7261 7465       return rate
+00011e60: 0a0a 2020 2020 2020 2020 636f 6e66 5f73  ..        conf_s
+00011e70: 7472 6174 6567 7920 3d20 7365 6c66 2e5f  trategy = self._
+00011e80: 636f 6e66 6967 2e67 6574 2873 7472 6174  config.get(strat
+00011e90: 5f6e 616d 652c 207b 7d29 0a0a 2020 2020  _name, {})..    
+00011ea0: 2020 2020 7072 6963 655f 7369 6465 203d      price_side =
+00011eb0: 2073 656c 662e 5f67 6574 5f70 7269 6365   self._get_price
+00011ec0: 5f73 6964 6528 7369 6465 2c20 6973 5f73  _side(side, is_s
+00011ed0: 686f 7274 2c20 636f 6e66 5f73 7472 6174  hort, conf_strat
+00011ee0: 6567 7929 0a0a 2020 2020 2020 2020 7072  egy)..        pr
+00011ef0: 6963 655f 7369 6465 5f77 6f72 6420 3d20  ice_side_word = 
+00011f00: 7072 6963 655f 7369 6465 2e63 6170 6974  price_side.capit
+00011f10: 616c 697a 6528 290a 0a20 2020 2020 2020  alize()..       
+00011f20: 2069 6620 636f 6e66 5f73 7472 6174 6567   if conf_strateg
+00011f30: 792e 6765 7428 2775 7365 5f6f 7264 6572  y.get('use_order
+00011f40: 5f62 6f6f 6b27 2c20 4661 6c73 6529 3a0a  _book', False):.
+00011f50: 0a20 2020 2020 2020 2020 2020 206f 7264  .            ord
+00011f60: 6572 5f62 6f6f 6b5f 746f 7020 3d20 636f  er_book_top = co
+00011f70: 6e66 5f73 7472 6174 6567 792e 6765 7428  nf_strategy.get(
+00011f80: 276f 7264 6572 5f62 6f6f 6b5f 746f 7027  'order_book_top'
+00011f90: 2c20 3129 0a20 2020 2020 2020 2020 2020  , 1).           
+00011fa0: 2069 6620 6f72 6465 725f 626f 6f6b 2069   if order_book i
+00011fb0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00011fc0: 2020 2020 2020 2020 6f72 6465 725f 626f          order_bo
+00011fd0: 6f6b 203d 2073 656c 662e 6665 7463 685f  ok = self.fetch_
+00011fe0: 6c32 5f6f 7264 6572 5f62 6f6f 6b28 7061  l2_order_book(pa
+00011ff0: 6972 2c20 6f72 6465 725f 626f 6f6b 5f74  ir, order_book_t
+00012000: 6f70 290a 2020 2020 2020 2020 2020 2020  op).            
+00012010: 6c6f 6767 6572 2e64 6562 7567 2827 6f72  logger.debug('or
+00012020: 6465 725f 626f 6f6b 2025 7327 2c20 6f72  der_book %s', or
+00012030: 6465 725f 626f 6f6b 290a 2020 2020 2020  der_book).      
+00012040: 2020 2020 2020 2320 746f 7020 3120 3d20        # top 1 = 
+00012050: 696e 6465 7820 300a 2020 2020 2020 2020  index 0.        
+00012060: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00012070: 2020 2020 2020 2020 206f 6273 6964 653a           obside:
+00012080: 204f 424c 6974 6572 616c 203d 2027 6269   OBLiteral = 'bi
+00012090: 6473 2720 6966 2070 7269 6365 5f73 6964  ds' if price_sid
+000120a0: 6520 3d3d 2027 6269 6427 2065 6c73 6520  e == 'bid' else 
+000120b0: 2761 736b 7327 0a20 2020 2020 2020 2020  'asks'.         
+000120c0: 2020 2020 2020 2072 6174 6520 3d20 6f72         rate = or
+000120d0: 6465 725f 626f 6f6b 5b6f 6273 6964 655d  der_book[obside]
+000120e0: 5b6f 7264 6572 5f62 6f6f 6b5f 746f 7020  [order_book_top 
+000120f0: 2d20 315d 5b30 5d0a 2020 2020 2020 2020  - 1][0].        
+00012100: 2020 2020 6578 6365 7074 2028 496e 6465      except (Inde
+00012110: 7845 7272 6f72 2c20 4b65 7945 7272 6f72  xError, KeyError
+00012120: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
+00012130: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
+00012140: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
+00012150: 2020 2020 2020 2020 2020 2020 6622 7b70              f"{p
+00012160: 6169 727d 202d 207b 6e61 6d65 7d20 5072  air} - {name} Pr
+00012170: 6963 6520 6174 206c 6f63 6174 696f 6e20  ice at location 
+00012180: 7b6f 7264 6572 5f62 6f6f 6b5f 746f 707d  {order_book_top}
+00012190: 2066 726f 6d20 6f72 6465 7262 6f6f 6b20   from orderbook 
+000121a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000121b0: 2020 2020 2020 6622 636f 756c 6420 6e6f        f"could no
+000121c0: 7420 6265 2064 6574 6572 6d69 6e65 642e  t be determined.
+000121d0: 204f 7264 6572 626f 6f6b 3a20 7b6f 7264   Orderbook: {ord
+000121e0: 6572 5f62 6f6f 6b7d 220a 2020 2020 2020  er_book}".      
+000121f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00012200: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00012210: 6520 5072 6963 696e 6745 7272 6f72 2066  e PricingError f
+00012220: 726f 6d20 650a 2020 2020 2020 2020 2020  rom e.          
+00012230: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
+00012240: 227b 7061 6972 7d20 2d20 7b6e 616d 657d  "{pair} - {name}
+00012250: 2070 7269 6365 2066 726f 6d20 6f72 6465   price from orde
+00012260: 7262 6f6f 6b20 7b70 7269 6365 5f73 6964  rbook {price_sid
+00012270: 655f 776f 7264 7d22 0a20 2020 2020 2020  e_word}".       
+00012280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012290: 2020 6622 7369 6465 202d 2074 6f70 207b    f"side - top {
+000122a0: 6f72 6465 725f 626f 6f6b 5f74 6f70 7d20  order_book_top} 
+000122b0: 6f72 6465 7220 626f 6f6b 207b 7369 6465  order book {side
+000122c0: 7d20 7261 7465 207b 7261 7465 3a2e 3866  } rate {rate:.8f
+000122d0: 7d22 290a 2020 2020 2020 2020 656c 7365  }").        else
+000122e0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+000122f0: 6767 6572 2e64 6562 7567 2866 2255 7369  gger.debug(f"Usi
+00012300: 6e67 204c 6173 7420 7b70 7269 6365 5f73  ng Last {price_s
+00012310: 6964 655f 776f 7264 7d20 2f20 4c61 7374  ide_word} / Last
+00012320: 2050 7269 6365 2229 0a20 2020 2020 2020   Price").       
+00012330: 2020 2020 2069 6620 7469 636b 6572 2069       if ticker i
+00012340: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00012350: 2020 2020 2020 2020 7469 636b 6572 203d          ticker =
+00012360: 2073 656c 662e 6665 7463 685f 7469 636b   self.fetch_tick
+00012370: 6572 2870 6169 7229 0a20 2020 2020 2020  er(pair).       
+00012380: 2020 2020 2074 6963 6b65 725f 7261 7465       ticker_rate
+00012390: 203d 2074 6963 6b65 725b 7072 6963 655f   = ticker[price_
+000123a0: 7369 6465 5d0a 2020 2020 2020 2020 2020  side].          
+000123b0: 2020 6966 2074 6963 6b65 725b 276c 6173    if ticker['las
+000123c0: 7427 5d20 616e 6420 7469 636b 6572 5f72  t'] and ticker_r
+000123d0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+000123e0: 2020 2020 2069 6620 7369 6465 203d 3d20       if side == 
+000123f0: 2765 6e74 7279 2720 616e 6420 7469 636b  'entry' and tick
+00012400: 6572 5f72 6174 6520 3e20 7469 636b 6572  er_rate > ticker
+00012410: 5b27 6c61 7374 275d 3a0a 2020 2020 2020  ['last']:.      
+00012420: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+00012430: 6c61 6e63 6520 3d20 636f 6e66 5f73 7472  lance = conf_str
+00012440: 6174 6567 792e 6765 7428 2770 7269 6365  ategy.get('price
+00012450: 5f6c 6173 745f 6261 6c61 6e63 6527 2c20  _last_balance', 
+00012460: 302e 3029 0a20 2020 2020 2020 2020 2020  0.0).           
+00012470: 2020 2020 2020 2020 2074 6963 6b65 725f           ticker_
+00012480: 7261 7465 203d 2074 6963 6b65 725f 7261  rate = ticker_ra
+00012490: 7465 202b 2062 616c 616e 6365 202a 2028  te + balance * (
+000124a0: 7469 636b 6572 5b27 6c61 7374 275d 202d  ticker['last'] -
+000124b0: 2074 6963 6b65 725f 7261 7465 290a 2020   ticker_rate).  
+000124c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000124d0: 6966 2073 6964 6520 3d3d 2027 6578 6974  if side == 'exit
+000124e0: 2720 616e 6420 7469 636b 6572 5f72 6174  ' and ticker_rat
+000124f0: 6520 3c20 7469 636b 6572 5b27 6c61 7374  e < ticker['last
+00012500: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
+00012510: 2020 2020 2020 2020 6261 6c61 6e63 6520          balance 
+00012520: 3d20 636f 6e66 5f73 7472 6174 6567 792e  = conf_strategy.
+00012530: 6765 7428 2770 7269 6365 5f6c 6173 745f  get('price_last_
+00012540: 6261 6c61 6e63 6527 2c20 302e 3029 0a20  balance', 0.0). 
+00012550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012560: 2020 2074 6963 6b65 725f 7261 7465 203d     ticker_rate =
+00012570: 2074 6963 6b65 725f 7261 7465 202d 2062   ticker_rate - b
+00012580: 616c 616e 6365 202a 2028 7469 636b 6572  alance * (ticker
+00012590: 5f72 6174 6520 2d20 7469 636b 6572 5b27  _rate - ticker['
+000125a0: 6c61 7374 275d 290a 2020 2020 2020 2020  last']).        
+000125b0: 2020 2020 7261 7465 203d 2074 6963 6b65      rate = ticke
+000125c0: 725f 7261 7465 0a0a 2020 2020 2020 2020  r_rate..        
+000125d0: 6966 2072 6174 6520 6973 204e 6f6e 653a  if rate is None:
+000125e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000125f0: 7365 2050 7269 6369 6e67 4572 726f 7228  se PricingError(
+00012600: 6622 7b6e 616d 657d 2d52 6174 6520 666f  f"{name}-Rate fo
+00012610: 7220 7b70 6169 727d 2077 6173 2065 6d70  r {pair} was emp
+00012620: 7479 2e22 290a 2020 2020 2020 2020 7769  ty.").        wi
+00012630: 7468 2073 656c 662e 5f63 6163 6865 5f6c  th self._cache_l
+00012640: 6f63 6b3a 0a20 2020 2020 2020 2020 2020  ock:.           
+00012650: 2063 6163 6865 5f72 6174 655b 7061 6972   cache_rate[pair
+00012660: 5d20 3d20 7261 7465 0a0a 2020 2020 2020  ] = rate..      
+00012670: 2020 7265 7475 726e 2072 6174 650a 0a20    return rate.. 
+00012680: 2020 2064 6566 2067 6574 5f72 6174 6573     def get_rates
+00012690: 2873 656c 662c 2070 6169 723a 2073 7472  (self, pair: str
+000126a0: 2c20 7265 6672 6573 683a 2062 6f6f 6c2c  , refresh: bool,
+000126b0: 2069 735f 7368 6f72 743a 2062 6f6f 6c29   is_short: bool)
+000126c0: 202d 3e20 5475 706c 655b 666c 6f61 742c   -> Tuple[float,
+000126d0: 2066 6c6f 6174 5d3a 0a20 2020 2020 2020   float]:.       
+000126e0: 2065 6e74 7279 5f72 6174 6520 3d20 4e6f   entry_rate = No
+000126f0: 6e65 0a20 2020 2020 2020 2065 7869 745f  ne.        exit_
+00012700: 7261 7465 203d 204e 6f6e 650a 2020 2020  rate = None.    
+00012710: 2020 2020 6966 206e 6f74 2072 6566 7265      if not refre
+00012720: 7368 3a0a 2020 2020 2020 2020 2020 2020  sh:.            
+00012730: 7769 7468 2073 656c 662e 5f63 6163 6865  with self._cache
+00012740: 5f6c 6f63 6b3a 0a20 2020 2020 2020 2020  _lock:.         
+00012750: 2020 2020 2020 2065 6e74 7279 5f72 6174         entry_rat
+00012760: 6520 3d20 7365 6c66 2e5f 656e 7472 795f  e = self._entry_
+00012770: 7261 7465 5f63 6163 6865 2e67 6574 2870  rate_cache.get(p
+00012780: 6169 7229 0a20 2020 2020 2020 2020 2020  air).           
+00012790: 2020 2020 2065 7869 745f 7261 7465 203d       exit_rate =
+000127a0: 2073 656c 662e 5f65 7869 745f 7261 7465   self._exit_rate
+000127b0: 5f63 6163 6865 2e67 6574 2870 6169 7229  _cache.get(pair)
+000127c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000127d0: 656e 7472 795f 7261 7465 3a0a 2020 2020  entry_rate:.    
+000127e0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+000127f0: 6572 2e64 6562 7567 2866 2255 7369 6e67  er.debug(f"Using
+00012800: 2063 6163 6865 6420 6275 7920 7261 7465   cached buy rate
+00012810: 2066 6f72 207b 7061 6972 7d2e 2229 0a20   for {pair}."). 
+00012820: 2020 2020 2020 2020 2020 2069 6620 6578             if ex
+00012830: 6974 5f72 6174 653a 0a20 2020 2020 2020  it_rate:.       
+00012840: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00012850: 6465 6275 6728 6622 5573 696e 6720 6361  debug(f"Using ca
+00012860: 6368 6564 2073 656c 6c20 7261 7465 2066  ched sell rate f
+00012870: 6f72 207b 7061 6972 7d2e 2229 0a0a 2020  or {pair}.")..  
+00012880: 2020 2020 2020 656e 7472 795f 7072 6963        entry_pric
+00012890: 696e 6720 3d20 7365 6c66 2e5f 636f 6e66  ing = self._conf
+000128a0: 6967 2e67 6574 2827 656e 7472 795f 7072  ig.get('entry_pr
+000128b0: 6963 696e 6727 2c20 7b7d 290a 2020 2020  icing', {}).    
+000128c0: 2020 2020 6578 6974 5f70 7269 6369 6e67      exit_pricing
+000128d0: 203d 2073 656c 662e 5f63 6f6e 6669 672e   = self._config.
+000128e0: 6765 7428 2765 7869 745f 7072 6963 696e  get('exit_pricin
+000128f0: 6727 2c20 7b7d 290a 2020 2020 2020 2020  g', {}).        
+00012900: 6f72 6465 725f 626f 6f6b 203d 2074 6963  order_book = tic
+00012910: 6b65 7220 3d20 4e6f 6e65 0a20 2020 2020  ker = None.     
+00012920: 2020 2069 6620 6e6f 7420 656e 7472 795f     if not entry_
+00012930: 7261 7465 2061 6e64 2065 6e74 7279 5f70  rate and entry_p
+00012940: 7269 6369 6e67 2e67 6574 2827 7573 655f  ricing.get('use_
+00012950: 6f72 6465 725f 626f 6f6b 272c 2046 616c  order_book', Fal
+00012960: 7365 293a 0a20 2020 2020 2020 2020 2020  se):.           
+00012970: 206f 7264 6572 5f62 6f6f 6b5f 746f 7020   order_book_top 
+00012980: 3d20 6d61 7828 656e 7472 795f 7072 6963  = max(entry_pric
+00012990: 696e 672e 6765 7428 276f 7264 6572 5f62  ing.get('order_b
+000129a0: 6f6f 6b5f 746f 7027 2c20 3129 2c0a 2020  ook_top', 1),.  
+000129b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000129d0: 7869 745f 7072 6963 696e 672e 6765 7428  xit_pricing.get(
+000129e0: 276f 7264 6572 5f62 6f6f 6b5f 746f 7027  'order_book_top'
+000129f0: 2c20 3129 290a 2020 2020 2020 2020 2020  , 1)).          
+00012a00: 2020 6f72 6465 725f 626f 6f6b 203d 2073    order_book = s
+00012a10: 656c 662e 6665 7463 685f 6c32 5f6f 7264  elf.fetch_l2_ord
+00012a20: 6572 5f62 6f6f 6b28 7061 6972 2c20 6f72  er_book(pair, or
+00012a30: 6465 725f 626f 6f6b 5f74 6f70 290a 2020  der_book_top).  
+00012a40: 2020 2020 2020 2020 2020 656e 7472 795f            entry_
+00012a50: 7261 7465 203d 2073 656c 662e 6765 745f  rate = self.get_
+00012a60: 7261 7465 2870 6169 722c 2072 6566 7265  rate(pair, refre
+00012a70: 7368 2c20 2765 6e74 7279 272c 2069 735f  sh, 'entry', is_
+00012a80: 7368 6f72 742c 206f 7264 6572 5f62 6f6f  short, order_boo
+00012a90: 6b3d 6f72 6465 725f 626f 6f6b 290a 2020  k=order_book).  
+00012aa0: 2020 2020 2020 656c 6966 206e 6f74 2065        elif not e
+00012ab0: 6e74 7279 5f72 6174 653a 0a20 2020 2020  ntry_rate:.     
+00012ac0: 2020 2020 2020 2074 6963 6b65 7220 3d20         ticker = 
+00012ad0: 7365 6c66 2e66 6574 6368 5f74 6963 6b65  self.fetch_ticke
+00012ae0: 7228 7061 6972 290a 2020 2020 2020 2020  r(pair).        
+00012af0: 2020 2020 656e 7472 795f 7261 7465 203d      entry_rate =
+00012b00: 2073 656c 662e 6765 745f 7261 7465 2870   self.get_rate(p
+00012b10: 6169 722c 2072 6566 7265 7368 2c20 2765  air, refresh, 'e
+00012b20: 6e74 7279 272c 2069 735f 7368 6f72 742c  ntry', is_short,
+00012b30: 2074 6963 6b65 723d 7469 636b 6572 290a   ticker=ticker).
+00012b40: 2020 2020 2020 2020 6966 206e 6f74 2065          if not e
+00012b50: 7869 745f 7261 7465 3a0a 2020 2020 2020  xit_rate:.      
+00012b60: 2020 2020 2020 6578 6974 5f72 6174 6520        exit_rate 
+00012b70: 3d20 7365 6c66 2e67 6574 5f72 6174 6528  = self.get_rate(
+00012b80: 7061 6972 2c20 7265 6672 6573 682c 2027  pair, refresh, '
+00012b90: 6578 6974 272c 0a20 2020 2020 2020 2020  exit',.         
+00012ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012bb0: 2020 2020 2020 2020 2020 2020 2069 735f               is_
+00012bc0: 7368 6f72 742c 206f 7264 6572 5f62 6f6f  short, order_boo
+00012bd0: 6b3d 6f72 6465 725f 626f 6f6b 2c20 7469  k=order_book, ti
+00012be0: 636b 6572 3d74 6963 6b65 7229 0a20 2020  cker=ticker).   
+00012bf0: 2020 2020 2072 6574 7572 6e20 656e 7472       return entr
+00012c00: 795f 7261 7465 2c20 6578 6974 5f72 6174  y_rate, exit_rat
+00012c10: 650a 0a20 2020 2023 2046 6565 2068 616e  e..    # Fee han
+00012c20: 646c 696e 670a 0a20 2020 2040 7265 7472  dling..    @retr
+00012c30: 6965 720a 2020 2020 6465 6620 6765 745f  ier.    def get_
+00012c40: 7472 6164 6573 5f66 6f72 5f6f 7264 6572  trades_for_order
+00012c50: 2873 656c 662c 206f 7264 6572 5f69 643a  (self, order_id:
+00012c60: 2073 7472 2c20 7061 6972 3a20 7374 722c   str, pair: str,
+00012c70: 2073 696e 6365 3a20 6461 7465 7469 6d65   since: datetime
+00012c80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012c90: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00012ca0: 6172 616d 733a 204f 7074 696f 6e61 6c5b  arams: Optional[
+00012cb0: 4469 6374 5d20 3d20 4e6f 6e65 2920 2d3e  Dict] = None) ->
+00012cc0: 204c 6973 743a 0a20 2020 2020 2020 2022   List:.        "
+00012cd0: 2222 0a20 2020 2020 2020 2046 6574 6368  "".        Fetch
+00012ce0: 204f 7264 6572 7320 7573 696e 6720 7468   Orders using th
+00012cf0: 6520 2266 6574 6368 5f6d 795f 7472 6164  e "fetch_my_trad
+00012d00: 6573 2220 656e 6470 6f69 6e74 2061 6e64  es" endpoint and
+00012d10: 2066 696c 7465 7220 7468 656d 2062 7920   filter them by 
+00012d20: 6f72 6465 722d 6964 2e0a 2020 2020 2020  order-id..      
+00012d30: 2020 5468 6520 2273 696e 6365 2220 6172    The "since" ar
+00012d40: 6775 6d65 6e74 2070 6173 7365 6420 696e  gument passed in
+00012d50: 2069 7320 636f 6d69 6e67 2066 726f 6d20   is coming from 
+00012d60: 7468 6520 6461 7461 6261 7365 2061 6e64  the database and
+00012d70: 2069 7320 696e 2055 5443 2c0a 2020 2020   is in UTC,.    
+00012d80: 2020 2020 6173 2074 696d 657a 6f6e 652d      as timezone-
+00012d90: 6e61 7469 7665 2064 6174 6574 696d 6520  native datetime 
+00012da0: 6f62 6a65 6374 2e0a 2020 2020 2020 2020  object..        
+00012db0: 4672 6f6d 2074 6865 2070 7974 686f 6e20  From the python 
+00012dc0: 646f 6375 6d65 6e74 6174 696f 6e3a 0a20  documentation:. 
+00012dd0: 2020 2020 2020 2020 2020 203e 204e 6169             > Nai
+00012de0: 7665 2064 6174 6574 696d 6520 696e 7374  ve datetime inst
+00012df0: 616e 6365 7320 6172 6520 6173 7375 6d65  ances are assume
+00012e00: 6420 746f 2072 6570 7265 7365 6e74 206c  d to represent l
+00012e10: 6f63 616c 2074 696d 650a 2020 2020 2020  ocal time.      
+00012e20: 2020 5468 6572 6566 6f72 652c 2063 616c    Therefore, cal
+00012e30: 6c69 6e67 2022 7369 6e63 652e 7469 6d65  ling "since.time
+00012e40: 7374 616d 7028 2922 2077 696c 6c20 6765  stamp()" will ge
+00012e50: 7420 7468 6520 5554 4320 7469 6d65 7374  t the UTC timest
+00012e60: 616d 702c 2061 6674 6572 2061 7070 6c79  amp, after apply
+00012e70: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
+00012e80: 7472 616e 7366 6f72 6d61 7469 6f6e 2066  transformation f
+00012e90: 726f 6d20 6c6f 6361 6c20 7469 6d65 7a6f  rom local timezo
+00012ea0: 6e65 2074 6f20 5554 432e 0a20 2020 2020  ne to UTC..     
+00012eb0: 2020 2054 6869 7320 776f 726b 7320 666f     This works fo
+00012ec0: 7220 7469 6d65 7a6f 6e65 7320 5554 432b  r timezones UTC+
+00012ed0: 2073 696e 6365 2074 6865 6e20 7468 6520   since then the 
+00012ee0: 7265 7375 6c74 2077 696c 6c20 636f 6e74  result will cont
+00012ef0: 6169 6e20 7472 6164 6573 2066 726f 6d20  ain trades from 
+00012f00: 6120 6665 7720 686f 7572 730a 2020 2020  a few hours.    
+00012f10: 2020 2020 696e 7374 6561 6420 6f66 2066      instead of f
+00012f20: 726f 6d20 7468 6520 6c61 7374 2035 2073  rom the last 5 s
+00012f30: 6563 6f6e 6473 2c20 686f 7765 7665 7220  econds, however 
+00012f40: 6661 696c 7320 666f 7220 5554 432d 2074  fails for UTC- t
+00012f50: 696d 657a 6f6e 6573 2c0a 2020 2020 2020  imezones,.      
+00012f60: 2020 7369 6e63 6520 7765 2772 6520 7468    since we're th
+00012f70: 656e 2061 736b 696e 6720 666f 7220 7472  en asking for tr
+00012f80: 6164 6573 2077 6974 6820 6120 2273 696e  ades with a "sin
+00012f90: 6365 2220 6172 6775 6d65 6e74 2069 6e20  ce" argument in 
+00012fa0: 7468 6520 6675 7475 7265 2e0a 0a20 2020  the future...   
+00012fb0: 2020 2020 203a 7061 7261 6d20 6f72 6465       :param orde
+00012fc0: 725f 6964 206f 7264 6572 5f69 643a 204f  r_id order_id: O
+00012fd0: 7264 6572 2d69 6420 6173 2067 6976 656e  rder-id as given
+00012fe0: 2077 6865 6e20 6372 6561 7469 6e67 2074   when creating t
+00012ff0: 6865 206f 7264 6572 0a20 2020 2020 2020  he order.       
+00013000: 203a 7061 7261 6d20 7061 6972 3a20 5061   :param pair: Pa
+00013010: 6972 2074 6865 206f 7264 6572 2069 7320  ir the order is 
+00013020: 666f 720a 2020 2020 2020 2020 3a70 6172  for.        :par
+00013030: 616d 2073 696e 6365 3a20 6461 7465 7469  am since: dateti
+00013040: 6d65 206f 626a 6563 7420 6f66 2074 6865  me object of the
+00013050: 206f 7264 6572 2063 7265 6174 696f 6e20   order creation 
+00013060: 7469 6d65 2e20 4173 7375 6d65 7320 6f62  time. Assumes ob
+00013070: 6a65 6374 2069 7320 696e 2055 5443 2e0a  ject is in UTC..
+00013080: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00013090: 2020 2020 6966 2073 656c 662e 5f63 6f6e      if self._con
+000130a0: 6669 675b 2764 7279 5f72 756e 275d 3a0a  fig['dry_run']:.
+000130b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000130c0: 726e 205b 5d0a 2020 2020 2020 2020 6966  rn [].        if
+000130d0: 206e 6f74 2073 656c 662e 6578 6368 616e   not self.exchan
+000130e0: 6765 5f68 6173 2827 6665 7463 684d 7954  ge_has('fetchMyT
+000130f0: 7261 6465 7327 293a 0a20 2020 2020 2020  rades'):.       
+00013100: 2020 2020 2072 6574 7572 6e20 5b5d 0a20       return []. 
+00013110: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00013120: 2020 2020 2020 2020 2320 416c 6c6f 7720          # Allow 
+00013130: 3573 206f 6666 7365 7420 746f 2063 6174  5s offset to cat
+00013140: 6368 2073 6c69 6768 7420 7469 6d65 206f  ch slight time o
+00013150: 6666 7365 7473 2028 6469 7363 6f76 6572  ffsets (discover
+00013160: 6564 2069 6e20 2331 3138 3529 0a20 2020  ed in #1185).   
+00013170: 2020 2020 2020 2020 2023 2073 696e 6365           # since
+00013180: 206e 6565 6473 2074 6f20 6265 2069 6e74   needs to be int
+00013190: 2069 6e20 6d69 6c6c 6973 6563 6f6e 6473   in milliseconds
+000131a0: 0a20 2020 2020 2020 2020 2020 205f 7061  .            _pa
+000131b0: 7261 6d73 203d 2070 6172 616d 7320 6966  rams = params if
+000131c0: 2070 6172 616d 7320 656c 7365 207b 7d0a   params else {}.
+000131d0: 2020 2020 2020 2020 2020 2020 6d79 5f74              my_t
+000131e0: 7261 6465 7320 3d20 7365 6c66 2e5f 6170  rades = self._ap
+000131f0: 692e 6665 7463 685f 6d79 5f74 7261 6465  i.fetch_my_trade
+00013200: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+00013210: 2020 2070 6169 722c 2069 6e74 2828 7369     pair, int((si
+00013220: 6e63 652e 7265 706c 6163 6528 747a 696e  nce.replace(tzin
+00013230: 666f 3d74 696d 657a 6f6e 652e 7574 6329  fo=timezone.utc)
+00013240: 2e74 696d 6573 7461 6d70 2829 202d 2035  .timestamp() - 5
+00013250: 2920 2a20 3130 3030 292c 0a20 2020 2020  ) * 1000),.     
+00013260: 2020 2020 2020 2020 2020 2070 6172 616d             param
+00013270: 733d 5f70 6172 616d 7329 0a20 2020 2020  s=_params).     
+00013280: 2020 2020 2020 206d 6174 6368 6564 5f74         matched_t
+00013290: 7261 6465 7320 3d20 5b74 7261 6465 2066  rades = [trade f
+000132a0: 6f72 2074 7261 6465 2069 6e20 6d79 5f74  or trade in my_t
+000132b0: 7261 6465 7320 6966 2074 7261 6465 5b27  rades if trade['
+000132c0: 6f72 6465 7227 5d20 3d3d 206f 7264 6572  order'] == order
+000132d0: 5f69 645d 0a0a 2020 2020 2020 2020 2020  _id]..          
+000132e0: 2020 7365 6c66 2e5f 6c6f 675f 6578 6368    self._log_exch
+000132f0: 616e 6765 5f72 6573 706f 6e73 6528 2767  ange_response('g
+00013300: 6574 5f74 7261 6465 735f 666f 725f 6f72  et_trades_for_or
+00013310: 6465 7227 2c20 6d61 7463 6865 645f 7472  der', matched_tr
+00013320: 6164 6573 290a 0a20 2020 2020 2020 2020  ades)..         
+00013330: 2020 206d 6174 6368 6564 5f74 7261 6465     matched_trade
+00013340: 7320 3d20 7365 6c66 2e5f 7472 6164 6573  s = self._trades
+00013350: 5f63 6f6e 7472 6163 7473 5f74 6f5f 616d  _contracts_to_am
+00013360: 6f75 6e74 286d 6174 6368 6564 5f74 7261  ount(matched_tra
+00013370: 6465 7329 0a0a 2020 2020 2020 2020 2020  des)..          
+00013380: 2020 7265 7475 726e 206d 6174 6368 6564    return matched
+00013390: 5f74 7261 6465 730a 2020 2020 2020 2020  _trades.        
+000133a0: 6578 6365 7074 2063 6378 742e 4444 6f53  except ccxt.DDoS
+000133b0: 5072 6f74 6563 7469 6f6e 2061 7320 653a  Protection as e:
+000133c0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000133d0: 7365 2044 446f 7350 726f 7465 6374 696f  se DDosProtectio
+000133e0: 6e28 6529 2066 726f 6d20 650a 2020 2020  n(e) from e.    
+000133f0: 2020 2020 6578 6365 7074 2028 6363 7874      except (ccxt
+00013400: 2e4e 6574 776f 726b 4572 726f 722c 2063  .NetworkError, c
+00013410: 6378 742e 4578 6368 616e 6765 4572 726f  cxt.ExchangeErro
+00013420: 7229 2061 7320 653a 0a20 2020 2020 2020  r) as e:.       
+00013430: 2020 2020 2072 6169 7365 2054 656d 706f       raise Tempo
+00013440: 7261 7279 4572 726f 7228 0a20 2020 2020  raryError(.     
+00013450: 2020 2020 2020 2020 2020 2066 2743 6f75             f'Cou
+00013460: 6c64 206e 6f74 2067 6574 2074 7261 6465  ld not get trade
+00013470: 7320 6475 6520 746f 207b 652e 5f5f 636c  s due to {e.__cl
+00013480: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d2e  ass__.__name__}.
+00013490: 204d 6573 7361 6765 3a20 7b65 7d27 2920   Message: {e}') 
+000134a0: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
+000134b0: 7863 6570 7420 6363 7874 2e42 6173 6545  xcept ccxt.BaseE
+000134c0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+000134d0: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
+000134e0: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
+000134f0: 6e28 6529 2066 726f 6d20 650a 0a20 2020  n(e) from e..   
+00013500: 2064 6566 2067 6574 5f6f 7264 6572 5f69   def get_order_i
+00013510: 645f 636f 6e64 6974 696f 6e61 6c28 7365  d_conditional(se
+00013520: 6c66 2c20 6f72 6465 723a 2044 6963 745b  lf, order: Dict[
+00013530: 7374 722c 2041 6e79 5d29 202d 3e20 7374  str, Any]) -> st
+00013540: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
+00013550: 6e20 6f72 6465 725b 2769 6427 5d0a 0a20  n order['id'].. 
+00013560: 2020 2040 7265 7472 6965 720a 2020 2020     @retrier.    
+00013570: 6465 6620 6765 745f 6665 6528 7365 6c66  def get_fee(self
+00013580: 2c20 7379 6d62 6f6c 3a20 7374 722c 2074  , symbol: str, t
+00013590: 7970 653a 2073 7472 203d 2027 272c 2073  ype: str = '', s
+000135a0: 6964 653a 2073 7472 203d 2027 272c 2061  ide: str = '', a
+000135b0: 6d6f 756e 743a 2066 6c6f 6174 203d 2031  mount: float = 1
+000135c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000135d0: 2020 7072 6963 653a 2066 6c6f 6174 203d    price: float =
+000135e0: 2031 2c20 7461 6b65 725f 6f72 5f6d 616b   1, taker_or_mak
+000135f0: 6572 3a20 4d61 6b65 7254 616b 6572 203d  er: MakerTaker =
+00013600: 2027 6d61 6b65 7227 2920 2d3e 2066 6c6f   'maker') -> flo
+00013610: 6174 3a0a 2020 2020 2020 2020 2222 220a  at:.        """.
+00013620: 2020 2020 2020 2020 5265 7472 6965 7665          Retrieve
+00013630: 2066 6565 2066 726f 6d20 6578 6368 616e   fee from exchan
+00013640: 6765 0a20 2020 2020 2020 203a 7061 7261  ge.        :para
+00013650: 6d20 7379 6d62 6f6c 3a20 5061 6972 0a20  m symbol: Pair. 
+00013660: 2020 2020 2020 203a 7061 7261 6d20 7479         :param ty
+00013670: 7065 3a20 5479 7065 206f 6620 6f72 6465  pe: Type of orde
+00013680: 7220 286d 6172 6b65 742c 206c 696d 6974  r (market, limit
+00013690: 2c20 2e2e 2e29 0a20 2020 2020 2020 203a  , ...).        :
+000136a0: 7061 7261 6d20 7369 6465 3a20 5369 6465  param side: Side
+000136b0: 206f 6620 6f72 6465 7220 2862 7579 2c20   of order (buy, 
+000136c0: 7365 6c6c 290a 2020 2020 2020 2020 3a70  sell).        :p
+000136d0: 6172 616d 2061 6d6f 756e 743a 2041 6d6f  aram amount: Amo
+000136e0: 756e 7420 6f66 206f 7264 6572 0a20 2020  unt of order.   
+000136f0: 2020 2020 203a 7061 7261 6d20 7072 6963       :param pric
+00013700: 653a 2050 7269 6365 206f 6620 6f72 6465  e: Price of orde
+00013710: 720a 2020 2020 2020 2020 3a70 6172 616d  r.        :param
+00013720: 2074 616b 6572 5f6f 725f 6d61 6b65 723a   taker_or_maker:
+00013730: 2027 6d61 6b65 7227 206f 7220 2774 616b   'maker' or 'tak
+00013740: 6572 2720 2869 676e 6f72 6564 2069 6620  er' (ignored if 
+00013750: 2274 7970 6522 2069 7320 7072 6f76 6964  "type" is provid
+00013760: 6564 290a 2020 2020 2020 2020 2222 220a  ed).        """.
+00013770: 2020 2020 2020 2020 6966 2074 7970 6520          if type 
+00013780: 616e 6420 7479 7065 203d 3d20 276d 6172  and type == 'mar
+00013790: 6b65 7427 3a0a 2020 2020 2020 2020 2020  ket':.          
+000137a0: 2020 7461 6b65 725f 6f72 5f6d 616b 6572    taker_or_maker
+000137b0: 203d 2027 7461 6b65 7227 0a20 2020 2020   = 'taker'.     
+000137c0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000137d0: 2020 2020 6966 2073 656c 662e 5f63 6f6e      if self._con
+000137e0: 6669 675b 2764 7279 5f72 756e 275d 2061  fig['dry_run'] a
+000137f0: 6e64 2073 656c 662e 5f63 6f6e 6669 672e  nd self._config.
+00013800: 6765 7428 2766 6565 272c 204e 6f6e 6529  get('fee', None)
+00013810: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00013820: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00013830: 7475 726e 2073 656c 662e 5f63 6f6e 6669  turn self._confi
+00013840: 675b 2766 6565 275d 0a20 2020 2020 2020  g['fee'].       
+00013850: 2020 2020 2023 2076 616c 6964 6174 6520       # validate 
+00013860: 7468 6174 206d 6172 6b65 7473 2061 7265  that markets are
+00013870: 206c 6f61 6465 6420 6265 666f 7265 2074   loaded before t
+00013880: 7279 696e 6720 746f 2067 6574 2066 6565  rying to get fee
+00013890: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000138a0: 7365 6c66 2e5f 6170 692e 6d61 726b 6574  self._api.market
+000138b0: 7320 6973 204e 6f6e 6520 6f72 206c 656e  s is None or len
+000138c0: 2873 656c 662e 5f61 7069 2e6d 6172 6b65  (self._api.marke
+000138d0: 7473 2920 3d3d 2030 3a0a 2020 2020 2020  ts) == 0:.      
+000138e0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000138f0: 6170 692e 6c6f 6164 5f6d 6172 6b65 7473  api.load_markets
+00013900: 2870 6172 616d 733d 7b7d 290a 0a20 2020  (params={})..   
+00013910: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00013920: 7365 6c66 2e5f 6170 692e 6361 6c63 756c  self._api.calcul
+00013930: 6174 655f 6665 6528 7379 6d62 6f6c 3d73  ate_fee(symbol=s
+00013940: 796d 626f 6c2c 2074 7970 653d 7479 7065  ymbol, type=type
+00013950: 2c20 7369 6465 3d73 6964 652c 2061 6d6f  , side=side, amo
+00013960: 756e 743d 616d 6f75 6e74 2c0a 2020 2020  unt=amount,.    
+00013970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013990: 2020 2020 2020 2070 7269 6365 3d70 7269         price=pri
+000139a0: 6365 2c20 7461 6b65 724f 724d 616b 6572  ce, takerOrMaker
+000139b0: 3d74 616b 6572 5f6f 725f 6d61 6b65 7229  =taker_or_maker)
+000139c0: 5b27 7261 7465 275d 0a20 2020 2020 2020  ['rate'].       
+000139d0: 2065 7863 6570 7420 6363 7874 2e44 446f   except ccxt.DDo
+000139e0: 5350 726f 7465 6374 696f 6e20 6173 2065  SProtection as e
+000139f0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00013a00: 6973 6520 4444 6f73 5072 6f74 6563 7469  ise DDosProtecti
+00013a10: 6f6e 2865 2920 6672 6f6d 2065 0a20 2020  on(e) from e.   
+00013a20: 2020 2020 2065 7863 6570 7420 2863 6378       except (ccx
+00013a30: 742e 4e65 7477 6f72 6b45 7272 6f72 2c20  t.NetworkError, 
+00013a40: 6363 7874 2e45 7863 6861 6e67 6545 7272  ccxt.ExchangeErr
+00013a50: 6f72 2920 6173 2065 3a0a 2020 2020 2020  or) as e:.      
+00013a60: 2020 2020 2020 7261 6973 6520 5465 6d70        raise Temp
+00013a70: 6f72 6172 7945 7272 6f72 280a 2020 2020  oraryError(.    
+00013a80: 2020 2020 2020 2020 2020 2020 6627 436f              f'Co
+00013a90: 756c 6420 6e6f 7420 6765 7420 6665 6520  uld not get fee 
+00013aa0: 696e 666f 2064 7565 2074 6f20 7b65 2e5f  info due to {e._
+00013ab0: 5f63 6c61 7373 5f5f 2e5f 5f6e 616d 655f  _class__.__name_
+00013ac0: 5f7d 2e20 4d65 7373 6167 653a 207b 657d  _}. Message: {e}
+00013ad0: 2729 2066 726f 6d20 650a 2020 2020 2020  ') from e.      
+00013ae0: 2020 6578 6365 7074 2063 6378 742e 4261    except ccxt.Ba
+00013af0: 7365 4572 726f 7220 6173 2065 3a0a 2020  seError as e:.  
+00013b00: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00013b10: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
+00013b20: 7469 6f6e 2865 2920 6672 6f6d 2065 0a0a  tion(e) from e..
+00013b30: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+00013b40: 640a 2020 2020 6465 6620 6f72 6465 725f  d.    def order_
+00013b50: 6861 735f 6665 6528 6f72 6465 723a 2044  has_fee(order: D
+00013b60: 6963 7429 202d 3e20 626f 6f6c 3a0a 2020  ict) -> bool:.  
+00013b70: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00013b80: 2020 5665 7269 6669 6573 2069 6620 7468    Verifies if th
+00013b90: 6520 7061 7373 6564 2069 6e20 6f72 6465  e passed in orde
+00013ba0: 7220 6469 6374 2068 6173 2074 6865 206e  r dict has the n
+00013bb0: 6565 6465 6420 6b65 7973 2074 6f20 6578  eeded keys to ex
+00013bc0: 7472 6163 7420 6665 6573 2c0a 2020 2020  tract fees,.    
+00013bd0: 2020 2020 616e 6420 7468 6174 2074 6865      and that the
+00013be0: 7365 206b 6579 7320 2863 7572 7265 6e63  se keys (currenc
+00013bf0: 792c 2063 6f73 7429 2061 7265 206e 6f74  y, cost) are not
+00013c00: 2065 6d70 7479 2e0a 2020 2020 2020 2020   empty..        
+00013c10: 3a70 6172 616d 206f 7264 6572 3a20 4f72  :param order: Or
+00013c20: 6465 7220 6f72 2074 7261 6465 2028 6f6e  der or trade (on
+00013c30: 6520 7472 6164 6529 2064 6963 740a 2020  e trade) dict.  
+00013c40: 2020 2020 2020 3a72 6574 7572 6e3a 2054        :return: T
+00013c50: 7275 6520 6966 2074 6865 2066 6565 2073  rue if the fee s
+00013c60: 7562 7374 7275 6374 7572 6520 636f 6e74  ubstructure cont
+00013c70: 6169 6e73 2063 7572 7265 6e63 7920 616e  ains currency an
+00013c80: 6420 636f 7374 2c20 6661 6c73 6520 6f74  d cost, false ot
+00013c90: 6865 7277 6973 650a 2020 2020 2020 2020  herwise.        
+00013ca0: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
+00013cb0: 6f74 2069 7369 6e73 7461 6e63 6528 6f72  ot isinstance(or
+00013cc0: 6465 722c 2064 6963 7429 3a0a 2020 2020  der, dict):.    
+00013cd0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+00013ce0: 616c 7365 0a20 2020 2020 2020 2072 6574  alse.        ret
+00013cf0: 7572 6e20 2827 6665 6527 2069 6e20 6f72  urn ('fee' in or
+00013d00: 6465 7220 616e 6420 6f72 6465 725b 2766  der and order['f
+00013d10: 6565 275d 2069 7320 6e6f 7420 4e6f 6e65  ee'] is not None
+00013d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013d30: 2061 6e64 2028 6f72 6465 725b 2766 6565   and (order['fee
+00013d40: 275d 2e6b 6579 7328 2920 3e3d 207b 2763  '].keys() >= {'c
+00013d50: 7572 7265 6e63 7927 2c20 2763 6f73 7427  urrency', 'cost'
+00013d60: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
+00013d70: 2020 2061 6e64 206f 7264 6572 5b27 6665     and order['fe
+00013d80: 6527 5d5b 2763 7572 7265 6e63 7927 5d20  e']['currency'] 
+00013d90: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00013da0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00013db0: 6f72 6465 725b 2766 6565 275d 5b27 636f  order['fee']['co
+00013dc0: 7374 275d 2069 7320 6e6f 7420 4e6f 6e65  st'] is not None
+00013dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013de0: 2029 0a0a 2020 2020 6465 6620 6361 6c63   )..    def calc
+00013df0: 756c 6174 655f 6665 655f 7261 7465 280a  ulate_fee_rate(.
+00013e00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00013e10: 2c20 6665 653a 2044 6963 742c 2073 796d  , fee: Dict, sym
+00013e20: 626f 6c3a 2073 7472 2c20 636f 7374 3a20  bol: str, cost: 
+00013e30: 666c 6f61 742c 2061 6d6f 756e 743a 2066  float, amount: f
+00013e40: 6c6f 6174 2920 2d3e 204f 7074 696f 6e61  loat) -> Optiona
+00013e50: 6c5b 666c 6f61 745d 3a0a 2020 2020 2020  l[float]:.      
+00013e60: 2020 2222 220a 2020 2020 2020 2020 4361    """.        Ca
+00013e70: 6c63 756c 6174 6520 6665 6520 7261 7465  lculate fee rate
+00013e80: 2069 6620 6974 2773 206e 6f74 2067 6976   if it's not giv
+00013e90: 656e 2062 7920 7468 6520 6578 6368 616e  en by the exchan
+00013ea0: 6765 2e0a 2020 2020 2020 2020 3a70 6172  ge..        :par
+00013eb0: 616d 2066 6565 3a20 6363 7874 2046 6565  am fee: ccxt Fee
+00013ec0: 2064 6963 7420 2d20 6d75 7374 2063 6f6e   dict - must con
+00013ed0: 7461 696e 2063 6f73 7420 2f20 6375 7272  tain cost / curr
+00013ee0: 656e 6379 202f 2072 6174 650a 2020 2020  ency / rate.    
+00013ef0: 2020 2020 3a70 6172 616d 2073 796d 626f      :param symbo
+00013f00: 6c3a 2053 796d 626f 6c20 6f66 2074 6865  l: Symbol of the
+00013f10: 206f 7264 6572 0a20 2020 2020 2020 203a   order.        :
+00013f20: 7061 7261 6d20 636f 7374 3a20 546f 7461  param cost: Tota
+00013f30: 6c20 636f 7374 206f 6620 7468 6520 6f72  l cost of the or
+00013f40: 6465 720a 2020 2020 2020 2020 3a70 6172  der.        :par
+00013f50: 616d 2061 6d6f 756e 743a 2041 6d6f 756e  am amount: Amoun
+00013f60: 7420 6f66 2074 6865 206f 7264 6572 0a20  t of the order. 
+00013f70: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00013f80: 2020 2069 6620 6665 652e 6765 7428 2772     if fee.get('r
+00013f90: 6174 6527 2920 6973 206e 6f74 204e 6f6e  ate') is not Non
+00013fa0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00013fb0: 6574 7572 6e20 6665 652e 6765 7428 2772  eturn fee.get('r
+00013fc0: 6174 6527 290a 2020 2020 2020 2020 6665  ate').        fe
+00013fd0: 655f 6375 7272 203d 2066 6565 2e67 6574  e_curr = fee.get
+00013fe0: 2827 6375 7272 656e 6379 2729 0a20 2020  ('currency').   
+00013ff0: 2020 2020 2069 6620 6665 655f 6375 7272       if fee_curr
+00014000: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00014010: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00014020: 650a 2020 2020 2020 2020 6665 655f 636f  e.        fee_co
+00014030: 7374 203d 2066 6c6f 6174 2866 6565 5b27  st = float(fee['
+00014040: 636f 7374 275d 290a 2020 2020 2020 2020  cost']).        
+00014050: 6966 2073 656c 662e 5f66 745f 6861 735b  if self._ft_has[
+00014060: 2766 6565 5f63 6f73 745f 696e 5f63 6f6e  'fee_cost_in_con
+00014070: 7472 6163 7473 275d 3a0a 2020 2020 2020  tracts']:.      
+00014080: 2020 2020 2020 2320 436f 6e76 6572 7420        # Convert 
+00014090: 636f 7374 2076 6961 2022 636f 6e74 7261  cost via "contra
+000140a0: 6374 7322 2063 6f6e 7665 7273 696f 6e0a  cts" conversion.
+000140b0: 2020 2020 2020 2020 2020 2020 6665 655f              fee_
+000140c0: 636f 7374 203d 2073 656c 662e 5f63 6f6e  cost = self._con
+000140d0: 7472 6163 7473 5f74 6f5f 616d 6f75 6e74  tracts_to_amount
+000140e0: 2873 796d 626f 6c2c 2066 6565 5b27 636f  (symbol, fee['co
+000140f0: 7374 275d 290a 0a20 2020 2020 2020 2023  st'])..        #
+00014100: 2043 616c 6375 6c61 7465 2066 6565 2062   Calculate fee b
+00014110: 6173 6564 206f 6e20 6f72 6465 7220 6465  ased on order de
+00014120: 7461 696c 730a 2020 2020 2020 2020 6966  tails.        if
+00014130: 2066 6565 5f63 7572 7220 3d3d 2073 656c   fee_curr == sel
+00014140: 662e 6765 745f 7061 6972 5f62 6173 655f  f.get_pair_base_
+00014150: 6375 7272 656e 6379 2873 796d 626f 6c29  currency(symbol)
+00014160: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00014170: 4261 7365 2063 7572 7265 6e63 7920 2d20  Base currency - 
+00014180: 6469 7669 6465 2062 7920 616d 6f75 6e74  divide by amount
+00014190: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000141a0: 7572 6e20 726f 756e 6428 6665 655f 636f  urn round(fee_co
+000141b0: 7374 202f 2061 6d6f 756e 742c 2038 290a  st / amount, 8).
+000141c0: 2020 2020 2020 2020 656c 6966 2066 6565          elif fee
+000141d0: 5f63 7572 7220 3d3d 2073 656c 662e 6765  _curr == self.ge
+000141e0: 745f 7061 6972 5f71 756f 7465 5f63 7572  t_pair_quote_cur
+000141f0: 7265 6e63 7928 7379 6d62 6f6c 293a 0a20  rency(symbol):. 
+00014200: 2020 2020 2020 2020 2020 2023 2051 756f             # Quo
+00014210: 7465 2063 7572 7265 6e63 7920 2d20 6469  te currency - di
+00014220: 7669 6465 2062 7920 636f 7374 0a20 2020  vide by cost.   
+00014230: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00014240: 726f 756e 6428 6665 655f 636f 7374 202f  round(fee_cost /
+00014250: 2063 6f73 742c 2038 2920 6966 2063 6f73   cost, 8) if cos
+00014260: 7420 656c 7365 204e 6f6e 650a 2020 2020  t else None.    
+00014270: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00014280: 2020 2020 2020 2320 4966 2046 6565 2063        # If Fee c
+00014290: 7572 7265 6e63 7920 6973 2061 2064 6966  urrency is a dif
+000142a0: 6665 7265 6e74 2063 7572 7265 6e63 790a  ferent currency.
+000142b0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000142c0: 6f74 2063 6f73 743a 0a20 2020 2020 2020  ot cost:.       
+000142d0: 2020 2020 2020 2020 2023 2049 6620 636f           # If co
+000142e0: 7374 2069 7320 4e6f 6e65 206f 7220 302e  st is None or 0.
+000142f0: 3020 2d3e 2066 616c 7379 2c20 7265 7475  0 -> falsy, retu
+00014300: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
+00014310: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+00014320: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00014330: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00014340: 2020 2020 2063 6f6d 6220 3d20 7365 6c66       comb = self
+00014350: 2e67 6574 5f76 616c 6964 5f70 6169 725f  .get_valid_pair_
+00014360: 636f 6d62 696e 6174 696f 6e28 6665 655f  combination(fee_
+00014370: 6375 7272 2c20 7365 6c66 2e5f 636f 6e66  curr, self._conf
+00014380: 6967 5b27 7374 616b 655f 6375 7272 656e  ig['stake_curren
+00014390: 6379 275d 290a 2020 2020 2020 2020 2020  cy']).          
+000143a0: 2020 2020 2020 7469 636b 203d 2073 656c        tick = sel
+000143b0: 662e 6665 7463 685f 7469 636b 6572 2863  f.fetch_ticker(c
+000143c0: 6f6d 6229 0a0a 2020 2020 2020 2020 2020  omb)..          
+000143d0: 2020 2020 2020 6665 655f 746f 5f71 756f        fee_to_quo
+000143e0: 7465 5f72 6174 6520 3d20 7361 6665 5f76  te_rate = safe_v
+000143f0: 616c 7565 5f66 616c 6c62 6163 6b32 2874  alue_fallback2(t
+00014400: 6963 6b2c 2074 6963 6b2c 2027 6c61 7374  ick, tick, 'last
+00014410: 272c 2027 6173 6b27 290a 2020 2020 2020  ', 'ask').      
+00014420: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00014430: 6861 6e67 6545 7272 6f72 3a0a 2020 2020  hangeError:.    
+00014440: 2020 2020 2020 2020 2020 2020 6665 655f              fee_
+00014450: 746f 5f71 756f 7465 5f72 6174 6520 3d20  to_quote_rate = 
+00014460: 7365 6c66 2e5f 636f 6e66 6967 5b27 6578  self._config['ex
+00014470: 6368 616e 6765 275d 2e67 6574 2827 756e  change'].get('un
+00014480: 6b6e 6f77 6e5f 6665 655f 7261 7465 272c  known_fee_rate',
+00014490: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
+000144a0: 2020 2020 2020 2069 6620 6e6f 7420 6665         if not fe
+000144b0: 655f 746f 5f71 756f 7465 5f72 6174 653a  e_to_quote_rate:
+000144c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000144d0: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+000144e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000144f0: 7572 6e20 726f 756e 6428 2866 6565 5f63  urn round((fee_c
+00014500: 6f73 7420 2a20 6665 655f 746f 5f71 756f  ost * fee_to_quo
+00014510: 7465 5f72 6174 6529 202f 2063 6f73 742c  te_rate) / cost,
+00014520: 2038 290a 0a20 2020 2064 6566 2065 7874   8)..    def ext
+00014530: 7261 6374 5f63 6f73 745f 6375 7272 5f72  ract_cost_curr_r
+00014540: 6174 6528 7365 6c66 2c20 6665 653a 2044  ate(self, fee: D
+00014550: 6963 742c 2073 796d 626f 6c3a 2073 7472  ict, symbol: str
+00014560: 2c20 636f 7374 3a20 666c 6f61 742c 0a20  , cost: float,. 
+00014570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014580: 2020 2020 2020 2020 2020 2020 2020 616d                am
+00014590: 6f75 6e74 3a20 666c 6f61 7429 202d 3e20  ount: float) -> 
+000145a0: 5475 706c 655b 666c 6f61 742c 2073 7472  Tuple[float, str
+000145b0: 2c20 4f70 7469 6f6e 616c 5b66 6c6f 6174  , Optional[float
+000145c0: 5d5d 3a0a 2020 2020 2020 2020 2222 220a  ]]:.        """.
+000145d0: 2020 2020 2020 2020 4578 7472 6163 7420          Extract 
+000145e0: 7475 706c 6520 6f66 2063 6f73 742c 2063  tuple of cost, c
+000145f0: 7572 7265 6e63 792c 2072 6174 652e 0a20  urrency, rate.. 
+00014600: 2020 2020 2020 2052 6571 7569 7265 7320         Requires 
+00014610: 6f72 6465 725f 6861 735f 6665 6520 746f  order_has_fee to
+00014620: 2072 756e 2066 6972 7374 210a 2020 2020   run first!.    
+00014630: 2020 2020 3a70 6172 616d 2066 6565 3a20      :param fee: 
+00014640: 6363 7874 2046 6565 2064 6963 7420 2d20  ccxt Fee dict - 
+00014650: 6d75 7374 2063 6f6e 7461 696e 2063 6f73  must contain cos
+00014660: 7420 2f20 6375 7272 656e 6379 202f 2072  t / currency / r
+00014670: 6174 650a 2020 2020 2020 2020 3a70 6172  ate.        :par
+00014680: 616d 2073 796d 626f 6c3a 2053 796d 626f  am symbol: Symbo
+00014690: 6c20 6f66 2074 6865 206f 7264 6572 0a20  l of the order. 
+000146a0: 2020 2020 2020 203a 7061 7261 6d20 636f         :param co
+000146b0: 7374 3a20 546f 7461 6c20 636f 7374 206f  st: Total cost o
+000146c0: 6620 7468 6520 6f72 6465 720a 2020 2020  f the order.    
+000146d0: 2020 2020 3a70 6172 616d 2061 6d6f 756e      :param amoun
+000146e0: 743a 2041 6d6f 756e 7420 6f66 2074 6865  t: Amount of the
+000146f0: 206f 7264 6572 0a20 2020 2020 2020 203a   order.        :
+00014700: 7265 7475 726e 3a20 5475 706c 6520 7769  return: Tuple wi
+00014710: 7468 2063 6f73 742c 2063 7572 7265 6e63  th cost, currenc
+00014720: 792c 2072 6174 6520 6f66 2074 6865 2067  y, rate of the g
+00014730: 6976 656e 2066 6565 2064 6963 740a 2020  iven fee dict.  
+00014740: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00014750: 2020 7265 7475 726e 2028 666c 6f61 7428    return (float(
+00014760: 6665 655b 2763 6f73 7427 5d29 2c0a 2020  fee['cost']),.  
+00014770: 2020 2020 2020 2020 2020 2020 2020 6665                fe
+00014780: 655b 2763 7572 7265 6e63 7927 5d2c 0a20  e['currency'],. 
+00014790: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000147a0: 656c 662e 6361 6c63 756c 6174 655f 6665  elf.calculate_fe
+000147b0: 655f 7261 7465 280a 2020 2020 2020 2020  e_rate(.        
+000147c0: 2020 2020 2020 2020 2020 2020 6665 652c              fee,
+000147d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000147e0: 2020 2020 2073 796d 626f 6c2c 0a20 2020       symbol,.   
+000147f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014800: 2063 6f73 742c 0a20 2020 2020 2020 2020   cost,.         
+00014810: 2020 2020 2020 2020 2020 2061 6d6f 756e             amoun
+00014820: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00014830: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00014840: 2020 2020 2020 2020 290a 0a20 2020 2023          )..    #
+00014850: 2048 6973 746f 7269 6320 6461 7461 0a0a   Historic data..
+00014860: 2020 2020 6465 6620 6765 745f 6869 7374      def get_hist
+00014870: 6f72 6963 5f6f 686c 6376 2873 656c 662c  oric_ohlcv(self,
+00014880: 2070 6169 723a 2073 7472 2c20 7469 6d65   pair: str, time
+00014890: 6672 616d 653a 2073 7472 2c0a 2020 2020  frame: str,.    
+000148a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148b0: 2020 2020 2020 2073 696e 6365 5f6d 733a         since_ms:
+000148c0: 2069 6e74 2c20 6361 6e64 6c65 5f74 7970   int, candle_typ
+000148d0: 653a 2043 616e 646c 6554 7970 652c 0a20  e: CandleType,. 
+000148e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148f0: 2020 2020 2020 2020 2020 6973 5f6e 6577            is_new
+00014900: 5f70 6169 723a 2062 6f6f 6c20 3d20 4661  _pair: bool = Fa
+00014910: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+00014920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014930: 756e 7469 6c5f 6d73 3a20 4f70 7469 6f6e  until_ms: Option
+00014940: 616c 5b69 6e74 5d20 3d20 4e6f 6e65 2920  al[int] = None) 
+00014950: 2d3e 204c 6973 743a 0a20 2020 2020 2020  -> List:.       
+00014960: 2022 2222 0a20 2020 2020 2020 2047 6574   """.        Get
+00014970: 2063 616e 646c 6520 6869 7374 6f72 7920   candle history 
+00014980: 7573 696e 6720 6173 796e 6369 6f20 616e  using asyncio an
+00014990: 6420 7265 7475 726e 7320 7468 6520 6c69  d returns the li
+000149a0: 7374 206f 6620 6361 6e64 6c65 732e 0a20  st of candles.. 
+000149b0: 2020 2020 2020 2048 616e 646c 6573 2061         Handles a
+000149c0: 6c6c 2061 7379 6e63 2077 6f72 6b20 666f  ll async work fo
+000149d0: 7220 7468 6973 2e0a 2020 2020 2020 2020  r this..        
+000149e0: 4173 796e 6320 6f76 6572 206f 6e65 2070  Async over one p
+000149f0: 6169 722c 2061 7373 756d 696e 6720 7765  air, assuming we
+00014a00: 2067 6574 2060 7365 6c66 2e6f 686c 6376   get `self.ohlcv
+00014a10: 5f63 616e 646c 655f 6c69 6d69 7428 2960  _candle_limit()`
+00014a20: 2063 616e 646c 6573 2070 6572 2063 616c   candles per cal
+00014a30: 6c2e 0a20 2020 2020 2020 203a 7061 7261  l..        :para
+00014a40: 6d20 7061 6972 3a20 5061 6972 2074 6f20  m pair: Pair to 
+00014a50: 646f 776e 6c6f 6164 0a20 2020 2020 2020  download.       
+00014a60: 203a 7061 7261 6d20 7469 6d65 6672 616d   :param timefram
+00014a70: 653a 2054 696d 6566 7261 6d65 2074 6f20  e: Timeframe to 
+00014a80: 6765 7420 6461 7461 2066 6f72 0a20 2020  get data for.   
+00014a90: 2020 2020 203a 7061 7261 6d20 7369 6e63       :param sinc
+00014aa0: 655f 6d73 3a20 5469 6d65 7374 616d 7020  e_ms: Timestamp 
+00014ab0: 696e 206d 696c 6c69 7365 636f 6e64 7320  in milliseconds 
+00014ac0: 746f 2067 6574 2068 6973 746f 7279 2066  to get history f
+00014ad0: 726f 6d0a 2020 2020 2020 2020 3a70 6172  rom.        :par
+00014ae0: 616d 2075 6e74 696c 5f6d 733a 2054 696d  am until_ms: Tim
+00014af0: 6573 7461 6d70 2069 6e20 6d69 6c6c 6973  estamp in millis
+00014b00: 6563 6f6e 6473 2074 6f20 6765 7420 6869  econds to get hi
+00014b10: 7374 6f72 7920 7570 2074 6f0a 2020 2020  story up to.    
+00014b20: 2020 2020 3a70 6172 616d 2063 616e 646c      :param candl
+00014b30: 655f 7479 7065 3a20 2727 2c20 6d61 726b  e_type: '', mark
+00014b40: 2c20 696e 6465 782c 2070 7265 6d69 756d  , index, premium
+00014b50: 496e 6465 782c 206f 7220 6675 6e64 696e  Index, or fundin
+00014b60: 675f 7261 7465 0a20 2020 2020 2020 203a  g_rate.        :
+00014b70: 7265 7475 726e 3a20 4c69 7374 2077 6974  return: List wit
+00014b80: 6820 6361 6e64 6c65 2028 4f48 4c43 5629  h candle (OHLCV)
+00014b90: 2064 6174 610a 2020 2020 2020 2020 2222   data.        ""
+00014ba0: 220a 2020 2020 2020 2020 7061 6972 2c20  ".        pair, 
+00014bb0: 5f2c 205f 2c20 6461 7461 2c20 5f20 3d20  _, _, data, _ = 
+00014bc0: 7365 6c66 2e6c 6f6f 702e 7275 6e5f 756e  self.loop.run_un
+00014bd0: 7469 6c5f 636f 6d70 6c65 7465 280a 2020  til_complete(.  
+00014be0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00014bf0: 6173 796e 635f 6765 745f 6869 7374 6f72  async_get_histor
+00014c00: 6963 5f6f 686c 6376 2870 6169 723d 7061  ic_ohlcv(pair=pa
+00014c10: 6972 2c20 7469 6d65 6672 616d 653d 7469  ir, timeframe=ti
+00014c20: 6d65 6672 616d 652c 0a20 2020 2020 2020  meframe,.       
+00014c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c50: 2020 2020 7369 6e63 655f 6d73 3d73 696e      since_ms=sin
+00014c60: 6365 5f6d 732c 2075 6e74 696c 5f6d 733d  ce_ms, until_ms=
+00014c70: 756e 7469 6c5f 6d73 2c0a 2020 2020 2020  until_ms,.      
+00014c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ca0: 2020 2020 2069 735f 6e65 775f 7061 6972       is_new_pair
+00014cb0: 3d69 735f 6e65 775f 7061 6972 2c20 6361  =is_new_pair, ca
+00014cc0: 6e64 6c65 5f74 7970 653d 6361 6e64 6c65  ndle_type=candle
+00014cd0: 5f74 7970 6529 290a 2020 2020 2020 2020  _type)).        
+00014ce0: 6c6f 6767 6572 2e69 6e66 6f28 6622 446f  logger.info(f"Do
+00014cf0: 776e 6c6f 6164 6564 2064 6174 6120 666f  wnloaded data fo
+00014d00: 7220 7b70 6169 727d 2077 6974 6820 6c65  r {pair} with le
+00014d10: 6e67 7468 207b 6c65 6e28 6461 7461 297d  ngth {len(data)}
+00014d20: 2e22 290a 2020 2020 2020 2020 7265 7475  .").        retu
+00014d30: 726e 2064 6174 610a 0a20 2020 2061 7379  rn data..    asy
+00014d40: 6e63 2064 6566 205f 6173 796e 635f 6765  nc def _async_ge
+00014d50: 745f 6869 7374 6f72 6963 5f6f 686c 6376  t_historic_ohlcv
+00014d60: 2873 656c 662c 2070 6169 723a 2073 7472  (self, pair: str
+00014d70: 2c20 7469 6d65 6672 616d 653a 2073 7472  , timeframe: str
+00014d80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014da0: 2020 2020 2020 2020 2020 7369 6e63 655f            since_
+00014db0: 6d73 3a20 696e 742c 2063 616e 646c 655f  ms: int, candle_
+00014dc0: 7479 7065 3a20 4361 6e64 6c65 5479 7065  type: CandleType
+00014dd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014df0: 2020 2020 2020 2020 2020 6973 5f6e 6577            is_new
+00014e00: 5f70 6169 723a 2062 6f6f 6c20 3d20 4661  _pair: bool = Fa
+00014e10: 6c73 652c 2072 6169 7365 5f3a 2062 6f6f  lse, raise_: boo
+00014e20: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+00014e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e50: 2020 2075 6e74 696c 5f6d 733a 204f 7074     until_ms: Opt
+00014e60: 696f 6e61 6c5b 696e 745d 203d 204e 6f6e  ional[int] = Non
+00014e70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00014e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014e90: 2020 2020 2020 2020 2020 2920 2d3e 204f            ) -> O
+00014ea0: 484c 4356 5265 7370 6f6e 7365 3a0a 2020  HLCVResponse:.  
+00014eb0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00014ec0: 2020 446f 776e 6c6f 6164 2068 6973 746f    Download histo
+00014ed0: 7269 6320 6f68 6c63 760a 2020 2020 2020  ric ohlcv.      
+00014ee0: 2020 3a70 6172 616d 2069 735f 6e65 775f    :param is_new_
+00014ef0: 7061 6972 3a20 7573 6564 2062 7920 6269  pair: used by bi
+00014f00: 6e61 6e63 6520 7375 6263 6c61 7373 2074  nance subclass t
+00014f10: 6f20 616c 6c6f 7720 2266 6173 7422 206e  o allow "fast" n
+00014f20: 6577 2070 6169 7220 646f 776e 6c6f 6164  ew pair download
+00014f30: 696e 670a 2020 2020 2020 2020 3a70 6172  ing.        :par
+00014f40: 616d 2063 616e 646c 655f 7479 7065 3a20  am candle_type: 
+00014f50: 416e 7920 6f66 2074 6865 2065 6e75 6d20  Any of the enum 
+00014f60: 4361 6e64 6c65 5479 7065 2028 6d75 7374  CandleType (must
+00014f70: 206d 6174 6368 2074 7261 6469 6e67 206d   match trading m
+00014f80: 6f64 6521 290a 2020 2020 2020 2020 2222  ode!).        ""
+00014f90: 220a 0a20 2020 2020 2020 206f 6e65 5f63  "..        one_c
+00014fa0: 616c 6c20 3d20 7469 6d65 6672 616d 655f  all = timeframe_
+00014fb0: 746f 5f6d 7365 6373 2874 696d 6566 7261  to_msecs(timefra
+00014fc0: 6d65 2920 2a20 7365 6c66 2e6f 686c 6376  me) * self.ohlcv
+00014fd0: 5f63 616e 646c 655f 6c69 6d69 7428 0a20  _candle_limit(. 
+00014fe0: 2020 2020 2020 2020 2020 2074 696d 6566             timef
+00014ff0: 7261 6d65 2c20 6361 6e64 6c65 5f74 7970  rame, candle_typ
+00015000: 652c 2073 696e 6365 5f6d 7329 0a20 2020  e, since_ms).   
+00015010: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+00015020: 6728 0a20 2020 2020 2020 2020 2020 2022  g(.            "
+00015030: 6f6e 655f 6361 6c6c 3a20 2573 206d 7365  one_call: %s mse
+00015040: 6373 2028 2573 2922 2c0a 2020 2020 2020  cs (%s)",.      
+00015050: 2020 2020 2020 6f6e 655f 6361 6c6c 2c0a        one_call,.
+00015060: 2020 2020 2020 2020 2020 2020 6474 5f68              dt_h
+00015070: 756d 616e 697a 6528 6474 5f6e 6f77 2829  umanize(dt_now()
+00015080: 202d 2074 696d 6564 656c 7461 286d 696c   - timedelta(mil
+00015090: 6c69 7365 636f 6e64 733d 6f6e 655f 6361  liseconds=one_ca
+000150a0: 6c6c 292c 206f 6e6c 795f 6469 7374 616e  ll), only_distan
+000150b0: 6365 3d54 7275 6529 0a20 2020 2020 2020  ce=True).       
+000150c0: 2029 0a20 2020 2020 2020 2069 6e70 7574   ).        input
+000150d0: 5f63 6f72 6f75 7469 6e65 7320 3d20 5b73  _coroutines = [s
+000150e0: 656c 662e 5f61 7379 6e63 5f67 6574 5f63  elf._async_get_c
+000150f0: 616e 646c 655f 6869 7374 6f72 7928 0a20  andle_history(. 
+00015100: 2020 2020 2020 2020 2020 2070 6169 722c             pair,
+00015110: 2074 696d 6566 7261 6d65 2c20 6361 6e64   timeframe, cand
+00015120: 6c65 5f74 7970 652c 2073 696e 6365 2920  le_type, since) 
+00015130: 666f 7220 7369 6e63 6520 696e 0a20 2020  for since in.   
+00015140: 2020 2020 2020 2020 2072 616e 6765 2873           range(s
+00015150: 696e 6365 5f6d 732c 2075 6e74 696c 5f6d  ince_ms, until_m
+00015160: 7320 6f72 2064 745f 7473 2829 2c20 6f6e  s or dt_ts(), on
+00015170: 655f 6361 6c6c 295d 0a0a 2020 2020 2020  e_call)]..      
+00015180: 2020 6461 7461 3a20 4c69 7374 203d 205b    data: List = [
+00015190: 5d0a 2020 2020 2020 2020 2320 4368 756e  ].        # Chun
+000151a0: 6b20 7265 7175 6573 7473 2069 6e74 6f20  k requests into 
+000151b0: 6261 7463 6865 7320 6f66 2031 3030 2074  batches of 100 t
+000151c0: 6f20 6176 6f69 6420 6f76 6572 7765 6c6d  o avoid overwelm
+000151d0: 696e 6720 6363 7874 2054 6872 6f74 746c  ing ccxt Throttl
+000151e0: 696e 670a 2020 2020 2020 2020 666f 7220  ing.        for 
+000151f0: 696e 7075 745f 636f 726f 2069 6e20 6368  input_coro in ch
+00015200: 756e 6b73 2869 6e70 7574 5f63 6f72 6f75  unks(input_corou
+00015210: 7469 6e65 732c 2031 3030 293a 0a0a 2020  tines, 100):..  
+00015220: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00015230: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
+00015240: 6f2e 6761 7468 6572 282a 696e 7075 745f  o.gather(*input_
+00015250: 636f 726f 2c20 7265 7475 726e 5f65 7863  coro, return_exc
+00015260: 6570 7469 6f6e 733d 5472 7565 290a 2020  eptions=True).  
+00015270: 2020 2020 2020 2020 2020 666f 7220 7265            for re
+00015280: 7320 696e 2072 6573 756c 7473 3a0a 2020  s in results:.  
+00015290: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000152a0: 2069 7369 6e73 7461 6e63 6528 7265 732c   isinstance(res,
+000152b0: 2045 7863 6570 7469 6f6e 293a 0a20 2020   Exception):.   
+000152c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152d0: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+000152e0: 6622 4173 796e 6320 636f 6465 2072 6169  f"Async code rai
+000152f0: 7365 6420 616e 2065 7863 6570 7469 6f6e  sed an exception
+00015300: 3a20 7b72 6570 7228 7265 7329 7d22 290a  : {repr(res)}").
+00015310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015320: 2020 2020 6966 2072 6169 7365 5f3a 0a20      if raise_:. 
+00015330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015340: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
+00015350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015360: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+00015370: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00015380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015390: 2020 2020 2320 4465 636f 6e73 7472 7563      # Deconstruc
+000153a0: 7420 7475 706c 6520 6966 2069 7427 7320  t tuple if it's 
+000153b0: 6e6f 7420 616e 2065 7863 6570 7469 6f6e  not an exception
+000153c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000153d0: 2020 2020 2070 2c20 5f2c 2063 2c20 6e65       p, _, c, ne
+000153e0: 775f 6461 7461 2c20 5f20 3d20 7265 730a  w_data, _ = res.
+000153f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015400: 2020 2020 6966 2070 203d 3d20 7061 6972      if p == pair
+00015410: 2061 6e64 2063 203d 3d20 6361 6e64 6c65   and c == candle
+00015420: 5f74 7970 653a 0a20 2020 2020 2020 2020  _type:.         
+00015430: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00015440: 6174 612e 6578 7465 6e64 286e 6577 5f64  ata.extend(new_d
+00015450: 6174 6129 0a20 2020 2020 2020 2023 2053  ata).        # S
+00015460: 6f72 7420 6461 7461 2061 6761 696e 2061  ort data again a
+00015470: 6674 6572 2065 7874 656e 6469 6e67 2074  fter extending t
+00015480: 6865 2072 6573 756c 7420 2d20 6162 6f76  he result - abov
+00015490: 6520 6361 6c6c 7320 7265 7475 726e 2069  e calls return i
+000154a0: 6e20 2261 7379 6e63 206f 7264 6572 220a  n "async order".
+000154b0: 2020 2020 2020 2020 6461 7461 203d 2073          data = s
+000154c0: 6f72 7465 6428 6461 7461 2c20 6b65 793d  orted(data, key=
+000154d0: 6c61 6d62 6461 2078 3a20 785b 305d 290a  lambda x: x[0]).
+000154e0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+000154f0: 6169 722c 2074 696d 6566 7261 6d65 2c20  air, timeframe, 
+00015500: 6361 6e64 6c65 5f74 7970 652c 2064 6174  candle_type, dat
+00015510: 612c 2073 656c 662e 5f6f 686c 6376 5f70  a, self._ohlcv_p
+00015520: 6172 7469 616c 5f63 616e 646c 650a 0a20  artial_candle.. 
+00015530: 2020 2064 6566 205f 6275 696c 645f 636f     def _build_co
+00015540: 726f 7574 696e 6528 0a20 2020 2020 2020  routine(.       
+00015550: 2020 2020 2073 656c 662c 2070 6169 723a       self, pair:
+00015560: 2073 7472 2c20 7469 6d65 6672 616d 653a   str, timeframe:
+00015570: 2073 7472 2c20 6361 6e64 6c65 5f74 7970   str, candle_typ
+00015580: 653a 2043 616e 646c 6554 7970 652c 0a20  e: CandleType,. 
+00015590: 2020 2020 2020 2020 2020 2073 696e 6365             since
+000155a0: 5f6d 733a 204f 7074 696f 6e61 6c5b 696e  _ms: Optional[in
+000155b0: 745d 2c20 6361 6368 653a 2062 6f6f 6c29  t], cache: bool)
+000155c0: 202d 3e20 436f 726f 7574 696e 655b 416e   -> Coroutine[An
+000155d0: 792c 2041 6e79 2c20 4f48 4c43 5652 6573  y, Any, OHLCVRes
+000155e0: 706f 6e73 655d 3a0a 2020 2020 2020 2020  ponse]:.        
+000155f0: 6e6f 745f 616c 6c5f 6461 7461 203d 2063  not_all_data = c
+00015600: 6163 6865 2061 6e64 2073 656c 662e 7265  ache and self.re
+00015610: 7175 6972 6564 5f63 616e 646c 655f 6361  quired_candle_ca
+00015620: 6c6c 5f63 6f75 6e74 203e 2031 0a20 2020  ll_count > 1.   
+00015630: 2020 2020 2069 6620 6361 6368 6520 616e       if cache an
+00015640: 6420 2870 6169 722c 2074 696d 6566 7261  d (pair, timefra
+00015650: 6d65 2c20 6361 6e64 6c65 5f74 7970 6529  me, candle_type)
+00015660: 2069 6e20 7365 6c66 2e5f 6b6c 696e 6573   in self._klines
+00015670: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
+00015680: 6e64 6c65 5f6c 696d 6974 203d 2073 656c  ndle_limit = sel
+00015690: 662e 6f68 6c63 765f 6361 6e64 6c65 5f6c  f.ohlcv_candle_l
+000156a0: 696d 6974 2874 696d 6566 7261 6d65 2c20  imit(timeframe, 
+000156b0: 6361 6e64 6c65 5f74 7970 6529 0a20 2020  candle_type).   
+000156c0: 2020 2020 2020 2020 206d 696e 5f64 6174           min_dat
+000156d0: 6520 3d20 6461 7465 5f6d 696e 7573 5f63  e = date_minus_c
+000156e0: 616e 646c 6573 2874 696d 6566 7261 6d65  andles(timeframe
+000156f0: 2c20 6361 6e64 6c65 5f6c 696d 6974 202d  , candle_limit -
+00015700: 2035 292e 7469 6d65 7374 616d 7028 290a   5).timestamp().
+00015710: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
+00015720: 6563 6b20 6966 2031 2063 616c 6c20 6361  eck if 1 call ca
+00015730: 6e20 6765 7420 7573 2075 7064 6174 6564  n get us updated
+00015740: 2063 616e 646c 6573 2077 6974 686f 7574   candles without
+00015750: 2068 6f6c 6520 696e 2074 6865 2064 6174   hole in the dat
+00015760: 612e 0a20 2020 2020 2020 2020 2020 2069  a..            i
+00015770: 6620 6d69 6e5f 6461 7465 203c 2073 656c  f min_date < sel
+00015780: 662e 5f70 6169 7273 5f6c 6173 745f 7265  f._pairs_last_re
+00015790: 6672 6573 685f 7469 6d65 2e67 6574 2828  fresh_time.get((
+000157a0: 7061 6972 2c20 7469 6d65 6672 616d 652c  pair, timeframe,
+000157b0: 2063 616e 646c 655f 7479 7065 292c 2030   candle_type), 0
+000157c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000157d0: 2020 2023 2043 6163 6865 2063 616e 2062     # Cache can b
+000157e0: 6520 7573 6564 202d 2064 6f20 6f6e 652d  e used - do one-
+000157f0: 6f66 6620 6361 6c6c 2e0a 2020 2020 2020  off call..      
+00015800: 2020 2020 2020 2020 2020 6e6f 745f 616c            not_al
+00015810: 6c5f 6461 7461 203d 2046 616c 7365 0a20  l_data = False. 
+00015820: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00015830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015840: 2023 2054 696d 6520 6a75 6d70 2064 6574   # Time jump det
+00015850: 6563 7465 642c 2065 7669 6374 2063 6163  ected, evict cac
+00015860: 6865 0a20 2020 2020 2020 2020 2020 2020  he.             
+00015870: 2020 206c 6f67 6765 722e 696e 666f 280a     logger.info(.
+00015880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015890: 2020 2020 6622 5469 6d65 206a 756d 7020      f"Time jump 
+000158a0: 6465 7465 6374 6564 2e20 4576 6963 7469  detected. Evicti
+000158b0: 6e67 2063 6163 6865 2066 6f72 207b 7061  ng cache for {pa
+000158c0: 6972 7d2c 207b 7469 6d65 6672 616d 657d  ir}, {timeframe}
+000158d0: 2c20 7b63 616e 646c 655f 7479 7065 7d22  , {candle_type}"
+000158e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000158f0: 2020 6465 6c20 7365 6c66 2e5f 6b6c 696e    del self._klin
+00015900: 6573 5b28 7061 6972 2c20 7469 6d65 6672  es[(pair, timefr
+00015910: 616d 652c 2063 616e 646c 655f 7479 7065  ame, candle_type
+00015920: 295d 0a0a 2020 2020 2020 2020 6966 2028  )]..        if (
+00015930: 6e6f 7420 7369 6e63 655f 6d73 2061 6e64  not since_ms and
+00015940: 2028 7365 6c66 2e5f 6674 5f68 6173 5b22   (self._ft_has["
+00015950: 6f68 6c63 765f 7265 7175 6972 655f 7369  ohlcv_require_si
+00015960: 6e63 6522 5d20 6f72 206e 6f74 5f61 6c6c  nce"] or not_all
+00015970: 5f64 6174 6129 293a 0a20 2020 2020 2020  _data)):.       
+00015980: 2020 2020 2023 204d 756c 7469 706c 6520       # Multiple 
+00015990: 6361 6c6c 7320 666f 7220 6f6e 6520 7061  calls for one pa
+000159a0: 6972 202d 2074 6f20 6765 7420 6d6f 7265  ir - to get more
+000159b0: 2068 6973 746f 7279 0a20 2020 2020 2020   history.       
+000159c0: 2020 2020 206f 6e65 5f63 616c 6c20 3d20       one_call = 
+000159d0: 7469 6d65 6672 616d 655f 746f 5f6d 7365  timeframe_to_mse
+000159e0: 6373 2874 696d 6566 7261 6d65 2920 2a20  cs(timeframe) * 
+000159f0: 7365 6c66 2e6f 686c 6376 5f63 616e 646c  self.ohlcv_candl
+00015a00: 655f 6c69 6d69 7428 0a20 2020 2020 2020  e_limit(.       
+00015a10: 2020 2020 2020 2020 2074 696d 6566 7261           timefra
+00015a20: 6d65 2c20 6361 6e64 6c65 5f74 7970 652c  me, candle_type,
+00015a30: 2073 696e 6365 5f6d 7329 0a20 2020 2020   since_ms).     
+00015a40: 2020 2020 2020 206d 6f76 655f 746f 203d         move_to =
+00015a50: 206f 6e65 5f63 616c 6c20 2a20 7365 6c66   one_call * self
+00015a60: 2e72 6571 7569 7265 645f 6361 6e64 6c65  .required_candle
+00015a70: 5f63 616c 6c5f 636f 756e 740a 2020 2020  _call_count.    
+00015a80: 2020 2020 2020 2020 6e6f 7720 3d20 7469          now = ti
+00015a90: 6d65 6672 616d 655f 746f 5f6e 6578 745f  meframe_to_next_
+00015aa0: 6461 7465 2874 696d 6566 7261 6d65 290a  date(timeframe).
+00015ab0: 2020 2020 2020 2020 2020 2020 7369 6e63              sinc
+00015ac0: 655f 6d73 203d 2069 6e74 2828 6e6f 7720  e_ms = int((now 
+00015ad0: 2d20 7469 6d65 6465 6c74 6128 7365 636f  - timedelta(seco
+00015ae0: 6e64 733d 6d6f 7665 5f74 6f20 2f2f 2031  nds=move_to // 1
+00015af0: 3030 3029 292e 7469 6d65 7374 616d 7028  000)).timestamp(
+00015b00: 2920 2a20 3130 3030 290a 0a20 2020 2020  ) * 1000)..     
+00015b10: 2020 2069 6620 7369 6e63 655f 6d73 3a0a     if since_ms:.
+00015b20: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00015b30: 726e 2073 656c 662e 5f61 7379 6e63 5f67  rn self._async_g
+00015b40: 6574 5f68 6973 746f 7269 635f 6f68 6c63  et_historic_ohlc
+00015b50: 7628 0a20 2020 2020 2020 2020 2020 2020  v(.             
+00015b60: 2020 2070 6169 722c 2074 696d 6566 7261     pair, timefra
+00015b70: 6d65 2c20 7369 6e63 655f 6d73 3d73 696e  me, since_ms=sin
+00015b80: 6365 5f6d 732c 2072 6169 7365 5f3d 5472  ce_ms, raise_=Tr
+00015b90: 7565 2c20 6361 6e64 6c65 5f74 7970 653d  ue, candle_type=
+00015ba0: 6361 6e64 6c65 5f74 7970 6529 0a20 2020  candle_type).   
+00015bb0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00015bc0: 2020 2020 2020 2023 204f 6e65 2063 616c         # One cal
+00015bd0: 6c20 2e2e 2e20 2272 6567 756c 6172 2220  l ... "regular" 
+00015be0: 7265 6672 6573 680a 2020 2020 2020 2020  refresh.        
+00015bf0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00015c00: 5f61 7379 6e63 5f67 6574 5f63 616e 646c  _async_get_candl
+00015c10: 655f 6869 7374 6f72 7928 0a20 2020 2020  e_history(.     
+00015c20: 2020 2020 2020 2020 2020 2070 6169 722c             pair,
+00015c30: 2074 696d 6566 7261 6d65 2c20 7369 6e63   timeframe, sinc
+00015c40: 655f 6d73 3d73 696e 6365 5f6d 732c 2063  e_ms=since_ms, c
+00015c50: 616e 646c 655f 7479 7065 3d63 616e 646c  andle_type=candl
+00015c60: 655f 7479 7065 290a 0a20 2020 2064 6566  e_type)..    def
+00015c70: 205f 6275 696c 645f 6f68 6c63 765f 646c   _build_ohlcv_dl
+00015c80: 5f6a 6f62 7328 0a20 2020 2020 2020 2020  _jobs(.         
+00015c90: 2020 2073 656c 662c 2070 6169 725f 6c69     self, pair_li
+00015ca0: 7374 3a20 4c69 7374 5061 6972 7357 6974  st: ListPairsWit
+00015cb0: 6854 696d 6566 7261 6d65 732c 2073 696e  hTimeframes, sin
+00015cc0: 6365 5f6d 733a 204f 7074 696f 6e61 6c5b  ce_ms: Optional[
+00015cd0: 696e 745d 2c0a 2020 2020 2020 2020 2020  int],.          
+00015ce0: 2020 6361 6368 653a 2062 6f6f 6c29 202d    cache: bool) -
+00015cf0: 3e20 5475 706c 655b 4c69 7374 5b43 6f72  > Tuple[List[Cor
+00015d00: 6f75 7469 6e65 5d2c 204c 6973 745b 5475  outine], List[Tu
+00015d10: 706c 655b 7374 722c 2073 7472 2c20 4361  ple[str, str, Ca
+00015d20: 6e64 6c65 5479 7065 5d5d 5d3a 0a20 2020  ndleType]]]:.   
+00015d30: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00015d40: 2042 7569 6c64 2043 6f72 6f75 7469 6e65   Build Coroutine
+00015d50: 7320 746f 2065 7865 6375 7465 2061 7320  s to execute as 
+00015d60: 7061 7274 206f 6620 7265 6672 6573 685f  part of refresh_
+00015d70: 6c61 7465 7374 5f6f 686c 6376 0a20 2020  latest_ohlcv.   
+00015d80: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00015d90: 2069 6e70 7574 5f63 6f72 6f75 7469 6e65   input_coroutine
+00015da0: 733a 204c 6973 745b 436f 726f 7574 696e  s: List[Coroutin
+00015db0: 655b 416e 792c 2041 6e79 2c20 4f48 4c43  e[Any, Any, OHLC
+00015dc0: 5652 6573 706f 6e73 655d 5d20 3d20 5b5d  VResponse]] = []
+00015dd0: 0a20 2020 2020 2020 2063 6163 6865 645f  .        cached_
+00015de0: 7061 6972 7320 3d20 5b5d 0a20 2020 2020  pairs = [].     
+00015df0: 2020 2066 6f72 2070 6169 722c 2074 696d     for pair, tim
+00015e00: 6566 7261 6d65 2c20 6361 6e64 6c65 5f74  eframe, candle_t
+00015e10: 7970 6520 696e 2073 6574 2870 6169 725f  ype in set(pair_
+00015e20: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
+00015e30: 2020 2069 6620 2874 696d 6566 7261 6d65     if (timeframe
+00015e40: 206e 6f74 2069 6e20 7365 6c66 2e74 696d   not in self.tim
+00015e50: 6566 7261 6d65 730a 2020 2020 2020 2020  eframes.        
+00015e60: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00015e70: 6361 6e64 6c65 5f74 7970 6520 696e 2028  candle_type in (
+00015e80: 4361 6e64 6c65 5479 7065 2e53 504f 542c  CandleType.SPOT,
+00015e90: 2043 616e 646c 6554 7970 652e 4655 5455   CandleType.FUTU
+00015ea0: 5245 5329 293a 0a20 2020 2020 2020 2020  RES)):.         
+00015eb0: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
+00015ec0: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+00015ed0: 2020 2020 2020 2020 2020 2066 2243 616e             f"Can
+00015ee0: 6e6f 7420 646f 776e 6c6f 6164 2028 7b70  not download ({p
+00015ef0: 6169 727d 2c20 7b74 696d 6566 7261 6d65  air}, {timeframe
+00015f00: 7d29 2063 6f6d 6269 6e61 7469 6f6e 2061  }) combination a
+00015f10: 7320 7468 6973 2074 696d 6566 7261 6d65  s this timeframe
+00015f20: 2069 7320 220a 2020 2020 2020 2020 2020   is ".          
+00015f30: 2020 2020 2020 2020 2020 6622 6e6f 7420            f"not 
+00015f40: 6176 6169 6c61 626c 6520 6f6e 207b 7365  available on {se
+00015f50: 6c66 2e6e 616d 657d 2e20 4176 6169 6c61  lf.name}. Availa
+00015f60: 626c 6520 7469 6d65 6672 616d 6573 2061  ble timeframes a
+00015f70: 7265 2022 0a20 2020 2020 2020 2020 2020  re ".           
+00015f80: 2020 2020 2020 2020 2066 227b 272c 2027           f"{', '
+00015f90: 2e6a 6f69 6e28 7365 6c66 2e74 696d 6566  .join(self.timef
+00015fa0: 7261 6d65 7329 7d2e 2229 0a20 2020 2020  rames)}.").     
+00015fb0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00015fc0: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+00015fd0: 2069 6620 2828 7061 6972 2c20 7469 6d65   if ((pair, time
+00015fe0: 6672 616d 652c 2063 616e 646c 655f 7479  frame, candle_ty
+00015ff0: 7065 2920 6e6f 7420 696e 2073 656c 662e  pe) not in self.
+00016000: 5f6b 6c69 6e65 7320 6f72 206e 6f74 2063  _klines or not c
+00016010: 6163 6865 0a20 2020 2020 2020 2020 2020  ache.           
+00016020: 2020 2020 2020 2020 206f 7220 7365 6c66           or self
+00016030: 2e5f 6e6f 775f 6973 5f74 696d 655f 746f  ._now_is_time_to
+00016040: 5f72 6566 7265 7368 2870 6169 722c 2074  _refresh(pair, t
+00016050: 696d 6566 7261 6d65 2c20 6361 6e64 6c65  imeframe, candle
+00016060: 5f74 7970 6529 293a 0a0a 2020 2020 2020  _type)):..      
+00016070: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+00016080: 636f 726f 7574 696e 6573 2e61 7070 656e  coroutines.appen
+00016090: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+000160a0: 2020 2020 2020 2073 656c 662e 5f62 7569         self._bui
+000160b0: 6c64 5f63 6f72 6f75 7469 6e65 2870 6169  ld_coroutine(pai
+000160c0: 722c 2074 696d 6566 7261 6d65 2c20 6361  r, timeframe, ca
+000160d0: 6e64 6c65 5f74 7970 652c 2073 696e 6365  ndle_type, since
+000160e0: 5f6d 732c 2063 6163 6865 2929 0a0a 2020  _ms, cache))..  
+000160f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00016100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016110: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
+00016120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016130: 2020 6622 5573 696e 6720 6361 6368 6564    f"Using cached
+00016140: 2063 616e 646c 6520 284f 484c 4356 2920   candle (OHLCV) 
+00016150: 6461 7461 2066 6f72 207b 7061 6972 7d2c  data for {pair},
+00016160: 207b 7469 6d65 6672 616d 657d 2c20 7b63   {timeframe}, {c
+00016170: 616e 646c 655f 7479 7065 7d20 2e2e 2e22  andle_type} ..."
+00016180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016190: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000161a0: 2020 2063 6163 6865 645f 7061 6972 732e     cached_pairs.
+000161b0: 6170 7065 6e64 2828 7061 6972 2c20 7469  append((pair, ti
+000161c0: 6d65 6672 616d 652c 2063 616e 646c 655f  meframe, candle_
+000161d0: 7479 7065 2929 0a0a 2020 2020 2020 2020  type))..        
+000161e0: 7265 7475 726e 2069 6e70 7574 5f63 6f72  return input_cor
+000161f0: 6f75 7469 6e65 732c 2063 6163 6865 645f  outines, cached_
+00016200: 7061 6972 730a 0a20 2020 2064 6566 205f  pairs..    def _
+00016210: 7072 6f63 6573 735f 6f68 6c63 765f 6466  process_ohlcv_df
+00016220: 2873 656c 662c 2070 6169 723a 2073 7472  (self, pair: str
+00016230: 2c20 7469 6d65 6672 616d 653a 2073 7472  , timeframe: str
+00016240: 2c20 635f 7479 7065 3a20 4361 6e64 6c65  , c_type: Candle
+00016250: 5479 7065 2c20 7469 636b 733a 204c 6973  Type, ticks: Lis
+00016260: 745b 4c69 7374 5d2c 0a20 2020 2020 2020  t[List],.       
+00016270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016280: 2020 2063 6163 6865 3a20 626f 6f6c 2c20     cache: bool, 
+00016290: 6472 6f70 5f69 6e63 6f6d 706c 6574 653a  drop_incomplete:
+000162a0: 2062 6f6f 6c29 202d 3e20 4461 7461 4672   bool) -> DataFr
+000162b0: 616d 653a 0a20 2020 2020 2020 2023 206b  ame:.        # k
+000162c0: 6565 7069 6e67 206c 6173 7420 6361 6e64  eeping last cand
+000162d0: 6c65 2074 696d 6520 6173 206c 6173 7420  le time as last 
+000162e0: 7265 6672 6573 6865 6420 7469 6d65 206f  refreshed time o
+000162f0: 6620 7468 6520 7061 6972 0a20 2020 2020  f the pair.     
+00016300: 2020 2069 6620 7469 636b 7320 616e 6420     if ticks and 
+00016310: 6361 6368 653a 0a20 2020 2020 2020 2020  cache:.         
+00016320: 2020 2069 6478 203d 202d 3220 6966 2064     idx = -2 if d
+00016330: 726f 705f 696e 636f 6d70 6c65 7465 2061  rop_incomplete a
+00016340: 6e64 206c 656e 2874 6963 6b73 2920 3e20  nd len(ticks) > 
+00016350: 3120 656c 7365 202d 310a 2020 2020 2020  1 else -1.      
+00016360: 2020 2020 2020 7365 6c66 2e5f 7061 6972        self._pair
+00016370: 735f 6c61 7374 5f72 6566 7265 7368 5f74  s_last_refresh_t
+00016380: 696d 655b 2870 6169 722c 2074 696d 6566  ime[(pair, timef
+00016390: 7261 6d65 2c20 635f 7479 7065 295d 203d  rame, c_type)] =
+000163a0: 2074 6963 6b73 5b69 6478 5d5b 305d 202f   ticks[idx][0] /
+000163b0: 2f20 3130 3030 0a20 2020 2020 2020 2023  / 1000.        #
+000163c0: 206b 6565 7069 6e67 2070 6172 7365 6420   keeping parsed 
+000163d0: 6461 7461 6672 616d 6520 696e 2063 6163  dataframe in cac
+000163e0: 6865 0a20 2020 2020 2020 206f 686c 6376  he.        ohlcv
+000163f0: 5f64 6620 3d20 6f68 6c63 765f 746f 5f64  _df = ohlcv_to_d
+00016400: 6174 6166 7261 6d65 2874 6963 6b73 2c20  ataframe(ticks, 
+00016410: 7469 6d65 6672 616d 652c 2070 6169 723d  timeframe, pair=
+00016420: 7061 6972 2c20 6669 6c6c 5f6d 6973 7369  pair, fill_missi
+00016430: 6e67 3d54 7275 652c 0a20 2020 2020 2020  ng=True,.       
+00016440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016450: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00016460: 726f 705f 696e 636f 6d70 6c65 7465 3d64  rop_incomplete=d
+00016470: 726f 705f 696e 636f 6d70 6c65 7465 290a  rop_incomplete).
+00016480: 2020 2020 2020 2020 6966 2063 6163 6865          if cache
+00016490: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000164a0: 2028 7061 6972 2c20 7469 6d65 6672 616d   (pair, timefram
+000164b0: 652c 2063 5f74 7970 6529 2069 6e20 7365  e, c_type) in se
+000164c0: 6c66 2e5f 6b6c 696e 6573 3a0a 2020 2020  lf._klines:.    
+000164d0: 2020 2020 2020 2020 2020 2020 6f6c 6420              old 
+000164e0: 3d20 7365 6c66 2e5f 6b6c 696e 6573 5b28  = self._klines[(
+000164f0: 7061 6972 2c20 7469 6d65 6672 616d 652c  pair, timeframe,
+00016500: 2063 5f74 7970 6529 5d0a 2020 2020 2020   c_type)].      
+00016510: 2020 2020 2020 2020 2020 2320 5265 6173            # Reas
+00016520: 7369 676e 2073 6f20 7765 2072 6574 7572  sign so we retur
+00016530: 6e20 7468 6520 7570 6461 7465 642c 2063  n the updated, c
+00016540: 6f6d 6269 6e65 6420 6466 0a20 2020 2020  ombined df.     
+00016550: 2020 2020 2020 2020 2020 206f 686c 6376             ohlcv
+00016560: 5f64 6620 3d20 636c 6561 6e5f 6f68 6c63  _df = clean_ohlc
+00016570: 765f 6461 7461 6672 616d 6528 636f 6e63  v_dataframe(conc
+00016580: 6174 285b 6f6c 642c 206f 686c 6376 5f64  at([old, ohlcv_d
+00016590: 665d 2c20 6178 6973 3d30 292c 2074 696d  f], axis=0), tim
+000165a0: 6566 7261 6d65 2c20 7061 6972 2c0a 2020  eframe, pair,.  
+000165b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000165e0: 696c 6c5f 6d69 7373 696e 673d 5472 7565  ill_missing=True
+000165f0: 2c20 6472 6f70 5f69 6e63 6f6d 706c 6574  , drop_incomplet
+00016600: 653d 4661 6c73 6529 0a20 2020 2020 2020  e=False).       
+00016610: 2020 2020 2020 2020 2063 616e 646c 655f           candle_
+00016620: 6c69 6d69 7420 3d20 7365 6c66 2e6f 686c  limit = self.ohl
+00016630: 6376 5f63 616e 646c 655f 6c69 6d69 7428  cv_candle_limit(
+00016640: 7469 6d65 6672 616d 652c 2073 656c 662e  timeframe, self.
+00016650: 5f63 6f6e 6669 675b 2763 616e 646c 655f  _config['candle_
+00016660: 7479 7065 5f64 6566 275d 290a 2020 2020  type_def']).    
+00016670: 2020 2020 2020 2020 2020 2020 2320 4167              # Ag
+00016680: 6520 6f75 7420 6f6c 6420 6361 6e64 6c65  e out old candle
+00016690: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000166a0: 2020 6f68 6c63 765f 6466 203d 206f 686c    ohlcv_df = ohl
+000166b0: 6376 5f64 662e 7461 696c 2863 616e 646c  cv_df.tail(candl
+000166c0: 655f 6c69 6d69 7420 2b20 7365 6c66 2e5f  e_limit + self._
+000166d0: 7374 6172 7475 705f 6361 6e64 6c65 5f63  startup_candle_c
+000166e0: 6f75 6e74 290a 2020 2020 2020 2020 2020  ount).          
+000166f0: 2020 2020 2020 6f68 6c63 765f 6466 203d        ohlcv_df =
+00016700: 206f 686c 6376 5f64 662e 7265 7365 745f   ohlcv_df.reset_
+00016710: 696e 6465 7828 6472 6f70 3d54 7275 6529  index(drop=True)
+00016720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016730: 2073 656c 662e 5f6b 6c69 6e65 735b 2870   self._klines[(p
+00016740: 6169 722c 2074 696d 6566 7261 6d65 2c20  air, timeframe, 
+00016750: 635f 7479 7065 295d 203d 206f 686c 6376  c_type)] = ohlcv
+00016760: 5f64 660a 2020 2020 2020 2020 2020 2020  _df.            
+00016770: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00016780: 2020 2020 2020 7365 6c66 2e5f 6b6c 696e        self._klin
+00016790: 6573 5b28 7061 6972 2c20 7469 6d65 6672  es[(pair, timefr
+000167a0: 616d 652c 2063 5f74 7970 6529 5d20 3d20  ame, c_type)] = 
+000167b0: 6f68 6c63 765f 6466 0a20 2020 2020 2020  ohlcv_df.       
+000167c0: 2072 6574 7572 6e20 6f68 6c63 765f 6466   return ohlcv_df
+000167d0: 0a0a 2020 2020 6465 6620 7265 6672 6573  ..    def refres
+000167e0: 685f 6c61 7465 7374 5f6f 686c 6376 2873  h_latest_ohlcv(s
+000167f0: 656c 662c 2070 6169 725f 6c69 7374 3a20  elf, pair_list: 
+00016800: 4c69 7374 5061 6972 7357 6974 6854 696d  ListPairsWithTim
+00016810: 6566 7261 6d65 732c 202a 2c0a 2020 2020  eframes, *,.    
+00016820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016830: 2020 2020 2020 2020 2073 696e 6365 5f6d           since_m
+00016840: 733a 204f 7074 696f 6e61 6c5b 696e 745d  s: Optional[int]
+00016850: 203d 204e 6f6e 652c 2063 6163 6865 3a20   = None, cache: 
+00016860: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+00016870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016880: 2020 2020 2020 2020 2020 6472 6f70 5f69            drop_i
+00016890: 6e63 6f6d 706c 6574 653a 204f 7074 696f  ncomplete: Optio
+000168a0: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+000168b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000168c0: 2020 2020 2020 2020 2020 2020 2020 2920                ) 
+000168d0: 2d3e 2044 6963 745b 5061 6972 5769 7468  -> Dict[PairWith
+000168e0: 5469 6d65 6672 616d 652c 2044 6174 6146  Timeframe, DataF
+000168f0: 7261 6d65 5d3a 0a20 2020 2020 2020 2022  rame]:.        "
+00016900: 2222 0a20 2020 2020 2020 2052 6566 7265  "".        Refre
+00016910: 7368 2069 6e2d 6d65 6d6f 7279 204f 484c  sh in-memory OHL
+00016920: 4356 2061 7379 6e63 6872 6f6e 6f75 736c  CV asynchronousl
+00016930: 7920 616e 6420 7365 7420 605f 6b6c 696e  y and set `_klin
+00016940: 6573 6020 7769 7468 2074 6865 2072 6573  es` with the res
+00016950: 756c 740a 2020 2020 2020 2020 4c6f 6f70  ult.        Loop
+00016960: 7320 6173 796e 6368 726f 6e6f 7573 6c79  s asynchronously
+00016970: 206f 7665 7220 7061 6972 5f6c 6973 7420   over pair_list 
+00016980: 616e 6420 646f 776e 6c6f 6164 7320 616c  and downloads al
+00016990: 6c20 7061 6972 7320 6173 796e 6320 2873  l pairs async (s
+000169a0: 656d 692d 7061 7261 6c6c 656c 292e 0a20  emi-parallel).. 
+000169b0: 2020 2020 2020 204f 6e6c 7920 7573 6564         Only used
+000169c0: 2069 6e20 7468 6520 6461 7461 7072 6f76   in the dataprov
+000169d0: 6964 6572 2e72 6566 7265 7368 2829 206d  ider.refresh() m
+000169e0: 6574 686f 642e 0a20 2020 2020 2020 203a  ethod..        :
+000169f0: 7061 7261 6d20 7061 6972 5f6c 6973 743a  param pair_list:
+00016a00: 204c 6973 7420 6f66 2032 2065 6c65 6d65   List of 2 eleme
+00016a10: 6e74 2074 7570 6c65 7320 636f 6e74 6169  nt tuples contai
+00016a20: 6e69 6e67 2070 6169 722c 2069 6e74 6572  ning pair, inter
+00016a30: 7661 6c20 746f 2072 6566 7265 7368 0a20  val to refresh. 
+00016a40: 2020 2020 2020 203a 7061 7261 6d20 7369         :param si
+00016a50: 6e63 655f 6d73 3a20 7469 6d65 2073 696e  nce_ms: time sin
+00016a60: 6365 2077 6865 6e20 746f 2064 6f77 6e6c  ce when to downl
+00016a70: 6f61 642c 2069 6e20 6d69 6c6c 6973 6563  oad, in millisec
+00016a80: 6f6e 6473 0a20 2020 2020 2020 203a 7061  onds.        :pa
+00016a90: 7261 6d20 6361 6368 653a 2041 7373 6967  ram cache: Assig
+00016aa0: 6e20 7265 7375 6c74 2074 6f20 5f6b 6c69  n result to _kli
+00016ab0: 6e65 732e 2055 7365 6675 6c6c 2066 6f72  nes. Usefull for
+00016ac0: 206f 6e65 2d6f 6666 2064 6f77 6e6c 6f61   one-off downloa
+00016ad0: 6473 206c 696b 6520 666f 7220 7061 6972  ds like for pair
+00016ae0: 6c69 7374 730a 2020 2020 2020 2020 3a70  lists.        :p
+00016af0: 6172 616d 2064 726f 705f 696e 636f 6d70  aram drop_incomp
+00016b00: 6c65 7465 3a20 436f 6e74 726f 6c20 6361  lete: Control ca
+00016b10: 6e64 6c65 2064 726f 7070 696e 672e 0a20  ndle dropping.. 
+00016b20: 2020 2020 2020 2020 2020 2053 7065 6369             Speci
+00016b30: 6679 696e 6720 4e6f 6e65 2064 6566 6175  fying None defau
+00016b40: 6c74 7320 746f 205f 6f68 6c63 765f 7061  lts to _ohlcv_pa
+00016b50: 7274 6961 6c5f 6361 6e64 6c65 0a20 2020  rtial_candle.   
+00016b60: 2020 2020 203a 7265 7475 726e 3a20 4469       :return: Di
+00016b70: 6374 206f 6620 5b7b 2870 6169 722c 2074  ct of [{(pair, t
+00016b80: 696d 6566 7261 6d65 293a 2044 6174 6166  imeframe): Dataf
+00016b90: 7261 6d65 7d5d 0a20 2020 2020 2020 2022  rame}].        "
+00016ba0: 2222 0a20 2020 2020 2020 206c 6f67 6765  "".        logge
+00016bb0: 722e 6465 6275 6728 2252 6566 7265 7368  r.debug("Refresh
+00016bc0: 696e 6720 6361 6e64 6c65 2028 4f48 4c43  ing candle (OHLC
+00016bd0: 5629 2064 6174 6120 666f 7220 2564 2070  V) data for %d p
+00016be0: 6169 7273 222c 206c 656e 2870 6169 725f  airs", len(pair_
+00016bf0: 6c69 7374 2929 0a0a 2020 2020 2020 2020  list))..        
+00016c00: 2320 4761 7468 6572 2063 6f72 6f75 7469  # Gather corouti
+00016c10: 6e65 7320 746f 2072 756e 0a20 2020 2020  nes to run.     
+00016c20: 2020 2069 6e70 7574 5f63 6f72 6f75 7469     input_corouti
+00016c30: 6e65 732c 2063 6163 6865 645f 7061 6972  nes, cached_pair
+00016c40: 7320 3d20 7365 6c66 2e5f 6275 696c 645f  s = self._build_
+00016c50: 6f68 6c63 765f 646c 5f6a 6f62 7328 7061  ohlcv_dl_jobs(pa
+00016c60: 6972 5f6c 6973 742c 2073 696e 6365 5f6d  ir_list, since_m
+00016c70: 732c 2063 6163 6865 290a 0a20 2020 2020  s, cache)..     
+00016c80: 2020 2072 6573 756c 7473 5f64 6620 3d20     results_df = 
+00016c90: 7b7d 0a20 2020 2020 2020 2023 2043 6875  {}.        # Chu
+00016ca0: 6e6b 2072 6571 7565 7374 7320 696e 746f  nk requests into
+00016cb0: 2062 6174 6368 6573 206f 6620 3130 3020   batches of 100 
+00016cc0: 746f 2061 766f 6964 206f 7665 7277 656c  to avoid overwel
+00016cd0: 6d69 6e67 2063 6378 7420 5468 726f 7474  ming ccxt Thrott
+00016ce0: 6c69 6e67 0a20 2020 2020 2020 2066 6f72  ling.        for
+00016cf0: 2069 6e70 7574 5f63 6f72 6f20 696e 2063   input_coro in c
+00016d00: 6875 6e6b 7328 696e 7075 745f 636f 726f  hunks(input_coro
+00016d10: 7574 696e 6573 2c20 3130 3029 3a0a 2020  utines, 100):.  
+00016d20: 2020 2020 2020 2020 2020 6173 796e 6320            async 
+00016d30: 6465 6620 6761 7468 6572 5f73 7475 6666  def gather_stuff
+00016d40: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00016d50: 2020 2020 7265 7475 726e 2061 7761 6974      return await
+00016d60: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+00016d70: 2a69 6e70 7574 5f63 6f72 6f2c 2072 6574  *input_coro, ret
+00016d80: 7572 6e5f 6578 6365 7074 696f 6e73 3d54  urn_exceptions=T
+00016d90: 7275 6529 0a0a 2020 2020 2020 2020 2020  rue)..          
+00016da0: 2020 7769 7468 2073 656c 662e 5f6c 6f6f    with self._loo
+00016db0: 705f 6c6f 636b 3a0a 2020 2020 2020 2020  p_lock:.        
+00016dc0: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
+00016dd0: 3d20 7365 6c66 2e6c 6f6f 702e 7275 6e5f  = self.loop.run_
+00016de0: 756e 7469 6c5f 636f 6d70 6c65 7465 2867  until_complete(g
+00016df0: 6174 6865 725f 7374 7566 6628 2929 0a0a  ather_stuff())..
+00016e00: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00016e10: 7265 7320 696e 2072 6573 756c 7473 3a0a  res in results:.
+00016e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e30: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+00016e40: 732c 2045 7863 6570 7469 6f6e 293a 0a20  s, Exception):. 
+00016e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e60: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00016e70: 6728 6622 4173 796e 6320 636f 6465 2072  g(f"Async code r
+00016e80: 6169 7365 6420 616e 2065 7863 6570 7469  aised an excepti
+00016e90: 6f6e 3a20 7b72 6570 7228 7265 7329 7d22  on: {repr(res)}"
+00016ea0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016eb0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00016ec0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00016ed0: 2044 6563 6f6e 7374 7275 6374 2074 7570   Deconstruct tup
+00016ee0: 6c65 2028 6861 7320 3520 656c 656d 656e  le (has 5 elemen
+00016ef0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+00016f00: 2020 2020 7061 6972 2c20 7469 6d65 6672      pair, timefr
+00016f10: 616d 652c 2063 5f74 7970 652c 2074 6963  ame, c_type, tic
+00016f20: 6b73 2c20 6472 6f70 5f68 696e 7420 3d20  ks, drop_hint = 
+00016f30: 7265 730a 2020 2020 2020 2020 2020 2020  res.            
+00016f40: 2020 2020 6472 6f70 5f69 6e63 6f6d 706c      drop_incompl
+00016f50: 6574 655f 203d 2064 726f 705f 6869 6e74  ete_ = drop_hint
+00016f60: 2069 6620 6472 6f70 5f69 6e63 6f6d 706c   if drop_incompl
+00016f70: 6574 6520 6973 204e 6f6e 6520 656c 7365  ete is None else
+00016f80: 2064 726f 705f 696e 636f 6d70 6c65 7465   drop_incomplete
+00016f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016fa0: 206f 686c 6376 5f64 6620 3d20 7365 6c66   ohlcv_df = self
+00016fb0: 2e5f 7072 6f63 6573 735f 6f68 6c63 765f  ._process_ohlcv_
+00016fc0: 6466 280a 2020 2020 2020 2020 2020 2020  df(.            
+00016fd0: 2020 2020 2020 2020 7061 6972 2c20 7469          pair, ti
+00016fe0: 6d65 6672 616d 652c 2063 5f74 7970 652c  meframe, c_type,
+00016ff0: 2074 6963 6b73 2c20 6361 6368 652c 2064   ticks, cache, d
+00017000: 726f 705f 696e 636f 6d70 6c65 7465 5f29  rop_incomplete_)
+00017010: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00017020: 2020 7265 7375 6c74 735f 6466 5b28 7061    results_df[(pa
+00017030: 6972 2c20 7469 6d65 6672 616d 652c 2063  ir, timeframe, c
+00017040: 5f74 7970 6529 5d20 3d20 6f68 6c63 765f  _type)] = ohlcv_
+00017050: 6466 0a0a 2020 2020 2020 2020 2320 5265  df..        # Re
+00017060: 7475 726e 2063 6163 6865 6420 6b6c 696e  turn cached klin
+00017070: 6573 0a20 2020 2020 2020 2066 6f72 2070  es.        for p
+00017080: 6169 722c 2074 696d 6566 7261 6d65 2c20  air, timeframe, 
+00017090: 635f 7479 7065 2069 6e20 6361 6368 6564  c_type in cached
+000170a0: 5f70 6169 7273 3a0a 2020 2020 2020 2020  _pairs:.        
+000170b0: 2020 2020 7265 7375 6c74 735f 6466 5b28      results_df[(
+000170c0: 7061 6972 2c20 7469 6d65 6672 616d 652c  pair, timeframe,
+000170d0: 2063 5f74 7970 6529 5d20 3d20 7365 6c66   c_type)] = self
+000170e0: 2e6b 6c69 6e65 7328 0a20 2020 2020 2020  .klines(.       
+000170f0: 2020 2020 2020 2020 2028 7061 6972 2c20           (pair, 
+00017100: 7469 6d65 6672 616d 652c 2063 5f74 7970  timeframe, c_typ
+00017110: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00017120: 2020 2020 636f 7079 3d46 616c 7365 0a20      copy=False. 
+00017130: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00017140: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00017150: 756c 7473 5f64 660a 0a20 2020 2064 6566  ults_df..    def
+00017160: 205f 6e6f 775f 6973 5f74 696d 655f 746f   _now_is_time_to
+00017170: 5f72 6566 7265 7368 2873 656c 662c 2070  _refresh(self, p
+00017180: 6169 723a 2073 7472 2c20 7469 6d65 6672  air: str, timefr
+00017190: 616d 653a 2073 7472 2c20 6361 6e64 6c65  ame: str, candle
+000171a0: 5f74 7970 653a 2043 616e 646c 6554 7970  _type: CandleTyp
+000171b0: 6529 202d 3e20 626f 6f6c 3a0a 2020 2020  e) -> bool:.    
+000171c0: 2020 2020 2320 5469 6d65 6672 616d 6520      # Timeframe 
+000171d0: 696e 2073 6563 6f6e 6473 0a20 2020 2020  in seconds.     
+000171e0: 2020 2069 6e74 6572 7661 6c5f 696e 5f73     interval_in_s
+000171f0: 6563 203d 2074 696d 6566 7261 6d65 5f74  ec = timeframe_t
+00017200: 6f5f 7365 636f 6e64 7328 7469 6d65 6672  o_seconds(timefr
+00017210: 616d 6529 0a20 2020 2020 2020 2070 6c72  ame).        plr
+00017220: 203d 2073 656c 662e 5f70 6169 7273 5f6c   = self._pairs_l
+00017230: 6173 745f 7265 6672 6573 685f 7469 6d65  ast_refresh_time
+00017240: 2e67 6574 2828 7061 6972 2c20 7469 6d65  .get((pair, time
+00017250: 6672 616d 652c 2063 616e 646c 655f 7479  frame, candle_ty
+00017260: 7065 292c 2030 2920 2b20 696e 7465 7276  pe), 0) + interv
+00017270: 616c 5f69 6e5f 7365 630a 2020 2020 2020  al_in_sec.      
+00017280: 2020 2320 6375 7272 656e 742c 6163 7469    # current,acti
+00017290: 7665 2063 616e 646c 6520 6f70 656e 2064  ve candle open d
+000172a0: 6174 650a 2020 2020 2020 2020 6e6f 7720  ate.        now 
+000172b0: 3d20 696e 7428 7469 6d65 6672 616d 655f  = int(timeframe_
+000172c0: 746f 5f70 7265 765f 6461 7465 2874 696d  to_prev_date(tim
+000172d0: 6566 7261 6d65 292e 7469 6d65 7374 616d  eframe).timestam
+000172e0: 7028 2929 0a20 2020 2020 2020 2072 6574  p()).        ret
+000172f0: 7572 6e20 706c 7220 3c20 6e6f 770a 0a20  urn plr < now.. 
+00017300: 2020 2040 7265 7472 6965 725f 6173 796e     @retrier_asyn
+00017310: 630a 2020 2020 6173 796e 6320 6465 6620  c.    async def 
+00017320: 5f61 7379 6e63 5f67 6574 5f63 616e 646c  _async_get_candl
+00017330: 655f 6869 7374 6f72 7928 0a20 2020 2020  e_history(.     
+00017340: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00017350: 2070 6169 723a 2073 7472 2c0a 2020 2020   pair: str,.    
+00017360: 2020 2020 7469 6d65 6672 616d 653a 2073      timeframe: s
+00017370: 7472 2c0a 2020 2020 2020 2020 6361 6e64  tr,.        cand
+00017380: 6c65 5f74 7970 653a 2043 616e 646c 6554  le_type: CandleT
+00017390: 7970 652c 0a20 2020 2020 2020 2073 696e  ype,.        sin
+000173a0: 6365 5f6d 733a 204f 7074 696f 6e61 6c5b  ce_ms: Optional[
+000173b0: 696e 745d 203d 204e 6f6e 652c 0a20 2020  int] = None,.   
+000173c0: 2029 202d 3e20 4f48 4c43 5652 6573 706f   ) -> OHLCVRespo
+000173d0: 6e73 653a 0a20 2020 2020 2020 2022 2222  nse:.        """
+000173e0: 0a20 2020 2020 2020 2041 7379 6e63 6872  .        Asynchr
+000173f0: 6f6e 6f75 736c 7920 6765 7420 6361 6e64  onously get cand
+00017400: 6c65 2068 6973 746f 7279 2064 6174 6120  le history data 
+00017410: 7573 696e 6720 6665 7463 685f 6f68 6c63  using fetch_ohlc
+00017420: 760a 2020 2020 2020 2020 3a70 6172 616d  v.        :param
+00017430: 2063 616e 646c 655f 7479 7065 3a20 2727   candle_type: ''
+00017440: 2c20 6d61 726b 2c20 696e 6465 782c 2070  , mark, index, p
+00017450: 7265 6d69 756d 496e 6465 782c 206f 7220  remiumIndex, or 
+00017460: 6675 6e64 696e 675f 7261 7465 0a20 2020  funding_rate.   
+00017470: 2020 2020 2072 6574 7572 6e73 2074 7570       returns tup
+00017480: 6c65 3a20 2870 6169 722c 2074 696d 6566  le: (pair, timef
+00017490: 7261 6d65 2c20 6f68 6c63 765f 6c69 7374  rame, ohlcv_list
+000174a0: 290a 2020 2020 2020 2020 2222 220a 2020  ).        """.  
+000174b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000174c0: 2020 2020 2020 2023 2046 6574 6368 204f         # Fetch O
+000174d0: 484c 4356 2061 7379 6e63 6872 6f6e 6f75  HLCV asynchronou
+000174e0: 736c 790a 2020 2020 2020 2020 2020 2020  sly.            
+000174f0: 7320 3d20 2728 2720 2b20 6474 5f66 726f  s = '(' + dt_fro
+00017500: 6d5f 7473 2873 696e 6365 5f6d 7329 2e69  m_ts(since_ms).i
+00017510: 736f 666f 726d 6174 2829 202b 2027 2920  soformat() + ') 
+00017520: 2720 6966 2073 696e 6365 5f6d 7320 6973  ' if since_ms is
+00017530: 206e 6f74 204e 6f6e 6520 656c 7365 2027   not None else '
+00017540: 270a 2020 2020 2020 2020 2020 2020 6c6f  '.            lo
+00017550: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
+00017560: 2020 2020 2020 2020 2020 2020 2246 6574              "Fet
+00017570: 6368 696e 6720 7061 6972 2025 732c 2025  ching pair %s, %
+00017580: 732c 2069 6e74 6572 7661 6c20 2573 2c20  s, interval %s, 
+00017590: 7369 6e63 6520 2573 2025 732e 2e2e 222c  since %s %s...",
+000175a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000175b0: 2070 6169 722c 2063 616e 646c 655f 7479   pair, candle_ty
+000175c0: 7065 2c20 7469 6d65 6672 616d 652c 2073  pe, timeframe, s
+000175d0: 696e 6365 5f6d 732c 2073 0a20 2020 2020  ince_ms, s.     
+000175e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000175f0: 2020 2020 2070 6172 616d 7320 3d20 6465       params = de
+00017600: 6570 636f 7079 2873 656c 662e 5f66 745f  epcopy(self._ft_
+00017610: 6861 732e 6765 7428 276f 686c 6376 5f70  has.get('ohlcv_p
+00017620: 6172 616d 7327 2c20 7b7d 2929 0a20 2020  arams', {})).   
+00017630: 2020 2020 2020 2020 2063 616e 646c 655f           candle_
+00017640: 6c69 6d69 7420 3d20 7365 6c66 2e6f 686c  limit = self.ohl
+00017650: 6376 5f63 616e 646c 655f 6c69 6d69 7428  cv_candle_limit(
+00017660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017670: 2074 696d 6566 7261 6d65 2c20 6361 6e64   timeframe, cand
+00017680: 6c65 5f74 7970 653d 6361 6e64 6c65 5f74  le_type=candle_t
+00017690: 7970 652c 2073 696e 6365 5f6d 733d 7369  ype, since_ms=si
+000176a0: 6e63 655f 6d73 290a 0a20 2020 2020 2020  nce_ms)..       
+000176b0: 2020 2020 2069 6620 6361 6e64 6c65 5f74       if candle_t
+000176c0: 7970 6520 616e 6420 6361 6e64 6c65 5f74  ype and candle_t
+000176d0: 7970 6520 213d 2043 616e 646c 6554 7970  ype != CandleTyp
+000176e0: 652e 5350 4f54 3a0a 2020 2020 2020 2020  e.SPOT:.        
+000176f0: 2020 2020 2020 2020 7061 7261 6d73 2e75          params.u
+00017700: 7064 6174 6528 7b27 7072 6963 6527 3a20  pdate({'price': 
+00017710: 6361 6e64 6c65 5f74 7970 652e 7661 6c75  candle_type.valu
+00017720: 657d 290a 2020 2020 2020 2020 2020 2020  e}).            
+00017730: 6966 2063 616e 646c 655f 7479 7065 2021  if candle_type !
+00017740: 3d20 4361 6e64 6c65 5479 7065 2e46 554e  = CandleType.FUN
+00017750: 4449 4e47 5f52 4154 453a 0a20 2020 2020  DING_RATE:.     
+00017760: 2020 2020 2020 2020 2020 2064 6174 6120             data 
+00017770: 3d20 6177 6169 7420 7365 6c66 2e5f 6170  = await self._ap
+00017780: 695f 6173 796e 632e 6665 7463 685f 6f68  i_async.fetch_oh
+00017790: 6c63 7628 0a20 2020 2020 2020 2020 2020  lcv(.           
+000177a0: 2020 2020 2020 2020 2070 6169 722c 2074           pair, t
+000177b0: 696d 6566 7261 6d65 3d74 696d 6566 7261  imeframe=timefra
+000177c0: 6d65 2c20 7369 6e63 653d 7369 6e63 655f  me, since=since_
+000177d0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+000177e0: 2020 2020 2020 2020 6c69 6d69 743d 6361          limit=ca
+000177f0: 6e64 6c65 5f6c 696d 6974 2c20 7061 7261  ndle_limit, para
+00017800: 6d73 3d70 6172 616d 7329 0a20 2020 2020  ms=params).     
+00017810: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00017820: 2020 2020 2020 2020 2020 2020 2023 2046               # F
+00017830: 756e 6469 6e67 2072 6174 650a 2020 2020  unding rate.    
+00017840: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00017850: 203d 2061 7761 6974 2073 656c 662e 5f66   = await self._f
+00017860: 6574 6368 5f66 756e 6469 6e67 5f72 6174  etch_funding_rat
+00017870: 655f 6869 7374 6f72 7928 0a20 2020 2020  e_history(.     
+00017880: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00017890: 6169 723d 7061 6972 2c0a 2020 2020 2020  air=pair,.      
+000178a0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+000178b0: 6d65 6672 616d 653d 7469 6d65 6672 616d  meframe=timefram
+000178c0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000178d0: 2020 2020 2020 206c 696d 6974 3d63 616e         limit=can
+000178e0: 646c 655f 6c69 6d69 742c 0a20 2020 2020  dle_limit,.     
+000178f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00017900: 696e 6365 5f6d 733d 7369 6e63 655f 6d73  ince_ms=since_ms
+00017910: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017920: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00017930: 2320 536f 6d65 2065 7863 6861 6e67 6573  # Some exchanges
+00017940: 2073 6f72 7420 4f48 4c43 5620 696e 2041   sort OHLCV in A
+00017950: 5343 206f 7264 6572 2061 6e64 206f 7468  SC order and oth
+00017960: 6572 7320 696e 2044 4553 432e 0a20 2020  ers in DESC..   
+00017970: 2020 2020 2020 2020 2023 2045 783a 2042           # Ex: B
+00017980: 6974 7472 6578 2072 6574 7572 6e73 2074  ittrex returns t
+00017990: 6865 206c 6973 7420 6f66 204f 484c 4356  he list of OHLCV
+000179a0: 2069 6e20 4153 4320 6f72 6465 7220 286f   in ASC order (o
+000179b0: 6c64 6573 7420 6669 7273 742c 206e 6577  ldest first, new
+000179c0: 6573 7420 6c61 7374 290a 2020 2020 2020  est last).      
+000179d0: 2020 2020 2020 2320 7768 696c 6520 4744        # while GD
+000179e0: 4158 2072 6574 7572 6e73 2074 6865 206c  AX returns the l
+000179f0: 6973 7420 6f66 204f 484c 4356 2069 6e20  ist of OHLCV in 
+00017a00: 4445 5343 206f 7264 6572 2028 6e65 7765  DESC order (newe
+00017a10: 7374 2066 6972 7374 2c20 6f6c 6465 7374  st first, oldest
+00017a20: 206c 6173 7429 0a20 2020 2020 2020 2020   last).         
+00017a30: 2020 2023 204f 6e6c 7920 736f 7274 2069     # Only sort i
+00017a40: 6620 6e65 6365 7373 6172 7920 746f 2073  f necessary to s
+00017a50: 6176 6520 636f 6d70 7574 696e 6720 7469  ave computing ti
+00017a60: 6d65 0a20 2020 2020 2020 2020 2020 2074  me.            t
+00017a70: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00017a80: 2020 2020 6966 2064 6174 6120 616e 6420      if data and 
+00017a90: 6461 7461 5b30 5d5b 305d 203e 2064 6174  data[0][0] > dat
+00017aa0: 615b 2d31 5d5b 305d 3a0a 2020 2020 2020  a[-1][0]:.      
+00017ab0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00017ac0: 7461 203d 2073 6f72 7465 6428 6461 7461  ta = sorted(data
+00017ad0: 2c20 6b65 793d 6c61 6d62 6461 2078 3a20  , key=lambda x: 
+00017ae0: 785b 305d 290a 2020 2020 2020 2020 2020  x[0]).          
+00017af0: 2020 6578 6365 7074 2049 6e64 6578 4572    except IndexEr
+00017b00: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+00017b10: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
+00017b20: 7074 696f 6e28 2245 7272 6f72 206c 6f61  ption("Error loa
+00017b30: 6469 6e67 2025 732e 2052 6573 756c 7420  ding %s. Result 
+00017b40: 7761 7320 2573 2e22 2c20 7061 6972 2c20  was %s.", pair, 
+00017b50: 6461 7461 290a 2020 2020 2020 2020 2020  data).          
+00017b60: 2020 2020 2020 7265 7475 726e 2070 6169        return pai
+00017b70: 722c 2074 696d 6566 7261 6d65 2c20 6361  r, timeframe, ca
+00017b80: 6e64 6c65 5f74 7970 652c 205b 5d2c 2073  ndle_type, [], s
+00017b90: 656c 662e 5f6f 686c 6376 5f70 6172 7469  elf._ohlcv_parti
+00017ba0: 616c 5f63 616e 646c 650a 2020 2020 2020  al_candle.      
+00017bb0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+00017bc0: 7567 2822 446f 6e65 2066 6574 6368 696e  ug("Done fetchin
+00017bd0: 6720 7061 6972 2025 732c 2069 6e74 6572  g pair %s, inter
+00017be0: 7661 6c20 2573 202e 2e2e 222c 2070 6169  val %s ...", pai
+00017bf0: 722c 2074 696d 6566 7261 6d65 290a 2020  r, timeframe).  
+00017c00: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00017c10: 2070 6169 722c 2074 696d 6566 7261 6d65   pair, timeframe
+00017c20: 2c20 6361 6e64 6c65 5f74 7970 652c 2064  , candle_type, d
+00017c30: 6174 612c 2073 656c 662e 5f6f 686c 6376  ata, self._ohlcv
+00017c40: 5f70 6172 7469 616c 5f63 616e 646c 650a  _partial_candle.
+00017c50: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00017c60: 6363 7874 2e4e 6f74 5375 7070 6f72 7465  ccxt.NotSupporte
+00017c70: 6420 6173 2065 3a0a 2020 2020 2020 2020  d as e:.        
+00017c80: 2020 2020 7261 6973 6520 4f70 6572 6174      raise Operat
+00017c90: 696f 6e61 6c45 7863 6570 7469 6f6e 280a  ionalException(.
+00017ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017cb0: 6627 4578 6368 616e 6765 207b 7365 6c66  f'Exchange {self
+00017cc0: 2e5f 6170 692e 6e61 6d65 7d20 646f 6573  ._api.name} does
+00017cd0: 206e 6f74 2073 7570 706f 7274 2066 6574   not support fet
+00017ce0: 6368 696e 6720 6869 7374 6f72 6963 616c  ching historical
+00017cf0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00017d00: 2020 2066 2763 616e 646c 6520 284f 484c     f'candle (OHL
+00017d10: 4356 2920 6461 7461 2e20 4d65 7373 6167  CV) data. Messag
+00017d20: 653a 207b 657d 2729 2066 726f 6d20 650a  e: {e}') from e.
+00017d30: 2020 2020 2020 2020 6578 6365 7074 2063          except c
+00017d40: 6378 742e 4444 6f53 5072 6f74 6563 7469  cxt.DDoSProtecti
+00017d50: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+00017d60: 2020 2020 2072 6169 7365 2044 446f 7350       raise DDosP
+00017d70: 726f 7465 6374 696f 6e28 6529 2066 726f  rotection(e) fro
+00017d80: 6d20 650a 2020 2020 2020 2020 6578 6365  m e.        exce
+00017d90: 7074 2028 6363 7874 2e4e 6574 776f 726b  pt (ccxt.Network
+00017da0: 4572 726f 722c 2063 6378 742e 4578 6368  Error, ccxt.Exch
+00017db0: 616e 6765 4572 726f 7229 2061 7320 653a  angeError) as e:
+00017dc0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00017dd0: 7365 2054 656d 706f 7261 7279 4572 726f  se TemporaryErro
+00017de0: 7228 6627 436f 756c 6420 6e6f 7420 6665  r(f'Could not fe
+00017df0: 7463 6820 6869 7374 6f72 6963 616c 2063  tch historical c
+00017e00: 616e 646c 6520 284f 484c 4356 2920 6461  andle (OHLCV) da
+00017e10: 7461 2027 0a20 2020 2020 2020 2020 2020  ta '.           
+00017e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e30: 2020 2020 2020 6627 666f 7220 7061 6972        f'for pair
+00017e40: 207b 7061 6972 7d20 6475 6520 746f 207b   {pair} due to {
+00017e50: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
+00017e60: 6d65 5f5f 7d2e 2027 0a20 2020 2020 2020  me__}. '.       
+00017e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e80: 2020 2020 2020 2020 2020 6627 4d65 7373            f'Mess
+00017e90: 6167 653a 207b 657d 2729 2066 726f 6d20  age: {e}') from 
+00017ea0: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
+00017eb0: 2063 6378 742e 4261 7365 4572 726f 7220   ccxt.BaseError 
+00017ec0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00017ed0: 2020 7261 6973 6520 4f70 6572 6174 696f    raise Operatio
+00017ee0: 6e61 6c45 7863 6570 7469 6f6e 2866 2743  nalException(f'C
+00017ef0: 6f75 6c64 206e 6f74 2066 6574 6368 2068  ould not fetch h
+00017f00: 6973 746f 7269 6361 6c20 6361 6e64 6c65  istorical candle
+00017f10: 2028 4f48 4c43 5629 2064 6174 6120 270a   (OHLCV) data '.
+00017f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f40: 2020 2020 2020 2066 2766 6f72 2070 6169         f'for pai
+00017f50: 7220 7b70 6169 727d 2e20 4d65 7373 6167  r {pair}. Messag
+00017f60: 653a 207b 657d 2729 2066 726f 6d20 650a  e: {e}') from e.
+00017f70: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
+00017f80: 6665 7463 685f 6675 6e64 696e 675f 7261  fetch_funding_ra
+00017f90: 7465 5f68 6973 746f 7279 280a 2020 2020  te_history(.    
+00017fa0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00017fb0: 2020 7061 6972 3a20 7374 722c 0a20 2020    pair: str,.   
+00017fc0: 2020 2020 2074 696d 6566 7261 6d65 3a20       timeframe: 
+00017fd0: 7374 722c 0a20 2020 2020 2020 206c 696d  str,.        lim
+00017fe0: 6974 3a20 696e 742c 0a20 2020 2020 2020  it: int,.       
+00017ff0: 2073 696e 6365 5f6d 733a 204f 7074 696f   since_ms: Optio
+00018000: 6e61 6c5b 696e 745d 203d 204e 6f6e 652c  nal[int] = None,
+00018010: 0a20 2020 2029 202d 3e20 4c69 7374 5b4c  .    ) -> List[L
+00018020: 6973 745d 3a0a 2020 2020 2020 2020 2222  ist]:.        ""
+00018030: 220a 2020 2020 2020 2020 4665 7463 6820  ".        Fetch 
+00018040: 6675 6e64 696e 6720 7261 7465 2068 6973  funding rate his
+00018050: 746f 7279 202d 2075 7365 6420 746f 2073  tory - used to s
+00018060: 656c 6563 7469 7665 6c79 206f 7665 7272  electively overr
+00018070: 6964 6520 7468 6973 2062 7920 7375 6263  ide this by subc
+00018080: 6c61 7373 6573 2e0a 2020 2020 2020 2020  lasses..        
+00018090: 2222 220a 2020 2020 2020 2020 2320 4675  """.        # Fu
+000180a0: 6e64 696e 6720 7261 7465 0a20 2020 2020  nding rate.     
+000180b0: 2020 2064 6174 6120 3d20 6177 6169 7420     data = await 
+000180c0: 7365 6c66 2e5f 6170 695f 6173 796e 632e  self._api_async.
+000180d0: 6665 7463 685f 6675 6e64 696e 675f 7261  fetch_funding_ra
+000180e0: 7465 5f68 6973 746f 7279 280a 2020 2020  te_history(.    
+000180f0: 2020 2020 2020 2020 7061 6972 2c20 7369          pair, si
+00018100: 6e63 653d 7369 6e63 655f 6d73 2c0a 2020  nce=since_ms,.  
+00018110: 2020 2020 2020 2020 2020 6c69 6d69 743d            limit=
+00018120: 6c69 6d69 7429 0a20 2020 2020 2020 2023  limit).        #
+00018130: 2043 6f6e 7665 7274 2066 756e 6469 6e67   Convert funding
+00018140: 2072 6174 6520 746f 2063 616e 646c 6520   rate to candle 
+00018150: 7061 7474 6572 6e0a 2020 2020 2020 2020  pattern.        
+00018160: 6461 7461 203d 205b 5b78 5b27 7469 6d65  data = [[x['time
+00018170: 7374 616d 7027 5d2c 2078 5b27 6675 6e64  stamp'], x['fund
+00018180: 696e 6752 6174 6527 5d2c 2030 2c20 302c  ingRate'], 0, 0,
+00018190: 2030 2c20 305d 2066 6f72 2078 2069 6e20   0, 0] for x in 
+000181a0: 6461 7461 5d0a 2020 2020 2020 2020 7265  data].        re
+000181b0: 7475 726e 2064 6174 610a 0a20 2020 2023  turn data..    #
+000181c0: 2046 6574 6368 2068 6973 746f 7269 6320   Fetch historic 
+000181d0: 7472 6164 6573 0a0a 2020 2020 4072 6574  trades..    @ret
+000181e0: 7269 6572 5f61 7379 6e63 0a20 2020 2061  rier_async.    a
+000181f0: 7379 6e63 2064 6566 205f 6173 796e 635f  sync def _async_
+00018200: 6665 7463 685f 7472 6164 6573 2873 656c  fetch_trades(sel
+00018210: 662c 2070 6169 723a 2073 7472 2c0a 2020  f, pair: str,.  
+00018220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018240: 7369 6e63 653a 204f 7074 696f 6e61 6c5b  since: Optional[
+00018250: 696e 745d 203d 204e 6f6e 652c 0a20 2020  int] = None,.   
+00018260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018270: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00018280: 6172 616d 733a 204f 7074 696f 6e61 6c5b  arams: Optional[
+00018290: 6469 6374 5d20 3d20 4e6f 6e65 2920 2d3e  dict] = None) ->
+000182a0: 204c 6973 745b 4c69 7374 5d3a 0a20 2020   List[List]:.   
+000182b0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000182c0: 2041 7379 6e63 726f 6e6f 7573 6c79 2067   Asyncronously g
+000182d0: 6574 7320 7472 6164 6520 6869 7374 6f72  ets trade histor
+000182e0: 7920 7573 696e 6720 6665 7463 685f 7472  y using fetch_tr
+000182f0: 6164 6573 2e0a 2020 2020 2020 2020 4861  ades..        Ha
+00018300: 6e64 6c65 7320 6578 6368 616e 6765 2065  ndles exchange e
+00018310: 7272 6f72 732c 2064 6f65 7320 6f6e 6520  rrors, does one 
+00018320: 6361 6c6c 2074 6f20 7468 6520 6578 6368  call to the exch
+00018330: 616e 6765 2e0a 2020 2020 2020 2020 3a70  ange..        :p
+00018340: 6172 616d 2070 6169 723a 2050 6169 7220  aram pair: Pair 
+00018350: 746f 2066 6574 6368 2074 7261 6465 2064  to fetch trade d
+00018360: 6174 6120 666f 720a 2020 2020 2020 2020  ata for.        
+00018370: 3a70 6172 616d 2073 696e 6365 3a20 5369  :param since: Si
+00018380: 6e63 6520 6173 2069 6e74 6567 6572 2074  nce as integer t
+00018390: 696d 6573 7461 6d70 2069 6e20 6d69 6c6c  imestamp in mill
+000183a0: 6973 6563 6f6e 6473 0a20 2020 2020 2020  iseconds.       
+000183b0: 2072 6574 7572 6e73 3a20 4c69 7374 206f   returns: List o
+000183c0: 6620 6469 6374 7320 636f 6e74 6169 6e69  f dicts containi
+000183d0: 6e67 2074 7261 6465 730a 2020 2020 2020  ng trades.      
+000183e0: 2020 2222 220a 2020 2020 2020 2020 7472    """.        tr
+000183f0: 793a 0a20 2020 2020 2020 2020 2020 2023  y:.            #
+00018400: 2066 6574 6368 2074 7261 6465 7320 6173   fetch trades as
+00018410: 796e 6368 726f 6e6f 7573 6c79 0a20 2020  ynchronously.   
+00018420: 2020 2020 2020 2020 2069 6620 7061 7261           if para
+00018430: 6d73 3a0a 2020 2020 2020 2020 2020 2020  ms:.            
+00018440: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00018450: 2822 4665 7463 6869 6e67 2074 7261 6465  ("Fetching trade
+00018460: 7320 666f 7220 7061 6972 2025 732c 2070  s for pair %s, p
+00018470: 6172 616d 733a 2025 7320 222c 2070 6169  arams: %s ", pai
+00018480: 722c 2070 6172 616d 7329 0a20 2020 2020  r, params).     
+00018490: 2020 2020 2020 2020 2020 2074 7261 6465             trade
+000184a0: 7320 3d20 6177 6169 7420 7365 6c66 2e5f  s = await self._
+000184b0: 6170 695f 6173 796e 632e 6665 7463 685f  api_async.fetch_
+000184c0: 7472 6164 6573 2870 6169 722c 2070 6172  trades(pair, par
+000184d0: 616d 733d 7061 7261 6d73 2c20 6c69 6d69  ams=params, limi
+000184e0: 743d 3130 3030 290a 2020 2020 2020 2020  t=1000).        
+000184f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00018500: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00018510: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00018520: 2020 2020 2020 2020 2020 2020 2246 6574              "Fet
+00018530: 6368 696e 6720 7472 6164 6573 2066 6f72  ching trades for
+00018540: 2070 6169 7220 2573 2c20 7369 6e63 6520   pair %s, since 
+00018550: 2573 2025 732e 2e2e 222c 0a20 2020 2020  %s %s...",.     
+00018560: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00018570: 6169 722c 2073 696e 6365 2c0a 2020 2020  air, since,.    
+00018580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018590: 2728 2720 2b20 6474 5f66 726f 6d5f 7473  '(' + dt_from_ts
+000185a0: 2873 696e 6365 292e 6973 6f66 6f72 6d61  (since).isoforma
+000185b0: 7428 2920 2b20 2729 2027 2069 6620 7369  t() + ') ' if si
+000185c0: 6e63 6520 6973 206e 6f74 204e 6f6e 6520  nce is not None 
+000185d0: 656c 7365 2027 270a 2020 2020 2020 2020  else ''.        
+000185e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000185f0: 2020 2020 2020 2020 2020 7472 6164 6573            trades
+00018600: 203d 2061 7761 6974 2073 656c 662e 5f61   = await self._a
+00018610: 7069 5f61 7379 6e63 2e66 6574 6368 5f74  pi_async.fetch_t
+00018620: 7261 6465 7328 7061 6972 2c20 7369 6e63  rades(pair, sinc
+00018630: 653d 7369 6e63 652c 206c 696d 6974 3d31  e=since, limit=1
+00018640: 3030 3029 0a20 2020 2020 2020 2020 2020  000).           
+00018650: 2074 7261 6465 7320 3d20 7365 6c66 2e5f   trades = self._
+00018660: 7472 6164 6573 5f63 6f6e 7472 6163 7473  trades_contracts
+00018670: 5f74 6f5f 616d 6f75 6e74 2874 7261 6465  _to_amount(trade
+00018680: 7329 0a20 2020 2020 2020 2020 2020 2072  s).            r
+00018690: 6574 7572 6e20 7472 6164 6573 5f64 6963  eturn trades_dic
+000186a0: 745f 746f 5f6c 6973 7428 7472 6164 6573  t_to_list(trades
+000186b0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+000186c0: 2063 6378 742e 4e6f 7453 7570 706f 7274   ccxt.NotSupport
+000186d0: 6564 2061 7320 653a 0a20 2020 2020 2020  ed as e:.       
+000186e0: 2020 2020 2072 6169 7365 204f 7065 7261       raise Opera
+000186f0: 7469 6f6e 616c 4578 6365 7074 696f 6e28  tionalException(
+00018700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018710: 2066 2745 7863 6861 6e67 6520 7b73 656c   f'Exchange {sel
+00018720: 662e 5f61 7069 2e6e 616d 657d 2064 6f65  f._api.name} doe
+00018730: 7320 6e6f 7420 7375 7070 6f72 7420 6665  s not support fe
+00018740: 7463 6869 6e67 2068 6973 746f 7269 6361  tching historica
+00018750: 6c20 7472 6164 6520 6461 7461 2e27 0a20  l trade data.'. 
+00018760: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00018770: 274d 6573 7361 6765 3a20 7b65 7d27 2920  'Message: {e}') 
+00018780: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
+00018790: 7863 6570 7420 6363 7874 2e44 446f 5350  xcept ccxt.DDoSP
+000187a0: 726f 7465 6374 696f 6e20 6173 2065 3a0a  rotection as e:.
+000187b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000187c0: 6520 4444 6f73 5072 6f74 6563 7469 6f6e  e DDosProtection
+000187d0: 2865 2920 6672 6f6d 2065 0a20 2020 2020  (e) from e.     
+000187e0: 2020 2065 7863 6570 7420 2863 6378 742e     except (ccxt.
+000187f0: 4e65 7477 6f72 6b45 7272 6f72 2c20 6363  NetworkError, cc
+00018800: 7874 2e45 7863 6861 6e67 6545 7272 6f72  xt.ExchangeError
+00018810: 2920 6173 2065 3a0a 2020 2020 2020 2020  ) as e:.        
+00018820: 2020 2020 7261 6973 6520 5465 6d70 6f72      raise Tempor
+00018830: 6172 7945 7272 6f72 2866 2743 6f75 6c64  aryError(f'Could
+00018840: 206e 6f74 206c 6f61 6420 7472 6164 6520   not load trade 
+00018850: 6869 7374 6f72 7920 6475 6520 746f 207b  history due to {
+00018860: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
+00018870: 6d65 5f5f 7d2e 2027 0a20 2020 2020 2020  me__}. '.       
+00018880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018890: 2020 2020 2020 2020 2020 6627 4d65 7373            f'Mess
+000188a0: 6167 653a 207b 657d 2729 2066 726f 6d20  age: {e}') from 
+000188b0: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
+000188c0: 2063 6378 742e 4261 7365 4572 726f 7220   ccxt.BaseError 
+000188d0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+000188e0: 2020 7261 6973 6520 4f70 6572 6174 696f    raise Operatio
+000188f0: 6e61 6c45 7863 6570 7469 6f6e 2866 2743  nalException(f'C
+00018900: 6f75 6c64 206e 6f74 2066 6574 6368 2074  ould not fetch t
+00018910: 7261 6465 2064 6174 612e 204d 7367 3a20  rade data. Msg: 
+00018920: 7b65 7d27 2920 6672 6f6d 2065 0a0a 2020  {e}') from e..  
+00018930: 2020 6173 796e 6320 6465 6620 5f61 7379    async def _asy
+00018940: 6e63 5f67 6574 5f74 7261 6465 5f68 6973  nc_get_trade_his
+00018950: 746f 7279 5f69 6428 7365 6c66 2c20 7061  tory_id(self, pa
+00018960: 6972 3a20 7374 722c 0a20 2020 2020 2020  ir: str,.       
 00018970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018980: 6272 6561 6b0a 0a20 2020 2020 2020 2072  break..        r
-00018990: 6574 7572 6e20 2870 6169 722c 2074 7261  eturn (pair, tra
-000189a0: 6465 7329 0a0a 2020 2020 6173 796e 6320  des)..    async 
-000189b0: 6465 6620 5f61 7379 6e63 5f67 6574 5f74  def _async_get_t
-000189c0: 7261 6465 5f68 6973 746f 7279 5f74 696d  rade_history_tim
-000189d0: 6528 7365 6c66 2c20 7061 6972 3a20 7374  e(self, pair: st
-000189e0: 722c 2075 6e74 696c 3a20 696e 742c 0a20  r, until: int,. 
+00018980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018990: 2020 2075 6e74 696c 3a20 696e 742c 0a20     until: int,. 
+000189a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189c0: 2020 2020 2020 2020 2073 696e 6365 3a20           since: 
+000189d0: 4f70 7469 6f6e 616c 5b69 6e74 5d20 3d20  Optional[int] = 
+000189e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
 000189f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00018a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a10: 2020 2020 2020 2020 2020 2073 696e 6365             since
-00018a20: 3a20 4f70 7469 6f6e 616c 5b69 6e74 5d20  : Optional[int] 
-00018a30: 3d20 4e6f 6e65 2920 2d3e 2054 7570 6c65  = None) -> Tuple
-00018a40: 5b73 7472 2c20 4c69 7374 5b4c 6973 745d  [str, List[List]
-00018a50: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
-00018a60: 2020 2020 2020 2041 7379 6e63 726f 6e6f         Asyncrono
-00018a70: 7573 6c79 2067 6574 7320 7472 6164 6520  usly gets trade 
-00018a80: 6869 7374 6f72 7920 7573 696e 6720 6665  history using fe
-00018a90: 7463 685f 7472 6164 6573 2c0a 2020 2020  tch_trades,.    
-00018aa0: 2020 2020 7768 656e 2074 6865 2065 7863      when the exc
-00018ab0: 6861 6e67 6520 7573 6573 2074 696d 652d  hange uses time-
-00018ac0: 6261 7365 6420 6974 6572 6174 696f 6e20  based iteration 
-00018ad0: 2863 6865 636b 2060 7365 6c66 2e5f 7472  (check `self._tr
-00018ae0: 6164 6573 5f70 6167 696e 6174 696f 6e60  ades_pagination`
-00018af0: 290a 2020 2020 2020 2020 3a70 6172 616d  ).        :param
-00018b00: 2070 6169 723a 2050 6169 7220 746f 2066   pair: Pair to f
-00018b10: 6574 6368 2074 7261 6465 2064 6174 6120  etch trade data 
-00018b20: 666f 720a 2020 2020 2020 2020 3a70 6172  for.        :par
-00018b30: 616d 2073 696e 6365 3a20 5369 6e63 6520  am since: Since 
-00018b40: 6173 2069 6e74 6567 6572 2074 696d 6573  as integer times
-00018b50: 7461 6d70 2069 6e20 6d69 6c6c 6973 6563  tamp in millisec
-00018b60: 6f6e 6473 0a20 2020 2020 2020 203a 7061  onds.        :pa
-00018b70: 7261 6d20 756e 7469 6c3a 2055 6e74 696c  ram until: Until
-00018b80: 2061 7320 696e 7465 6765 7220 7469 6d65   as integer time
-00018b90: 7374 616d 7020 696e 206d 696c 6c69 7365  stamp in millise
-00018ba0: 636f 6e64 730a 2020 2020 2020 2020 7265  conds.        re
-00018bb0: 7475 726e 7320 7475 706c 653a 2028 7061  turns tuple: (pa
-00018bc0: 6972 2c20 7472 6164 6573 2d6c 6973 7429  ir, trades-list)
-00018bd0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-00018be0: 2020 2020 2020 7472 6164 6573 3a20 4c69        trades: Li
-00018bf0: 7374 5b4c 6973 745d 203d 205b 5d0a 2020  st[List] = [].  
-00018c00: 2020 2020 2020 2320 4445 4641 554c 545f        # DEFAULT_
-00018c10: 5452 4144 4553 5f43 4f4c 554d 4e53 3a20  TRADES_COLUMNS: 
-00018c20: 3020 2d3e 2074 696d 6573 7461 6d70 0a20  0 -> timestamp. 
-00018c30: 2020 2020 2020 2023 2044 4546 4155 4c54         # DEFAULT
-00018c40: 5f54 5241 4445 535f 434f 4c55 4d4e 533a  _TRADES_COLUMNS:
-00018c50: 2031 202d 3e20 6964 0a20 2020 2020 2020   1 -> id.       
-00018c60: 2077 6869 6c65 2054 7275 653a 0a20 2020   while True:.   
-00018c70: 2020 2020 2020 2020 2074 203d 2061 7761           t = awa
-00018c80: 6974 2073 656c 662e 5f61 7379 6e63 5f66  it self._async_f
-00018c90: 6574 6368 5f74 7261 6465 7328 7061 6972  etch_trades(pair
-00018ca0: 2c20 7369 6e63 653d 7369 6e63 6529 0a20  , since=since). 
-00018cb0: 2020 2020 2020 2020 2020 2069 6620 743a             if t:
-00018cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018cd0: 2073 696e 6365 203d 2074 5b2d 315d 5b30   since = t[-1][0
-00018ce0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00018cf0: 2020 7472 6164 6573 2e65 7874 656e 6428    trades.extend(
-00018d00: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00018d10: 2020 2023 2052 6561 6368 6564 2074 6865     # Reached the
-00018d20: 2065 6e64 206f 6620 7468 6520 6465 6669   end of the defi
-00018d30: 6e65 642d 646f 776e 6c6f 6164 2070 6572  ned-download per
-00018d40: 696f 640a 2020 2020 2020 2020 2020 2020  iod.            
-00018d50: 2020 2020 6966 2075 6e74 696c 2061 6e64      if until and
-00018d60: 2074 5b2d 315d 5b30 5d20 3e20 756e 7469   t[-1][0] > unti
-00018d70: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
-00018d80: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-00018d90: 6275 6728 0a20 2020 2020 2020 2020 2020  bug(.           
-00018da0: 2020 2020 2020 2020 2020 2020 2066 2253               f"S
-00018db0: 746f 7070 696e 6720 6265 6361 7573 6520  topping because 
-00018dc0: 756e 7469 6c20 7761 7320 7265 6163 6865  until was reache
-00018dd0: 642e 207b 745b 2d31 5d5b 305d 7d20 3e20  d. {t[-1][0]} > 
-00018de0: 7b75 6e74 696c 7d22 290a 2020 2020 2020  {until}").      
-00018df0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00018e00: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-00018e10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00018e20: 2020 2020 2020 6272 6561 6b0a 0a20 2020        break..   
-00018e30: 2020 2020 2072 6574 7572 6e20 2870 6169       return (pai
-00018e40: 722c 2074 7261 6465 7329 0a0a 2020 2020  r, trades)..    
-00018e50: 6173 796e 6320 6465 6620 5f61 7379 6e63  async def _async
-00018e60: 5f67 6574 5f74 7261 6465 5f68 6973 746f  _get_trade_histo
-00018e70: 7279 2873 656c 662c 2070 6169 723a 2073  ry(self, pair: s
-00018e80: 7472 2c0a 2020 2020 2020 2020 2020 2020  tr,.            
-00018e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ea0: 2020 2020 2020 2020 2020 2073 696e 6365             since
-00018eb0: 3a20 4f70 7469 6f6e 616c 5b69 6e74 5d20  : Optional[int] 
-00018ec0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00018ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ee0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00018ef0: 6e74 696c 3a20 4f70 7469 6f6e 616c 5b69  ntil: Optional[i
-00018f00: 6e74 5d20 3d20 4e6f 6e65 2c0a 2020 2020  nt] = None,.    
+00018a10: 6672 6f6d 5f69 643a 204f 7074 696f 6e61  from_id: Optiona
+00018a20: 6c5b 7374 725d 203d 204e 6f6e 6529 202d  l[str] = None) -
+00018a30: 3e20 5475 706c 655b 7374 722c 204c 6973  > Tuple[str, Lis
+00018a40: 745b 4c69 7374 5d5d 3a0a 2020 2020 2020  t[List]]:.      
+00018a50: 2020 2222 220a 2020 2020 2020 2020 4173    """.        As
+00018a60: 796e 6372 6f6e 6f75 736c 7920 6765 7473  yncronously gets
+00018a70: 2074 7261 6465 2068 6973 746f 7279 2075   trade history u
+00018a80: 7369 6e67 2066 6574 6368 5f74 7261 6465  sing fetch_trade
+00018a90: 730a 2020 2020 2020 2020 7573 6520 7468  s.        use th
+00018aa0: 6973 2077 6865 6e20 6578 6368 616e 6765  is when exchange
+00018ab0: 2075 7365 7320 6964 2d62 6173 6564 2069   uses id-based i
+00018ac0: 7465 7261 7469 6f6e 2028 6368 6563 6b20  teration (check 
+00018ad0: 6073 656c 662e 5f74 7261 6465 735f 7061  `self._trades_pa
+00018ae0: 6769 6e61 7469 6f6e 6029 0a20 2020 2020  gination`).     
+00018af0: 2020 203a 7061 7261 6d20 7061 6972 3a20     :param pair: 
+00018b00: 5061 6972 2074 6f20 6665 7463 6820 7472  Pair to fetch tr
+00018b10: 6164 6520 6461 7461 2066 6f72 0a20 2020  ade data for.   
+00018b20: 2020 2020 203a 7061 7261 6d20 7369 6e63       :param sinc
+00018b30: 653a 2053 696e 6365 2061 7320 696e 7465  e: Since as inte
+00018b40: 6765 7220 7469 6d65 7374 616d 7020 696e  ger timestamp in
+00018b50: 206d 696c 6c69 7365 636f 6e64 730a 2020   milliseconds.  
+00018b60: 2020 2020 2020 3a70 6172 616d 2075 6e74        :param unt
+00018b70: 696c 3a20 556e 7469 6c20 6173 2069 6e74  il: Until as int
+00018b80: 6567 6572 2074 696d 6573 7461 6d70 2069  eger timestamp i
+00018b90: 6e20 6d69 6c6c 6973 6563 6f6e 6473 0a20  n milliseconds. 
+00018ba0: 2020 2020 2020 203a 7061 7261 6d20 6672         :param fr
+00018bb0: 6f6d 5f69 643a 2044 6f77 6e6c 6f61 6420  om_id: Download 
+00018bc0: 6461 7461 2073 7461 7274 696e 6720 7769  data starting wi
+00018bd0: 7468 2049 4420 2869 6620 6964 2069 7320  th ID (if id is 
+00018be0: 6b6e 6f77 6e29 2e20 4967 6e6f 7265 7320  known). Ignores 
+00018bf0: 2273 696e 6365 2220 6966 2073 6574 2e0a  "since" if set..
+00018c00: 2020 2020 2020 2020 7265 7475 726e 7320          returns 
+00018c10: 7475 706c 653a 2028 7061 6972 2c20 7472  tuple: (pair, tr
+00018c20: 6164 6573 2d6c 6973 7429 0a20 2020 2020  ades-list).     
+00018c30: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+00018c40: 7472 6164 6573 3a20 4c69 7374 5b4c 6973  trades: List[Lis
+00018c50: 745d 203d 205b 5d0a 0a20 2020 2020 2020  t] = []..       
+00018c60: 2069 6620 6e6f 7420 6672 6f6d 5f69 643a   if not from_id:
+00018c70: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+00018c80: 6574 6368 2066 6972 7374 2065 6c65 6d65  etch first eleme
+00018c90: 6e74 7320 7573 696e 6720 7469 6d65 6261  nts using timeba
+00018ca0: 7365 6420 6d65 7468 6f64 2074 6f20 6765  sed method to ge
+00018cb0: 7420 616e 2049 4420 746f 2070 6167 696e  t an ID to pagin
+00018cc0: 6174 6520 6f6e 0a20 2020 2020 2020 2020  ate on.         
+00018cd0: 2020 2023 2044 6570 656e 6469 6e67 206f     # Depending o
+00018ce0: 6e20 7468 6520 4578 6368 616e 6765 2c20  n the Exchange, 
+00018cf0: 7468 6973 2063 616e 2069 6e74 726f 6475  this can introdu
+00018d00: 6365 2061 2064 7269 6674 2061 7420 7468  ce a drift at th
+00018d10: 6520 7374 6172 7420 6f66 2074 6865 2069  e start of the i
+00018d20: 6e74 6572 7661 6c0a 2020 2020 2020 2020  nterval.        
+00018d30: 2020 2020 2320 6f66 2075 7020 746f 2061      # of up to a
+00018d40: 6e20 686f 7572 2e0a 2020 2020 2020 2020  n hour..        
+00018d50: 2020 2020 2320 652e 672e 2042 696e 616e      # e.g. Binan
+00018d60: 6365 2072 6574 7572 6e73 2074 6865 2022  ce returns the "
+00018d70: 6c61 7374 2031 3030 3022 2063 616e 646c  last 1000" candl
+00018d80: 6573 2077 6974 6869 6e20 6120 3168 2074  es within a 1h t
+00018d90: 696d 6520 696e 7465 7276 616c 0a20 2020  ime interval.   
+00018da0: 2020 2020 2020 2020 2023 202d 2073 6f20           # - so 
+00018db0: 7765 2077 696c 6c20 6d69 7373 2074 6865  we will miss the
+00018dc0: 2066 6972 7374 2074 7261 6465 732e 0a20   first trades.. 
+00018dd0: 2020 2020 2020 2020 2020 2074 203d 2061             t = a
+00018de0: 7761 6974 2073 656c 662e 5f61 7379 6e63  wait self._async
+00018df0: 5f66 6574 6368 5f74 7261 6465 7328 7061  _fetch_trades(pa
+00018e00: 6972 2c20 7369 6e63 653d 7369 6e63 6529  ir, since=since)
+00018e10: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
+00018e20: 4546 4155 4c54 5f54 5241 4445 535f 434f  EFAULT_TRADES_CO
+00018e30: 4c55 4d4e 533a 2030 202d 3e20 7469 6d65  LUMNS: 0 -> time
+00018e40: 7374 616d 700a 2020 2020 2020 2020 2020  stamp.          
+00018e50: 2020 2320 4445 4641 554c 545f 5452 4144    # DEFAULT_TRAD
+00018e60: 4553 5f43 4f4c 554d 4e53 3a20 3120 2d3e  ES_COLUMNS: 1 ->
+00018e70: 2069 640a 2020 2020 2020 2020 2020 2020   id.            
+00018e80: 6672 6f6d 5f69 6420 3d20 745b 2d31 5d5b  from_id = t[-1][
+00018e90: 315d 0a20 2020 2020 2020 2020 2020 2074  1].            t
+00018ea0: 7261 6465 732e 6578 7465 6e64 2874 5b3a  rades.extend(t[:
+00018eb0: 2d31 5d29 0a20 2020 2020 2020 2077 6869  -1]).        whi
+00018ec0: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
+00018ed0: 2020 2020 2074 203d 2061 7761 6974 2073       t = await s
+00018ee0: 656c 662e 5f61 7379 6e63 5f66 6574 6368  elf._async_fetch
+00018ef0: 5f74 7261 6465 7328 7061 6972 2c0a 2020  _trades(pair,.  
+00018f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00018f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f30: 2020 2066 726f 6d5f 6964 3a20 4f70 7469     from_id: Opti
-00018f40: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
-00018f50: 2920 2d3e 2054 7570 6c65 5b73 7472 2c20  ) -> Tuple[str, 
-00018f60: 4c69 7374 5b4c 6973 745d 5d3a 0a20 2020  List[List]]:.   
-00018f70: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00018f80: 2041 7379 6e63 2077 7261 7070 6572 2068   Async wrapper h
-00018f90: 616e 646c 696e 6720 646f 776e 6c6f 6164  andling download
-00018fa0: 696e 6720 7472 6164 6573 2075 7369 6e67  ing trades using
-00018fb0: 2065 6974 6865 7220 7469 6d65 206f 7220   either time or 
-00018fc0: 6964 2062 6173 6564 206d 6574 686f 6473  id based methods
-00018fd0: 2e0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
-00018fe0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-00018ff0: 6275 6728 6622 5f61 7379 6e63 5f67 6574  bug(f"_async_get
-00019000: 5f74 7261 6465 5f68 6973 746f 7279 2829  _trade_history()
-00019010: 2c20 7061 6972 3a20 7b70 6169 727d 2c20  , pair: {pair}, 
-00019020: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00019030: 2020 2020 2020 2066 2273 696e 6365 3a20         f"since: 
-00019040: 7b73 696e 6365 7d2c 2075 6e74 696c 3a20  {since}, until: 
-00019050: 7b75 6e74 696c 7d2c 2066 726f 6d5f 6964  {until}, from_id
-00019060: 3a20 7b66 726f 6d5f 6964 7d22 290a 0a20  : {from_id}").. 
-00019070: 2020 2020 2020 2069 6620 756e 7469 6c20         if until 
-00019080: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00019090: 2020 2020 2075 6e74 696c 203d 2063 6378       until = ccx
-000190a0: 742e 4578 6368 616e 6765 2e6d 696c 6c69  t.Exchange.milli
-000190b0: 7365 636f 6e64 7328 290a 2020 2020 2020  seconds().      
-000190c0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-000190d0: 7567 2866 2245 7863 6861 6e67 6520 6d69  ug(f"Exchange mi
-000190e0: 6c6c 6973 6563 6f6e 6473 3a20 7b75 6e74  lliseconds: {unt
-000190f0: 696c 7d22 290a 0a20 2020 2020 2020 2069  il}")..        i
-00019100: 6620 7365 6c66 2e5f 7472 6164 6573 5f70  f self._trades_p
-00019110: 6167 696e 6174 696f 6e20 3d3d 2027 7469  agination == 'ti
-00019120: 6d65 273a 0a20 2020 2020 2020 2020 2020  me':.           
-00019130: 2072 6574 7572 6e20 6177 6169 7420 7365   return await se
-00019140: 6c66 2e5f 6173 796e 635f 6765 745f 7472  lf._async_get_tr
-00019150: 6164 655f 6869 7374 6f72 795f 7469 6d65  ade_history_time
-00019160: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00019170: 2020 7061 6972 3d70 6169 722c 2073 696e    pair=pair, sin
-00019180: 6365 3d73 696e 6365 2c20 756e 7469 6c3d  ce=since, until=
-00019190: 756e 7469 6c29 0a20 2020 2020 2020 2065  until).        e
-000191a0: 6c69 6620 7365 6c66 2e5f 7472 6164 6573  lif self._trades
-000191b0: 5f70 6167 696e 6174 696f 6e20 3d3d 2027  _pagination == '
-000191c0: 6964 273a 0a20 2020 2020 2020 2020 2020  id':.           
-000191d0: 2072 6574 7572 6e20 6177 6169 7420 7365   return await se
-000191e0: 6c66 2e5f 6173 796e 635f 6765 745f 7472  lf._async_get_tr
-000191f0: 6164 655f 6869 7374 6f72 795f 6964 280a  ade_history_id(.
+00018f20: 2020 2020 2020 2020 2020 2020 2070 6172               par
+00018f30: 616d 733d 7b73 656c 662e 5f74 7261 6465  ams={self._trade
+00018f40: 735f 7061 6769 6e61 7469 6f6e 5f61 7267  s_pagination_arg
+00018f50: 3a20 6672 6f6d 5f69 647d 290a 2020 2020  : from_id}).    
+00018f60: 2020 2020 2020 2020 6966 2074 3a0a 2020          if t:.  
+00018f70: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00018f80: 536b 6970 206c 6173 7420 6964 2073 696e  Skip last id sin
+00018f90: 6365 2069 7473 2074 6865 206b 6579 2066  ce its the key f
+00018fa0: 6f72 2074 6865 206e 6578 7420 6361 6c6c  or the next call
+00018fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018fc0: 2074 7261 6465 732e 6578 7465 6e64 2874   trades.extend(t
+00018fd0: 5b3a 2d31 5d29 0a20 2020 2020 2020 2020  [:-1]).         
+00018fe0: 2020 2020 2020 2069 6620 6672 6f6d 5f69         if from_i
+00018ff0: 6420 3d3d 2074 5b2d 315d 5b31 5d20 6f72  d == t[-1][1] or
+00019000: 2074 5b2d 315d 5b30 5d20 3e20 756e 7469   t[-1][0] > unti
+00019010: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
+00019020: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+00019030: 6275 6728 6622 5374 6f70 7069 6e67 2062  bug(f"Stopping b
+00019040: 6563 6175 7365 2066 726f 6d5f 6964 2064  ecause from_id d
+00019050: 6964 206e 6f74 2063 6861 6e67 652e 2022  id not change. "
+00019060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019080: 2020 6622 5265 6163 6865 6420 7b74 5b2d    f"Reached {t[-
+00019090: 315d 5b30 5d7d 203e 207b 756e 7469 6c7d  1][0]} > {until}
+000190a0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+000190b0: 2020 2020 2020 2023 2052 6561 6368 6564         # Reached
+000190c0: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
+000190d0: 6465 6669 6e65 642d 646f 776e 6c6f 6164  defined-download
+000190e0: 2070 6572 696f 6420 2d20 6164 6420 6c61   period - add la
+000190f0: 7374 2074 7261 6465 2061 7320 7765 6c6c  st trade as well
+00019100: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00019110: 2020 2020 2020 7472 6164 6573 2e65 7874        trades.ext
+00019120: 656e 6428 745b 2d31 3a5d 290a 2020 2020  end(t[-1:]).    
+00019130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019140: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
+00019150: 2020 2020 2020 2066 726f 6d5f 6964 203d         from_id =
+00019160: 2074 5b2d 315d 5b31 5d0a 2020 2020 2020   t[-1][1].      
+00019170: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00019180: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00019190: 6b0a 0a20 2020 2020 2020 2072 6574 7572  k..        retur
+000191a0: 6e20 2870 6169 722c 2074 7261 6465 7329  n (pair, trades)
+000191b0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+000191c0: 5f61 7379 6e63 5f67 6574 5f74 7261 6465  _async_get_trade
+000191d0: 5f68 6973 746f 7279 5f74 696d 6528 7365  _history_time(se
+000191e0: 6c66 2c20 7061 6972 3a20 7374 722c 2075  lf, pair: str, u
+000191f0: 6e74 696c 3a20 696e 742c 0a20 2020 2020  ntil: int,.     
 00019200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019210: 7061 6972 3d70 6169 722c 2073 696e 6365  pair=pair, since
-00019220: 3d73 696e 6365 2c20 756e 7469 6c3d 756e  =since, until=un
-00019230: 7469 6c2c 2066 726f 6d5f 6964 3d66 726f  til, from_id=fro
-00019240: 6d5f 6964 0a20 2020 2020 2020 2020 2020  m_id.           
-00019250: 2029 0a20 2020 2020 2020 2065 6c73 653a   ).        else:
-00019260: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00019270: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
-00019280: 6365 7074 696f 6e28 6622 4578 6368 616e  ception(f"Exchan
-00019290: 6765 207b 7365 6c66 2e6e 616d 657d 2064  ge {self.name} d
-000192a0: 6f65 7320 7573 6520 6e65 6974 6865 7220  oes use neither 
-000192b0: 7469 6d65 2c20 220a 2020 2020 2020 2020  time, ".        
-000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000192e0: 226e 6f72 2069 6420 6261 7365 6420 7061  "nor id based pa
-000192f0: 6769 6e61 7469 6f6e 2229 0a0a 2020 2020  gination")..    
-00019300: 6465 6620 6765 745f 6869 7374 6f72 6963  def get_historic
-00019310: 5f74 7261 6465 7328 7365 6c66 2c20 7061  _trades(self, pa
-00019320: 6972 3a20 7374 722c 0a20 2020 2020 2020  ir: str,.       
-00019330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019340: 2020 2020 2073 696e 6365 3a20 4f70 7469       since: Opti
-00019350: 6f6e 616c 5b69 6e74 5d20 3d20 4e6f 6e65  onal[int] = None
-00019360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019370: 2020 2020 2020 2020 2020 2020 2020 756e                un
-00019380: 7469 6c3a 204f 7074 696f 6e61 6c5b 696e  til: Optional[in
-00019390: 745d 203d 204e 6f6e 652c 0a20 2020 2020  t] = None,.     
-000193a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193b0: 2020 2020 2020 2066 726f 6d5f 6964 3a20         from_id: 
-000193c0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
-000193d0: 4e6f 6e65 2920 2d3e 2054 7570 6c65 5b73  None) -> Tuple[s
-000193e0: 7472 2c20 4c69 7374 5d3a 0a20 2020 2020  tr, List]:.     
-000193f0: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
-00019400: 6574 2074 7261 6465 2068 6973 746f 7279  et trade history
-00019410: 2064 6174 6120 7573 696e 6720 6173 796e   data using asyn
-00019420: 6369 6f2e 0a20 2020 2020 2020 2048 616e  cio..        Han
-00019430: 646c 6573 2061 6c6c 2061 7379 6e63 2077  dles all async w
-00019440: 6f72 6b20 616e 6420 7265 7475 726e 7320  ork and returns 
-00019450: 7468 6520 6c69 7374 206f 6620 6361 6e64  the list of cand
-00019460: 6c65 732e 0a20 2020 2020 2020 2041 7379  les..        Asy
-00019470: 6e63 206f 7665 7220 6f6e 6520 7061 6972  nc over one pair
-00019480: 2c20 6173 7375 6d69 6e67 2077 6520 6765  , assuming we ge
-00019490: 7420 6073 656c 662e 6f68 6c63 765f 6361  t `self.ohlcv_ca
-000194a0: 6e64 6c65 5f6c 696d 6974 2829 6020 6361  ndle_limit()` ca
-000194b0: 6e64 6c65 7320 7065 7220 6361 6c6c 2e0a  ndles per call..
-000194c0: 2020 2020 2020 2020 3a70 6172 616d 2070          :param p
-000194d0: 6169 723a 2050 6169 7220 746f 2064 6f77  air: Pair to dow
-000194e0: 6e6c 6f61 640a 2020 2020 2020 2020 3a70  nload.        :p
-000194f0: 6172 616d 2073 696e 6365 3a20 5469 6d65  aram since: Time
-00019500: 7374 616d 7020 696e 206d 696c 6c69 7365  stamp in millise
-00019510: 636f 6e64 7320 746f 2067 6574 2068 6973  conds to get his
-00019520: 746f 7279 2066 726f 6d0a 2020 2020 2020  tory from.      
-00019530: 2020 3a70 6172 616d 2075 6e74 696c 3a20    :param until: 
-00019540: 5469 6d65 7374 616d 7020 696e 206d 696c  Timestamp in mil
-00019550: 6c69 7365 636f 6e64 732e 2044 6566 6175  liseconds. Defau
-00019560: 6c74 7320 746f 2063 7572 7265 6e74 2074  lts to current t
-00019570: 696d 6573 7461 6d70 2069 6620 6e6f 7420  imestamp if not 
-00019580: 6465 6669 6e65 642e 0a20 2020 2020 2020  defined..       
-00019590: 203a 7061 7261 6d20 6672 6f6d 5f69 643a   :param from_id:
-000195a0: 2044 6f77 6e6c 6f61 6420 6461 7461 2073   Download data s
-000195b0: 7461 7274 696e 6720 7769 7468 2049 4420  tarting with ID 
-000195c0: 2869 6620 6964 2069 7320 6b6e 6f77 6e29  (if id is known)
-000195d0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-000195e0: 7320 4c69 7374 206f 6620 7472 6164 6520  s List of trade 
-000195f0: 6461 7461 0a20 2020 2020 2020 2022 2222  data.        """
-00019600: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00019610: 7365 6c66 2e65 7863 6861 6e67 655f 6861  self.exchange_ha
-00019620: 7328 2266 6574 6368 5472 6164 6573 2229  s("fetchTrades")
-00019630: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00019640: 6973 6520 4f70 6572 6174 696f 6e61 6c45  ise OperationalE
-00019650: 7863 6570 7469 6f6e 2822 5468 6973 2065  xception("This e
-00019660: 7863 6861 6e67 6520 646f 6573 206e 6f74  xchange does not
-00019670: 2073 7570 706f 7274 2064 6f77 6e6c 6f61   support downloa
-00019680: 6469 6e67 2054 7261 6465 732e 2229 0a0a  ding Trades.")..
-00019690: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-000196a0: 662e 5f6c 6f6f 705f 6c6f 636b 3a0a 2020  f._loop_lock:.  
-000196b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000196c0: 2073 656c 662e 6c6f 6f70 2e72 756e 5f75   self.loop.run_u
-000196d0: 6e74 696c 5f63 6f6d 706c 6574 6528 0a20  ntil_complete(. 
-000196e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000196f0: 656c 662e 5f61 7379 6e63 5f67 6574 5f74  elf._async_get_t
-00019700: 7261 6465 5f68 6973 746f 7279 2870 6169  rade_history(pai
-00019710: 723d 7061 6972 2c20 7369 6e63 653d 7369  r=pair, since=si
-00019720: 6e63 652c 0a20 2020 2020 2020 2020 2020  nce,.           
-00019730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019750: 2020 2075 6e74 696c 3d75 6e74 696c 2c20     until=until, 
-00019760: 6672 6f6d 5f69 643d 6672 6f6d 5f69 6429  from_id=from_id)
-00019770: 290a 0a20 2020 2040 7265 7472 6965 720a  )..    @retrier.
-00019780: 2020 2020 6465 6620 5f67 6574 5f66 756e      def _get_fun
-00019790: 6469 6e67 5f66 6565 735f 6672 6f6d 5f65  ding_fees_from_e
-000197a0: 7863 6861 6e67 6528 7365 6c66 2c20 7061  xchange(self, pa
-000197b0: 6972 3a20 7374 722c 2073 696e 6365 3a20  ir: str, since: 
-000197c0: 556e 696f 6e5b 6461 7465 7469 6d65 2c20  Union[datetime, 
-000197d0: 696e 745d 2920 2d3e 2066 6c6f 6174 3a0a  int]) -> float:.
-000197e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000197f0: 2020 2020 5265 7475 726e 7320 7468 6520      Returns the 
-00019800: 7375 6d20 6f66 2061 6c6c 2066 756e 6469  sum of all fundi
-00019810: 6e67 2066 6565 7320 7468 6174 2077 6572  ng fees that wer
-00019820: 6520 6578 6368 616e 6765 6420 666f 7220  e exchanged for 
-00019830: 6120 7061 6972 2077 6974 6869 6e20 6120  a pair within a 
-00019840: 7469 6d65 6672 616d 650a 2020 2020 2020  timeframe.      
-00019850: 2020 4472 792d 7275 6e20 6861 6e64 6c69    Dry-run handli
-00019860: 6e67 2068 6170 7065 6e73 2061 7320 7061  ng happens as pa
-00019870: 7274 206f 6620 5f63 616c 6375 6c61 7465  rt of _calculate
-00019880: 5f66 756e 6469 6e67 5f66 6565 732e 0a20  _funding_fees.. 
-00019890: 2020 2020 2020 203a 7061 7261 6d20 7061         :param pa
-000198a0: 6972 3a20 2865 2e67 2e20 4144 412f 5553  ir: (e.g. ADA/US
-000198b0: 4454 290a 2020 2020 2020 2020 3a70 6172  DT).        :par
-000198c0: 616d 2073 696e 6365 3a20 5468 6520 6561  am since: The ea
-000198d0: 726c 6965 7374 2074 696d 6520 6f66 2063  rliest time of c
-000198e0: 6f6e 7369 6465 7261 7469 6f6e 2066 6f72  onsideration for
-000198f0: 2063 616c 6375 6c61 7469 6e67 2066 756e   calculating fun
-00019900: 6469 6e67 2066 6565 732c 0a20 2020 2020  ding fees,.     
-00019910: 2020 2020 2020 2069 6e20 756e 6978 2074         in unix t
-00019920: 696d 6520 6f72 2061 7320 6120 6461 7465  ime or as a date
-00019930: 7469 6d65 0a20 2020 2020 2020 2022 2222  time.        """
-00019940: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00019950: 7365 6c66 2e65 7863 6861 6e67 655f 6861  self.exchange_ha
-00019960: 7328 2266 6574 6368 4675 6e64 696e 6748  s("fetchFundingH
-00019970: 6973 746f 7279 2229 3a0a 2020 2020 2020  istory"):.      
-00019980: 2020 2020 2020 7261 6973 6520 4f70 6572        raise Oper
-00019990: 6174 696f 6e61 6c45 7863 6570 7469 6f6e  ationalException
-000199a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000199b0: 2020 6622 6665 7463 685f 6675 6e64 696e    f"fetch_fundin
-000199c0: 675f 6869 7374 6f72 7928 2920 6973 206e  g_history() is n
-000199d0: 6f74 2061 7661 696c 6162 6c65 2075 7369  ot available usi
-000199e0: 6e67 207b 7365 6c66 2e6e 616d 657d 220a  ng {self.name}".
-000199f0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00019a00: 2020 2020 2020 2069 6620 7479 7065 2873         if type(s
-00019a10: 696e 6365 2920 6973 2064 6174 6574 696d  ince) is datetim
-00019a20: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00019a30: 696e 6365 203d 2069 6e74 2873 696e 6365  ince = int(since
-00019a40: 2e74 696d 6573 7461 6d70 2829 2920 2a20  .timestamp()) * 
-00019a50: 3130 3030 2020 2023 202a 2031 3030 3020  1000   # * 1000 
-00019a60: 666f 7220 6d73 0a0a 2020 2020 2020 2020  for ms..        
-00019a70: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00019a80: 2066 756e 6469 6e67 5f68 6973 746f 7279   funding_history
-00019a90: 203d 2073 656c 662e 5f61 7069 2e66 6574   = self._api.fet
-00019aa0: 6368 5f66 756e 6469 6e67 5f68 6973 746f  ch_funding_histo
-00019ab0: 7279 280a 2020 2020 2020 2020 2020 2020  ry(.            
-00019ac0: 2020 2020 7379 6d62 6f6c 3d70 6169 722c      symbol=pair,
-00019ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ae0: 2073 696e 6365 3d73 696e 6365 0a20 2020   since=since.   
-00019af0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00019b00: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-00019b10: 6d28 6665 655b 2761 6d6f 756e 7427 5d20  m(fee['amount'] 
-00019b20: 666f 7220 6665 6520 696e 2066 756e 6469  for fee in fundi
-00019b30: 6e67 5f68 6973 746f 7279 290a 2020 2020  ng_history).    
-00019b40: 2020 2020 6578 6365 7074 2063 6378 742e      except ccxt.
-00019b50: 4444 6f53 5072 6f74 6563 7469 6f6e 2061  DDoSProtection a
-00019b60: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00019b70: 2072 6169 7365 2044 446f 7350 726f 7465   raise DDosProte
-00019b80: 6374 696f 6e28 6529 2066 726f 6d20 650a  ction(e) from e.
-00019b90: 2020 2020 2020 2020 6578 6365 7074 2028          except (
-00019ba0: 6363 7874 2e4e 6574 776f 726b 4572 726f  ccxt.NetworkErro
-00019bb0: 722c 2063 6378 742e 4578 6368 616e 6765  r, ccxt.Exchange
-00019bc0: 4572 726f 7229 2061 7320 653a 0a20 2020  Error) as e:.   
-00019bd0: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-00019be0: 656d 706f 7261 7279 4572 726f 7228 0a20  emporaryError(. 
-00019bf0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00019c00: 2743 6f75 6c64 206e 6f74 2067 6574 2066  'Could not get f
-00019c10: 756e 6469 6e67 2066 6565 7320 6475 6520  unding fees due 
-00019c20: 746f 207b 652e 5f5f 636c 6173 735f 5f2e  to {e.__class__.
-00019c30: 5f5f 6e61 6d65 5f5f 7d2e 204d 6573 7361  __name__}. Messa
-00019c40: 6765 3a20 7b65 7d27 2920 6672 6f6d 2065  ge: {e}') from e
-00019c50: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00019c60: 6363 7874 2e42 6173 6545 7272 6f72 2061  ccxt.BaseError a
-00019c70: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00019c80: 2072 6169 7365 204f 7065 7261 7469 6f6e   raise Operation
-00019c90: 616c 4578 6365 7074 696f 6e28 6529 2066  alException(e) f
-00019ca0: 726f 6d20 650a 0a20 2020 2040 7265 7472  rom e..    @retr
-00019cb0: 6965 720a 2020 2020 6465 6620 6765 745f  ier.    def get_
-00019cc0: 6c65 7665 7261 6765 5f74 6965 7273 2873  leverage_tiers(s
-00019cd0: 656c 6629 202d 3e20 4469 6374 5b73 7472  elf) -> Dict[str
-00019ce0: 2c20 4c69 7374 5b44 6963 745d 5d3a 0a20  , List[Dict]]:. 
-00019cf0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00019d00: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00019d10: 656c 662e 5f61 7069 2e66 6574 6368 5f6c  elf._api.fetch_l
-00019d20: 6576 6572 6167 655f 7469 6572 7328 290a  everage_tiers().
-00019d30: 2020 2020 2020 2020 6578 6365 7074 2063          except c
-00019d40: 6378 742e 4444 6f53 5072 6f74 6563 7469  cxt.DDoSProtecti
-00019d50: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00019d60: 2020 2020 2072 6169 7365 2044 446f 7350       raise DDosP
-00019d70: 726f 7465 6374 696f 6e28 6529 2066 726f  rotection(e) fro
-00019d80: 6d20 650a 2020 2020 2020 2020 6578 6365  m e.        exce
-00019d90: 7074 2028 6363 7874 2e4e 6574 776f 726b  pt (ccxt.Network
-00019da0: 4572 726f 722c 2063 6378 742e 4578 6368  Error, ccxt.Exch
-00019db0: 616e 6765 4572 726f 7229 2061 7320 653a  angeError) as e:
-00019dc0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00019dd0: 7365 2054 656d 706f 7261 7279 4572 726f  se TemporaryErro
-00019de0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00019df0: 2020 2066 2743 6f75 6c64 206e 6f74 206c     f'Could not l
-00019e00: 6f61 6420 6c65 7665 7261 6765 2074 6965  oad leverage tie
-00019e10: 7273 2064 7565 2074 6f20 7b65 2e5f 5f63  rs due to {e.__c
-00019e20: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f7d  lass__.__name__}
-00019e30: 2e20 4d65 7373 6167 653a 207b 657d 270a  . Message: {e}'.
-00019e40: 2020 2020 2020 2020 2020 2020 2920 6672              ) fr
-00019e50: 6f6d 2065 0a20 2020 2020 2020 2065 7863  om e.        exc
-00019e60: 6570 7420 6363 7874 2e42 6173 6545 7272  ept ccxt.BaseErr
-00019e70: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-00019e80: 2020 2020 2072 6169 7365 204f 7065 7261       raise Opera
-00019e90: 7469 6f6e 616c 4578 6365 7074 696f 6e28  tionalException(
-00019ea0: 6529 2066 726f 6d20 650a 0a20 2020 2040  e) from e..    @
-00019eb0: 7265 7472 6965 725f 6173 796e 630a 2020  retrier_async.  
-00019ec0: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
-00019ed0: 6d61 726b 6574 5f6c 6576 6572 6167 655f  market_leverage_
-00019ee0: 7469 6572 7328 7365 6c66 2c20 7379 6d62  tiers(self, symb
-00019ef0: 6f6c 3a20 7374 7229 202d 3e20 5475 706c  ol: str) -> Tupl
-00019f00: 655b 7374 722c 204c 6973 745b 4469 6374  e[str, List[Dict
-00019f10: 5d5d 3a0a 2020 2020 2020 2020 2222 2220  ]]:.        """ 
-00019f20: 4c65 7665 7261 6765 2074 6965 7273 2070  Leverage tiers p
-00019f30: 6572 2073 796d 626f 6c20 2222 220a 2020  er symbol """.  
-00019f40: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00019f50: 2020 2020 2020 2074 6965 7220 3d20 6177         tier = aw
-00019f60: 6169 7420 7365 6c66 2e5f 6170 695f 6173  ait self._api_as
-00019f70: 796e 632e 6665 7463 685f 6d61 726b 6574  ync.fetch_market
-00019f80: 5f6c 6576 6572 6167 655f 7469 6572 7328  _leverage_tiers(
-00019f90: 7379 6d62 6f6c 290a 2020 2020 2020 2020  symbol).        
-00019fa0: 2020 2020 7265 7475 726e 2073 796d 626f      return symbo
-00019fb0: 6c2c 2074 6965 720a 2020 2020 2020 2020  l, tier.        
-00019fc0: 6578 6365 7074 2063 6378 742e 4444 6f53  except ccxt.DDoS
-00019fd0: 5072 6f74 6563 7469 6f6e 2061 7320 653a  Protection as e:
-00019fe0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00019ff0: 7365 2044 446f 7350 726f 7465 6374 696f  se DDosProtectio
-0001a000: 6e28 6529 2066 726f 6d20 650a 2020 2020  n(e) from e.    
-0001a010: 2020 2020 6578 6365 7074 2028 6363 7874      except (ccxt
-0001a020: 2e4e 6574 776f 726b 4572 726f 722c 2063  .NetworkError, c
-0001a030: 6378 742e 4578 6368 616e 6765 4572 726f  cxt.ExchangeErro
-0001a040: 7229 2061 7320 653a 0a20 2020 2020 2020  r) as e:.       
-0001a050: 2020 2020 2072 6169 7365 2054 656d 706f       raise Tempo
-0001a060: 7261 7279 4572 726f 7228 0a20 2020 2020  raryError(.     
-0001a070: 2020 2020 2020 2020 2020 2066 2743 6f75             f'Cou
-0001a080: 6c64 206e 6f74 206c 6f61 6420 6c65 7665  ld not load leve
-0001a090: 7261 6765 2074 6965 7273 2066 6f72 207b  rage tiers for {
-0001a0a0: 7379 6d62 6f6c 7d27 0a20 2020 2020 2020  symbol}'.       
-0001a0b0: 2020 2020 2020 2020 2066 2720 6475 6520           f' due 
-0001a0c0: 746f 207b 652e 5f5f 636c 6173 735f 5f2e  to {e.__class__.
-0001a0d0: 5f5f 6e61 6d65 5f5f 7d2e 204d 6573 7361  __name__}. Messa
-0001a0e0: 6765 3a20 7b65 7d27 0a20 2020 2020 2020  ge: {e}'.       
-0001a0f0: 2020 2020 2029 2066 726f 6d20 650a 2020       ) from e.  
-0001a100: 2020 2020 2020 6578 6365 7074 2063 6378        except ccx
-0001a110: 742e 4261 7365 4572 726f 7220 6173 2065  t.BaseError as e
-0001a120: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0001a130: 6973 6520 4f70 6572 6174 696f 6e61 6c45  ise OperationalE
-0001a140: 7863 6570 7469 6f6e 2865 2920 6672 6f6d  xception(e) from
-0001a150: 2065 0a0a 2020 2020 6465 6620 6c6f 6164   e..    def load
-0001a160: 5f6c 6576 6572 6167 655f 7469 6572 7328  _leverage_tiers(
-0001a170: 7365 6c66 2920 2d3e 2044 6963 745b 7374  self) -> Dict[st
-0001a180: 722c 204c 6973 745b 4469 6374 5d5d 3a0a  r, List[Dict]]:.
-0001a190: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001a1a0: 7472 6164 696e 675f 6d6f 6465 203d 3d20  trading_mode == 
-0001a1b0: 5472 6164 696e 674d 6f64 652e 4655 5455  TradingMode.FUTU
-0001a1c0: 5245 533a 0a20 2020 2020 2020 2020 2020  RES:.           
-0001a1d0: 2069 6620 7365 6c66 2e65 7863 6861 6e67   if self.exchang
-0001a1e0: 655f 6861 7328 2766 6574 6368 4c65 7665  e_has('fetchLeve
-0001a1f0: 7261 6765 5469 6572 7327 293a 0a20 2020  rageTiers'):.   
-0001a200: 2020 2020 2020 2020 2020 2020 2023 2046               # F
-0001a210: 6574 6368 2061 6c6c 206c 6576 6572 6167  etch all leverag
-0001a220: 6520 7469 6572 7320 6174 206f 6e63 650a  e tiers at once.
-0001a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a240: 7265 7475 726e 2073 656c 662e 6765 745f  return self.get_
-0001a250: 6c65 7665 7261 6765 5f74 6965 7273 2829  leverage_tiers()
-0001a260: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-0001a270: 6620 7365 6c66 2e65 7863 6861 6e67 655f  f self.exchange_
-0001a280: 6861 7328 2766 6574 6368 4d61 726b 6574  has('fetchMarket
-0001a290: 4c65 7665 7261 6765 5469 6572 7327 293a  LeverageTiers'):
-0001a2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a2b0: 2023 204d 7573 7420 6665 7463 6820 7468   # Must fetch th
-0001a2c0: 6520 6c65 7665 7261 6765 2074 6965 7273  e leverage tiers
-0001a2d0: 2066 6f72 2065 6163 6820 6d61 726b 6574   for each market
-0001a2e0: 2073 6570 6172 6174 656c 790a 2020 2020   separately.    
-0001a2f0: 2020 2020 2020 2020 2020 2020 2320 2a20              # * 
-0001a300: 5468 6973 2069 7320 736c 6f77 287e 3435  This is slow(~45
-0001a310: 7329 206f 6e20 4f6b 782c 206d 616b 6573  s) on Okx, makes
-0001a320: 207e 3930 2061 7069 2063 616c 6c73 2074   ~90 api calls t
-0001a330: 6f20 6c6f 6164 2061 6c6c 206c 696e 6561  o load all linea
-0001a340: 7220 7377 6170 206d 6172 6b65 7473 0a20  r swap markets. 
-0001a350: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001a360: 6172 6b65 7473 203d 2073 656c 662e 6d61  arkets = self.ma
-0001a370: 726b 6574 730a 0a20 2020 2020 2020 2020  rkets..         
-0001a380: 2020 2020 2020 2073 796d 626f 6c73 203d         symbols =
-0001a390: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0001a3a0: 2020 2020 2020 2073 796d 626f 6c20 666f         symbol fo
-0001a3b0: 7220 7379 6d62 6f6c 2c20 6d61 726b 6574  r symbol, market
-0001a3c0: 2069 6e20 6d61 726b 6574 732e 6974 656d   in markets.item
-0001a3d0: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0001a3e0: 2020 2020 2020 2020 6966 2028 7365 6c66          if (self
-0001a3f0: 2e6d 6172 6b65 745f 6973 5f66 7574 7572  .market_is_futur
-0001a400: 6528 6d61 726b 6574 290a 2020 2020 2020  e(market).      
-0001a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a420: 2020 616e 6420 6d61 726b 6574 5b27 7175    and market['qu
-0001a430: 6f74 6527 5d20 3d3d 2073 656c 662e 5f63  ote'] == self._c
-0001a440: 6f6e 6669 675b 2773 7461 6b65 5f63 7572  onfig['stake_cur
-0001a450: 7265 6e63 7927 5d29 0a20 2020 2020 2020  rency']).       
-0001a460: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
-0001a470: 2020 2020 2020 2020 2020 2020 7469 6572              tier
-0001a480: 733a 2044 6963 745b 7374 722c 204c 6973  s: Dict[str, Lis
-0001a490: 745b 4469 6374 5d5d 203d 207b 7d0a 0a20  t[Dict]] = {}.. 
-0001a4a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001a4b0: 6965 7273 5f63 6163 6865 6420 3d20 7365  iers_cached = se
-0001a4c0: 6c66 2e6c 6f61 645f 6361 6368 6564 5f6c  lf.load_cached_l
-0001a4d0: 6576 6572 6167 655f 7469 6572 7328 7365  everage_tiers(se
-0001a4e0: 6c66 2e5f 636f 6e66 6967 5b27 7374 616b  lf._config['stak
-0001a4f0: 655f 6375 7272 656e 6379 275d 290a 2020  e_currency']).  
-0001a500: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001a510: 2074 6965 7273 5f63 6163 6865 643a 0a20   tiers_cached:. 
-0001a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a530: 2020 2074 6965 7273 203d 2074 6965 7273     tiers = tiers
-0001a540: 5f63 6163 6865 640a 0a20 2020 2020 2020  _cached..       
-0001a550: 2020 2020 2020 2020 2063 6f72 6f73 203d           coros =
-0001a560: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-0001a570: 2020 2020 2020 2073 656c 662e 6765 745f         self.get_
-0001a580: 6d61 726b 6574 5f6c 6576 6572 6167 655f  market_leverage_
-0001a590: 7469 6572 7328 7379 6d62 6f6c 290a 2020  tiers(symbol).  
-0001a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a5b0: 2020 666f 7220 7379 6d62 6f6c 2069 6e20    for symbol in 
-0001a5c0: 736f 7274 6564 2873 796d 626f 6c73 2920  sorted(symbols) 
-0001a5d0: 6966 2073 796d 626f 6c20 6e6f 7420 696e  if symbol not in
-0001a5e0: 2074 6965 7273 5d0a 0a20 2020 2020 2020   tiers]..       
-0001a5f0: 2020 2020 2020 2020 2023 2042 6520 7665           # Be ve
-0001a600: 7262 6f73 6520 6865 7265 2c20 6173 2074  rbose here, as t
-0001a610: 6869 7320 6465 6c61 7973 2073 7461 7274  his delays start
-0001a620: 7570 2062 7920 7e31 206d 696e 7574 652e  up by ~1 minute.
-0001a630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a640: 2069 6620 636f 726f 733a 0a20 2020 2020   if coros:.     
-0001a650: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0001a660: 6f67 6765 722e 696e 666f 280a 2020 2020  ogger.info(.    
-0001a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a680: 2020 2020 6622 496e 6974 6961 6c69 7a69      f"Initializi
-0001a690: 6e67 206c 6576 6572 6167 655f 7469 6572  ng leverage_tier
-0001a6a0: 7320 666f 7220 7b6c 656e 2873 796d 626f  s for {len(symbo
-0001a6b0: 6c73 297d 206d 6172 6b65 7473 2e20 220a  ls)} markets. ".
-0001a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a6d0: 2020 2020 2020 2020 2254 6869 7320 7769          "This wi
-0001a6e0: 6c6c 2074 616b 6520 6162 6f75 7420 6120  ll take about a 
-0001a6f0: 6d69 6e75 7465 2e22 290a 2020 2020 2020  minute.").      
-0001a700: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001a710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a720: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0001a730: 2255 7369 6e67 2063 6163 6865 6420 6c65  "Using cached le
-0001a740: 7665 7261 6765 5f74 6965 7273 2e22 290a  verage_tiers.").
-0001a750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a760: 2061 7379 6e63 2064 6566 2067 6174 6865   async def gathe
-0001a770: 725f 7265 7375 6c74 7328 696e 7075 745f  r_results(input_
-0001a780: 636f 726f 293a 0a20 2020 2020 2020 2020  coro):.         
-0001a790: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001a7a0: 6e20 6177 6169 7420 6173 796e 6369 6f2e  n await asyncio.
-0001a7b0: 6761 7468 6572 282a 696e 7075 745f 636f  gather(*input_co
-0001a7c0: 726f 2c20 7265 7475 726e 5f65 7863 6570  ro, return_excep
-0001a7d0: 7469 6f6e 733d 5472 7565 290a 0a20 2020  tions=True)..   
-0001a7e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001a7f0: 2069 6e70 7574 5f63 6f72 6f20 696e 2063   input_coro in c
-0001a800: 6875 6e6b 7328 636f 726f 732c 2031 3030  hunks(coros, 100
-0001a810: 293a 0a0a 2020 2020 2020 2020 2020 2020  ):..            
-0001a820: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-0001a830: 662e 5f6c 6f6f 705f 6c6f 636b 3a0a 2020  f._loop_lock:.  
-0001a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a850: 2020 2020 2020 7265 7375 6c74 7320 3d20        results = 
-0001a860: 7365 6c66 2e6c 6f6f 702e 7275 6e5f 756e  self.loop.run_un
-0001a870: 7469 6c5f 636f 6d70 6c65 7465 2867 6174  til_complete(gat
-0001a880: 6865 725f 7265 7375 6c74 7328 696e 7075  her_results(inpu
-0001a890: 745f 636f 726f 2929 0a0a 2020 2020 2020  t_coro))..      
-0001a8a0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0001a8b0: 7220 7265 7320 696e 2072 6573 756c 7473  r res in results
-0001a8c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a8d0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-0001a8e0: 6e73 7461 6e63 6528 7265 732c 2045 7863  nstance(res, Exc
-0001a8f0: 6570 7469 6f6e 293a 0a20 2020 2020 2020  eption):.       
-0001a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a910: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
-0001a920: 696e 6728 6622 4c65 7665 7261 6765 2074  ing(f"Leverage t
-0001a930: 6965 7220 6578 6365 7074 696f 6e3a 207b  ier exception: {
-0001a940: 7265 7072 2872 6573 297d 2229 0a20 2020  repr(res)}").   
-0001a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a960: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-0001a970: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001a980: 2020 2020 2020 2020 2020 7379 6d62 6f6c            symbol
-0001a990: 2c20 7469 6572 203d 2072 6573 0a20 2020  , tier = res.   
-0001a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9b0: 2020 2020 2074 6965 7273 5b73 796d 626f       tiers[symbo
-0001a9c0: 6c5d 203d 2074 6965 720a 2020 2020 2020  l] = tier.      
-0001a9d0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-0001a9e0: 2863 6f72 6f73 2920 3e20 303a 0a20 2020  (coros) > 0:.   
-0001a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa00: 2073 656c 662e 6361 6368 655f 6c65 7665   self.cache_leve
-0001aa10: 7261 6765 5f74 6965 7273 2874 6965 7273  rage_tiers(tiers
-0001aa20: 2c20 7365 6c66 2e5f 636f 6e66 6967 5b27  , self._config['
-0001aa30: 7374 616b 655f 6375 7272 656e 6379 275d  stake_currency']
-0001aa40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001aa50: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
-0001aa60: 446f 6e65 2069 6e69 7469 616c 697a 696e  Done initializin
-0001aa70: 6720 7b6c 656e 2873 796d 626f 6c73 297d  g {len(symbols)}
-0001aa80: 206d 6172 6b65 7473 2e22 290a 0a20 2020   markets.")..   
-0001aa90: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001aaa0: 7572 6e20 7469 6572 730a 2020 2020 2020  urn tiers.      
-0001aab0: 2020 7265 7475 726e 207b 7d0a 0a20 2020    return {}..   
-0001aac0: 2064 6566 2063 6163 6865 5f6c 6576 6572   def cache_lever
-0001aad0: 6167 655f 7469 6572 7328 7365 6c66 2c20  age_tiers(self, 
-0001aae0: 7469 6572 733a 2044 6963 745b 7374 722c  tiers: Dict[str,
-0001aaf0: 204c 6973 745b 4469 6374 5d5d 2c20 7374   List[Dict]], st
-0001ab00: 616b 655f 6375 7272 656e 6379 3a20 7374  ake_currency: st
-0001ab10: 7229 202d 3e20 4e6f 6e65 3a0a 0a20 2020  r) -> None:..   
-0001ab20: 2020 2020 2066 696c 656e 616d 6520 3d20       filename = 
-0001ab30: 7365 6c66 2e5f 636f 6e66 6967 5b27 6461  self._config['da
-0001ab40: 7461 6469 7227 5d20 2f20 2266 7574 7572  tadir'] / "futur
-0001ab50: 6573 2220 2f20 6622 6c65 7665 7261 6765  es" / f"leverage
-0001ab60: 5f74 6965 7273 5f7b 7374 616b 655f 6375  _tiers_{stake_cu
-0001ab70: 7272 656e 6379 7d2e 6a73 6f6e 220a 2020  rrency}.json".  
-0001ab80: 2020 2020 2020 6966 206e 6f74 2066 696c        if not fil
-0001ab90: 656e 616d 652e 7061 7265 6e74 2e69 735f  ename.parent.is_
-0001aba0: 6469 7228 293a 0a20 2020 2020 2020 2020  dir():.         
-0001abb0: 2020 2066 696c 656e 616d 652e 7061 7265     filename.pare
-0001abc0: 6e74 2e6d 6b64 6972 2870 6172 656e 7473  nt.mkdir(parents
-0001abd0: 3d54 7275 6529 0a20 2020 2020 2020 2064  =True).        d
-0001abe0: 6174 6120 3d20 7b0a 2020 2020 2020 2020  ata = {.        
-0001abf0: 2020 2020 2275 7064 6174 6564 223a 2064      "updated": d
-0001ac00: 6174 6574 696d 652e 6e6f 7728 7469 6d65  atetime.now(time
-0001ac10: 7a6f 6e65 2e75 7463 292c 0a20 2020 2020  zone.utc),.     
-0001ac20: 2020 2020 2020 2022 6461 7461 223a 2074         "data": t
-0001ac30: 6965 7273 2c0a 2020 2020 2020 2020 7d0a  iers,.        }.
-0001ac40: 2020 2020 2020 2020 6669 6c65 5f64 756d          file_dum
-0001ac50: 705f 6a73 6f6e 2866 696c 656e 616d 652c  p_json(filename,
-0001ac60: 2064 6174 6129 0a0a 2020 2020 6465 6620   data)..    def 
-0001ac70: 6c6f 6164 5f63 6163 6865 645f 6c65 7665  load_cached_leve
-0001ac80: 7261 6765 5f74 6965 7273 2873 656c 662c  rage_tiers(self,
-0001ac90: 2073 7461 6b65 5f63 7572 7265 6e63 793a   stake_currency:
-0001aca0: 2073 7472 2920 2d3e 204f 7074 696f 6e61   str) -> Optiona
-0001acb0: 6c5b 4469 6374 5b73 7472 2c20 4c69 7374  l[Dict[str, List
-0001acc0: 5b44 6963 745d 5d5d 3a0a 2020 2020 2020  [Dict]]]:.      
-0001acd0: 2020 6669 6c65 6e61 6d65 203d 2073 656c    filename = sel
-0001ace0: 662e 5f63 6f6e 6669 675b 2764 6174 6164  f._config['datad
-0001acf0: 6972 275d 202f 2022 6675 7475 7265 7322  ir'] / "futures"
-0001ad00: 202f 2066 226c 6576 6572 6167 655f 7469   / f"leverage_ti
-0001ad10: 6572 735f 7b73 7461 6b65 5f63 7572 7265  ers_{stake_curre
-0001ad20: 6e63 797d 2e6a 736f 6e22 0a20 2020 2020  ncy}.json".     
-0001ad30: 2020 2069 6620 6669 6c65 6e61 6d65 2e69     if filename.i
-0001ad40: 735f 6669 6c65 2829 3a0a 2020 2020 2020  s_file():.      
-0001ad50: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0001ad60: 2020 2020 2020 2020 2020 2074 6965 7273             tiers
-0001ad70: 203d 2066 696c 655f 6c6f 6164 5f6a 736f   = file_load_jso
-0001ad80: 6e28 6669 6c65 6e61 6d65 290a 2020 2020  n(filename).    
-0001ad90: 2020 2020 2020 2020 2020 2020 7570 6461              upda
-0001ada0: 7465 6420 3d20 7469 6572 732e 6765 7428  ted = tiers.get(
-0001adb0: 2775 7064 6174 6564 2729 0a20 2020 2020  'updated').     
-0001adc0: 2020 2020 2020 2020 2020 2069 6620 7570             if up
-0001add0: 6461 7465 643a 0a20 2020 2020 2020 2020  dated:.         
-0001ade0: 2020 2020 2020 2020 2020 2075 7064 6174             updat
-0001adf0: 6564 5f64 7420 3d20 7061 7273 6572 2e70  ed_dt = parser.p
-0001ae00: 6172 7365 2875 7064 6174 6564 290a 2020  arse(updated).  
-0001ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ae20: 2020 6966 2075 7064 6174 6564 5f64 7420    if updated_dt 
-0001ae30: 3c20 6461 7465 7469 6d65 2e6e 6f77 2874  < datetime.now(t
-0001ae40: 696d 657a 6f6e 652e 7574 6329 202d 2074  imezone.utc) - t
-0001ae50: 696d 6564 656c 7461 2877 6565 6b73 3d34  imedelta(weeks=4
-0001ae60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001ae70: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0001ae80: 722e 696e 666f 2822 4361 6368 6564 206c  r.info("Cached l
-0001ae90: 6576 6572 6167 6520 7469 6572 7320 6172  everage tiers ar
-0001aea0: 6520 6f75 7464 6174 6564 2e20 5769 6c6c  e outdated. Will
-0001aeb0: 2075 7064 6174 652e 2229 0a20 2020 2020   update.").     
-0001aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aed0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
-0001aee0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001aef0: 6574 7572 6e20 7469 6572 735b 2764 6174  eturn tiers['dat
-0001af00: 6127 5d0a 2020 2020 2020 2020 2020 2020  a'].            
-0001af10: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0001af20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001af30: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
-0001af40: 6f6e 2822 4572 726f 7220 6c6f 6164 696e  on("Error loadin
-0001af50: 6720 6361 6368 6564 206c 6576 6572 6167  g cached leverag
-0001af60: 6520 7469 6572 732e 2052 6566 7265 7368  e tiers. Refresh
-0001af70: 696e 672e 2229 0a20 2020 2020 2020 2072  ing.").        r
-0001af80: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
-0001af90: 6465 6620 6669 6c6c 5f6c 6576 6572 6167  def fill_leverag
-0001afa0: 655f 7469 6572 7328 7365 6c66 2920 2d3e  e_tiers(self) ->
-0001afb0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0001afc0: 2222 0a20 2020 2020 2020 2041 7373 6967  "".        Assig
-0001afd0: 6e73 2070 726f 7065 7274 7920 5f6c 6576  ns property _lev
-0001afe0: 6572 6167 655f 7469 6572 7320 746f 2061  erage_tiers to a
-0001aff0: 2064 6963 7469 6f6e 6172 7920 6f66 2069   dictionary of i
-0001b000: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
-0001b010: 2074 6865 206c 6576 6572 6167 650a 2020   the leverage.  
-0001b020: 2020 2020 2020 616c 6c6f 7765 6420 6f6e        allowed on
-0001b030: 2065 6163 6820 7061 6972 0a20 2020 2020   each pair.     
-0001b040: 2020 2022 2222 0a20 2020 2020 2020 206c     """.        l
-0001b050: 6576 6572 6167 655f 7469 6572 7320 3d20  everage_tiers = 
-0001b060: 7365 6c66 2e6c 6f61 645f 6c65 7665 7261  self.load_levera
-0001b070: 6765 5f74 6965 7273 2829 0a20 2020 2020  ge_tiers().     
-0001b080: 2020 2066 6f72 2070 6169 722c 2074 6965     for pair, tie
-0001b090: 7273 2069 6e20 6c65 7665 7261 6765 5f74  rs in leverage_t
-0001b0a0: 6965 7273 2e69 7465 6d73 2829 3a0a 2020  iers.items():.  
-0001b0b0: 2020 2020 2020 2020 2020 7061 6972 5f74            pair_t
-0001b0c0: 6965 7273 203d 205b 5d0a 2020 2020 2020  iers = [].      
-0001b0d0: 2020 2020 2020 666f 7220 7469 6572 2069        for tier i
-0001b0e0: 6e20 7469 6572 733a 0a20 2020 2020 2020  n tiers:.       
-0001b0f0: 2020 2020 2020 2020 2070 6169 725f 7469           pair_ti
-0001b100: 6572 732e 6170 7065 6e64 2873 656c 662e  ers.append(self.
-0001b110: 7061 7273 655f 6c65 7665 7261 6765 5f74  parse_leverage_t
-0001b120: 6965 7228 7469 6572 2929 0a20 2020 2020  ier(tier)).     
-0001b130: 2020 2020 2020 2073 656c 662e 5f6c 6576         self._lev
-0001b140: 6572 6167 655f 7469 6572 735b 7061 6972  erage_tiers[pair
-0001b150: 5d20 3d20 7061 6972 5f74 6965 7273 0a0a  ] = pair_tiers..
-0001b160: 2020 2020 6465 6620 7061 7273 655f 6c65      def parse_le
-0001b170: 7665 7261 6765 5f74 6965 7228 7365 6c66  verage_tier(self
-0001b180: 2c20 7469 6572 2920 2d3e 2044 6963 743a  , tier) -> Dict:
-0001b190: 0a20 2020 2020 2020 2069 6e66 6f20 3d20  .        info = 
-0001b1a0: 7469 6572 2e67 6574 2827 696e 666f 272c  tier.get('info',
-0001b1b0: 207b 7d29 0a20 2020 2020 2020 2072 6574   {}).        ret
-0001b1c0: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
-0001b1d0: 2020 276d 696e 4e6f 7469 6f6e 616c 273a    'minNotional':
-0001b1e0: 2074 6965 725b 276d 696e 4e6f 7469 6f6e   tier['minNotion
-0001b1f0: 616c 275d 2c0a 2020 2020 2020 2020 2020  al'],.          
-0001b200: 2020 276d 6178 4e6f 7469 6f6e 616c 273a    'maxNotional':
-0001b210: 2074 6965 725b 276d 6178 4e6f 7469 6f6e   tier['maxNotion
-0001b220: 616c 275d 2c0a 2020 2020 2020 2020 2020  al'],.          
-0001b230: 2020 276d 6169 6e74 656e 616e 6365 4d61    'maintenanceMa
-0001b240: 7267 696e 5261 7465 273a 2074 6965 725b  rginRate': tier[
-0001b250: 276d 6169 6e74 656e 616e 6365 4d61 7267  'maintenanceMarg
-0001b260: 696e 5261 7465 275d 2c0a 2020 2020 2020  inRate'],.      
-0001b270: 2020 2020 2020 276d 6178 4c65 7665 7261        'maxLevera
-0001b280: 6765 273a 2074 6965 725b 276d 6178 4c65  ge': tier['maxLe
-0001b290: 7665 7261 6765 275d 2c0a 2020 2020 2020  verage'],.      
-0001b2a0: 2020 2020 2020 276d 6169 6e74 416d 7427        'maintAmt'
-0001b2b0: 3a20 666c 6f61 7428 696e 666f 5b27 6375  : float(info['cu
-0001b2c0: 6d27 5d29 2069 6620 2763 756d 2720 696e  m']) if 'cum' in
-0001b2d0: 2069 6e66 6f20 656c 7365 204e 6f6e 652c   info else None,
-0001b2e0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0001b2f0: 6465 6620 6765 745f 6d61 785f 6c65 7665  def get_max_leve
-0001b300: 7261 6765 2873 656c 662c 2070 6169 723a  rage(self, pair:
-0001b310: 2073 7472 2c20 7374 616b 655f 616d 6f75   str, stake_amou
-0001b320: 6e74 3a20 4f70 7469 6f6e 616c 5b66 6c6f  nt: Optional[flo
-0001b330: 6174 5d29 202d 3e20 666c 6f61 743a 0a20  at]) -> float:. 
-0001b340: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001b350: 2020 2052 6574 7572 6e73 2074 6865 206d     Returns the m
-0001b360: 6178 696d 756d 206c 6576 6572 6167 6520  aximum leverage 
-0001b370: 7468 6174 2061 2070 6169 7220 6361 6e20  that a pair can 
-0001b380: 6265 2074 7261 6465 6420 6174 0a20 2020  be traded at.   
-0001b390: 2020 2020 203a 7061 7261 6d20 7061 6972       :param pair
-0001b3a0: 3a20 5468 6520 6261 7365 2f71 756f 7465  : The base/quote
-0001b3b0: 2063 7572 7265 6e63 7920 7061 6972 2062   currency pair b
-0001b3c0: 6569 6e67 2074 7261 6465 640a 2020 2020  eing traded.    
-0001b3d0: 2020 2020 3a73 7461 6b65 5f61 6d6f 756e      :stake_amoun
-0001b3e0: 743a 2054 6865 2074 6f74 616c 2076 616c  t: The total val
-0001b3f0: 7565 206f 6620 7468 6520 7472 6164 6572  ue of the trader
-0001b400: 7320 6d61 7267 696e 5f6d 6f64 6520 696e  s margin_mode in
-0001b410: 2071 756f 7465 2063 7572 7265 6e63 790a   quote currency.
-0001b420: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-0001b430: 2020 2020 2069 6620 7365 6c66 2e74 7261       if self.tra
-0001b440: 6469 6e67 5f6d 6f64 6520 3d3d 2054 7261  ding_mode == Tra
-0001b450: 6469 6e67 4d6f 6465 2e53 504f 543a 0a20  dingMode.SPOT:. 
-0001b460: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001b470: 6e20 312e 300a 0a20 2020 2020 2020 2069  n 1.0..        i
-0001b480: 6620 7365 6c66 2e74 7261 6469 6e67 5f6d  f self.trading_m
-0001b490: 6f64 6520 3d3d 2054 7261 6469 6e67 4d6f  ode == TradingMo
-0001b4a0: 6465 2e46 5554 5552 4553 3a0a 0a20 2020  de.FUTURES:..   
-0001b4b0: 2020 2020 2020 2020 2023 2043 6865 636b           # Check
-0001b4c0: 7320 616e 6420 6564 6765 2063 6173 6573  s and edge cases
-0001b4d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001b4e0: 7374 616b 655f 616d 6f75 6e74 2069 7320  stake_amount is 
-0001b4f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001b500: 2020 2020 2020 7261 6973 6520 4f70 6572        raise Oper
-0001b510: 6174 696f 6e61 6c45 7863 6570 7469 6f6e  ationalException
-0001b520: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001b530: 2020 2020 2020 6627 7b73 656c 662e 6e61        f'{self.na
-0001b540: 6d65 7d2e 6765 745f 6d61 785f 6c65 7665  me}.get_max_leve
-0001b550: 7261 6765 2072 6571 7569 7265 7320 6172  rage requires ar
-0001b560: 6775 6d65 6e74 2073 7461 6b65 5f61 6d6f  gument stake_amo
-0001b570: 756e 7427 0a20 2020 2020 2020 2020 2020  unt'.           
-0001b580: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001b590: 2020 2020 6966 2070 6169 7220 6e6f 7420      if pair not 
-0001b5a0: 696e 2073 656c 662e 5f6c 6576 6572 6167  in self._leverag
-0001b5b0: 655f 7469 6572 733a 0a20 2020 2020 2020  e_tiers:.       
-0001b5c0: 2020 2020 2020 2020 2023 204d 6179 6265           # Maybe
-0001b5d0: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
-0001b5e0: 2062 6563 6175 7365 2069 7420 6361 6e27   because it can'
-0001b5f0: 7420 6265 2074 7261 6465 6420 6f6e 2066  t be traded on f
-0001b600: 7574 7572 6573 3f0a 2020 2020 2020 2020  utures?.        
-0001b610: 2020 2020 2020 2020 7265 7475 726e 2031          return 1
-0001b620: 2e30 0a0a 2020 2020 2020 2020 2020 2020  .0..            
-0001b630: 7061 6972 5f74 6965 7273 203d 2073 656c  pair_tiers = sel
-0001b640: 662e 5f6c 6576 6572 6167 655f 7469 6572  f._leverage_tier
-0001b650: 735b 7061 6972 5d0a 0a20 2020 2020 2020  s[pair]..       
-0001b660: 2020 2020 2069 6620 7374 616b 655f 616d       if stake_am
-0001b670: 6f75 6e74 203d 3d20 303a 0a20 2020 2020  ount == 0:.     
-0001b680: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001b690: 6e20 7365 6c66 2e5f 6c65 7665 7261 6765  n self._leverage
-0001b6a0: 5f74 6965 7273 5b70 6169 725d 5b30 5d5b  _tiers[pair][0][
-0001b6b0: 276d 6178 4c65 7665 7261 6765 275d 2020  'maxLeverage']  
-0001b6c0: 2320 4d61 7820 6c65 7620 666f 7220 6c6f  # Max lev for lo
-0001b6d0: 7765 7374 2061 6d6f 756e 740a 0a20 2020  west amount..   
-0001b6e0: 2020 2020 2020 2020 2066 6f72 2074 6965           for tie
-0001b6f0: 725f 696e 6465 7820 696e 2072 616e 6765  r_index in range
-0001b700: 286c 656e 2870 6169 725f 7469 6572 7329  (len(pair_tiers)
-0001b710: 293a 0a0a 2020 2020 2020 2020 2020 2020  ):..            
-0001b720: 2020 2020 7469 6572 203d 2070 6169 725f      tier = pair_
-0001b730: 7469 6572 735b 7469 6572 5f69 6e64 6578  tiers[tier_index
-0001b740: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001b750: 2020 6c65 7620 3d20 7469 6572 5b27 6d61    lev = tier['ma
-0001b760: 784c 6576 6572 6167 6527 5d0a 0a20 2020  xLeverage']..   
-0001b770: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001b780: 7469 6572 5f69 6e64 6578 203c 206c 656e  tier_index < len
-0001b790: 2870 6169 725f 7469 6572 7329 202d 2031  (pair_tiers) - 1
-0001b7a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001b7b0: 2020 2020 2020 6e65 7874 5f74 6965 7220        next_tier 
-0001b7c0: 3d20 7061 6972 5f74 6965 7273 5b74 6965  = pair_tiers[tie
-0001b7d0: 725f 696e 6465 7820 2b20 315d 0a20 2020  r_index + 1].   
-0001b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b7f0: 206e 6578 745f 666c 6f6f 7220 3d20 6e65   next_floor = ne
-0001b800: 7874 5f74 6965 725b 276d 696e 4e6f 7469  xt_tier['minNoti
-0001b810: 6f6e 616c 275d 202f 206e 6578 745f 7469  onal'] / next_ti
-0001b820: 6572 5b27 6d61 784c 6576 6572 6167 6527  er['maxLeverage'
-0001b830: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001b840: 2020 2020 2020 6966 206e 6578 745f 666c        if next_fl
-0001b850: 6f6f 7220 3e20 7374 616b 655f 616d 6f75  oor > stake_amou
-0001b860: 6e74 3a20 2023 204e 6578 7420 7469 6572  nt:  # Next tier
-0001b870: 206d 696e 2074 6f6f 2068 6967 6820 666f   min too high fo
-0001b880: 7220 7374 616b 6520 616d 6f75 6e74 0a20  r stake amount. 
-0001b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8a0: 2020 2020 2020 2072 6574 7572 6e20 6d69         return mi
-0001b8b0: 6e28 2874 6965 725b 276d 6178 4e6f 7469  n((tier['maxNoti
-0001b8c0: 6f6e 616c 275d 202f 2073 7461 6b65 5f61  onal'] / stake_a
-0001b8d0: 6d6f 756e 7429 2c20 6c65 7629 0a20 2020  mount), lev).   
-0001b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8f0: 2020 2020 2023 0a20 2020 2020 2020 2020       #.         
-0001b900: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001b910: 2057 6974 6820 7468 6520 7477 6f20 6c65   With the two le
-0001b920: 7665 7261 6765 2074 6965 7273 2062 656c  verage tiers bel
-0001b930: 6f77 2c0a 2020 2020 2020 2020 2020 2020  ow,.            
-0001b940: 2020 2020 2020 2020 2020 2020 2320 2d20              # - 
-0001b950: 6120 7374 616b 6520 616d 6f75 6e74 206f  a stake amount o
-0001b960: 6620 3135 3020 776f 756c 6420 6d65 616e  f 150 would mean
-0001b970: 2061 206d 6178 206c 6576 6572 6167 6520   a max leverage 
-0001b980: 6f66 2028 3130 3030 3020 2f20 3135 3029  of (10000 / 150)
-0001b990: 203d 2036 362e 3636 0a20 2020 2020 2020   = 66.66.       
-0001b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b9b0: 2023 202d 2073 7461 6b65 7320 6265 6c6f   # - stakes belo
-0001b9c0: 7720 3133 332e 3333 203d 206d 6178 5f6c  w 133.33 = max_l
-0001b9d0: 6576 206f 6620 3735 0a20 2020 2020 2020  ev of 75.       
-0001b9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b9f0: 2023 202d 2073 7461 6b65 7320 6265 7477   # - stakes betw
-0001ba00: 6565 6e20 3133 332e 3333 2d32 3030 203d  een 133.33-200 =
-0001ba10: 206d 6178 5f6c 6576 206f 6620 3130 3030   max_lev of 1000
-0001ba20: 302f 7374 616b 6520 3d20 3530 2e30 312d  0/stake = 50.01-
-0001ba30: 3734 2e39 390a 2020 2020 2020 2020 2020  74.99.          
-0001ba40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001ba50: 2d20 7374 616b 6573 2066 726f 6d20 3230  - stakes from 20
-0001ba60: 3020 2b20 3130 3030 203d 206d 6178 5f6c  0 + 1000 = max_l
-0001ba70: 6576 206f 6620 3530 0a20 2020 2020 2020  ev of 50.       
-0001ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba90: 2023 0a20 2020 2020 2020 2020 2020 2020   #.             
-0001baa0: 2020 2020 2020 2020 2020 2023 207b 0a20             # {. 
-0001bab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bac0: 2020 2020 2020 2023 2020 2020 2022 6d69         #     "mi
-0001bad0: 6e22 3a20 302c 2020 2020 2020 2320 7374  n": 0,      # st
-0001bae0: 616b 6520 3d20 302e 300a 2020 2020 2020  ake = 0.0.      
-0001baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb00: 2020 2320 2020 2020 226d 6178 223a 2031    #     "max": 1
-0001bb10: 3030 3030 2c20 2023 206d 6178 5f73 7461  0000,  # max_sta
-0001bb20: 6b65 4037 3520 3d20 3130 3030 302f 3735  ke@75 = 10000/75
-0001bb30: 203d 2031 3333 2e33 3333 3333 3333 3333   = 133.333333333
-0001bb40: 3333 3333 340a 2020 2020 2020 2020 2020  33334.          
-0001bb50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001bb60: 2020 2020 226c 6576 223a 2037 352c 0a20      "lev": 75,. 
-0001bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb80: 2020 2020 2020 2023 207d 2c0a 2020 2020         # },.    
-0001bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bba0: 2020 2020 2320 7b0a 2020 2020 2020 2020      # {.        
-0001bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bbc0: 2320 2020 2020 226d 696e 223a 2031 3030  #     "min": 100
-0001bbd0: 3030 2c20 2023 2073 7461 6b65 203d 2032  00,  # stake = 2
-0001bbe0: 3030 2e30 0a20 2020 2020 2020 2020 2020  00.0.           
-0001bbf0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-0001bc00: 2020 2022 6d61 7822 3a20 3530 3030 302c     "max": 50000,
-0001bc10: 2020 2320 6d61 785f 7374 616b 6540 3530    # max_stake@50
-0001bc20: 203d 2035 3030 3030 2f35 3020 3d20 3130   = 50000/50 = 10
-0001bc30: 3030 2e30 0a20 2020 2020 2020 2020 2020  00.0.           
-0001bc40: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-0001bc50: 2020 2022 6c65 7622 3a20 3530 2c0a 2020     "lev": 50,.  
-0001bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc70: 2020 2020 2020 2320 7d0a 2020 2020 2020        # }.      
-0001bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc90: 2020 230a 0a20 2020 2020 2020 2020 2020    #..           
-0001bca0: 2020 2020 2065 6c73 653a 2020 2320 6966       else:  # if
-0001bcb0: 206f 6e20 7468 6520 6c61 7374 2074 6965   on the last tie
-0001bcc0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0001bcd0: 2020 2020 2020 6966 2073 7461 6b65 5f61        if stake_a
-0001bce0: 6d6f 756e 7420 3e20 7469 6572 5b27 6d61  mount > tier['ma
-0001bcf0: 784e 6f74 696f 6e61 6c27 5d3a 0a20 2020  xNotional']:.   
-0001bd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd10: 2020 2020 2023 2049 6620 7374 616b 6520       # If stake 
-0001bd20: 6973 203e 2074 6861 6e20 6d61 7820 7472  is > than max tr
-0001bd30: 6164 6561 626c 6520 616d 6f75 6e74 0a20  adeable amount. 
-0001bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd50: 2020 2020 2020 2072 6169 7365 2049 6e76         raise Inv
-0001bd60: 616c 6964 4f72 6465 7245 7863 6570 7469  alidOrderExcepti
-0001bd70: 6f6e 2866 2741 6d6f 756e 7420 7b73 7461  on(f'Amount {sta
-0001bd80: 6b65 5f61 6d6f 756e 747d 2074 6f6f 2068  ke_amount} too h
-0001bd90: 6967 6820 666f 7220 7b70 6169 727d 2729  igh for {pair}')
-0001bda0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bdb0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001bdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bdd0: 2020 2072 6574 7572 6e20 7469 6572 5b27     return tier['
-0001bde0: 6d61 784c 6576 6572 6167 6527 5d0a 0a20  maxLeverage'].. 
-0001bdf0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001be00: 204f 7065 7261 7469 6f6e 616c 4578 6365   OperationalExce
-0001be10: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
-0001be20: 2020 2020 2020 2027 4c6f 6f70 6564 2074         'Looped t
-0001be30: 6872 6f75 6768 2061 6c6c 2074 6965 7273  hrough all tiers
-0001be40: 2077 6974 686f 7574 2066 696e 6469 6e67   without finding
-0001be50: 2061 206d 6178 206c 6576 6572 6167 652e   a max leverage.
-0001be60: 2053 686f 756c 6420 6e65 7665 7220 6265   Should never be
-0001be70: 2072 6561 6368 6564 270a 2020 2020 2020   reached'.      
-0001be80: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001be90: 2065 6c69 6620 7365 6c66 2e74 7261 6469   elif self.tradi
-0001bea0: 6e67 5f6d 6f64 6520 3d3d 2054 7261 6469  ng_mode == Tradi
-0001beb0: 6e67 4d6f 6465 2e4d 4152 4749 4e3a 2020  ngMode.MARGIN:  
-0001bec0: 2320 5365 6172 6368 206d 6172 6b65 7473  # Search markets
-0001bed0: 2e6c 696d 6974 7320 666f 7220 6d61 7820  .limits for max 
-0001bee0: 6c65 760a 2020 2020 2020 2020 2020 2020  lev.            
-0001bef0: 6d61 726b 6574 203d 2073 656c 662e 6d61  market = self.ma
-0001bf00: 726b 6574 735b 7061 6972 5d0a 2020 2020  rkets[pair].    
-0001bf10: 2020 2020 2020 2020 6966 206d 6172 6b65          if marke
-0001bf20: 745b 276c 696d 6974 7327 5d5b 276c 6576  t['limits']['lev
-0001bf30: 6572 6167 6527 5d5b 276d 6178 275d 2069  erage']['max'] i
-0001bf40: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0001bf50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001bf60: 726e 206d 6172 6b65 745b 276c 696d 6974  rn market['limit
-0001bf70: 7327 5d5b 276c 6576 6572 6167 6527 5d5b  s']['leverage'][
-0001bf80: 276d 6178 275d 0a20 2020 2020 2020 2020  'max'].         
-0001bf90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001bfa0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001bfb0: 312e 3020 2023 2044 6566 6175 6c74 2069  1.0  # Default i
-0001bfc0: 6620 6d61 7820 6c65 7665 7261 6765 2063  f max leverage c
-0001bfd0: 616e 6e6f 7420 6265 2066 6f75 6e64 0a20  annot be found. 
-0001bfe0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001bff0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001c000: 312e 300a 0a20 2020 2040 7265 7472 6965  1.0..    @retrie
-0001c010: 720a 2020 2020 6465 6620 5f73 6574 5f6c  r.    def _set_l
-0001c020: 6576 6572 6167 6528 0a20 2020 2020 2020  everage(.       
-0001c030: 2073 656c 662c 0a20 2020 2020 2020 206c   self,.        l
-0001c040: 6576 6572 6167 653a 2066 6c6f 6174 2c0a  everage: float,.
-0001c050: 2020 2020 2020 2020 7061 6972 3a20 4f70          pair: Op
-0001c060: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-0001c070: 6e65 2c0a 2020 2020 2020 2020 6163 6365  ne,.        acce
-0001c080: 7074 5f66 6169 6c3a 2062 6f6f 6c20 3d20  pt_fail: bool = 
-0001c090: 4661 6c73 652c 0a20 2020 2029 3a0a 2020  False,.    ):.  
-0001c0a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001c0b0: 2020 5365 7427 7320 7468 6520 6c65 7665    Set's the leve
-0001c0c0: 7261 6765 2062 6566 6f72 6520 6d61 6b69  rage before maki
-0001c0d0: 6e67 2061 2074 7261 6465 2c20 696e 206f  ng a trade, in o
-0001c0e0: 7264 6572 2074 6f20 6e6f 740a 2020 2020  rder to not.    
-0001c0f0: 2020 2020 6861 7665 2074 6865 2073 616d      have the sam
-0001c100: 6520 6c65 7665 7261 6765 206f 6e20 6576  e leverage on ev
-0001c110: 6572 7920 7472 6164 650a 2020 2020 2020  ery trade.      
-0001c120: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-0001c130: 2073 656c 662e 5f63 6f6e 6669 675b 2764   self._config['d
-0001c140: 7279 5f72 756e 275d 206f 7220 6e6f 7420  ry_run'] or not 
-0001c150: 7365 6c66 2e65 7863 6861 6e67 655f 6861  self.exchange_ha
-0001c160: 7328 2273 6574 4c65 7665 7261 6765 2229  s("setLeverage")
-0001c170: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001c180: 536f 6d65 2065 7863 6861 6e67 6573 206f  Some exchanges o
-0001c190: 6e6c 7920 7375 7070 6f72 7420 6f6e 6520  nly support one 
-0001c1a0: 6d61 7267 696e 5f6d 6f64 6520 7479 7065  margin_mode type
-0001c1b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001c1c0: 7572 6e0a 2020 2020 2020 2020 6966 2073  urn.        if s
-0001c1d0: 656c 662e 5f66 745f 6861 732e 6765 7428  elf._ft_has.get(
-0001c1e0: 2766 6c6f 6f72 5f6c 6576 6572 6167 6527  'floor_leverage'
-0001c1f0: 2c20 4661 6c73 6529 2069 7320 5472 7565  , False) is True
-0001c200: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001c210: 526f 756e 6469 6e67 2066 6f72 2062 696e  Rounding for bin
-0001c220: 616e 6365 202e 2e2e 0a20 2020 2020 2020  ance ....       
-0001c230: 2020 2020 206c 6576 6572 6167 6520 3d20       leverage = 
-0001c240: 666c 6f6f 7228 6c65 7665 7261 6765 290a  floor(leverage).
-0001c250: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0001c260: 2020 2020 2020 2020 2072 6573 203d 2073           res = s
-0001c270: 656c 662e 5f61 7069 2e73 6574 5f6c 6576  elf._api.set_lev
-0001c280: 6572 6167 6528 7379 6d62 6f6c 3d70 6169  erage(symbol=pai
-0001c290: 722c 206c 6576 6572 6167 653d 6c65 7665  r, leverage=leve
-0001c2a0: 7261 6765 290a 2020 2020 2020 2020 2020  rage).          
-0001c2b0: 2020 7365 6c66 2e5f 6c6f 675f 6578 6368    self._log_exch
-0001c2c0: 616e 6765 5f72 6573 706f 6e73 6528 2773  ange_response('s
-0001c2d0: 6574 5f6c 6576 6572 6167 6527 2c20 7265  et_leverage', re
-0001c2e0: 7329 0a20 2020 2020 2020 2065 7863 6570  s).        excep
-0001c2f0: 7420 6363 7874 2e44 446f 5350 726f 7465  t ccxt.DDoSProte
-0001c300: 6374 696f 6e20 6173 2065 3a0a 2020 2020  ction as e:.    
-0001c310: 2020 2020 2020 2020 7261 6973 6520 4444          raise DD
-0001c320: 6f73 5072 6f74 6563 7469 6f6e 2865 2920  osProtection(e) 
-0001c330: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
-0001c340: 7863 6570 7420 2863 6378 742e 4261 6452  xcept (ccxt.BadR
-0001c350: 6571 7565 7374 2c20 6363 7874 2e49 6e73  equest, ccxt.Ins
-0001c360: 7566 6669 6369 656e 7446 756e 6473 2920  ufficientFunds) 
-0001c370: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0001c380: 2020 6966 206e 6f74 2061 6363 6570 745f    if not accept_
-0001c390: 6661 696c 3a0a 2020 2020 2020 2020 2020  fail:.          
-0001c3a0: 2020 2020 2020 7261 6973 6520 5465 6d70        raise Temp
-0001c3b0: 6f72 6172 7945 7272 6f72 280a 2020 2020  oraryError(.    
-0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3d0: 6627 436f 756c 6420 6e6f 7420 7365 7420  f'Could not set 
-0001c3e0: 6c65 7665 7261 6765 2064 7565 2074 6f20  leverage due to 
-0001c3f0: 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  {e.__class__.__n
-0001c400: 616d 655f 5f7d 2e20 4d65 7373 6167 653a  ame__}. Message:
-0001c410: 207b 657d 2729 2066 726f 6d20 650a 2020   {e}') from e.  
-0001c420: 2020 2020 2020 6578 6365 7074 2028 6363        except (cc
-0001c430: 7874 2e4e 6574 776f 726b 4572 726f 722c  xt.NetworkError,
-0001c440: 2063 6378 742e 4578 6368 616e 6765 4572   ccxt.ExchangeEr
-0001c450: 726f 7229 2061 7320 653a 0a20 2020 2020  ror) as e:.     
-0001c460: 2020 2020 2020 2072 6169 7365 2054 656d         raise Tem
-0001c470: 706f 7261 7279 4572 726f 7228 0a20 2020  poraryError(.   
-0001c480: 2020 2020 2020 2020 2020 2020 2066 2743               f'C
-0001c490: 6f75 6c64 206e 6f74 2073 6574 206c 6576  ould not set lev
-0001c4a0: 6572 6167 6520 6475 6520 746f 207b 652e  erage due to {e.
-0001c4b0: 5f5f 636c 6173 735f 5f2e 5f5f 6e61 6d65  __class__.__name
-0001c4c0: 5f5f 7d2e 204d 6573 7361 6765 3a20 7b65  __}. Message: {e
-0001c4d0: 7d27 2920 6672 6f6d 2065 0a20 2020 2020  }') from e.     
-0001c4e0: 2020 2065 7863 6570 7420 6363 7874 2e42     except ccxt.B
-0001c4f0: 6173 6545 7272 6f72 2061 7320 653a 0a20  aseError as e:. 
-0001c500: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001c510: 204f 7065 7261 7469 6f6e 616c 4578 6365   OperationalExce
-0001c520: 7074 696f 6e28 6529 2066 726f 6d20 650a  ption(e) from e.
-0001c530: 0a20 2020 2064 6566 2067 6574 5f69 6e74  .    def get_int
-0001c540: 6572 6573 745f 7261 7465 2873 656c 6629  erest_rate(self)
-0001c550: 202d 3e20 666c 6f61 743a 0a20 2020 2020   -> float:.     
-0001c560: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
-0001c570: 6574 7269 6576 6520 696e 7465 7265 7374  etrieve interest
-0001c580: 2072 6174 6520 2d20 6e65 6365 7373 6172   rate - necessar
-0001c590: 7920 666f 7220 4d61 7267 696e 2074 7261  y for Margin tra
-0001c5a0: 6469 6e67 2e0a 2020 2020 2020 2020 5368  ding..        Sh
-0001c5b0: 6f75 6c64 206e 6f74 2063 616c 6c20 7468  ould not call th
-0001c5c0: 6520 6578 6368 616e 6765 2064 6972 6563  e exchange direc
-0001c5d0: 746c 7920 7768 656e 2075 7365 6420 6672  tly when used fr
-0001c5e0: 6f6d 2062 6163 6b74 6573 7469 6e67 2e0a  om backtesting..
-0001c5f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001c600: 2020 2020 7265 7475 726e 2030 2e30 0a0a      return 0.0..
-0001c610: 2020 2020 6465 6620 6675 6e64 696e 675f      def funding_
-0001c620: 6665 655f 6375 746f 6666 2873 656c 662c  fee_cutoff(self,
-0001c630: 206f 7065 6e5f 6461 7465 3a20 6461 7465   open_date: date
-0001c640: 7469 6d65 293a 0a20 2020 2020 2020 2022  time):.        "
-0001c650: 2222 0a20 2020 2020 2020 203a 7061 7261  "".        :para
-0001c660: 6d20 6f70 656e 5f64 6174 653a 2054 6865  m open_date: The
-0001c670: 206f 7065 6e20 6461 7465 2066 6f72 2061   open date for a
-0001c680: 2074 7261 6465 0a20 2020 2020 2020 203a   trade.        :
-0001c690: 7265 7475 726e 3a20 5468 6520 6375 746f  return: The cuto
-0001c6a0: 6666 206f 7065 6e20 7469 6d65 2066 6f72  ff open time for
-0001c6b0: 2077 6865 6e20 6120 6675 6e64 696e 6720   when a funding 
-0001c6c0: 6665 6520 6973 2063 6861 7267 6564 0a20  fee is charged. 
-0001c6d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001c6e0: 2020 2072 6574 7572 6e20 6f70 656e 5f64     return open_d
-0001c6f0: 6174 652e 6d69 6e75 7465 203e 2030 206f  ate.minute > 0 o
-0001c700: 7220 6f70 656e 5f64 6174 652e 7365 636f  r open_date.seco
-0001c710: 6e64 203e 2030 0a0a 2020 2020 4072 6574  nd > 0..    @ret
-0001c720: 7269 6572 0a20 2020 2064 6566 2073 6574  rier.    def set
-0001c730: 5f6d 6172 6769 6e5f 6d6f 6465 2873 656c  _margin_mode(sel
-0001c740: 662c 2070 6169 723a 2073 7472 2c20 6d61  f, pair: str, ma
-0001c750: 7267 696e 5f6d 6f64 653a 204d 6172 6769  rgin_mode: Margi
-0001c760: 6e4d 6f64 652c 2061 6363 6570 745f 6661  nMode, accept_fa
-0001c770: 696c 3a20 626f 6f6c 203d 2046 616c 7365  il: bool = False
-0001c780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001c790: 2020 2020 2020 2020 2020 7061 7261 6d73            params
-0001c7a0: 3a20 6469 6374 203d 207b 7d29 3a0a 2020  : dict = {}):.  
-0001c7b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001c7c0: 2020 5365 7427 7320 7468 6520 6d61 7267    Set's the marg
-0001c7d0: 696e 206d 6f64 6520 6f6e 2074 6865 2065  in mode on the e
-0001c7e0: 7863 6861 6e67 6520 746f 2063 726f 7373  xchange to cross
-0001c7f0: 206f 7220 6973 6f6c 6174 6564 2066 6f72   or isolated for
-0001c800: 2061 2073 7065 6369 6669 6320 7061 6972   a specific pair
-0001c810: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0001c820: 7061 6972 3a20 6261 7365 2f71 756f 7465  pair: base/quote
-0001c830: 2063 7572 7265 6e63 7920 7061 6972 2028   currency pair (
-0001c840: 652e 672e 2022 4144 412f 5553 4454 2229  e.g. "ADA/USDT")
-0001c850: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001c860: 2020 2020 2069 6620 7365 6c66 2e5f 636f       if self._co
-0001c870: 6e66 6967 5b27 6472 795f 7275 6e27 5d20  nfig['dry_run'] 
-0001c880: 6f72 206e 6f74 2073 656c 662e 6578 6368  or not self.exch
-0001c890: 616e 6765 5f68 6173 2822 7365 744d 6172  ange_has("setMar
-0001c8a0: 6769 6e4d 6f64 6522 293a 0a20 2020 2020  ginMode"):.     
-0001c8b0: 2020 2020 2020 2023 2053 6f6d 6520 6578         # Some ex
-0001c8c0: 6368 616e 6765 7320 6f6e 6c79 2073 7570  changes only sup
-0001c8d0: 706f 7274 206f 6e65 206d 6172 6769 6e5f  port one margin_
-0001c8e0: 6d6f 6465 2074 7970 650a 2020 2020 2020  mode type.      
-0001c8f0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-0001c900: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0001c910: 2020 2020 2020 2072 6573 203d 2073 656c         res = sel
-0001c920: 662e 5f61 7069 2e73 6574 5f6d 6172 6769  f._api.set_margi
-0001c930: 6e5f 6d6f 6465 286d 6172 6769 6e5f 6d6f  n_mode(margin_mo
-0001c940: 6465 2e76 616c 7565 2c20 7061 6972 2c20  de.value, pair, 
-0001c950: 7061 7261 6d73 290a 2020 2020 2020 2020  params).        
-0001c960: 2020 2020 7365 6c66 2e5f 6c6f 675f 6578      self._log_ex
-0001c970: 6368 616e 6765 5f72 6573 706f 6e73 6528  change_response(
-0001c980: 2773 6574 5f6d 6172 6769 6e5f 6d6f 6465  'set_margin_mode
-0001c990: 272c 2072 6573 290a 2020 2020 2020 2020  ', res).        
-0001c9a0: 6578 6365 7074 2063 6378 742e 4444 6f53  except ccxt.DDoS
-0001c9b0: 5072 6f74 6563 7469 6f6e 2061 7320 653a  Protection as e:
-0001c9c0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0001c9d0: 7365 2044 446f 7350 726f 7465 6374 696f  se DDosProtectio
-0001c9e0: 6e28 6529 2066 726f 6d20 650a 2020 2020  n(e) from e.    
-0001c9f0: 2020 2020 6578 6365 7074 2063 6378 742e      except ccxt.
-0001ca00: 4261 6452 6571 7565 7374 2061 7320 653a  BadRequest as e:
-0001ca10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001ca20: 6e6f 7420 6163 6365 7074 5f66 6169 6c3a  not accept_fail:
-0001ca30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ca40: 2072 6169 7365 2054 656d 706f 7261 7279   raise Temporary
-0001ca50: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0001ca60: 2020 2020 2020 2020 2020 2066 2743 6f75             f'Cou
-0001ca70: 6c64 206e 6f74 2073 6574 206d 6172 6769  ld not set margi
-0001ca80: 6e20 6d6f 6465 2064 7565 2074 6f20 7b65  n mode due to {e
-0001ca90: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
-0001caa0: 655f 5f7d 2e20 4d65 7373 6167 653a 207b  e__}. Message: {
-0001cab0: 657d 2729 2066 726f 6d20 650a 2020 2020  e}') from e.    
-0001cac0: 2020 2020 6578 6365 7074 2028 6363 7874      except (ccxt
-0001cad0: 2e4e 6574 776f 726b 4572 726f 722c 2063  .NetworkError, c
-0001cae0: 6378 742e 4578 6368 616e 6765 4572 726f  cxt.ExchangeErro
-0001caf0: 7229 2061 7320 653a 0a20 2020 2020 2020  r) as e:.       
-0001cb00: 2020 2020 2072 6169 7365 2054 656d 706f       raise Tempo
-0001cb10: 7261 7279 4572 726f 7228 0a20 2020 2020  raryError(.     
-0001cb20: 2020 2020 2020 2020 2020 2066 2743 6f75             f'Cou
-0001cb30: 6c64 206e 6f74 2073 6574 206d 6172 6769  ld not set margi
-0001cb40: 6e20 6d6f 6465 2064 7565 2074 6f20 7b65  n mode due to {e
-0001cb50: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
-0001cb60: 655f 5f7d 2e20 4d65 7373 6167 653a 207b  e__}. Message: {
-0001cb70: 657d 2729 2066 726f 6d20 650a 2020 2020  e}') from e.    
-0001cb80: 2020 2020 6578 6365 7074 2063 6378 742e      except ccxt.
-0001cb90: 4261 7365 4572 726f 7220 6173 2065 3a0a  BaseError as e:.
-0001cba0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001cbb0: 6520 4f70 6572 6174 696f 6e61 6c45 7863  e OperationalExc
-0001cbc0: 6570 7469 6f6e 2865 2920 6672 6f6d 2065  eption(e) from e
-0001cbd0: 0a0a 2020 2020 6465 6620 5f66 6574 6368  ..    def _fetch
-0001cbe0: 5f61 6e64 5f63 616c 6375 6c61 7465 5f66  _and_calculate_f
-0001cbf0: 756e 6469 6e67 5f66 6565 7328 0a20 2020  unding_fees(.   
-0001cc00: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0001cc10: 2020 2070 6169 723a 2073 7472 2c0a 2020     pair: str,.  
-0001cc20: 2020 2020 2020 616d 6f75 6e74 3a20 666c        amount: fl
-0001cc30: 6f61 742c 0a20 2020 2020 2020 2069 735f  oat,.        is_
-0001cc40: 7368 6f72 743a 2062 6f6f 6c2c 0a20 2020  short: bool,.   
-0001cc50: 2020 2020 206f 7065 6e5f 6461 7465 3a20       open_date: 
-0001cc60: 6461 7465 7469 6d65 2c0a 2020 2020 2020  datetime,.      
-0001cc70: 2020 636c 6f73 655f 6461 7465 3a20 4f70    close_date: Op
-0001cc80: 7469 6f6e 616c 5b64 6174 6574 696d 655d  tional[datetime]
-0001cc90: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
-0001cca0: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
-0001ccb0: 2222 220a 2020 2020 2020 2020 4665 7463  """.        Fetc
-0001ccc0: 6865 7320 616e 6420 6361 6c63 756c 6174  hes and calculat
-0001ccd0: 6573 2074 6865 2073 756d 206f 6620 616c  es the sum of al
-0001cce0: 6c20 6675 6e64 696e 6720 6665 6573 2074  l funding fees t
-0001ccf0: 6861 7420 6f63 6375 7272 6564 2066 6f72  hat occurred for
-0001cd00: 2061 2070 6169 720a 2020 2020 2020 2020   a pair.        
-0001cd10: 6475 7269 6e67 2061 2066 7574 7572 6573  during a futures
-0001cd20: 2074 7261 6465 2e0a 2020 2020 2020 2020   trade..        
-0001cd30: 4f6e 6c79 2075 7365 6420 6475 7269 6e67  Only used during
-0001cd40: 2064 7279 2d72 756e 206f 7220 6966 2074   dry-run or if t
-0001cd50: 6865 2065 7863 6861 6e67 6520 646f 6573  he exchange does
-0001cd60: 206e 6f74 2070 726f 7669 6465 2061 2066   not provide a f
-0001cd70: 756e 6469 6e67 5f72 6174 6573 2065 6e64  unding_rates end
-0001cd80: 706f 696e 742e 0a20 2020 2020 2020 203a  point..        :
-0001cd90: 7061 7261 6d20 7061 6972 3a20 5468 6520  param pair: The 
-0001cda0: 7175 6f74 652f 6261 7365 2070 6169 7220  quote/base pair 
-0001cdb0: 6f66 2074 6865 2074 7261 6465 0a20 2020  of the trade.   
-0001cdc0: 2020 2020 203a 7061 7261 6d20 616d 6f75       :param amou
-0001cdd0: 6e74 3a20 5468 6520 7175 616e 7469 7479  nt: The quantity
-0001cde0: 206f 6620 7468 6520 7472 6164 650a 2020   of the trade.  
-0001cdf0: 2020 2020 2020 3a70 6172 616d 2069 735f        :param is_
-0001ce00: 7368 6f72 743a 2074 7261 6465 2064 6972  short: trade dir
-0001ce10: 6563 7469 6f6e 0a20 2020 2020 2020 203a  ection.        :
-0001ce20: 7061 7261 6d20 6f70 656e 5f64 6174 653a  param open_date:
-0001ce30: 2054 6865 2064 6174 6520 616e 6420 7469   The date and ti
-0001ce40: 6d65 2074 6861 7420 7468 6520 7472 6164  me that the trad
-0001ce50: 6520 7374 6172 7465 640a 2020 2020 2020  e started.      
-0001ce60: 2020 3a70 6172 616d 2063 6c6f 7365 5f64    :param close_d
-0001ce70: 6174 653a 2054 6865 2064 6174 6520 616e  ate: The date an
-0001ce80: 6420 7469 6d65 2074 6861 7420 7468 6520  d time that the 
-0001ce90: 7472 6164 6520 656e 6465 640a 2020 2020  trade ended.    
-0001cea0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-0001ceb0: 2069 6620 7365 6c66 2e66 756e 6469 6e67   if self.funding
-0001cec0: 5f66 6565 5f63 7574 6f66 6628 6f70 656e  _fee_cutoff(open
-0001ced0: 5f64 6174 6529 3a0a 2020 2020 2020 2020  _date):.        
-0001cee0: 2020 2020 6f70 656e 5f64 6174 6520 2b3d      open_date +=
-0001cef0: 2074 696d 6564 656c 7461 2868 6f75 7273   timedelta(hours
-0001cf00: 3d31 290a 2020 2020 2020 2020 7469 6d65  =1).        time
-0001cf10: 6672 616d 6520 3d20 7365 6c66 2e5f 6674  frame = self._ft
-0001cf20: 5f68 6173 5b27 6d61 726b 5f6f 686c 6376  _has['mark_ohlcv
-0001cf30: 5f74 696d 6566 7261 6d65 275d 0a20 2020  _timeframe'].   
-0001cf40: 2020 2020 2074 696d 6566 7261 6d65 5f66       timeframe_f
-0001cf50: 6620 3d20 7365 6c66 2e5f 6674 5f68 6173  f = self._ft_has
-0001cf60: 2e67 6574 2827 6675 6e64 696e 675f 6665  .get('funding_fe
-0001cf70: 655f 7469 6d65 6672 616d 6527 2c0a 2020  e_timeframe',.  
-0001cf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019220: 2020 2020 2020 2073 696e 6365 3a20 4f70         since: Op
+00019230: 7469 6f6e 616c 5b69 6e74 5d20 3d20 4e6f  tional[int] = No
+00019240: 6e65 2920 2d3e 2054 7570 6c65 5b73 7472  ne) -> Tuple[str
+00019250: 2c20 4c69 7374 5b4c 6973 745d 5d3a 0a20  , List[List]]:. 
+00019260: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00019270: 2020 2041 7379 6e63 726f 6e6f 7573 6c79     Asyncronously
+00019280: 2067 6574 7320 7472 6164 6520 6869 7374   gets trade hist
+00019290: 6f72 7920 7573 696e 6720 6665 7463 685f  ory using fetch_
+000192a0: 7472 6164 6573 2c0a 2020 2020 2020 2020  trades,.        
+000192b0: 7768 656e 2074 6865 2065 7863 6861 6e67  when the exchang
+000192c0: 6520 7573 6573 2074 696d 652d 6261 7365  e uses time-base
+000192d0: 6420 6974 6572 6174 696f 6e20 2863 6865  d iteration (che
+000192e0: 636b 2060 7365 6c66 2e5f 7472 6164 6573  ck `self._trades
+000192f0: 5f70 6167 696e 6174 696f 6e60 290a 2020  _pagination`).  
+00019300: 2020 2020 2020 3a70 6172 616d 2070 6169        :param pai
+00019310: 723a 2050 6169 7220 746f 2066 6574 6368  r: Pair to fetch
+00019320: 2074 7261 6465 2064 6174 6120 666f 720a   trade data for.
+00019330: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
+00019340: 696e 6365 3a20 5369 6e63 6520 6173 2069  ince: Since as i
+00019350: 6e74 6567 6572 2074 696d 6573 7461 6d70  nteger timestamp
+00019360: 2069 6e20 6d69 6c6c 6973 6563 6f6e 6473   in milliseconds
+00019370: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00019380: 756e 7469 6c3a 2055 6e74 696c 2061 7320  until: Until as 
+00019390: 696e 7465 6765 7220 7469 6d65 7374 616d  integer timestam
+000193a0: 7020 696e 206d 696c 6c69 7365 636f 6e64  p in millisecond
+000193b0: 730a 2020 2020 2020 2020 7265 7475 726e  s.        return
+000193c0: 7320 7475 706c 653a 2028 7061 6972 2c20  s tuple: (pair, 
+000193d0: 7472 6164 6573 2d6c 6973 7429 0a20 2020  trades-list).   
+000193e0: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+000193f0: 2020 7472 6164 6573 3a20 4c69 7374 5b4c    trades: List[L
+00019400: 6973 745d 203d 205b 5d0a 2020 2020 2020  ist] = [].      
+00019410: 2020 2320 4445 4641 554c 545f 5452 4144    # DEFAULT_TRAD
+00019420: 4553 5f43 4f4c 554d 4e53 3a20 3020 2d3e  ES_COLUMNS: 0 ->
+00019430: 2074 696d 6573 7461 6d70 0a20 2020 2020   timestamp.     
+00019440: 2020 2023 2044 4546 4155 4c54 5f54 5241     # DEFAULT_TRA
+00019450: 4445 535f 434f 4c55 4d4e 533a 2031 202d  DES_COLUMNS: 1 -
+00019460: 3e20 6964 0a20 2020 2020 2020 2077 6869  > id.        whi
+00019470: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
+00019480: 2020 2020 2074 203d 2061 7761 6974 2073       t = await s
+00019490: 656c 662e 5f61 7379 6e63 5f66 6574 6368  elf._async_fetch
+000194a0: 5f74 7261 6465 7328 7061 6972 2c20 7369  _trades(pair, si
+000194b0: 6e63 653d 7369 6e63 6529 0a20 2020 2020  nce=since).     
+000194c0: 2020 2020 2020 2069 6620 743a 0a20 2020         if t:.   
+000194d0: 2020 2020 2020 2020 2020 2020 2073 696e               sin
+000194e0: 6365 203d 2074 5b2d 315d 5b30 5d0a 2020  ce = t[-1][0].  
+000194f0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00019500: 6164 6573 2e65 7874 656e 6428 7429 0a20  ades.extend(t). 
+00019510: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00019520: 2052 6561 6368 6564 2074 6865 2065 6e64   Reached the end
+00019530: 206f 6620 7468 6520 6465 6669 6e65 642d   of the defined-
+00019540: 646f 776e 6c6f 6164 2070 6572 696f 640a  download period.
+00019550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019560: 6966 2075 6e74 696c 2061 6e64 2074 5b2d  if until and t[-
+00019570: 315d 5b30 5d20 3e20 756e 7469 6c3a 0a20  1][0] > until:. 
+00019580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019590: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+000195a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000195b0: 2020 2020 2020 2020 2066 2253 746f 7070           f"Stopp
+000195c0: 696e 6720 6265 6361 7573 6520 756e 7469  ing because unti
+000195d0: 6c20 7761 7320 7265 6163 6865 642e 207b  l was reached. {
+000195e0: 745b 2d31 5d5b 305d 7d20 3e20 7b75 6e74  t[-1][0]} > {unt
+000195f0: 696c 7d22 290a 2020 2020 2020 2020 2020  il}").          
+00019600: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00019610: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00019620: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019630: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+00019640: 2072 6574 7572 6e20 2870 6169 722c 2074   return (pair, t
+00019650: 7261 6465 7329 0a0a 2020 2020 6173 796e  rades)..    asyn
+00019660: 6320 6465 6620 5f61 7379 6e63 5f67 6574  c def _async_get
+00019670: 5f74 7261 6465 5f68 6973 746f 7279 2873  _trade_history(s
+00019680: 656c 662c 2070 6169 723a 2073 7472 2c0a  elf, pair: str,.
+00019690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196b0: 2020 2020 2020 2073 696e 6365 3a20 4f70         since: Op
+000196c0: 7469 6f6e 616c 5b69 6e74 5d20 3d20 4e6f  tional[int] = No
+000196d0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+000196e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196f0: 2020 2020 2020 2020 2020 2075 6e74 696c             until
+00019700: 3a20 4f70 7469 6f6e 616c 5b69 6e74 5d20  : Optional[int] 
+00019710: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00019720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019730: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00019740: 726f 6d5f 6964 3a20 4f70 7469 6f6e 616c  rom_id: Optional
+00019750: 5b73 7472 5d20 3d20 4e6f 6e65 2920 2d3e  [str] = None) ->
+00019760: 2054 7570 6c65 5b73 7472 2c20 4c69 7374   Tuple[str, List
+00019770: 5b4c 6973 745d 5d3a 0a20 2020 2020 2020  [List]]:.       
+00019780: 2022 2222 0a20 2020 2020 2020 2041 7379   """.        Asy
+00019790: 6e63 2077 7261 7070 6572 2068 616e 646c  nc wrapper handl
+000197a0: 696e 6720 646f 776e 6c6f 6164 696e 6720  ing downloading 
+000197b0: 7472 6164 6573 2075 7369 6e67 2065 6974  trades using eit
+000197c0: 6865 7220 7469 6d65 206f 7220 6964 2062  her time or id b
+000197d0: 6173 6564 206d 6574 686f 6473 2e0a 2020  ased methods..  
+000197e0: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+000197f0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00019800: 6622 5f61 7379 6e63 5f67 6574 5f74 7261  f"_async_get_tra
+00019810: 6465 5f68 6973 746f 7279 2829 2c20 7061  de_history(), pa
+00019820: 6972 3a20 7b70 6169 727d 2c20 220a 2020  ir: {pair}, ".  
+00019830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019840: 2020 2066 2273 696e 6365 3a20 7b73 696e     f"since: {sin
+00019850: 6365 7d2c 2075 6e74 696c 3a20 7b75 6e74  ce}, until: {unt
+00019860: 696c 7d2c 2066 726f 6d5f 6964 3a20 7b66  il}, from_id: {f
+00019870: 726f 6d5f 6964 7d22 290a 0a20 2020 2020  rom_id}")..     
+00019880: 2020 2069 6620 756e 7469 6c20 6973 204e     if until is N
+00019890: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000198a0: 2075 6e74 696c 203d 2063 6378 742e 4578   until = ccxt.Ex
+000198b0: 6368 616e 6765 2e6d 696c 6c69 7365 636f  change.milliseco
+000198c0: 6e64 7328 290a 2020 2020 2020 2020 2020  nds().          
+000198d0: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
+000198e0: 2245 7863 6861 6e67 6520 6d69 6c6c 6973  "Exchange millis
+000198f0: 6563 6f6e 6473 3a20 7b75 6e74 696c 7d22  econds: {until}"
+00019900: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+00019910: 6c66 2e5f 7472 6164 6573 5f70 6167 696e  lf._trades_pagin
+00019920: 6174 696f 6e20 3d3d 2027 7469 6d65 273a  ation == 'time':
+00019930: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00019940: 7572 6e20 6177 6169 7420 7365 6c66 2e5f  urn await self._
+00019950: 6173 796e 635f 6765 745f 7472 6164 655f  async_get_trade_
+00019960: 6869 7374 6f72 795f 7469 6d65 280a 2020  history_time(.  
+00019970: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00019980: 6972 3d70 6169 722c 2073 696e 6365 3d73  ir=pair, since=s
+00019990: 696e 6365 2c20 756e 7469 6c3d 756e 7469  ince, until=unti
+000199a0: 6c29 0a20 2020 2020 2020 2065 6c69 6620  l).        elif 
+000199b0: 7365 6c66 2e5f 7472 6164 6573 5f70 6167  self._trades_pag
+000199c0: 696e 6174 696f 6e20 3d3d 2027 6964 273a  ination == 'id':
+000199d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000199e0: 7572 6e20 6177 6169 7420 7365 6c66 2e5f  urn await self._
+000199f0: 6173 796e 635f 6765 745f 7472 6164 655f  async_get_trade_
+00019a00: 6869 7374 6f72 795f 6964 280a 2020 2020  history_id(.    
+00019a10: 2020 2020 2020 2020 2020 2020 7061 6972              pair
+00019a20: 3d70 6169 722c 2073 696e 6365 3d73 696e  =pair, since=sin
+00019a30: 6365 2c20 756e 7469 6c3d 756e 7469 6c2c  ce, until=until,
+00019a40: 2066 726f 6d5f 6964 3d66 726f 6d5f 6964   from_id=from_id
+00019a50: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00019a60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00019a70: 2020 2020 2020 2020 2072 6169 7365 204f           raise O
+00019a80: 7065 7261 7469 6f6e 616c 4578 6365 7074  perationalExcept
+00019a90: 696f 6e28 6622 4578 6368 616e 6765 207b  ion(f"Exchange {
+00019aa0: 7365 6c66 2e6e 616d 657d 2064 6f65 7320  self.name} does 
+00019ab0: 7573 6520 6e65 6974 6865 7220 7469 6d65  use neither time
+00019ac0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
+00019ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ae0: 2020 2020 2020 2020 2020 2066 226e 6f72             f"nor
+00019af0: 2069 6420 6261 7365 6420 7061 6769 6e61   id based pagina
+00019b00: 7469 6f6e 2229 0a0a 2020 2020 6465 6620  tion")..    def 
+00019b10: 6765 745f 6869 7374 6f72 6963 5f74 7261  get_historic_tra
+00019b20: 6465 7328 7365 6c66 2c20 7061 6972 3a20  des(self, pair: 
+00019b30: 7374 722c 0a20 2020 2020 2020 2020 2020  str,.           
+00019b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b50: 2073 696e 6365 3a20 4f70 7469 6f6e 616c   since: Optional
+00019b60: 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a 2020  [int] = None,.  
+00019b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b80: 2020 2020 2020 2020 2020 756e 7469 6c3a            until:
+00019b90: 204f 7074 696f 6e61 6c5b 696e 745d 203d   Optional[int] =
+00019ba0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00019bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019bc0: 2020 2066 726f 6d5f 6964 3a20 4f70 7469     from_id: Opti
+00019bd0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00019be0: 2920 2d3e 2054 7570 6c65 5b73 7472 2c20  ) -> Tuple[str, 
+00019bf0: 4c69 7374 5d3a 0a20 2020 2020 2020 2022  List]:.        "
+00019c00: 2222 0a20 2020 2020 2020 2047 6574 2074  "".        Get t
+00019c10: 7261 6465 2068 6973 746f 7279 2064 6174  rade history dat
+00019c20: 6120 7573 696e 6720 6173 796e 6369 6f2e  a using asyncio.
+00019c30: 0a20 2020 2020 2020 2048 616e 646c 6573  .        Handles
+00019c40: 2061 6c6c 2061 7379 6e63 2077 6f72 6b20   all async work 
+00019c50: 616e 6420 7265 7475 726e 7320 7468 6520  and returns the 
+00019c60: 6c69 7374 206f 6620 6361 6e64 6c65 732e  list of candles.
+00019c70: 0a20 2020 2020 2020 2041 7379 6e63 206f  .        Async o
+00019c80: 7665 7220 6f6e 6520 7061 6972 2c20 6173  ver one pair, as
+00019c90: 7375 6d69 6e67 2077 6520 6765 7420 6073  suming we get `s
+00019ca0: 656c 662e 6f68 6c63 765f 6361 6e64 6c65  elf.ohlcv_candle
+00019cb0: 5f6c 696d 6974 2829 6020 6361 6e64 6c65  _limit()` candle
+00019cc0: 7320 7065 7220 6361 6c6c 2e0a 2020 2020  s per call..    
+00019cd0: 2020 2020 3a70 6172 616d 2070 6169 723a      :param pair:
+00019ce0: 2050 6169 7220 746f 2064 6f77 6e6c 6f61   Pair to downloa
+00019cf0: 640a 2020 2020 2020 2020 3a70 6172 616d  d.        :param
+00019d00: 2073 696e 6365 3a20 5469 6d65 7374 616d   since: Timestam
+00019d10: 7020 696e 206d 696c 6c69 7365 636f 6e64  p in millisecond
+00019d20: 7320 746f 2067 6574 2068 6973 746f 7279  s to get history
+00019d30: 2066 726f 6d0a 2020 2020 2020 2020 3a70   from.        :p
+00019d40: 6172 616d 2075 6e74 696c 3a20 5469 6d65  aram until: Time
+00019d50: 7374 616d 7020 696e 206d 696c 6c69 7365  stamp in millise
+00019d60: 636f 6e64 732e 2044 6566 6175 6c74 7320  conds. Defaults 
+00019d70: 746f 2063 7572 7265 6e74 2074 696d 6573  to current times
+00019d80: 7461 6d70 2069 6620 6e6f 7420 6465 6669  tamp if not defi
+00019d90: 6e65 642e 0a20 2020 2020 2020 203a 7061  ned..        :pa
+00019da0: 7261 6d20 6672 6f6d 5f69 643a 2044 6f77  ram from_id: Dow
+00019db0: 6e6c 6f61 6420 6461 7461 2073 7461 7274  nload data start
+00019dc0: 696e 6720 7769 7468 2049 4420 2869 6620  ing with ID (if 
+00019dd0: 6964 2069 7320 6b6e 6f77 6e29 0a20 2020  id is known).   
+00019de0: 2020 2020 203a 7265 7475 726e 7320 4c69       :returns Li
+00019df0: 7374 206f 6620 7472 6164 6520 6461 7461  st of trade data
+00019e00: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00019e10: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00019e20: 2e65 7863 6861 6e67 655f 6861 7328 2266  .exchange_has("f
+00019e30: 6574 6368 5472 6164 6573 2229 3a0a 2020  etchTrades"):.  
+00019e40: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00019e50: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
+00019e60: 7469 6f6e 2822 5468 6973 2065 7863 6861  tion("This excha
+00019e70: 6e67 6520 646f 6573 206e 6f74 2073 7570  nge does not sup
+00019e80: 706f 7274 2064 6f77 6e6c 6f61 6469 6e67  port downloading
+00019e90: 2054 7261 6465 732e 2229 0a0a 2020 2020   Trades.")..    
+00019ea0: 2020 2020 7769 7468 2073 656c 662e 5f6c      with self._l
+00019eb0: 6f6f 705f 6c6f 636b 3a0a 2020 2020 2020  oop_lock:.      
+00019ec0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00019ed0: 662e 6c6f 6f70 2e72 756e 5f75 6e74 696c  f.loop.run_until
+00019ee0: 5f63 6f6d 706c 6574 6528 0a20 2020 2020  _complete(.     
+00019ef0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00019f00: 5f61 7379 6e63 5f67 6574 5f74 7261 6465  _async_get_trade
+00019f10: 5f68 6973 746f 7279 2870 6169 723d 7061  _history(pair=pa
+00019f20: 6972 2c20 7369 6e63 653d 7369 6e63 652c  ir, since=since,
+00019f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f50: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00019f60: 6e74 696c 3d75 6e74 696c 2c20 6672 6f6d  ntil=until, from
+00019f70: 5f69 643d 6672 6f6d 5f69 6429 290a 0a20  _id=from_id)).. 
+00019f80: 2020 2040 7265 7472 6965 720a 2020 2020     @retrier.    
+00019f90: 6465 6620 5f67 6574 5f66 756e 6469 6e67  def _get_funding
+00019fa0: 5f66 6565 735f 6672 6f6d 5f65 7863 6861  _fees_from_excha
+00019fb0: 6e67 6528 7365 6c66 2c20 7061 6972 3a20  nge(self, pair: 
+00019fc0: 7374 722c 2073 696e 6365 3a20 556e 696f  str, since: Unio
+00019fd0: 6e5b 6461 7465 7469 6d65 2c20 696e 745d  n[datetime, int]
+00019fe0: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
+00019ff0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001a000: 5265 7475 726e 7320 7468 6520 7375 6d20  Returns the sum 
+0001a010: 6f66 2061 6c6c 2066 756e 6469 6e67 2066  of all funding f
+0001a020: 6565 7320 7468 6174 2077 6572 6520 6578  ees that were ex
+0001a030: 6368 616e 6765 6420 666f 7220 6120 7061  changed for a pa
+0001a040: 6972 2077 6974 6869 6e20 6120 7469 6d65  ir within a time
+0001a050: 6672 616d 650a 2020 2020 2020 2020 4472  frame.        Dr
+0001a060: 792d 7275 6e20 6861 6e64 6c69 6e67 2068  y-run handling h
+0001a070: 6170 7065 6e73 2061 7320 7061 7274 206f  appens as part o
+0001a080: 6620 5f63 616c 6375 6c61 7465 5f66 756e  f _calculate_fun
+0001a090: 6469 6e67 5f66 6565 732e 0a20 2020 2020  ding_fees..     
+0001a0a0: 2020 203a 7061 7261 6d20 7061 6972 3a20     :param pair: 
+0001a0b0: 2865 2e67 2e20 4144 412f 5553 4454 290a  (e.g. ADA/USDT).
+0001a0c0: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
+0001a0d0: 696e 6365 3a20 5468 6520 6561 726c 6965  ince: The earlie
+0001a0e0: 7374 2074 696d 6520 6f66 2063 6f6e 7369  st time of consi
+0001a0f0: 6465 7261 7469 6f6e 2066 6f72 2063 616c  deration for cal
+0001a100: 6375 6c61 7469 6e67 2066 756e 6469 6e67  culating funding
+0001a110: 2066 6565 732c 0a20 2020 2020 2020 2020   fees,.         
+0001a120: 2020 2069 6e20 756e 6978 2074 696d 6520     in unix time 
+0001a130: 6f72 2061 7320 6120 6461 7465 7469 6d65  or as a datetime
+0001a140: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001a150: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0001a160: 2e65 7863 6861 6e67 655f 6861 7328 2266  .exchange_has("f
+0001a170: 6574 6368 4675 6e64 696e 6748 6973 746f  etchFundingHisto
+0001a180: 7279 2229 3a0a 2020 2020 2020 2020 2020  ry"):.          
+0001a190: 2020 7261 6973 6520 4f70 6572 6174 696f    raise Operatio
+0001a1a0: 6e61 6c45 7863 6570 7469 6f6e 280a 2020  nalException(.  
+0001a1b0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0001a1c0: 6665 7463 685f 6675 6e64 696e 675f 6869  fetch_funding_hi
+0001a1d0: 7374 6f72 7928 2920 6973 206e 6f74 2061  story() is not a
+0001a1e0: 7661 696c 6162 6c65 2075 7369 6e67 207b  vailable using {
+0001a1f0: 7365 6c66 2e6e 616d 657d 220a 2020 2020  self.name}".    
+0001a200: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0001a210: 2020 2069 6620 7479 7065 2873 696e 6365     if type(since
+0001a220: 2920 6973 2064 6174 6574 696d 653a 0a20  ) is datetime:. 
+0001a230: 2020 2020 2020 2020 2020 2073 696e 6365             since
+0001a240: 203d 2069 6e74 2873 696e 6365 2e74 696d   = int(since.tim
+0001a250: 6573 7461 6d70 2829 2920 2a20 3130 3030  estamp()) * 1000
+0001a260: 2020 2023 202a 2031 3030 3020 666f 7220     # * 1000 for 
+0001a270: 6d73 0a0a 2020 2020 2020 2020 7472 793a  ms..        try:
+0001a280: 0a20 2020 2020 2020 2020 2020 2066 756e  .            fun
+0001a290: 6469 6e67 5f68 6973 746f 7279 203d 2073  ding_history = s
+0001a2a0: 656c 662e 5f61 7069 2e66 6574 6368 5f66  elf._api.fetch_f
+0001a2b0: 756e 6469 6e67 5f68 6973 746f 7279 280a  unding_history(.
+0001a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2d0: 7379 6d62 6f6c 3d70 6169 722c 0a20 2020  symbol=pair,.   
+0001a2e0: 2020 2020 2020 2020 2020 2020 2073 696e               sin
+0001a2f0: 6365 3d73 696e 6365 0a20 2020 2020 2020  ce=since.       
+0001a300: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001a310: 2020 2072 6574 7572 6e20 7375 6d28 6665     return sum(fe
+0001a320: 655b 2761 6d6f 756e 7427 5d20 666f 7220  e['amount'] for 
+0001a330: 6665 6520 696e 2066 756e 6469 6e67 5f68  fee in funding_h
+0001a340: 6973 746f 7279 290a 2020 2020 2020 2020  istory).        
+0001a350: 6578 6365 7074 2063 6378 742e 4444 6f53  except ccxt.DDoS
+0001a360: 5072 6f74 6563 7469 6f6e 2061 7320 653a  Protection as e:
+0001a370: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0001a380: 7365 2044 446f 7350 726f 7465 6374 696f  se DDosProtectio
+0001a390: 6e28 6529 2066 726f 6d20 650a 2020 2020  n(e) from e.    
+0001a3a0: 2020 2020 6578 6365 7074 2028 6363 7874      except (ccxt
+0001a3b0: 2e4e 6574 776f 726b 4572 726f 722c 2063  .NetworkError, c
+0001a3c0: 6378 742e 4578 6368 616e 6765 4572 726f  cxt.ExchangeErro
+0001a3d0: 7229 2061 7320 653a 0a20 2020 2020 2020  r) as e:.       
+0001a3e0: 2020 2020 2072 6169 7365 2054 656d 706f       raise Tempo
+0001a3f0: 7261 7279 4572 726f 7228 0a20 2020 2020  raryError(.     
+0001a400: 2020 2020 2020 2020 2020 2066 2743 6f75             f'Cou
+0001a410: 6c64 206e 6f74 2067 6574 2066 756e 6469  ld not get fundi
+0001a420: 6e67 2066 6565 7320 6475 6520 746f 207b  ng fees due to {
+0001a430: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
+0001a440: 6d65 5f5f 7d2e 204d 6573 7361 6765 3a20  me__}. Message: 
+0001a450: 7b65 7d27 2920 6672 6f6d 2065 0a20 2020  {e}') from e.   
+0001a460: 2020 2020 2065 7863 6570 7420 6363 7874       except ccxt
+0001a470: 2e42 6173 6545 7272 6f72 2061 7320 653a  .BaseError as e:
+0001a480: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0001a490: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
+0001a4a0: 6365 7074 696f 6e28 6529 2066 726f 6d20  ception(e) from 
+0001a4b0: 650a 0a20 2020 2040 7265 7472 6965 720a  e..    @retrier.
+0001a4c0: 2020 2020 6465 6620 6765 745f 6c65 7665      def get_leve
+0001a4d0: 7261 6765 5f74 6965 7273 2873 656c 6629  rage_tiers(self)
+0001a4e0: 202d 3e20 4469 6374 5b73 7472 2c20 4c69   -> Dict[str, Li
+0001a4f0: 7374 5b44 6963 745d 5d3a 0a20 2020 2020  st[Dict]]:.     
+0001a500: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001a510: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0001a520: 5f61 7069 2e66 6574 6368 5f6c 6576 6572  _api.fetch_lever
+0001a530: 6167 655f 7469 6572 7328 290a 2020 2020  age_tiers().    
+0001a540: 2020 2020 6578 6365 7074 2063 6378 742e      except ccxt.
+0001a550: 4444 6f53 5072 6f74 6563 7469 6f6e 2061  DDoSProtection a
+0001a560: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0001a570: 2072 6169 7365 2044 446f 7350 726f 7465   raise DDosProte
+0001a580: 6374 696f 6e28 6529 2066 726f 6d20 650a  ction(e) from e.
+0001a590: 2020 2020 2020 2020 6578 6365 7074 2028          except (
+0001a5a0: 6363 7874 2e4e 6574 776f 726b 4572 726f  ccxt.NetworkErro
+0001a5b0: 722c 2063 6378 742e 4578 6368 616e 6765  r, ccxt.Exchange
+0001a5c0: 4572 726f 7229 2061 7320 653a 0a20 2020  Error) as e:.   
+0001a5d0: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
+0001a5e0: 656d 706f 7261 7279 4572 726f 7228 0a20  emporaryError(. 
+0001a5f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001a600: 2743 6f75 6c64 206e 6f74 206c 6f61 6420  'Could not load 
+0001a610: 6c65 7665 7261 6765 2074 6965 7273 2064  leverage tiers d
+0001a620: 7565 2074 6f20 7b65 2e5f 5f63 6c61 7373  ue to {e.__class
+0001a630: 5f5f 2e5f 5f6e 616d 655f 5f7d 2e20 4d65  __.__name__}. Me
+0001a640: 7373 6167 653a 207b 657d 270a 2020 2020  ssage: {e}'.    
+0001a650: 2020 2020 2020 2020 2920 6672 6f6d 2065          ) from e
+0001a660: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0001a670: 6363 7874 2e42 6173 6545 7272 6f72 2061  ccxt.BaseError a
+0001a680: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0001a690: 2072 6169 7365 204f 7065 7261 7469 6f6e   raise Operation
+0001a6a0: 616c 4578 6365 7074 696f 6e28 6529 2066  alException(e) f
+0001a6b0: 726f 6d20 650a 0a20 2020 2040 7265 7472  rom e..    @retr
+0001a6c0: 6965 725f 6173 796e 630a 2020 2020 6173  ier_async.    as
+0001a6d0: 796e 6320 6465 6620 6765 745f 6d61 726b  ync def get_mark
+0001a6e0: 6574 5f6c 6576 6572 6167 655f 7469 6572  et_leverage_tier
+0001a6f0: 7328 7365 6c66 2c20 7379 6d62 6f6c 3a20  s(self, symbol: 
+0001a700: 7374 7229 202d 3e20 5475 706c 655b 7374  str) -> Tuple[st
+0001a710: 722c 204c 6973 745b 4469 6374 5d5d 3a0a  r, List[Dict]]:.
+0001a720: 2020 2020 2020 2020 2222 2220 4c65 7665          """ Leve
+0001a730: 7261 6765 2074 6965 7273 2070 6572 2073  rage tiers per s
+0001a740: 796d 626f 6c20 2222 220a 2020 2020 2020  ymbol """.      
+0001a750: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0001a760: 2020 2074 6965 7220 3d20 6177 6169 7420     tier = await 
+0001a770: 7365 6c66 2e5f 6170 695f 6173 796e 632e  self._api_async.
+0001a780: 6665 7463 685f 6d61 726b 6574 5f6c 6576  fetch_market_lev
+0001a790: 6572 6167 655f 7469 6572 7328 7379 6d62  erage_tiers(symb
+0001a7a0: 6f6c 290a 2020 2020 2020 2020 2020 2020  ol).            
+0001a7b0: 7265 7475 726e 2073 796d 626f 6c2c 2074  return symbol, t
+0001a7c0: 6965 720a 2020 2020 2020 2020 6578 6365  ier.        exce
+0001a7d0: 7074 2063 6378 742e 4444 6f53 5072 6f74  pt ccxt.DDoSProt
+0001a7e0: 6563 7469 6f6e 2061 7320 653a 0a20 2020  ection as e:.   
+0001a7f0: 2020 2020 2020 2020 2072 6169 7365 2044           raise D
+0001a800: 446f 7350 726f 7465 6374 696f 6e28 6529  DosProtection(e)
+0001a810: 2066 726f 6d20 650a 2020 2020 2020 2020   from e.        
+0001a820: 6578 6365 7074 2028 6363 7874 2e4e 6574  except (ccxt.Net
+0001a830: 776f 726b 4572 726f 722c 2063 6378 742e  workError, ccxt.
+0001a840: 4578 6368 616e 6765 4572 726f 7229 2061  ExchangeError) a
+0001a850: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0001a860: 2072 6169 7365 2054 656d 706f 7261 7279   raise Temporary
+0001a870: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0001a880: 2020 2020 2020 2066 2743 6f75 6c64 206e         f'Could n
+0001a890: 6f74 206c 6f61 6420 6c65 7665 7261 6765  ot load leverage
+0001a8a0: 2074 6965 7273 2066 6f72 207b 7379 6d62   tiers for {symb
+0001a8b0: 6f6c 7d27 0a20 2020 2020 2020 2020 2020  ol}'.           
+0001a8c0: 2020 2020 2066 2720 6475 6520 746f 207b       f' due to {
+0001a8d0: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
+0001a8e0: 6d65 5f5f 7d2e 204d 6573 7361 6765 3a20  me__}. Message: 
+0001a8f0: 7b65 7d27 0a20 2020 2020 2020 2020 2020  {e}'.           
+0001a900: 2029 2066 726f 6d20 650a 2020 2020 2020   ) from e.      
+0001a910: 2020 6578 6365 7074 2063 6378 742e 4261    except ccxt.Ba
+0001a920: 7365 4572 726f 7220 6173 2065 3a0a 2020  seError as e:.  
+0001a930: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0001a940: 4f70 6572 6174 696f 6e61 6c45 7863 6570  OperationalExcep
+0001a950: 7469 6f6e 2865 2920 6672 6f6d 2065 0a0a  tion(e) from e..
+0001a960: 2020 2020 6465 6620 6c6f 6164 5f6c 6576      def load_lev
+0001a970: 6572 6167 655f 7469 6572 7328 7365 6c66  erage_tiers(self
+0001a980: 2920 2d3e 2044 6963 745b 7374 722c 204c  ) -> Dict[str, L
+0001a990: 6973 745b 4469 6374 5d5d 3a0a 2020 2020  ist[Dict]]:.    
+0001a9a0: 2020 2020 6966 2073 656c 662e 7472 6164      if self.trad
+0001a9b0: 696e 675f 6d6f 6465 203d 3d20 5472 6164  ing_mode == Trad
+0001a9c0: 696e 674d 6f64 652e 4655 5455 5245 533a  ingMode.FUTURES:
+0001a9d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001a9e0: 7365 6c66 2e65 7863 6861 6e67 655f 6861  self.exchange_ha
+0001a9f0: 7328 2766 6574 6368 4c65 7665 7261 6765  s('fetchLeverage
+0001aa00: 5469 6572 7327 293a 0a20 2020 2020 2020  Tiers'):.       
+0001aa10: 2020 2020 2020 2020 2023 2046 6574 6368           # Fetch
+0001aa20: 2061 6c6c 206c 6576 6572 6167 6520 7469   all leverage ti
+0001aa30: 6572 7320 6174 206f 6e63 650a 2020 2020  ers at once.    
+0001aa40: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001aa50: 726e 2073 656c 662e 6765 745f 6c65 7665  rn self.get_leve
+0001aa60: 7261 6765 5f74 6965 7273 2829 0a20 2020  rage_tiers().   
+0001aa70: 2020 2020 2020 2020 2065 6c69 6620 7365           elif se
+0001aa80: 6c66 2e65 7863 6861 6e67 655f 6861 7328  lf.exchange_has(
+0001aa90: 2766 6574 6368 4d61 726b 6574 4c65 7665  'fetchMarketLeve
+0001aaa0: 7261 6765 5469 6572 7327 293a 0a20 2020  rageTiers'):.   
+0001aab0: 2020 2020 2020 2020 2020 2020 2023 204d               # M
+0001aac0: 7573 7420 6665 7463 6820 7468 6520 6c65  ust fetch the le
+0001aad0: 7665 7261 6765 2074 6965 7273 2066 6f72  verage tiers for
+0001aae0: 2065 6163 6820 6d61 726b 6574 2073 6570   each market sep
+0001aaf0: 6172 6174 656c 790a 2020 2020 2020 2020  arately.        
+0001ab00: 2020 2020 2020 2020 2320 2a20 5468 6973          # * This
+0001ab10: 2069 7320 736c 6f77 287e 3435 7329 206f   is slow(~45s) o
+0001ab20: 6e20 4f6b 782c 206d 616b 6573 207e 3930  n Okx, makes ~90
+0001ab30: 2061 7069 2063 616c 6c73 2074 6f20 6c6f   api calls to lo
+0001ab40: 6164 2061 6c6c 206c 696e 6561 7220 7377  ad all linear sw
+0001ab50: 6170 206d 6172 6b65 7473 0a20 2020 2020  ap markets.     
+0001ab60: 2020 2020 2020 2020 2020 206d 6172 6b65             marke
+0001ab70: 7473 203d 2073 656c 662e 6d61 726b 6574  ts = self.market
+0001ab80: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
+0001ab90: 2020 2073 796d 626f 6c73 203d 205b 0a20     symbols = [. 
+0001aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abb0: 2020 2073 796d 626f 6c20 666f 7220 7379     symbol for sy
+0001abc0: 6d62 6f6c 2c20 6d61 726b 6574 2069 6e20  mbol, market in 
+0001abd0: 6d61 726b 6574 732e 6974 656d 7328 290a  markets.items().
+0001abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abf0: 2020 2020 6966 2028 7365 6c66 2e6d 6172      if (self.mar
+0001ac00: 6b65 745f 6973 5f66 7574 7572 6528 6d61  ket_is_future(ma
+0001ac10: 726b 6574 290a 2020 2020 2020 2020 2020  rket).          
+0001ac20: 2020 2020 2020 2020 2020 2020 2020 616e                an
+0001ac30: 6420 6d61 726b 6574 5b27 7175 6f74 6527  d market['quote'
+0001ac40: 5d20 3d3d 2073 656c 662e 5f63 6f6e 6669  ] == self._confi
+0001ac50: 675b 2773 7461 6b65 5f63 7572 7265 6e63  g['stake_currenc
+0001ac60: 7927 5d29 0a20 2020 2020 2020 2020 2020  y']).           
+0001ac70: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+0001ac80: 2020 2020 2020 2020 7469 6572 733a 2044          tiers: D
+0001ac90: 6963 745b 7374 722c 204c 6973 745b 4469  ict[str, List[Di
+0001aca0: 6374 5d5d 203d 207b 7d0a 0a20 2020 2020  ct]] = {}..     
+0001acb0: 2020 2020 2020 2020 2020 2074 6965 7273             tiers
+0001acc0: 5f63 6163 6865 6420 3d20 7365 6c66 2e6c  _cached = self.l
+0001acd0: 6f61 645f 6361 6368 6564 5f6c 6576 6572  oad_cached_lever
+0001ace0: 6167 655f 7469 6572 7328 7365 6c66 2e5f  age_tiers(self._
+0001acf0: 636f 6e66 6967 5b27 7374 616b 655f 6375  config['stake_cu
+0001ad00: 7272 656e 6379 275d 290a 2020 2020 2020  rrency']).      
+0001ad10: 2020 2020 2020 2020 2020 6966 2074 6965            if tie
+0001ad20: 7273 5f63 6163 6865 643a 0a20 2020 2020  rs_cached:.     
+0001ad30: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001ad40: 6965 7273 203d 2074 6965 7273 5f63 6163  iers = tiers_cac
+0001ad50: 6865 640a 0a20 2020 2020 2020 2020 2020  hed..           
+0001ad60: 2020 2020 2063 6f72 6f73 203d 205b 0a20       coros = [. 
+0001ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad80: 2020 2073 656c 662e 6765 745f 6d61 726b     self.get_mark
+0001ad90: 6574 5f6c 6576 6572 6167 655f 7469 6572  et_leverage_tier
+0001ada0: 7328 7379 6d62 6f6c 290a 2020 2020 2020  s(symbol).      
+0001adb0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0001adc0: 7220 7379 6d62 6f6c 2069 6e20 736f 7274  r symbol in sort
+0001add0: 6564 2873 796d 626f 6c73 2920 6966 2073  ed(symbols) if s
+0001ade0: 796d 626f 6c20 6e6f 7420 696e 2074 6965  ymbol not in tie
+0001adf0: 7273 5d0a 0a20 2020 2020 2020 2020 2020  rs]..           
+0001ae00: 2020 2020 2023 2042 6520 7665 7262 6f73       # Be verbos
+0001ae10: 6520 6865 7265 2c20 6173 2074 6869 7320  e here, as this 
+0001ae20: 6465 6c61 7973 2073 7461 7274 7570 2062  delays startup b
+0001ae30: 7920 7e31 206d 696e 7574 652e 0a20 2020  y ~1 minute..   
+0001ae40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001ae50: 636f 726f 733a 0a20 2020 2020 2020 2020  coros:.         
+0001ae60: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0001ae70: 722e 696e 666f 280a 2020 2020 2020 2020  r.info(.        
+0001ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ae90: 6622 496e 6974 6961 6c69 7a69 6e67 206c  f"Initializing l
+0001aea0: 6576 6572 6167 655f 7469 6572 7320 666f  everage_tiers fo
+0001aeb0: 7220 7b6c 656e 2873 796d 626f 6c73 297d  r {len(symbols)}
+0001aec0: 206d 6172 6b65 7473 2e20 220a 2020 2020   markets. ".    
+0001aed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aee0: 2020 2020 2254 6869 7320 7769 6c6c 2074      "This will t
+0001aef0: 616b 6520 6162 6f75 7420 6120 6d69 6e75  ake about a minu
+0001af00: 7465 2e22 290a 2020 2020 2020 2020 2020  te.").          
+0001af10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001af30: 6c6f 6767 6572 2e69 6e66 6f28 2255 7369  logger.info("Usi
+0001af40: 6e67 2063 6163 6865 6420 6c65 7665 7261  ng cached levera
+0001af50: 6765 5f74 6965 7273 2e22 290a 0a20 2020  ge_tiers.")..   
+0001af60: 2020 2020 2020 2020 2020 2020 2061 7379               asy
+0001af70: 6e63 2064 6566 2067 6174 6865 725f 7265  nc def gather_re
+0001af80: 7375 6c74 7328 696e 7075 745f 636f 726f  sults(input_coro
+0001af90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001afa0: 2020 2020 2020 2072 6574 7572 6e20 6177         return aw
+0001afb0: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+0001afc0: 6572 282a 696e 7075 745f 636f 726f 2c20  er(*input_coro, 
+0001afd0: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+0001afe0: 733d 5472 7565 290a 0a20 2020 2020 2020  s=True)..       
+0001aff0: 2020 2020 2020 2020 2066 6f72 2069 6e70           for inp
+0001b000: 7574 5f63 6f72 6f20 696e 2063 6875 6e6b  ut_coro in chunk
+0001b010: 7328 636f 726f 732c 2031 3030 293a 0a0a  s(coros, 100):..
+0001b020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b030: 2020 2020 7769 7468 2073 656c 662e 5f6c      with self._l
+0001b040: 6f6f 705f 6c6f 636b 3a0a 2020 2020 2020  oop_lock:.      
+0001b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b060: 2020 7265 7375 6c74 7320 3d20 7365 6c66    results = self
+0001b070: 2e6c 6f6f 702e 7275 6e5f 756e 7469 6c5f  .loop.run_until_
+0001b080: 636f 6d70 6c65 7465 2867 6174 6865 725f  complete(gather_
+0001b090: 7265 7375 6c74 7328 696e 7075 745f 636f  results(input_co
+0001b0a0: 726f 2929 0a0a 2020 2020 2020 2020 2020  ro))..          
+0001b0b0: 2020 2020 2020 2020 2020 666f 7220 7265            for re
+0001b0c0: 7320 696e 2072 6573 756c 7473 3a0a 2020  s in results:.  
+0001b0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0e0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+0001b0f0: 6e63 6528 7265 732c 2045 7863 6570 7469  nce(res, Excepti
+0001b100: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
+0001b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b120: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+0001b130: 6622 4c65 7665 7261 6765 2074 6965 7220  f"Leverage tier 
+0001b140: 6578 6365 7074 696f 6e3a 207b 7265 7072  exception: {repr
+0001b150: 2872 6573 297d 2229 0a20 2020 2020 2020  (res)}").       
+0001b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b170: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+0001b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b190: 2020 2020 2020 7379 6d62 6f6c 2c20 7469        symbol, ti
+0001b1a0: 6572 203d 2072 6573 0a20 2020 2020 2020  er = res.       
+0001b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b1c0: 2074 6965 7273 5b73 796d 626f 6c5d 203d   tiers[symbol] =
+0001b1d0: 2074 6965 720a 2020 2020 2020 2020 2020   tier.          
+0001b1e0: 2020 2020 2020 6966 206c 656e 2863 6f72        if len(cor
+0001b1f0: 6f73 2920 3e20 303a 0a20 2020 2020 2020  os) > 0:.       
+0001b200: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001b210: 662e 6361 6368 655f 6c65 7665 7261 6765  f.cache_leverage
+0001b220: 5f74 6965 7273 2874 6965 7273 2c20 7365  _tiers(tiers, se
+0001b230: 6c66 2e5f 636f 6e66 6967 5b27 7374 616b  lf._config['stak
+0001b240: 655f 6375 7272 656e 6379 275d 290a 2020  e_currency']).  
+0001b250: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0001b260: 6767 6572 2e69 6e66 6f28 6622 446f 6e65  gger.info(f"Done
+0001b270: 2069 6e69 7469 616c 697a 696e 6720 7b6c   initializing {l
+0001b280: 656e 2873 796d 626f 6c73 297d 206d 6172  en(symbols)} mar
+0001b290: 6b65 7473 2e22 290a 0a20 2020 2020 2020  kets.")..       
+0001b2a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001b2b0: 7469 6572 730a 2020 2020 2020 2020 7265  tiers.        re
+0001b2c0: 7475 726e 207b 7d0a 0a20 2020 2064 6566  turn {}..    def
+0001b2d0: 2063 6163 6865 5f6c 6576 6572 6167 655f   cache_leverage_
+0001b2e0: 7469 6572 7328 7365 6c66 2c20 7469 6572  tiers(self, tier
+0001b2f0: 733a 2044 6963 745b 7374 722c 204c 6973  s: Dict[str, Lis
+0001b300: 745b 4469 6374 5d5d 2c20 7374 616b 655f  t[Dict]], stake_
+0001b310: 6375 7272 656e 6379 3a20 7374 7229 202d  currency: str) -
+0001b320: 3e20 4e6f 6e65 3a0a 0a20 2020 2020 2020  > None:..       
+0001b330: 2066 696c 656e 616d 6520 3d20 7365 6c66   filename = self
+0001b340: 2e5f 636f 6e66 6967 5b27 6461 7461 6469  ._config['datadi
+0001b350: 7227 5d20 2f20 2266 7574 7572 6573 2220  r'] / "futures" 
+0001b360: 2f20 6622 6c65 7665 7261 6765 5f74 6965  / f"leverage_tie
+0001b370: 7273 5f7b 7374 616b 655f 6375 7272 656e  rs_{stake_curren
+0001b380: 6379 7d2e 6a73 6f6e 220a 2020 2020 2020  cy}.json".      
+0001b390: 2020 6966 206e 6f74 2066 696c 656e 616d    if not filenam
+0001b3a0: 652e 7061 7265 6e74 2e69 735f 6469 7228  e.parent.is_dir(
+0001b3b0: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
+0001b3c0: 696c 656e 616d 652e 7061 7265 6e74 2e6d  ilename.parent.m
+0001b3d0: 6b64 6972 2870 6172 656e 7473 3d54 7275  kdir(parents=Tru
+0001b3e0: 6529 0a20 2020 2020 2020 2064 6174 6120  e).        data 
+0001b3f0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0001b400: 2275 7064 6174 6564 223a 2064 6174 6574  "updated": datet
+0001b410: 696d 652e 6e6f 7728 7469 6d65 7a6f 6e65  ime.now(timezone
+0001b420: 2e75 7463 292c 0a20 2020 2020 2020 2020  .utc),.         
+0001b430: 2020 2022 6461 7461 223a 2074 6965 7273     "data": tiers
+0001b440: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
+0001b450: 2020 2020 6669 6c65 5f64 756d 705f 6a73      file_dump_js
+0001b460: 6f6e 2866 696c 656e 616d 652c 2064 6174  on(filename, dat
+0001b470: 6129 0a0a 2020 2020 6465 6620 6c6f 6164  a)..    def load
+0001b480: 5f63 6163 6865 645f 6c65 7665 7261 6765  _cached_leverage
+0001b490: 5f74 6965 7273 2873 656c 662c 2073 7461  _tiers(self, sta
+0001b4a0: 6b65 5f63 7572 7265 6e63 793a 2073 7472  ke_currency: str
+0001b4b0: 2920 2d3e 204f 7074 696f 6e61 6c5b 4469  ) -> Optional[Di
+0001b4c0: 6374 5b73 7472 2c20 4c69 7374 5b44 6963  ct[str, List[Dic
+0001b4d0: 745d 5d5d 3a0a 2020 2020 2020 2020 6669  t]]]:.        fi
+0001b4e0: 6c65 6e61 6d65 203d 2073 656c 662e 5f63  lename = self._c
+0001b4f0: 6f6e 6669 675b 2764 6174 6164 6972 275d  onfig['datadir']
+0001b500: 202f 2022 6675 7475 7265 7322 202f 2066   / "futures" / f
+0001b510: 226c 6576 6572 6167 655f 7469 6572 735f  "leverage_tiers_
+0001b520: 7b73 7461 6b65 5f63 7572 7265 6e63 797d  {stake_currency}
+0001b530: 2e6a 736f 6e22 0a20 2020 2020 2020 2069  .json".        i
+0001b540: 6620 6669 6c65 6e61 6d65 2e69 735f 6669  f filename.is_fi
+0001b550: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
+0001b560: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0001b570: 2020 2020 2020 2074 6965 7273 203d 2066         tiers = f
+0001b580: 696c 655f 6c6f 6164 5f6a 736f 6e28 6669  ile_load_json(fi
+0001b590: 6c65 6e61 6d65 290a 2020 2020 2020 2020  lename).        
+0001b5a0: 2020 2020 2020 2020 7570 6461 7465 6420          updated 
+0001b5b0: 3d20 7469 6572 732e 6765 7428 2775 7064  = tiers.get('upd
+0001b5c0: 6174 6564 2729 0a20 2020 2020 2020 2020  ated').         
+0001b5d0: 2020 2020 2020 2069 6620 7570 6461 7465         if update
+0001b5e0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+0001b5f0: 2020 2020 2020 2075 7064 6174 6564 5f64         updated_d
+0001b600: 7420 3d20 7061 7273 6572 2e70 6172 7365  t = parser.parse
+0001b610: 2875 7064 6174 6564 290a 2020 2020 2020  (updated).      
+0001b620: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001b630: 2075 7064 6174 6564 5f64 7420 3c20 6461   updated_dt < da
+0001b640: 7465 7469 6d65 2e6e 6f77 2874 696d 657a  tetime.now(timez
+0001b650: 6f6e 652e 7574 6329 202d 2074 696d 6564  one.utc) - timed
+0001b660: 656c 7461 2877 6565 6b73 3d34 293a 0a20  elta(weeks=4):. 
+0001b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b680: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0001b690: 666f 2822 4361 6368 6564 206c 6576 6572  fo("Cached lever
+0001b6a0: 6167 6520 7469 6572 7320 6172 6520 6f75  age tiers are ou
+0001b6b0: 7464 6174 6564 2e20 5769 6c6c 2075 7064  tdated. Will upd
+0001b6c0: 6174 652e 2229 0a20 2020 2020 2020 2020  ate.").         
+0001b6d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001b6e0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+0001b6f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001b700: 6e20 7469 6572 735b 2764 6174 6127 5d0a  n tiers['data'].
+0001b710: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0001b720: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+0001b730: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0001b740: 6767 6572 2e65 7863 6570 7469 6f6e 2822  gger.exception("
+0001b750: 4572 726f 7220 6c6f 6164 696e 6720 6361  Error loading ca
+0001b760: 6368 6564 206c 6576 6572 6167 6520 7469  ched leverage ti
+0001b770: 6572 732e 2052 6566 7265 7368 696e 672e  ers. Refreshing.
+0001b780: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
+0001b790: 6e20 4e6f 6e65 0a0a 2020 2020 6465 6620  n None..    def 
+0001b7a0: 6669 6c6c 5f6c 6576 6572 6167 655f 7469  fill_leverage_ti
+0001b7b0: 6572 7328 7365 6c66 2920 2d3e 204e 6f6e  ers(self) -> Non
+0001b7c0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+0001b7d0: 2020 2020 2020 2041 7373 6967 6e73 2070         Assigns p
+0001b7e0: 726f 7065 7274 7920 5f6c 6576 6572 6167  roperty _leverag
+0001b7f0: 655f 7469 6572 7320 746f 2061 2064 6963  e_tiers to a dic
+0001b800: 7469 6f6e 6172 7920 6f66 2069 6e66 6f72  tionary of infor
+0001b810: 6d61 7469 6f6e 2061 626f 7574 2074 6865  mation about the
+0001b820: 206c 6576 6572 6167 650a 2020 2020 2020   leverage.      
+0001b830: 2020 616c 6c6f 7765 6420 6f6e 2065 6163    allowed on eac
+0001b840: 6820 7061 6972 0a20 2020 2020 2020 2022  h pair.        "
+0001b850: 2222 0a20 2020 2020 2020 206c 6576 6572  "".        lever
+0001b860: 6167 655f 7469 6572 7320 3d20 7365 6c66  age_tiers = self
+0001b870: 2e6c 6f61 645f 6c65 7665 7261 6765 5f74  .load_leverage_t
+0001b880: 6965 7273 2829 0a20 2020 2020 2020 2066  iers().        f
+0001b890: 6f72 2070 6169 722c 2074 6965 7273 2069  or pair, tiers i
+0001b8a0: 6e20 6c65 7665 7261 6765 5f74 6965 7273  n leverage_tiers
+0001b8b0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0001b8c0: 2020 2020 2020 7061 6972 5f74 6965 7273        pair_tiers
+0001b8d0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+0001b8e0: 2020 666f 7220 7469 6572 2069 6e20 7469    for tier in ti
+0001b8f0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+0001b900: 2020 2020 2070 6169 725f 7469 6572 732e       pair_tiers.
+0001b910: 6170 7065 6e64 2873 656c 662e 7061 7273  append(self.pars
+0001b920: 655f 6c65 7665 7261 6765 5f74 6965 7228  e_leverage_tier(
+0001b930: 7469 6572 2929 0a20 2020 2020 2020 2020  tier)).         
+0001b940: 2020 2073 656c 662e 5f6c 6576 6572 6167     self._leverag
+0001b950: 655f 7469 6572 735b 7061 6972 5d20 3d20  e_tiers[pair] = 
+0001b960: 7061 6972 5f74 6965 7273 0a0a 2020 2020  pair_tiers..    
+0001b970: 6465 6620 7061 7273 655f 6c65 7665 7261  def parse_levera
+0001b980: 6765 5f74 6965 7228 7365 6c66 2c20 7469  ge_tier(self, ti
+0001b990: 6572 2920 2d3e 2044 6963 743a 0a20 2020  er) -> Dict:.   
+0001b9a0: 2020 2020 2069 6e66 6f20 3d20 7469 6572       info = tier
+0001b9b0: 2e67 6574 2827 696e 666f 272c 207b 7d29  .get('info', {})
+0001b9c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001b9d0: 7b0a 2020 2020 2020 2020 2020 2020 276d  {.            'm
+0001b9e0: 696e 4e6f 7469 6f6e 616c 273a 2074 6965  inNotional': tie
+0001b9f0: 725b 276d 696e 4e6f 7469 6f6e 616c 275d  r['minNotional']
+0001ba00: 2c0a 2020 2020 2020 2020 2020 2020 276d  ,.            'm
+0001ba10: 6178 4e6f 7469 6f6e 616c 273a 2074 6965  axNotional': tie
+0001ba20: 725b 276d 6178 4e6f 7469 6f6e 616c 275d  r['maxNotional']
+0001ba30: 2c0a 2020 2020 2020 2020 2020 2020 276d  ,.            'm
+0001ba40: 6169 6e74 656e 616e 6365 4d61 7267 696e  aintenanceMargin
+0001ba50: 5261 7465 273a 2074 6965 725b 276d 6169  Rate': tier['mai
+0001ba60: 6e74 656e 616e 6365 4d61 7267 696e 5261  ntenanceMarginRa
+0001ba70: 7465 275d 2c0a 2020 2020 2020 2020 2020  te'],.          
+0001ba80: 2020 276d 6178 4c65 7665 7261 6765 273a    'maxLeverage':
+0001ba90: 2074 6965 725b 276d 6178 4c65 7665 7261   tier['maxLevera
+0001baa0: 6765 275d 2c0a 2020 2020 2020 2020 2020  ge'],.          
+0001bab0: 2020 276d 6169 6e74 416d 7427 3a20 666c    'maintAmt': fl
+0001bac0: 6f61 7428 696e 666f 5b27 6375 6d27 5d29  oat(info['cum'])
+0001bad0: 2069 6620 2763 756d 2720 696e 2069 6e66   if 'cum' in inf
+0001bae0: 6f20 656c 7365 204e 6f6e 652c 0a20 2020  o else None,.   
+0001baf0: 2020 2020 207d 0a0a 2020 2020 6465 6620       }..    def 
+0001bb00: 6765 745f 6d61 785f 6c65 7665 7261 6765  get_max_leverage
+0001bb10: 2873 656c 662c 2070 6169 723a 2073 7472  (self, pair: str
+0001bb20: 2c20 7374 616b 655f 616d 6f75 6e74 3a20  , stake_amount: 
+0001bb30: 4f70 7469 6f6e 616c 5b66 6c6f 6174 5d29  Optional[float])
+0001bb40: 202d 3e20 666c 6f61 743a 0a20 2020 2020   -> float:.     
+0001bb50: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
+0001bb60: 6574 7572 6e73 2074 6865 206d 6178 696d  eturns the maxim
+0001bb70: 756d 206c 6576 6572 6167 6520 7468 6174  um leverage that
+0001bb80: 2061 2070 6169 7220 6361 6e20 6265 2074   a pair can be t
+0001bb90: 7261 6465 6420 6174 0a20 2020 2020 2020  raded at.       
+0001bba0: 203a 7061 7261 6d20 7061 6972 3a20 5468   :param pair: Th
+0001bbb0: 6520 6261 7365 2f71 756f 7465 2063 7572  e base/quote cur
+0001bbc0: 7265 6e63 7920 7061 6972 2062 6569 6e67  rency pair being
+0001bbd0: 2074 7261 6465 640a 2020 2020 2020 2020   traded.        
+0001bbe0: 3a73 7461 6b65 5f61 6d6f 756e 743a 2054  :stake_amount: T
+0001bbf0: 6865 2074 6f74 616c 2076 616c 7565 206f  he total value o
+0001bc00: 6620 7468 6520 7472 6164 6572 7320 6d61  f the traders ma
+0001bc10: 7267 696e 5f6d 6f64 6520 696e 2071 756f  rgin_mode in quo
+0001bc20: 7465 2063 7572 7265 6e63 790a 2020 2020  te currency.    
+0001bc30: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+0001bc40: 2069 6620 7365 6c66 2e74 7261 6469 6e67   if self.trading
+0001bc50: 5f6d 6f64 6520 3d3d 2054 7261 6469 6e67  _mode == Trading
+0001bc60: 4d6f 6465 2e53 504f 543a 0a20 2020 2020  Mode.SPOT:.     
+0001bc70: 2020 2020 2020 2072 6574 7572 6e20 312e         return 1.
+0001bc80: 300a 0a20 2020 2020 2020 2069 6620 7365  0..        if se
+0001bc90: 6c66 2e74 7261 6469 6e67 5f6d 6f64 6520  lf.trading_mode 
+0001bca0: 3d3d 2054 7261 6469 6e67 4d6f 6465 2e46  == TradingMode.F
+0001bcb0: 5554 5552 4553 3a0a 0a20 2020 2020 2020  UTURES:..       
+0001bcc0: 2020 2020 2023 2043 6865 636b 7320 616e       # Checks an
+0001bcd0: 6420 6564 6765 2063 6173 6573 0a20 2020  d edge cases.   
+0001bce0: 2020 2020 2020 2020 2069 6620 7374 616b           if stak
+0001bcf0: 655f 616d 6f75 6e74 2069 7320 4e6f 6e65  e_amount is None
+0001bd00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001bd10: 2020 7261 6973 6520 4f70 6572 6174 696f    raise Operatio
+0001bd20: 6e61 6c45 7863 6570 7469 6f6e 280a 2020  nalException(.  
+0001bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd40: 2020 6627 7b73 656c 662e 6e61 6d65 7d2e    f'{self.name}.
+0001bd50: 6765 745f 6d61 785f 6c65 7665 7261 6765  get_max_leverage
+0001bd60: 2072 6571 7569 7265 7320 6172 6775 6d65   requires argume
+0001bd70: 6e74 2073 7461 6b65 5f61 6d6f 756e 7427  nt stake_amount'
+0001bd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bd90: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0001bda0: 6966 2070 6169 7220 6e6f 7420 696e 2073  if pair not in s
+0001bdb0: 656c 662e 5f6c 6576 6572 6167 655f 7469  elf._leverage_ti
+0001bdc0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+0001bdd0: 2020 2020 2023 204d 6179 6265 2072 6169       # Maybe rai
+0001bde0: 7365 2065 7863 6570 7469 6f6e 2062 6563  se exception bec
+0001bdf0: 6175 7365 2069 7420 6361 6e27 7420 6265  ause it can't be
+0001be00: 2074 7261 6465 6420 6f6e 2066 7574 7572   traded on futur
+0001be10: 6573 3f0a 2020 2020 2020 2020 2020 2020  es?.            
+0001be20: 2020 2020 7265 7475 726e 2031 2e30 0a0a      return 1.0..
+0001be30: 2020 2020 2020 2020 2020 2020 7061 6972              pair
+0001be40: 5f74 6965 7273 203d 2073 656c 662e 5f6c  _tiers = self._l
+0001be50: 6576 6572 6167 655f 7469 6572 735b 7061  everage_tiers[pa
+0001be60: 6972 5d0a 0a20 2020 2020 2020 2020 2020  ir]..           
+0001be70: 2069 6620 7374 616b 655f 616d 6f75 6e74   if stake_amount
+0001be80: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+0001be90: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0001bea0: 6c66 2e5f 6c65 7665 7261 6765 5f74 6965  lf._leverage_tie
+0001beb0: 7273 5b70 6169 725d 5b30 5d5b 276d 6178  rs[pair][0]['max
+0001bec0: 4c65 7665 7261 6765 275d 2020 2320 4d61  Leverage']  # Ma
+0001bed0: 7820 6c65 7620 666f 7220 6c6f 7765 7374  x lev for lowest
+0001bee0: 2061 6d6f 756e 740a 0a20 2020 2020 2020   amount..       
+0001bef0: 2020 2020 2066 6f72 2074 6965 725f 696e       for tier_in
+0001bf00: 6465 7820 696e 2072 616e 6765 286c 656e  dex in range(len
+0001bf10: 2870 6169 725f 7469 6572 7329 293a 0a0a  (pair_tiers)):..
+0001bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bf30: 7469 6572 203d 2070 6169 725f 7469 6572  tier = pair_tier
+0001bf40: 735b 7469 6572 5f69 6e64 6578 5d0a 2020  s[tier_index].  
+0001bf50: 2020 2020 2020 2020 2020 2020 2020 6c65                le
+0001bf60: 7620 3d20 7469 6572 5b27 6d61 784c 6576  v = tier['maxLev
+0001bf70: 6572 6167 6527 5d0a 0a20 2020 2020 2020  erage']..       
+0001bf80: 2020 2020 2020 2020 2069 6620 7469 6572           if tier
+0001bf90: 5f69 6e64 6578 203c 206c 656e 2870 6169  _index < len(pai
+0001bfa0: 725f 7469 6572 7329 202d 2031 3a0a 2020  r_tiers) - 1:.  
+0001bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bfc0: 2020 6e65 7874 5f74 6965 7220 3d20 7061    next_tier = pa
+0001bfd0: 6972 5f74 6965 7273 5b74 6965 725f 696e  ir_tiers[tier_in
+0001bfe0: 6465 7820 2b20 315d 0a20 2020 2020 2020  dex + 1].       
+0001bff0: 2020 2020 2020 2020 2020 2020 206e 6578               nex
+0001c000: 745f 666c 6f6f 7220 3d20 6e65 7874 5f74  t_floor = next_t
+0001c010: 6965 725b 276d 696e 4e6f 7469 6f6e 616c  ier['minNotional
+0001c020: 275d 202f 206e 6578 745f 7469 6572 5b27  '] / next_tier['
+0001c030: 6d61 784c 6576 6572 6167 6527 5d0a 2020  maxLeverage'].  
+0001c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c050: 2020 6966 206e 6578 745f 666c 6f6f 7220    if next_floor 
+0001c060: 3e20 7374 616b 655f 616d 6f75 6e74 3a20  > stake_amount: 
+0001c070: 2023 204e 6578 7420 7469 6572 206d 696e   # Next tier min
+0001c080: 2074 6f6f 2068 6967 6820 666f 7220 7374   too high for st
+0001c090: 616b 6520 616d 6f75 6e74 0a20 2020 2020  ake amount.     
+0001c0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c0b0: 2020 2072 6574 7572 6e20 6d69 6e28 2874     return min((t
+0001c0c0: 6965 725b 276d 6178 4e6f 7469 6f6e 616c  ier['maxNotional
+0001c0d0: 275d 202f 2073 7461 6b65 5f61 6d6f 756e  '] / stake_amoun
+0001c0e0: 7429 2c20 6c65 7629 0a20 2020 2020 2020  t), lev).       
+0001c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c100: 2023 0a20 2020 2020 2020 2020 2020 2020   #.             
+0001c110: 2020 2020 2020 2020 2020 2023 2057 6974             # Wit
+0001c120: 6820 7468 6520 7477 6f20 6c65 7665 7261  h the two levera
+0001c130: 6765 2074 6965 7273 2062 656c 6f77 2c0a  ge tiers below,.
+0001c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c150: 2020 2020 2020 2020 2320 2d20 6120 7374          # - a st
+0001c160: 616b 6520 616d 6f75 6e74 206f 6620 3135  ake amount of 15
+0001c170: 3020 776f 756c 6420 6d65 616e 2061 206d  0 would mean a m
+0001c180: 6178 206c 6576 6572 6167 6520 6f66 2028  ax leverage of (
+0001c190: 3130 3030 3020 2f20 3135 3029 203d 2036  10000 / 150) = 6
+0001c1a0: 362e 3636 0a20 2020 2020 2020 2020 2020  6.66.           
+0001c1b0: 2020 2020 2020 2020 2020 2020 2023 202d               # -
+0001c1c0: 2073 7461 6b65 7320 6265 6c6f 7720 3133   stakes below 13
+0001c1d0: 332e 3333 203d 206d 6178 5f6c 6576 206f  3.33 = max_lev o
+0001c1e0: 6620 3735 0a20 2020 2020 2020 2020 2020  f 75.           
+0001c1f0: 2020 2020 2020 2020 2020 2020 2023 202d               # -
+0001c200: 2073 7461 6b65 7320 6265 7477 6565 6e20   stakes between 
+0001c210: 3133 332e 3333 2d32 3030 203d 206d 6178  133.33-200 = max
+0001c220: 5f6c 6576 206f 6620 3130 3030 302f 7374  _lev of 10000/st
+0001c230: 616b 6520 3d20 3530 2e30 312d 3734 2e39  ake = 50.01-74.9
+0001c240: 390a 2020 2020 2020 2020 2020 2020 2020  9.              
+0001c250: 2020 2020 2020 2020 2020 2320 2d20 7374            # - st
+0001c260: 616b 6573 2066 726f 6d20 3230 3020 2b20  akes from 200 + 
+0001c270: 3130 3030 203d 206d 6178 5f6c 6576 206f  1000 = max_lev o
+0001c280: 6620 3530 0a20 2020 2020 2020 2020 2020  f 50.           
+0001c290: 2020 2020 2020 2020 2020 2020 2023 0a20               #. 
+0001c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c2b0: 2020 2020 2020 2023 207b 0a20 2020 2020         # {.     
+0001c2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c2d0: 2020 2023 2020 2020 2022 6d69 6e22 3a20     #     "min": 
+0001c2e0: 302c 2020 2020 2020 2320 7374 616b 6520  0,      # stake 
+0001c2f0: 3d20 302e 300a 2020 2020 2020 2020 2020  = 0.0.          
+0001c300: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001c310: 2020 2020 226d 6178 223a 2031 3030 3030      "max": 10000
+0001c320: 2c20 2023 206d 6178 5f73 7461 6b65 4037  ,  # max_stake@7
+0001c330: 3520 3d20 3130 3030 302f 3735 203d 2031  5 = 10000/75 = 1
+0001c340: 3333 2e33 3333 3333 3333 3333 3333 3333  33.3333333333333
+0001c350: 340a 2020 2020 2020 2020 2020 2020 2020  4.              
+0001c360: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+0001c370: 226c 6576 223a 2037 352c 0a20 2020 2020  "lev": 75,.     
+0001c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c390: 2020 2023 207d 2c0a 2020 2020 2020 2020     # },.        
+0001c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3b0: 2320 7b0a 2020 2020 2020 2020 2020 2020  # {.            
+0001c3c0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0001c3d0: 2020 226d 696e 223a 2031 3030 3030 2c20    "min": 10000, 
+0001c3e0: 2023 2073 7461 6b65 203d 2032 3030 2e30   # stake = 200.0
+0001c3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c400: 2020 2020 2020 2020 2023 2020 2020 2022           #     "
+0001c410: 6d61 7822 3a20 3530 3030 302c 2020 2320  max": 50000,  # 
+0001c420: 6d61 785f 7374 616b 6540 3530 203d 2035  max_stake@50 = 5
+0001c430: 3030 3030 2f35 3020 3d20 3130 3030 2e30  0000/50 = 1000.0
+0001c440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c450: 2020 2020 2020 2020 2023 2020 2020 2022           #     "
+0001c460: 6c65 7622 3a20 3530 2c0a 2020 2020 2020  lev": 50,.      
+0001c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c480: 2020 2320 7d0a 2020 2020 2020 2020 2020    # }.          
+0001c490: 2020 2020 2020 2020 2020 2020 2020 230a                #.
+0001c4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c4b0: 2065 6c73 653a 2020 2320 6966 206f 6e20   else:  # if on 
+0001c4c0: 7468 6520 6c61 7374 2074 6965 720a 2020  the last tier.  
+0001c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4e0: 2020 6966 2073 7461 6b65 5f61 6d6f 756e    if stake_amoun
+0001c4f0: 7420 3e20 7469 6572 5b27 6d61 784e 6f74  t > tier['maxNot
+0001c500: 696f 6e61 6c27 5d3a 0a20 2020 2020 2020  ional']:.       
+0001c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c520: 2023 2049 6620 7374 616b 6520 6973 203e   # If stake is >
+0001c530: 2074 6861 6e20 6d61 7820 7472 6164 6561   than max tradea
+0001c540: 626c 6520 616d 6f75 6e74 0a20 2020 2020  ble amount.     
+0001c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c560: 2020 2072 6169 7365 2049 6e76 616c 6964     raise Invalid
+0001c570: 4f72 6465 7245 7863 6570 7469 6f6e 2866  OrderException(f
+0001c580: 2741 6d6f 756e 7420 7b73 7461 6b65 5f61  'Amount {stake_a
+0001c590: 6d6f 756e 747d 2074 6f6f 2068 6967 6820  mount} too high 
+0001c5a0: 666f 7220 7b70 6169 727d 2729 0a20 2020  for {pair}').   
+0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001c5d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001c5e0: 6574 7572 6e20 7469 6572 5b27 6d61 784c  eturn tier['maxL
+0001c5f0: 6576 6572 6167 6527 5d0a 0a20 2020 2020  everage']..     
+0001c600: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
+0001c610: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
+0001c620: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+0001c630: 2020 2027 4c6f 6f70 6564 2074 6872 6f75     'Looped throu
+0001c640: 6768 2061 6c6c 2074 6965 7273 2077 6974  gh all tiers wit
+0001c650: 686f 7574 2066 696e 6469 6e67 2061 206d  hout finding a m
+0001c660: 6178 206c 6576 6572 6167 652e 2053 686f  ax leverage. Sho
+0001c670: 756c 6420 6e65 7665 7220 6265 2072 6561  uld never be rea
+0001c680: 6368 6564 270a 2020 2020 2020 2020 2020  ched'.          
+0001c690: 2020 290a 0a20 2020 2020 2020 2065 6c69    )..        eli
+0001c6a0: 6620 7365 6c66 2e74 7261 6469 6e67 5f6d  f self.trading_m
+0001c6b0: 6f64 6520 3d3d 2054 7261 6469 6e67 4d6f  ode == TradingMo
+0001c6c0: 6465 2e4d 4152 4749 4e3a 2020 2320 5365  de.MARGIN:  # Se
+0001c6d0: 6172 6368 206d 6172 6b65 7473 2e6c 696d  arch markets.lim
+0001c6e0: 6974 7320 666f 7220 6d61 7820 6c65 760a  its for max lev.
+0001c6f0: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
+0001c700: 6574 203d 2073 656c 662e 6d61 726b 6574  et = self.market
+0001c710: 735b 7061 6972 5d0a 2020 2020 2020 2020  s[pair].        
+0001c720: 2020 2020 6966 206d 6172 6b65 745b 276c      if market['l
+0001c730: 696d 6974 7327 5d5b 276c 6576 6572 6167  imits']['leverag
+0001c740: 6527 5d5b 276d 6178 275d 2069 7320 6e6f  e']['max'] is no
+0001c750: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0001c760: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+0001c770: 6172 6b65 745b 276c 696d 6974 7327 5d5b  arket['limits'][
+0001c780: 276c 6576 6572 6167 6527 5d5b 276d 6178  'leverage']['max
+0001c790: 275d 0a20 2020 2020 2020 2020 2020 2065  '].            e
+0001c7a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001c7b0: 2020 2020 2072 6574 7572 6e20 312e 3020       return 1.0 
+0001c7c0: 2023 2044 6566 6175 6c74 2069 6620 6d61   # Default if ma
+0001c7d0: 7820 6c65 7665 7261 6765 2063 616e 6e6f  x leverage canno
+0001c7e0: 7420 6265 2066 6f75 6e64 0a20 2020 2020  t be found.     
+0001c7f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001c800: 2020 2020 2072 6574 7572 6e20 312e 300a       return 1.0.
+0001c810: 0a20 2020 2040 7265 7472 6965 720a 2020  .    @retrier.  
+0001c820: 2020 6465 6620 5f73 6574 5f6c 6576 6572    def _set_lever
+0001c830: 6167 6528 0a20 2020 2020 2020 2073 656c  age(.        sel
+0001c840: 662c 0a20 2020 2020 2020 206c 6576 6572  f,.        lever
+0001c850: 6167 653a 2066 6c6f 6174 2c0a 2020 2020  age: float,.    
+0001c860: 2020 2020 7061 6972 3a20 4f70 7469 6f6e      pair: Option
+0001c870: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
+0001c880: 2020 2020 2020 2020 6163 6365 7074 5f66          accept_f
+0001c890: 6169 6c3a 2062 6f6f 6c20 3d20 4661 6c73  ail: bool = Fals
+0001c8a0: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+0001c8b0: 2020 2222 220a 2020 2020 2020 2020 5365    """.        Se
+0001c8c0: 7427 7320 7468 6520 6c65 7665 7261 6765  t's the leverage
+0001c8d0: 2062 6566 6f72 6520 6d61 6b69 6e67 2061   before making a
+0001c8e0: 2074 7261 6465 2c20 696e 206f 7264 6572   trade, in order
+0001c8f0: 2074 6f20 6e6f 740a 2020 2020 2020 2020   to not.        
+0001c900: 6861 7665 2074 6865 2073 616d 6520 6c65  have the same le
+0001c910: 7665 7261 6765 206f 6e20 6576 6572 7920  verage on every 
+0001c920: 7472 6164 650a 2020 2020 2020 2020 2222  trade.        ""
+0001c930: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+0001c940: 662e 5f63 6f6e 6669 675b 2764 7279 5f72  f._config['dry_r
+0001c950: 756e 275d 206f 7220 6e6f 7420 7365 6c66  un'] or not self
+0001c960: 2e65 7863 6861 6e67 655f 6861 7328 2273  .exchange_has("s
+0001c970: 6574 4c65 7665 7261 6765 2229 3a0a 2020  etLeverage"):.  
+0001c980: 2020 2020 2020 2020 2020 2320 536f 6d65            # Some
+0001c990: 2065 7863 6861 6e67 6573 206f 6e6c 7920   exchanges only 
+0001c9a0: 7375 7070 6f72 7420 6f6e 6520 6d61 7267  support one marg
+0001c9b0: 696e 5f6d 6f64 6520 7479 7065 0a20 2020  in_mode type.   
+0001c9c0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0001c9d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001c9e0: 5f66 745f 6861 732e 6765 7428 2766 6c6f  _ft_has.get('flo
+0001c9f0: 6f72 5f6c 6576 6572 6167 6527 2c20 4661  or_leverage', Fa
+0001ca00: 6c73 6529 2069 7320 5472 7565 3a0a 2020  lse) is True:.  
+0001ca10: 2020 2020 2020 2020 2020 2320 526f 756e            # Roun
+0001ca20: 6469 6e67 2066 6f72 2062 696e 616e 6365  ding for binance
+0001ca30: 202e 2e2e 0a20 2020 2020 2020 2020 2020   ....           
+0001ca40: 206c 6576 6572 6167 6520 3d20 666c 6f6f   leverage = floo
+0001ca50: 7228 6c65 7665 7261 6765 290a 2020 2020  r(leverage).    
+0001ca60: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001ca70: 2020 2020 2072 6573 203d 2073 656c 662e       res = self.
+0001ca80: 5f61 7069 2e73 6574 5f6c 6576 6572 6167  _api.set_leverag
+0001ca90: 6528 7379 6d62 6f6c 3d70 6169 722c 206c  e(symbol=pair, l
+0001caa0: 6576 6572 6167 653d 6c65 7665 7261 6765  everage=leverage
+0001cab0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0001cac0: 6c66 2e5f 6c6f 675f 6578 6368 616e 6765  lf._log_exchange
+0001cad0: 5f72 6573 706f 6e73 6528 2773 6574 5f6c  _response('set_l
+0001cae0: 6576 6572 6167 6527 2c20 7265 7329 0a20  everage', res). 
+0001caf0: 2020 2020 2020 2065 7863 6570 7420 6363         except cc
+0001cb00: 7874 2e44 446f 5350 726f 7465 6374 696f  xt.DDoSProtectio
+0001cb10: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+0001cb20: 2020 2020 7261 6973 6520 4444 6f73 5072      raise DDosPr
+0001cb30: 6f74 6563 7469 6f6e 2865 2920 6672 6f6d  otection(e) from
+0001cb40: 2065 0a20 2020 2020 2020 2065 7863 6570   e.        excep
+0001cb50: 7420 2863 6378 742e 4261 6452 6571 7565  t (ccxt.BadReque
+0001cb60: 7374 2c20 6363 7874 2e49 6e73 7566 6669  st, ccxt.Insuffi
+0001cb70: 6369 656e 7446 756e 6473 2920 6173 2065  cientFunds) as e
+0001cb80: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0001cb90: 206e 6f74 2061 6363 6570 745f 6661 696c   not accept_fail
+0001cba0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001cbb0: 2020 7261 6973 6520 5465 6d70 6f72 6172    raise Temporar
+0001cbc0: 7945 7272 6f72 280a 2020 2020 2020 2020  yError(.        
+0001cbd0: 2020 2020 2020 2020 2020 2020 6627 436f              f'Co
+0001cbe0: 756c 6420 6e6f 7420 7365 7420 6c65 7665  uld not set leve
+0001cbf0: 7261 6765 2064 7565 2074 6f20 7b65 2e5f  rage due to {e._
+0001cc00: 5f63 6c61 7373 5f5f 2e5f 5f6e 616d 655f  _class__.__name_
+0001cc10: 5f7d 2e20 4d65 7373 6167 653a 207b 657d  _}. Message: {e}
+0001cc20: 2729 2066 726f 6d20 650a 2020 2020 2020  ') from e.      
+0001cc30: 2020 6578 6365 7074 2028 6363 7874 2e4e    except (ccxt.N
+0001cc40: 6574 776f 726b 4572 726f 722c 2063 6378  etworkError, ccx
+0001cc50: 742e 4578 6368 616e 6765 4572 726f 7229  t.ExchangeError)
+0001cc60: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+0001cc70: 2020 2072 6169 7365 2054 656d 706f 7261     raise Tempora
+0001cc80: 7279 4572 726f 7228 0a20 2020 2020 2020  ryError(.       
+0001cc90: 2020 2020 2020 2020 2066 2743 6f75 6c64           f'Could
+0001cca0: 206e 6f74 2073 6574 206c 6576 6572 6167   not set leverag
+0001ccb0: 6520 6475 6520 746f 207b 652e 5f5f 636c  e due to {e.__cl
+0001ccc0: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d2e  ass__.__name__}.
+0001ccd0: 204d 6573 7361 6765 3a20 7b65 7d27 2920   Message: {e}') 
+0001cce0: 6672 6f6d 2065 0a20 2020 2020 2020 2065  from e.        e
+0001ccf0: 7863 6570 7420 6363 7874 2e42 6173 6545  xcept ccxt.BaseE
+0001cd00: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+0001cd10: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
+0001cd20: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
+0001cd30: 6e28 6529 2066 726f 6d20 650a 0a20 2020  n(e) from e..   
+0001cd40: 2064 6566 2067 6574 5f69 6e74 6572 6573   def get_interes
+0001cd50: 745f 7261 7465 2873 656c 6629 202d 3e20  t_rate(self) -> 
+0001cd60: 666c 6f61 743a 0a20 2020 2020 2020 2022  float:.        "
+0001cd70: 2222 0a20 2020 2020 2020 2052 6574 7269  "".        Retri
+0001cd80: 6576 6520 696e 7465 7265 7374 2072 6174  eve interest rat
+0001cd90: 6520 2d20 6e65 6365 7373 6172 7920 666f  e - necessary fo
+0001cda0: 7220 4d61 7267 696e 2074 7261 6469 6e67  r Margin trading
+0001cdb0: 2e0a 2020 2020 2020 2020 5368 6f75 6c64  ..        Should
+0001cdc0: 206e 6f74 2063 616c 6c20 7468 6520 6578   not call the ex
+0001cdd0: 6368 616e 6765 2064 6972 6563 746c 7920  change directly 
+0001cde0: 7768 656e 2075 7365 6420 6672 6f6d 2062  when used from b
+0001cdf0: 6163 6b74 6573 7469 6e67 2e0a 2020 2020  acktesting..    
+0001ce00: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001ce10: 7265 7475 726e 2030 2e30 0a0a 2020 2020  return 0.0..    
+0001ce20: 6465 6620 6675 6e64 696e 675f 6665 655f  def funding_fee_
+0001ce30: 6375 746f 6666 2873 656c 662c 206f 7065  cutoff(self, ope
+0001ce40: 6e5f 6461 7465 3a20 6461 7465 7469 6d65  n_date: datetime
+0001ce50: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+0001ce60: 2020 2020 2020 203a 7061 7261 6d20 6f70         :param op
+0001ce70: 656e 5f64 6174 653a 2054 6865 206f 7065  en_date: The ope
+0001ce80: 6e20 6461 7465 2066 6f72 2061 2074 7261  n date for a tra
+0001ce90: 6465 0a20 2020 2020 2020 203a 7265 7475  de.        :retu
+0001cea0: 726e 3a20 5468 6520 6375 746f 6666 206f  rn: The cutoff o
+0001ceb0: 7065 6e20 7469 6d65 2066 6f72 2077 6865  pen time for whe
+0001cec0: 6e20 6120 6675 6e64 696e 6720 6665 6520  n a funding fee 
+0001ced0: 6973 2063 6861 7267 6564 0a20 2020 2020  is charged.     
+0001cee0: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0001cef0: 6574 7572 6e20 6f70 656e 5f64 6174 652e  eturn open_date.
+0001cf00: 6d69 6e75 7465 203e 2030 206f 7220 6f70  minute > 0 or op
+0001cf10: 656e 5f64 6174 652e 7365 636f 6e64 203e  en_date.second >
+0001cf20: 2030 0a0a 2020 2020 4072 6574 7269 6572   0..    @retrier
+0001cf30: 0a20 2020 2064 6566 2073 6574 5f6d 6172  .    def set_mar
+0001cf40: 6769 6e5f 6d6f 6465 2873 656c 662c 2070  gin_mode(self, p
+0001cf50: 6169 723a 2073 7472 2c20 6d61 7267 696e  air: str, margin
+0001cf60: 5f6d 6f64 653a 204d 6172 6769 6e4d 6f64  _mode: MarginMod
+0001cf70: 652c 2061 6363 6570 745f 6661 696c 3a20  e, accept_fail: 
+0001cf80: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
 0001cf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfa0: 2020 2020 2020 7365 6c66 2e5f 6674 5f68        self._ft_h
-0001cfb0: 6173 5b27 6d61 726b 5f6f 686c 6376 5f74  as['mark_ohlcv_t
-0001cfc0: 696d 6566 7261 6d65 275d 290a 0a20 2020  imeframe'])..   
-0001cfd0: 2020 2020 2069 6620 6e6f 7420 636c 6f73       if not clos
-0001cfe0: 655f 6461 7465 3a0a 2020 2020 2020 2020  e_date:.        
-0001cff0: 2020 2020 636c 6f73 655f 6461 7465 203d      close_date =
-0001d000: 2064 6174 6574 696d 652e 6e6f 7728 7469   datetime.now(ti
-0001d010: 6d65 7a6f 6e65 2e75 7463 290a 2020 2020  mezone.utc).    
-0001d020: 2020 2020 6f70 656e 5f74 696d 6573 7461      open_timesta
-0001d030: 6d70 203d 2069 6e74 2874 696d 6566 7261  mp = int(timefra
-0001d040: 6d65 5f74 6f5f 7072 6576 5f64 6174 6528  me_to_prev_date(
-0001d050: 7469 6d65 6672 616d 652c 206f 7065 6e5f  timeframe, open_
-0001d060: 6461 7465 292e 7469 6d65 7374 616d 7028  date).timestamp(
-0001d070: 2929 202a 2031 3030 300a 2020 2020 2020  )) * 1000.      
-0001d080: 2020 2320 636c 6f73 655f 7469 6d65 7374    # close_timest
-0001d090: 616d 7020 3d20 696e 7428 636c 6f73 655f  amp = int(close_
-0001d0a0: 6461 7465 2e74 696d 6573 7461 6d70 2829  date.timestamp()
-0001d0b0: 2920 2a20 3130 3030 0a0a 2020 2020 2020  ) * 1000..      
-0001d0c0: 2020 6d61 726b 5f63 6f6d 623a 2050 6169    mark_comb: Pai
-0001d0d0: 7257 6974 6854 696d 6566 7261 6d65 203d  rWithTimeframe =
-0001d0e0: 2028 0a20 2020 2020 2020 2020 2020 2070   (.            p
-0001d0f0: 6169 722c 2074 696d 6566 7261 6d65 2c20  air, timeframe, 
-0001d100: 4361 6e64 6c65 5479 7065 2e66 726f 6d5f  CandleType.from_
-0001d110: 7374 7269 6e67 2873 656c 662e 5f66 745f  string(self._ft_
-0001d120: 6861 735b 226d 6172 6b5f 6f68 6c63 765f  has["mark_ohlcv_
-0001d130: 7072 6963 6522 5d29 290a 0a20 2020 2020  price"]))..     
-0001d140: 2020 2066 756e 6469 6e67 5f63 6f6d 623a     funding_comb:
-0001d150: 2050 6169 7257 6974 6854 696d 6566 7261   PairWithTimefra
-0001d160: 6d65 203d 2028 7061 6972 2c20 7469 6d65  me = (pair, time
-0001d170: 6672 616d 655f 6666 2c20 4361 6e64 6c65  frame_ff, Candle
-0001d180: 5479 7065 2e46 554e 4449 4e47 5f52 4154  Type.FUNDING_RAT
-0001d190: 4529 0a20 2020 2020 2020 2063 616e 646c  E).        candl
-0001d1a0: 655f 6869 7374 6f72 6965 7320 3d20 7365  e_histories = se
-0001d1b0: 6c66 2e72 6566 7265 7368 5f6c 6174 6573  lf.refresh_lates
-0001d1c0: 745f 6f68 6c63 7628 0a20 2020 2020 2020  t_ohlcv(.       
-0001d1d0: 2020 2020 205b 6d61 726b 5f63 6f6d 622c       [mark_comb,
-0001d1e0: 2066 756e 6469 6e67 5f63 6f6d 625d 2c0a   funding_comb],.
-0001d1f0: 2020 2020 2020 2020 2020 2020 7369 6e63              sinc
-0001d200: 655f 6d73 3d6f 7065 6e5f 7469 6d65 7374  e_ms=open_timest
-0001d210: 616d 702c 0a20 2020 2020 2020 2020 2020  amp,.           
-0001d220: 2063 6163 6865 3d46 616c 7365 2c0a 2020   cache=False,.  
-0001d230: 2020 2020 2020 2020 2020 6472 6f70 5f69            drop_i
-0001d240: 6e63 6f6d 706c 6574 653d 4661 6c73 652c  ncomplete=False,
-0001d250: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001d260: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001d270: 2020 2020 2320 7765 2063 616e 2774 2061      # we can't a
-0001d280: 7373 756d 6520 7765 2061 6c77 6179 7320  ssume we always 
-0001d290: 6765 7420 6869 7374 6f72 6965 7320 2d20  get histories - 
-0001d2a0: 666f 7220 6578 616d 706c 6520 6475 7269  for example duri
-0001d2b0: 6e67 2065 7863 6861 6e67 6520 646f 776e  ng exchange down
-0001d2c0: 7469 6d65 730a 2020 2020 2020 2020 2020  times.          
-0001d2d0: 2020 6675 6e64 696e 675f 7261 7465 7320    funding_rates 
-0001d2e0: 3d20 6361 6e64 6c65 5f68 6973 746f 7269  = candle_histori
-0001d2f0: 6573 5b66 756e 6469 6e67 5f63 6f6d 625d  es[funding_comb]
-0001d300: 0a20 2020 2020 2020 2020 2020 206d 6172  .            mar
-0001d310: 6b5f 7261 7465 7320 3d20 6361 6e64 6c65  k_rates = candle
-0001d320: 5f68 6973 746f 7269 6573 5b6d 6172 6b5f  _histories[mark_
-0001d330: 636f 6d62 5d0a 2020 2020 2020 2020 6578  comb].        ex
-0001d340: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
-0001d350: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001d360: 2045 7863 6861 6e67 6545 7272 6f72 2822   ExchangeError("
-0001d370: 436f 756c 6420 6e6f 7420 6669 6e64 2066  Could not find f
-0001d380: 756e 6469 6e67 2072 6174 6573 2e22 2920  unding rates.") 
-0001d390: 6672 6f6d 204e 6f6e 650a 0a20 2020 2020  from None..     
-0001d3a0: 2020 2066 756e 6469 6e67 5f6d 6172 6b5f     funding_mark_
-0001d3b0: 7261 7465 7320 3d20 7365 6c66 2e63 6f6d  rates = self.com
-0001d3c0: 6269 6e65 5f66 756e 6469 6e67 5f61 6e64  bine_funding_and
-0001d3d0: 5f6d 6172 6b28 0a20 2020 2020 2020 2020  _mark(.         
-0001d3e0: 2020 2066 756e 6469 6e67 5f72 6174 6573     funding_rates
-0001d3f0: 3d66 756e 6469 6e67 5f72 6174 6573 2c20  =funding_rates, 
-0001d400: 6d61 726b 5f72 6174 6573 3d6d 6172 6b5f  mark_rates=mark_
-0001d410: 7261 7465 7329 0a0a 2020 2020 2020 2020  rates)..        
-0001d420: 7265 7475 726e 2073 656c 662e 6361 6c63  return self.calc
-0001d430: 756c 6174 655f 6675 6e64 696e 675f 6665  ulate_funding_fe
-0001d440: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
-0001d450: 6675 6e64 696e 675f 6d61 726b 5f72 6174  funding_mark_rat
-0001d460: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0001d470: 616d 6f75 6e74 3d61 6d6f 756e 742c 0a20  amount=amount,. 
-0001d480: 2020 2020 2020 2020 2020 2069 735f 7368             is_sh
-0001d490: 6f72 743d 6973 5f73 686f 7274 2c0a 2020  ort=is_short,.  
-0001d4a0: 2020 2020 2020 2020 2020 6f70 656e 5f64            open_d
-0001d4b0: 6174 653d 6f70 656e 5f64 6174 652c 0a20  ate=open_date,. 
-0001d4c0: 2020 2020 2020 2020 2020 2063 6c6f 7365             close
-0001d4d0: 5f64 6174 653d 636c 6f73 655f 6461 7465  _date=close_date
-0001d4e0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0001d4f0: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-0001d500: 2020 6465 6620 636f 6d62 696e 655f 6675    def combine_fu
-0001d510: 6e64 696e 675f 616e 645f 6d61 726b 2866  nding_and_mark(f
-0001d520: 756e 6469 6e67 5f72 6174 6573 3a20 4461  unding_rates: Da
-0001d530: 7461 4672 616d 652c 206d 6172 6b5f 7261  taFrame, mark_ra
-0001d540: 7465 733a 2044 6174 6146 7261 6d65 2c0a  tes: DataFrame,.
-0001d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d570: 2066 7574 7572 6573 5f66 756e 6469 6e67   futures_funding
-0001d580: 5f72 6174 653a 204f 7074 696f 6e61 6c5b  _rate: Optional[
-0001d590: 696e 745d 203d 204e 6f6e 6529 202d 3e20  int] = None) -> 
-0001d5a0: 4461 7461 4672 616d 653a 0a20 2020 2020  DataFrame:.     
-0001d5b0: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
-0001d5c0: 6f6d 6269 6e65 2066 756e 6469 6e67 2d72  ombine funding-r
-0001d5d0: 6174 6573 2061 6e64 206d 6172 6b2d 7261  ates and mark-ra
-0001d5e0: 7465 7320 6461 7461 6672 616d 6573 0a20  tes dataframes. 
-0001d5f0: 2020 2020 2020 203a 7061 7261 6d20 6675         :param fu
-0001d600: 6e64 696e 675f 7261 7465 733a 2044 6174  nding_rates: Dat
-0001d610: 6166 7261 6d65 2063 6f6e 7461 696e 696e  aframe containin
-0001d620: 6720 4675 6e64 696e 6720 7261 7465 7320  g Funding rates 
-0001d630: 2854 7970 6520 4655 4e44 494e 475f 5241  (Type FUNDING_RA
-0001d640: 5445 290a 2020 2020 2020 2020 3a70 6172  TE).        :par
-0001d650: 616d 206d 6172 6b5f 7261 7465 733a 2044  am mark_rates: D
-0001d660: 6174 6166 7261 6d65 2063 6f6e 7461 696e  ataframe contain
-0001d670: 696e 6720 4d61 726b 2072 6174 6573 2028  ing Mark rates (
-0001d680: 5479 7065 206d 6172 6b5f 6f68 6c63 765f  Type mark_ohlcv_
-0001d690: 7072 6963 6529 0a20 2020 2020 2020 203a  price).        :
-0001d6a0: 7061 7261 6d20 6675 7475 7265 735f 6675  param futures_fu
-0001d6b0: 6e64 696e 675f 7261 7465 3a20 4661 6b65  nding_rate: Fake
-0001d6c0: 2066 756e 6469 6e67 2072 6174 6520 746f   funding rate to
-0001d6d0: 2075 7365 2069 6620 6675 6e64 696e 675f   use if funding_
-0001d6e0: 7261 7465 7320 6172 6520 6e6f 7420 6176  rates are not av
-0001d6f0: 6169 6c61 626c 650a 2020 2020 2020 2020  ailable.        
-0001d700: 2222 220a 2020 2020 2020 2020 6966 2066  """.        if f
-0001d710: 7574 7572 6573 5f66 756e 6469 6e67 5f72  utures_funding_r
-0001d720: 6174 6520 6973 204e 6f6e 653a 0a20 2020  ate is None:.   
-0001d730: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001d740: 6d61 726b 5f72 6174 6573 2e6d 6572 6765  mark_rates.merge
-0001d750: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001d760: 2020 6675 6e64 696e 675f 7261 7465 732c    funding_rates,
-0001d770: 206f 6e3d 2764 6174 6527 2c20 686f 773d   on='date', how=
-0001d780: 2269 6e6e 6572 222c 2073 7566 6669 7865  "inner", suffixe
-0001d790: 733d 5b22 5f6d 6172 6b22 2c20 225f 6675  s=["_mark", "_fu
-0001d7a0: 6e64 225d 290a 2020 2020 2020 2020 656c  nd"]).        el
-0001d7b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001d7c0: 6966 206c 656e 2866 756e 6469 6e67 5f72  if len(funding_r
-0001d7d0: 6174 6573 2920 3d3d 2030 3a0a 2020 2020  ates) == 0:.    
-0001d7e0: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-0001d7f0: 2066 756e 6469 6e67 2072 6174 6520 6361   funding rate ca
-0001d800: 6e64 6c65 7320 2d20 6675 6c6c 2066 696c  ndles - full fil
-0001d810: 6c75 7020 7769 7468 2066 616c 6c62 6163  lup with fallbac
-0001d820: 6b20 7661 7269 6162 6c65 0a20 2020 2020  k variable.     
-0001d830: 2020 2020 2020 2020 2020 206d 6172 6b5f             mark_
-0001d840: 7261 7465 735b 276f 7065 6e5f 6675 6e64  rates['open_fund
-0001d850: 275d 203d 2066 7574 7572 6573 5f66 756e  '] = futures_fun
-0001d860: 6469 6e67 5f72 6174 650a 2020 2020 2020  ding_rate.      
-0001d870: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001d880: 206d 6172 6b5f 7261 7465 732e 7265 6e61   mark_rates.rena
-0001d890: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
-0001d8a0: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
-0001d8b0: 6d6e 733d 7b27 6f70 656e 273a 2027 6f70  mns={'open': 'op
-0001d8c0: 656e 5f6d 6172 6b27 2c0a 2020 2020 2020  en_mark',.      
-0001d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8e0: 2020 2020 2020 2020 2020 2027 636c 6f73             'clos
-0001d8f0: 6527 3a20 2763 6c6f 7365 5f6d 6172 6b27  e': 'close_mark'
-0001d900: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d920: 2020 2027 6869 6768 273a 2027 6869 6768     'high': 'high
-0001d930: 5f6d 6172 6b27 2c0a 2020 2020 2020 2020  _mark',.        
-0001d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d950: 2020 2020 2020 2020 2027 6c6f 7727 3a20           'low': 
-0001d960: 276c 6f77 5f6d 6172 6b27 2c0a 2020 2020  'low_mark',.    
-0001d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d980: 2020 2020 2020 2020 2020 2020 2027 766f               'vo
-0001d990: 6c75 6d65 273a 2027 766f 6c75 6d65 5f6d  lume': 'volume_m
-0001d9a0: 6172 6b27 7d29 0a0a 2020 2020 2020 2020  ark'})..        
-0001d9b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001d9c0: 2020 2020 2020 2020 2020 2320 4669 6c6c            # Fill
-0001d9d0: 2075 7020 6d69 7373 696e 6720 6675 6e64   up missing fund
-0001d9e0: 696e 675f 7261 7465 2063 616e 646c 6573  ing_rate candles
-0001d9f0: 2077 6974 6820 6661 6c6c 6261 636b 2076   with fallback v
-0001da00: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
-0001da10: 2020 2020 2063 6f6d 6269 6e65 6420 3d20       combined = 
-0001da20: 6d61 726b 5f72 6174 6573 2e6d 6572 6765  mark_rates.merge
-0001da30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001da40: 2020 2020 2020 6675 6e64 696e 675f 7261        funding_ra
-0001da50: 7465 732c 206f 6e3d 2764 6174 6527 2c20  tes, on='date', 
-0001da60: 686f 773d 226f 7574 6572 222c 2073 7566  how="outer", suf
-0001da70: 6669 7865 733d 5b22 5f6d 6172 6b22 2c20  fixes=["_mark", 
-0001da80: 225f 6675 6e64 225d 0a20 2020 2020 2020  "_fund"].       
-0001da90: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0001daa0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001dab0: 6f6d 6269 6e65 645b 276f 7065 6e5f 6675  ombined['open_fu
-0001dac0: 6e64 275d 203d 2063 6f6d 6269 6e65 645b  nd'] = combined[
-0001dad0: 276f 7065 6e5f 6675 6e64 275d 2e66 696c  'open_fund'].fil
-0001dae0: 6c6e 6128 6675 7475 7265 735f 6675 6e64  lna(futures_fund
-0001daf0: 696e 675f 7261 7465 290a 2020 2020 2020  ing_rate).      
-0001db00: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001db10: 2063 6f6d 6269 6e65 640a 0a20 2020 2064   combined..    d
-0001db20: 6566 2063 616c 6375 6c61 7465 5f66 756e  ef calculate_fun
-0001db30: 6469 6e67 5f66 6565 7328 0a20 2020 2020  ding_fees(.     
-0001db40: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001db50: 2064 663a 2044 6174 6146 7261 6d65 2c0a   df: DataFrame,.
-0001db60: 2020 2020 2020 2020 616d 6f75 6e74 3a20          amount: 
-0001db70: 666c 6f61 742c 0a20 2020 2020 2020 2069  float,.        i
-0001db80: 735f 7368 6f72 743a 2062 6f6f 6c2c 0a20  s_short: bool,. 
-0001db90: 2020 2020 2020 206f 7065 6e5f 6461 7465         open_date
-0001dba0: 3a20 6461 7465 7469 6d65 2c0a 2020 2020  : datetime,.    
-0001dbb0: 2020 2020 636c 6f73 655f 6461 7465 3a20      close_date: 
-0001dbc0: 4f70 7469 6f6e 616c 5b64 6174 6574 696d  Optional[datetim
-0001dbd0: 655d 203d 204e 6f6e 652c 0a20 2020 2020  e] = None,.     
-0001dbe0: 2020 2074 696d 655f 696e 5f72 6174 696f     time_in_ratio
-0001dbf0: 3a20 4f70 7469 6f6e 616c 5b66 6c6f 6174  : Optional[float
-0001dc00: 5d20 3d20 4e6f 6e65 0a20 2020 2029 202d  ] = None.    ) -
-0001dc10: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
-0001dc20: 2022 2222 0a20 2020 2020 2020 2063 616c   """.        cal
-0001dc30: 6375 6c61 7465 7320 7468 6520 7375 6d20  culates the sum 
-0001dc40: 6f66 2061 6c6c 2066 756e 6469 6e67 2066  of all funding f
-0001dc50: 6565 7320 7468 6174 206f 6363 7572 7265  ees that occurre
-0001dc60: 6420 666f 7220 6120 7061 6972 2064 7572  d for a pair dur
-0001dc70: 696e 6720 6120 6675 7475 7265 7320 7472  ing a futures tr
-0001dc80: 6164 650a 2020 2020 2020 2020 3a70 6172  ade.        :par
-0001dc90: 616d 2064 663a 2044 6174 6166 7261 6d65  am df: Dataframe
-0001dca0: 2063 6f6e 7461 696e 696e 6720 636f 6d62   containing comb
-0001dcb0: 696e 6564 2066 756e 6469 6e67 2061 6e64  ined funding and
-0001dcc0: 206d 6172 6b20 7261 7465 730a 2020 2020   mark rates.    
-0001dcd0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001dce0: 7320 606f 7065 6e5f 6675 6e64 6020 616e  s `open_fund` an
-0001dcf0: 6420 606f 7065 6e5f 6d61 726b 602e 0a20  d `open_mark`.. 
-0001dd00: 2020 2020 2020 203a 7061 7261 6d20 616d         :param am
-0001dd10: 6f75 6e74 3a20 5468 6520 7175 616e 7469  ount: The quanti
-0001dd20: 7479 206f 6620 7468 6520 7472 6164 650a  ty of the trade.
-0001dd30: 2020 2020 2020 2020 3a70 6172 616d 2069          :param i
-0001dd40: 735f 7368 6f72 743a 2074 7261 6465 2064  s_short: trade d
-0001dd50: 6972 6563 7469 6f6e 0a20 2020 2020 2020  irection.       
-0001dd60: 203a 7061 7261 6d20 6f70 656e 5f64 6174   :param open_dat
-0001dd70: 653a 2054 6865 2064 6174 6520 616e 6420  e: The date and 
-0001dd80: 7469 6d65 2074 6861 7420 7468 6520 7472  time that the tr
-0001dd90: 6164 6520 7374 6172 7465 640a 2020 2020  ade started.    
-0001dda0: 2020 2020 3a70 6172 616d 2063 6c6f 7365      :param close
-0001ddb0: 5f64 6174 653a 2054 6865 2064 6174 6520  _date: The date 
-0001ddc0: 616e 6420 7469 6d65 2074 6861 7420 7468  and time that th
-0001ddd0: 6520 7472 6164 6520 656e 6465 640a 2020  e trade ended.  
-0001dde0: 2020 2020 2020 3a70 6172 616d 2074 696d        :param tim
-0001ddf0: 655f 696e 5f72 6174 696f 3a20 4e6f 7420  e_in_ratio: Not 
-0001de00: 7573 6564 2062 7920 6d6f 7374 2065 7863  used by most exc
-0001de10: 6861 6e67 6520 636c 6173 7365 730a 2020  hange classes.  
-0001de20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001de30: 2020 6665 6573 3a20 666c 6f61 7420 3d20    fees: float = 
-0001de40: 300a 0a20 2020 2020 2020 2069 6620 6e6f  0..        if no
-0001de50: 7420 6466 2e65 6d70 7479 3a0a 2020 2020  t df.empty:.    
-0001de60: 2020 2020 2020 2020 6466 203d 2064 665b          df = df[
-0001de70: 2864 665b 2764 6174 6527 5d20 3e3d 206f  (df['date'] >= o
-0001de80: 7065 6e5f 6461 7465 2920 2620 2864 665b  pen_date) & (df[
-0001de90: 2764 6174 6527 5d20 3c3d 2063 6c6f 7365  'date'] <= close
-0001dea0: 5f64 6174 6529 5d0a 2020 2020 2020 2020  _date)].        
-0001deb0: 2020 2020 6665 6573 203d 2073 756d 2864      fees = sum(d
-0001dec0: 665b 276f 7065 6e5f 6675 6e64 275d 202a  f['open_fund'] *
-0001ded0: 2064 665b 276f 7065 6e5f 6d61 726b 275d   df['open_mark']
-0001dee0: 202a 2061 6d6f 756e 7429 0a0a 2020 2020   * amount)..    
-0001def0: 2020 2020 2320 4e65 6761 7465 2066 6565      # Negate fee
-0001df00: 7320 666f 7220 6c6f 6e67 7320 6173 2066  s for longs as f
-0001df10: 756e 6469 6e67 5f66 6565 7320 6578 7065  unding_fees expe
-0001df20: 6374 7320 6974 2074 6869 7320 7761 7920  cts it this way 
-0001df30: 6261 7365 6420 6f6e 206c 6976 6520 656e  based on live en
-0001df40: 6470 6f69 6e74 732e 0a20 2020 2020 2020  dpoints..       
-0001df50: 2072 6574 7572 6e20 6665 6573 2069 6620   return fees if 
-0001df60: 6973 5f73 686f 7274 2065 6c73 6520 2d66  is_short else -f
-0001df70: 6565 730a 0a20 2020 2064 6566 2067 6574  ees..    def get
-0001df80: 5f66 756e 6469 6e67 5f66 6565 7328 0a20  _funding_fees(. 
-0001df90: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-0001dfa0: 2070 6169 723a 2073 7472 2c20 616d 6f75   pair: str, amou
-0001dfb0: 6e74 3a20 666c 6f61 742c 2069 735f 7368  nt: float, is_sh
-0001dfc0: 6f72 743a 2062 6f6f 6c2c 206f 7065 6e5f  ort: bool, open_
-0001dfd0: 6461 7465 3a20 6461 7465 7469 6d65 2920  date: datetime) 
-0001dfe0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
-0001dff0: 2020 2222 220a 2020 2020 2020 2020 4665    """.        Fe
-0001e000: 7463 6820 6675 6e64 696e 6720 6665 6573  tch funding fees
-0001e010: 2c20 6569 7468 6572 2066 726f 6d20 7468  , either from th
-0001e020: 6520 6578 6368 616e 6765 2028 6c69 7665  e exchange (live
-0001e030: 2920 6f72 2063 616c 6375 6c61 7465 7320  ) or calculates 
-0001e040: 7468 656d 0a20 2020 2020 2020 2062 6173  them.        bas
-0001e050: 6564 206f 6e20 6675 6e64 696e 6720 7261  ed on funding ra
-0001e060: 7465 2f6d 6172 6b20 7072 6963 6520 6869  te/mark price hi
-0001e070: 7374 6f72 790a 2020 2020 2020 2020 3a70  story.        :p
-0001e080: 6172 616d 2070 6169 723a 2054 6865 2071  aram pair: The q
-0001e090: 756f 7465 2f62 6173 6520 7061 6972 206f  uote/base pair o
-0001e0a0: 6620 7468 6520 7472 6164 650a 2020 2020  f the trade.    
-0001e0b0: 2020 2020 3a70 6172 616d 2069 735f 7368      :param is_sh
-0001e0c0: 6f72 743a 2074 7261 6465 2064 6972 6563  ort: trade direc
-0001e0d0: 7469 6f6e 0a20 2020 2020 2020 203a 7061  tion.        :pa
-0001e0e0: 7261 6d20 616d 6f75 6e74 3a20 5472 6164  ram amount: Trad
-0001e0f0: 6520 616d 6f75 6e74 0a20 2020 2020 2020  e amount.       
-0001e100: 203a 7061 7261 6d20 6f70 656e 5f64 6174   :param open_dat
-0001e110: 653a 204f 7065 6e20 6461 7465 206f 6620  e: Open date of 
-0001e120: 7468 6520 7472 6164 650a 2020 2020 2020  the trade.      
-0001e130: 2020 3a72 6574 7572 6e3a 2066 756e 6469    :return: fundi
-0001e140: 6e67 2066 6565 2073 696e 6365 206f 7065  ng fee since ope
-0001e150: 6e5f 6461 7465 0a20 2020 2020 2020 203a  n_date.        :
-0001e160: 7261 6973 6573 3a20 4578 6368 616e 6765  raises: Exchange
-0001e170: 4572 726f 7220 6966 2073 6f6d 6574 6869  Error if somethi
-0001e180: 6e67 2067 6f65 7320 7772 6f6e 672e 0a20  ng goes wrong.. 
-0001e190: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001e1a0: 2020 2069 6620 7365 6c66 2e74 7261 6469     if self.tradi
-0001e1b0: 6e67 5f6d 6f64 6520 3d3d 2054 7261 6469  ng_mode == Tradi
-0001e1c0: 6e67 4d6f 6465 2e46 5554 5552 4553 3a0a  ngMode.FUTURES:.
-0001e1d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0001e1e0: 656c 662e 5f63 6f6e 6669 675b 2764 7279  elf._config['dry
-0001e1f0: 5f72 756e 275d 3a0a 2020 2020 2020 2020  _run']:.        
-0001e200: 2020 2020 2020 2020 6675 6e64 696e 675f          funding_
-0001e210: 6665 6573 203d 2073 656c 662e 5f66 6574  fees = self._fet
-0001e220: 6368 5f61 6e64 5f63 616c 6375 6c61 7465  ch_and_calculate
-0001e230: 5f66 756e 6469 6e67 5f66 6565 7328 0a20  _funding_fees(. 
+0001cfa0: 2020 2020 2020 7061 7261 6d73 3a20 6469        params: di
+0001cfb0: 6374 203d 207b 7d29 3a0a 2020 2020 2020  ct = {}):.      
+0001cfc0: 2020 2222 220a 2020 2020 2020 2020 5365    """.        Se
+0001cfd0: 7427 7320 7468 6520 6d61 7267 696e 206d  t's the margin m
+0001cfe0: 6f64 6520 6f6e 2074 6865 2065 7863 6861  ode on the excha
+0001cff0: 6e67 6520 746f 2063 726f 7373 206f 7220  nge to cross or 
+0001d000: 6973 6f6c 6174 6564 2066 6f72 2061 2073  isolated for a s
+0001d010: 7065 6369 6669 6320 7061 6972 0a20 2020  pecific pair.   
+0001d020: 2020 2020 203a 7061 7261 6d20 7061 6972       :param pair
+0001d030: 3a20 6261 7365 2f71 756f 7465 2063 7572  : base/quote cur
+0001d040: 7265 6e63 7920 7061 6972 2028 652e 672e  rency pair (e.g.
+0001d050: 2022 4144 412f 5553 4454 2229 0a20 2020   "ADA/USDT").   
+0001d060: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0001d070: 2069 6620 7365 6c66 2e5f 636f 6e66 6967   if self._config
+0001d080: 5b27 6472 795f 7275 6e27 5d20 6f72 206e  ['dry_run'] or n
+0001d090: 6f74 2073 656c 662e 6578 6368 616e 6765  ot self.exchange
+0001d0a0: 5f68 6173 2822 7365 744d 6172 6769 6e4d  _has("setMarginM
+0001d0b0: 6f64 6522 293a 0a20 2020 2020 2020 2020  ode"):.         
+0001d0c0: 2020 2023 2053 6f6d 6520 6578 6368 616e     # Some exchan
+0001d0d0: 6765 7320 6f6e 6c79 2073 7570 706f 7274  ges only support
+0001d0e0: 206f 6e65 206d 6172 6769 6e5f 6d6f 6465   one margin_mode
+0001d0f0: 2074 7970 650a 2020 2020 2020 2020 2020   type.          
+0001d100: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+0001d110: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0001d120: 2020 2072 6573 203d 2073 656c 662e 5f61     res = self._a
+0001d130: 7069 2e73 6574 5f6d 6172 6769 6e5f 6d6f  pi.set_margin_mo
+0001d140: 6465 286d 6172 6769 6e5f 6d6f 6465 2e76  de(margin_mode.v
+0001d150: 616c 7565 2c20 7061 6972 2c20 7061 7261  alue, pair, para
+0001d160: 6d73 290a 2020 2020 2020 2020 2020 2020  ms).            
+0001d170: 7365 6c66 2e5f 6c6f 675f 6578 6368 616e  self._log_exchan
+0001d180: 6765 5f72 6573 706f 6e73 6528 2773 6574  ge_response('set
+0001d190: 5f6d 6172 6769 6e5f 6d6f 6465 272c 2072  _margin_mode', r
+0001d1a0: 6573 290a 2020 2020 2020 2020 6578 6365  es).        exce
+0001d1b0: 7074 2063 6378 742e 4444 6f53 5072 6f74  pt ccxt.DDoSProt
+0001d1c0: 6563 7469 6f6e 2061 7320 653a 0a20 2020  ection as e:.   
+0001d1d0: 2020 2020 2020 2020 2072 6169 7365 2044           raise D
+0001d1e0: 446f 7350 726f 7465 6374 696f 6e28 6529  DosProtection(e)
+0001d1f0: 2066 726f 6d20 650a 2020 2020 2020 2020   from e.        
+0001d200: 6578 6365 7074 2063 6378 742e 4261 6452  except ccxt.BadR
+0001d210: 6571 7565 7374 2061 7320 653a 0a20 2020  equest as e:.   
+0001d220: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001d230: 6163 6365 7074 5f66 6169 6c3a 0a20 2020  accept_fail:.   
+0001d240: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001d250: 7365 2054 656d 706f 7261 7279 4572 726f  se TemporaryErro
+0001d260: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0001d270: 2020 2020 2020 2066 2743 6f75 6c64 206e         f'Could n
+0001d280: 6f74 2073 6574 206d 6172 6769 6e20 6d6f  ot set margin mo
+0001d290: 6465 2064 7565 2074 6f20 7b65 2e5f 5f63  de due to {e.__c
+0001d2a0: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f7d  lass__.__name__}
+0001d2b0: 2e20 4d65 7373 6167 653a 207b 657d 2729  . Message: {e}')
+0001d2c0: 2066 726f 6d20 650a 2020 2020 2020 2020   from e.        
+0001d2d0: 6578 6365 7074 2028 6363 7874 2e4e 6574  except (ccxt.Net
+0001d2e0: 776f 726b 4572 726f 722c 2063 6378 742e  workError, ccxt.
+0001d2f0: 4578 6368 616e 6765 4572 726f 7229 2061  ExchangeError) a
+0001d300: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0001d310: 2072 6169 7365 2054 656d 706f 7261 7279   raise Temporary
+0001d320: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0001d330: 2020 2020 2020 2066 2743 6f75 6c64 206e         f'Could n
+0001d340: 6f74 2073 6574 206d 6172 6769 6e20 6d6f  ot set margin mo
+0001d350: 6465 2064 7565 2074 6f20 7b65 2e5f 5f63  de due to {e.__c
+0001d360: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f7d  lass__.__name__}
+0001d370: 2e20 4d65 7373 6167 653a 207b 657d 2729  . Message: {e}')
+0001d380: 2066 726f 6d20 650a 2020 2020 2020 2020   from e.        
+0001d390: 6578 6365 7074 2063 6378 742e 4261 7365  except ccxt.Base
+0001d3a0: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
+0001d3b0: 2020 2020 2020 2020 7261 6973 6520 4f70          raise Op
+0001d3c0: 6572 6174 696f 6e61 6c45 7863 6570 7469  erationalExcepti
+0001d3d0: 6f6e 2865 2920 6672 6f6d 2065 0a0a 2020  on(e) from e..  
+0001d3e0: 2020 6465 6620 5f66 6574 6368 5f61 6e64    def _fetch_and
+0001d3f0: 5f63 616c 6375 6c61 7465 5f66 756e 6469  _calculate_fundi
+0001d400: 6e67 5f66 6565 7328 0a20 2020 2020 2020  ng_fees(.       
+0001d410: 2073 656c 662c 0a20 2020 2020 2020 2070   self,.        p
+0001d420: 6169 723a 2073 7472 2c0a 2020 2020 2020  air: str,.      
+0001d430: 2020 616d 6f75 6e74 3a20 666c 6f61 742c    amount: float,
+0001d440: 0a20 2020 2020 2020 2069 735f 7368 6f72  .        is_shor
+0001d450: 743a 2062 6f6f 6c2c 0a20 2020 2020 2020  t: bool,.       
+0001d460: 206f 7065 6e5f 6461 7465 3a20 6461 7465   open_date: date
+0001d470: 7469 6d65 2c0a 2020 2020 2020 2020 636c  time,.        cl
+0001d480: 6f73 655f 6461 7465 3a20 4f70 7469 6f6e  ose_date: Option
+0001d490: 616c 5b64 6174 6574 696d 655d 203d 204e  al[datetime] = N
+0001d4a0: 6f6e 650a 2020 2020 2920 2d3e 2066 6c6f  one.    ) -> flo
+0001d4b0: 6174 3a0a 2020 2020 2020 2020 2222 220a  at:.        """.
+0001d4c0: 2020 2020 2020 2020 4665 7463 6865 7320          Fetches 
+0001d4d0: 616e 6420 6361 6c63 756c 6174 6573 2074  and calculates t
+0001d4e0: 6865 2073 756d 206f 6620 616c 6c20 6675  he sum of all fu
+0001d4f0: 6e64 696e 6720 6665 6573 2074 6861 7420  nding fees that 
+0001d500: 6f63 6375 7272 6564 2066 6f72 2061 2070  occurred for a p
+0001d510: 6169 720a 2020 2020 2020 2020 6475 7269  air.        duri
+0001d520: 6e67 2061 2066 7574 7572 6573 2074 7261  ng a futures tra
+0001d530: 6465 2e0a 2020 2020 2020 2020 4f6e 6c79  de..        Only
+0001d540: 2075 7365 6420 6475 7269 6e67 2064 7279   used during dry
+0001d550: 2d72 756e 206f 7220 6966 2074 6865 2065  -run or if the e
+0001d560: 7863 6861 6e67 6520 646f 6573 206e 6f74  xchange does not
+0001d570: 2070 726f 7669 6465 2061 2066 756e 6469   provide a fundi
+0001d580: 6e67 5f72 6174 6573 2065 6e64 706f 696e  ng_rates endpoin
+0001d590: 742e 0a20 2020 2020 2020 203a 7061 7261  t..        :para
+0001d5a0: 6d20 7061 6972 3a20 5468 6520 7175 6f74  m pair: The quot
+0001d5b0: 652f 6261 7365 2070 6169 7220 6f66 2074  e/base pair of t
+0001d5c0: 6865 2074 7261 6465 0a20 2020 2020 2020  he trade.       
+0001d5d0: 203a 7061 7261 6d20 616d 6f75 6e74 3a20   :param amount: 
+0001d5e0: 5468 6520 7175 616e 7469 7479 206f 6620  The quantity of 
+0001d5f0: 7468 6520 7472 6164 650a 2020 2020 2020  the trade.      
+0001d600: 2020 3a70 6172 616d 2069 735f 7368 6f72    :param is_shor
+0001d610: 743a 2074 7261 6465 2064 6972 6563 7469  t: trade directi
+0001d620: 6f6e 0a20 2020 2020 2020 203a 7061 7261  on.        :para
+0001d630: 6d20 6f70 656e 5f64 6174 653a 2054 6865  m open_date: The
+0001d640: 2064 6174 6520 616e 6420 7469 6d65 2074   date and time t
+0001d650: 6861 7420 7468 6520 7472 6164 6520 7374  hat the trade st
+0001d660: 6172 7465 640a 2020 2020 2020 2020 3a70  arted.        :p
+0001d670: 6172 616d 2063 6c6f 7365 5f64 6174 653a  aram close_date:
+0001d680: 2054 6865 2064 6174 6520 616e 6420 7469   The date and ti
+0001d690: 6d65 2074 6861 7420 7468 6520 7472 6164  me that the trad
+0001d6a0: 6520 656e 6465 640a 2020 2020 2020 2020  e ended.        
+0001d6b0: 2222 220a 0a20 2020 2020 2020 2069 6620  """..        if 
+0001d6c0: 7365 6c66 2e66 756e 6469 6e67 5f66 6565  self.funding_fee
+0001d6d0: 5f63 7574 6f66 6628 6f70 656e 5f64 6174  _cutoff(open_dat
+0001d6e0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001d6f0: 6f70 656e 5f64 6174 6520 2b3d 2074 696d  open_date += tim
+0001d700: 6564 656c 7461 2868 6f75 7273 3d31 290a  edelta(hours=1).
+0001d710: 2020 2020 2020 2020 7469 6d65 6672 616d          timefram
+0001d720: 6520 3d20 7365 6c66 2e5f 6674 5f68 6173  e = self._ft_has
+0001d730: 5b27 6d61 726b 5f6f 686c 6376 5f74 696d  ['mark_ohlcv_tim
+0001d740: 6566 7261 6d65 275d 0a20 2020 2020 2020  eframe'].       
+0001d750: 2074 696d 6566 7261 6d65 5f66 6620 3d20   timeframe_ff = 
+0001d760: 7365 6c66 2e5f 6674 5f68 6173 2e67 6574  self._ft_has.get
+0001d770: 2827 6675 6e64 696e 675f 6665 655f 7469  ('funding_fee_ti
+0001d780: 6d65 6672 616d 6527 2c0a 2020 2020 2020  meframe',.      
+0001d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7b0: 2020 7365 6c66 2e5f 6674 5f68 6173 5b27    self._ft_has['
+0001d7c0: 6d61 726b 5f6f 686c 6376 5f74 696d 6566  mark_ohlcv_timef
+0001d7d0: 7261 6d65 275d 290a 0a20 2020 2020 2020  rame'])..       
+0001d7e0: 2069 6620 6e6f 7420 636c 6f73 655f 6461   if not close_da
+0001d7f0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+0001d800: 636c 6f73 655f 6461 7465 203d 2064 6174  close_date = dat
+0001d810: 6574 696d 652e 6e6f 7728 7469 6d65 7a6f  etime.now(timezo
+0001d820: 6e65 2e75 7463 290a 2020 2020 2020 2020  ne.utc).        
+0001d830: 6f70 656e 5f74 696d 6573 7461 6d70 203d  open_timestamp =
+0001d840: 2069 6e74 2874 696d 6566 7261 6d65 5f74   int(timeframe_t
+0001d850: 6f5f 7072 6576 5f64 6174 6528 7469 6d65  o_prev_date(time
+0001d860: 6672 616d 652c 206f 7065 6e5f 6461 7465  frame, open_date
+0001d870: 292e 7469 6d65 7374 616d 7028 2929 202a  ).timestamp()) *
+0001d880: 2031 3030 300a 2020 2020 2020 2020 2320   1000.        # 
+0001d890: 636c 6f73 655f 7469 6d65 7374 616d 7020  close_timestamp 
+0001d8a0: 3d20 696e 7428 636c 6f73 655f 6461 7465  = int(close_date
+0001d8b0: 2e74 696d 6573 7461 6d70 2829 2920 2a20  .timestamp()) * 
+0001d8c0: 3130 3030 0a0a 2020 2020 2020 2020 6d61  1000..        ma
+0001d8d0: 726b 5f63 6f6d 623a 2050 6169 7257 6974  rk_comb: PairWit
+0001d8e0: 6854 696d 6566 7261 6d65 203d 2028 0a20  hTimeframe = (. 
+0001d8f0: 2020 2020 2020 2020 2020 2070 6169 722c             pair,
+0001d900: 2074 696d 6566 7261 6d65 2c20 4361 6e64   timeframe, Cand
+0001d910: 6c65 5479 7065 2e66 726f 6d5f 7374 7269  leType.from_stri
+0001d920: 6e67 2873 656c 662e 5f66 745f 6861 735b  ng(self._ft_has[
+0001d930: 226d 6172 6b5f 6f68 6c63 765f 7072 6963  "mark_ohlcv_pric
+0001d940: 6522 5d29 290a 0a20 2020 2020 2020 2066  e"]))..        f
+0001d950: 756e 6469 6e67 5f63 6f6d 623a 2050 6169  unding_comb: Pai
+0001d960: 7257 6974 6854 696d 6566 7261 6d65 203d  rWithTimeframe =
+0001d970: 2028 7061 6972 2c20 7469 6d65 6672 616d   (pair, timefram
+0001d980: 655f 6666 2c20 4361 6e64 6c65 5479 7065  e_ff, CandleType
+0001d990: 2e46 554e 4449 4e47 5f52 4154 4529 0a20  .FUNDING_RATE). 
+0001d9a0: 2020 2020 2020 2063 616e 646c 655f 6869         candle_hi
+0001d9b0: 7374 6f72 6965 7320 3d20 7365 6c66 2e72  stories = self.r
+0001d9c0: 6566 7265 7368 5f6c 6174 6573 745f 6f68  efresh_latest_oh
+0001d9d0: 6c63 7628 0a20 2020 2020 2020 2020 2020  lcv(.           
+0001d9e0: 205b 6d61 726b 5f63 6f6d 622c 2066 756e   [mark_comb, fun
+0001d9f0: 6469 6e67 5f63 6f6d 625d 2c0a 2020 2020  ding_comb],.    
+0001da00: 2020 2020 2020 2020 7369 6e63 655f 6d73          since_ms
+0001da10: 3d6f 7065 6e5f 7469 6d65 7374 616d 702c  =open_timestamp,
+0001da20: 0a20 2020 2020 2020 2020 2020 2063 6163  .            cac
+0001da30: 6865 3d46 616c 7365 2c0a 2020 2020 2020  he=False,.      
+0001da40: 2020 2020 2020 6472 6f70 5f69 6e63 6f6d        drop_incom
+0001da50: 706c 6574 653d 4661 6c73 652c 0a20 2020  plete=False,.   
+0001da60: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
+0001da70: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0001da80: 2320 7765 2063 616e 2774 2061 7373 756d  # we can't assum
+0001da90: 6520 7765 2061 6c77 6179 7320 6765 7420  e we always get 
+0001daa0: 6869 7374 6f72 6965 7320 2d20 666f 7220  histories - for 
+0001dab0: 6578 616d 706c 6520 6475 7269 6e67 2065  example during e
+0001dac0: 7863 6861 6e67 6520 646f 776e 7469 6d65  xchange downtime
+0001dad0: 730a 2020 2020 2020 2020 2020 2020 6675  s.            fu
+0001dae0: 6e64 696e 675f 7261 7465 7320 3d20 6361  nding_rates = ca
+0001daf0: 6e64 6c65 5f68 6973 746f 7269 6573 5b66  ndle_histories[f
+0001db00: 756e 6469 6e67 5f63 6f6d 625d 0a20 2020  unding_comb].   
+0001db10: 2020 2020 2020 2020 206d 6172 6b5f 7261           mark_ra
+0001db20: 7465 7320 3d20 6361 6e64 6c65 5f68 6973  tes = candle_his
+0001db30: 746f 7269 6573 5b6d 6172 6b5f 636f 6d62  tories[mark_comb
+0001db40: 5d0a 2020 2020 2020 2020 6578 6365 7074  ].        except
+0001db50: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
+0001db60: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
+0001db70: 6861 6e67 6545 7272 6f72 2822 436f 756c  hangeError("Coul
+0001db80: 6420 6e6f 7420 6669 6e64 2066 756e 6469  d not find fundi
+0001db90: 6e67 2072 6174 6573 2e22 2920 6672 6f6d  ng rates.") from
+0001dba0: 204e 6f6e 650a 0a20 2020 2020 2020 2066   None..        f
+0001dbb0: 756e 6469 6e67 5f6d 6172 6b5f 7261 7465  unding_mark_rate
+0001dbc0: 7320 3d20 7365 6c66 2e63 6f6d 6269 6e65  s = self.combine
+0001dbd0: 5f66 756e 6469 6e67 5f61 6e64 5f6d 6172  _funding_and_mar
+0001dbe0: 6b28 0a20 2020 2020 2020 2020 2020 2066  k(.            f
+0001dbf0: 756e 6469 6e67 5f72 6174 6573 3d66 756e  unding_rates=fun
+0001dc00: 6469 6e67 5f72 6174 6573 2c20 6d61 726b  ding_rates, mark
+0001dc10: 5f72 6174 6573 3d6d 6172 6b5f 7261 7465  _rates=mark_rate
+0001dc20: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
+0001dc30: 726e 2073 656c 662e 6361 6c63 756c 6174  rn self.calculat
+0001dc40: 655f 6675 6e64 696e 675f 6665 6573 280a  e_funding_fees(.
+0001dc50: 2020 2020 2020 2020 2020 2020 6675 6e64              fund
+0001dc60: 696e 675f 6d61 726b 5f72 6174 6573 2c0a  ing_mark_rates,.
+0001dc70: 2020 2020 2020 2020 2020 2020 616d 6f75              amou
+0001dc80: 6e74 3d61 6d6f 756e 742c 0a20 2020 2020  nt=amount,.     
+0001dc90: 2020 2020 2020 2069 735f 7368 6f72 743d         is_short=
+0001dca0: 6973 5f73 686f 7274 2c0a 2020 2020 2020  is_short,.      
+0001dcb0: 2020 2020 2020 6f70 656e 5f64 6174 653d        open_date=
+0001dcc0: 6f70 656e 5f64 6174 652c 0a20 2020 2020  open_date,.     
+0001dcd0: 2020 2020 2020 2063 6c6f 7365 5f64 6174         close_dat
+0001dce0: 653d 636c 6f73 655f 6461 7465 0a20 2020  e=close_date.   
+0001dcf0: 2020 2020 2029 0a0a 2020 2020 4073 7461       )..    @sta
+0001dd00: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+0001dd10: 6620 636f 6d62 696e 655f 6675 6e64 696e  f combine_fundin
+0001dd20: 675f 616e 645f 6d61 726b 2866 756e 6469  g_and_mark(fundi
+0001dd30: 6e67 5f72 6174 6573 3a20 4461 7461 4672  ng_rates: DataFr
+0001dd40: 616d 652c 206d 6172 6b5f 7261 7465 733a  ame, mark_rates:
+0001dd50: 2044 6174 6146 7261 6d65 2c0a 2020 2020   DataFrame,.    
+0001dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd70: 2020 2020 2020 2020 2020 2020 2066 7574               fut
+0001dd80: 7572 6573 5f66 756e 6469 6e67 5f72 6174  ures_funding_rat
+0001dd90: 653a 204f 7074 696f 6e61 6c5b 696e 745d  e: Optional[int]
+0001dda0: 203d 204e 6f6e 6529 202d 3e20 4461 7461   = None) -> Data
+0001ddb0: 4672 616d 653a 0a20 2020 2020 2020 2022  Frame:.        "
+0001ddc0: 2222 0a20 2020 2020 2020 2043 6f6d 6269  "".        Combi
+0001ddd0: 6e65 2066 756e 6469 6e67 2d72 6174 6573  ne funding-rates
+0001dde0: 2061 6e64 206d 6172 6b2d 7261 7465 7320   and mark-rates 
+0001ddf0: 6461 7461 6672 616d 6573 0a20 2020 2020  dataframes.     
+0001de00: 2020 203a 7061 7261 6d20 6675 6e64 696e     :param fundin
+0001de10: 675f 7261 7465 733a 2044 6174 6166 7261  g_rates: Datafra
+0001de20: 6d65 2063 6f6e 7461 696e 696e 6720 4675  me containing Fu
+0001de30: 6e64 696e 6720 7261 7465 7320 2854 7970  nding rates (Typ
+0001de40: 6520 4655 4e44 494e 475f 5241 5445 290a  e FUNDING_RATE).
+0001de50: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
+0001de60: 6172 6b5f 7261 7465 733a 2044 6174 6166  ark_rates: Dataf
+0001de70: 7261 6d65 2063 6f6e 7461 696e 696e 6720  rame containing 
+0001de80: 4d61 726b 2072 6174 6573 2028 5479 7065  Mark rates (Type
+0001de90: 206d 6172 6b5f 6f68 6c63 765f 7072 6963   mark_ohlcv_pric
+0001dea0: 6529 0a20 2020 2020 2020 203a 7061 7261  e).        :para
+0001deb0: 6d20 6675 7475 7265 735f 6675 6e64 696e  m futures_fundin
+0001dec0: 675f 7261 7465 3a20 4661 6b65 2066 756e  g_rate: Fake fun
+0001ded0: 6469 6e67 2072 6174 6520 746f 2075 7365  ding rate to use
+0001dee0: 2069 6620 6675 6e64 696e 675f 7261 7465   if funding_rate
+0001def0: 7320 6172 6520 6e6f 7420 6176 6169 6c61  s are not availa
+0001df00: 626c 650a 2020 2020 2020 2020 2222 220a  ble.        """.
+0001df10: 2020 2020 2020 2020 6966 2066 7574 7572          if futur
+0001df20: 6573 5f66 756e 6469 6e67 5f72 6174 6520  es_funding_rate 
+0001df30: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001df40: 2020 2020 2072 6574 7572 6e20 6d61 726b       return mark
+0001df50: 5f72 6174 6573 2e6d 6572 6765 280a 2020  _rates.merge(.  
+0001df60: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+0001df70: 6e64 696e 675f 7261 7465 732c 206f 6e3d  nding_rates, on=
+0001df80: 2764 6174 6527 2c20 686f 773d 2269 6e6e  'date', how="inn
+0001df90: 6572 222c 2073 7566 6669 7865 733d 5b22  er", suffixes=["
+0001dfa0: 5f6d 6172 6b22 2c20 225f 6675 6e64 225d  _mark", "_fund"]
+0001dfb0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001dfc0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+0001dfd0: 656e 2866 756e 6469 6e67 5f72 6174 6573  en(funding_rates
+0001dfe0: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+0001dff0: 2020 2020 2020 2020 2320 4e6f 2066 756e          # No fun
+0001e000: 6469 6e67 2072 6174 6520 6361 6e64 6c65  ding rate candle
+0001e010: 7320 2d20 6675 6c6c 2066 696c 6c75 7020  s - full fillup 
+0001e020: 7769 7468 2066 616c 6c62 6163 6b20 7661  with fallback va
+0001e030: 7269 6162 6c65 0a20 2020 2020 2020 2020  riable.         
+0001e040: 2020 2020 2020 206d 6172 6b5f 7261 7465         mark_rate
+0001e050: 735b 276f 7065 6e5f 6675 6e64 275d 203d  s['open_fund'] =
+0001e060: 2066 7574 7572 6573 5f66 756e 6469 6e67   futures_funding
+0001e070: 5f72 6174 650a 2020 2020 2020 2020 2020  _rate.          
+0001e080: 2020 2020 2020 7265 7475 726e 206d 6172        return mar
+0001e090: 6b5f 7261 7465 732e 7265 6e61 6d65 280a  k_rates.rename(.
+0001e0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0b0: 2020 2020 2020 2020 636f 6c75 6d6e 733d          columns=
+0001e0c0: 7b27 6f70 656e 273a 2027 6f70 656e 5f6d  {'open': 'open_m
+0001e0d0: 6172 6b27 2c0a 2020 2020 2020 2020 2020  ark',.          
+0001e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0f0: 2020 2020 2020 2027 636c 6f73 6527 3a20         'close': 
+0001e100: 2763 6c6f 7365 5f6d 6172 6b27 2c0a 2020  'close_mark',.  
+0001e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e120: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0001e130: 6869 6768 273a 2027 6869 6768 5f6d 6172  high': 'high_mar
+0001e140: 6b27 2c0a 2020 2020 2020 2020 2020 2020  k',.            
+0001e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e160: 2020 2020 2027 6c6f 7727 3a20 276c 6f77       'low': 'low
+0001e170: 5f6d 6172 6b27 2c0a 2020 2020 2020 2020  _mark',.        
+0001e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e190: 2020 2020 2020 2020 2027 766f 6c75 6d65           'volume
+0001e1a0: 273a 2027 766f 6c75 6d65 5f6d 6172 6b27  ': 'volume_mark'
+0001e1b0: 7d29 0a0a 2020 2020 2020 2020 2020 2020  })..            
+0001e1c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001e1d0: 2020 2020 2020 2320 4669 6c6c 2075 7020        # Fill up 
+0001e1e0: 6d69 7373 696e 6720 6675 6e64 696e 675f  missing funding_
+0001e1f0: 7261 7465 2063 616e 646c 6573 2077 6974  rate candles wit
+0001e200: 6820 6661 6c6c 6261 636b 2076 616c 7565  h fallback value
+0001e210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e220: 2063 6f6d 6269 6e65 6420 3d20 6d61 726b   combined = mark
+0001e230: 5f72 6174 6573 2e6d 6572 6765 280a 2020  _rates.merge(.  
 0001e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e250: 2020 2070 6169 722c 2061 6d6f 756e 742c     pair, amount,
-0001e260: 2069 735f 7368 6f72 742c 206f 7065 6e5f   is_short, open_
-0001e270: 6461 7465 290a 2020 2020 2020 2020 2020  date).          
-0001e280: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001e290: 2020 2020 2020 2020 6675 6e64 696e 675f          funding_
-0001e2a0: 6665 6573 203d 2073 656c 662e 5f67 6574  fees = self._get
-0001e2b0: 5f66 756e 6469 6e67 5f66 6565 735f 6672  _funding_fees_fr
-0001e2c0: 6f6d 5f65 7863 6861 6e67 6528 7061 6972  om_exchange(pair
-0001e2d0: 2c20 6f70 656e 5f64 6174 6529 0a20 2020  , open_date).   
-0001e2e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001e2f0: 6675 6e64 696e 675f 6665 6573 0a20 2020  funding_fees.   
-0001e300: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001e310: 2020 2020 2020 2072 6574 7572 6e20 302e         return 0.
-0001e320: 300a 0a20 2020 2064 6566 2067 6574 5f6c  0..    def get_l
-0001e330: 6971 7569 6461 7469 6f6e 5f70 7269 6365  iquidation_price
-0001e340: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0001e350: 2020 2020 2020 2020 7061 6972 3a20 7374          pair: st
-0001e360: 722c 0a20 2020 2020 2020 2023 2044 7279  r,.        # Dry
-0001e370: 2d72 756e 0a20 2020 2020 2020 206f 7065  -run.        ope
-0001e380: 6e5f 7261 7465 3a20 666c 6f61 742c 2020  n_rate: float,  
-0001e390: 2023 2045 6e74 7279 2070 7269 6365 206f   # Entry price o
-0001e3a0: 6620 706f 7369 7469 6f6e 0a20 2020 2020  f position.     
-0001e3b0: 2020 2069 735f 7368 6f72 743a 2062 6f6f     is_short: boo
-0001e3c0: 6c2c 0a20 2020 2020 2020 2061 6d6f 756e  l,.        amoun
-0001e3d0: 743a 2066 6c6f 6174 2c20 2023 2041 6273  t: float,  # Abs
-0001e3e0: 6f6c 7574 6520 7661 6c75 6520 6f66 2070  olute value of p
-0001e3f0: 6f73 6974 696f 6e20 7369 7a65 0a20 2020  osition size.   
-0001e400: 2020 2020 2073 7461 6b65 5f61 6d6f 756e       stake_amoun
-0001e410: 743a 2066 6c6f 6174 2c0a 2020 2020 2020  t: float,.      
-0001e420: 2020 6c65 7665 7261 6765 3a20 666c 6f61    leverage: floa
-0001e430: 742c 0a20 2020 2020 2020 2077 616c 6c65  t,.        walle
-0001e440: 745f 6261 6c61 6e63 653a 2066 6c6f 6174  t_balance: float
-0001e450: 2c0a 2020 2020 2020 2020 6d6d 5f65 785f  ,.        mm_ex_
-0001e460: 313a 2066 6c6f 6174 203d 2030 2e30 2c20  1: float = 0.0, 
-0001e470: 2023 2028 4269 6e61 6e63 6529 2043 726f   # (Binance) Cro
-0001e480: 7373 206f 6e6c 790a 2020 2020 2020 2020  ss only.        
-0001e490: 7570 6e6c 5f65 785f 313a 2066 6c6f 6174  upnl_ex_1: float
-0001e4a0: 203d 2030 2e30 2c20 2023 2028 4269 6e61   = 0.0,  # (Bina
-0001e4b0: 6e63 6529 2043 726f 7373 206f 6e6c 790a  nce) Cross only.
-0001e4c0: 2020 2020 2920 2d3e 204f 7074 696f 6e61      ) -> Optiona
-0001e4d0: 6c5b 666c 6f61 745d 3a0a 2020 2020 2020  l[float]:.      
-0001e4e0: 2020 2222 220a 2020 2020 2020 2020 5365    """.        Se
-0001e4f0: 7427 7320 7468 6520 6d61 7267 696e 206d  t's the margin m
-0001e500: 6f64 6520 6f6e 2074 6865 2065 7863 6861  ode on the excha
-0001e510: 6e67 6520 746f 2063 726f 7373 206f 7220  nge to cross or 
-0001e520: 6973 6f6c 6174 6564 2066 6f72 2061 2073  isolated for a s
-0001e530: 7065 6369 6669 6320 7061 6972 0a20 2020  pecific pair.   
-0001e540: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0001e550: 2069 6620 7365 6c66 2e74 7261 6469 6e67   if self.trading
-0001e560: 5f6d 6f64 6520 3d3d 2054 7261 6469 6e67  _mode == Trading
-0001e570: 4d6f 6465 2e53 504f 543a 0a20 2020 2020  Mode.SPOT:.     
-0001e580: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-0001e590: 6e65 0a20 2020 2020 2020 2065 6c69 6620  ne.        elif 
-0001e5a0: 2873 656c 662e 7472 6164 696e 675f 6d6f  (self.trading_mo
-0001e5b0: 6465 2021 3d20 5472 6164 696e 674d 6f64  de != TradingMod
-0001e5c0: 652e 4655 5455 5245 5329 3a0a 2020 2020  e.FUTURES):.    
-0001e5d0: 2020 2020 2020 2020 7261 6973 6520 4f70          raise Op
-0001e5e0: 6572 6174 696f 6e61 6c45 7863 6570 7469  erationalExcepti
-0001e5f0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0001e600: 2020 2020 6622 7b73 656c 662e 6e61 6d65      f"{self.name
-0001e610: 7d20 646f 6573 206e 6f74 2073 7570 706f  } does not suppo
-0001e620: 7274 207b 7365 6c66 2e6d 6172 6769 6e5f  rt {self.margin_
-0001e630: 6d6f 6465 7d20 7b73 656c 662e 7472 6164  mode} {self.trad
-0001e640: 696e 675f 6d6f 6465 7d22 290a 0a20 2020  ing_mode}")..   
-0001e650: 2020 2020 206c 6971 7569 6461 7469 6f6e       liquidation
-0001e660: 5f70 7269 6365 203d 204e 6f6e 650a 2020  _price = None.  
-0001e670: 2020 2020 2020 6966 2073 656c 662e 5f63        if self._c
-0001e680: 6f6e 6669 675b 2764 7279 5f72 756e 275d  onfig['dry_run']
-0001e690: 206f 7220 6e6f 7420 7365 6c66 2e65 7863   or not self.exc
-0001e6a0: 6861 6e67 655f 6861 7328 2266 6574 6368  hange_has("fetch
-0001e6b0: 506f 7369 7469 6f6e 7322 293a 0a0a 2020  Positions"):..  
-0001e6c0: 2020 2020 2020 2020 2020 6c69 7175 6964            liquid
-0001e6d0: 6174 696f 6e5f 7072 6963 6520 3d20 7365  ation_price = se
-0001e6e0: 6c66 2e64 7279 5f72 756e 5f6c 6971 7569  lf.dry_run_liqui
-0001e6f0: 6461 7469 6f6e 5f70 7269 6365 280a 2020  dation_price(.  
-0001e700: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0001e710: 6972 3d70 6169 722c 0a20 2020 2020 2020  ir=pair,.       
-0001e720: 2020 2020 2020 2020 206f 7065 6e5f 7261           open_ra
-0001e730: 7465 3d6f 7065 6e5f 7261 7465 2c0a 2020  te=open_rate,.  
-0001e740: 2020 2020 2020 2020 2020 2020 2020 6973                is
-0001e750: 5f73 686f 7274 3d69 735f 7368 6f72 742c  _short=is_short,
-0001e760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e770: 2061 6d6f 756e 743d 616d 6f75 6e74 2c0a   amount=amount,.
-0001e780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e790: 6c65 7665 7261 6765 3d6c 6576 6572 6167  leverage=leverag
-0001e7a0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001e7b0: 2020 2073 7461 6b65 5f61 6d6f 756e 743d     stake_amount=
-0001e7c0: 7374 616b 655f 616d 6f75 6e74 2c0a 2020  stake_amount,.  
-0001e7d0: 2020 2020 2020 2020 2020 2020 2020 7761                wa
-0001e7e0: 6c6c 6574 5f62 616c 616e 6365 3d77 616c  llet_balance=wal
-0001e7f0: 6c65 745f 6261 6c61 6e63 652c 0a20 2020  let_balance,.   
-0001e800: 2020 2020 2020 2020 2020 2020 206d 6d5f               mm_
-0001e810: 6578 5f31 3d6d 6d5f 6578 5f31 2c0a 2020  ex_1=mm_ex_1,.  
-0001e820: 2020 2020 2020 2020 2020 2020 2020 7570                up
-0001e830: 6e6c 5f65 785f 313d 7570 6e6c 5f65 785f  nl_ex_1=upnl_ex_
-0001e840: 310a 2020 2020 2020 2020 2020 2020 290a  1.            ).
-0001e850: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001e860: 2020 2020 2020 2020 2020 706f 7369 7469            positi
-0001e870: 6f6e 7320 3d20 7365 6c66 2e66 6574 6368  ons = self.fetch
-0001e880: 5f70 6f73 6974 696f 6e73 2870 6169 7229  _positions(pair)
-0001e890: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001e8a0: 6c65 6e28 706f 7369 7469 6f6e 7329 203e  len(positions) >
-0001e8b0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0001e8c0: 2020 2020 706f 7320 3d20 706f 7369 7469      pos = positi
-0001e8d0: 6f6e 735b 305d 0a20 2020 2020 2020 2020  ons[0].         
-0001e8e0: 2020 2020 2020 206c 6971 7569 6461 7469         liquidati
-0001e8f0: 6f6e 5f70 7269 6365 203d 2070 6f73 5b27  on_price = pos['
-0001e900: 6c69 7175 6964 6174 696f 6e50 7269 6365  liquidationPrice
-0001e910: 275d 0a0a 2020 2020 2020 2020 6966 206c  ']..        if l
-0001e920: 6971 7569 6461 7469 6f6e 5f70 7269 6365  iquidation_price
-0001e930: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0001e940: 2020 2020 2020 2020 2020 6275 6666 6572            buffer
-0001e950: 5f61 6d6f 756e 7420 3d20 6162 7328 6f70  _amount = abs(op
-0001e960: 656e 5f72 6174 6520 2d20 6c69 7175 6964  en_rate - liquid
-0001e970: 6174 696f 6e5f 7072 6963 6529 202a 2073  ation_price) * s
-0001e980: 656c 662e 6c69 7175 6964 6174 696f 6e5f  elf.liquidation_
-0001e990: 6275 6666 6572 0a20 2020 2020 2020 2020  buffer.         
-0001e9a0: 2020 206c 6971 7569 6461 7469 6f6e 5f70     liquidation_p
-0001e9b0: 7269 6365 5f62 7566 6665 7220 3d20 280a  rice_buffer = (.
-0001e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9d0: 6c69 7175 6964 6174 696f 6e5f 7072 6963  liquidation_pric
-0001e9e0: 6520 2d20 6275 6666 6572 5f61 6d6f 756e  e - buffer_amoun
-0001e9f0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-0001ea00: 2020 6966 2069 735f 7368 6f72 7420 656c    if is_short el
-0001ea10: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0001ea20: 2020 206c 6971 7569 6461 7469 6f6e 5f70     liquidation_p
-0001ea30: 7269 6365 202b 2062 7566 6665 725f 616d  rice + buffer_am
-0001ea40: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
-0001ea50: 2029 0a20 2020 2020 2020 2020 2020 2072   ).            r
-0001ea60: 6574 7572 6e20 6d61 7828 6c69 7175 6964  eturn max(liquid
-0001ea70: 6174 696f 6e5f 7072 6963 655f 6275 6666  ation_price_buff
-0001ea80: 6572 2c20 302e 3029 0a20 2020 2020 2020  er, 0.0).       
-0001ea90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001eaa0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-0001eab0: 2020 2020 6465 6620 6472 795f 7275 6e5f      def dry_run_
-0001eac0: 6c69 7175 6964 6174 696f 6e5f 7072 6963  liquidation_pric
-0001ead0: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
-0001eae0: 0a20 2020 2020 2020 2070 6169 723a 2073  .        pair: s
-0001eaf0: 7472 2c0a 2020 2020 2020 2020 6f70 656e  tr,.        open
-0001eb00: 5f72 6174 653a 2066 6c6f 6174 2c20 2020  _rate: float,   
-0001eb10: 2320 456e 7472 7920 7072 6963 6520 6f66  # Entry price of
-0001eb20: 2070 6f73 6974 696f 6e0a 2020 2020 2020   position.      
-0001eb30: 2020 6973 5f73 686f 7274 3a20 626f 6f6c    is_short: bool
-0001eb40: 2c0a 2020 2020 2020 2020 616d 6f75 6e74  ,.        amount
-0001eb50: 3a20 666c 6f61 742c 0a20 2020 2020 2020  : float,.       
-0001eb60: 2073 7461 6b65 5f61 6d6f 756e 743a 2066   stake_amount: f
-0001eb70: 6c6f 6174 2c0a 2020 2020 2020 2020 6c65  loat,.        le
-0001eb80: 7665 7261 6765 3a20 666c 6f61 742c 0a20  verage: float,. 
-0001eb90: 2020 2020 2020 2077 616c 6c65 745f 6261         wallet_ba
-0001eba0: 6c61 6e63 653a 2066 6c6f 6174 2c20 2023  lance: float,  #
-0001ebb0: 204f 7220 6d61 7267 696e 2062 616c 616e   Or margin balan
-0001ebc0: 6365 0a20 2020 2020 2020 206d 6d5f 6578  ce.        mm_ex
-0001ebd0: 5f31 3a20 666c 6f61 7420 3d20 302e 302c  _1: float = 0.0,
-0001ebe0: 2020 2320 2842 696e 616e 6365 2920 4372    # (Binance) Cr
-0001ebf0: 6f73 7320 6f6e 6c79 0a20 2020 2020 2020  oss only.       
-0001ec00: 2075 706e 6c5f 6578 5f31 3a20 666c 6f61   upnl_ex_1: floa
-0001ec10: 7420 3d20 302e 302c 2020 2320 2842 696e  t = 0.0,  # (Bin
-0001ec20: 616e 6365 2920 4372 6f73 7320 6f6e 6c79  ance) Cross only
-0001ec30: 0a20 2020 2029 202d 3e20 4f70 7469 6f6e  .    ) -> Option
-0001ec40: 616c 5b66 6c6f 6174 5d3a 0a20 2020 2020  al[float]:.     
-0001ec50: 2020 2022 2222 0a20 2020 2020 2020 2049     """.        I
-0001ec60: 6d70 6f72 7461 6e74 3a20 4d75 7374 2062  mportant: Must b
-0001ec70: 6520 6665 7463 6869 6e67 2064 6174 6120  e fetching data 
-0001ec80: 6672 6f6d 2063 6163 6865 6420 7661 6c75  from cached valu
-0001ec90: 6573 2061 7320 7468 6973 2069 7320 7573  es as this is us
-0001eca0: 6564 2062 7920 6261 636b 7465 7374 696e  ed by backtestin
-0001ecb0: 6721 0a20 2020 2020 2020 2050 4552 5045  g!.        PERPE
-0001ecc0: 5455 414c 3a0a 2020 2020 2020 2020 2067  TUAL:.         g
-0001ecd0: 6174 653a 2068 7474 7073 3a2f 2f77 7777  ate: https://www
-0001ece0: 2e67 6174 652e 696f 2f68 656c 702f 6675  .gate.io/help/fu
-0001ecf0: 7475 7265 732f 6675 7475 7265 732f 3237  tures/futures/27
-0001ed00: 3732 342f 6c69 7175 6964 6174 696f 6e2d  724/liquidation-
-0001ed10: 7072 6963 652d 6261 6e6b 7275 7074 6379  price-bankruptcy
-0001ed20: 2d70 7269 6365 0a20 2020 2020 2020 2020  -price.         
-0001ed30: 3e20 4c69 7175 6964 6174 696f 6e20 5072  > Liquidation Pr
-0001ed40: 6963 6520 3d20 2845 6e74 7279 2050 7269  ice = (Entry Pri
-0001ed50: 6365 20c2 b120 4d61 7267 696e 202f 2043  ce .. Margin / C
-0001ed60: 6f6e 7472 6163 7420 4d75 6c74 6970 6c69  ontract Multipli
-0001ed70: 6572 202f 2053 697a 6529 202f 0a20 2020  er / Size) /.   
-0001ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed90: 2020 2020 2020 2020 2020 2020 205b 2031               [ 1
-0001eda0: 20c2 b120 284d 6169 6e74 656e 616e 6365   .. (Maintenance
-0001edb0: 204d 6172 6769 6e20 5261 7469 6f20 2b20   Margin Ratio + 
-0001edc0: 5461 6b65 7220 5261 7465 295d 0a20 2020  Taker Rate)].   
-0001edd0: 2020 2020 2020 2020 2057 6865 7265 696e           Wherein
-0001ede0: 2c20 222b 2220 6f72 2022 2d22 2064 6570  , "+" or "-" dep
-0001edf0: 656e 6473 206f 6e20 7768 6574 6865 7220  ends on whether 
-0001ee00: 7468 6520 636f 6e74 7261 6374 2067 6f65  the contract goe
-0001ee10: 7320 6c6f 6e67 206f 7220 7368 6f72 743a  s long or short:
-0001ee20: 0a20 2020 2020 2020 2020 2020 2022 2d22  .            "-"
-0001ee30: 2066 6f72 206c 6f6e 672c 2061 6e64 2022   for long, and "
-0001ee40: 2b22 2066 6f72 2073 686f 7274 2e0a 0a20  +" for short... 
-0001ee50: 2020 2020 2020 2020 6f6b 6578 3a20 6874          okex: ht
-0001ee60: 7470 733a 2f2f 7777 772e 6f6b 6578 2e63  tps://www.okex.c
-0001ee70: 6f6d 2f73 7570 706f 7274 2f68 632f 656e  om/support/hc/en
-0001ee80: 2d75 732f 6172 7469 636c 6573 2f0a 2020  -us/articles/.  
-0001ee90: 2020 2020 2020 2020 2020 3336 3030 3533            360053
-0001eea0: 3930 3935 3932 2d56 492d 496e 7472 6f64  909592-VI-Introd
-0001eeb0: 7563 7469 6f6e 2d74 6f2d 7468 652d 6973  uction-to-the-is
-0001eec0: 6f6c 6174 6564 2d6d 6f64 652d 6f66 2d53  olated-mode-of-S
-0001eed0: 696e 676c 652d 4d75 6c74 692d 6375 7272  ingle-Multi-curr
-0001eee0: 656e 6379 2d50 6f72 7466 6f6c 696f 2d6d  ency-Portfolio-m
-0001eef0: 6172 6769 6e0a 0a20 2020 2020 2020 203a  argin..        :
-0001ef00: 7061 7261 6d20 7061 6972 3a20 5061 6972  param pair: Pair
-0001ef10: 2074 6f20 6361 6c63 756c 6174 6520 6c69   to calculate li
-0001ef20: 7175 6964 6174 696f 6e20 7072 6963 6520  quidation price 
-0001ef30: 666f 720a 2020 2020 2020 2020 3a70 6172  for.        :par
-0001ef40: 616d 206f 7065 6e5f 7261 7465 3a20 456e  am open_rate: En
-0001ef50: 7472 7920 7072 6963 6520 6f66 2070 6f73  try price of pos
-0001ef60: 6974 696f 6e0a 2020 2020 2020 2020 3a70  ition.        :p
-0001ef70: 6172 616d 2069 735f 7368 6f72 743a 2054  aram is_short: T
-0001ef80: 7275 6520 6966 2074 6865 2074 7261 6465  rue if the trade
-0001ef90: 2069 7320 6120 7368 6f72 742c 2066 616c   is a short, fal
-0001efa0: 7365 206f 7468 6572 7769 7365 0a20 2020  se otherwise.   
-0001efb0: 2020 2020 203a 7061 7261 6d20 616d 6f75       :param amou
-0001efc0: 6e74 3a20 4162 736f 6c75 7465 2076 616c  nt: Absolute val
-0001efd0: 7565 206f 6620 706f 7369 7469 6f6e 2073  ue of position s
-0001efe0: 697a 6520 696e 636c 2e20 6c65 7665 7261  ize incl. levera
-0001eff0: 6765 2028 696e 2062 6173 6520 6375 7272  ge (in base curr
-0001f000: 656e 6379 290a 2020 2020 2020 2020 3a70  ency).        :p
-0001f010: 6172 616d 2073 7461 6b65 5f61 6d6f 756e  aram stake_amoun
-0001f020: 743a 2053 7461 6b65 2061 6d6f 756e 7420  t: Stake amount 
-0001f030: 2d20 436f 6c6c 6174 6572 616c 2069 6e20  - Collateral in 
-0001f040: 7365 7474 6c65 2063 7572 7265 6e63 792e  settle currency.
-0001f050: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0001f060: 6c65 7665 7261 6765 3a20 4c65 7665 7261  leverage: Levera
-0001f070: 6765 2075 7365 6420 666f 7220 7468 6973  ge used for this
-0001f080: 2070 6f73 6974 696f 6e2e 0a20 2020 2020   position..     
-0001f090: 2020 203a 7061 7261 6d20 7472 6164 696e     :param tradin
-0001f0a0: 675f 6d6f 6465 3a20 5350 4f54 2c20 4d41  g_mode: SPOT, MA
-0001f0b0: 5247 494e 2c20 4655 5455 5245 532c 2065  RGIN, FUTURES, e
-0001f0c0: 7463 2e0a 2020 2020 2020 2020 3a70 6172  tc..        :par
-0001f0d0: 616d 206d 6172 6769 6e5f 6d6f 6465 3a20  am margin_mode: 
-0001f0e0: 4569 7468 6572 2049 534f 4c41 5445 4420  Either ISOLATED 
-0001f0f0: 6f72 2043 524f 5353 0a20 2020 2020 2020  or CROSS.       
-0001f100: 203a 7061 7261 6d20 7761 6c6c 6574 5f62   :param wallet_b
-0001f110: 616c 616e 6365 3a20 416d 6f75 6e74 206f  alance: Amount o
-0001f120: 6620 6d61 7267 696e 5f6d 6f64 6520 696e  f margin_mode in
-0001f130: 2074 6865 2077 616c 6c65 7420 6265 696e   the wallet bein
-0001f140: 6720 7573 6564 2074 6f20 7472 6164 650a  g used to trade.
-0001f150: 2020 2020 2020 2020 2020 2020 4372 6f73              Cros
-0001f160: 732d 4d61 7267 696e 204d 6f64 653a 2063  s-Margin Mode: c
-0001f170: 726f 7373 5761 6c6c 6574 4261 6c61 6e63  rossWalletBalanc
-0001f180: 650a 2020 2020 2020 2020 2020 2020 4973  e.            Is
-0001f190: 6f6c 6174 6564 2d4d 6172 6769 6e20 4d6f  olated-Margin Mo
-0001f1a0: 6465 3a20 6973 6f6c 6174 6564 5761 6c6c  de: isolatedWall
-0001f1b0: 6574 4261 6c61 6e63 650a 0a20 2020 2020  etBalance..     
-0001f1c0: 2020 2023 202a 204e 6f74 2072 6571 7569     # * Not requi
-0001f1d0: 7265 6420 6279 2047 6174 6520 6f72 204f  red by Gate or O
-0001f1e0: 4b58 0a20 2020 2020 2020 203a 7061 7261  KX.        :para
-0001f1f0: 6d20 6d6d 5f65 785f 313a 0a20 2020 2020  m mm_ex_1:.     
-0001f200: 2020 203a 7061 7261 6d20 7570 6e6c 5f65     :param upnl_e
-0001f210: 785f 313a 0a20 2020 2020 2020 2022 2222  x_1:.        """
-0001f220: 0a0a 2020 2020 2020 2020 6d61 726b 6574  ..        market
-0001f230: 203d 2073 656c 662e 6d61 726b 6574 735b   = self.markets[
-0001f240: 7061 6972 5d0a 2020 2020 2020 2020 7461  pair].        ta
-0001f250: 6b65 725f 6665 655f 7261 7465 203d 206d  ker_fee_rate = m
-0001f260: 6172 6b65 745b 2774 616b 6572 275d 0a20  arket['taker']. 
-0001f270: 2020 2020 2020 206d 6d5f 7261 7469 6f2c         mm_ratio,
-0001f280: 205f 203d 2073 656c 662e 6765 745f 6d61   _ = self.get_ma
-0001f290: 696e 7465 6e61 6e63 655f 7261 7469 6f5f  intenance_ratio_
-0001f2a0: 616e 645f 616d 7428 7061 6972 2c20 7374  and_amt(pair, st
-0001f2b0: 616b 655f 616d 6f75 6e74 290a 0a20 2020  ake_amount)..   
-0001f2c0: 2020 2020 2069 6620 7365 6c66 2e74 7261       if self.tra
-0001f2d0: 6469 6e67 5f6d 6f64 6520 3d3d 2054 7261  ding_mode == Tra
-0001f2e0: 6469 6e67 4d6f 6465 2e46 5554 5552 4553  dingMode.FUTURES
-0001f2f0: 2061 6e64 2073 656c 662e 6d61 7267 696e   and self.margin
-0001f300: 5f6d 6f64 6520 3d3d 204d 6172 6769 6e4d  _mode == MarginM
-0001f310: 6f64 652e 4953 4f4c 4154 4544 3a0a 0a20  ode.ISOLATED:.. 
-0001f320: 2020 2020 2020 2020 2020 2069 6620 6d61             if ma
-0001f330: 726b 6574 5b27 696e 7665 7273 6527 5d3a  rket['inverse']:
-0001f340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f350: 2072 6169 7365 204f 7065 7261 7469 6f6e   raise Operation
-0001f360: 616c 4578 6365 7074 696f 6e28 0a20 2020  alException(.   
-0001f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f380: 2022 4672 6571 7472 6164 6520 646f 6573   "Freqtrade does
-0001f390: 206e 6f74 2079 6574 2073 7570 706f 7274   not yet support
-0001f3a0: 2069 6e76 6572 7365 2063 6f6e 7472 6163   inverse contrac
-0001f3b0: 7473 2229 0a0a 2020 2020 2020 2020 2020  ts")..          
-0001f3c0: 2020 7661 6c75 6520 3d20 7761 6c6c 6574    value = wallet
-0001f3d0: 5f62 616c 616e 6365 202f 2061 6d6f 756e  _balance / amoun
-0001f3e0: 740a 0a20 2020 2020 2020 2020 2020 206d  t..            m
-0001f3f0: 6d5f 7261 7469 6f5f 7461 6b65 7220 3d20  m_ratio_taker = 
-0001f400: 286d 6d5f 7261 7469 6f20 2b20 7461 6b65  (mm_ratio + take
-0001f410: 725f 6665 655f 7261 7465 290a 2020 2020  r_fee_rate).    
-0001f420: 2020 2020 2020 2020 6966 2069 735f 7368          if is_sh
-0001f430: 6f72 743a 0a20 2020 2020 2020 2020 2020  ort:.           
-0001f440: 2020 2020 2072 6574 7572 6e20 286f 7065       return (ope
-0001f450: 6e5f 7261 7465 202b 2076 616c 7565 2920  n_rate + value) 
-0001f460: 2f20 2831 202b 206d 6d5f 7261 7469 6f5f  / (1 + mm_ratio_
-0001f470: 7461 6b65 7229 0a20 2020 2020 2020 2020  taker).         
-0001f480: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001f490: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001f4a0: 286f 7065 6e5f 7261 7465 202d 2076 616c  (open_rate - val
-0001f4b0: 7565 2920 2f20 2831 202d 206d 6d5f 7261  ue) / (1 - mm_ra
-0001f4c0: 7469 6f5f 7461 6b65 7229 0a20 2020 2020  tio_taker).     
-0001f4d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001f4e0: 2020 2020 2072 6169 7365 204f 7065 7261       raise Opera
-0001f4f0: 7469 6f6e 616c 4578 6365 7074 696f 6e28  tionalException(
-0001f500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f510: 2022 4672 6571 7472 6164 6520 6f6e 6c79   "Freqtrade only
-0001f520: 2073 7570 706f 7274 7320 6973 6f6c 6174   supports isolat
-0001f530: 6564 2066 7574 7572 6573 2066 6f72 206c  ed futures for l
-0001f540: 6576 6572 6167 6520 7472 6164 696e 6722  everage trading"
-0001f550: 290a 0a20 2020 2064 6566 2067 6574 5f6d  )..    def get_m
-0001f560: 6169 6e74 656e 616e 6365 5f72 6174 696f  aintenance_ratio
-0001f570: 5f61 6e64 5f61 6d74 280a 2020 2020 2020  _and_amt(.      
-0001f580: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0001f590: 7061 6972 3a20 7374 722c 0a20 2020 2020  pair: str,.     
-0001f5a0: 2020 206e 6f6d 696e 616c 5f76 616c 7565     nominal_value
-0001f5b0: 3a20 666c 6f61 742c 0a20 2020 2029 202d  : float,.    ) -
-0001f5c0: 3e20 5475 706c 655b 666c 6f61 742c 204f  > Tuple[float, O
-0001f5d0: 7074 696f 6e61 6c5b 666c 6f61 745d 5d3a  ptional[float]]:
-0001f5e0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001f5f0: 2020 2020 2049 6d70 6f72 7461 6e74 3a20       Important: 
-0001f600: 4d75 7374 2062 6520 6665 7463 6869 6e67  Must be fetching
-0001f610: 2064 6174 6120 6672 6f6d 2063 6163 6865   data from cache
-0001f620: 6420 7661 6c75 6573 2061 7320 7468 6973  d values as this
-0001f630: 2069 7320 7573 6564 2062 7920 6261 636b   is used by back
-0001f640: 7465 7374 696e 6721 0a20 2020 2020 2020  testing!.       
-0001f650: 203a 7061 7261 6d20 7061 6972 3a20 4d61   :param pair: Ma
-0001f660: 726b 6574 2073 796d 626f 6c0a 2020 2020  rket symbol.    
-0001f670: 2020 2020 3a70 6172 616d 206e 6f6d 696e      :param nomin
-0001f680: 616c 5f76 616c 7565 3a20 5468 6520 746f  al_value: The to
-0001f690: 7461 6c20 7472 6164 6520 616d 6f75 6e74  tal trade amount
-0001f6a0: 2069 6e20 7175 6f74 6520 6375 7272 656e   in quote curren
-0001f6b0: 6379 2069 6e63 6c75 6469 6e67 206c 6576  cy including lev
-0001f6c0: 6572 6167 650a 2020 2020 2020 2020 6d61  erage.        ma
-0001f6d0: 696e 7465 6e61 6e63 6520 616d 6f75 6e74  intenance amount
-0001f6e0: 206f 6e6c 7920 6f6e 2042 696e 616e 6365   only on Binance
-0001f6f0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0001f700: 3a20 286d 6169 6e74 656e 616e 6365 206d  : (maintenance m
-0001f710: 6172 6769 6e20 7261 7469 6f2c 206d 6169  argin ratio, mai
-0001f720: 6e74 656e 616e 6365 2061 6d6f 756e 7429  ntenance amount)
-0001f730: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-0001f740: 2020 2020 2020 6966 2028 7365 6c66 2e5f        if (self._
-0001f750: 636f 6e66 6967 2e67 6574 2827 7275 6e6d  config.get('runm
-0001f760: 6f64 6527 2920 696e 204f 5054 494d 495a  ode') in OPTIMIZ
-0001f770: 455f 4d4f 4445 530a 2020 2020 2020 2020  E_MODES.        
-0001f780: 2020 2020 2020 2020 6f72 2073 656c 662e          or self.
-0001f790: 6578 6368 616e 6765 5f68 6173 2827 6665  exchange_has('fe
-0001f7a0: 7463 684c 6576 6572 6167 6554 6965 7273  tchLeverageTiers
-0001f7b0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0001f7c0: 2020 206f 7220 7365 6c66 2e65 7863 6861     or self.excha
-0001f7d0: 6e67 655f 6861 7328 2766 6574 6368 4d61  nge_has('fetchMa
-0001f7e0: 726b 6574 4c65 7665 7261 6765 5469 6572  rketLeverageTier
-0001f7f0: 7327 2929 3a0a 0a20 2020 2020 2020 2020  s')):..         
-0001f800: 2020 2069 6620 7061 6972 206e 6f74 2069     if pair not i
-0001f810: 6e20 7365 6c66 2e5f 6c65 7665 7261 6765  n self._leverage
-0001f820: 5f74 6965 7273 3a0a 2020 2020 2020 2020  _tiers:.        
-0001f830: 2020 2020 2020 2020 7261 6973 6520 496e          raise In
-0001f840: 7661 6c69 644f 7264 6572 4578 6365 7074  validOrderExcept
-0001f850: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
-0001f860: 2020 2020 2020 2020 2066 224d 6169 6e74           f"Maint
-0001f870: 656e 616e 6365 206d 6172 6769 6e20 7261  enance margin ra
-0001f880: 7465 2066 6f72 207b 7061 6972 7d20 6973  te for {pair} is
-0001f890: 2075 6e61 7661 696c 6162 6c65 2066 6f72   unavailable for
-0001f8a0: 207b 7365 6c66 2e6e 616d 657d 220a 2020   {self.name}".  
-0001f8b0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0001f8c0: 0a20 2020 2020 2020 2020 2020 2070 6169  .            pai
-0001f8d0: 725f 7469 6572 7320 3d20 7365 6c66 2e5f  r_tiers = self._
-0001f8e0: 6c65 7665 7261 6765 5f74 6965 7273 5b70  leverage_tiers[p
-0001f8f0: 6169 725d 0a0a 2020 2020 2020 2020 2020  air]..          
-0001f900: 2020 666f 7220 7469 6572 2069 6e20 7265    for tier in re
-0001f910: 7665 7273 6564 2870 6169 725f 7469 6572  versed(pair_tier
-0001f920: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0001f930: 2020 2020 6966 206e 6f6d 696e 616c 5f76      if nominal_v
-0001f940: 616c 7565 203e 3d20 7469 6572 5b27 6d69  alue >= tier['mi
-0001f950: 6e4e 6f74 696f 6e61 6c27 5d3a 0a20 2020  nNotional']:.   
-0001f960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f970: 2072 6574 7572 6e20 2874 6965 725b 276d   return (tier['m
-0001f980: 6169 6e74 656e 616e 6365 4d61 7267 696e  aintenanceMargin
-0001f990: 5261 7465 275d 2c20 7469 6572 5b27 6d61  Rate'], tier['ma
-0001f9a0: 696e 7441 6d74 275d 290a 0a20 2020 2020  intAmt'])..     
-0001f9b0: 2020 2020 2020 2072 6169 7365 204f 7065         raise Ope
-0001f9c0: 7261 7469 6f6e 616c 4578 6365 7074 696f  rationalExceptio
-0001f9d0: 6e28 226e 6f6d 696e 616c 2076 616c 7565  n("nominal value
-0001f9e0: 2063 616e 206e 6f74 2062 6520 6c6f 7765   can not be lowe
-0001f9f0: 7220 7468 616e 2030 2229 0a20 2020 2020  r than 0").     
-0001fa00: 2020 2020 2020 2023 2054 6865 206c 6f77         # The low
-0001fa10: 6573 7420 6e6f 7469 6f6e 616c 5f66 6c6f  est notional_flo
-0001fa20: 6f72 2066 6f72 2061 6e79 2070 6169 7220  or for any pair 
-0001fa30: 696e 2066 6574 6368 5f6c 6576 6572 6167  in fetch_leverag
-0001fa40: 655f 7469 6572 7320 6973 2061 6c77 6179  e_tiers is alway
-0001fa50: 7320 3020 6265 6361 7573 6520 6974 0a20  s 0 because it. 
-0001fa60: 2020 2020 2020 2020 2020 2023 2064 6573             # des
-0001fa70: 6372 6962 6573 2074 6865 206d 696e 2061  cribes the min a
-0001fa80: 6d74 2066 6f72 2061 2074 6965 722c 2061  mt for a tier, a
-0001fa90: 6e64 2074 6865 206c 6f77 6573 7420 7469  nd the lowest ti
-0001faa0: 6572 2077 696c 6c20 616c 7761 7973 2067  er will always g
-0001fab0: 6f20 646f 776e 2074 6f20 300a 2020 2020  o down to 0.    
-0001fac0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001fad0: 2020 2020 2020 7261 6973 6520 4f70 6572        raise Oper
-0001fae0: 6174 696f 6e61 6c45 7863 6570 7469 6f6e  ationalException
-0001faf0: 2866 2243 616e 6e6f 7420 6765 7420 6d61  (f"Cannot get ma
-0001fb00: 696e 7465 6e61 6e63 6520 7261 7469 6f20  intenance ratio 
-0001fb10: 7573 696e 6720 7b73 656c 662e 6e61 6d65  using {self.name
-0001fb20: 7d22 290a                                }").
+0001e250: 2020 6675 6e64 696e 675f 7261 7465 732c    funding_rates,
+0001e260: 206f 6e3d 2764 6174 6527 2c20 686f 773d   on='date', how=
+0001e270: 226f 7574 6572 222c 2073 7566 6669 7865  "outer", suffixe
+0001e280: 733d 5b22 5f6d 6172 6b22 2c20 225f 6675  s=["_mark", "_fu
+0001e290: 6e64 225d 0a20 2020 2020 2020 2020 2020  nd"].           
+0001e2a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001e2b0: 2020 2020 2020 2020 2020 2063 6f6d 6269             combi
+0001e2c0: 6e65 645b 276f 7065 6e5f 6675 6e64 275d  ned['open_fund']
+0001e2d0: 203d 2063 6f6d 6269 6e65 645b 276f 7065   = combined['ope
+0001e2e0: 6e5f 6675 6e64 275d 2e66 696c 6c6e 6128  n_fund'].fillna(
+0001e2f0: 6675 7475 7265 735f 6675 6e64 696e 675f  futures_funding_
+0001e300: 7261 7465 290a 2020 2020 2020 2020 2020  rate).          
+0001e310: 2020 2020 2020 7265 7475 726e 2063 6f6d        return com
+0001e320: 6269 6e65 640a 0a20 2020 2064 6566 2063  bined..    def c
+0001e330: 616c 6375 6c61 7465 5f66 756e 6469 6e67  alculate_funding
+0001e340: 5f66 6565 7328 0a20 2020 2020 2020 2073  _fees(.        s
+0001e350: 656c 662c 0a20 2020 2020 2020 2064 663a  elf,.        df:
+0001e360: 2044 6174 6146 7261 6d65 2c0a 2020 2020   DataFrame,.    
+0001e370: 2020 2020 616d 6f75 6e74 3a20 666c 6f61      amount: floa
+0001e380: 742c 0a20 2020 2020 2020 2069 735f 7368  t,.        is_sh
+0001e390: 6f72 743a 2062 6f6f 6c2c 0a20 2020 2020  ort: bool,.     
+0001e3a0: 2020 206f 7065 6e5f 6461 7465 3a20 6461     open_date: da
+0001e3b0: 7465 7469 6d65 2c0a 2020 2020 2020 2020  tetime,.        
+0001e3c0: 636c 6f73 655f 6461 7465 3a20 4f70 7469  close_date: Opti
+0001e3d0: 6f6e 616c 5b64 6174 6574 696d 655d 203d  onal[datetime] =
+0001e3e0: 204e 6f6e 652c 0a20 2020 2020 2020 2074   None,.        t
+0001e3f0: 696d 655f 696e 5f72 6174 696f 3a20 4f70  ime_in_ratio: Op
+0001e400: 7469 6f6e 616c 5b66 6c6f 6174 5d20 3d20  tional[float] = 
+0001e410: 4e6f 6e65 0a20 2020 2029 202d 3e20 666c  None.    ) -> fl
+0001e420: 6f61 743a 0a20 2020 2020 2020 2022 2222  oat:.        """
+0001e430: 0a20 2020 2020 2020 2063 616c 6375 6c61  .        calcula
+0001e440: 7465 7320 7468 6520 7375 6d20 6f66 2061  tes the sum of a
+0001e450: 6c6c 2066 756e 6469 6e67 2066 6565 7320  ll funding fees 
+0001e460: 7468 6174 206f 6363 7572 7265 6420 666f  that occurred fo
+0001e470: 7220 6120 7061 6972 2064 7572 696e 6720  r a pair during 
+0001e480: 6120 6675 7475 7265 7320 7472 6164 650a  a futures trade.
+0001e490: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
+0001e4a0: 663a 2044 6174 6166 7261 6d65 2063 6f6e  f: Dataframe con
+0001e4b0: 7461 696e 696e 6720 636f 6d62 696e 6564  taining combined
+0001e4c0: 2066 756e 6469 6e67 2061 6e64 206d 6172   funding and mar
+0001e4d0: 6b20 7261 7465 730a 2020 2020 2020 2020  k rates.        
+0001e4e0: 2020 2020 2020 2020 2020 2061 7320 606f             as `o
+0001e4f0: 7065 6e5f 6675 6e64 6020 616e 6420 606f  pen_fund` and `o
+0001e500: 7065 6e5f 6d61 726b 602e 0a20 2020 2020  pen_mark`..     
+0001e510: 2020 203a 7061 7261 6d20 616d 6f75 6e74     :param amount
+0001e520: 3a20 5468 6520 7175 616e 7469 7479 206f  : The quantity o
+0001e530: 6620 7468 6520 7472 6164 650a 2020 2020  f the trade.    
+0001e540: 2020 2020 3a70 6172 616d 2069 735f 7368      :param is_sh
+0001e550: 6f72 743a 2074 7261 6465 2064 6972 6563  ort: trade direc
+0001e560: 7469 6f6e 0a20 2020 2020 2020 203a 7061  tion.        :pa
+0001e570: 7261 6d20 6f70 656e 5f64 6174 653a 2054  ram open_date: T
+0001e580: 6865 2064 6174 6520 616e 6420 7469 6d65  he date and time
+0001e590: 2074 6861 7420 7468 6520 7472 6164 6520   that the trade 
+0001e5a0: 7374 6172 7465 640a 2020 2020 2020 2020  started.        
+0001e5b0: 3a70 6172 616d 2063 6c6f 7365 5f64 6174  :param close_dat
+0001e5c0: 653a 2054 6865 2064 6174 6520 616e 6420  e: The date and 
+0001e5d0: 7469 6d65 2074 6861 7420 7468 6520 7472  time that the tr
+0001e5e0: 6164 6520 656e 6465 640a 2020 2020 2020  ade ended.      
+0001e5f0: 2020 3a70 6172 616d 2074 696d 655f 696e    :param time_in
+0001e600: 5f72 6174 696f 3a20 4e6f 7420 7573 6564  _ratio: Not used
+0001e610: 2062 7920 6d6f 7374 2065 7863 6861 6e67   by most exchang
+0001e620: 6520 636c 6173 7365 730a 2020 2020 2020  e classes.      
+0001e630: 2020 2222 220a 2020 2020 2020 2020 6665    """.        fe
+0001e640: 6573 3a20 666c 6f61 7420 3d20 300a 0a20  es: float = 0.. 
+0001e650: 2020 2020 2020 2069 6620 6e6f 7420 6466         if not df
+0001e660: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
+0001e670: 2020 2020 6466 203d 2064 665b 2864 665b      df = df[(df[
+0001e680: 2764 6174 6527 5d20 3e3d 206f 7065 6e5f  'date'] >= open_
+0001e690: 6461 7465 2920 2620 2864 665b 2764 6174  date) & (df['dat
+0001e6a0: 6527 5d20 3c3d 2063 6c6f 7365 5f64 6174  e'] <= close_dat
+0001e6b0: 6529 5d0a 2020 2020 2020 2020 2020 2020  e)].            
+0001e6c0: 6665 6573 203d 2073 756d 2864 665b 276f  fees = sum(df['o
+0001e6d0: 7065 6e5f 6675 6e64 275d 202a 2064 665b  pen_fund'] * df[
+0001e6e0: 276f 7065 6e5f 6d61 726b 275d 202a 2061  'open_mark'] * a
+0001e6f0: 6d6f 756e 7429 0a0a 2020 2020 2020 2020  mount)..        
+0001e700: 2320 4e65 6761 7465 2066 6565 7320 666f  # Negate fees fo
+0001e710: 7220 6c6f 6e67 7320 6173 2066 756e 6469  r longs as fundi
+0001e720: 6e67 5f66 6565 7320 6578 7065 6374 7320  ng_fees expects 
+0001e730: 6974 2074 6869 7320 7761 7920 6261 7365  it this way base
+0001e740: 6420 6f6e 206c 6976 6520 656e 6470 6f69  d on live endpoi
+0001e750: 6e74 732e 0a20 2020 2020 2020 2072 6574  nts..        ret
+0001e760: 7572 6e20 6665 6573 2069 6620 6973 5f73  urn fees if is_s
+0001e770: 686f 7274 2065 6c73 6520 2d66 6565 730a  hort else -fees.
+0001e780: 0a20 2020 2064 6566 2067 6574 5f66 756e  .    def get_fun
+0001e790: 6469 6e67 5f66 6565 7328 0a20 2020 2020  ding_fees(.     
+0001e7a0: 2020 2020 2020 2073 656c 662c 2070 6169         self, pai
+0001e7b0: 723a 2073 7472 2c20 616d 6f75 6e74 3a20  r: str, amount: 
+0001e7c0: 666c 6f61 742c 2069 735f 7368 6f72 743a  float, is_short:
+0001e7d0: 2062 6f6f 6c2c 206f 7065 6e5f 6461 7465   bool, open_date
+0001e7e0: 3a20 6461 7465 7469 6d65 2920 2d3e 2066  : datetime) -> f
+0001e7f0: 6c6f 6174 3a0a 2020 2020 2020 2020 2222  loat:.        ""
+0001e800: 220a 2020 2020 2020 2020 4665 7463 6820  ".        Fetch 
+0001e810: 6675 6e64 696e 6720 6665 6573 2c20 6569  funding fees, ei
+0001e820: 7468 6572 2066 726f 6d20 7468 6520 6578  ther from the ex
+0001e830: 6368 616e 6765 2028 6c69 7665 2920 6f72  change (live) or
+0001e840: 2063 616c 6375 6c61 7465 7320 7468 656d   calculates them
+0001e850: 0a20 2020 2020 2020 2062 6173 6564 206f  .        based o
+0001e860: 6e20 6675 6e64 696e 6720 7261 7465 2f6d  n funding rate/m
+0001e870: 6172 6b20 7072 6963 6520 6869 7374 6f72  ark price histor
+0001e880: 790a 2020 2020 2020 2020 3a70 6172 616d  y.        :param
+0001e890: 2070 6169 723a 2054 6865 2071 756f 7465   pair: The quote
+0001e8a0: 2f62 6173 6520 7061 6972 206f 6620 7468  /base pair of th
+0001e8b0: 6520 7472 6164 650a 2020 2020 2020 2020  e trade.        
+0001e8c0: 3a70 6172 616d 2069 735f 7368 6f72 743a  :param is_short:
+0001e8d0: 2074 7261 6465 2064 6972 6563 7469 6f6e   trade direction
+0001e8e0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0001e8f0: 616d 6f75 6e74 3a20 5472 6164 6520 616d  amount: Trade am
+0001e900: 6f75 6e74 0a20 2020 2020 2020 203a 7061  ount.        :pa
+0001e910: 7261 6d20 6f70 656e 5f64 6174 653a 204f  ram open_date: O
+0001e920: 7065 6e20 6461 7465 206f 6620 7468 6520  pen date of the 
+0001e930: 7472 6164 650a 2020 2020 2020 2020 3a72  trade.        :r
+0001e940: 6574 7572 6e3a 2066 756e 6469 6e67 2066  eturn: funding f
+0001e950: 6565 2073 696e 6365 206f 7065 6e5f 6461  ee since open_da
+0001e960: 7465 0a20 2020 2020 2020 203a 7261 6973  te.        :rais
+0001e970: 6573 3a20 4578 6368 616e 6765 4572 726f  es: ExchangeErro
+0001e980: 7220 6966 2073 6f6d 6574 6869 6e67 2067  r if something g
+0001e990: 6f65 7320 7772 6f6e 672e 0a20 2020 2020  oes wrong..     
+0001e9a0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+0001e9b0: 6620 7365 6c66 2e74 7261 6469 6e67 5f6d  f self.trading_m
+0001e9c0: 6f64 6520 3d3d 2054 7261 6469 6e67 4d6f  ode == TradingMo
+0001e9d0: 6465 2e46 5554 5552 4553 3a0a 2020 2020  de.FUTURES:.    
+0001e9e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001e9f0: 5f63 6f6e 6669 675b 2764 7279 5f72 756e  _config['dry_run
+0001ea00: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
+0001ea10: 2020 2020 6675 6e64 696e 675f 6665 6573      funding_fees
+0001ea20: 203d 2073 656c 662e 5f66 6574 6368 5f61   = self._fetch_a
+0001ea30: 6e64 5f63 616c 6375 6c61 7465 5f66 756e  nd_calculate_fun
+0001ea40: 6469 6e67 5f66 6565 7328 0a20 2020 2020  ding_fees(.     
+0001ea50: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0001ea60: 6169 722c 2061 6d6f 756e 742c 2069 735f  air, amount, is_
+0001ea70: 7368 6f72 742c 206f 7065 6e5f 6461 7465  short, open_date
+0001ea80: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0001ea90: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001eaa0: 2020 2020 6675 6e64 696e 675f 6665 6573      funding_fees
+0001eab0: 203d 2073 656c 662e 5f67 6574 5f66 756e   = self._get_fun
+0001eac0: 6469 6e67 5f66 6565 735f 6672 6f6d 5f65  ding_fees_from_e
+0001ead0: 7863 6861 6e67 6528 7061 6972 2c20 6f70  xchange(pair, op
+0001eae0: 656e 5f64 6174 6529 0a20 2020 2020 2020  en_date).       
+0001eaf0: 2020 2020 2072 6574 7572 6e20 6675 6e64       return fund
+0001eb00: 696e 675f 6665 6573 0a20 2020 2020 2020  ing_fees.       
+0001eb10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001eb20: 2020 2072 6574 7572 6e20 302e 300a 0a20     return 0.0.. 
+0001eb30: 2020 2064 6566 2067 6574 5f6c 6971 7569     def get_liqui
+0001eb40: 6461 7469 6f6e 5f70 7269 6365 280a 2020  dation_price(.  
+0001eb50: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0001eb60: 2020 2020 7061 6972 3a20 7374 722c 0a20      pair: str,. 
+0001eb70: 2020 2020 2020 2023 2044 7279 2d72 756e         # Dry-run
+0001eb80: 0a20 2020 2020 2020 206f 7065 6e5f 7261  .        open_ra
+0001eb90: 7465 3a20 666c 6f61 742c 2020 2023 2045  te: float,   # E
+0001eba0: 6e74 7279 2070 7269 6365 206f 6620 706f  ntry price of po
+0001ebb0: 7369 7469 6f6e 0a20 2020 2020 2020 2069  sition.        i
+0001ebc0: 735f 7368 6f72 743a 2062 6f6f 6c2c 0a20  s_short: bool,. 
+0001ebd0: 2020 2020 2020 2061 6d6f 756e 743a 2066         amount: f
+0001ebe0: 6c6f 6174 2c20 2023 2041 6273 6f6c 7574  loat,  # Absolut
+0001ebf0: 6520 7661 6c75 6520 6f66 2070 6f73 6974  e value of posit
+0001ec00: 696f 6e20 7369 7a65 0a20 2020 2020 2020  ion size.       
+0001ec10: 2073 7461 6b65 5f61 6d6f 756e 743a 2066   stake_amount: f
+0001ec20: 6c6f 6174 2c0a 2020 2020 2020 2020 6c65  loat,.        le
+0001ec30: 7665 7261 6765 3a20 666c 6f61 742c 0a20  verage: float,. 
+0001ec40: 2020 2020 2020 2077 616c 6c65 745f 6261         wallet_ba
+0001ec50: 6c61 6e63 653a 2066 6c6f 6174 2c0a 2020  lance: float,.  
+0001ec60: 2020 2020 2020 6d6d 5f65 785f 313a 2066        mm_ex_1: f
+0001ec70: 6c6f 6174 203d 2030 2e30 2c20 2023 2028  loat = 0.0,  # (
+0001ec80: 4269 6e61 6e63 6529 2043 726f 7373 206f  Binance) Cross o
+0001ec90: 6e6c 790a 2020 2020 2020 2020 7570 6e6c  nly.        upnl
+0001eca0: 5f65 785f 313a 2066 6c6f 6174 203d 2030  _ex_1: float = 0
+0001ecb0: 2e30 2c20 2023 2028 4269 6e61 6e63 6529  .0,  # (Binance)
+0001ecc0: 2043 726f 7373 206f 6e6c 790a 2020 2020   Cross only.    
+0001ecd0: 2920 2d3e 204f 7074 696f 6e61 6c5b 666c  ) -> Optional[fl
+0001ece0: 6f61 745d 3a0a 2020 2020 2020 2020 2222  oat]:.        ""
+0001ecf0: 220a 2020 2020 2020 2020 5365 7427 7320  ".        Set's 
+0001ed00: 7468 6520 6d61 7267 696e 206d 6f64 6520  the margin mode 
+0001ed10: 6f6e 2074 6865 2065 7863 6861 6e67 6520  on the exchange 
+0001ed20: 746f 2063 726f 7373 206f 7220 6973 6f6c  to cross or isol
+0001ed30: 6174 6564 2066 6f72 2061 2073 7065 6369  ated for a speci
+0001ed40: 6669 6320 7061 6972 0a20 2020 2020 2020  fic pair.       
+0001ed50: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+0001ed60: 7365 6c66 2e74 7261 6469 6e67 5f6d 6f64  self.trading_mod
+0001ed70: 6520 3d3d 2054 7261 6469 6e67 4d6f 6465  e == TradingMode
+0001ed80: 2e53 504f 543a 0a20 2020 2020 2020 2020  .SPOT:.         
+0001ed90: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
+0001eda0: 2020 2020 2020 2065 6c69 6620 2873 656c         elif (sel
+0001edb0: 662e 7472 6164 696e 675f 6d6f 6465 2021  f.trading_mode !
+0001edc0: 3d20 5472 6164 696e 674d 6f64 652e 4655  = TradingMode.FU
+0001edd0: 5455 5245 5329 3a0a 2020 2020 2020 2020  TURES):.        
+0001ede0: 2020 2020 7261 6973 6520 4f70 6572 6174      raise Operat
+0001edf0: 696f 6e61 6c45 7863 6570 7469 6f6e 280a  ionalException(.
+0001ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee10: 6622 7b73 656c 662e 6e61 6d65 7d20 646f  f"{self.name} do
+0001ee20: 6573 206e 6f74 2073 7570 706f 7274 207b  es not support {
+0001ee30: 7365 6c66 2e6d 6172 6769 6e5f 6d6f 6465  self.margin_mode
+0001ee40: 7d20 7b73 656c 662e 7472 6164 696e 675f  } {self.trading_
+0001ee50: 6d6f 6465 7d22 290a 0a20 2020 2020 2020  mode}")..       
+0001ee60: 206c 6971 7569 6461 7469 6f6e 5f70 7269   liquidation_pri
+0001ee70: 6365 203d 204e 6f6e 650a 2020 2020 2020  ce = None.      
+0001ee80: 2020 6966 2073 656c 662e 5f63 6f6e 6669    if self._confi
+0001ee90: 675b 2764 7279 5f72 756e 275d 206f 7220  g['dry_run'] or 
+0001eea0: 6e6f 7420 7365 6c66 2e65 7863 6861 6e67  not self.exchang
+0001eeb0: 655f 6861 7328 2266 6574 6368 506f 7369  e_has("fetchPosi
+0001eec0: 7469 6f6e 7322 293a 0a0a 2020 2020 2020  tions"):..      
+0001eed0: 2020 2020 2020 6c69 7175 6964 6174 696f        liquidatio
+0001eee0: 6e5f 7072 6963 6520 3d20 7365 6c66 2e64  n_price = self.d
+0001eef0: 7279 5f72 756e 5f6c 6971 7569 6461 7469  ry_run_liquidati
+0001ef00: 6f6e 5f70 7269 6365 280a 2020 2020 2020  on_price(.      
+0001ef10: 2020 2020 2020 2020 2020 7061 6972 3d70            pair=p
+0001ef20: 6169 722c 0a20 2020 2020 2020 2020 2020  air,.           
+0001ef30: 2020 2020 206f 7065 6e5f 7261 7465 3d6f       open_rate=o
+0001ef40: 7065 6e5f 7261 7465 2c0a 2020 2020 2020  pen_rate,.      
+0001ef50: 2020 2020 2020 2020 2020 6973 5f73 686f            is_sho
+0001ef60: 7274 3d69 735f 7368 6f72 742c 0a20 2020  rt=is_short,.   
+0001ef70: 2020 2020 2020 2020 2020 2020 2061 6d6f               amo
+0001ef80: 756e 743d 616d 6f75 6e74 2c0a 2020 2020  unt=amount,.    
+0001ef90: 2020 2020 2020 2020 2020 2020 6c65 7665              leve
+0001efa0: 7261 6765 3d6c 6576 6572 6167 652c 0a20  rage=leverage,. 
+0001efb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001efc0: 7461 6b65 5f61 6d6f 756e 743d 7374 616b  take_amount=stak
+0001efd0: 655f 616d 6f75 6e74 2c0a 2020 2020 2020  e_amount,.      
+0001efe0: 2020 2020 2020 2020 2020 7761 6c6c 6574            wallet
+0001eff0: 5f62 616c 616e 6365 3d77 616c 6c65 745f  _balance=wallet_
+0001f000: 6261 6c61 6e63 652c 0a20 2020 2020 2020  balance,.       
+0001f010: 2020 2020 2020 2020 206d 6d5f 6578 5f31           mm_ex_1
+0001f020: 3d6d 6d5f 6578 5f31 2c0a 2020 2020 2020  =mm_ex_1,.      
+0001f030: 2020 2020 2020 2020 2020 7570 6e6c 5f65            upnl_e
+0001f040: 785f 313d 7570 6e6c 5f65 785f 310a 2020  x_1=upnl_ex_1.  
+0001f050: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0001f060: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001f070: 2020 2020 2020 706f 7369 7469 6f6e 7320        positions 
+0001f080: 3d20 7365 6c66 2e66 6574 6368 5f70 6f73  = self.fetch_pos
+0001f090: 6974 696f 6e73 2870 6169 7229 0a20 2020  itions(pair).   
+0001f0a0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0001f0b0: 706f 7369 7469 6f6e 7329 203e 2030 3a0a  positions) > 0:.
+0001f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f0d0: 706f 7320 3d20 706f 7369 7469 6f6e 735b  pos = positions[
+0001f0e0: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+0001f0f0: 2020 206c 6971 7569 6461 7469 6f6e 5f70     liquidation_p
+0001f100: 7269 6365 203d 2070 6f73 5b27 6c69 7175  rice = pos['liqu
+0001f110: 6964 6174 696f 6e50 7269 6365 275d 0a0a  idationPrice']..
+0001f120: 2020 2020 2020 2020 6966 206c 6971 7569          if liqui
+0001f130: 6461 7469 6f6e 5f70 7269 6365 2069 7320  dation_price is 
+0001f140: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0001f150: 2020 2020 2020 6275 6666 6572 5f61 6d6f        buffer_amo
+0001f160: 756e 7420 3d20 6162 7328 6f70 656e 5f72  unt = abs(open_r
+0001f170: 6174 6520 2d20 6c69 7175 6964 6174 696f  ate - liquidatio
+0001f180: 6e5f 7072 6963 6529 202a 2073 656c 662e  n_price) * self.
+0001f190: 6c69 7175 6964 6174 696f 6e5f 6275 6666  liquidation_buff
+0001f1a0: 6572 0a20 2020 2020 2020 2020 2020 206c  er.            l
+0001f1b0: 6971 7569 6461 7469 6f6e 5f70 7269 6365  iquidation_price
+0001f1c0: 5f62 7566 6665 7220 3d20 280a 2020 2020  _buffer = (.    
+0001f1d0: 2020 2020 2020 2020 2020 2020 6c69 7175              liqu
+0001f1e0: 6964 6174 696f 6e5f 7072 6963 6520 2d20  idation_price - 
+0001f1f0: 6275 6666 6572 5f61 6d6f 756e 740a 2020  buffer_amount.  
+0001f200: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001f210: 2069 735f 7368 6f72 7420 656c 7365 0a20   is_short else. 
+0001f220: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0001f230: 6971 7569 6461 7469 6f6e 5f70 7269 6365  iquidation_price
+0001f240: 202b 2062 7566 6665 725f 616d 6f75 6e74   + buffer_amount
+0001f250: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001f260: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001f270: 6e20 6d61 7828 6c69 7175 6964 6174 696f  n max(liquidatio
+0001f280: 6e5f 7072 6963 655f 6275 6666 6572 2c20  n_price_buffer, 
+0001f290: 302e 3029 0a20 2020 2020 2020 2065 6c73  0.0).        els
+0001f2a0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001f2b0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+0001f2c0: 6465 6620 6472 795f 7275 6e5f 6c69 7175  def dry_run_liqu
+0001f2d0: 6964 6174 696f 6e5f 7072 6963 6528 0a20  idation_price(. 
+0001f2e0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0001f2f0: 2020 2020 2070 6169 723a 2073 7472 2c0a       pair: str,.
+0001f300: 2020 2020 2020 2020 6f70 656e 5f72 6174          open_rat
+0001f310: 653a 2066 6c6f 6174 2c20 2020 2320 456e  e: float,   # En
+0001f320: 7472 7920 7072 6963 6520 6f66 2070 6f73  try price of pos
+0001f330: 6974 696f 6e0a 2020 2020 2020 2020 6973  ition.        is
+0001f340: 5f73 686f 7274 3a20 626f 6f6c 2c0a 2020  _short: bool,.  
+0001f350: 2020 2020 2020 616d 6f75 6e74 3a20 666c        amount: fl
+0001f360: 6f61 742c 0a20 2020 2020 2020 2073 7461  oat,.        sta
+0001f370: 6b65 5f61 6d6f 756e 743a 2066 6c6f 6174  ke_amount: float
+0001f380: 2c0a 2020 2020 2020 2020 6c65 7665 7261  ,.        levera
+0001f390: 6765 3a20 666c 6f61 742c 0a20 2020 2020  ge: float,.     
+0001f3a0: 2020 2077 616c 6c65 745f 6261 6c61 6e63     wallet_balanc
+0001f3b0: 653a 2066 6c6f 6174 2c20 2023 204f 7220  e: float,  # Or 
+0001f3c0: 6d61 7267 696e 2062 616c 616e 6365 0a20  margin balance. 
+0001f3d0: 2020 2020 2020 206d 6d5f 6578 5f31 3a20         mm_ex_1: 
+0001f3e0: 666c 6f61 7420 3d20 302e 302c 2020 2320  float = 0.0,  # 
+0001f3f0: 2842 696e 616e 6365 2920 4372 6f73 7320  (Binance) Cross 
+0001f400: 6f6e 6c79 0a20 2020 2020 2020 2075 706e  only.        upn
+0001f410: 6c5f 6578 5f31 3a20 666c 6f61 7420 3d20  l_ex_1: float = 
+0001f420: 302e 302c 2020 2320 2842 696e 616e 6365  0.0,  # (Binance
+0001f430: 2920 4372 6f73 7320 6f6e 6c79 0a20 2020  ) Cross only.   
+0001f440: 2029 202d 3e20 4f70 7469 6f6e 616c 5b66   ) -> Optional[f
+0001f450: 6c6f 6174 5d3a 0a20 2020 2020 2020 2022  loat]:.        "
+0001f460: 2222 0a20 2020 2020 2020 2049 6d70 6f72  "".        Impor
+0001f470: 7461 6e74 3a20 4d75 7374 2062 6520 6665  tant: Must be fe
+0001f480: 7463 6869 6e67 2064 6174 6120 6672 6f6d  tching data from
+0001f490: 2063 6163 6865 6420 7661 6c75 6573 2061   cached values a
+0001f4a0: 7320 7468 6973 2069 7320 7573 6564 2062  s this is used b
+0001f4b0: 7920 6261 636b 7465 7374 696e 6721 0a20  y backtesting!. 
+0001f4c0: 2020 2020 2020 2050 4552 5045 5455 414c         PERPETUAL
+0001f4d0: 3a0a 2020 2020 2020 2020 2067 6174 653a  :.         gate:
+0001f4e0: 2068 7474 7073 3a2f 2f77 7777 2e67 6174   https://www.gat
+0001f4f0: 652e 696f 2f68 656c 702f 6675 7475 7265  e.io/help/future
+0001f500: 732f 6675 7475 7265 732f 3237 3732 342f  s/futures/27724/
+0001f510: 6c69 7175 6964 6174 696f 6e2d 7072 6963  liquidation-pric
+0001f520: 652d 6261 6e6b 7275 7074 6379 2d70 7269  e-bankruptcy-pri
+0001f530: 6365 0a20 2020 2020 2020 2020 3e20 4c69  ce.         > Li
+0001f540: 7175 6964 6174 696f 6e20 5072 6963 6520  quidation Price 
+0001f550: 3d20 2845 6e74 7279 2050 7269 6365 20c2  = (Entry Price .
+0001f560: b120 4d61 7267 696e 202f 2043 6f6e 7472  . Margin / Contr
+0001f570: 6163 7420 4d75 6c74 6970 6c69 6572 202f  act Multiplier /
+0001f580: 2053 697a 6529 202f 0a20 2020 2020 2020   Size) /.       
+0001f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5a0: 2020 2020 2020 2020 205b 2031 20c2 b120           [ 1 .. 
+0001f5b0: 284d 6169 6e74 656e 616e 6365 204d 6172  (Maintenance Mar
+0001f5c0: 6769 6e20 5261 7469 6f20 2b20 5461 6b65  gin Ratio + Take
+0001f5d0: 7220 5261 7465 295d 0a20 2020 2020 2020  r Rate)].       
+0001f5e0: 2020 2020 2057 6865 7265 696e 2c20 222b       Wherein, "+
+0001f5f0: 2220 6f72 2022 2d22 2064 6570 656e 6473  " or "-" depends
+0001f600: 206f 6e20 7768 6574 6865 7220 7468 6520   on whether the 
+0001f610: 636f 6e74 7261 6374 2067 6f65 7320 6c6f  contract goes lo
+0001f620: 6e67 206f 7220 7368 6f72 743a 0a20 2020  ng or short:.   
+0001f630: 2020 2020 2020 2020 2022 2d22 2066 6f72           "-" for
+0001f640: 206c 6f6e 672c 2061 6e64 2022 2b22 2066   long, and "+" f
+0001f650: 6f72 2073 686f 7274 2e0a 0a20 2020 2020  or short...     
+0001f660: 2020 2020 6f6b 6578 3a20 6874 7470 733a      okex: https:
+0001f670: 2f2f 7777 772e 6f6b 6578 2e63 6f6d 2f73  //www.okex.com/s
+0001f680: 7570 706f 7274 2f68 632f 656e 2d75 732f  upport/hc/en-us/
+0001f690: 6172 7469 636c 6573 2f0a 2020 2020 2020  articles/.      
+0001f6a0: 2020 2020 2020 3336 3030 3533 3930 3935        3600539095
+0001f6b0: 3932 2d56 492d 496e 7472 6f64 7563 7469  92-VI-Introducti
+0001f6c0: 6f6e 2d74 6f2d 7468 652d 6973 6f6c 6174  on-to-the-isolat
+0001f6d0: 6564 2d6d 6f64 652d 6f66 2d53 696e 676c  ed-mode-of-Singl
+0001f6e0: 652d 4d75 6c74 692d 6375 7272 656e 6379  e-Multi-currency
+0001f6f0: 2d50 6f72 7466 6f6c 696f 2d6d 6172 6769  -Portfolio-margi
+0001f700: 6e0a 0a20 2020 2020 2020 203a 7061 7261  n..        :para
+0001f710: 6d20 7061 6972 3a20 5061 6972 2074 6f20  m pair: Pair to 
+0001f720: 6361 6c63 756c 6174 6520 6c69 7175 6964  calculate liquid
+0001f730: 6174 696f 6e20 7072 6963 6520 666f 720a  ation price for.
+0001f740: 2020 2020 2020 2020 3a70 6172 616d 206f          :param o
+0001f750: 7065 6e5f 7261 7465 3a20 456e 7472 7920  pen_rate: Entry 
+0001f760: 7072 6963 6520 6f66 2070 6f73 6974 696f  price of positio
+0001f770: 6e0a 2020 2020 2020 2020 3a70 6172 616d  n.        :param
+0001f780: 2069 735f 7368 6f72 743a 2054 7275 6520   is_short: True 
+0001f790: 6966 2074 6865 2074 7261 6465 2069 7320  if the trade is 
+0001f7a0: 6120 7368 6f72 742c 2066 616c 7365 206f  a short, false o
+0001f7b0: 7468 6572 7769 7365 0a20 2020 2020 2020  therwise.       
+0001f7c0: 203a 7061 7261 6d20 616d 6f75 6e74 3a20   :param amount: 
+0001f7d0: 4162 736f 6c75 7465 2076 616c 7565 206f  Absolute value o
+0001f7e0: 6620 706f 7369 7469 6f6e 2073 697a 6520  f position size 
+0001f7f0: 696e 636c 2e20 6c65 7665 7261 6765 2028  incl. leverage (
+0001f800: 696e 2062 6173 6520 6375 7272 656e 6379  in base currency
+0001f810: 290a 2020 2020 2020 2020 3a70 6172 616d  ).        :param
+0001f820: 2073 7461 6b65 5f61 6d6f 756e 743a 2053   stake_amount: S
+0001f830: 7461 6b65 2061 6d6f 756e 7420 2d20 436f  take amount - Co
+0001f840: 6c6c 6174 6572 616c 2069 6e20 7365 7474  llateral in sett
+0001f850: 6c65 2063 7572 7265 6e63 792e 0a20 2020  le currency..   
+0001f860: 2020 2020 203a 7061 7261 6d20 6c65 7665       :param leve
+0001f870: 7261 6765 3a20 4c65 7665 7261 6765 2075  rage: Leverage u
+0001f880: 7365 6420 666f 7220 7468 6973 2070 6f73  sed for this pos
+0001f890: 6974 696f 6e2e 0a20 2020 2020 2020 203a  ition..        :
+0001f8a0: 7061 7261 6d20 7472 6164 696e 675f 6d6f  param trading_mo
+0001f8b0: 6465 3a20 5350 4f54 2c20 4d41 5247 494e  de: SPOT, MARGIN
+0001f8c0: 2c20 4655 5455 5245 532c 2065 7463 2e0a  , FUTURES, etc..
+0001f8d0: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
+0001f8e0: 6172 6769 6e5f 6d6f 6465 3a20 4569 7468  argin_mode: Eith
+0001f8f0: 6572 2049 534f 4c41 5445 4420 6f72 2043  er ISOLATED or C
+0001f900: 524f 5353 0a20 2020 2020 2020 203a 7061  ROSS.        :pa
+0001f910: 7261 6d20 7761 6c6c 6574 5f62 616c 616e  ram wallet_balan
+0001f920: 6365 3a20 416d 6f75 6e74 206f 6620 6d61  ce: Amount of ma
+0001f930: 7267 696e 5f6d 6f64 6520 696e 2074 6865  rgin_mode in the
+0001f940: 2077 616c 6c65 7420 6265 696e 6720 7573   wallet being us
+0001f950: 6564 2074 6f20 7472 6164 650a 2020 2020  ed to trade.    
+0001f960: 2020 2020 2020 2020 4372 6f73 732d 4d61          Cross-Ma
+0001f970: 7267 696e 204d 6f64 653a 2063 726f 7373  rgin Mode: cross
+0001f980: 5761 6c6c 6574 4261 6c61 6e63 650a 2020  WalletBalance.  
+0001f990: 2020 2020 2020 2020 2020 4973 6f6c 6174            Isolat
+0001f9a0: 6564 2d4d 6172 6769 6e20 4d6f 6465 3a20  ed-Margin Mode: 
+0001f9b0: 6973 6f6c 6174 6564 5761 6c6c 6574 4261  isolatedWalletBa
+0001f9c0: 6c61 6e63 650a 0a20 2020 2020 2020 2023  lance..        #
+0001f9d0: 202a 204e 6f74 2072 6571 7569 7265 6420   * Not required 
+0001f9e0: 6279 2047 6174 6520 6f72 204f 4b58 0a20  by Gate or OKX. 
+0001f9f0: 2020 2020 2020 203a 7061 7261 6d20 6d6d         :param mm
+0001fa00: 5f65 785f 313a 0a20 2020 2020 2020 203a  _ex_1:.        :
+0001fa10: 7061 7261 6d20 7570 6e6c 5f65 785f 313a  param upnl_ex_1:
+0001fa20: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+0001fa30: 2020 2020 2020 6d61 726b 6574 203d 2073        market = s
+0001fa40: 656c 662e 6d61 726b 6574 735b 7061 6972  elf.markets[pair
+0001fa50: 5d0a 2020 2020 2020 2020 7461 6b65 725f  ].        taker_
+0001fa60: 6665 655f 7261 7465 203d 206d 6172 6b65  fee_rate = marke
+0001fa70: 745b 2774 616b 6572 275d 0a20 2020 2020  t['taker'].     
+0001fa80: 2020 206d 6d5f 7261 7469 6f2c 205f 203d     mm_ratio, _ =
+0001fa90: 2073 656c 662e 6765 745f 6d61 696e 7465   self.get_mainte
+0001faa0: 6e61 6e63 655f 7261 7469 6f5f 616e 645f  nance_ratio_and_
+0001fab0: 616d 7428 7061 6972 2c20 7374 616b 655f  amt(pair, stake_
+0001fac0: 616d 6f75 6e74 290a 0a20 2020 2020 2020  amount)..       
+0001fad0: 2069 6620 7365 6c66 2e74 7261 6469 6e67   if self.trading
+0001fae0: 5f6d 6f64 6520 3d3d 2054 7261 6469 6e67  _mode == Trading
+0001faf0: 4d6f 6465 2e46 5554 5552 4553 2061 6e64  Mode.FUTURES and
+0001fb00: 2073 656c 662e 6d61 7267 696e 5f6d 6f64   self.margin_mod
+0001fb10: 6520 3d3d 204d 6172 6769 6e4d 6f64 652e  e == MarginMode.
+0001fb20: 4953 4f4c 4154 4544 3a0a 0a20 2020 2020  ISOLATED:..     
+0001fb30: 2020 2020 2020 2069 6620 6d61 726b 6574         if market
+0001fb40: 5b27 696e 7665 7273 6527 5d3a 0a20 2020  ['inverse']:.   
+0001fb50: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001fb60: 7365 204f 7065 7261 7469 6f6e 616c 4578  se OperationalEx
+0001fb70: 6365 7074 696f 6e28 0a20 2020 2020 2020  ception(.       
+0001fb80: 2020 2020 2020 2020 2020 2020 2022 4672               "Fr
+0001fb90: 6571 7472 6164 6520 646f 6573 206e 6f74  eqtrade does not
+0001fba0: 2079 6574 2073 7570 706f 7274 2069 6e76   yet support inv
+0001fbb0: 6572 7365 2063 6f6e 7472 6163 7473 2229  erse contracts")
+0001fbc0: 0a0a 2020 2020 2020 2020 2020 2020 7661  ..            va
+0001fbd0: 6c75 6520 3d20 7761 6c6c 6574 5f62 616c  lue = wallet_bal
+0001fbe0: 616e 6365 202f 2061 6d6f 756e 740a 0a20  ance / amount.. 
+0001fbf0: 2020 2020 2020 2020 2020 206d 6d5f 7261             mm_ra
+0001fc00: 7469 6f5f 7461 6b65 7220 3d20 286d 6d5f  tio_taker = (mm_
+0001fc10: 7261 7469 6f20 2b20 7461 6b65 725f 6665  ratio + taker_fe
+0001fc20: 655f 7261 7465 290a 2020 2020 2020 2020  e_rate).        
+0001fc30: 2020 2020 6966 2069 735f 7368 6f72 743a      if is_short:
+0001fc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fc50: 2072 6574 7572 6e20 286f 7065 6e5f 7261   return (open_ra
+0001fc60: 7465 202b 2076 616c 7565 2920 2f20 2831  te + value) / (1
+0001fc70: 202b 206d 6d5f 7261 7469 6f5f 7461 6b65   + mm_ratio_take
+0001fc80: 7229 0a20 2020 2020 2020 2020 2020 2065  r).            e
+0001fc90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001fca0: 2020 2020 2072 6574 7572 6e20 286f 7065       return (ope
+0001fcb0: 6e5f 7261 7465 202d 2076 616c 7565 2920  n_rate - value) 
+0001fcc0: 2f20 2831 202d 206d 6d5f 7261 7469 6f5f  / (1 - mm_ratio_
+0001fcd0: 7461 6b65 7229 0a20 2020 2020 2020 2065  taker).        e
+0001fce0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001fcf0: 2072 6169 7365 204f 7065 7261 7469 6f6e   raise Operation
+0001fd00: 616c 4578 6365 7074 696f 6e28 0a20 2020  alException(.   
+0001fd10: 2020 2020 2020 2020 2020 2020 2022 4672               "Fr
+0001fd20: 6571 7472 6164 6520 6f6e 6c79 2073 7570  eqtrade only sup
+0001fd30: 706f 7274 7320 6973 6f6c 6174 6564 2066  ports isolated f
+0001fd40: 7574 7572 6573 2066 6f72 206c 6576 6572  utures for lever
+0001fd50: 6167 6520 7472 6164 696e 6722 290a 0a20  age trading").. 
+0001fd60: 2020 2064 6566 2067 6574 5f6d 6169 6e74     def get_maint
+0001fd70: 656e 616e 6365 5f72 6174 696f 5f61 6e64  enance_ratio_and
+0001fd80: 5f61 6d74 280a 2020 2020 2020 2020 7365  _amt(.        se
+0001fd90: 6c66 2c0a 2020 2020 2020 2020 7061 6972  lf,.        pair
+0001fda0: 3a20 7374 722c 0a20 2020 2020 2020 206e  : str,.        n
+0001fdb0: 6f6d 696e 616c 5f76 616c 7565 3a20 666c  ominal_value: fl
+0001fdc0: 6f61 742c 0a20 2020 2029 202d 3e20 5475  oat,.    ) -> Tu
+0001fdd0: 706c 655b 666c 6f61 742c 204f 7074 696f  ple[float, Optio
+0001fde0: 6e61 6c5b 666c 6f61 745d 5d3a 0a20 2020  nal[float]]:.   
+0001fdf0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0001fe00: 2049 6d70 6f72 7461 6e74 3a20 4d75 7374   Important: Must
+0001fe10: 2062 6520 6665 7463 6869 6e67 2064 6174   be fetching dat
+0001fe20: 6120 6672 6f6d 2063 6163 6865 6420 7661  a from cached va
+0001fe30: 6c75 6573 2061 7320 7468 6973 2069 7320  lues as this is 
+0001fe40: 7573 6564 2062 7920 6261 636b 7465 7374  used by backtest
+0001fe50: 696e 6721 0a20 2020 2020 2020 203a 7061  ing!.        :pa
+0001fe60: 7261 6d20 7061 6972 3a20 4d61 726b 6574  ram pair: Market
+0001fe70: 2073 796d 626f 6c0a 2020 2020 2020 2020   symbol.        
+0001fe80: 3a70 6172 616d 206e 6f6d 696e 616c 5f76  :param nominal_v
+0001fe90: 616c 7565 3a20 5468 6520 746f 7461 6c20  alue: The total 
+0001fea0: 7472 6164 6520 616d 6f75 6e74 2069 6e20  trade amount in 
+0001feb0: 7175 6f74 6520 6375 7272 656e 6379 2069  quote currency i
+0001fec0: 6e63 6c75 6469 6e67 206c 6576 6572 6167  ncluding leverag
+0001fed0: 650a 2020 2020 2020 2020 6d61 696e 7465  e.        mainte
+0001fee0: 6e61 6e63 6520 616d 6f75 6e74 206f 6e6c  nance amount onl
+0001fef0: 7920 6f6e 2042 696e 616e 6365 0a20 2020  y on Binance.   
+0001ff00: 2020 2020 203a 7265 7475 726e 3a20 286d       :return: (m
+0001ff10: 6169 6e74 656e 616e 6365 206d 6172 6769  aintenance margi
+0001ff20: 6e20 7261 7469 6f2c 206d 6169 6e74 656e  n ratio, mainten
+0001ff30: 616e 6365 2061 6d6f 756e 7429 0a20 2020  ance amount).   
+0001ff40: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+0001ff50: 2020 6966 2028 7365 6c66 2e5f 636f 6e66    if (self._conf
+0001ff60: 6967 2e67 6574 2827 7275 6e6d 6f64 6527  ig.get('runmode'
+0001ff70: 2920 696e 204f 5054 494d 495a 455f 4d4f  ) in OPTIMIZE_MO
+0001ff80: 4445 530a 2020 2020 2020 2020 2020 2020  DES.            
+0001ff90: 2020 2020 6f72 2073 656c 662e 6578 6368      or self.exch
+0001ffa0: 616e 6765 5f68 6173 2827 6665 7463 684c  ange_has('fetchL
+0001ffb0: 6576 6572 6167 6554 6965 7273 2729 0a20  everageTiers'). 
+0001ffc0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0001ffd0: 7220 7365 6c66 2e65 7863 6861 6e67 655f  r self.exchange_
+0001ffe0: 6861 7328 2766 6574 6368 4d61 726b 6574  has('fetchMarket
+0001fff0: 4c65 7665 7261 6765 5469 6572 7327 2929  LeverageTiers'))
+00020000: 3a0a 0a20 2020 2020 2020 2020 2020 2069  :..            i
+00020010: 6620 7061 6972 206e 6f74 2069 6e20 7365  f pair not in se
+00020020: 6c66 2e5f 6c65 7665 7261 6765 5f74 6965  lf._leverage_tie
+00020030: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+00020040: 2020 2020 7261 6973 6520 496e 7661 6c69      raise Invali
+00020050: 644f 7264 6572 4578 6365 7074 696f 6e28  dOrderException(
+00020060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020070: 2020 2020 2066 224d 6169 6e74 656e 616e       f"Maintenan
+00020080: 6365 206d 6172 6769 6e20 7261 7465 2066  ce margin rate f
+00020090: 6f72 207b 7061 6972 7d20 6973 2075 6e61  or {pair} is una
+000200a0: 7661 696c 6162 6c65 2066 6f72 207b 7365  vailable for {se
+000200b0: 6c66 2e6e 616d 657d 220a 2020 2020 2020  lf.name}".      
+000200c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000200d0: 2020 2020 2020 2020 2070 6169 725f 7469           pair_ti
+000200e0: 6572 7320 3d20 7365 6c66 2e5f 6c65 7665  ers = self._leve
+000200f0: 7261 6765 5f74 6965 7273 5b70 6169 725d  rage_tiers[pair]
+00020100: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00020110: 7220 7469 6572 2069 6e20 7265 7665 7273  r tier in revers
+00020120: 6564 2870 6169 725f 7469 6572 7329 3a0a  ed(pair_tiers):.
+00020130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020140: 6966 206e 6f6d 696e 616c 5f76 616c 7565  if nominal_value
+00020150: 203e 3d20 7469 6572 5b27 6d69 6e4e 6f74   >= tier['minNot
+00020160: 696f 6e61 6c27 5d3a 0a20 2020 2020 2020  ional']:.       
+00020170: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00020180: 7572 6e20 2874 6965 725b 276d 6169 6e74  urn (tier['maint
+00020190: 656e 616e 6365 4d61 7267 696e 5261 7465  enanceMarginRate
+000201a0: 275d 2c20 7469 6572 5b27 6d61 696e 7441  '], tier['maintA
+000201b0: 6d74 275d 290a 0a20 2020 2020 2020 2020  mt'])..         
+000201c0: 2020 2072 6169 7365 2045 7863 6861 6e67     raise Exchang
+000201d0: 6545 7272 6f72 2822 6e6f 6d69 6e61 6c20  eError("nominal 
+000201e0: 7661 6c75 6520 6361 6e20 6e6f 7420 6265  value can not be
+000201f0: 206c 6f77 6572 2074 6861 6e20 3022 290a   lower than 0").
+00020200: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+00020210: 6520 6c6f 7765 7374 206e 6f74 696f 6e61  e lowest notiona
+00020220: 6c5f 666c 6f6f 7220 666f 7220 616e 7920  l_floor for any 
+00020230: 7061 6972 2069 6e20 6665 7463 685f 6c65  pair in fetch_le
+00020240: 7665 7261 6765 5f74 6965 7273 2069 7320  verage_tiers is 
+00020250: 616c 7761 7973 2030 2062 6563 6175 7365  always 0 because
+00020260: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
+00020270: 2320 6465 7363 7269 6265 7320 7468 6520  # describes the 
+00020280: 6d69 6e20 616d 7420 666f 7220 6120 7469  min amt for a ti
+00020290: 6572 2c20 616e 6420 7468 6520 6c6f 7765  er, and the lowe
+000202a0: 7374 2074 6965 7220 7769 6c6c 2061 6c77  st tier will alw
+000202b0: 6179 7320 676f 2064 6f77 6e20 746f 2030  ays go down to 0
+000202c0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000202d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000202e0: 2045 7863 6861 6e67 6545 7272 6f72 2866   ExchangeError(f
+000202f0: 2243 616e 6e6f 7420 6765 7420 6d61 696e  "Cannot get main
+00020300: 7465 6e61 6e63 6520 7261 7469 6f20 7573  tenance ratio us
+00020310: 696e 6720 7b73 656c 662e 6e61 6d65 7d22  ing {self.name}"
+00020320: 290a                                     ).
```

### Comparing `freqtrade-2023.4/freqtrade/exchange/exchange_utils.py` & `freqtrade-2023.5/freqtrade/exchange/exchange_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -7,14 +7,15 @@
 
 import ccxt
 from ccxt import (DECIMAL_PLACES, ROUND, ROUND_DOWN, ROUND_UP, SIGNIFICANT_DIGITS, TICK_SIZE,
                   TRUNCATE, decimal_to_precision)
 
 from freqtrade.exchange.common import BAD_EXCHANGES, EXCHANGE_HAS_OPTIONAL, EXCHANGE_HAS_REQUIRED
 from freqtrade.util import FtPrecise
+from freqtrade.util.datetime_helpers import dt_from_ts, dt_ts
 
 
 CcxtModuleType = Any
 
 
 def is_exchange_known_ccxt(
         exchange_name: str, ccxt_module: Optional[CcxtModuleType] = None) -> bool:
@@ -95,31 +96,29 @@
     :param timeframe: timeframe in string format (e.g. "5m")
     :param date: date to use. Defaults to now(utc)
     :returns: date of previous candle (with utc timezone)
     """
     if not date:
         date = datetime.now(timezone.utc)
 
-    new_timestamp = ccxt.Exchange.round_timeframe(timeframe, date.timestamp() * 1000,
-                                                  ROUND_DOWN) // 1000
-    return datetime.fromtimestamp(new_timestamp, tz=timezone.utc)
+    new_timestamp = ccxt.Exchange.round_timeframe(timeframe, dt_ts(date), ROUND_DOWN) // 1000
+    return dt_from_ts(new_timestamp)
 
 
 def timeframe_to_next_date(timeframe: str, date: Optional[datetime] = None) -> datetime:
     """
     Use Timeframe and determine next candle.
     :param timeframe: timeframe in string format (e.g. "5m")
     :param date: date to use. Defaults to now(utc)
     :returns: date of next candle (with utc timezone)
     """
     if not date:
         date = datetime.now(timezone.utc)
-    new_timestamp = ccxt.Exchange.round_timeframe(timeframe, date.timestamp() * 1000,
-                                                  ROUND_UP) // 1000
-    return datetime.fromtimestamp(new_timestamp, tz=timezone.utc)
+    new_timestamp = ccxt.Exchange.round_timeframe(timeframe, dt_ts(date), ROUND_UP) // 1000
+    return dt_from_ts(new_timestamp)
 
 
 def date_minus_candles(
         timeframe: str, candle_count: int, date: Optional[datetime] = None) -> datetime:
     """
     subtract X candles from a date.
     :param timeframe: timeframe in string format (e.g. "5m")
```

### Comparing `freqtrade-2023.4/freqtrade/exchange/gate.py` & `freqtrade-2023.5/freqtrade/exchange/gate.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/hitbtc.py` & `freqtrade-2023.5/freqtrade/exchange/hitbtc.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/huobi.py` & `freqtrade-2023.5/freqtrade/exchange/huobi.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/kraken.py` & `freqtrade-2023.5/freqtrade/exchange/kraken.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/kucoin.py` & `freqtrade-2023.5/freqtrade/exchange/kucoin.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/exchange/okx.py` & `freqtrade-2023.5/freqtrade/exchange/okx.py`

 * *Files 3% similar despite different names*

```diff
@@ -165,45 +165,50 @@
     def _get_stop_params(self, side: BuySell, ordertype: str, stop_price: float) -> Dict:
         params = super()._get_stop_params(side, ordertype, stop_price)
         if self.trading_mode == TradingMode.FUTURES and self.margin_mode:
             params['tdMode'] = self.margin_mode.value
             params['posSide'] = self._get_posSide(side, True)
         return params
 
+    def _convert_stop_order(self, pair: str, order_id: str, order: Dict) -> Dict:
+        if (
+            order['status'] == 'closed'
+            and (real_order_id := order.get('info', {}).get('ordId')) is not None
+        ):
+            # Once a order triggered, we fetch the regular followup order.
+            order_reg = self.fetch_order(real_order_id, pair)
+            self._log_exchange_response('fetch_stoploss_order1', order_reg)
+            order_reg['id_stop'] = order_reg['id']
+            order_reg['id'] = order_id
+            order_reg['type'] = 'stoploss'
+            order_reg['status_stop'] = 'triggered'
+            return order_reg
+        order['type'] = 'stoploss'
+        return order
+
     def fetch_stoploss_order(self, order_id: str, pair: str, params: Dict = {}) -> Dict:
         if self._config['dry_run']:
             return self.fetch_dry_run_order(order_id)
 
         try:
             params1 = {'stop': True}
             order_reg = self._api.fetch_order(order_id, pair, params=params1)
             self._log_exchange_response('fetch_stoploss_order', order_reg)
-            return order_reg
+            return self._convert_stop_order(pair, order_id, order_reg)
         except ccxt.OrderNotFound:
             pass
         params2 = {'stop': True, 'ordType': 'conditional'}
         for method in (self._api.fetch_open_orders, self._api.fetch_closed_orders,
                        self._api.fetch_canceled_orders):
             try:
                 orders = method(pair, params=params2)
                 orders_f = [order for order in orders if order['id'] == order_id]
                 if orders_f:
                     order = orders_f[0]
-                    if (order['status'] == 'closed'
-                            and (real_order_id := order.get('info', {}).get('ordId')) is not None):
-                        # Once a order triggered, we fetch the regular followup order.
-                        order_reg = self.fetch_order(real_order_id, pair)
-                        self._log_exchange_response('fetch_stoploss_order1', order_reg)
-                        order_reg['id_stop'] = order_reg['id']
-                        order_reg['id'] = order_id
-                        order_reg['type'] = 'stoploss'
-                        order_reg['status_stop'] = 'triggered'
-                        return order_reg
-                    order['type'] = 'stoploss'
-                    return order
+                    return self._convert_stop_order(pair, order_id, order)
             except ccxt.BaseError:
                 pass
         raise RetryableOrderError(
                 f'StoplossOrder not found (pair: {pair} id: {order_id}).')
 
     def get_order_id_conditional(self, order: Dict[str, Any]) -> str:
         if order['type'] == 'stop':
```

### Comparing `freqtrade-2023.4/freqtrade/exchange/types.py` & `freqtrade-2023.5/freqtrade/exchange/types.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/RL/Base3ActionRLEnv.py` & `freqtrade-2023.5/freqtrade/freqai/RL/Base4ActionRLEnv.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,27 +1,28 @@
 import logging
 from enum import Enum
 
-from gym import spaces
+from gymnasium import spaces
 
 from freqtrade.freqai.RL.BaseEnvironment import BaseEnvironment, Positions
 
 
 logger = logging.getLogger(__name__)
 
 
 class Actions(Enum):
     Neutral = 0
-    Buy = 1
-    Sell = 2
+    Exit = 1
+    Long_enter = 2
+    Short_enter = 3
 
 
-class Base3ActionRLEnv(BaseEnvironment):
+class Base4ActionRLEnv(BaseEnvironment):
     """
-    Base class for a 3 action environment
+    Base class for a 4 action environment
     """
     def __init__(self, **kwargs):
         super().__init__(**kwargs)
         self.actions = Actions
 
     def set_action_space(self):
         self.action_space = spaces.Discrete(len(Actions))
@@ -47,27 +48,28 @@
         self._update_unrealized_total_profit()
         step_reward = self.calculate_reward(action)
         self.total_reward += step_reward
         self.tensorboard_log(self.actions._member_names_[action], category="actions")
 
         trade_type = None
         if self.is_tradesignal(action):
-            if action == Actions.Buy.value:
-                if self._position == Positions.Short:
-                    self._update_total_profit()
+
+            if action == Actions.Neutral.value:
+                self._position = Positions.Neutral
+                trade_type = "neutral"
+                self._last_trade_tick = None
+            elif action == Actions.Long_enter.value:
                 self._position = Positions.Long
-                trade_type = "long"
+                trade_type = "enter_long"
                 self._last_trade_tick = self._current_tick
-            elif action == Actions.Sell.value and self.can_short:
-                if self._position == Positions.Long:
-                    self._update_total_profit()
+            elif action == Actions.Short_enter.value:
                 self._position = Positions.Short
-                trade_type = "short"
+                trade_type = "enter_short"
                 self._last_trade_tick = self._current_tick
-            elif action == Actions.Sell.value and not self.can_short:
+            elif action == Actions.Exit.value:
                 self._update_total_profit()
                 self._position = Positions.Neutral
                 trade_type = "exit"
                 self._last_trade_tick = None
             else:
                 print("case not defined")
 
@@ -90,36 +92,44 @@
             position=self._position.value,
             trade_duration=self.get_trade_duration(),
             current_profit_pct=self.get_unrealized_profit()
         )
 
         observation = self._get_observation()
 
+        # user can play with time if they want
+        truncated = False
+
         self._update_history(info)
 
-        return observation, step_reward, self._done, info
+        return observation, step_reward, self._done, truncated, info
 
     def is_tradesignal(self, action: int) -> bool:
         """
         Determine if the signal is a trade signal
-        e.g.: agent wants a Actions.Buy while it is in a Positions.short
+        e.g.: agent wants a Actions.Long_exit while it is in a Positions.short
         """
-        return (
-            (action == Actions.Buy.value and self._position == Positions.Neutral)
-            or (action == Actions.Sell.value and self._position == Positions.Long)
-            or (action == Actions.Sell.value and self._position == Positions.Neutral
-                and self.can_short)
-            or (action == Actions.Buy.value and self._position == Positions.Short
-                and self.can_short)
-        )
+        return not ((action == Actions.Neutral.value and self._position == Positions.Neutral) or
+                    (action == Actions.Neutral.value and self._position == Positions.Short) or
+                    (action == Actions.Neutral.value and self._position == Positions.Long) or
+                    (action == Actions.Short_enter.value and self._position == Positions.Short) or
+                    (action == Actions.Short_enter.value and self._position == Positions.Long) or
+                    (action == Actions.Exit.value and self._position == Positions.Neutral) or
+                    (action == Actions.Long_enter.value and self._position == Positions.Long) or
+                    (action == Actions.Long_enter.value and self._position == Positions.Short))
 
     def _is_valid(self, action: int) -> bool:
         """
         Determine if the signal is valid.
-        e.g.: agent wants a Actions.Sell while it is in a Positions.Long
+        e.g.: agent wants a Actions.Long_exit while it is in a Positions.short
         """
-        if self.can_short:
-            return action in [Actions.Buy.value, Actions.Sell.value, Actions.Neutral.value]
-        else:
-            if action == Actions.Sell.value and self._position != Positions.Long:
+        # Agent should only try to exit if it is in position
+        if action == Actions.Exit.value:
+            if self._position not in (Positions.Short, Positions.Long):
+                return False
+
+        # Agent should only try to enter if it is not in position
+        if action in (Actions.Short_enter.value, Actions.Long_enter.value):
+            if self._position != Positions.Neutral:
                 return False
-            return True
+
+        return True
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/RL/Base4ActionRLEnv.py` & `freqtrade-2023.5/freqtrade/freqai/RL/Base3ActionRLEnv.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,28 +1,27 @@
 import logging
 from enum import Enum
 
-from gym import spaces
+from gymnasium import spaces
 
 from freqtrade.freqai.RL.BaseEnvironment import BaseEnvironment, Positions
 
 
 logger = logging.getLogger(__name__)
 
 
 class Actions(Enum):
     Neutral = 0
-    Exit = 1
-    Long_enter = 2
-    Short_enter = 3
+    Buy = 1
+    Sell = 2
 
 
-class Base4ActionRLEnv(BaseEnvironment):
+class Base3ActionRLEnv(BaseEnvironment):
     """
-    Base class for a 4 action environment
+    Base class for a 3 action environment
     """
     def __init__(self, **kwargs):
         super().__init__(**kwargs)
         self.actions = Actions
 
     def set_action_space(self):
         self.action_space = spaces.Discrete(len(Actions))
@@ -48,28 +47,27 @@
         self._update_unrealized_total_profit()
         step_reward = self.calculate_reward(action)
         self.total_reward += step_reward
         self.tensorboard_log(self.actions._member_names_[action], category="actions")
 
         trade_type = None
         if self.is_tradesignal(action):
-
-            if action == Actions.Neutral.value:
-                self._position = Positions.Neutral
-                trade_type = "neutral"
-                self._last_trade_tick = None
-            elif action == Actions.Long_enter.value:
+            if action == Actions.Buy.value:
+                if self._position == Positions.Short:
+                    self._update_total_profit()
                 self._position = Positions.Long
-                trade_type = "enter_long"
+                trade_type = "long"
                 self._last_trade_tick = self._current_tick
-            elif action == Actions.Short_enter.value:
+            elif action == Actions.Sell.value and self.can_short:
+                if self._position == Positions.Long:
+                    self._update_total_profit()
                 self._position = Positions.Short
-                trade_type = "enter_short"
+                trade_type = "short"
                 self._last_trade_tick = self._current_tick
-            elif action == Actions.Exit.value:
+            elif action == Actions.Sell.value and not self.can_short:
                 self._update_total_profit()
                 self._position = Positions.Neutral
                 trade_type = "exit"
                 self._last_trade_tick = None
             else:
                 print("case not defined")
 
@@ -92,41 +90,39 @@
             position=self._position.value,
             trade_duration=self.get_trade_duration(),
             current_profit_pct=self.get_unrealized_profit()
         )
 
         observation = self._get_observation()
 
+        # user can play with time if they want
+        truncated = False
+
         self._update_history(info)
 
-        return observation, step_reward, self._done, info
+        return observation, step_reward, self._done, truncated, info
 
     def is_tradesignal(self, action: int) -> bool:
         """
         Determine if the signal is a trade signal
-        e.g.: agent wants a Actions.Long_exit while it is in a Positions.short
+        e.g.: agent wants a Actions.Buy while it is in a Positions.short
         """
-        return not ((action == Actions.Neutral.value and self._position == Positions.Neutral) or
-                    (action == Actions.Neutral.value and self._position == Positions.Short) or
-                    (action == Actions.Neutral.value and self._position == Positions.Long) or
-                    (action == Actions.Short_enter.value and self._position == Positions.Short) or
-                    (action == Actions.Short_enter.value and self._position == Positions.Long) or
-                    (action == Actions.Exit.value and self._position == Positions.Neutral) or
-                    (action == Actions.Long_enter.value and self._position == Positions.Long) or
-                    (action == Actions.Long_enter.value and self._position == Positions.Short))
+        return (
+            (action == Actions.Buy.value and self._position == Positions.Neutral)
+            or (action == Actions.Sell.value and self._position == Positions.Long)
+            or (action == Actions.Sell.value and self._position == Positions.Neutral
+                and self.can_short)
+            or (action == Actions.Buy.value and self._position == Positions.Short
+                and self.can_short)
+        )
 
     def _is_valid(self, action: int) -> bool:
         """
         Determine if the signal is valid.
-        e.g.: agent wants a Actions.Long_exit while it is in a Positions.short
+        e.g.: agent wants a Actions.Sell while it is in a Positions.Long
         """
-        # Agent should only try to exit if it is in position
-        if action == Actions.Exit.value:
-            if self._position not in (Positions.Short, Positions.Long):
-                return False
-
-        # Agent should only try to enter if it is not in position
-        if action in (Actions.Short_enter.value, Actions.Long_enter.value):
-            if self._position != Positions.Neutral:
+        if self.can_short:
+            return action in [Actions.Buy.value, Actions.Sell.value, Actions.Neutral.value]
+        else:
+            if action == Actions.Sell.value and self._position != Positions.Long:
                 return False
-
-        return True
+            return True
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/RL/Base5ActionRLEnv.py` & `freqtrade-2023.5/freqtrade/freqai/RL/Base5ActionRLEnv.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 import logging
 from enum import Enum
 
-from gym import spaces
+from gymnasium import spaces
 
 from freqtrade.freqai.RL.BaseEnvironment import BaseEnvironment, Positions
 
 
 logger = logging.getLogger(__name__)
 
 
@@ -97,18 +97,20 @@
             total_profit=self._total_profit,
             position=self._position.value,
             trade_duration=self.get_trade_duration(),
             current_profit_pct=self.get_unrealized_profit()
         )
 
         observation = self._get_observation()
+        # user can play with time if they want
+        truncated = False
 
         self._update_history(info)
 
-        return observation, step_reward, self._done, info
+        return observation, step_reward, self._done, truncated, info
 
     def is_tradesignal(self, action: int) -> bool:
         """
         Determine if the signal is a trade signal
         e.g.: agent wants a Actions.Long_exit while it is in a Positions.short
         """
         return not ((action == Actions.Neutral.value and self._position == Positions.Neutral) or
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/RL/BaseEnvironment.py` & `freqtrade-2023.5/freqtrade/freqai/RL/BaseEnvironment.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,18 +1,18 @@
 import logging
 import random
 from abc import abstractmethod
 from enum import Enum
 from typing import Optional, Type, Union
 
-import gym
+import gymnasium as gym
 import numpy as np
 import pandas as pd
-from gym import spaces
-from gym.utils import seeding
+from gymnasium import spaces
+from gymnasium.utils import seeding
 from pandas import DataFrame
 
 
 logger = logging.getLogger(__name__)
 
 
 class BaseActions(Enum):
@@ -123,14 +123,22 @@
         self._position_history: list = [None]
         self.total_reward: float = 0
         self._total_profit: float = 1
         self._total_unrealized_profit: float = 1
         self.history: dict = {}
         self.trade_history: list = []
 
+    def get_attr(self, attr: str):
+        """
+        Returns the attribute of the environment
+        :param attr: attribute to return
+        :return: attribute
+        """
+        return getattr(self, attr)
+
     @abstractmethod
     def set_action_space(self):
         """
         Unique to the environment action count. Must be inherited.
         """
 
     def seed(self, seed: int = 1):
@@ -168,15 +176,15 @@
             self.tensorboard_metrics[category][metric] = value
         else:
             self.tensorboard_metrics[category][metric] += value
 
     def reset_tensorboard_log(self):
         self.tensorboard_metrics = {}
 
-    def reset(self):
+    def reset(self, seed=None):
         """
         Reset is called at the beginning of every episode
         """
         self.reset_tensorboard_log()
 
         self._done = False
 
@@ -199,15 +207,15 @@
         self.trade_history = []
         self.portfolio_log_returns = np.zeros(len(self.prices))
 
         self._profits = [(self._start_tick, 1)]
         self.close_trade_profit = []
         self._total_unrealized_profit = 1
 
-        return self._get_observation()
+        return self._get_observation(), self.history
 
     @abstractmethod
     def step(self, action: int):
         """
         Step depeneds on action types, this must be inherited.
         """
         return
@@ -294,14 +302,20 @@
             self.history[key].append(value)
 
     @abstractmethod
     def calculate_reward(self, action: int) -> float:
         """
         An example reward function. This is the one function that users will likely
         wish to inject their own creativity into.
+
+        Warning!
+        This is function is a showcase of functionality designed to show as many possible
+        environment control features as possible. It is also designed to run quickly
+        on small computers. This is a benchmark, it is *not* for live production.
+
         :param action: int = The action made by the agent for the current candle.
         :return:
         float = the reward to give to the agent for current step (used for optimization
             of weights in NN)
         """
 
     def _update_unrealized_total_profit(self):
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/RL/BaseReinforcementLearningModel.py` & `freqtrade-2023.5/freqtrade/freqai/RL/BaseReinforcementLearningModel.py`

 * *Files 1% similar despite different names*

```diff
@@ -2,32 +2,32 @@
 import importlib
 import logging
 from abc import abstractmethod
 from datetime import datetime, timezone
 from pathlib import Path
 from typing import Any, Callable, Dict, Optional, Tuple, Type, Union
 
-import gym
+import gymnasium as gym
 import numpy as np
 import numpy.typing as npt
 import pandas as pd
 import torch as th
 import torch.multiprocessing
 from pandas import DataFrame
 from stable_baselines3.common.callbacks import EvalCallback
 from stable_baselines3.common.monitor import Monitor
 from stable_baselines3.common.utils import set_random_seed
-from stable_baselines3.common.vec_env import SubprocVecEnv
+from stable_baselines3.common.vec_env import SubprocVecEnv, VecMonitor
 
 from freqtrade.exceptions import OperationalException
 from freqtrade.freqai.data_kitchen import FreqaiDataKitchen
 from freqtrade.freqai.freqai_interface import IFreqaiModel
 from freqtrade.freqai.RL.Base5ActionRLEnv import Actions, Base5ActionRLEnv
-from freqtrade.freqai.RL.BaseEnvironment import BaseActions, Positions
-from freqtrade.freqai.RL.TensorboardCallback import TensorboardCallback
+from freqtrade.freqai.RL.BaseEnvironment import BaseActions, BaseEnvironment, Positions
+from freqtrade.freqai.tensorboard.TensorboardCallback import TensorboardCallback
 from freqtrade.persistence import Trade
 
 
 logger = logging.getLogger(__name__)
 
 torch.multiprocessing.set_sharing_strategy('file_system')
 
@@ -42,16 +42,16 @@
 
     def __init__(self, **kwargs) -> None:
         super().__init__(config=kwargs['config'])
         self.max_threads = min(self.freqai_info['rl_config'].get(
             'cpu_count', 1), max(int(self.max_system_threads / 2), 1))
         th.set_num_threads(self.max_threads)
         self.reward_params = self.freqai_info['rl_config']['model_reward_parameters']
-        self.train_env: Union[SubprocVecEnv, Type[gym.Env]] = gym.Env()
-        self.eval_env: Union[SubprocVecEnv, Type[gym.Env]] = gym.Env()
+        self.train_env: Union[VecMonitor, SubprocVecEnv, gym.Env] = gym.Env()
+        self.eval_env: Union[VecMonitor, SubprocVecEnv, gym.Env] = gym.Env()
         self.eval_callback: Optional[EvalCallback] = None
         self.model_type = self.freqai_info['rl_config']['model_type']
         self.rl_config = self.freqai_info['rl_config']
         self.df_raw: DataFrame = DataFrame()
         self.continual_learning = self.freqai_info.get('continual_learning', False)
         if self.model_type in SB3_MODELS:
             import_str = 'stable_baselines3'
@@ -367,14 +367,20 @@
         sets a custom reward based on profit and trade duration.
         """
 
         def calculate_reward(self, action: int) -> float:  # noqa: C901
             """
             An example reward function. This is the one function that users will likely
             wish to inject their own creativity into.
+
+            Warning!
+            This is function is a showcase of functionality designed to show as many possible
+            environment control features as possible. It is also designed to run quickly
+            on small computers. This is a benchmark, it is *not* for live production.
+
             :param action: int = The action made by the agent for the current candle.
             :return:
             float = the reward to give to the agent for current step (used for optimization
                 of weights in NN)
             """
             # first, penalize if the action is not valid
             if not self._is_valid(action):
@@ -427,17 +433,16 @@
                 if pnl > self.profit_aim * self.rr:
                     factor *= self.rl_config['model_reward_parameters'].get('win_reward_factor', 2)
                 return float(pnl * factor)
 
             return 0.
 
 
-def make_env(MyRLEnv: Type[gym.Env], env_id: str, rank: int,
+def make_env(MyRLEnv: Type[BaseEnvironment], env_id: str, rank: int,
              seed: int, train_df: DataFrame, price: DataFrame,
-             monitor: bool = False,
              env_info: Dict[str, Any] = {}) -> Callable:
     """
     Utility function for multiprocessed env.
 
     :param env_id: (str) the environment ID
     :param num_env: (int) the number of environment you wish to have in subprocesses
     :param seed: (int) the inital seed for RNG
@@ -446,12 +451,11 @@
     :return: (Callable)
     """
 
     def _init() -> gym.Env:
 
         env = MyRLEnv(df=train_df, prices=price, id=env_id, seed=seed + rank,
                       **env_info)
-        if monitor:
-            env = Monitor(env)
+
         return env
     set_random_seed(seed)
     return _init
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/RL/TensorboardCallback.py` & `freqtrade-2023.5/freqtrade/freqai/tensorboard/TensorboardCallback.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,26 +1,29 @@
 from enum import Enum
 from typing import Any, Dict, Type, Union
 
 from stable_baselines3.common.callbacks import BaseCallback
 from stable_baselines3.common.logger import HParam
+from stable_baselines3.common.vec_env import VecEnv
 
-from freqtrade.freqai.RL.BaseEnvironment import BaseActions, BaseEnvironment
+from freqtrade.freqai.RL.BaseEnvironment import BaseActions
 
 
 class TensorboardCallback(BaseCallback):
     """
     Custom callback for plotting additional values in tensorboard and
     episodic summary reports.
     """
+    # Override training_env type to fix type errors
+    training_env: Union[VecEnv, None] = None
+
     def __init__(self, verbose=1, actions: Type[Enum] = BaseActions):
         super().__init__(verbose)
         self.model: Any = None
-        self.logger = None  # type: Any
-        self.training_env: BaseEnvironment = None  # type: ignore
+        self.logger: Any = None
         self.actions: Type[Enum] = actions
 
     def _on_training_start(self) -> None:
         hparam_dict = {
             "algorithm": self.model.__class__.__name__,
             "learning_rate": self.model.learning_rate,
             # "gamma": self.model.gamma,
@@ -40,14 +43,16 @@
             HParam(hparam_dict, metric_dict),
             exclude=("stdout", "log", "json", "csv"),
         )
 
     def _on_step(self) -> bool:
 
         local_info = self.locals["infos"][0]
+        if self.training_env is None:
+            return True
         tensorboard_metrics = self.training_env.get_attr("tensorboard_metrics")[0]
 
         for metric in local_info:
             if metric not in ["episode", "terminal_observation"]:
                 self.logger.record(f"info/{metric}", local_info[metric])
 
         for category in tensorboard_metrics:
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/base_models/BaseClassifierModel.py` & `freqtrade-2023.5/freqtrade/freqai/base_models/BaseClassifierModel.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/base_models/BasePyTorchClassifier.py` & `freqtrade-2023.5/freqtrade/freqai/base_models/BasePyTorchClassifier.py`

 * *Files 4% similar despite different names*

```diff
@@ -41,14 +41,15 @@
         self.index_to_class_name = None
 
     def predict(
         self, unfiltered_df: DataFrame, dk: FreqaiDataKitchen, **kwargs
     ) -> Tuple[DataFrame, npt.NDArray[np.int_]]:
         """
         Filter the prediction features data and predict with it.
+        :param dk: dk: The datakitchen object
         :param unfiltered_df: Full dataframe for the current backtest period.
         :return:
         :pred_df: dataframe containing the predictions
         :do_predict: np.array of 1s and 0s to indicate places where freqai needed to remove
         data (NaNs) or felt uncertain about data (PCA and DI index)
         :raises ValueError: if 'class_names' doesn't exist in model meta_data.
         """
@@ -70,19 +71,22 @@
         filtered_df = dk.normalize_data_from_metadata(filtered_df)
         dk.data_dictionary["prediction_features"] = filtered_df
         self.data_cleaning_predict(dk)
         x = self.data_convertor.convert_x(
             dk.data_dictionary["prediction_features"],
             device=self.device
         )
+        self.model.model.eval()
         logits = self.model.model(x)
         probs = F.softmax(logits, dim=-1)
         predicted_classes = torch.argmax(probs, dim=-1)
         predicted_classes_str = self.decode_class_names(predicted_classes)
-        pred_df_prob = DataFrame(probs.detach().numpy(), columns=class_names)
+        # used .tolist to convert probs into an iterable, in this way Tensors
+        # are automatically moved to the CPU first if necessary.
+        pred_df_prob = DataFrame(probs.detach().tolist(), columns=class_names)
         pred_df = DataFrame(predicted_classes_str, columns=[dk.label_list[0]])
         pred_df = pd.concat([pred_df, pred_df_prob], axis=1)
         return (pred_df, dk.do_predict)
 
     def encode_class_names(
             self,
             data_dictionary: Dict[str, pd.DataFrame],
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/base_models/BasePyTorchModel.py` & `freqtrade-2023.5/freqtrade/freqai/base_models/BasePyTorchModel.py`

 * *Files 8% similar despite different names*

```diff
@@ -23,14 +23,15 @@
 
     def __init__(self, **kwargs):
         super().__init__(config=kwargs["config"])
         self.dd.model_type = "pytorch"
         self.device = "cuda" if torch.cuda.is_available() else "cpu"
         test_size = self.freqai_info.get('data_split_parameters', {}).get('test_size')
         self.splits = ["train", "test"] if test_size != 0 else ["train"]
+        self.window_size = self.freqai_info.get("conv_width", 1)
 
     def train(
         self, unfiltered_df: DataFrame, pair: str, dk: FreqaiDataKitchen, **kwargs
     ) -> Any:
         """
         Filter the training data and train a model to it. Train makes heavy use of the datakitchen
         for storing, saving, loading, and analyzing the data.
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/base_models/BasePyTorchRegressor.py` & `freqtrade-2023.5/freqtrade/freqai/base_models/BasePyTorchRegressor.py`

 * *Files 8% similar despite different names*

```diff
@@ -40,11 +40,12 @@
         dk.data_dictionary["prediction_features"] = filtered_df
 
         self.data_cleaning_predict(dk)
         x = self.data_convertor.convert_x(
             dk.data_dictionary["prediction_features"],
             device=self.device
         )
+        self.model.model.eval()
         y = self.model.model(x)
-        y = y.cpu()
-        pred_df = DataFrame(y.detach().numpy(), columns=[dk.label_list[0]])
+        pred_df = DataFrame(y.detach().tolist(), columns=[dk.label_list[0]])
+        pred_df = dk.denormalize_labels_from_metadata(pred_df)
         return (pred_df, dk.do_predict)
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/base_models/BaseRegressionModel.py` & `freqtrade-2023.5/freqtrade/freqai/base_models/BaseRegressionModel.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/base_models/BaseTensorFlowModel.py` & `freqtrade-2023.5/freqtrade/freqai/base_models/BaseTensorFlowModel.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/base_models/FreqaiMultiOutputClassifier.py` & `freqtrade-2023.5/freqtrade/freqai/base_models/FreqaiMultiOutputClassifier.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/base_models/FreqaiMultiOutputRegressor.py` & `freqtrade-2023.5/freqtrade/freqai/base_models/FreqaiMultiOutputRegressor.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/data_drawer.py` & `freqtrade-2023.5/freqtrade/freqai/data_drawer.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/data_kitchen.py` & `freqtrade-2023.5/freqtrade/freqai/data_kitchen.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/freqai_interface.py` & `freqtrade-2023.5/freqtrade/freqai/freqai_interface.py`

 * *Files 2% similar despite different names*

```diff
@@ -17,15 +17,15 @@
 from freqtrade.constants import Config
 from freqtrade.data.dataprovider import DataProvider
 from freqtrade.enums import RunMode
 from freqtrade.exceptions import OperationalException
 from freqtrade.exchange import timeframe_to_seconds
 from freqtrade.freqai.data_drawer import FreqaiDataDrawer
 from freqtrade.freqai.data_kitchen import FreqaiDataKitchen
-from freqtrade.freqai.utils import plot_feature_importance, record_params
+from freqtrade.freqai.utils import get_tb_logger, plot_feature_importance, record_params
 from freqtrade.strategy.interface import IStrategy
 
 
 pd.options.mode.chained_assignment = None
 logger = logging.getLogger(__name__)
 
 
@@ -76,14 +76,15 @@
         self.scanning = False
         self.ft_params = self.freqai_info["feature_parameters"]
         self.corr_pairlist: List[str] = self.ft_params.get("include_corr_pairlist", [])
         self.keras: bool = self.freqai_info.get("keras", False)
         if self.keras and self.ft_params.get("DI_threshold", 0):
             self.ft_params["DI_threshold"] = 0
             logger.warning("DI threshold is not configured for Keras models yet. Deactivating.")
+
         self.CONV_WIDTH = self.freqai_info.get('conv_width', 1)
         if self.ft_params.get("inlier_metric_window", 0):
             self.CONV_WIDTH = self.ft_params.get("inlier_metric_window", 0) * 2
         self.class_names: List[str] = []  # used in classification subclasses
         self.pair_it = 0
         self.pair_it_train = 0
         self.total_pairs = len(self.config.get("exchange", {}).get("pair_whitelist"))
@@ -105,14 +106,15 @@
         self.data_provider: Optional[DataProvider] = None
         self.max_system_threads = max(int(psutil.cpu_count() * 2 - 2), 1)
         self.can_short = True  # overridden in start() with strategy.can_short
         self.model: Any = None
         if self.ft_params.get('principal_component_analysis', False) and self.continual_learning:
             self.ft_params.update({'principal_component_analysis': False})
             logger.warning('User tried to use PCA with continual learning. Deactivating PCA.')
+        self.activate_tensorboard: bool = self.freqai_info.get('activate_tensorboard', True)
 
         record_params(config, self.full_path)
 
     def __getstate__(self):
         """
         Return an empty state to be pickled in hyperopt
         """
@@ -238,16 +240,16 @@
                 self.train_timer('start')
                 dk.set_paths(pair, new_trained_timerange.stopts)
                 try:
                     self.extract_data_and_train_model(
                         new_trained_timerange, pair, strategy, dk, data_load_timerange
                     )
                 except Exception as msg:
-                    logger.warning(f"Training {pair} raised exception {msg.__class__.__name__}. "
-                                   f"Message: {msg}, skipping.")
+                    logger.exception(f"Training {pair} raised exception {msg.__class__.__name__}. "
+                                     f"Message: {msg}, skipping.")
 
                 self.train_timer('stop', pair)
 
                 # only rotate the queue after the first has been trained.
                 self.train_queue.rotate(-1)
 
                 self.dd.save_historic_predictions_to_disk()
@@ -302,18 +304,19 @@
             dk.set_paths(pair, timestamp_model_id)
 
             dk.set_new_model_names(pair, timestamp_model_id)
 
             if dk.check_if_backtest_prediction_is_valid(len_backtest_df):
                 if check_features:
                     self.dd.load_metadata(dk)
-                    dataframe_dummy_features = self.dk.use_strategy_to_populate_indicators(
+                    df_fts = self.dk.use_strategy_to_populate_indicators(
                         strategy, prediction_dataframe=dataframe.tail(1), pair=pair
                     )
-                    dk.find_features(dataframe_dummy_features)
+                    df_fts = dk.remove_special_chars_from_feature_names(df_fts)
+                    dk.find_features(df_fts)
                     self.check_if_feature_list_matches_strategy(dk)
                     check_features = False
                 append_df = dk.get_backtesting_prediction()
                 dk.append_predictions(append_df)
             else:
                 if populate_indicators:
                     dataframe = self.dk.use_strategy_to_populate_indicators(
@@ -338,15 +341,18 @@
                 dk.get_unique_classes_from_labels(dataframe_train)
 
                 if not self.model_exists(dk):
                     dk.find_features(dataframe_train)
                     dk.find_labels(dataframe_train)
 
                     try:
+                        self.tb_logger = get_tb_logger(self.dd.model_type, dk.data_path,
+                                                       self.activate_tensorboard)
                         self.model = self.train(dataframe_train, pair, dk)
+                        self.tb_logger.close()
                     except Exception as msg:
                         logger.warning(
                             f"Training {pair} raised exception {msg.__class__.__name__}. "
                             f"Message: {msg}, skipping.", exc_info=True)
                         self.model = None
 
                     self.dd.pair_dict[pair]["trained_timestamp"] = int(
@@ -485,17 +491,17 @@
             feature_list = dk.data["training_features_list_raw"]
         else:
             feature_list = dk.data['training_features_list']
 
         if dk.training_features_list != feature_list:
             raise OperationalException(
                 "Trying to access pretrained model with `identifier` "
-                "but found different features furnished by current strategy."
-                "Change `identifier` to train from scratch, or ensure the"
-                "strategy is furnishing the same features as the pretrained"
+                "but found different features furnished by current strategy. "
+                "Change `identifier` to train from scratch, or ensure the "
+                "strategy is furnishing the same features as the pretrained "
                 "model. In case of --strategy-list, please be aware that FreqAI "
                 "requires all strategies to maintain identical "
                 "feature_engineering_* functions"
             )
 
     def data_cleaning_train(self, dk: FreqaiDataKitchen) -> None:
         """
@@ -616,26 +622,31 @@
             data_load_timerange, pair, dk
         )
 
         unfiltered_dataframe = dk.use_strategy_to_populate_indicators(
             strategy, corr_dataframes, base_dataframes, pair
         )
 
-        new_trained_timerange = dk.buffer_timerange(new_trained_timerange)
+        trained_timestamp = new_trained_timerange.stopts
+
+        buffered_timerange = dk.buffer_timerange(new_trained_timerange)
 
-        unfiltered_dataframe = dk.slice_dataframe(new_trained_timerange, unfiltered_dataframe)
+        unfiltered_dataframe = dk.slice_dataframe(buffered_timerange, unfiltered_dataframe)
 
         # find the features indicated by strategy and store in datakitchen
         dk.find_features(unfiltered_dataframe)
         dk.find_labels(unfiltered_dataframe)
 
+        self.tb_logger = get_tb_logger(self.dd.model_type, dk.data_path,
+                                       self.activate_tensorboard)
         model = self.train(unfiltered_dataframe, pair, dk)
+        self.tb_logger.close()
 
-        self.dd.pair_dict[pair]["trained_timestamp"] = new_trained_timerange.stopts
-        dk.set_new_model_names(pair, new_trained_timerange.stopts)
+        self.dd.pair_dict[pair]["trained_timestamp"] = trained_timestamp
+        dk.set_new_model_names(pair, trained_timestamp)
         self.dd.save_data(model, pair, dk)
 
         if self.plot_features:
             plot_feature_importance(model, pair, dk, self.plot_features)
 
         self.dd.purge_old_models()
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/CatboostClassifier.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/CatboostClassifier.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/CatboostClassifierMultiTarget.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/CatboostClassifierMultiTarget.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/CatboostRegressor.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/CatboostRegressor.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/CatboostRegressorMultiTarget.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/CatboostRegressorMultiTarget.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/LightGBMClassifier.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/LightGBMClassifier.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/LightGBMClassifierMultiTarget.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/LightGBMClassifierMultiTarget.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/LightGBMRegressor.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/LightGBMRegressor.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/LightGBMRegressorMultiTarget.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/LightGBMRegressorMultiTarget.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/PyTorchMLPClassifier.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/PyTorchMLPClassifier.py`

 * *Files 8% similar despite different names*

```diff
@@ -70,20 +70,22 @@
             input_dim=n_features,
             output_dim=len(class_names),
             **self.model_kwargs
         )
         model.to(self.device)
         optimizer = torch.optim.AdamW(model.parameters(), lr=self.learning_rate)
         criterion = torch.nn.CrossEntropyLoss()
-        init_model = self.get_init_model(dk.pair)
-        trainer = PyTorchModelTrainer(
-            model=model,
-            optimizer=optimizer,
-            criterion=criterion,
-            model_meta_data={"class_names": class_names},
-            device=self.device,
-            init_model=init_model,
-            data_convertor=self.data_convertor,
-            **self.trainer_kwargs,
-        )
+        # check if continual_learning is activated, and retreive the model to continue training
+        trainer = self.get_init_model(dk.pair)
+        if trainer is None:
+            trainer = PyTorchModelTrainer(
+                model=model,
+                optimizer=optimizer,
+                criterion=criterion,
+                model_meta_data={"class_names": class_names},
+                device=self.device,
+                data_convertor=self.data_convertor,
+                tb_logger=self.tb_logger,
+                **self.trainer_kwargs,
+            )
         trainer.fit(data_dictionary, self.splits)
         return trainer
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/PyTorchMLPRegressor.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/PyTorchMLPRegressor.py`

 * *Files 6% similar despite different names*

```diff
@@ -65,19 +65,21 @@
             input_dim=n_features,
             output_dim=1,
             **self.model_kwargs
         )
         model.to(self.device)
         optimizer = torch.optim.AdamW(model.parameters(), lr=self.learning_rate)
         criterion = torch.nn.MSELoss()
-        init_model = self.get_init_model(dk.pair)
-        trainer = PyTorchModelTrainer(
-            model=model,
-            optimizer=optimizer,
-            criterion=criterion,
-            device=self.device,
-            init_model=init_model,
-            data_convertor=self.data_convertor,
-            **self.trainer_kwargs,
-        )
+        # check if continual_learning is activated, and retreive the model to continue training
+        trainer = self.get_init_model(dk.pair)
+        if trainer is None:
+            trainer = PyTorchModelTrainer(
+                model=model,
+                optimizer=optimizer,
+                criterion=criterion,
+                device=self.device,
+                data_convertor=self.data_convertor,
+                tb_logger=self.tb_logger,
+                **self.trainer_kwargs,
+            )
         trainer.fit(data_dictionary, self.splits)
         return trainer
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/ReinforcementLearner.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/ReinforcementLearner.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 import logging
 from pathlib import Path
-from typing import Any, Dict
+from typing import Any, Dict, Type
 
 import torch as th
 
 from freqtrade.freqai.data_kitchen import FreqaiDataKitchen
 from freqtrade.freqai.RL.Base5ActionRLEnv import Actions, Base5ActionRLEnv, Positions
+from freqtrade.freqai.RL.BaseEnvironment import BaseEnvironment
 from freqtrade.freqai.RL.BaseReinforcementLearningModel import BaseReinforcementLearningModel
 
 
 logger = logging.getLogger(__name__)
 
 
 class ReinforcementLearner(BaseReinforcementLearningModel):
@@ -53,18 +54,22 @@
         """
         train_df = data_dictionary["train_features"]
         total_timesteps = self.freqai_info["rl_config"]["train_cycles"] * len(train_df)
 
         policy_kwargs = dict(activation_fn=th.nn.ReLU,
                              net_arch=self.net_arch)
 
+        if self.activate_tensorboard:
+            tb_path = Path(dk.full_path / "tensorboard" / dk.pair.split('/')[0])
+        else:
+            tb_path = None
+
         if dk.pair not in self.dd.model_dictionary or not self.continual_learning:
             model = self.MODELCLASS(self.policy_type, self.train_env, policy_kwargs=policy_kwargs,
-                                    tensorboard_log=Path(
-                                        dk.full_path / "tensorboard" / dk.pair.split('/')[0]),
+                                    tensorboard_log=tb_path,
                                     **self.freqai_info.get('model_training_parameters', {})
                                     )
         else:
             logger.info('Continual training activated - starting training from previously '
                         'trained agent.')
             model = self.dd.model_dictionary[dk.pair]
             model.set_env(self.train_env)
@@ -80,24 +85,32 @@
             best_model = self.MODELCLASS.load(dk.data_path / "best_model")
             return best_model
 
         logger.info('Couldnt find best model, using final model instead.')
 
         return model
 
-    class MyRLEnv(Base5ActionRLEnv):
+    MyRLEnv: Type[BaseEnvironment]
+
+    class MyRLEnv(Base5ActionRLEnv):  # type: ignore[no-redef]
         """
         User can override any function in BaseRLEnv and gym.Env. Here the user
         sets a custom reward based on profit and trade duration.
         """
 
         def calculate_reward(self, action: int) -> float:
             """
             An example reward function. This is the one function that users will likely
             wish to inject their own creativity into.
+
+                        Warning!
+            This is function is a showcase of functionality designed to show as many possible
+            environment control features as possible. It is also designed to run quickly
+            on small computers. This is a benchmark, it is *not* for live production.
+
             :param action: int = The action made by the agent for the current candle.
             :return:
             float = the reward to give to the agent for current step (used for optimization
                 of weights in NN)
             """
             # first, penalize if the action is not valid
             if not self._is_valid(action):
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/ReinforcementLearner_multiproc.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/ReinforcementLearner_multiproc.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,18 +1,18 @@
 import logging
 from typing import Any, Dict
 
 from pandas import DataFrame
 from stable_baselines3.common.callbacks import EvalCallback
-from stable_baselines3.common.vec_env import SubprocVecEnv
+from stable_baselines3.common.vec_env import SubprocVecEnv, VecMonitor
 
 from freqtrade.freqai.data_kitchen import FreqaiDataKitchen
 from freqtrade.freqai.prediction_models.ReinforcementLearner import ReinforcementLearner
 from freqtrade.freqai.RL.BaseReinforcementLearningModel import make_env
-from freqtrade.freqai.RL.TensorboardCallback import TensorboardCallback
+from freqtrade.freqai.tensorboard.TensorboardCallback import TensorboardCallback
 
 
 logger = logging.getLogger(__name__)
 
 
 class ReinforcementLearner_multiproc(ReinforcementLearner):
     """
@@ -37,26 +37,29 @@
         if self.train_env:
             self.train_env.close()
         if self.eval_env:
             self.eval_env.close()
 
         env_info = self.pack_env_dict(dk.pair)
 
+        eval_freq = len(train_df) // self.max_threads
+
         env_id = "train_env"
-        self.train_env = SubprocVecEnv([make_env(self.MyRLEnv, env_id, i, 1,
-                                        train_df, prices_train,
-                                        monitor=True,
-                                        env_info=env_info) for i
-                                        in range(self.max_threads)])
+        self.train_env = VecMonitor(SubprocVecEnv([make_env(self.MyRLEnv, env_id, i, 1,
+                                                            train_df, prices_train,
+                                                            env_info=env_info) for i
+                                                   in range(self.max_threads)]))
 
         eval_env_id = 'eval_env'
-        self.eval_env = SubprocVecEnv([make_env(self.MyRLEnv, eval_env_id, i, 1,
-                                                test_df, prices_test,
-                                                monitor=True,
-                                                env_info=env_info) for i
-                                       in range(self.max_threads)])
+        self.eval_env = VecMonitor(SubprocVecEnv([make_env(self.MyRLEnv, eval_env_id, i, 1,
+                                                           test_df, prices_test,
+                                                           env_info=env_info) for i
+                                                  in range(self.max_threads)]))
+
         self.eval_callback = EvalCallback(self.eval_env, deterministic=True,
-                                          render=False, eval_freq=len(train_df),
+                                          render=False, eval_freq=eval_freq,
                                           best_model_save_path=str(dk.data_path))
 
+        # TENSORBOARD CALLBACK DOES NOT RECOMMENDED TO USE WITH MULTIPLE ENVS,
+        # IT WILL RETURN FALSE INFORMATIONS, NEVERTHLESS NOT THREAD SAFE WITH SB3!!!
         actions = self.train_env.env_method("get_actions")[0]
         self.tensorboard_callback = TensorboardCallback(verbose=1, actions=actions)
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/XGBoostClassifier.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/XGBoostClassifier.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/XGBoostRFClassifier.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/XGBoostRFClassifier.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/XGBoostRFRegressor.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/XGBoostRFRegressor.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/prediction_models/XGBoostRegressor.py` & `freqtrade-2023.5/freqtrade/freqai/prediction_models/XGBoostRegressorMultiTarget.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,20 +1,21 @@
 import logging
 from typing import Any, Dict
 
 from xgboost import XGBRegressor
 
 from freqtrade.freqai.base_models.BaseRegressionModel import BaseRegressionModel
+from freqtrade.freqai.base_models.FreqaiMultiOutputRegressor import FreqaiMultiOutputRegressor
 from freqtrade.freqai.data_kitchen import FreqaiDataKitchen
 
 
 logger = logging.getLogger(__name__)
 
 
-class XGBoostRegressor(BaseRegressionModel):
+class XGBoostRegressorMultiTarget(BaseRegressionModel):
     """
     User created prediction model. The class inherits IFreqaiModel, which
     means it has full access to all Frequency AI functionality. Typically,
     users would use this to override the common `fit()`, `train()`, or
     `predict()` methods to add their custom data handling tools or change
     various aspects of the training that cannot be configured via the
     top level config.json file.
@@ -24,27 +25,43 @@
         """
         User sets up the training and test data to fit their desired model here
         :param data_dictionary: the dictionary holding all data for train, test,
             labels, weights
         :param dk: The datakitchen object for the current coin/model
         """
 
+        xgb = XGBRegressor(**self.model_training_parameters)
+
         X = data_dictionary["train_features"]
         y = data_dictionary["train_labels"]
-
-        if self.freqai_info.get("data_split_parameters", {}).get("test_size", 0.1) == 0:
-            eval_set = None
-            eval_weights = None
-        else:
-            eval_set = [(data_dictionary["test_features"], data_dictionary["test_labels"])]
-            eval_weights = [data_dictionary['test_weights']]
-
         sample_weight = data_dictionary["train_weights"]
 
-        xgb_model = self.get_init_model(dk.pair)
+        eval_weights = None
+        eval_sets = [None] * y.shape[1]
 
-        model = XGBRegressor(**self.model_training_parameters)
+        if self.freqai_info.get('data_split_parameters', {}).get('test_size', 0.1) != 0:
+            eval_weights = [data_dictionary["test_weights"]]
+            for i in range(data_dictionary['test_labels'].shape[1]):
+                eval_sets[i] = [(  # type: ignore
+                    data_dictionary["test_features"],
+                    data_dictionary["test_labels"].iloc[:, i]
+                )]
+
+        init_model = self.get_init_model(dk.pair)
+        if init_model:
+            init_models = init_model.estimators_
+        else:
+            init_models = [None] * y.shape[1]
 
-        model.fit(X=X, y=y, sample_weight=sample_weight, eval_set=eval_set,
-                  sample_weight_eval_set=eval_weights, xgb_model=xgb_model)
+        fit_params = []
+        for i in range(len(eval_sets)):
+            fit_params.append(
+                {'eval_set': eval_sets[i], 'sample_weight_eval_set': eval_weights,
+                 'xgb_model': init_models[i]})
+
+        model = FreqaiMultiOutputRegressor(estimator=xgb)
+        thread_training = self.freqai_info.get('multitarget_parallel_training', False)
+        if thread_training:
+            model.n_jobs = y.shape[1]
+        model.fit(X=X, y=y, sample_weight=sample_weight, fit_params=fit_params)
 
         return model
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/torch/PyTorchDataConvertor.py` & `freqtrade-2023.5/freqtrade/freqai/torch/PyTorchDataConvertor.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,29 +1,29 @@
 from abc import ABC, abstractmethod
-from typing import List, Optional
+from typing import Optional
 
 import pandas as pd
 import torch
 
 
 class PyTorchDataConvertor(ABC):
     """
     This class is responsible for converting `*_features` & `*_labels` pandas dataframes
     to pytorch tensors.
     """
 
     @abstractmethod
-    def convert_x(self, df: pd.DataFrame, device: Optional[str] = None) -> List[torch.Tensor]:
+    def convert_x(self, df: pd.DataFrame, device: Optional[str] = None) -> torch.Tensor:
         """
         :param df: "*_features" dataframe.
         :param device: The device to use for training (e.g. 'cpu', 'cuda').
         """
 
     @abstractmethod
-    def convert_y(self, df: pd.DataFrame, device: Optional[str] = None) -> List[torch.Tensor]:
+    def convert_y(self, df: pd.DataFrame, device: Optional[str] = None) -> torch.Tensor:
         """
         :param df: "*_labels" dataframe.
         :param device: The device to use for training (e.g. 'cpu', 'cuda').
         """
 
 
 class DefaultPyTorchDataConvertor(PyTorchDataConvertor):
@@ -41,27 +41,27 @@
             torch.long, for regressor use torch.float or torch.double.
         :param squeeze_target_tensor: controls the target shape, used for loss functions
             that requires 0D or 1D.
         """
         self._target_tensor_type = target_tensor_type
         self._squeeze_target_tensor = squeeze_target_tensor
 
-    def convert_x(self, df: pd.DataFrame, device: Optional[str] = None) -> List[torch.Tensor]:
+    def convert_x(self, df: pd.DataFrame, device: Optional[str] = None) -> torch.Tensor:
         x = torch.from_numpy(df.values).float()
         if device:
             x = x.to(device)
 
-        return [x]
+        return x
 
-    def convert_y(self, df: pd.DataFrame, device: Optional[str] = None) -> List[torch.Tensor]:
+    def convert_y(self, df: pd.DataFrame, device: Optional[str] = None) -> torch.Tensor:
         y = torch.from_numpy(df.values)
 
         if self._target_tensor_type:
             y = y.to(self._target_tensor_type)
 
         if self._squeeze_target_tensor:
             y = y.squeeze()
 
         if device:
             y = y.to(device)
 
-        return [y]
+        return y
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/torch/PyTorchMLPModel.py` & `freqtrade-2023.5/freqtrade/freqai/torch/PyTorchMLPModel.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,9 +1,8 @@
 import logging
-from typing import List
 
 import torch
 from torch import nn
 
 
 logger = logging.getLogger(__name__)
 
@@ -43,16 +42,16 @@
         n_layer: int = kwargs.get("n_layer", 1)
         self.input_layer = nn.Linear(input_dim, hidden_dim)
         self.blocks = nn.Sequential(*[Block(hidden_dim, dropout_percent) for _ in range(n_layer)])
         self.output_layer = nn.Linear(hidden_dim, output_dim)
         self.relu = nn.ReLU()
         self.dropout = nn.Dropout(p=dropout_percent)
 
-    def forward(self, tensors: List[torch.Tensor]) -> torch.Tensor:
-        x: torch.Tensor = tensors[0]
+    def forward(self, x: torch.Tensor) -> torch.Tensor:
+        # x: torch.Tensor = tensors[0]
         x = self.relu(self.input_layer(x))
         x = self.dropout(x)
         x = self.blocks(x)
         x = self.output_layer(x)
         return x
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/torch/PyTorchModelTrainer.py` & `freqtrade-2023.5/freqtrade/freqai/torch/PyTorchModelTrainer.py`

 * *Files 10% similar despite different names*

```diff
@@ -8,28 +8,31 @@
 from torch import nn
 from torch.optim import Optimizer
 from torch.utils.data import DataLoader, TensorDataset
 
 from freqtrade.freqai.torch.PyTorchDataConvertor import PyTorchDataConvertor
 from freqtrade.freqai.torch.PyTorchTrainerInterface import PyTorchTrainerInterface
 
+from .datasets import WindowDataset
+
 
 logger = logging.getLogger(__name__)
 
 
 class PyTorchModelTrainer(PyTorchTrainerInterface):
     def __init__(
             self,
             model: nn.Module,
             optimizer: Optimizer,
             criterion: nn.Module,
             device: str,
-            init_model: Dict,
             data_convertor: PyTorchDataConvertor,
             model_meta_data: Dict[str, Any] = {},
+            window_size: int = 1,
+            tb_logger: Any = None,
             **kwargs
     ):
         """
         :param model: The PyTorch model to be trained.
         :param optimizer: The optimizer to use for training.
         :param criterion: The loss function to use for training.
         :param device: The device to use for training (e.g. 'cpu', 'cuda').
@@ -48,16 +51,16 @@
         self.criterion = criterion
         self.model_meta_data = model_meta_data
         self.device = device
         self.max_iters: int = kwargs.get("max_iters", 100)
         self.batch_size: int = kwargs.get("batch_size", 64)
         self.max_n_eval_batches: Optional[int] = kwargs.get("max_n_eval_batches", None)
         self.data_convertor = data_convertor
-        if init_model:
-            self.load_from_checkpoint(init_model)
+        self.window_size: int = window_size
+        self.tb_logger = tb_logger
 
     def fit(self, data_dictionary: Dict[str, pd.DataFrame], splits: List[str]):
         """
         :param data_dictionary: the dictionary constructed by DataHandler to hold
         all the training and test data/labels.
         :param splits: splits to use in training, splits must contain "train",
         optional "test" could be added by setting freqai.data_split_parameters.test_size > 0
@@ -71,85 +74,73 @@
         """
         data_loaders_dictionary = self.create_data_loaders_dictionary(data_dictionary, splits)
         epochs = self.calc_n_epochs(
             n_obs=len(data_dictionary["train_features"]),
             batch_size=self.batch_size,
             n_iters=self.max_iters
         )
+        self.model.train()
         for epoch in range(1, epochs + 1):
-            # training
-            losses = []
             for i, batch_data in enumerate(data_loaders_dictionary["train"]):
 
-                for tensor in batch_data:
-                    tensor.to(self.device)
-
-                xb = batch_data[:-1]
-                yb = batch_data[-1]
+                xb, yb = batch_data
+                xb.to(self.device)
+                yb.to(self.device)
                 yb_pred = self.model(xb)
                 loss = self.criterion(yb_pred, yb)
 
                 self.optimizer.zero_grad(set_to_none=True)
                 loss.backward()
                 self.optimizer.step()
-                losses.append(loss.item())
-            train_loss = sum(losses) / len(losses)
-            log_message = f"epoch {epoch}/{epochs}: train loss {train_loss:.4f}"
+                self.tb_logger.log_scalar("train_loss", loss.item(), i)
 
             # evaluation
             if "test" in splits:
-                test_loss = self.estimate_loss(
+                self.estimate_loss(
                     data_loaders_dictionary,
                     self.max_n_eval_batches,
                     "test"
                 )
-                log_message += f" ; test loss {test_loss:.4f}"
-
-            logger.info(log_message)
 
     @torch.no_grad()
     def estimate_loss(
             self,
             data_loader_dictionary: Dict[str, DataLoader],
             max_n_eval_batches: Optional[int],
             split: str,
-    ) -> float:
+    ) -> None:
         self.model.eval()
         n_batches = 0
-        losses = []
         for i, batch_data in enumerate(data_loader_dictionary[split]):
             if max_n_eval_batches and i > max_n_eval_batches:
                 n_batches += 1
                 break
+            xb, yb = batch_data
+            xb.to(self.device)
+            yb.to(self.device)
 
-            for tensor in batch_data:
-                tensor.to(self.device)
-
-            xb = batch_data[:-1]
-            yb = batch_data[-1]
             yb_pred = self.model(xb)
             loss = self.criterion(yb_pred, yb)
-            losses.append(loss.item())
+            self.tb_logger.log_scalar(f"{split}_loss", loss.item(), i)
 
         self.model.train()
-        return sum(losses) / len(losses)
 
     def create_data_loaders_dictionary(
             self,
             data_dictionary: Dict[str, pd.DataFrame],
             splits: List[str]
     ) -> Dict[str, DataLoader]:
         """
         Converts the input data to PyTorch tensors using a data loader.
         """
         data_loader_dictionary = {}
         for split in splits:
             x = self.data_convertor.convert_x(data_dictionary[f"{split}_features"], self.device)
             y = self.data_convertor.convert_y(data_dictionary[f"{split}_labels"], self.device)
-            dataset = TensorDataset(*x, *y)
+            dataset = TensorDataset(x, y)
             data_loader = DataLoader(
                 dataset,
                 batch_size=self.batch_size,
                 shuffle=True,
                 drop_last=True,
                 num_workers=0,
             )
@@ -202,7 +193,37 @@
         you can access this dict from any class that inherits IFreqaiModel by calling
         get_init_model method.
         """
         self.model.load_state_dict(checkpoint["model_state_dict"])
         self.optimizer.load_state_dict(checkpoint["optimizer_state_dict"])
         self.model_meta_data = checkpoint["model_meta_data"]
         return self
+
+
+class PyTorchTransformerTrainer(PyTorchModelTrainer):
+    """
+    Creating a trainer for the Transformer model.
+    """
+
+    def create_data_loaders_dictionary(
+            self,
+            data_dictionary: Dict[str, pd.DataFrame],
+            splits: List[str]
+    ) -> Dict[str, DataLoader]:
+        """
+        Converts the input data to PyTorch tensors using a data loader.
+        """
+        data_loader_dictionary = {}
+        for split in splits:
+            x = self.data_convertor.convert_x(data_dictionary[f"{split}_features"], self.device)
+            y = self.data_convertor.convert_y(data_dictionary[f"{split}_labels"], self.device)
+            dataset = WindowDataset(x, y, self.window_size)
+            data_loader = DataLoader(
+                dataset,
+                batch_size=self.batch_size,
+                shuffle=False,
+                drop_last=True,
+                num_workers=0,
+            )
+            data_loader_dictionary[split] = data_loader
+
+        return data_loader_dictionary
```

### Comparing `freqtrade-2023.4/freqtrade/freqai/torch/PyTorchTrainerInterface.py` & `freqtrade-2023.5/freqtrade/freqai/torch/PyTorchTrainerInterface.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/freqai/utils.py` & `freqtrade-2023.5/freqtrade/freqai/utils.py`

 * *Files 27% similar despite different names*

```diff
@@ -88,63 +88,14 @@
     )
     stopts = int(time)
     data_load_timerange = TimeRange('date', 'date', startts, stopts)
 
     return data_load_timerange
 
 
-# Keep below for when we wish to download heterogeneously lengthed data for FreqAI.
-# def download_all_data_for_training(dp: DataProvider, config: Config) -> None:
-#     """
-#     Called only once upon start of bot to download the necessary data for
-#     populating indicators and training a FreqAI model.
-#     :param timerange: TimeRange = The full data timerange for populating the indicators
-#                                     and training the model.
-#     :param dp: DataProvider instance attached to the strategy
-#     """
-
-#     if dp._exchange is not None:
-#         markets = [p for p, m in dp._exchange.markets.items() if market_is_active(m)
-#                    or config.get('include_inactive')]
-#     else:
-#         # This should not occur:
-#         raise OperationalException('No exchange object found.')
-
-#     all_pairs = dynamic_expand_pairlist(config, markets)
-
-#     if not dp._exchange:
-#         # Not realistic - this is only called in live mode.
-#         raise OperationalException("Dataprovider did not have an exchange attached.")
-
-#     time = datetime.now(tz=timezone.utc).timestamp()
-
-#     for tf in config["freqai"]["feature_parameters"].get("include_timeframes"):
-#         timerange = TimeRange()
-#         timerange.startts = int(time)
-#         timerange.stopts = int(time)
-#         startup_candles = dp.get_required_startup(str(tf))
-#         tf_seconds = timeframe_to_seconds(str(tf))
-#         timerange.subtract_start(tf_seconds * startup_candles)
-#         new_pairs_days = int((timerange.stopts - timerange.startts) / 86400)
-#         # FIXME: now that we are looping on `refresh_backtest_ohlcv_data`, the function
-#         # redownloads the funding rate for each pair.
-#         refresh_backtest_ohlcv_data(
-#             dp._exchange,
-#             pairs=all_pairs,
-#             timeframes=[tf],
-#             datadir=config["datadir"],
-#             timerange=timerange,
-#             new_pairs_days=new_pairs_days,
-#             erase=False,
-#             data_format=config.get("dataformat_ohlcv", "json"),
-#             trading_mode=config.get("trading_mode", "spot"),
-#             prepend=config.get("prepend_data", False),
-#         )
-
-
 def plot_feature_importance(model: Any, pair: str, dk: FreqaiDataKitchen,
                             count_max: int = 25) -> None:
     """
         Plot Best and worst features by importance for a single sub-train.
         :param model: Any = A model which was `fit` using a common library
                             such as catboost or lightgbm
         :param pair: str = pair e.g. BTC/USD
@@ -229,7 +180,17 @@
     :return: a string timerange (format example: '20220801-20220822')
     """
     dk = FreqaiDataKitchen(config)
     models_path = dk.get_full_models_path(config)
     dd = FreqaiDataDrawer(models_path, config)
     timerange = dd.get_timerange_from_live_historic_predictions()
     return timerange.timerange_str
+
+
+def get_tb_logger(model_type: str, path: Path, activate: bool) -> Any:
+
+    if model_type == "pytorch" and activate:
+        from freqtrade.freqai.tensorboard import TBLogger
+        return TBLogger(path, activate)
+    else:
+        from freqtrade.freqai.tensorboard.base_tensorboard import BaseTensorboardLogger
+        return BaseTensorboardLogger(path, activate)
```

### Comparing `freqtrade-2023.4/freqtrade/freqtradebot.py` & `freqtrade-2023.5/freqtrade/freqtradebot.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,32 +1,33 @@
 """
 Freqtrade is the main module of this bot. It contains the class Freqtrade()
 """
-import copy
 import logging
 import traceback
+from copy import deepcopy
 from datetime import datetime, time, timedelta, timezone
 from math import isclose
 from threading import Lock
 from typing import Any, Dict, List, Optional, Tuple
 
 from schedule import Scheduler
 
 from freqtrade import constants
 from freqtrade.configuration import validate_config_consistency
-from freqtrade.constants import BuySell, Config, LongShort
+from freqtrade.constants import BuySell, Config, ExchangeConfig, LongShort
 from freqtrade.data.converter import order_book_to_dataframe
 from freqtrade.data.dataprovider import DataProvider
 from freqtrade.edge import Edge
 from freqtrade.enums import (ExitCheckTuple, ExitType, RPCMessageType, RunMode, SignalDirection,
                              State, TradingMode)
 from freqtrade.exceptions import (DependencyException, ExchangeError, InsufficientFundsError,
                                   InvalidOrderException, PricingError)
 from freqtrade.exchange import (ROUND_DOWN, ROUND_UP, timeframe_to_minutes, timeframe_to_next_date,
                                 timeframe_to_seconds)
+from freqtrade.exchange.common import remove_exchange_credentials
 from freqtrade.misc import safe_value_fallback, safe_value_fallback2
 from freqtrade.mixins import LoggingMixin
 from freqtrade.persistence import Order, PairLocks, Trade, init_db
 from freqtrade.persistence.key_value_store import set_startup_time
 from freqtrade.plugins.pairlistmanager import PairListManager
 from freqtrade.plugins.protectionmanager import ProtectionManager
 from freqtrade.resolvers import ExchangeResolver, StrategyResolver
@@ -59,22 +60,25 @@
         self.active_pair_whitelist: List[str] = []
 
         # Init bot state
         self.state = State.STOPPED
 
         # Init objects
         self.config = config
+        exchange_config: ExchangeConfig = deepcopy(config['exchange'])
+        # Remove credentials from original exchange config to avoid accidental credentail exposure
+        remove_exchange_credentials(config['exchange'], True)
 
         self.strategy: IStrategy = StrategyResolver.load_strategy(self.config)
 
         # Check config consistency here since strategies can set certain options
         validate_config_consistency(config)
 
         self.exchange = ExchangeResolver.load_exchange(
-            self.config['exchange']['name'], self.config, load_leverage_tiers=True)
+            self.config, exchange_config=exchange_config, load_leverage_tiers=True)
 
         init_db(self.config['db_url'])
 
         self.wallets = Wallets(self.config, self.exchange)
 
         PairLocks.timeframe = self.config['timeframe']
 
@@ -416,15 +420,15 @@
                         )
                         self.update_trade_state(trade, order.order_id, send_msg=False)
 
     def handle_insufficient_funds(self, trade: Trade):
         """
         Try refinding a lost trade.
         Only used when InsufficientFunds appears on exit orders (stoploss or long sell/short buy).
-        Tries to walk the stored orders and sell them off eventually.
+        Tries to walk the stored orders and updates the trade state if necessary.
         """
         logger.info(f"Trying to refind lost order for {trade}")
         for order in trade.orders:
             logger.info(f"Trying to refind {order}")
             fo = None
             if not order.ft_is_open:
                 logger.debug(f"Order {order} is no longer open.")
@@ -447,25 +451,61 @@
                     logger.info(f"Found {order} for trade {trade}.")
                     self.update_trade_state(trade, order.order_id, fo,
                                             stoploss_order=order.ft_order_side == 'stoploss')
 
             except ExchangeError:
                 logger.warning(f"Error updating {order.order_id}.")
 
+    def handle_onexchange_order(self, trade: Trade):
+        """
+        Try refinding a order that is not in the database.
+        Only used balance disappeared, which would make exiting impossible.
+        """
+        try:
+            orders = self.exchange.fetch_orders(trade.pair, trade.open_date_utc)
+            for order in orders:
+                trade_order = [o for o in trade.orders if o.order_id == order['id']]
+                if trade_order:
+                    continue
+                logger.info(f"Found previously unknown order {order['id']} for {trade.pair}.")
+
+                order_obj = Order.parse_from_ccxt_object(order, trade.pair, order['side'])
+                order_obj.order_filled_date = datetime.fromtimestamp(
+                    safe_value_fallback(order, 'lastTradeTimestamp', 'timestamp') // 1000,
+                    tz=timezone.utc)
+                trade.orders.append(order_obj)
+                # TODO: how do we handle open_order_id ...
+                Trade.commit()
+                prev_exit_reason = trade.exit_reason
+                trade.exit_reason = ExitType.SOLD_ON_EXCHANGE.value
+                self.update_trade_state(trade, order['id'], order)
+
+                logger.info(f"handled order {order['id']}")
+                if not trade.is_open:
+                    # Trade was just closed
+                    trade.close_date = order_obj.order_filled_date
+                    Trade.commit()
+                    break
+                else:
+                    trade.exit_reason = prev_exit_reason
+                    Trade.commit()
+
+        except ExchangeError:
+            logger.warning("Error finding onexchange order")
 #
 # BUY / enter positions / open trades logic and methods
 #
 
     def enter_positions(self) -> int:
         """
         Tries to execute entry orders for new trades (positions)
         """
         trades_created = 0
 
-        whitelist = copy.deepcopy(self.active_pair_whitelist)
+        whitelist = deepcopy(self.active_pair_whitelist)
         if not whitelist:
             self.log_once("Active pair whitelist is empty.", logger.info)
             return trades_created
         # Remove pairs for currently opened trades from the whitelist
         for trade in Trade.get_open_trades():
             if trade.pair in whitelist:
                 whitelist.remove(trade.pair)
@@ -486,15 +526,16 @@
                               f"Not creating new trades, reason: {lock.reason}.", logger.info)
             else:
                 self.log_once("Global pairlock active. Not creating new trades.", logger.info)
             return trades_created
         # Create entity and execute trade for each pair from whitelist
         for pair in whitelist:
             try:
-                trades_created += self.create_trade(pair)
+                with self._exit_lock:
+                    trades_created += self.create_trade(pair)
             except DependencyException as exception:
                 logger.warning('Unable to create trade for %s: %s', pair, exception)
 
         if not trades_created:
             logger.debug("Found no enter signals for whitelisted currencies. Trying again...")
 
         return trades_created
@@ -977,15 +1018,15 @@
             'open_rate': open_rate,
             'order_type': order_type,
             'stake_amount': trade.stake_amount,
             'stake_currency': self.config['stake_currency'],
             'base_currency': self.exchange.get_pair_base_currency(trade.pair),
             'fiat_currency': self.config.get('fiat_display_currency', None),
             'amount': order.safe_amount_after_fee if fill else (order.amount or trade.amount),
-            'open_date': trade.open_date or datetime.utcnow(),
+            'open_date': trade.open_date_utc or datetime.now(timezone.utc),
             'current_rate': current_rate,
             'sub_trade': sub_trade,
         }
 
         # Send the message
         self.rpc.send_msg(msg)
 
@@ -1029,14 +1070,21 @@
 
     def exit_positions(self, trades: List[Trade]) -> int:
         """
         Tries to execute exit orders for open trades (positions)
         """
         trades_closed = 0
         for trade in trades:
+
+            if trade.open_order_id is None and not self.wallets.check_exit_amount(trade):
+                logger.warning(
+                    f'Not enough {trade.safe_base_currency} in wallet to exit {trade}. '
+                    'Trying to recover.')
+                self.handle_onexchange_order(trade)
+
             try:
                 try:
                     if (self.strategy.order_types.get('stoploss_on_exchange') and
                             self.handle_stoploss_on_exchange(trade)):
                         trades_closed += 1
                         Trade.commit()
                         continue
@@ -1531,21 +1579,21 @@
         :param amount: amount we expect to be available
         :return: amount to sell
         :raise: DependencyException: if available balance is not within 2% of the available amount.
         """
         # Update wallets to ensure amounts tied up in a stoploss is now free!
         self.wallets.update()
         if self.trading_mode == TradingMode.FUTURES:
+            # A safe exit amount isn't needed for futures, you can just exit/close the position
             return amount
 
         trade_base_currency = self.exchange.get_pair_base_currency(pair)
         wallet_amount = self.wallets.get_free(trade_base_currency)
         logger.debug(f"{pair} - Wallet: {wallet_amount} - Trade-amount: {amount}")
         if wallet_amount >= amount:
-            # A safe exit amount isn't needed for futures, you can just exit/close the position
             return amount
         elif wallet_amount > amount * 0.98:
             logger.info(f"{pair} - Falling back to wallet-amount {wallet_amount} -> {amount}.")
             trade.amount = wallet_amount
             return wallet_amount
         else:
             raise DependencyException(
@@ -1693,16 +1741,16 @@
             'current_rate': current_rate,
             'profit_amount': profit,
             'profit_ratio': profit_ratio,
             'buy_tag': trade.enter_tag,
             'enter_tag': trade.enter_tag,
             'sell_reason': trade.exit_reason,  # Deprecated
             'exit_reason': trade.exit_reason,
-            'open_date': trade.open_date,
-            'close_date': trade.close_date or datetime.utcnow(),
+            'open_date': trade.open_date_utc,
+            'close_date': trade.close_date_utc or datetime.now(timezone.utc),
             'stake_amount': trade.stake_amount,
             'stake_currency': self.config['stake_currency'],
             'base_currency': self.exchange.get_pair_base_currency(trade.pair),
             'fiat_currency': self.config.get('fiat_display_currency'),
             'sub_trade': sub_trade,
             'cumulative_profit': trade.realized_profit,
         }
@@ -1716,18 +1764,16 @@
         Sends rpc notification when a sell cancel occurred.
         """
         if trade.exit_order_status == reason:
             return
         else:
             trade.exit_order_status = reason
 
-        order = trade.select_order_by_order_id(order_id)
-        if not order:
-            raise DependencyException(
-                f"Order_obj not found for {order_id}. This should not have happened.")
+        order_or_none = trade.select_order_by_order_id(order_id)
+        order = self.order_obj_or_raise(order_id, order_or_none)
 
         profit_rate: float = trade.safe_close_rate
         profit_trade = trade.calc_profit(rate=profit_rate)
         current_rate = self.exchange.get_rate(
             trade.pair, side='exit', is_short=trade.is_short, refresh=False)
         profit_ratio = trade.calc_profit_ratio(profit_rate)
         gain = "profit" if profit_ratio > 0 else "loss"
@@ -1760,14 +1806,20 @@
             'sub_trade': sub_trade,
             'stake_amount': trade.stake_amount,
         }
 
         # Send the message
         self.rpc.send_msg(msg)
 
+    def order_obj_or_raise(self, order_id: str, order_obj: Optional[Order]) -> Order:
+        if not order_obj:
+            raise DependencyException(
+                f"Order_obj not found for {order_id}. This should not have happened.")
+        return order_obj
+
 #
 # Common update trade state methods
 #
 
     def update_trade_state(
             self, trade: Trade, order_id: Optional[str],
             action_order: Optional[Dict[str, Any]] = None,
@@ -1798,18 +1850,16 @@
         trade.update_order(order)
 
         if self.exchange.check_order_canceled_empty(order):
             # Trade has been cancelled on exchange
             # Handling of this will happen in check_handle_timedout.
             return True
 
-        order_obj = trade.select_order_by_order_id(order_id)
-        if not order_obj:
-            raise DependencyException(
-                f"Order_obj not found for {order_id}. This should not have happened.")
+        order_obj_or_none = trade.select_order_by_order_id(order_id)
+        order_obj = self.order_obj_or_raise(order_id, order_obj_or_none)
 
         self.handle_order_fee(trade, order_obj, order)
 
         trade.update_trade(order_obj)
 
         if order.get('status') in constants.NON_OPEN_EXCHANGE_STATES:
             # If a entry order was closed, force update on stoploss on exchange
@@ -1819,24 +1869,26 @@
                     # TODO: should shorting/leverage be supported by Edge,
                     # then this will need to be fixed.
                     trade.adjust_stop_loss(trade.open_rate, self.strategy.stoploss, initial=True)
             if order.get('side') == trade.entry_side or (trade.amount > 0 and trade.is_open):
                 # Must also run for partial exits
                 # TODO: Margin will need to use interest_rate as well.
                 # interest_rate = self.exchange.get_interest_rate()
-                trade.set_liquidation_price(self.exchange.get_liquidation_price(
-                    pair=trade.pair,
-                    open_rate=trade.open_rate,
-                    is_short=trade.is_short,
-                    amount=trade.amount,
-                    stake_amount=trade.stake_amount,
-                    leverage=trade.leverage,
-                    wallet_balance=trade.stake_amount,
-                ))
-
+                try:
+                    trade.set_liquidation_price(self.exchange.get_liquidation_price(
+                        pair=trade.pair,
+                        open_rate=trade.open_rate,
+                        is_short=trade.is_short,
+                        amount=trade.amount,
+                        stake_amount=trade.stake_amount,
+                        leverage=trade.leverage,
+                        wallet_balance=trade.stake_amount,
+                    ))
+                except DependencyException:
+                    logger.warning('Unable to calculate liquidation price')
             # Updating wallets when order is closed
             self.wallets.update()
         Trade.commit()
 
         self.order_close_notify(trade, order_obj, stoploss_order, send_msg)
 
         return False
```

### Comparing `freqtrade-2023.4/freqtrade/leverage/interest.py` & `freqtrade-2023.5/freqtrade/leverage/interest.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/loggers/__init__.py` & `freqtrade-2023.5/freqtrade/loggers/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -28,14 +28,15 @@
     logging.getLogger("urllib3").setLevel(
         logging.INFO if verbosity <= 1 else logging.DEBUG
     )
     logging.getLogger('ccxt.base.exchange').setLevel(
         logging.INFO if verbosity <= 2 else logging.DEBUG
     )
     logging.getLogger('telegram').setLevel(logging.INFO)
+    logging.getLogger('httpx').setLevel(logging.INFO)
 
     logging.getLogger('werkzeug').setLevel(
         logging.ERROR if api_verbosity == 'error' else logging.INFO
     )
 
 
 def get_existing_handlers(handlertype):
```

### Comparing `freqtrade-2023.4/freqtrade/loggers/std_err_stream_handler.py` & `freqtrade-2023.5/freqtrade/loggers/std_err_stream_handler.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/main.py` & `freqtrade-2023.5/freqtrade/main.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/misc.py` & `freqtrade-2023.5/freqtrade/misc.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,19 +1,17 @@
 """
 Various tool function for Freqtrade and scripts
 """
 import gzip
 import logging
-import re
 from datetime import datetime
 from pathlib import Path
 from typing import Any, Dict, Iterator, List, Mapping, Optional, TextIO, Union
 from urllib.parse import urlparse
 
-import orjson
 import pandas as pd
 import rapidjson
 
 from freqtrade.constants import DECIMAL_PER_COIN_FALLBACK, DECIMALS_PER_COIN
 from freqtrade.enums import SignalTagType, SignalType
 
 
@@ -44,26 +42,14 @@
         val = val.rstrip('0').rstrip('.')
     if show_coin_name:
         val = f"{val} {coin}"
 
     return val
 
 
-def shorten_date(_date: str) -> str:
-    """
-    Trim the date so it fits on small screens
-    """
-    new_date = re.sub('seconds?', 'sec', _date)
-    new_date = re.sub('minutes?', 'min', new_date)
-    new_date = re.sub('hours?', 'h', new_date)
-    new_date = re.sub('days?', 'd', new_date)
-    new_date = re.sub('^an?', '1', new_date)
-    return new_date
-
-
 def file_dump_json(filename: Path, data: Any, is_zip: bool = False, log: bool = True) -> None:
     """
     Dump JSON data into a file
     :param filename: file to create
     :param is_zip: if file should be zip
     :param data: JSON Data to save
     :return:
@@ -258,25 +244,15 @@
 
 def dataframe_to_json(dataframe: pd.DataFrame) -> str:
     """
     Serialize a DataFrame for transmission over the wire using JSON
     :param dataframe: A pandas DataFrame
     :returns: A JSON string of the pandas DataFrame
     """
-    # https://github.com/pandas-dev/pandas/issues/24889
-    # https://github.com/pandas-dev/pandas/issues/40443
-    # We need to convert to a dict to avoid mem leak
-    def default(z):
-        if isinstance(z, pd.Timestamp):
-            return z.timestamp() * 1e3
-        if z is pd.NaT:
-            return 'NaT'
-        raise TypeError
-
-    return str(orjson.dumps(dataframe.to_dict(orient='split'), default=default), 'utf-8')
+    return dataframe.to_json(orient='split')
 
 
 def json_to_dataframe(data: str) -> pd.DataFrame:
     """
     Deserialize JSON into a DataFrame
     :param data: A JSON string
     :returns: A pandas DataFrame from the JSON string
```

### Comparing `freqtrade-2023.4/freqtrade/mixins/logging_mixin.py` & `freqtrade-2023.5/freqtrade/mixins/logging_mixin.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/backtest_caching.py` & `freqtrade-2023.5/freqtrade/optimize/backtest_caching.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/backtesting.py` & `freqtrade-2023.5/freqtrade/optimize/backtesting.py`

 * *Files 5% similar despite different names*

```diff
@@ -5,15 +5,14 @@
 """
 import logging
 from collections import defaultdict
 from copy import deepcopy
 from datetime import datetime, timedelta, timezone
 from typing import Any, Dict, List, Optional, Tuple
 
-import pandas as pd
 from numpy import nan
 from pandas import DataFrame
 
 from freqtrade import constants
 from freqtrade.configuration import TimeRange, validate_config_consistency
 from freqtrade.constants import DATETIME_PRINT_FORMAT, Config, IntOrInf, LongShort
 from freqtrade.data import history
@@ -24,16 +23,18 @@
                              TradingMode)
 from freqtrade.exceptions import DependencyException, OperationalException
 from freqtrade.exchange import (amount_to_contract_precision, price_to_precision,
                                 timeframe_to_minutes, timeframe_to_seconds)
 from freqtrade.mixins import LoggingMixin
 from freqtrade.optimize.backtest_caching import get_strategy_run_id
 from freqtrade.optimize.bt_progress import BTProgress
-from freqtrade.optimize.optimize_reports import (generate_backtest_stats, show_backtest_results,
-                                                 store_backtest_signal_candles,
+from freqtrade.optimize.optimize_reports import (generate_backtest_stats, generate_rejected_signals,
+                                                 generate_trade_signal_candles,
+                                                 show_backtest_results,
+                                                 store_backtest_analysis_results,
                                                  store_backtest_stats)
 from freqtrade.persistence import LocalTrade, Order, PairLocks, Trade
 from freqtrade.plugins.pairlistmanager import PairListManager
 from freqtrade.plugins.protectionmanager import ProtectionManager
 from freqtrade.resolvers import ExchangeResolver, StrategyResolver
 from freqtrade.strategy.interface import IStrategy
 from freqtrade.strategy.strategy_wrapper import strategy_safe_wrapper
@@ -80,18 +81,19 @@
         self.order_id_counter: int = 0
 
         config['dry_run'] = True
         self.run_ids: Dict[str, str] = {}
         self.strategylist: List[IStrategy] = []
         self.all_results: Dict[str, Dict] = {}
         self.processed_dfs: Dict[str, Dict] = {}
+        self.rejected_dict: Dict[str, List] = {}
+        self.rejected_df: Dict[str, Dict] = {}
 
         self._exchange_name = self.config['exchange']['name']
-        self.exchange = ExchangeResolver.load_exchange(
-            self._exchange_name, self.config, load_leverage_tiers=True)
+        self.exchange = ExchangeResolver.load_exchange(self.config, load_leverage_tiers=True)
         self.dataprovider = DataProvider(self.config, self.exchange)
 
         if self.config.get('strategy_list'):
             if self.config.get('freqai', {}).get('enabled', False):
                 logger.warning("Using --strategy-list with FreqAI REQUIRES all strategies "
                                "to have identical feature_engineering_* functions.")
             for strat in list(self.config['strategy_list']):
@@ -1052,14 +1054,26 @@
             return None
 
         # Waits until the time-counter reaches the start of the data for this pair.
         if row[DATE_IDX] > current_time:
             return None
         return row
 
+    def _collate_rejected(self, pair, row):
+        """
+        Temporarily store rejected signal information for downstream use in backtesting_analysis
+        """
+        # It could be fun to enable hyperopt mode to write
+        # a loss function to reduce rejected signals
+        if (self.config.get('export', 'none') == 'signals' and
+                self.dataprovider.runmode == RunMode.BACKTEST):
+            if pair not in self.rejected_dict:
+                self.rejected_dict[pair] = []
+            self.rejected_dict[pair].append([row[DATE_IDX], row[ENTER_TAG_IDX]])
+
     def backtest_loop(
             self, row: Tuple, pair: str, current_time: datetime, end_date: datetime,
             open_trade_count_start: int, trade_dir: Optional[LongShort],
             is_first: bool = True) -> int:
         """
         NOTE: This method is used by Hyperopt at each iteration. Please keep it optimized.
 
@@ -1077,28 +1091,30 @@
         # without positionstacking, we can only have one open trade per pair.
         # max_open_trades must be respected
         # don't open on the last row
         # We only open trades on the main candle, not on detail candles
         if (
             (self._position_stacking or len(LocalTrade.bt_trades_open_pp[pair]) == 0)
             and is_first
-            and self.trade_slot_available(open_trade_count_start)
             and current_time != end_date
             and trade_dir is not None
             and not PairLocks.is_pair_locked(pair, row[DATE_IDX], trade_dir)
         ):
-            trade = self._enter_trade(pair, row, trade_dir)
-            if trade:
-                # TODO: hacky workaround to avoid opening > max_open_trades
-                # This emulates previous behavior - not sure if this is correct
-                # Prevents entering if the trade-slot was freed in this candle
-                open_trade_count_start += 1
-                # logger.debug(f"{pair} - Emulate creation of new trade: {trade}.")
-                LocalTrade.add_bt_trade(trade)
-                self.wallets.update()
+            if (self.trade_slot_available(open_trade_count_start)):
+                trade = self._enter_trade(pair, row, trade_dir)
+                if trade:
+                    # TODO: hacky workaround to avoid opening > max_open_trades
+                    # This emulates previous behavior - not sure if this is correct
+                    # Prevents entering if the trade-slot was freed in this candle
+                    open_trade_count_start += 1
+                    # logger.debug(f"{pair} - Emulate creation of new trade: {trade}.")
+                    LocalTrade.add_bt_trade(trade)
+                    self.wallets.update()
+            else:
+                self._collate_rejected(pair, row)
 
         for trade in list(LocalTrade.bt_trades_open_pp[pair]):
             # 3. Process entry orders.
             order = trade.select_order(trade.entry_side, is_open=True)
             if order and self._get_order_filled(order.ft_price, row):
                 order.close_bt_order(current_time, trade)
                 trade.open_order_id = None
@@ -1232,16 +1248,16 @@
             'replaced_entry_orders': self.replaced_entry_orders,
             'final_balance': self.wallets.get_total(self.strategy.config['stake_currency']),
         }
 
     def backtest_one_strategy(self, strat: IStrategy, data: Dict[str, DataFrame],
                               timerange: TimeRange):
         self.progress.init_step(BacktestState.ANALYZE, 0)
-
-        logger.info(f"Running backtesting for Strategy {strat.get_strategy_name()}")
+        strategy_name = strat.get_strategy_name()
+        logger.info(f"Running backtesting for Strategy {strategy_name}")
         backtest_start_time = datetime.now(timezone.utc)
         self._set_strategy(strat)
 
         # Use max_open_trades in backtesting, except --disable-max-market-positions is set
         if not self.config.get('use_max_market_positions', True):
             logger.info(
                 'Ignoring max_open_trades (--disable-max-market-positions was used) ...')
@@ -1268,45 +1284,29 @@
         results = self.backtest(
             processed=preprocessed,
             start_date=min_date,
             end_date=max_date,
         )
         backtest_end_time = datetime.now(timezone.utc)
         results.update({
-            'run_id': self.run_ids.get(strat.get_strategy_name(), ''),
+            'run_id': self.run_ids.get(strategy_name, ''),
             'backtest_start_time': int(backtest_start_time.timestamp()),
             'backtest_end_time': int(backtest_end_time.timestamp()),
         })
-        self.all_results[self.strategy.get_strategy_name()] = results
+        self.all_results[strategy_name] = results
 
         if (self.config.get('export', 'none') == 'signals' and
                 self.dataprovider.runmode == RunMode.BACKTEST):
-            self._generate_trade_signal_candles(preprocessed_tmp, results)
+            self.processed_dfs[strategy_name] = generate_trade_signal_candles(
+                preprocessed_tmp, results)
+            self.rejected_df[strategy_name] = generate_rejected_signals(
+                preprocessed_tmp, self.rejected_dict)
 
         return min_date, max_date
 
-    def _generate_trade_signal_candles(self, preprocessed_df, bt_results):
-        signal_candles_only = {}
-        for pair in preprocessed_df.keys():
-            signal_candles_only_df = DataFrame()
-
-            pairdf = preprocessed_df[pair]
-            resdf = bt_results['results']
-            pairresults = resdf.loc[(resdf["pair"] == pair)]
-
-            if pairdf.shape[0] > 0:
-                for t, v in pairresults.open_date.items():
-                    allinds = pairdf.loc[(pairdf['date'] < v)]
-                    signal_inds = allinds.iloc[[-1]]
-                    signal_candles_only_df = pd.concat([signal_candles_only_df, signal_inds])
-
-                signal_candles_only[pair] = signal_candles_only_df
-
-        self.processed_dfs[self.strategy.get_strategy_name()] = signal_candles_only
-
     def _get_min_cached_backtest_date(self):
         min_backtest_date = None
         backtest_cache_age = self.config.get('backtest_cache', constants.BACKTEST_CACHE_DEFAULT)
         if self.timerange.stopts == 0 or self.timerange.stopdt > datetime.now(tz=timezone.utc):
             logger.warning('Backtest result caching disabled due to use of open-ended timerange.')
         elif backtest_cache_age == 'day':
             min_backtest_date = datetime.now(tz=timezone.utc) - timedelta(days=1)
@@ -1361,16 +1361,17 @@
                 self.results = results
             dt_appendix = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
             if self.config.get('export', 'none') in ('trades', 'signals'):
                 store_backtest_stats(self.config['exportfilename'], self.results, dt_appendix)
 
             if (self.config.get('export', 'none') == 'signals' and
                     self.dataprovider.runmode == RunMode.BACKTEST):
-                store_backtest_signal_candles(
-                    self.config['exportfilename'], self.processed_dfs, dt_appendix)
+                store_backtest_analysis_results(
+                    self.config['exportfilename'], self.processed_dfs, self.rejected_df,
+                    dt_appendix)
 
         # Results may be mixed up now. Sort them so they follow --strategy-list order.
         if 'strategy_list' in self.config and len(self.results) > 0:
             self.results['strategy_comparison'] = sorted(
                 self.results['strategy_comparison'],
                 key=lambda c: self.config['strategy_list'].index(c['key']))
             self.results['strategy'] = dict(
```

### Comparing `freqtrade-2023.4/freqtrade/optimize/bt_progress.py` & `freqtrade-2023.5/freqtrade/optimize/bt_progress.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/edge_cli.py` & `freqtrade-2023.5/freqtrade/optimize/edge_cli.py`

 * *Files 8% similar despite different names*

```diff
@@ -28,15 +28,15 @@
 
     def __init__(self, config: Config) -> None:
         self.config = config
 
         # Ensure using dry-run
         self.config['dry_run'] = True
         self.config['stake_amount'] = constants.UNLIMITED_STAKE_AMOUNT
-        self.exchange = ExchangeResolver.load_exchange(self.config['exchange']['name'], self.config)
+        self.exchange = ExchangeResolver.load_exchange(self.config)
         self.strategy = StrategyResolver.load_strategy(self.config)
         self.strategy.dp = DataProvider(config, self.exchange)
 
         validate_config_consistency(self.config)
 
         self.edge = Edge(config, self.exchange, self.strategy)
         # Set refresh_pairs to false for edge-cli (it must be true for edge)
```

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_auto.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_auto.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_epoch_filters.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_epoch_filters.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_interface.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_interface.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_calmar.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_calmar.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_max_drawdown.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_max_drawdown.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_max_drawdown_relative.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_max_drawdown_relative.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_onlyprofit.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_onlyprofit.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_profit_drawdown.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_profit_drawdown.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sharpe.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sharpe.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sharpe_daily.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sharpe_daily.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_short_trade_dur.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_short_trade_dur.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sortino.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sortino.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sortino_daily.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss/hyperopt_loss_sortino_daily.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_loss_interface.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_loss_interface.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/hyperopt_tools.py` & `freqtrade-2023.5/freqtrade/optimize/hyperopt_tools.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/optimize/optimize_reports.py` & `freqtrade-2023.5/freqtrade/optimize/optimize_reports.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 import logging
 from copy import deepcopy
 from datetime import datetime, timedelta, timezone
 from pathlib import Path
 from typing import Any, Dict, List, Union
 
-from pandas import DataFrame, to_datetime
+from pandas import DataFrame, concat, to_datetime
 from tabulate import tabulate
 
 from freqtrade.constants import (BACKTEST_BREAKDOWNS, DATETIME_PRINT_FORMAT, LAST_BT_RESULT_FN,
                                  UNLIMITED_STAKE_AMOUNT, Config, IntOrInf)
 from freqtrade.data.metrics import (calculate_cagr, calculate_calmar, calculate_csum,
                                     calculate_expectancy, calculate_market_change,
                                     calculate_max_drawdown, calculate_sharpe, calculate_sortino)
@@ -42,37 +42,88 @@
 
     file_dump_json(filename, stats)
 
     latest_filename = Path.joinpath(filename.parent, LAST_BT_RESULT_FN)
     file_dump_json(latest_filename, {'latest_backtest': str(filename.name)})
 
 
-def store_backtest_signal_candles(
-        recordfilename: Path, candles: Dict[str, Dict], dtappendix: str) -> Path:
+def _store_backtest_analysis_data(
+        recordfilename: Path, data: Dict[str, Dict],
+        dtappendix: str, name: str) -> Path:
     """
-    Stores backtest trade signal candles
+    Stores backtest trade candles for analysis
     :param recordfilename: Path object, which can either be a filename or a directory.
         Filenames will be appended with a timestamp right before the suffix
-        while for directories, <directory>/backtest-result-<datetime>_signals.pkl will be used
+        while for directories, <directory>/backtest-result-<datetime>_<name>.pkl will be used
         as filename
-    :param stats: Dict containing the backtesting signal candles
+    :param candles: Dict containing the backtesting data for analysis
     :param dtappendix: Datetime to use for the filename
+    :param name: Name to use for the file, e.g. signals, rejected
     """
     if recordfilename.is_dir():
-        filename = (recordfilename / f'backtest-result-{dtappendix}_signals.pkl')
+        filename = (recordfilename / f'backtest-result-{dtappendix}_{name}.pkl')
     else:
         filename = Path.joinpath(
-            recordfilename.parent, f'{recordfilename.stem}-{dtappendix}_signals.pkl'
+            recordfilename.parent, f'{recordfilename.stem}-{dtappendix}_{name}.pkl'
         )
 
-    file_dump_joblib(filename, candles)
+    file_dump_joblib(filename, data)
 
     return filename
 
 
+def store_backtest_analysis_results(
+        recordfilename: Path, candles: Dict[str, Dict], trades: Dict[str, Dict],
+        dtappendix: str) -> None:
+    _store_backtest_analysis_data(recordfilename, candles, dtappendix, "signals")
+    _store_backtest_analysis_data(recordfilename, trades, dtappendix, "rejected")
+
+
+def generate_trade_signal_candles(preprocessed_df: Dict[str, DataFrame],
+                                  bt_results: Dict[str, Any]) -> DataFrame:
+    signal_candles_only = {}
+    for pair in preprocessed_df.keys():
+        signal_candles_only_df = DataFrame()
+
+        pairdf = preprocessed_df[pair]
+        resdf = bt_results['results']
+        pairresults = resdf.loc[(resdf["pair"] == pair)]
+
+        if pairdf.shape[0] > 0:
+            for t, v in pairresults.open_date.items():
+                allinds = pairdf.loc[(pairdf['date'] < v)]
+                signal_inds = allinds.iloc[[-1]]
+                signal_candles_only_df = concat([
+                    signal_candles_only_df.infer_objects(),
+                    signal_inds.infer_objects()])
+
+            signal_candles_only[pair] = signal_candles_only_df
+    return signal_candles_only
+
+
+def generate_rejected_signals(preprocessed_df: Dict[str, DataFrame],
+                              rejected_dict: Dict[str, DataFrame]) -> Dict[str, DataFrame]:
+    rejected_candles_only = {}
+    for pair, signals in rejected_dict.items():
+        rejected_signals_only_df = DataFrame()
+        pairdf = preprocessed_df[pair]
+
+        for t in signals:
+            data_df_row = pairdf.loc[(pairdf['date'] == t[0])].copy()
+            data_df_row['pair'] = pair
+            data_df_row['enter_tag'] = t[1]
+
+            rejected_signals_only_df = concat([
+                rejected_signals_only_df.infer_objects(),
+                data_df_row.infer_objects()])
+
+        rejected_candles_only[pair] = rejected_signals_only_df
+    return rejected_candles_only
+
+
 def _get_line_floatfmt(stake_currency: str) -> List[str]:
     """
     Generate floatformat (goes in line with _generate_result_line())
     """
     return ['s', 'd', '.2f', '.2f', f'.{decimals_per_coin(stake_currency)}f',
             '.2f', 'd', 's', 's']
```

### Comparing `freqtrade-2023.4/freqtrade/optimize/space/decimalspace.py` & `freqtrade-2023.5/freqtrade/optimize/space/decimalspace.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/persistence/key_value_store.py` & `freqtrade-2023.5/freqtrade/persistence/key_value_store.py`

 * *Files 2% similar despite different names*

```diff
@@ -32,15 +32,15 @@
 
     id: Mapped[int] = mapped_column(primary_key=True)
 
     key: Mapped[KeyStoreKeys] = mapped_column(String(25), nullable=False, index=True)
 
     value_type: Mapped[ValueTypesEnum] = mapped_column(String(20), nullable=False)
 
-    string_value: Mapped[Optional[str]]
+    string_value: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
     datetime_value: Mapped[Optional[datetime]]
     float_value: Mapped[Optional[float]]
     int_value: Mapped[Optional[int]]
 
 
 class KeyValueStore():
     """
```

### Comparing `freqtrade-2023.4/freqtrade/persistence/migrations.py` & `freqtrade-2023.5/freqtrade/persistence/migrations.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/persistence/models.py` & `freqtrade-2023.5/freqtrade/persistence/models.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/persistence/pairlock.py` & `freqtrade-2023.5/freqtrade/persistence/pairlock.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/persistence/pairlock_middleware.py` & `freqtrade-2023.5/freqtrade/persistence/pairlock_middleware.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/persistence/trade_model.py` & `freqtrade-2023.5/freqtrade/persistence/trade_model.py`

 * *Files 0% similar despite different names*

```diff
@@ -15,15 +15,15 @@
                                  NON_OPEN_EXCHANGE_STATES, BuySell, LongShort)
 from freqtrade.enums import ExitType, TradingMode
 from freqtrade.exceptions import DependencyException, OperationalException
 from freqtrade.exchange import (ROUND_DOWN, ROUND_UP, amount_to_contract_precision,
                                 price_to_precision)
 from freqtrade.leverage import interest
 from freqtrade.persistence.base import ModelBase, SessionType
-from freqtrade.util import FtPrecise
+from freqtrade.util import FtPrecise, dt_now
 
 
 logger = logging.getLogger(__name__)
 
 
 class Order(ModelBase):
     """
@@ -64,15 +64,15 @@
     price: Mapped[Optional[float]] = mapped_column(Float(), nullable=True)
     average: Mapped[Optional[float]] = mapped_column(Float(), nullable=True)
     amount: Mapped[Optional[float]] = mapped_column(Float(), nullable=True)
     filled: Mapped[Optional[float]] = mapped_column(Float(), nullable=True)
     remaining: Mapped[Optional[float]] = mapped_column(Float(), nullable=True)
     cost: Mapped[Optional[float]] = mapped_column(Float(), nullable=True)
     stop_price: Mapped[Optional[float]] = mapped_column(Float(), nullable=True)
-    order_date: Mapped[datetime] = mapped_column(nullable=True, default=datetime.utcnow)
+    order_date: Mapped[datetime] = mapped_column(nullable=True, default=dt_now)
     order_filled_date: Mapped[Optional[datetime]] = mapped_column(nullable=True)
     order_update_date: Mapped[Optional[datetime]] = mapped_column(nullable=True)
     funding_fee: Mapped[Optional[float]] = mapped_column(Float(), nullable=True)
 
     ft_fee_base: Mapped[Optional[float]] = mapped_column(Float(), nullable=True)
 
     @property
@@ -154,35 +154,38 @@
                 # Assign funding fee up to this point
                 # (represents the funding fee since the last order)
                 self.funding_fee = self.trade.funding_fees
             if (order.get('filled', 0.0) or 0.0) > 0 and not self.order_filled_date:
                 self.order_filled_date = datetime.now(timezone.utc)
         self.order_update_date = datetime.now(timezone.utc)
 
-    def to_ccxt_object(self) -> Dict[str, Any]:
+    def to_ccxt_object(self, stopPriceName: str = 'stopPrice') -> Dict[str, Any]:
         order: Dict[str, Any] = {
             'id': self.order_id,
             'symbol': self.ft_pair,
             'price': self.price,
             'average': self.average,
             'amount': self.amount,
             'cost': self.cost,
             'type': self.order_type,
             'side': self.ft_order_side,
             'filled': self.filled,
             'remaining': self.remaining,
-            'stopPrice': self.stop_price,
             'datetime': self.order_date_utc.strftime('%Y-%m-%dT%H:%M:%S.%f'),
             'timestamp': int(self.order_date_utc.timestamp() * 1000),
             'status': self.status,
             'fee': None,
             'info': {},
         }
         if self.ft_order_side == 'stoploss':
-            order['ft_order_type'] = 'stoploss'
+            order.update({
+                stopPriceName: self.stop_price,
+                'ft_order_type': 'stoploss',
+            })
+
         return order
 
     def to_json(self, entry_side: str, minified: bool = False) -> Dict[str, Any]:
         resp = {
             'amount': self.safe_amount,
             'safe_price': self.safe_price,
             'ft_order_side': self.ft_order_side,
@@ -418,15 +421,15 @@
     def stoploss_last_update_utc(self):
         if self.stoploss_last_update:
             return self.stoploss_last_update.replace(tzinfo=timezone.utc)
         return None
 
     @property
     def close_date_utc(self):
-        return self.close_date.replace(tzinfo=timezone.utc)
+        return self.close_date.replace(tzinfo=timezone.utc) if self.close_date else None
 
     @property
     def entry_side(self) -> str:
         if self.is_short:
             return "sell"
         else:
             return "buy"
@@ -704,15 +707,18 @@
                 logger.info(f'{order.order_type.upper()} is hit for {self}.')
         else:
             raise ValueError(f'Unknown order type: {order.order_type}')
 
         if order.ft_order_side != self.entry_side:
             amount_tr = amount_to_contract_precision(self.amount, self.amount_precision,
                                                      self.precision_mode, self.contract_size)
-            if isclose(order.safe_amount_after_fee, amount_tr, abs_tol=MATH_CLOSE_PREC):
+            if (
+                isclose(order.safe_amount_after_fee, amount_tr, abs_tol=MATH_CLOSE_PREC)
+                or order.safe_amount_after_fee > amount_tr
+            ):
                 self.close(order.safe_price)
             else:
                 self.recalc_trade_from_orders()
 
         Trade.commit()
 
     def close(self, rate: float, *, show_msg: bool = True) -> None:
```

### Comparing `freqtrade-2023.4/freqtrade/plot/plotting.py` & `freqtrade-2023.5/freqtrade/plot/plotting.py`

 * *Files 1% similar despite different names*

```diff
@@ -629,15 +629,15 @@
     - Load trades executed during the selected period
     - Generate Plotly plot objects
     - Generate plot files
     :return: None
     """
     strategy = StrategyResolver.load_strategy(config)
 
-    exchange = ExchangeResolver.load_exchange(config['exchange']['name'], config)
+    exchange = ExchangeResolver.load_exchange(config)
     IStrategy.dp = DataProvider(config, exchange)
     strategy.ft_bot_start()
     strategy.bot_loop_start(datetime.now(timezone.utc))
     plot_elements = init_plotscript(config, list(exchange.markets), strategy.startup_candle_count)
     timerange = plot_elements['timerange']
     trades = plot_elements['trades']
     pair_counter = 0
@@ -674,15 +674,15 @@
     Note, the profit calculation isn't realistic.
     But should be somewhat proportional, and therefor useful
     in helping out to find a good algorithm.
     """
     if 'timeframe' not in config:
         raise OperationalException('Timeframe must be set in either config or via --timeframe.')
 
-    exchange = ExchangeResolver.load_exchange(config['exchange']['name'], config)
+    exchange = ExchangeResolver.load_exchange(config)
     plot_elements = init_plotscript(config, list(exchange.markets))
     trades = plot_elements['trades']
     # Filter trades to relevant pairs
     # Remove open pairs - we don't know the profit yet so can't calculate profit for these.
     # Also, If only one open pair is left, then the profit-generation would fail.
     trades = trades[(trades['pair'].isin(plot_elements['pairs']))
                     & (~trades['close_date'].isnull())
```

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/AgeFilter.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/AgeFilter.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,23 +1,23 @@
 """
 Minimum age (days listed) pair list filter
 """
 import logging
 from copy import deepcopy
+from datetime import timedelta
 from typing import Any, Dict, List, Optional
 
-import arrow
 from pandas import DataFrame
 
 from freqtrade.constants import Config, ListPairsWithTimeframes
 from freqtrade.exceptions import OperationalException
 from freqtrade.exchange.types import Tickers
 from freqtrade.misc import plural
 from freqtrade.plugins.pairlist.IPairList import IPairList
-from freqtrade.util import PeriodicCache
+from freqtrade.util import PeriodicCache, dt_floor_day, dt_now, dt_ts
 
 
 logger = logging.getLogger(__name__)
 
 
 class AgeFilter(IPairList):
 
@@ -80,18 +80,15 @@
         if not needed_pairs:
             # Remove pairs that have been removed before
             return [p for p in pairlist if p not in self._symbolsCheckFailed]
 
         since_days = -(
             self._max_days_listed if self._max_days_listed else self._min_days_listed
         ) - 1
-        since_ms = int(arrow.utcnow()
-                       .floor('day')
-                       .shift(days=since_days)
-                       .float_timestamp) * 1000
+        since_ms = dt_ts(dt_floor_day(dt_now()) + timedelta(days=since_days))
         candles = self._exchange.refresh_latest_ohlcv(needed_pairs, since_ms=since_ms, cache=False)
         if self._enabled:
             for p in deepcopy(pairlist):
                 daily_candles = candles[(p, '1d', self._config['candle_type_def'])] if (
                     p, '1d', self._config['candle_type_def']) in candles else None
                 if not self._validate_pair_loc(p, daily_candles):
                     pairlist.remove(p)
@@ -112,21 +109,21 @@
         if daily_candles is not None:
             if (
                 len(daily_candles) >= self._min_days_listed
                 and (not self._max_days_listed or len(daily_candles) <= self._max_days_listed)
             ):
                 # We have fetched at least the minimum required number of daily candles
                 # Add to cache, store the time we last checked this symbol
-                self._symbolsChecked[pair] = arrow.utcnow().int_timestamp * 1000
+                self._symbolsChecked[pair] = dt_ts()
                 return True
             else:
                 self.log_once((
                     f"Removed {pair} from whitelist, because age "
                     f"{len(daily_candles)} is less than {self._min_days_listed} "
                     f"{plural(self._min_days_listed, 'day')}"
                 ) + ((
                     " or more than "
                     f"{self._max_days_listed} {plural(self._max_days_listed, 'day')}"
                 ) if self._max_days_listed else ''), logger.info)
-                self._symbolsCheckFailed[pair] = arrow.utcnow().int_timestamp * 1000
+                self._symbolsCheckFailed[pair] = dt_ts()
                 return False
         return False
```

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/IPairList.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/IPairList.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/OffsetFilter.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/OffsetFilter.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/PerformanceFilter.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/PerformanceFilter.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/PrecisionFilter.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/PrecisionFilter.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/PriceFilter.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/PriceFilter.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/ProducerPairList.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/ProducerPairList.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/RemotePairList.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/RemotePairList.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/ShuffleFilter.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/ShuffleFilter.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/SpreadFilter.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/SpreadFilter.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/StaticPairList.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/StaticPairList.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/VolatilityFilter.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/VolatilityFilter.py`

 * *Files 9% similar despite different names*

```diff
@@ -1,25 +1,26 @@
 """
 Volatility pairlist filter
 """
 import logging
 import sys
 from copy import deepcopy
+from datetime import timedelta
 from typing import Any, Dict, List, Optional
 
-import arrow
 import numpy as np
 from cachetools import TTLCache
 from pandas import DataFrame
 
 from freqtrade.constants import Config, ListPairsWithTimeframes
 from freqtrade.exceptions import OperationalException
 from freqtrade.exchange.types import Tickers
 from freqtrade.misc import plural
 from freqtrade.plugins.pairlist.IPairList import IPairList
+from freqtrade.util import dt_floor_day, dt_now, dt_ts
 
 
 logger = logging.getLogger(__name__)
 
 
 class VolatilityFilter(IPairList):
     """
@@ -69,18 +70,15 @@
         :param pairlist: pairlist to filter or sort
         :param tickers: Tickers (from exchange.get_tickers). May be cached.
         :return: new allowlist
         """
         needed_pairs: ListPairsWithTimeframes = [
             (p, '1d', self._def_candletype) for p in pairlist if p not in self._pair_cache]
 
-        since_ms = (arrow.utcnow()
-                         .floor('day')
-                         .shift(days=-self._days - 1)
-                         .int_timestamp) * 1000
+        since_ms = dt_ts(dt_floor_day(dt_now()) - timedelta(days=self._days))
         # Get all candles
         candles = {}
         if needed_pairs:
             candles = self._exchange.refresh_latest_ohlcv(needed_pairs, since_ms=since_ms,
                                                           cache=False)
 
         if self._enabled:
@@ -101,15 +99,15 @@
         # Check symbol in cache
         cached_res = self._pair_cache.get(pair, None)
         if cached_res is not None:
             return cached_res
 
         result = False
         if daily_candles is not None and not daily_candles.empty:
-            returns = (np.log(daily_candles.close / daily_candles.close.shift(-1)))
+            returns = (np.log(daily_candles["close"].shift(1) / daily_candles["close"]))
             returns.fillna(0, inplace=True)
 
             volatility_series = returns.rolling(window=self._days).std() * np.sqrt(self._days)
             volatility_avg = volatility_series.mean()
 
             if self._min_volatility <= volatility_avg <= self._max_volatility:
                 result = True
```

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/VolumePairList.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/VolumePairList.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,24 +1,25 @@
 """
 Volume PairList provider
 
 Provides dynamic pair list based on trade volumes
 """
 import logging
-from datetime import datetime, timedelta, timezone
+from datetime import timedelta
 from typing import Any, Dict, List, Literal
 
 from cachetools import TTLCache
 
 from freqtrade.constants import Config, ListPairsWithTimeframes
 from freqtrade.exceptions import OperationalException
 from freqtrade.exchange import timeframe_to_minutes, timeframe_to_prev_date
 from freqtrade.exchange.types import Tickers
 from freqtrade.misc import format_ms_time
 from freqtrade.plugins.pairlist.IPairList import IPairList
+from freqtrade.util import dt_now
 
 
 logger = logging.getLogger(__name__)
 
 
 SORT_VALUES = ['quoteVolume']
 
@@ -157,21 +158,21 @@
         if self._use_range:
             # Create bare minimum from tickers structure.
             filtered_tickers: List[Dict[str, Any]] = [{'symbol': k} for k in pairlist]
 
             # get lookback period in ms, for exchange ohlcv fetch
             since_ms = int(timeframe_to_prev_date(
                 self._lookback_timeframe,
-                datetime.now(timezone.utc) + timedelta(
+                dt_now() + timedelta(
                     minutes=-(self._lookback_period * self._tf_in_min) - self._tf_in_min)
                     ).timestamp()) * 1000
 
             to_ms = int(timeframe_to_prev_date(
                             self._lookback_timeframe,
-                            datetime.now(timezone.utc) - timedelta(minutes=self._tf_in_min)
+                            dt_now() - timedelta(minutes=self._tf_in_min)
                             ).timestamp()) * 1000
 
             # todo: utc date output for starting date
             self.log_once(f"Using volume range of {self._lookback_period} candles, timeframe: "
                           f"{self._lookback_timeframe}, starting from {format_ms_time(since_ms)} "
                           f"till {format_ms_time(to_ms)}", logger.info)
             needed_pairs: ListPairsWithTimeframes = [
```

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/pairlist_helpers.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/pairlist_helpers.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlist/rangestabilityfilter.py` & `freqtrade-2023.5/freqtrade/plugins/pairlist/rangestabilityfilter.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,23 +1,24 @@
 """
 Rate of change pairlist filter
 """
 import logging
 from copy import deepcopy
+from datetime import timedelta
 from typing import Any, Dict, List, Optional
 
-import arrow
 from cachetools import TTLCache
 from pandas import DataFrame
 
 from freqtrade.constants import Config, ListPairsWithTimeframes
 from freqtrade.exceptions import OperationalException
 from freqtrade.exchange.types import Tickers
 from freqtrade.misc import plural
 from freqtrade.plugins.pairlist.IPairList import IPairList
+from freqtrade.util import dt_floor_day, dt_now, dt_ts
 
 
 logger = logging.getLogger(__name__)
 
 
 class RangeStabilityFilter(IPairList):
 
@@ -67,18 +68,15 @@
         :param pairlist: pairlist to filter or sort
         :param tickers: Tickers (from exchange.get_tickers). May be cached.
         :return: new allowlist
         """
         needed_pairs: ListPairsWithTimeframes = [
             (p, '1d', self._def_candletype) for p in pairlist if p not in self._pair_cache]
 
-        since_ms = (arrow.utcnow()
-                         .floor('day')
-                         .shift(days=-self._days - 1)
-                         .int_timestamp) * 1000
+        since_ms = dt_ts(dt_floor_day(dt_now()) - timedelta(days=self._days - 1))
         # Get all candles
         candles = {}
         if needed_pairs:
             candles = self._exchange.refresh_latest_ohlcv(needed_pairs, since_ms=since_ms,
                                                           cache=False)
 
         if self._enabled:
```

### Comparing `freqtrade-2023.4/freqtrade/plugins/pairlistmanager.py` & `freqtrade-2023.5/freqtrade/plugins/pairlistmanager.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/protectionmanager.py` & `freqtrade-2023.5/freqtrade/plugins/protectionmanager.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/protections/cooldown_period.py` & `freqtrade-2023.5/freqtrade/plugins/protections/cooldown_period.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/protections/iprotection.py` & `freqtrade-2023.5/freqtrade/plugins/protections/iprotection.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/protections/low_profit_pairs.py` & `freqtrade-2023.5/freqtrade/plugins/protections/low_profit_pairs.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/protections/max_drawdown_protection.py` & `freqtrade-2023.5/freqtrade/plugins/protections/max_drawdown_protection.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/plugins/protections/stoploss_guard.py` & `freqtrade-2023.5/freqtrade/plugins/protections/stoploss_guard.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/resolvers/__init__.py` & `freqtrade-2023.5/freqtrade/resolvers/__init__.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/resolvers/exchange_resolver.py` & `freqtrade-2023.5/freqtrade/resolvers/exchange_resolver.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,52 +1,55 @@
 """
 This module loads custom exchanges
 """
 import logging
+from typing import Optional
 
 import freqtrade.exchange as exchanges
-from freqtrade.constants import Config
+from freqtrade.constants import Config, ExchangeConfig
 from freqtrade.exchange import MAP_EXCHANGE_CHILDCLASS, Exchange
 from freqtrade.resolvers import IResolver
 
 
 logger = logging.getLogger(__name__)
 
 
 class ExchangeResolver(IResolver):
     """
     This class contains all the logic to load a custom exchange class
     """
     object_type = Exchange
 
     @staticmethod
-    def load_exchange(exchange_name: str, config: Config, validate: bool = True,
-                      load_leverage_tiers: bool = False) -> Exchange:
+    def load_exchange(config: Config, *, exchange_config: Optional[ExchangeConfig] = None,
+                      validate: bool = True, load_leverage_tiers: bool = False) -> Exchange:
         """
         Load the custom class from config parameter
         :param exchange_name: name of the Exchange to load
         :param config: configuration dictionary
         """
+        exchange_name: str = config['exchange']['name']
         # Map exchange name to avoid duplicate classes for identical exchanges
         exchange_name = MAP_EXCHANGE_CHILDCLASS.get(exchange_name, exchange_name)
         exchange_name = exchange_name.title()
         exchange = None
         try:
             exchange = ExchangeResolver._load_exchange(
                 exchange_name,
                 kwargs={
                     'config': config,
                     'validate': validate,
+                    'exchange_config': exchange_config,
                     'load_leverage_tiers': load_leverage_tiers}
             )
         except ImportError:
             logger.info(
                 f"No {exchange_name} specific subclass found. Using the generic class instead.")
         if not exchange:
-            exchange = Exchange(config, validate=validate)
+            exchange = Exchange(config, validate=validate, exchange_config=exchange_config,)
         return exchange
 
     @staticmethod
     def _load_exchange(exchange_name: str, kwargs: dict) -> Exchange:
         """
         Loads the specified exchange.
         Only checks for exchanges exported in freqtrade.exchanges
```

### Comparing `freqtrade-2023.4/freqtrade/resolvers/freqaimodel_resolver.py` & `freqtrade-2023.5/freqtrade/resolvers/freqaimodel_resolver.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/resolvers/hyperopt_resolver.py` & `freqtrade-2023.5/freqtrade/resolvers/hyperopt_resolver.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/resolvers/iresolver.py` & `freqtrade-2023.5/freqtrade/resolvers/iresolver.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/resolvers/pairlist_resolver.py` & `freqtrade-2023.5/freqtrade/resolvers/pairlist_resolver.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/resolvers/protection_resolver.py` & `freqtrade-2023.5/freqtrade/resolvers/protection_resolver.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/resolvers/strategy_resolver.py` & `freqtrade-2023.5/freqtrade/resolvers/strategy_resolver.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/api_auth.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/api_auth.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/api_backtest.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/api_backtest.py`

 * *Files 17% similar despite different names*

```diff
@@ -4,44 +4,119 @@
 from datetime import datetime
 from typing import Any, Dict, List
 
 from fastapi import APIRouter, BackgroundTasks, Depends
 from fastapi.exceptions import HTTPException
 
 from freqtrade.configuration.config_validation import validate_config_consistency
+from freqtrade.constants import Config
 from freqtrade.data.btanalysis import get_backtest_resultlist, load_and_merge_backtest_result
 from freqtrade.enums import BacktestState
 from freqtrade.exceptions import DependencyException, OperationalException
+from freqtrade.exchange.common import remove_exchange_credentials
 from freqtrade.misc import deep_merge_dicts
 from freqtrade.rpc.api_server.api_schemas import (BacktestHistoryEntry, BacktestRequest,
                                                   BacktestResponse)
 from freqtrade.rpc.api_server.deps import get_config, is_webserver_mode
-from freqtrade.rpc.api_server.webserver import ApiServer
+from freqtrade.rpc.api_server.webserver_bgwork import ApiBG
 from freqtrade.rpc.rpc import RPCException
 
 
 logger = logging.getLogger(__name__)
 
 # Private API, protected by authentication
 router = APIRouter()
 
 
+def __run_backtest_bg(btconfig: Config):
+    from freqtrade.optimize.optimize_reports import generate_backtest_stats, store_backtest_stats
+    from freqtrade.resolvers import StrategyResolver
+    asyncio.set_event_loop(asyncio.new_event_loop())
+    try:
+        # Reload strategy
+        lastconfig = ApiBG.bt['last_config']
+        strat = StrategyResolver.load_strategy(btconfig)
+        validate_config_consistency(btconfig)
+
+        if (
+            not ApiBG.bt['bt']
+            or lastconfig.get('timeframe') != strat.timeframe
+            or lastconfig.get('timeframe_detail') != btconfig.get('timeframe_detail')
+            or lastconfig.get('timerange') != btconfig['timerange']
+        ):
+            from freqtrade.optimize.backtesting import Backtesting
+            ApiBG.bt['bt'] = Backtesting(btconfig)
+            ApiBG.bt['bt'].load_bt_data_detail()
+        else:
+            ApiBG.bt['bt'].config = btconfig
+            ApiBG.bt['bt'].init_backtest()
+        # Only reload data if timeframe changed.
+        if (
+            not ApiBG.bt['data']
+            or not ApiBG.bt['timerange']
+            or lastconfig.get('timeframe') != strat.timeframe
+            or lastconfig.get('timerange') != btconfig['timerange']
+        ):
+            ApiBG.bt['data'], ApiBG.bt['timerange'] = ApiBG.bt[
+                'bt'].load_bt_data()
+
+        lastconfig['timerange'] = btconfig['timerange']
+        lastconfig['timeframe'] = strat.timeframe
+        lastconfig['protections'] = btconfig.get('protections', [])
+        lastconfig['enable_protections'] = btconfig.get('enable_protections')
+        lastconfig['dry_run_wallet'] = btconfig.get('dry_run_wallet')
+
+        ApiBG.bt['bt'].enable_protections = btconfig.get('enable_protections', False)
+        ApiBG.bt['bt'].strategylist = [strat]
+        ApiBG.bt['bt'].results = {}
+        ApiBG.bt['bt'].load_prior_backtest()
+
+        ApiBG.bt['bt'].abort = False
+        if (ApiBG.bt['bt'].results and
+                strat.get_strategy_name() in ApiBG.bt['bt'].results['strategy']):
+            # When previous result hash matches - reuse that result and skip backtesting.
+            logger.info(f'Reusing result of previous backtest for {strat.get_strategy_name()}')
+        else:
+            min_date, max_date = ApiBG.bt['bt'].backtest_one_strategy(
+                strat, ApiBG.bt['data'], ApiBG.bt['timerange'])
+
+            ApiBG.bt['bt'].results = generate_backtest_stats(
+                ApiBG.bt['data'], ApiBG.bt['bt'].all_results,
+                min_date=min_date, max_date=max_date)
+
+        if btconfig.get('export', 'none') == 'trades':
+            store_backtest_stats(
+                btconfig['exportfilename'], ApiBG.bt['bt'].results,
+                datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
+                )
+
+        logger.info("Backtest finished.")
+
+    except (Exception, OperationalException, DependencyException) as e:
+        logger.exception(f"Backtesting caused an error: {e}")
+        ApiBG.bt['bt_error'] = str(e)
+        pass
+    finally:
+        ApiBG.bgtask_running = False
+
+
 @router.post('/backtest', response_model=BacktestResponse, tags=['webserver', 'backtest'])
-async def api_start_backtest(  # noqa: C901
+async def api_start_backtest(
         bt_settings: BacktestRequest, background_tasks: BackgroundTasks,
         config=Depends(get_config), ws_mode=Depends(is_webserver_mode)):
-    ApiServer._bt['bt_error'] = None
+    ApiBG.bt['bt_error'] = None
     """Start backtesting if not done so already"""
-    if ApiServer._bgtask_running:
+    if ApiBG.bgtask_running:
         raise RPCException('Bot Background task already running')
 
     if ':' in bt_settings.strategy:
         raise HTTPException(status_code=500, detail="base64 encoded strategies are not allowed.")
 
     btconfig = deepcopy(config)
+    remove_exchange_credentials(btconfig['exchange'], True)
     settings = dict(bt_settings)
     if settings.get('freqai', None) is not None:
         settings['freqai'] = dict(settings['freqai'])
     # Pydantic models will contain all keys, but non-provided ones are None
 
     btconfig = deep_merge_dicts(settings, btconfig, allow_null_overrides=False)
     try:
@@ -50,88 +125,17 @@
         pass
 
     # Force dry-run for backtesting
     btconfig['dry_run'] = True
 
     # Start backtesting
     # Initialize backtesting object
-    def run_backtest():
-        from freqtrade.optimize.optimize_reports import (generate_backtest_stats,
-                                                         store_backtest_stats)
-        from freqtrade.resolvers import StrategyResolver
-        asyncio.set_event_loop(asyncio.new_event_loop())
-        try:
-            # Reload strategy
-            lastconfig = ApiServer._bt['last_config']
-            strat = StrategyResolver.load_strategy(btconfig)
-            validate_config_consistency(btconfig)
-
-            if (
-                not ApiServer._bt['bt']
-                or lastconfig.get('timeframe') != strat.timeframe
-                or lastconfig.get('timeframe_detail') != btconfig.get('timeframe_detail')
-                or lastconfig.get('timerange') != btconfig['timerange']
-            ):
-                from freqtrade.optimize.backtesting import Backtesting
-                ApiServer._bt['bt'] = Backtesting(btconfig)
-                ApiServer._bt['bt'].load_bt_data_detail()
-            else:
-                ApiServer._bt['bt'].config = btconfig
-                ApiServer._bt['bt'].init_backtest()
-            # Only reload data if timeframe changed.
-            if (
-                not ApiServer._bt['data']
-                or not ApiServer._bt['timerange']
-                or lastconfig.get('timeframe') != strat.timeframe
-                or lastconfig.get('timerange') != btconfig['timerange']
-            ):
-                ApiServer._bt['data'], ApiServer._bt['timerange'] = ApiServer._bt[
-                    'bt'].load_bt_data()
-
-            lastconfig['timerange'] = btconfig['timerange']
-            lastconfig['timeframe'] = strat.timeframe
-            lastconfig['protections'] = btconfig.get('protections', [])
-            lastconfig['enable_protections'] = btconfig.get('enable_protections')
-            lastconfig['dry_run_wallet'] = btconfig.get('dry_run_wallet')
-
-            ApiServer._bt['bt'].enable_protections = btconfig.get('enable_protections', False)
-            ApiServer._bt['bt'].strategylist = [strat]
-            ApiServer._bt['bt'].results = {}
-            ApiServer._bt['bt'].load_prior_backtest()
-
-            ApiServer._bt['bt'].abort = False
-            if (ApiServer._bt['bt'].results and
-                    strat.get_strategy_name() in ApiServer._bt['bt'].results['strategy']):
-                # When previous result hash matches - reuse that result and skip backtesting.
-                logger.info(f'Reusing result of previous backtest for {strat.get_strategy_name()}')
-            else:
-                min_date, max_date = ApiServer._bt['bt'].backtest_one_strategy(
-                    strat, ApiServer._bt['data'], ApiServer._bt['timerange'])
-
-                ApiServer._bt['bt'].results = generate_backtest_stats(
-                    ApiServer._bt['data'], ApiServer._bt['bt'].all_results,
-                    min_date=min_date, max_date=max_date)
-
-            if btconfig.get('export', 'none') == 'trades':
-                store_backtest_stats(
-                    btconfig['exportfilename'], ApiServer._bt['bt'].results,
-                    datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
-                    )
-
-            logger.info("Backtest finished.")
-
-        except (Exception, OperationalException, DependencyException) as e:
-            logger.exception(f"Backtesting caused an error: {e}")
-            ApiServer._bt['bt_error'] = str(e)
-            pass
-        finally:
-            ApiServer._bgtask_running = False
 
-    background_tasks.add_task(run_backtest)
-    ApiServer._bgtask_running = True
+    background_tasks.add_task(__run_backtest_bg, btconfig=btconfig)
+    ApiBG.bgtask_running = True
 
     return {
         "status": "running",
         "running": True,
         "progress": 0,
         "step": str(BacktestState.STARTUP),
         "status_msg": "Backtest started",
@@ -141,90 +145,90 @@
 @router.get('/backtest', response_model=BacktestResponse, tags=['webserver', 'backtest'])
 def api_get_backtest(ws_mode=Depends(is_webserver_mode)):
     """
     Get backtesting result.
     Returns Result after backtesting has been ran.
     """
     from freqtrade.persistence import LocalTrade
-    if ApiServer._bgtask_running:
+    if ApiBG.bgtask_running:
         return {
             "status": "running",
             "running": True,
-            "step": (ApiServer._bt['bt'].progress.action if ApiServer._bt['bt']
+            "step": (ApiBG.bt['bt'].progress.action if ApiBG.bt['bt']
                      else str(BacktestState.STARTUP)),
-            "progress": ApiServer._bt['bt'].progress.progress if ApiServer._bt['bt'] else 0,
+            "progress": ApiBG.bt['bt'].progress.progress if ApiBG.bt['bt'] else 0,
             "trade_count": len(LocalTrade.trades),
             "status_msg": "Backtest running",
         }
 
-    if not ApiServer._bt['bt']:
+    if not ApiBG.bt['bt']:
         return {
             "status": "not_started",
             "running": False,
             "step": "",
             "progress": 0,
             "status_msg": "Backtest not yet executed"
         }
-    if ApiServer._bt['bt_error']:
+    if ApiBG.bt['bt_error']:
         return {
             "status": "error",
             "running": False,
             "step": "",
             "progress": 0,
-            "status_msg": f"Backtest failed with {ApiServer._bt['bt_error']}"
+            "status_msg": f"Backtest failed with {ApiBG.bt['bt_error']}"
         }
 
     return {
         "status": "ended",
         "running": False,
         "status_msg": "Backtest ended",
         "step": "finished",
         "progress": 1,
-        "backtest_result": ApiServer._bt['bt'].results,
+        "backtest_result": ApiBG.bt['bt'].results,
     }
 
 
 @router.delete('/backtest', response_model=BacktestResponse, tags=['webserver', 'backtest'])
 def api_delete_backtest(ws_mode=Depends(is_webserver_mode)):
     """Reset backtesting"""
-    if ApiServer._bgtask_running:
+    if ApiBG.bgtask_running:
         return {
             "status": "running",
             "running": True,
             "step": "",
             "progress": 0,
             "status_msg": "Backtest running",
         }
-    if ApiServer._bt['bt']:
-        ApiServer._bt['bt'].cleanup()
-        del ApiServer._bt['bt']
-        ApiServer._bt['bt'] = None
-        del ApiServer._bt['data']
-        ApiServer._bt['data'] = None
+    if ApiBG.bt['bt']:
+        ApiBG.bt['bt'].cleanup()
+        del ApiBG.bt['bt']
+        ApiBG.bt['bt'] = None
+        del ApiBG.bt['data']
+        ApiBG.bt['data'] = None
         logger.info("Backtesting reset")
     return {
         "status": "reset",
         "running": False,
         "step": "",
         "progress": 0,
         "status_msg": "Backtest reset",
     }
 
 
 @router.get('/backtest/abort', response_model=BacktestResponse, tags=['webserver', 'backtest'])
 def api_backtest_abort(ws_mode=Depends(is_webserver_mode)):
-    if not ApiServer._bgtask_running:
+    if not ApiBG.bgtask_running:
         return {
             "status": "not_running",
             "running": False,
             "step": "",
             "progress": 0,
             "status_msg": "Backtest ended",
         }
-    ApiServer._bt['bt'].abort = True
+    ApiBG.bt['bt'].abort = True
     return {
         "status": "stopping",
         "running": False,
         "step": "",
         "progress": 0,
         "status_msg": "Backtest ended",
     }
```

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/api_schemas.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/api_schemas.py`

 * *Files 2% similar despite different names*

```diff
@@ -32,28 +32,33 @@
 
 
 class Balance(BaseModel):
     currency: str
     free: float
     balance: float
     used: float
+    bot_owned: Optional[float]
     est_stake: float
+    est_stake_bot: Optional[float]
     stake: str
     # Starting with 2.x
     side: str
     leverage: float
     is_position: bool
     position: float
+    is_bot_managed: bool
 
 
 class Balances(BaseModel):
     currencies: List[Balance]
     total: float
+    total_bot: float
     symbol: str
     value: float
+    value_bot: float
     stake: str
     note: str
     starting_capital: float
     starting_capital_ratio: float
     starting_capital_pct: float
     starting_capital_fiat: float
     starting_capital_fiat_ratio: float
@@ -91,16 +96,18 @@
     profit_all_ratio_sum: float
     profit_all_percent: float
     profit_all_ratio: float
     profit_all_fiat: float
     trade_count: int
     closed_trade_count: int
     first_trade_date: str
+    first_trade_humanized: str
     first_trade_timestamp: int
     latest_trade_date: str
+    latest_trade_humanized: str
     latest_trade_timestamp: int
     avg_duration: str
     best_pair: str
     best_rate: float
     best_pair_profit_ratio: float
     winning_trades: int
     losing_trades: int
```

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/api_v1.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/api_v1.py`

 * *Files 8% similar despite different names*

```diff
@@ -39,15 +39,18 @@
 # 2.17: Forceentry - leverage, partial force_exit
 # 2.20: Add websocket endpoints
 # 2.21: Add new_candle messagetype
 # 2.22: Add FreqAI to backtesting
 # 2.23: Allow plot config request in webserver mode
 # 2.24: Add cancel_open_order endpoint
 # 2.25: Add several profit values to /status endpoint
-API_VERSION = 2.25
+# 2.26: increase /balance output
+# 2.27: Add /trades/<id>/reload endpoint
+# 2.28: Switch reload endpoint to Post
+API_VERSION = 2.28
 
 # Public API, requires no auth.
 router_public = APIRouter()
 # Private API, protected by authentication
 router = APIRouter()
 
 
@@ -122,19 +125,25 @@
 
 @router.delete('/trades/{tradeid}', response_model=DeleteTrade, tags=['info', 'trading'])
 def trades_delete(tradeid: int, rpc: RPC = Depends(get_rpc)):
     return rpc._rpc_delete(tradeid)
 
 
 @router.delete('/trades/{tradeid}/open-order', response_model=OpenTradeSchema,  tags=['trading'])
-def cancel_open_order(tradeid: int, rpc: RPC = Depends(get_rpc)):
+def trade_cancel_open_order(tradeid: int, rpc: RPC = Depends(get_rpc)):
     rpc._rpc_cancel_open_order(tradeid)
     return rpc._rpc_trade_status([tradeid])[0]
 
 
+@router.post('/trades/{tradeid}/reload', response_model=OpenTradeSchema,  tags=['trading'])
+def trade_reload(tradeid: int, rpc: RPC = Depends(get_rpc)):
+    rpc._rpc_reload_trade_from_exchange(tradeid)
+    return rpc._rpc_trade_status([tradeid])[0]
+
+
 # TODO: Missing response model
 @router.get('/edge', tags=['info'])
 def edge(rpc: RPC = Depends(get_rpc)):
     return rpc._rpc_edge()
 
 
 @router.get('/show_config', response_model=ShowConfig, tags=['info'])
@@ -242,22 +251,25 @@
 def pair_candles(
         pair: str, timeframe: str, limit: Optional[int] = None, rpc: RPC = Depends(get_rpc)):
     return rpc._rpc_analysed_dataframe(pair, timeframe, limit)
 
 
 @router.get('/pair_history', response_model=PairHistory, tags=['candle data'])
 def pair_history(pair: str, timeframe: str, timerange: str, strategy: str,
+                 freqaimodel: Optional[str] = None,
                  config=Depends(get_config), exchange=Depends(get_exchange)):
     # The initial call to this endpoint can be slow, as it may need to initialize
     # the exchange class.
     config = deepcopy(config)
     config.update({
         'strategy': strategy,
+        'timerange': timerange,
+        'freqaimodel': freqaimodel if freqaimodel else config.get('freqaimodel'),
     })
-    return RPC._rpc_analysed_history_full(config, pair, timeframe, timerange, exchange)
+    return RPC._rpc_analysed_history_full(config, pair, timeframe, exchange)
 
 
 @router.get('/plot_config', response_model=PlotConfig, tags=['candle data'])
 def plot_config(strategy: Optional[str] = None, config=Depends(get_config),
                 rpc: Optional[RPC] = Depends(get_rpc_optional)):
     if not strategy:
         if not rpc:
```

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/api_ws.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/api_ws.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/deps.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/deps.py`

 * *Files 6% similar despite different names*

```diff
@@ -2,14 +2,15 @@
 from uuid import uuid4
 
 from fastapi import Depends
 
 from freqtrade.enums import RunMode
 from freqtrade.persistence import Trade
 from freqtrade.persistence.models import _request_id_ctx_var
+from freqtrade.rpc.api_server.webserver_bgwork import ApiBG
 from freqtrade.rpc.rpc import RPC, RPCException
 
 from .webserver import ApiServer
 
 
 def get_rpc_optional() -> Optional[RPC]:
     if ApiServer._has_rpc:
@@ -39,19 +40,19 @@
 
 
 def get_api_config() -> Dict[str, Any]:
     return ApiServer._config['api_server']
 
 
 def get_exchange(config=Depends(get_config)):
-    if not ApiServer._exchange:
+    if not ApiBG.exchange:
         from freqtrade.resolvers import ExchangeResolver
-        ApiServer._exchange = ExchangeResolver.load_exchange(
-            config['exchange']['name'], config, load_leverage_tiers=False)
-    return ApiServer._exchange
+        ApiBG.exchange = ExchangeResolver.load_exchange(
+            config, load_leverage_tiers=False)
+    return ApiBG.exchange
 
 
 def get_message_stream():
     return ApiServer._message_stream
 
 
 def is_webserver_mode(config=Depends(get_config)):
```

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/ui/fallback_file.html` & `freqtrade-2023.5/freqtrade/rpc/api_server/ui/fallback_file.html`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/ui/favicon.ico` & `freqtrade-2023.5/freqtrade/rpc/api_server/ui/favicon.ico`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/uvicorn_threaded.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/uvicorn_threaded.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/web_ui.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/web_ui.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/webserver.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/webserver.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 import logging
 from ipaddress import IPv4Address
-from typing import Any, Dict, Optional
+from typing import Any, Optional
 
 import orjson
 import uvicorn
 from fastapi import Depends, FastAPI
 from fastapi.middleware.cors import CORSMiddleware
 from starlette.responses import JSONResponse
 
@@ -32,27 +32,16 @@
 
 class ApiServer(RPCHandler):
 
     __instance = None
     __initialized = False
 
     _rpc: RPC
-    # Backtesting type: Backtesting
-    _bt: Dict[str, Any] = {
-        'bt': None,
-        'data': None,
-        'timerange': None,
-        'last_config': {},
-        'bt_error': None,
-    }
     _has_rpc: bool = False
-    _bgtask_running: bool = False
     _config: Config = {}
-    # Exchange - only available in webserver mode.
-    _exchange = None
     # websocket message stuff
     _message_stream: Optional[MessageStream] = None
 
     def __new__(cls, *args, **kwargs):
         """
         This class is a singleton.
         We'll only have one instance of it around.
@@ -81,15 +70,15 @@
         self.configure_app(self.app, self._config)
         self.start_api()
 
     def add_rpc_handler(self, rpc: RPC):
         """
         Attach rpc handler
         """
-        if not self._has_rpc:
+        if not ApiServer._has_rpc:
             ApiServer._rpc = rpc
             ApiServer._has_rpc = True
         else:
             # This should not happen assuming we didn't mess up.
             raise OperationalException('RPC Handler already attached.')
 
     def cleanup(self) -> None:
```

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/ws/channel.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/ws/channel.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/ws/message_stream.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/ws/message_stream.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/ws/proxy.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/ws/proxy.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/ws/serializer.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/ws/serializer.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/api_server/ws_schemas.py` & `freqtrade-2023.5/freqtrade/rpc/api_server/ws_schemas.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/discord.py` & `freqtrade-2023.5/freqtrade/rpc/discord.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/external_message_consumer.py` & `freqtrade-2023.5/freqtrade/rpc/external_message_consumer.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/fiat_convert.py` & `freqtrade-2023.5/freqtrade/rpc/fiat_convert.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/rpc.py` & `freqtrade-2023.5/freqtrade/rpc/rpc.py`

 * *Files 2% similar despite different names*

```diff
@@ -3,15 +3,14 @@
 """
 import logging
 from abc import abstractmethod
 from datetime import date, datetime, timedelta, timezone
 from math import isnan
 from typing import Any, Dict, Generator, List, Optional, Sequence, Tuple, Union
 
-import arrow
 import psutil
 from dateutil.relativedelta import relativedelta
 from dateutil.tz import tzlocal
 from numpy import NAN, inf, int64, mean
 from pandas import DataFrame, NaT
 from sqlalchemy import func, select
 
@@ -22,20 +21,21 @@
 from freqtrade.data.metrics import calculate_max_drawdown
 from freqtrade.enums import (CandleType, ExitCheckTuple, ExitType, MarketDirection, SignalDirection,
                              State, TradingMode)
 from freqtrade.exceptions import ExchangeError, PricingError
 from freqtrade.exchange import timeframe_to_minutes, timeframe_to_msecs
 from freqtrade.exchange.types import Tickers
 from freqtrade.loggers import bufferHandler
-from freqtrade.misc import decimals_per_coin, shorten_date
+from freqtrade.misc import decimals_per_coin
 from freqtrade.persistence import KeyStoreKeys, KeyValueStore, Order, PairLocks, Trade
 from freqtrade.persistence.models import PairLock
 from freqtrade.plugins.pairlist.pairlist_helpers import expand_pairlist
 from freqtrade.rpc.fiat_convert import CryptoToFiatConverter
 from freqtrade.rpc.rpc_types import RPCSendMsg
+from freqtrade.util import dt_humanize, dt_now, shorten_date
 from freqtrade.wallets import PositionWallet, Wallet
 
 
 logger = logging.getLogger(__name__)
 
 
 class RPCException(Exception):
@@ -288,15 +288,15 @@
 
                 detail_trade = [
                     f'{trade.id} {direction_str}',
                     trade.pair + ('*' if (open_order
                                   and open_order.ft_order_side == trade.entry_side) else '')
                     + ('**' if (open_order and
                                 open_order.ft_order_side == trade.exit_side is not None) else ''),
-                    shorten_date(arrow.get(trade.open_date).humanize(only_distance=True)),
+                    shorten_date(dt_humanize(trade.open_date, only_distance=True)),
                     profit_str
                 ]
                 if self._config.get('position_adjustment_enable', False):
                     max_entry_str = ''
                     if self._config.get('max_entry_position_adjustment', -1) > 0:
                         max_entry_str = f"/{self._config['max_entry_position_adjustment'] + 1}"
                     filled_entries = trade.nr_of_successful_entries
@@ -416,24 +416,23 @@
             if trade.close_profit > 0:
                 return 'wins'
             elif trade.close_profit < 0:
                 return 'losses'
             else:
                 return 'draws'
         trades = Trade.get_trades([Trade.is_open.is_(False)], include_orders=False)
-        # Sell reason
+        # Duration
+        dur: Dict[str, List[float]] = {'wins': [], 'draws': [], 'losses': []}
+        # Exit reason
         exit_reasons = {}
         for trade in trades:
             if trade.exit_reason not in exit_reasons:
                 exit_reasons[trade.exit_reason] = {'wins': 0, 'losses': 0, 'draws': 0}
             exit_reasons[trade.exit_reason][trade_win_loss(trade)] += 1
 
-        # Duration
-        dur: Dict[str, List[float]] = {'wins': [], 'draws': [], 'losses': []}
-        for trade in trades:
             if trade.close_date is not None and trade.open_date is not None:
                 trade_dur = (trade.close_date - trade.open_date).total_seconds()
                 dur[trade_win_loss(trade)].append(trade_dur)
 
         wins_dur = sum(dur['wins']) / len(dur['wins']) if len(dur['wins']) > 0 else None
         draws_dur = sum(dur['draws']) / len(dur['draws']) if len(dur['draws']) > 0 else None
         losses_dur = sum(dur['losses']) / len(dur['losses']) if len(dur['losses']) > 0 else None
@@ -537,16 +536,16 @@
 
         profit_all_fiat = self._fiat_converter.convert_amount(
             profit_all_coin_sum,
             stake_currency,
             fiat_display_currency
         ) if self._fiat_converter else 0
 
-        first_date = trades[0].open_date if trades else None
-        last_date = trades[-1].open_date if trades else None
+        first_date = trades[0].open_date_utc if trades else None
+        last_date = trades[-1].open_date_utc if trades else None
         num = float(len(durations) or 1)
         bot_start = KeyValueStore.get_datetime_value(KeyStoreKeys.BOT_START_TIME)
         return {
             'profit_closed_coin': profit_closed_coin_sum,
             'profit_closed_percent_mean': round(profit_closed_ratio_mean * 100, 2),
             'profit_closed_ratio_mean': profit_closed_ratio_mean,
             'profit_closed_percent_sum': round(profit_closed_ratio_sum * 100, 2),
@@ -560,17 +559,19 @@
             'profit_all_percent_sum': round(profit_all_ratio_sum * 100, 2),
             'profit_all_ratio_sum': profit_all_ratio_sum,
             'profit_all_ratio': profit_all_ratio_fromstart,
             'profit_all_percent': round(profit_all_ratio_fromstart * 100, 2),
             'profit_all_fiat': profit_all_fiat,
             'trade_count': len(trades),
             'closed_trade_count': len([t for t in trades if not t.is_open]),
-            'first_trade_date': arrow.get(first_date).humanize() if first_date else '',
+            'first_trade_date': first_date.strftime(DATETIME_PRINT_FORMAT) if first_date else '',
+            'first_trade_humanized': dt_humanize(first_date) if first_date else '',
             'first_trade_timestamp': int(first_date.timestamp() * 1000) if first_date else 0,
-            'latest_trade_date': arrow.get(last_date).humanize() if last_date else '',
+            'latest_trade_date': last_date.strftime(DATETIME_PRINT_FORMAT) if last_date else '',
+            'latest_trade_humanized': dt_humanize(last_date) if last_date else '',
             'latest_trade_timestamp': int(last_date.timestamp() * 1000) if last_date else 0,
             'avg_duration': str(timedelta(seconds=sum(durations) / num)).split('.')[0],
             'best_pair': best_pair[0] if best_pair else '',
             'best_rate': round(best_pair[1] * 100, 2) if best_pair else 0,  # Deprecated
             'best_pair_profit_ratio': best_pair[1] if best_pair else 0,
             'winning_trades': winning_trades,
             'losing_trades': losing_trades,
@@ -579,91 +580,110 @@
             'max_drawdown_abs': max_drawdown_abs,
             'trading_volume': trading_volume,
             'bot_start_timestamp': int(bot_start.timestamp() * 1000) if bot_start else 0,
             'bot_start_date': bot_start.strftime(DATETIME_PRINT_FORMAT) if bot_start else '',
         }
 
     def __balance_get_est_stake(
-            self, coin: str, stake_currency: str, balance: Wallet, tickers) -> float:
+            self, coin: str, stake_currency: str, amount: float,
+            balance: Wallet, tickers) -> Tuple[float, float]:
         est_stake = 0.0
+        est_bot_stake = 0.0
         if coin == stake_currency:
             est_stake = balance.total
             if self._config.get('trading_mode', TradingMode.SPOT) != TradingMode.SPOT:
                 # in Futures, "total" includes the locked stake, and therefore all positions
                 est_stake = balance.free
+            est_bot_stake = amount
         else:
             try:
                 pair = self._freqtrade.exchange.get_valid_pair_combination(coin, stake_currency)
                 rate: Optional[float] = tickers.get(pair, {}).get('last', None)
                 if rate:
                     if pair.startswith(stake_currency) and not pair.endswith(stake_currency):
                         rate = 1.0 / rate
                     est_stake = rate * balance.total
+                    est_bot_stake = rate * amount
             except (ExchangeError):
                 logger.warning(f"Could not get rate for pair {coin}.")
                 raise ValueError()
 
-        return est_stake
+        return est_stake, est_bot_stake
 
     def _rpc_balance(self, stake_currency: str, fiat_display_currency: str) -> Dict:
         """ Returns current account balance per crypto """
         currencies: List[Dict] = []
         total = 0.0
         total_bot = 0.0
         try:
             tickers: Tickers = self._freqtrade.exchange.get_tickers(cached=True)
         except (ExchangeError):
             raise RPCException('Error getting current tickers.')
 
         open_trades: List[Trade] = Trade.get_open_trades()
-        open_assets = [t.base_currency for t in open_trades]
+        open_assets: Dict[str, Trade] = {t.safe_base_currency: t for t in open_trades}
         self._freqtrade.wallets.update(require_update=False)
         starting_capital = self._freqtrade.wallets.get_starting_balance()
         starting_cap_fiat = self._fiat_converter.convert_amount(
             starting_capital, stake_currency, fiat_display_currency) if self._fiat_converter else 0
         coin: str
         balance: Wallet
         for coin, balance in self._freqtrade.wallets.get_all_balances().items():
             if not balance.total:
                 continue
+
+            trade = open_assets.get(coin, None)
+            is_bot_managed = coin == stake_currency or trade is not None
+            trade_amount = trade.amount if trade else 0
+            if coin == stake_currency:
+                trade_amount = self._freqtrade.wallets.get_available_stake_amount()
+
             try:
-                est_stake = self.__balance_get_est_stake(coin, stake_currency, balance, tickers)
+                est_stake, est_stake_bot = self.__balance_get_est_stake(
+                    coin, stake_currency, trade_amount, balance, tickers)
             except ValueError:
                 continue
 
             total += est_stake
-            if coin == stake_currency or coin in open_assets:
-                total_bot += est_stake
+
+            if is_bot_managed:
+                total_bot += est_stake_bot
             currencies.append({
                 'currency': coin,
                 'free': balance.free,
                 'balance': balance.total,
                 'used': balance.used,
+                'bot_owned': trade_amount,
                 'est_stake': est_stake or 0,
+                'est_stake_bot': est_stake_bot if is_bot_managed else 0,
                 'stake': stake_currency,
                 'side': 'long',
                 'leverage': 1,
                 'position': 0,
+                'is_bot_managed': is_bot_managed,
                 'is_position': False,
             })
         symbol: str
         position: PositionWallet
         for symbol, position in self._freqtrade.wallets.get_all_positions().items():
             total += position.collateral
+            total_bot += position.collateral
 
             currencies.append({
                 'currency': symbol,
                 'free': 0,
                 'balance': 0,
                 'used': 0,
                 'position': position.position,
                 'est_stake': position.collateral,
+                'est_stake_bot': position.collateral,
                 'stake': stake_currency,
                 'leverage': position.leverage,
                 'side': position.side,
+                'is_bot_managed': True,
                 'is_position': True
             })
 
         value = self._fiat_converter.convert_amount(
             total, stake_currency, fiat_display_currency) if self._fiat_converter else 0
         value_bot = self._fiat_converter.convert_amount(
             total_bot, stake_currency, fiat_display_currency) if self._fiat_converter else 0
@@ -671,16 +691,18 @@
         trade_count = len(Trade.get_trades_proxy())
         starting_capital_ratio = (total_bot / starting_capital) - 1 if starting_capital else 0.0
         starting_cap_fiat_ratio = (value_bot / starting_cap_fiat) - 1 if starting_cap_fiat else 0.0
 
         return {
             'currencies': currencies,
             'total': total,
+            'total_bot': total_bot,
             'symbol': fiat_display_currency,
             'value': value,
+            'value_bot': value_bot,
             'stake': stake_currency,
             'starting_capital': starting_capital,
             'starting_capital_ratio': starting_capital_ratio,
             'starting_capital_pct': round(starting_capital_ratio * 100, 2),
             'starting_capital_fiat': starting_cap_fiat,
             'starting_capital_fiat_ratio': starting_cap_fiat_ratio,
             'starting_capital_fiat_pct': round(starting_cap_fiat_ratio * 100, 2),
@@ -716,14 +738,26 @@
         if self._freqtrade.state == State.RUNNING:
             # Set 'max_open_trades' to 0
             self._freqtrade.config['max_open_trades'] = 0
             self._freqtrade.strategy.max_open_trades = 0
 
         return {'status': 'No more entries will occur from now. Run /reload_config to reset.'}
 
+    def _rpc_reload_trade_from_exchange(self, trade_id: int) -> Dict[str, str]:
+        """
+        Handler for reload_trade_from_exchange.
+        Reloads a trade from it's orders, should manual interaction have happened.
+        """
+        trade = Trade.get_trades(trade_filter=[Trade.id == trade_id]).first()
+        if not trade:
+            raise RPCException(f"Could not find trade with id {trade_id}.")
+
+        self._freqtrade.handle_onexchange_order(trade)
+        return {'status': 'Reloaded from orders from exchange'}
+
     def __exec_force_exit(self, trade: Trade, ordertype: Optional[str],
                           amount: Optional[float] = None) -> None:
         # Check if there is there is an open order
         fully_canceled = False
         if trade.open_order_id:
             order = self._freqtrade.exchange.fetch_order(trade.open_order_id, trade.pair)
 
@@ -1191,37 +1225,38 @@
 
     def _ws_request_whitelist(self):
         """ Whitelist data for WebSocket """
         return self._freqtrade.active_pair_whitelist
 
     @staticmethod
     def _rpc_analysed_history_full(config: Config, pair: str, timeframe: str,
-                                   timerange: str, exchange) -> Dict[str, Any]:
-        timerange_parsed = TimeRange.parse_timerange(timerange)
+                                   exchange) -> Dict[str, Any]:
+        timerange_parsed = TimeRange.parse_timerange(config.get('timerange'))
 
         _data = load_data(
             datadir=config["datadir"],
             pairs=[pair],
             timeframe=timeframe,
             timerange=timerange_parsed,
             data_format=config.get('dataformat_ohlcv', 'json'),
             candle_type=config.get('candle_type_def', CandleType.SPOT)
         )
         if pair not in _data:
-            raise RPCException(f"No data for {pair}, {timeframe} in {timerange} found.")
+            raise RPCException(
+                f"No data for {pair}, {timeframe} in {config.get('timerange')} found.")
         from freqtrade.data.dataprovider import DataProvider
         from freqtrade.resolvers.strategy_resolver import StrategyResolver
         strategy = StrategyResolver.load_strategy(config)
         strategy.dp = DataProvider(config, exchange=exchange, pairlists=None)
         strategy.ft_bot_start()
 
         df_analyzed = strategy.analyze_ticker(_data[pair], {'pair': pair})
 
         return RPC._convert_dataframe_to_dict(strategy.get_strategy_name(), pair, timeframe,
-                                              df_analyzed, arrow.Arrow.utcnow().datetime)
+                                              df_analyzed, dt_now())
 
     def _rpc_plot_config(self) -> Dict[str, Any]:
         if (self._freqtrade.strategy.plot_config and
                 'subplots' not in self._freqtrade.strategy.plot_config):
             self._freqtrade.strategy.plot_config['subplots'] = {}
         return self._freqtrade.strategy.plot_config
```

### Comparing `freqtrade-2023.4/freqtrade/rpc/rpc_manager.py` & `freqtrade-2023.5/freqtrade/rpc/rpc_manager.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/rpc_types.py` & `freqtrade-2023.5/freqtrade/rpc/rpc_types.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/rpc/telegram.py` & `freqtrade-2023.5/freqtrade/rpc/telegram.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,40 +1,46 @@
 # pragma pylint: disable=unused-argument, unused-variable, protected-access, invalid-name
 
 """
 This module manage Telegram communication
 """
+import asyncio
 import json
 import logging
 import re
 from copy import deepcopy
 from dataclasses import dataclass
 from datetime import date, datetime, timedelta
 from functools import partial
 from html import escape
 from itertools import chain
 from math import isnan
-from typing import Any, Callable, Dict, List, Optional, Union
+from threading import Thread
+from typing import Any, Callable, Coroutine, Dict, List, Optional, Union
 
-import arrow
 from tabulate import tabulate
-from telegram import (MAX_MESSAGE_LENGTH, CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup,
-                      KeyboardButton, ParseMode, ReplyKeyboardMarkup, Update)
+from telegram import (CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup, KeyboardButton,
+                      ReplyKeyboardMarkup, Update)
+from telegram.constants import MessageLimit, ParseMode
 from telegram.error import BadRequest, NetworkError, TelegramError
-from telegram.ext import CallbackContext, CallbackQueryHandler, CommandHandler, Updater
-from telegram.utils.helpers import escape_markdown
+from telegram.ext import Application, CallbackContext, CallbackQueryHandler, CommandHandler
+from telegram.helpers import escape_markdown
 
 from freqtrade.__init__ import __version__
 from freqtrade.constants import DUST_PER_COIN, Config
 from freqtrade.enums import MarketDirection, RPCMessageType, SignalDirection, TradingMode
 from freqtrade.exceptions import OperationalException
 from freqtrade.misc import chunks, plural, round_coin_value
 from freqtrade.persistence import Trade
 from freqtrade.rpc import RPC, RPCException, RPCHandler
 from freqtrade.rpc.rpc_types import RPCSendMsg
+from freqtrade.util import dt_humanize
+
+
+MAX_MESSAGE_LENGTH = MessageLimit.MAX_TEXT_LENGTH
 
 
 logger = logging.getLogger(__name__)
 
 logger.debug('Included module rpc.telegram ...')
 
 
@@ -43,22 +49,22 @@
     header: str
     message: str
     message2: str
     callback: str
     default: int
 
 
-def authorized_only(command_handler: Callable[..., None]) -> Callable[..., Any]:
+def authorized_only(command_handler: Callable[..., Coroutine[Any, Any, None]]):
     """
     Decorator to check if the message comes from the correct chat_id
     :param command_handler: Telegram CommandHandler
     :return: decorated function
     """
 
-    def wrapper(self, *args, **kwargs):
+    async def wrapper(self, *args, **kwargs):
         """ Decorator logic """
         update = kwargs.get('update') or args[0]
 
         # Reject unauthorized messages
         if update.callback_query:
             cchat_id = int(update.callback_query.message.chat.id)
         else:
@@ -72,17 +78,17 @@
         Trade.rollback()
         logger.debug(
             'Executing handler: %s for chat_id: %s',
             command_handler.__name__,
             chat_id
         )
         try:
-            return command_handler(self, *args, **kwargs)
+            return await command_handler(self, *args, **kwargs)
         except RPCException as e:
-            self._send_msg(str(e))
+            await self._send_msg(str(e))
         except BaseException:
             logger.exception('Exception occurred within Telegram module')
         finally:
             Trade.session.remove()
 
     return wrapper
 
@@ -95,17 +101,25 @@
         Init the Telegram call, and init the super class RPCHandler
         :param rpc: instance of RPC Helper class
         :param config: Configuration object
         :return: None
         """
         super().__init__(rpc, config)
 
-        self._updater: Updater
+        self._app: Application
+        self._loop: asyncio.AbstractEventLoop
         self._init_keyboard()
-        self._init()
+        self._start_thread()
+
+    def _start_thread(self):
+        """
+        Creates and starts the polling thread
+        """
+        self._thread = Thread(target=self._init, name='FTTelegram')
+        self._thread.start()
 
     def _init_keyboard(self) -> None:
         """
         Validates the keyboard configuration from telegram config
         section.
         """
         self._keyboard: List[List[Union[str, KeyboardButton]]] = [
@@ -148,35 +162,45 @@
                            f'\nvalid commands are: {valid_keys_print}')
                 raise OperationalException(err_msg)
             else:
                 self._keyboard = cust_keyboard
                 logger.info('using custom keyboard from '
                             f'config.json: {self._keyboard}')
 
+    def _init_telegram_app(self):
+        return Application.builder().token(self._config['telegram']['token']).build()
+
     def _init(self) -> None:
         """
         Initializes this module with the given config,
         registers all known command handlers
         and starts polling for message updates
+        Runs in a separate thread.
         """
-        self._updater = Updater(token=self._config['telegram']['token'], workers=0,
-                                use_context=True)
+        try:
+            self._loop = asyncio.get_running_loop()
+        except RuntimeError:
+            self._loop = asyncio.new_event_loop()
+            asyncio.set_event_loop(self._loop)
+
+        self._app = self._init_telegram_app()
 
         # Register command handler and start telegram message polling
         handles = [
             CommandHandler('status', self._status),
             CommandHandler('profit', self._profit),
             CommandHandler('balance', self._balance),
             CommandHandler('start', self._start),
             CommandHandler('stop', self._stop),
             CommandHandler(['forcesell', 'forceexit', 'fx'], self._force_exit),
             CommandHandler(['forcebuy', 'forcelong'], partial(
                 self._force_enter, order_side=SignalDirection.LONG)),
             CommandHandler('forceshort', partial(
                 self._force_enter, order_side=SignalDirection.SHORT)),
+            CommandHandler('reload_trade', self._reload_trade_from_exchange),
             CommandHandler('trades', self._trades),
             CommandHandler('delete', self._delete_trade),
             CommandHandler(['coo', 'cancel_open_order'], self._cancel_open_order),
             CommandHandler('performance', self._performance),
             CommandHandler(['buys', 'entries'], self._enter_tag_performance),
             CommandHandler(['sells', 'exits'], self._exit_reason_performance),
             CommandHandler('mix_tags', self._mix_tag_performance),
@@ -214,37 +238,55 @@
                                  pattern='update_exit_reason_performance'),
             CallbackQueryHandler(self._mix_tag_performance, pattern='update_mix_tag_performance'),
             CallbackQueryHandler(self._count, pattern='update_count'),
             CallbackQueryHandler(self._force_exit_inline, pattern=r"force_exit__\S+"),
             CallbackQueryHandler(self._force_enter_inline, pattern=r"\S+\/\S+"),
         ]
         for handle in handles:
-            self._updater.dispatcher.add_handler(handle)
+            self._app.add_handler(handle)
 
         for callback in callbacks:
-            self._updater.dispatcher.add_handler(callback)
+            self._app.add_handler(callback)
 
-        self._updater.start_polling(
-            bootstrap_retries=-1,
-            timeout=20,
-            read_latency=60,  # Assumed transmission latency
-            drop_pending_updates=True,
-        )
         logger.info(
             'rpc.telegram is listening for following commands: %s',
-            [h.command for h in handles]
+            [[x for x in sorted(h.commands)] for h in handles]
         )
+        self._loop.run_until_complete(self._startup_telegram())
+
+    async def _startup_telegram(self) -> None:
+        await self._app.initialize()
+        await self._app.start()
+        if self._app.updater:
+            await self._app.updater.start_polling(
+                bootstrap_retries=-1,
+                timeout=20,
+                # read_latency=60,  # Assumed transmission latency
+                drop_pending_updates=True,
+                # stop_signals=[],  # Necessary as we don't run on the main thread
+            )
+            while True:
+                await asyncio.sleep(10)
+                if not self._app.updater.running:
+                    break
+
+    async def _cleanup_telegram(self) -> None:
+        if self._app.updater:
+            await self._app.updater.stop()
+        await self._app.stop()
+        await self._app.shutdown()
 
     def cleanup(self) -> None:
         """
         Stops all running telegram threads.
         :return: None
         """
         # This can take up to `timeout` from the call to `start_polling`.
-        self._updater.stop()
+        asyncio.run_coroutine_threadsafe(self._cleanup_telegram(), self._loop)
+        self._thread.join()
 
     def _exchange_from_msg(self, msg: Dict[str, Any]) -> str:
         """
         Extracts the exchange name from the given message.
         :param msg: The message to extract the exchange name from.
         :return: The exchange name.
         """
@@ -449,15 +491,17 @@
         if noti == 'off':
             logger.info(f"Notification '{msg_type}' not sent.")
             # Notification disabled
             return
 
         message = self.compose_message(deepcopy(msg), msg_type)  # type: ignore
         if message:
-            self._send_msg(message, disable_notification=(noti == 'silent'))
+            asyncio.run_coroutine_threadsafe(
+                self._send_msg(message, disable_notification=(noti == 'silent')),
+                self._loop)
 
     def _get_sell_emoji(self, msg):
         """
         Get emoji for sell-side
         """
 
         if float(msg['profit_percent']) >= 5.0:
@@ -480,15 +524,14 @@
         for order in filled_orders:
             lines: List[str] = []
             if order['is_open'] is True:
                 continue
             order_nr += 1
             wording = 'Entry' if order['ft_is_entry'] else 'Exit'
 
-            cur_entry_datetime = arrow.get(order["order_filled_date"])
             cur_entry_amount = order["filled"] or order["amount"]
             cur_entry_average = order["safe_price"]
             lines.append("  ")
             if order_nr == 1:
                 lines.append(f"*{wording} #{order_nr}:*")
                 lines.append(
                     f"*Amount:* {cur_entry_amount} "
@@ -511,66 +554,58 @@
                 price_to_1st_entry = ((cur_entry_average - first_avg) / first_avg)
                 minus_on_entry = 0
                 if prev_avg_price:
                     minus_on_entry = (cur_entry_average - prev_avg_price) / prev_avg_price
 
                 lines.append(f"*{wording} #{order_nr}:* at {minus_on_entry:.2%} avg Profit")
                 if is_open:
-                    lines.append("({})".format(cur_entry_datetime
-                                               .humanize(granularity=["day", "hour", "minute"])))
+                    lines.append("({})".format(dt_humanize(order["order_filled_date"],
+                                                           granularity=["day", "hour", "minute"])))
                 lines.append(f"*Amount:* {cur_entry_amount} "
                              f"({round_coin_value(order['cost'], quote_currency)})")
                 lines.append(f"*Average {wording} Price:* {cur_entry_average} "
                              f"({price_to_1st_entry:.2%} from 1st entry Rate)")
                 lines.append(f"*Order filled:* {order['order_filled_date']}")
 
-                # TODO: is this really useful?
-                # dur_entry = cur_entry_datetime - arrow.get(
-                #     filled_orders[x - 1]["order_filled_date"])
-                # days = dur_entry.days
-                # hours, remainder = divmod(dur_entry.seconds, 3600)
-                # minutes, seconds = divmod(remainder, 60)
-                # lines.append(
-                # f"({days}d {hours}h {minutes}m {seconds}s from previous {wording.lower()})")
             lines_detail.append("\n".join(lines))
 
         return lines_detail
 
     @authorized_only
-    def _status(self, update: Update, context: CallbackContext) -> None:
+    async def _status(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /status.
         Returns the current TradeThread status
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
 
         if context.args and 'table' in context.args:
-            self._status_table(update, context)
+            await self._status_table(update, context)
             return
         else:
-            self._status_msg(update, context)
+            await self._status_msg(update, context)
 
-    def _status_msg(self, update: Update, context: CallbackContext) -> None:
+    async def _status_msg(self, update: Update, context: CallbackContext) -> None:
         """
         handler for `/status` and `/status <id>`.
 
         """
         # Check if there's at least one numerical ID provided.
         # If so, try to get only these trades.
         trade_ids = []
         if context.args and len(context.args) > 0:
             trade_ids = [int(i) for i in context.args if i.isnumeric()]
 
         results = self._rpc._rpc_trade_status(trade_ids=trade_ids)
         position_adjust = self._config.get('position_adjustment_enable', False)
         max_entries = self._config.get('max_entry_position_adjustment', -1)
         for r in results:
-            r['open_date_hum'] = arrow.get(r['open_date']).humanize()
+            r['open_date_hum'] = dt_humanize(r['open_date'])
             r['num_entries'] = len([o for o in r['orders'] if o['ft_is_entry']])
             r['num_exits'] = len([o for o in r['orders'] if not o['ft_is_entry']
                                  and not o['ft_order_side'] == 'stoploss'])
             r['exit_reason'] = r.get('exit_reason', "")
             r['stake_amount_r'] = round_coin_value(r['stake_amount'], r['quote_currency'])
             r['max_stake_amount_r'] = round_coin_value(
                 r['max_stake_amount'] or r['stake_amount'], r['quote_currency'])
@@ -631,34 +666,34 @@
                     lines.append(
                         "*Open Order:* `{open_order}`"
                         + "- `{exit_order_status}`" if r['exit_order_status'] else "")
 
             lines_detail = self._prepare_order_details(
                 r['orders'], r['quote_currency'], r['is_open'])
             lines.extend(lines_detail if lines_detail else "")
-            self.__send_status_msg(lines, r)
+            await self.__send_status_msg(lines, r)
 
-    def __send_status_msg(self, lines: List[str], r: Dict[str, Any]) -> None:
+    async def __send_status_msg(self, lines: List[str], r: Dict[str, Any]) -> None:
         """
         Send status message.
         """
         msg = ''
 
         for line in lines:
             if line:
                 if (len(msg) + len(line) + 1) < MAX_MESSAGE_LENGTH:
                     msg += line + '\n'
                 else:
-                    self._send_msg(msg.format(**r))
+                    await self._send_msg(msg.format(**r))
                     msg = "*Trade ID:* `{trade_id}` - continued\n" + line + '\n'
 
-        self._send_msg(msg.format(**r))
+        await self._send_msg(msg.format(**r))
 
     @authorized_only
-    def _status_table(self, update: Update, context: CallbackContext) -> None:
+    async def _status_table(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /status table.
         Returns the current TradeThread status in table format
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -683,20 +718,19 @@
             message = tabulate(trades,
                                headers=head,
                                tablefmt='simple')
             if show_total and i == messages_count - 1:
                 # insert separators line between Total
                 lines = message.split("\n")
                 message = "\n".join(lines[:-1] + [lines[1]] + [lines[-1]])
-            self._send_msg(f"<pre>{message}</pre>", parse_mode=ParseMode.HTML,
-                           reload_able=True, callback_path="update_status_table",
-                           query=update.callback_query)
+            await self._send_msg(f"<pre>{message}</pre>", parse_mode=ParseMode.HTML,
+                                 reload_able=True, callback_path="update_status_table",
+                                 query=update.callback_query)
 
-    @authorized_only
-    def _timeunit_stats(self, update: Update, context: CallbackContext, unit: str) -> None:
+    async def _timeunit_stats(self, update: Update, context: CallbackContext, unit: str) -> None:
         """
         Handler for /daily <n>
         Returns a daily profit (in BTC) over the last n days.
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -735,52 +769,52 @@
                 'Trades',
             ],
             tablefmt='simple')
         message = (
             f'<b>{val.message} Profit over the last {timescale} {val.message2}</b>:\n'
             f'<pre>{stats_tab}</pre>'
         )
-        self._send_msg(message, parse_mode=ParseMode.HTML, reload_able=True,
-                       callback_path=val.callback, query=update.callback_query)
+        await self._send_msg(message, parse_mode=ParseMode.HTML, reload_able=True,
+                             callback_path=val.callback, query=update.callback_query)
 
     @authorized_only
-    def _daily(self, update: Update, context: CallbackContext) -> None:
+    async def _daily(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /daily <n>
         Returns a daily profit (in BTC) over the last n days.
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
-        self._timeunit_stats(update, context, 'days')
+        await self._timeunit_stats(update, context, 'days')
 
     @authorized_only
-    def _weekly(self, update: Update, context: CallbackContext) -> None:
+    async def _weekly(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /weekly <n>
         Returns a weekly profit (in BTC) over the last n weeks.
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
-        self._timeunit_stats(update, context, 'weeks')
+        await self._timeunit_stats(update, context, 'weeks')
 
     @authorized_only
-    def _monthly(self, update: Update, context: CallbackContext) -> None:
+    async def _monthly(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /monthly <n>
         Returns a monthly profit (in BTC) over the last n months.
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
-        self._timeunit_stats(update, context, 'months')
+        await self._timeunit_stats(update, context, 'months')
 
     @authorized_only
-    def _profit(self, update: Update, context: CallbackContext) -> None:
+    async def _profit(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /profit.
         Returns a cumulative profit statistics.
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -806,16 +840,16 @@
         profit_closed_percent = stats['profit_closed_percent']
         profit_closed_fiat = stats['profit_closed_fiat']
         profit_all_coin = stats['profit_all_coin']
         profit_all_ratio_mean = stats['profit_all_ratio_mean']
         profit_all_percent = stats['profit_all_percent']
         profit_all_fiat = stats['profit_all_fiat']
         trade_count = stats['trade_count']
-        first_trade_date = stats['first_trade_date']
-        latest_trade_date = stats['latest_trade_date']
+        first_trade_date = f"{stats['first_trade_humanized']} ({stats['first_trade_date']})"
+        latest_trade_date = f"{stats['latest_trade_humanized']} ({stats['latest_trade_date']})"
         avg_duration = stats['avg_duration']
         best_pair = stats['best_pair']
         best_pair_profit_ratio = stats['best_pair_profit_ratio']
         if stats['trade_count'] == 0:
             markdown_msg = f"No trades yet.\n*Bot started:* `{stats['bot_start_date']}`"
         else:
             # Message to display
@@ -846,19 +880,19 @@
                     f"\n*Avg. Duration:* `{avg_duration}`\n"
                     f"*Best Performing:* `{best_pair}: {best_pair_profit_ratio:.2%}`\n"
                     f"*Trading volume:* `{round_coin_value(stats['trading_volume'], stake_cur)}`\n"
                     f"*Profit factor:* `{stats['profit_factor']:.2f}`\n"
                     f"*Max Drawdown:* `{stats['max_drawdown']:.2%} "
                     f"({round_coin_value(stats['max_drawdown_abs'], stake_cur)})`"
                 )
-        self._send_msg(markdown_msg, reload_able=True, callback_path="update_profit",
-                       query=update.callback_query)
+        await self._send_msg(markdown_msg, reload_able=True, callback_path="update_profit",
+                             query=update.callback_query)
 
     @authorized_only
-    def _stats(self, update: Update, context: CallbackContext) -> None:
+    async def _stats(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /stats
         Show stats of recent trades
         """
         stats = self._rpc._rpc_stats()
 
         reason_map = {
@@ -881,270 +915,289 @@
         exit_reasons_msg = 'No trades yet.'
         for reason in chunks(exit_reasons_tabulate, 25):
             exit_reasons_msg = tabulate(
                 reason,
                 headers=['Exit Reason', 'Exits', 'Wins', 'Losses']
             )
             if len(exit_reasons_tabulate) > 25:
-                self._send_msg(f"```\n{exit_reasons_msg}```", ParseMode.MARKDOWN)
+                await self._send_msg(f"```\n{exit_reasons_msg}```", ParseMode.MARKDOWN)
                 exit_reasons_msg = ''
 
         durations = stats['durations']
         duration_msg = tabulate(
             [
                 ['Wins', str(timedelta(seconds=durations['wins']))
                  if durations['wins'] is not None else 'N/A'],
                 ['Losses', str(timedelta(seconds=durations['losses']))
                  if durations['losses'] is not None else 'N/A']
             ],
             headers=['', 'Avg. Duration']
         )
         msg = (f"""```\n{exit_reasons_msg}```\n```\n{duration_msg}```""")
 
-        self._send_msg(msg, ParseMode.MARKDOWN)
+        await self._send_msg(msg, ParseMode.MARKDOWN)
 
     @authorized_only
-    def _balance(self, update: Update, context: CallbackContext) -> None:
+    async def _balance(self, update: Update, context: CallbackContext) -> None:
         """ Handler for /balance """
+        full_result = context.args and 'full' in context.args
         result = self._rpc._rpc_balance(self._config['stake_currency'],
                                         self._config.get('fiat_display_currency', ''))
 
         balance_dust_level = self._config['telegram'].get('balance_dust_level', 0.0)
         if not balance_dust_level:
             balance_dust_level = DUST_PER_COIN.get(self._config['stake_currency'], 1.0)
 
         output = ''
         if self._config['dry_run']:
             output += "*Warning:* Simulated balances in Dry Mode.\n"
-        starting_cap = round_coin_value(
-            result['starting_capital'], self._config['stake_currency'])
+        starting_cap = round_coin_value(result['starting_capital'], self._config['stake_currency'])
         output += f"Starting capital: `{starting_cap}`"
         starting_cap_fiat = round_coin_value(
             result['starting_capital_fiat'], self._config['fiat_display_currency']
         ) if result['starting_capital_fiat'] > 0 else ''
         output += (f" `, {starting_cap_fiat}`.\n"
                    ) if result['starting_capital_fiat'] > 0 else '.\n'
 
         total_dust_balance = 0
         total_dust_currencies = 0
         for curr in result['currencies']:
             curr_output = ''
-            if curr['est_stake'] > balance_dust_level:
+            if (
+                (curr['is_position'] or curr['est_stake'] > balance_dust_level)
+                and (full_result or curr['is_bot_managed'])
+            ):
                 if curr['is_position']:
                     curr_output = (
                         f"*{curr['currency']}:*\n"
                         f"\t`{curr['side']}: {curr['position']:.8f}`\n"
                         f"\t`Leverage: {curr['leverage']:.1f}`\n"
                         f"\t`Est. {curr['stake']}: "
                         f"{round_coin_value(curr['est_stake'], curr['stake'], False)}`\n")
                 else:
+                    est_stake = round_coin_value(
+                        curr['est_stake' if full_result else 'est_stake_bot'], curr['stake'], False)
+
                     curr_output = (
                         f"*{curr['currency']}:*\n"
                         f"\t`Available: {curr['free']:.8f}`\n"
                         f"\t`Balance: {curr['balance']:.8f}`\n"
                         f"\t`Pending: {curr['used']:.8f}`\n"
-                        f"\t`Est. {curr['stake']}: "
-                        f"{round_coin_value(curr['est_stake'], curr['stake'], False)}`\n")
+                        f"\t`Bot Owned: {curr['bot_owned']:.8f}`\n"
+                        f"\t`Est. {curr['stake']}: {est_stake}`\n")
+
             elif curr['est_stake'] <= balance_dust_level:
                 total_dust_balance += curr['est_stake']
                 total_dust_currencies += 1
 
             # Handle overflowing message length
             if len(output + curr_output) >= MAX_MESSAGE_LENGTH:
-                self._send_msg(output)
+                await self._send_msg(output)
                 output = curr_output
             else:
                 output += curr_output
 
         if total_dust_balance > 0:
             output += (
                 f"*{total_dust_currencies} Other "
                 f"{plural(total_dust_currencies, 'Currency', 'Currencies')} "
                 f"(< {balance_dust_level} {result['stake']}):*\n"
                 f"\t`Est. {result['stake']}: "
                 f"{round_coin_value(total_dust_balance, result['stake'], False)}`\n")
         tc = result['trade_count'] > 0
         stake_improve = f" `({result['starting_capital_ratio']:.2%})`" if tc else ''
         fiat_val = f" `({result['starting_capital_fiat_ratio']:.2%})`" if tc else ''
-
-        output += ("\n*Estimated Value*:\n"
-                   f"\t`{result['stake']}: "
-                   f"{round_coin_value(result['total'], result['stake'], False)}`"
-                   f"{stake_improve}\n"
-                   f"\t`{result['symbol']}: "
-                   f"{round_coin_value(result['value'], result['symbol'], False)}`"
-                   f"{fiat_val}\n")
-        self._send_msg(output, reload_able=True, callback_path="update_balance",
-                       query=update.callback_query)
+        value = round_coin_value(
+            result['value' if full_result else 'value_bot'], result['symbol'], False)
+        total_stake = round_coin_value(
+            result['total' if full_result else 'total_bot'], result['stake'], False)
+        output += (
+            f"\n*Estimated Value{' (Bot managed assets only)' if not full_result else ''}*:\n"
+            f"\t`{result['stake']}: {total_stake}`{stake_improve}\n"
+            f"\t`{result['symbol']}: {value}`{fiat_val}\n"
+        )
+        await self._send_msg(output, reload_able=True, callback_path="update_balance",
+                             query=update.callback_query)
 
     @authorized_only
-    def _start(self, update: Update, context: CallbackContext) -> None:
+    async def _start(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /start.
         Starts TradeThread
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
         msg = self._rpc._rpc_start()
-        self._send_msg(f"Status: `{msg['status']}`")
+        await self._send_msg(f"Status: `{msg['status']}`")
 
     @authorized_only
-    def _stop(self, update: Update, context: CallbackContext) -> None:
+    async def _stop(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /stop.
         Stops TradeThread
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
         msg = self._rpc._rpc_stop()
-        self._send_msg(f"Status: `{msg['status']}`")
+        await self._send_msg(f"Status: `{msg['status']}`")
 
     @authorized_only
-    def _reload_config(self, update: Update, context: CallbackContext) -> None:
+    async def _reload_config(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /reload_config.
         Triggers a config file reload
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
         msg = self._rpc._rpc_reload_config()
-        self._send_msg(f"Status: `{msg['status']}`")
+        await self._send_msg(f"Status: `{msg['status']}`")
 
     @authorized_only
-    def _stopentry(self, update: Update, context: CallbackContext) -> None:
+    async def _stopentry(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /stop_buy.
         Sets max_open_trades to 0 and gracefully sells all open trades
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
         msg = self._rpc._rpc_stopentry()
-        self._send_msg(f"Status: `{msg['status']}`")
+        await self._send_msg(f"Status: `{msg['status']}`")
+
+    @authorized_only
+    async def _reload_trade_from_exchange(self, update: Update, context: CallbackContext) -> None:
+        """
+        Handler for /reload_trade <tradeid>.
+        """
+        if not context.args or len(context.args) == 0:
+            raise RPCException("Trade-id not set.")
+        trade_id = int(context.args[0])
+        msg = self._rpc._rpc_reload_trade_from_exchange(trade_id)
+        await self._send_msg(f"Status: `{msg['status']}`")
 
     @authorized_only
-    def _force_exit(self, update: Update, context: CallbackContext) -> None:
+    async def _force_exit(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /forceexit <id>.
         Sells the given trade at current price
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
 
         if context.args:
             trade_id = context.args[0]
-            self._force_exit_action(trade_id)
+            await self._force_exit_action(trade_id)
         else:
             fiat_currency = self._config.get('fiat_display_currency', '')
             try:
                 statlist, _, _ = self._rpc._rpc_status_table(
                     self._config['stake_currency'], fiat_currency)
             except RPCException:
-                self._send_msg(msg='No open trade found.')
+                await self._send_msg(msg='No open trade found.')
                 return
             trades = []
             for trade in statlist:
                 trades.append((trade[0], f"{trade[0]} {trade[1]} {trade[2]} {trade[3]}"))
 
             trade_buttons = [
                 InlineKeyboardButton(text=trade[1], callback_data=f"force_exit__{trade[0]}")
                 for trade in trades]
             buttons_aligned = self._layout_inline_keyboard_onecol(trade_buttons)
 
             buttons_aligned.append([InlineKeyboardButton(
                 text='Cancel', callback_data='force_exit__cancel')])
-            self._send_msg(msg="Which trade?", keyboard=buttons_aligned)
+            await self._send_msg(msg="Which trade?", keyboard=buttons_aligned)
 
-    def _force_exit_action(self, trade_id):
+    async def _force_exit_action(self, trade_id):
         if trade_id != 'cancel':
             try:
                 self._rpc._rpc_force_exit(trade_id)
             except RPCException as e:
-                self._send_msg(str(e))
+                await self._send_msg(str(e))
 
-    def _force_exit_inline(self, update: Update, _: CallbackContext) -> None:
+    async def _force_exit_inline(self, update: Update, _: CallbackContext) -> None:
         if update.callback_query:
             query = update.callback_query
             if query.data and '__' in query.data:
                 # Input data is "force_exit__<tradid|cancel>"
                 trade_id = query.data.split("__")[1].split(' ')[0]
                 if trade_id == 'cancel':
-                    query.answer()
-                    query.edit_message_text(text="Force exit canceled.")
+                    await query.answer()
+                    await query.edit_message_text(text="Force exit canceled.")
                     return
                 trade: Optional[Trade] = Trade.get_trades(trade_filter=Trade.id == trade_id).first()
-                query.answer()
+                await query.answer()
                 if trade:
-                    query.edit_message_text(
+                    await query.edit_message_text(
                         text=f"Manually exiting Trade #{trade_id}, {trade.pair}")
-                    self._force_exit_action(trade_id)
+                    await self._force_exit_action(trade_id)
                 else:
-                    query.edit_message_text(text=f"Trade {trade_id} not found.")
+                    await query.edit_message_text(text=f"Trade {trade_id} not found.")
 
-    def _force_enter_action(self, pair, price: Optional[float], order_side: SignalDirection):
+    async def _force_enter_action(self, pair, price: Optional[float], order_side: SignalDirection):
         if pair != 'cancel':
             try:
                 self._rpc._rpc_force_entry(pair, price, order_side=order_side)
             except RPCException as e:
                 logger.exception("Forcebuy error!")
-                self._send_msg(str(e), ParseMode.HTML)
+                await self._send_msg(str(e), ParseMode.HTML)
 
-    def _force_enter_inline(self, update: Update, _: CallbackContext) -> None:
+    async def _force_enter_inline(self, update: Update, _: CallbackContext) -> None:
         if update.callback_query:
             query = update.callback_query
             if query.data and '_||_' in query.data:
                 pair, side = query.data.split('_||_')
                 order_side = SignalDirection(side)
-                query.answer()
-                query.edit_message_text(text=f"Manually entering {order_side} for {pair}")
-                self._force_enter_action(pair, None, order_side)
+                await query.answer()
+                await query.edit_message_text(text=f"Manually entering {order_side} for {pair}")
+                await self._force_enter_action(pair, None, order_side)
 
     @staticmethod
     def _layout_inline_keyboard(
             buttons: List[InlineKeyboardButton], cols=3) -> List[List[InlineKeyboardButton]]:
         return [buttons[i:i + cols] for i in range(0, len(buttons), cols)]
 
     @staticmethod
     def _layout_inline_keyboard_onecol(
             buttons: List[InlineKeyboardButton], cols=1) -> List[List[InlineKeyboardButton]]:
         return [buttons[i:i + cols] for i in range(0, len(buttons), cols)]
 
     @authorized_only
-    def _force_enter(
+    async def _force_enter(
             self, update: Update, context: CallbackContext, order_side: SignalDirection) -> None:
         """
         Handler for /forcelong <asset> <price> and `/forceshort <asset> <price>
         Buys a pair trade at the given or current price
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
         if context.args:
             pair = context.args[0]
             price = float(context.args[1]) if len(context.args) > 1 else None
-            self._force_enter_action(pair, price, order_side)
+            await self._force_enter_action(pair, price, order_side)
         else:
             whitelist = self._rpc._rpc_whitelist()['whitelist']
             pair_buttons = [
                 InlineKeyboardButton(text=pair, callback_data=f"{pair}_||_{order_side}")
                 for pair in sorted(whitelist)
             ]
             buttons_aligned = self._layout_inline_keyboard(pair_buttons)
 
             buttons_aligned.append([InlineKeyboardButton(text='Cancel', callback_data='cancel')])
-            self._send_msg(msg="Which pair?",
-                           keyboard=buttons_aligned,
-                           query=update.callback_query)
+            await self._send_msg(msg="Which pair?",
+                                 keyboard=buttons_aligned,
+                                 query=update.callback_query)
 
     @authorized_only
-    def _trades(self, update: Update, context: CallbackContext) -> None:
+    async def _trades(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /trades <n>
         Returns last n recent trades.
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -1153,63 +1206,63 @@
             nrecent = int(context.args[0]) if context.args else 10
         except (TypeError, ValueError, IndexError):
             nrecent = 10
         trades = self._rpc._rpc_trade_history(
             nrecent
         )
         trades_tab = tabulate(
-            [[arrow.get(trade['close_date']).humanize(),
+            [[dt_humanize(trade['close_date']),
                 trade['pair'] + " (#" + str(trade['trade_id']) + ")",
                 f"{(trade['close_profit']):.2%} ({trade['close_profit_abs']})"]
                 for trade in trades['trades']],
             headers=[
                 'Close Date',
                 'Pair (ID)',
                 f'Profit ({stake_cur})',
             ],
             tablefmt='simple')
         message = (f"<b>{min(trades['trades_count'], nrecent)} recent trades</b>:\n"
                    + (f"<pre>{trades_tab}</pre>" if trades['trades_count'] > 0 else ''))
-        self._send_msg(message, parse_mode=ParseMode.HTML)
+        await self._send_msg(message, parse_mode=ParseMode.HTML)
 
     @authorized_only
-    def _delete_trade(self, update: Update, context: CallbackContext) -> None:
+    async def _delete_trade(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /delete <id>.
         Delete the given trade
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
         if not context.args or len(context.args) == 0:
             raise RPCException("Trade-id not set.")
         trade_id = int(context.args[0])
         msg = self._rpc._rpc_delete(trade_id)
-        self._send_msg(
+        await self._send_msg(
             f"`{msg['result_msg']}`\n"
             'Please make sure to take care of this asset on the exchange manually.'
         )
 
     @authorized_only
-    def _cancel_open_order(self, update: Update, context: CallbackContext) -> None:
+    async def _cancel_open_order(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /cancel_open_order <id>.
         Cancel open order for tradeid
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
         if not context.args or len(context.args) == 0:
             raise RPCException("Trade-id not set.")
         trade_id = int(context.args[0])
         self._rpc._rpc_cancel_open_order(trade_id)
-        self._send_msg('Open order canceled.')
+        await self._send_msg('Open order canceled.')
 
     @authorized_only
-    def _performance(self, update: Update, context: CallbackContext) -> None:
+    async def _performance(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /performance.
         Shows a performance statistic from finished trades
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -1219,25 +1272,25 @@
             stat_line = (
                 f"{i+1}.\t <code>{trade['pair']}\t"
                 f"{round_coin_value(trade['profit_abs'], self._config['stake_currency'])} "
                 f"({trade['profit_ratio']:.2%}) "
                 f"({trade['count']})</code>\n")
 
             if len(output + stat_line) >= MAX_MESSAGE_LENGTH:
-                self._send_msg(output, parse_mode=ParseMode.HTML)
+                await self._send_msg(output, parse_mode=ParseMode.HTML)
                 output = stat_line
             else:
                 output += stat_line
 
-        self._send_msg(output, parse_mode=ParseMode.HTML,
-                       reload_able=True, callback_path="update_performance",
-                       query=update.callback_query)
+        await self._send_msg(output, parse_mode=ParseMode.HTML,
+                             reload_able=True, callback_path="update_performance",
+                             query=update.callback_query)
 
     @authorized_only
-    def _enter_tag_performance(self, update: Update, context: CallbackContext) -> None:
+    async def _enter_tag_performance(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /buys PAIR .
         Shows a performance statistic from finished trades
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -1251,25 +1304,25 @@
             stat_line = (
                 f"{i+1}.\t <code>{trade['enter_tag']}\t"
                 f"{round_coin_value(trade['profit_abs'], self._config['stake_currency'])} "
                 f"({trade['profit_ratio']:.2%}) "
                 f"({trade['count']})</code>\n")
 
             if len(output + stat_line) >= MAX_MESSAGE_LENGTH:
-                self._send_msg(output, parse_mode=ParseMode.HTML)
+                await self._send_msg(output, parse_mode=ParseMode.HTML)
                 output = stat_line
             else:
                 output += stat_line
 
-        self._send_msg(output, parse_mode=ParseMode.HTML,
-                       reload_able=True, callback_path="update_enter_tag_performance",
-                       query=update.callback_query)
+        await self._send_msg(output, parse_mode=ParseMode.HTML,
+                             reload_able=True, callback_path="update_enter_tag_performance",
+                             query=update.callback_query)
 
     @authorized_only
-    def _exit_reason_performance(self, update: Update, context: CallbackContext) -> None:
+    async def _exit_reason_performance(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /sells.
         Shows a performance statistic from finished trades
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -1283,25 +1336,25 @@
             stat_line = (
                 f"{i+1}.\t <code>{trade['exit_reason']}\t"
                 f"{round_coin_value(trade['profit_abs'], self._config['stake_currency'])} "
                 f"({trade['profit_ratio']:.2%}) "
                 f"({trade['count']})</code>\n")
 
             if len(output + stat_line) >= MAX_MESSAGE_LENGTH:
-                self._send_msg(output, parse_mode=ParseMode.HTML)
+                await self._send_msg(output, parse_mode=ParseMode.HTML)
                 output = stat_line
             else:
                 output += stat_line
 
-        self._send_msg(output, parse_mode=ParseMode.HTML,
-                       reload_able=True, callback_path="update_exit_reason_performance",
-                       query=update.callback_query)
+        await self._send_msg(output, parse_mode=ParseMode.HTML,
+                             reload_able=True, callback_path="update_exit_reason_performance",
+                             query=update.callback_query)
 
     @authorized_only
-    def _mix_tag_performance(self, update: Update, context: CallbackContext) -> None:
+    async def _mix_tag_performance(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /mix_tags.
         Shows a performance statistic from finished trades
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -1315,84 +1368,84 @@
             stat_line = (
                 f"{i+1}.\t <code>{trade['mix_tag']}\t"
                 f"{round_coin_value(trade['profit_abs'], self._config['stake_currency'])} "
                 f"({trade['profit']:.2%}) "
                 f"({trade['count']})</code>\n")
 
             if len(output + stat_line) >= MAX_MESSAGE_LENGTH:
-                self._send_msg(output, parse_mode=ParseMode.HTML)
+                await self._send_msg(output, parse_mode=ParseMode.HTML)
                 output = stat_line
             else:
                 output += stat_line
 
-        self._send_msg(output, parse_mode=ParseMode.HTML,
-                       reload_able=True, callback_path="update_mix_tag_performance",
-                       query=update.callback_query)
+        await self._send_msg(output, parse_mode=ParseMode.HTML,
+                             reload_able=True, callback_path="update_mix_tag_performance",
+                             query=update.callback_query)
 
     @authorized_only
-    def _count(self, update: Update, context: CallbackContext) -> None:
+    async def _count(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /count.
         Returns the number of trades running
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
         counts = self._rpc._rpc_count()
         message = tabulate({k: [v] for k, v in counts.items()},
                            headers=['current', 'max', 'total stake'],
                            tablefmt='simple')
         message = f"<pre>{message}</pre>"
         logger.debug(message)
-        self._send_msg(message, parse_mode=ParseMode.HTML,
-                       reload_able=True, callback_path="update_count",
-                       query=update.callback_query)
+        await self._send_msg(message, parse_mode=ParseMode.HTML,
+                             reload_able=True, callback_path="update_count",
+                             query=update.callback_query)
 
     @authorized_only
-    def _locks(self, update: Update, context: CallbackContext) -> None:
+    async def _locks(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /locks.
         Returns the currently active locks
         """
         rpc_locks = self._rpc._rpc_locks()
         if not rpc_locks['locks']:
-            self._send_msg('No active locks.', parse_mode=ParseMode.HTML)
+            await self._send_msg('No active locks.', parse_mode=ParseMode.HTML)
 
         for locks in chunks(rpc_locks['locks'], 25):
             message = tabulate([[
                 lock['id'],
                 lock['pair'],
                 lock['lock_end_time'],
                 lock['reason']] for lock in locks],
                 headers=['ID', 'Pair', 'Until', 'Reason'],
                 tablefmt='simple')
             message = f"<pre>{escape(message)}</pre>"
             logger.debug(message)
-            self._send_msg(message, parse_mode=ParseMode.HTML)
+            await self._send_msg(message, parse_mode=ParseMode.HTML)
 
     @authorized_only
-    def _delete_locks(self, update: Update, context: CallbackContext) -> None:
+    async def _delete_locks(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /delete_locks.
         Returns the currently active locks
         """
         arg = context.args[0] if context.args and len(context.args) > 0 else None
         lockid = None
         pair = None
         if arg:
             try:
                 lockid = int(arg)
             except ValueError:
                 pair = arg
 
         self._rpc._rpc_delete_lock(lockid=lockid, pair=pair)
-        self._locks(update, context)
+        await self._locks(update, context)
 
     @authorized_only
-    def _whitelist(self, update: Update, context: CallbackContext) -> None:
+    async def _whitelist(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /whitelist
         Shows the currently active whitelist
         """
         whitelist = self._rpc._rpc_whitelist()
 
         if context.args:
@@ -1401,47 +1454,47 @@
             if "baseonly" in context.args:
                 whitelist['whitelist'] = [pair.split("/")[0] for pair in whitelist['whitelist']]
 
         message = f"Using whitelist `{whitelist['method']}` with {whitelist['length']} pairs\n"
         message += f"`{', '.join(whitelist['whitelist'])}`"
 
         logger.debug(message)
-        self._send_msg(message)
+        await self._send_msg(message)
 
     @authorized_only
-    def _blacklist(self, update: Update, context: CallbackContext) -> None:
+    async def _blacklist(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /blacklist
         Shows the currently active blacklist
         """
-        self.send_blacklist_msg(self._rpc._rpc_blacklist(context.args))
+        await self.send_blacklist_msg(self._rpc._rpc_blacklist(context.args))
 
-    def send_blacklist_msg(self, blacklist: Dict):
+    async def send_blacklist_msg(self, blacklist: Dict):
         errmsgs = []
         for pair, error in blacklist['errors'].items():
             errmsgs.append(f"Error: {error['error_msg']}")
         if errmsgs:
-            self._send_msg('\n'.join(errmsgs))
+            await self._send_msg('\n'.join(errmsgs))
 
         message = f"Blacklist contains {blacklist['length']} pairs\n"
         message += f"`{', '.join(blacklist['blacklist'])}`"
 
         logger.debug(message)
-        self._send_msg(message)
+        await self._send_msg(message)
 
     @authorized_only
-    def _blacklist_delete(self, update: Update, context: CallbackContext) -> None:
+    async def _blacklist_delete(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /bl_delete
         Deletes pair(s) from current blacklist
         """
-        self.send_blacklist_msg(self._rpc._rpc_blacklist_delete(context.args or []))
+        await self.send_blacklist_msg(self._rpc._rpc_blacklist_delete(context.args or []))
 
     @authorized_only
-    def _logs(self, update: Update, context: CallbackContext) -> None:
+    async def _logs(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /logs
         Shows the latest logs
         """
         try:
             limit = int(context.args[0]) if context.args else 10
         except (TypeError, ValueError, IndexError):
@@ -1452,43 +1505,43 @@
         for logrec in logs:
             msg = msg_template.format(escape_markdown(logrec[0], version=2),
                                       escape_markdown(logrec[2], version=2),
                                       escape_markdown(logrec[3], version=2),
                                       escape_markdown(logrec[4], version=2))
             if len(msgs + msg) + 10 >= MAX_MESSAGE_LENGTH:
                 # Send message immediately if it would become too long
-                self._send_msg(msgs, parse_mode=ParseMode.MARKDOWN_V2)
+                await self._send_msg(msgs, parse_mode=ParseMode.MARKDOWN_V2)
                 msgs = msg + '\n'
             else:
                 # Append message to messages to send
                 msgs += msg + '\n'
 
         if msgs:
-            self._send_msg(msgs, parse_mode=ParseMode.MARKDOWN_V2)
+            await self._send_msg(msgs, parse_mode=ParseMode.MARKDOWN_V2)
 
     @authorized_only
-    def _edge(self, update: Update, context: CallbackContext) -> None:
+    async def _edge(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /edge
         Shows information related to Edge
         """
         edge_pairs = self._rpc._rpc_edge()
         if not edge_pairs:
             message = '<b>Edge only validated following pairs:</b>'
-            self._send_msg(message, parse_mode=ParseMode.HTML)
+            await self._send_msg(message, parse_mode=ParseMode.HTML)
 
         for chunk in chunks(edge_pairs, 25):
             edge_pairs_tab = tabulate(chunk, headers='keys', tablefmt='simple')
             message = (f'<b>Edge only validated following pairs:</b>\n'
                        f'<pre>{edge_pairs_tab}</pre>')
 
-            self._send_msg(message, parse_mode=ParseMode.HTML)
+            await self._send_msg(message, parse_mode=ParseMode.HTML)
 
     @authorized_only
-    def _help(self, update: Update, context: CallbackContext) -> None:
+    async def _help(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /help.
         Show commands of the bot
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -1507,14 +1560,15 @@
             "*/stop:* Stops the trader\n"
             "*/stopentry:* `Stops entering, but handles open trades gracefully` \n"
             "*/forceexit <trade_id>|all:* `Instantly exits the given trade or all trades, "
             "regardless of profit`\n"
             "*/fx <trade_id>|all:* `Alias to /forceexit`\n"
             f"{force_enter_text if self._config.get('force_entry_enable', False) else ''}"
             "*/delete <trade_id>:* `Instantly delete the given trade in the database`\n"
+            "*/reload_trade <trade_id>:* `Relade trade from exchange Orders`\n"
             "*/cancel_open_order <trade_id>:* `Cancels open orders for trade. "
             "Only valid when the trade has open orders.`\n"
             "*/coo <trade_id>|all:* `Alias to /cancel_open_order`\n"
 
             "*/whitelist [sorted] [baseonly]:* `Show current whitelist. Optionally in "
             "order and/or only displaying the base currency of each pairing.`\n"
             "*/blacklist [pair]:* `Show current blacklist, or adds one or more pairs "
@@ -1524,15 +1578,16 @@
             "*/reload_config:* `Reload configuration file` \n"
             "*/unlock <pair|id>:* `Unlock this Pair (or this lock id if it's numeric)`\n"
 
             "_Current state_\n"
             "------------\n"
             "*/show_config:* `Show running configuration` \n"
             "*/locks:* `Show currently locked pairs`\n"
-            "*/balance:* `Show account balance per currency`\n"
+            "*/balance:* `Show bot managed balance per currency`\n"
+            "*/balance total:* `Show account balance per currency`\n"
             "*/logs [limit]:* `Show latest logs - defaults to 10` \n"
             "*/count:* `Show number of active trades compared to allowed number of trades`\n"
             "*/edge:* `Shows validated pairs by Edge if it is enabled` \n"
             "*/health* `Show latest process timestamp - defaults to 1970-01-01 00:00:00` \n"
             "*/marketdir [long | short | even | none]:* `Updates the user managed variable "
             "that represents the current market direction. If no direction is provided `"
             "`the currently set market direction will be output.` \n"
@@ -1557,44 +1612,44 @@
             "*/monthly <n>:* `Shows statistics per month, over the last n months`\n"
             "*/stats:* `Shows Wins / losses by Sell reason as well as "
             "Avg. holding durations for buys and sells.`\n"
             "*/help:* `This help message`\n"
             "*/version:* `Show version`"
             )
 
-        self._send_msg(message, parse_mode=ParseMode.MARKDOWN)
+        await self._send_msg(message, parse_mode=ParseMode.MARKDOWN)
 
     @authorized_only
-    def _health(self, update: Update, context: CallbackContext) -> None:
+    async def _health(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /health
         Shows the last process timestamp
         """
         health = self._rpc.health()
         message = f"Last process: `{health['last_process_loc']}`"
-        self._send_msg(message)
+        await self._send_msg(message)
 
     @authorized_only
-    def _version(self, update: Update, context: CallbackContext) -> None:
+    async def _version(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /version.
         Show version information
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
         strategy_version = self._rpc._freqtrade.strategy.version()
         version_string = f'*Version:* `{__version__}`'
         if strategy_version is not None:
-            version_string += f', *Strategy version: * `{strategy_version}`'
+            version_string += f'\n*Strategy version: * `{strategy_version}`'
 
-        self._send_msg(version_string)
+        await self._send_msg(version_string)
 
     @authorized_only
-    def _show_config(self, update: Update, context: CallbackContext) -> None:
+    async def _show_config(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /show_config.
         Show config information information
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -1615,15 +1670,15 @@
             pa_info = (
                 f"*Position adjustment:* On\n"
                 f"*Max enter position adjustment:* `{val['max_entry_position_adjustment']}`\n"
             )
         else:
             pa_info = "*Position adjustment:* Off\n"
 
-        self._send_msg(
+        await self._send_msg(
             f"*Mode:* `{'Dry-run' if val['dry_run'] else 'Live'}`\n"
             f"*Exchange:* `{val['exchange']}`\n"
             f"*Market: * `{val['trading_mode']}`\n"
             f"*Stake per trade:* `{val['stake_amount']} {val['stake_currency']}`\n"
             f"*Max open Trades:* `{val['max_open_trades']}`\n"
             f"*Minimum ROI:* `{val['minimal_roi']}`\n"
             f"*Entry strategy:* ```\n{json.dumps(val['entry_pricing'])}```\n"
@@ -1631,101 +1686,101 @@
             f"{sl_info}"
             f"{pa_info}"
             f"*Timeframe:* `{val['timeframe']}`\n"
             f"*Strategy:* `{val['strategy']}`\n"
             f"*Current state:* `{val['state']}`"
         )
 
-    def _update_msg(self, query: CallbackQuery, msg: str, callback_path: str = "",
-                    reload_able: bool = False, parse_mode: str = ParseMode.MARKDOWN) -> None:
+    async def _update_msg(self, query: CallbackQuery, msg: str, callback_path: str = "",
+                          reload_able: bool = False, parse_mode: str = ParseMode.MARKDOWN) -> None:
         if reload_able:
             reply_markup = InlineKeyboardMarkup([
                 [InlineKeyboardButton("Refresh", callback_data=callback_path)],
             ])
         else:
             reply_markup = InlineKeyboardMarkup([[]])
         msg += f"\nUpdated: {datetime.now().ctime()}"
         if not query.message:
             return
         chat_id = query.message.chat_id
         message_id = query.message.message_id
 
         try:
-            self._updater.bot.edit_message_text(
+            await self._app.bot.edit_message_text(
                 chat_id=chat_id,
                 message_id=message_id,
                 text=msg,
                 parse_mode=parse_mode,
                 reply_markup=reply_markup
             )
         except BadRequest as e:
             if 'not modified' in e.message.lower():
                 pass
             else:
                 logger.warning('TelegramError: %s', e.message)
         except TelegramError as telegram_err:
             logger.warning('TelegramError: %s! Giving up on that message.', telegram_err.message)
 
-    def _send_msg(self, msg: str, parse_mode: str = ParseMode.MARKDOWN,
-                  disable_notification: bool = False,
-                  keyboard: Optional[List[List[InlineKeyboardButton]]] = None,
-                  callback_path: str = "",
-                  reload_able: bool = False,
-                  query: Optional[CallbackQuery] = None) -> None:
+    async def _send_msg(self, msg: str, parse_mode: str = ParseMode.MARKDOWN,
+                        disable_notification: bool = False,
+                        keyboard: Optional[List[List[InlineKeyboardButton]]] = None,
+                        callback_path: str = "",
+                        reload_able: bool = False,
+                        query: Optional[CallbackQuery] = None) -> None:
         """
         Send given markdown message
         :param msg: message
         :param bot: alternative bot
         :param parse_mode: telegram parse mode
         :return: None
         """
         reply_markup: Union[InlineKeyboardMarkup, ReplyKeyboardMarkup]
         if query:
-            self._update_msg(query=query, msg=msg, parse_mode=parse_mode,
-                             callback_path=callback_path, reload_able=reload_able)
+            await self._update_msg(query=query, msg=msg, parse_mode=parse_mode,
+                                   callback_path=callback_path, reload_able=reload_able)
             return
         if reload_able and self._config['telegram'].get('reload', True):
             reply_markup = InlineKeyboardMarkup([
                 [InlineKeyboardButton("Refresh", callback_data=callback_path)]])
         else:
             if keyboard is not None:
-                reply_markup = InlineKeyboardMarkup(keyboard, resize_keyboard=True)
+                reply_markup = InlineKeyboardMarkup(keyboard)
             else:
                 reply_markup = ReplyKeyboardMarkup(self._keyboard, resize_keyboard=True)
         try:
             try:
-                self._updater.bot.send_message(
+                await self._app.bot.send_message(
                     self._config['telegram']['chat_id'],
                     text=msg,
                     parse_mode=parse_mode,
                     reply_markup=reply_markup,
                     disable_notification=disable_notification,
                 )
             except NetworkError as network_err:
                 # Sometimes the telegram server resets the current connection,
                 # if this is the case we send the message again.
                 logger.warning(
                     'Telegram NetworkError: %s! Trying one more time.',
                     network_err.message
                 )
-                self._updater.bot.send_message(
+                await self._app.bot.send_message(
                     self._config['telegram']['chat_id'],
                     text=msg,
                     parse_mode=parse_mode,
                     reply_markup=reply_markup,
                     disable_notification=disable_notification,
                 )
         except TelegramError as telegram_err:
             logger.warning(
                 'TelegramError: %s! Giving up on that message.',
                 telegram_err.message
             )
 
     @authorized_only
-    def _changemarketdir(self, update: Update, context: CallbackContext) -> None:
+    async def _changemarketdir(self, update: Update, context: CallbackContext) -> None:
         """
         Handler for /marketdir.
         Updates the bot's market_direction
         :param bot: telegram bot
         :param update: message update
         :return: None
         """
@@ -1740,18 +1795,18 @@
             elif new_market_dir_arg == "even":
                 new_market_dir = MarketDirection.EVEN
             elif new_market_dir_arg == "none":
                 new_market_dir = MarketDirection.NONE
 
             if new_market_dir is not None:
                 self._rpc._update_market_direction(new_market_dir)
-                self._send_msg("Successfully updated market direction"
-                               f" from *{old_market_dir}* to *{new_market_dir}*.")
+                await self._send_msg("Successfully updated market direction"
+                                     f" from *{old_market_dir}* to *{new_market_dir}*.")
             else:
                 raise RPCException("Invalid market direction provided. \n"
                                    "Valid market directions: *long, short, even, none*")
         elif context.args is not None and len(context.args) == 0:
             old_market_dir = self._rpc._get_market_direction()
-            self._send_msg(f"Currently set market direction: *{old_market_dir}*")
+            await self._send_msg(f"Currently set market direction: *{old_market_dir}*")
         else:
             raise RPCException("Invalid usage of command /marketdir. \n"
                                "Usage: */marketdir [short |  long | even | none]*")
```

### Comparing `freqtrade-2023.4/freqtrade/rpc/webhook.py` & `freqtrade-2023.5/freqtrade/rpc/webhook.py`

 * *Files 2% similar despite different names*

```diff
@@ -40,16 +40,19 @@
         Cleanup pending module resources.
         This will do nothing for webhooks, they will simply not be called anymore
         """
         pass
 
     def _get_value_dict(self, msg: RPCSendMsg) -> Optional[Dict[str, Any]]:
         whconfig = self._config['webhook']
+        if msg['type'].value in whconfig:
+            # Explicit types should have priority
+            valuedict = whconfig.get(msg['type'].value)
         # Deprecated 2022.10 - only keep generic method.
-        if msg['type'] in [RPCMessageType.ENTRY]:
+        elif msg['type'] in [RPCMessageType.ENTRY]:
             valuedict = whconfig.get('webhookentry')
         elif msg['type'] in [RPCMessageType.ENTRY_CANCEL]:
             valuedict = whconfig.get('webhookentrycancel')
         elif msg['type'] in [RPCMessageType.ENTRY_FILL]:
             valuedict = whconfig.get('webhookentryfill')
         elif msg['type'] == RPCMessageType.EXIT:
             valuedict = whconfig.get('webhookexit')
@@ -58,17 +61,14 @@
         elif msg['type'] == RPCMessageType.EXIT_CANCEL:
             valuedict = whconfig.get('webhookexitcancel')
         elif msg['type'] in (RPCMessageType.STATUS,
                              RPCMessageType.STARTUP,
                              RPCMessageType.EXCEPTION,
                              RPCMessageType.WARNING):
             valuedict = whconfig.get('webhookstatus')
-        elif msg['type'].value in whconfig:
-            # Allow all types ...
-            valuedict = whconfig.get(msg['type'].value)
         elif msg['type'] in (
                 RPCMessageType.PROTECTION_TRIGGER,
                 RPCMessageType.PROTECTION_TRIGGER_GLOBAL,
                 RPCMessageType.WHITELIST,
                 RPCMessageType.ANALYZED_DF,
                 RPCMessageType.NEW_CANDLE,
                 RPCMessageType.STRATEGY_MSG):
```

### Comparing `freqtrade-2023.4/freqtrade/strategy/__init__.py` & `freqtrade-2023.5/freqtrade/strategy/__init__.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/strategy/hyper.py` & `freqtrade-2023.5/freqtrade/strategy/hyper.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/strategy/informative_decorator.py` & `freqtrade-2023.5/freqtrade/strategy/informative_decorator.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/strategy/interface.py` & `freqtrade-2023.5/freqtrade/strategy/interface.py`

 * *Files 0% similar despite different names*

```diff
@@ -3,15 +3,14 @@
 This module defines the interface to apply for strategies
 """
 import logging
 from abc import ABC, abstractmethod
 from datetime import datetime, timedelta, timezone
 from typing import Dict, List, Optional, Tuple, Union
 
-import arrow
 from pandas import DataFrame
 
 from freqtrade.constants import CUSTOM_TAG_MAX_LENGTH, Config, IntOrInf, ListPairsWithTimeframes
 from freqtrade.data.dataprovider import DataProvider
 from freqtrade.enums import (CandleType, ExitCheckTuple, ExitType, MarketDirection, RunMode,
                              SignalDirection, SignalTagType, SignalType, TradingMode)
 from freqtrade.exceptions import OperationalException, StrategyError
@@ -19,14 +18,15 @@
 from freqtrade.misc import remove_entry_exit_signals
 from freqtrade.persistence import Order, PairLocks, Trade
 from freqtrade.strategy.hyper import HyperStrategyMixin
 from freqtrade.strategy.informative_decorator import (InformativeData, PopulateIndicators,
                                                       _create_and_merge_informative_pair,
                                                       _format_pair_name)
 from freqtrade.strategy.strategy_wrapper import strategy_safe_wrapper
+from freqtrade.util import dt_now
 from freqtrade.wallets import Wallets
 
 
 logger = logging.getLogger(__name__)
 
 
 class IStrategy(ABC, HyperStrategyMixin):
@@ -934,15 +934,15 @@
                 raise StrategyError(message)
 
     def get_latest_candle(
         self,
         pair: str,
         timeframe: str,
         dataframe: DataFrame,
-    ) -> Tuple[Optional[DataFrame], Optional[arrow.Arrow]]:
+    ) -> Tuple[Optional[DataFrame], Optional[datetime]]:
         """
         Calculates current signal based based on the entry order or exit order
         columns of the dataframe.
         Used by Bot to get the signal to enter, or exit
         :param pair: pair in format ANT/BTC
         :param timeframe: timeframe to use
         :param dataframe: Analyzed dataframe to get signal from.
@@ -950,24 +950,24 @@
         """
         if not isinstance(dataframe, DataFrame) or dataframe.empty:
             logger.warning(f'Empty candle (OHLCV) data for pair {pair}')
             return None, None
 
         latest_date = dataframe['date'].max()
         latest = dataframe.loc[dataframe['date'] == latest_date].iloc[-1]
-        # Explicitly convert to arrow object to ensure the below comparison does not fail
-        latest_date = arrow.get(latest_date)
+        # Explicitly convert to datetime object to ensure the below comparison does not fail
+        latest_date = latest_date.to_pydatetime()
 
         # Check if dataframe is out of date
         timeframe_minutes = timeframe_to_minutes(timeframe)
         offset = self.config.get('exchange', {}).get('outdated_offset', 5)
-        if latest_date < (arrow.utcnow().shift(minutes=-(timeframe_minutes * 2 + offset))):
+        if latest_date < (dt_now() - timedelta(minutes=timeframe_minutes * 2 + offset)):
             logger.warning(
                 'Outdated history for pair %s. Last tick is %s minutes old',
-                pair, int((arrow.utcnow() - latest_date).total_seconds() // 60)
+                pair, int((dt_now() - latest_date).total_seconds() // 60)
             )
             return None, None
         return latest, latest_date
 
     def get_exit_signal(
         self,
         pair: str,
@@ -1042,16 +1042,16 @@
             enter_tag_value = latest.get(SignalTagType.ENTER_TAG.value, None)
 
         enter_tag_value = enter_tag_value if isinstance(enter_tag_value, str) else None
 
         timeframe_seconds = timeframe_to_seconds(timeframe)
 
         if self.ignore_expired_candle(
-            latest_date=latest_date.datetime,
-            current_time=datetime.now(timezone.utc),
+            latest_date=latest_date,
+            current_time=dt_now(),
             timeframe_seconds=timeframe_seconds,
             enter=bool(enter_signal)
         ):
             return None, enter_tag_value
 
         logger.debug(f"entry trigger: {latest['date']} (pair={pair}) "
                      f"enter={enter_long} enter_tag_value={enter_tag_value}")
```

### Comparing `freqtrade-2023.4/freqtrade/strategy/parameters.py` & `freqtrade-2023.5/freqtrade/strategy/parameters.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/strategy/strategy_helper.py` & `freqtrade-2023.5/freqtrade/strategy/strategy_helper.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/strategy/strategy_wrapper.py` & `freqtrade-2023.5/freqtrade/strategy/strategy_wrapper.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/strategy/strategyupdater.py` & `freqtrade-2023.5/freqtrade/strategy/strategyupdater.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/templates/FreqaiExampleHybridStrategy.py` & `freqtrade-2023.5/freqtrade/templates/FreqaiExampleHybridStrategy.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/templates/FreqaiExampleStrategy.py` & `freqtrade-2023.5/freqtrade/templates/FreqaiExampleStrategy.py`

 * *Files 3% similar despite different names*

```diff
@@ -11,20 +11,23 @@
 
 logger = logging.getLogger(__name__)
 
 
 class FreqaiExampleStrategy(IStrategy):
     """
     Example strategy showing how the user connects their own
-    IFreqaiModel to the strategy. Namely, the user uses:
-    self.freqai.start(dataframe, metadata)
+    IFreqaiModel to the strategy.
 
-    to make predictions on their data. feature_engineering_*() automatically
-    generate the variety of features indicated by the user in the
-    canonical freqtrade configuration file under config['freqai'].
+    Warning! This is a showcase of functionality,
+    which means that it is designed to show various functions of FreqAI
+    and it runs on all computers. We use this showcase to help users
+    understand how to build a strategy, and we use it as a benchmark
+    to help debug possible problems.
+
+    This means this is *not* meant to be run live in production.
     """
 
     minimal_roi = {"0": 0.1, "240": -1}
 
     plot_config = {
         "main_plot": {},
         "subplots": {
```

### Comparing `freqtrade-2023.4/freqtrade/templates/base_config.json.j2` & `freqtrade-2023.5/freqtrade/templates/base_config.json.j2`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/templates/base_strategy.py.j2` & `freqtrade-2023.5/freqtrade/templates/base_strategy.py.j2`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/templates/sample_hyperopt_loss.py` & `freqtrade-2023.5/freqtrade/templates/sample_hyperopt_loss.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/templates/sample_strategy.py` & `freqtrade-2023.5/freqtrade/templates/sample_strategy.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/templates/strategy_analysis_example.ipynb` & `freqtrade-2023.5/freqtrade/templates/strategy_analysis_example.ipynb`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/indicators_full.j2` & `freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/indicators_full.j2`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/templates/strategy_subtemplates/strategy_methods_advanced.j2` & `freqtrade-2023.5/freqtrade/templates/strategy_subtemplates/strategy_methods_advanced.j2`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/util/binance_mig.py` & `freqtrade-2023.5/freqtrade/util/binance_mig.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/util/periodic_cache.py` & `freqtrade-2023.5/freqtrade/util/periodic_cache.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/vendor/qtpylib/indicators.py` & `freqtrade-2023.5/freqtrade/vendor/qtpylib/indicators.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade/wallets.py` & `freqtrade-2023.5/freqtrade/wallets.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,22 +1,22 @@
 # pragma pylint: disable=W0603
 """ Wallet """
 
 import logging
 from copy import deepcopy
+from datetime import datetime, timedelta
 from typing import Dict, NamedTuple, Optional
 
-import arrow
-
 from freqtrade.constants import UNLIMITED_STAKE_AMOUNT, Config
 from freqtrade.enums import RunMode, TradingMode
 from freqtrade.exceptions import DependencyException
 from freqtrade.exchange import Exchange
 from freqtrade.misc import safe_value_fallback
 from freqtrade.persistence import LocalTrade, Trade
+from freqtrade.util.datetime_helpers import dt_now
 
 
 logger = logging.getLogger(__name__)
 
 
 # wallet data structure
 class Wallet(NamedTuple):
@@ -39,15 +39,15 @@
     def __init__(self, config: Config, exchange: Exchange, log: bool = True) -> None:
         self._config = config
         self._log = log
         self._exchange = exchange
         self._wallets: Dict[str, Wallet] = {}
         self._positions: Dict[str, PositionWallet] = {}
         self.start_cap = config['dry_run_wallet']
-        self._last_wallet_refresh = 0
+        self._last_wallet_refresh: Optional[datetime] = None
         self.update()
 
     def get_free(self, currency: str) -> float:
         balance = self._wallets.get(currency)
         if balance and balance.free:
             return balance.free
         else:
@@ -162,29 +162,63 @@
         """
         Updates wallets from the configured version.
         By default, updates from the exchange.
         Update-skipping should only be used for user-invoked /balance calls, since
         for trading operations, the latest balance is needed.
         :param require_update: Allow skipping an update if balances were recently refreshed
         """
-        if (require_update or (self._last_wallet_refresh + 3600 < arrow.utcnow().int_timestamp)):
+        now = dt_now()
+        if (
+            require_update
+            or self._last_wallet_refresh is None
+            or (self._last_wallet_refresh + timedelta(seconds=3600) < now)
+        ):
             if (not self._config['dry_run'] or self._config.get('runmode') == RunMode.LIVE):
                 self._update_live()
             else:
                 self._update_dry()
             if self._log:
                 logger.info('Wallets synced.')
-            self._last_wallet_refresh = arrow.utcnow().int_timestamp
+            self._last_wallet_refresh = dt_now()
 
     def get_all_balances(self) -> Dict[str, Wallet]:
         return self._wallets
 
     def get_all_positions(self) -> Dict[str, PositionWallet]:
         return self._positions
 
+    def _check_exit_amount(self, trade: Trade) -> bool:
+        if trade.trading_mode != TradingMode.FUTURES:
+            # Slightly higher offset than in safe_exit_amount.
+            wallet_amount: float = self.get_total(trade.safe_base_currency) * (2 - 0.981)
+        else:
+            # wallet_amount: float = self.wallets.get_free(trade.safe_base_currency)
+            position = self._positions.get(trade.pair)
+            if position is None:
+                # We don't own anything :O
+                return False
+            wallet_amount = position.position
+
+        if wallet_amount >= trade.amount:
+            return True
+        return False
+
+    def check_exit_amount(self, trade: Trade) -> bool:
+        """
+        Checks if the exit amount is available in the wallet.
+        :param trade: Trade to check
+        :return: True if the exit amount is available, False otherwise
+        """
+        if not self._check_exit_amount(trade):
+            # Update wallets just to make sure
+            self.update()
+            return self._check_exit_amount(trade)
+
+        return True
+
     def get_starting_balance(self) -> float:
         """
         Retrieves starting balance - based on either available capital,
         or by using current balance subtracting
         """
         if "available_capital" in self._config:
             return self._config['available_capital']
```

### Comparing `freqtrade-2023.4/freqtrade/worker.py` & `freqtrade-2023.5/freqtrade/worker.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/freqtrade.egg-info/PKG-INFO` & `freqtrade-2023.5/freqtrade.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: freqtrade
-Version: 2023.4
+Version: 2023.5
 Summary: Freqtrade - Crypto Trading Bot
 Home-page: https://github.com/freqtrade/freqtrade
 Author: Freqtrade Team
 Author-email: freqtrade@protonmail.com
 License: GPLv3
 Project-URL: Bug Tracker, https://github.com/freqtrade/freqtrade/issues
 Classifier: Environment :: Console
```

### Comparing `freqtrade-2023.4/freqtrade.egg-info/SOURCES.txt` & `freqtrade-2023.5/freqtrade.egg-info/SOURCES.txt`

 * *Files 2% similar despite different names*

```diff
@@ -100,15 +100,14 @@
 freqtrade/freqai/freqai_interface.py
 freqtrade/freqai/utils.py
 freqtrade/freqai/RL/Base3ActionRLEnv.py
 freqtrade/freqai/RL/Base4ActionRLEnv.py
 freqtrade/freqai/RL/Base5ActionRLEnv.py
 freqtrade/freqai/RL/BaseEnvironment.py
 freqtrade/freqai/RL/BaseReinforcementLearningModel.py
-freqtrade/freqai/RL/TensorboardCallback.py
 freqtrade/freqai/RL/__init__.py
 freqtrade/freqai/base_models/BaseClassifierModel.py
 freqtrade/freqai/base_models/BasePyTorchClassifier.py
 freqtrade/freqai/base_models/BasePyTorchModel.py
 freqtrade/freqai/base_models/BasePyTorchRegressor.py
 freqtrade/freqai/base_models/BaseRegressionModel.py
 freqtrade/freqai/base_models/BaseTensorFlowModel.py
@@ -120,27 +119,34 @@
 freqtrade/freqai/prediction_models/CatboostRegressorMultiTarget.py
 freqtrade/freqai/prediction_models/LightGBMClassifier.py
 freqtrade/freqai/prediction_models/LightGBMClassifierMultiTarget.py
 freqtrade/freqai/prediction_models/LightGBMRegressor.py
 freqtrade/freqai/prediction_models/LightGBMRegressorMultiTarget.py
 freqtrade/freqai/prediction_models/PyTorchMLPClassifier.py
 freqtrade/freqai/prediction_models/PyTorchMLPRegressor.py
+freqtrade/freqai/prediction_models/PyTorchTransformerRegressor.py
 freqtrade/freqai/prediction_models/ReinforcementLearner.py
 freqtrade/freqai/prediction_models/ReinforcementLearner_multiproc.py
 freqtrade/freqai/prediction_models/XGBoostClassifier.py
 freqtrade/freqai/prediction_models/XGBoostRFClassifier.py
 freqtrade/freqai/prediction_models/XGBoostRFRegressor.py
 freqtrade/freqai/prediction_models/XGBoostRegressor.py
 freqtrade/freqai/prediction_models/XGBoostRegressorMultiTarget.py
 freqtrade/freqai/prediction_models/__init__.py
+freqtrade/freqai/tensorboard/TensorboardCallback.py
+freqtrade/freqai/tensorboard/__init__.py
+freqtrade/freqai/tensorboard/base_tensorboard.py
+freqtrade/freqai/tensorboard/tensorboard.py
 freqtrade/freqai/torch/PyTorchDataConvertor.py
 freqtrade/freqai/torch/PyTorchMLPModel.py
 freqtrade/freqai/torch/PyTorchModelTrainer.py
 freqtrade/freqai/torch/PyTorchTrainerInterface.py
+freqtrade/freqai/torch/PyTorchTransformerModel.py
 freqtrade/freqai/torch/__init__.py
+freqtrade/freqai/torch/datasets.py
 freqtrade/leverage/__init__.py
 freqtrade/leverage/interest.py
 freqtrade/loggers/__init__.py
 freqtrade/loggers/buffering_handler.py
 freqtrade/loggers/std_err_stream_handler.py
 freqtrade/mixins/__init__.py
 freqtrade/mixins/logging_mixin.py
@@ -226,14 +232,15 @@
 freqtrade/rpc/api_server/api_schemas.py
 freqtrade/rpc/api_server/api_v1.py
 freqtrade/rpc/api_server/api_ws.py
 freqtrade/rpc/api_server/deps.py
 freqtrade/rpc/api_server/uvicorn_threaded.py
 freqtrade/rpc/api_server/web_ui.py
 freqtrade/rpc/api_server/webserver.py
+freqtrade/rpc/api_server/webserver_bgwork.py
 freqtrade/rpc/api_server/ws_schemas.py
 freqtrade/rpc/api_server/ui/fallback_file.html
 freqtrade/rpc/api_server/ui/favicon.ico
 freqtrade/rpc/api_server/ws/__init__.py
 freqtrade/rpc/api_server/ws/channel.py
 freqtrade/rpc/api_server/ws/message_stream.py
 freqtrade/rpc/api_server/ws/proxy.py
@@ -270,14 +277,15 @@
 freqtrade/templates/subtemplates/exchange_generic.j2
 freqtrade/templates/subtemplates/exchange_huobi.j2
 freqtrade/templates/subtemplates/exchange_kraken.j2
 freqtrade/templates/subtemplates/exchange_kucoin.j2
 freqtrade/templates/subtemplates/exchange_okex.j2
 freqtrade/util/__init__.py
 freqtrade/util/binance_mig.py
+freqtrade/util/datetime_helpers.py
 freqtrade/util/ft_precise.py
 freqtrade/util/gc_setup.py
 freqtrade/util/periodic_cache.py
 freqtrade/vendor/__init__.py
 freqtrade/vendor/qtpylib/__init__.py
 freqtrade/vendor/qtpylib/indicators.py
 tests/__init__.py
@@ -289,15 +297,14 @@
 tests/test_configuration.py
 tests/test_directory_operations.py
 tests/test_freqtradebot.py
 tests/test_indicators.py
 tests/test_integration.py
 tests/test_main.py
 tests/test_misc.py
-tests/test_periodiccache.py
 tests/test_plotting.py
 tests/test_strategy_updater.py
 tests/test_talib.py
 tests/test_timerange.py
 tests/test_wallets.py
 tests/test_worker.py
 tests/commands/__init__.py
@@ -313,15 +320,14 @@
 tests/edge/__init__.py
 tests/edge/test_edge.py
 tests/exchange/__init__.py
 tests/exchange/test_binance.py
 tests/exchange/test_bitpanda.py
 tests/exchange/test_bybit.py
 tests/exchange/test_ccxt_compat.py
-tests/exchange/test_ccxt_precise.py
 tests/exchange/test_exchange.py
 tests/exchange/test_exchange_utils.py
 tests/exchange/test_gate.py
 tests/exchange/test_huobi.py
 tests/exchange/test_kraken.py
 tests/exchange/test_kucoin.py
 tests/exchange/test_okx.py
```

### Comparing `freqtrade-2023.4/freqtrade.egg-info/requires.txt` & `freqtrade-2023.5/freqtrade.egg-info/requires.txt`

 * *Files 18% similar despite different names*

```diff
@@ -1,11 +1,11 @@
-ccxt>=2.6.26
+ccxt>=3.0.0
 SQLAlchemy>=2.0.6
-python-telegram-bot>=13.4
-arrow>=0.17.0
+python-telegram-bot>=20.1
+arrow>=1.0.0
 cachetools
 requests
 urllib3
 jsonschema
 TA-Lib
 pandas-ta
 technical
@@ -28,89 +28,122 @@
 uvicorn
 psutil
 pyjwt
 aiofiles
 schedule
 websockets
 janus
+ast-comments
+aiohttp
+cryptography
+httpx
+python-dateutil
+packaging
 
 [:platform_machine != "armv7l"]
 pyarrow
 
 [all]
 plotly>=4.0
 coveralls
 mypy
+ruff
+pre-commit
 pytest
 pytest-asyncio
 pytest-cov
 pytest-mock
 pytest-random-order
+isort
+time-machine
+types-cachetools
+types-filelock
+types-requests
+types-tabulate
+types-python-dateutil
 jupyter
 nbstripout
 ipykernel
 nbconvert
 scipy
 scikit-learn
 scikit-optimize>=0.7.0
 filelock
 tables
 blosc
+joblib
 lightgbm
 xgboost
+tensorboard
 torch
+gymnasium
 stable-baselines3
-gym==0.21
 sb3-contrib
+tqdm
 
 [all:platform_machine != "aarch64"]
 catboost
 
 [dev]
 plotly>=4.0
 coveralls
 mypy
+ruff
+pre-commit
 pytest
 pytest-asyncio
 pytest-cov
 pytest-mock
 pytest-random-order
+isort
+time-machine
+types-cachetools
+types-filelock
+types-requests
+types-tabulate
+types-python-dateutil
 jupyter
 nbstripout
 ipykernel
 nbconvert
 scipy
 scikit-learn
 scikit-optimize>=0.7.0
 filelock
 tables
 blosc
+joblib
 lightgbm
 xgboost
+tensorboard
 torch
+gymnasium
 stable-baselines3
-gym==0.21
 sb3-contrib
+tqdm
 
 [dev:platform_machine != "aarch64"]
 catboost
 
 [freqai]
 scikit-learn
+joblib
 lightgbm
 xgboost
+tensorboard
 
 [freqai:platform_machine != "aarch64"]
 catboost
 
 [freqai_rl]
 torch
+gymnasium
 stable-baselines3
-gym==0.21
 sb3-contrib
+tqdm
 
 [hdf5]
 tables
 blosc
 
 [hyperopt]
 scipy
```

### Comparing `freqtrade-2023.4/pyproject.toml` & `freqtrade-2023.5/pyproject.toml`

 * *Files 1% similar despite different names*

```diff
@@ -1,9 +1,9 @@
 [build-system]
-requires = ["setuptools >= 46.4.0", "wheel"]
+requires = ["setuptools >= 64.0.0", "wheel"]
 build-backend = "setuptools.build_meta"
 
 [tool.black]
 line-length = 100
 exclude = '''
 (
   /(
```

### Comparing `freqtrade-2023.4/setup.cfg` & `freqtrade-2023.5/setup.cfg`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/setup.py` & `freqtrade-2023.5/setup.py`

 * *Files 6% similar despite different names*

```diff
@@ -8,39 +8,51 @@
     'scikit-learn',
     'scikit-optimize>=0.7.0',
     'filelock',
 ]
 
 freqai = [
     'scikit-learn',
+    'joblib',
     'catboost; platform_machine != "aarch64"',
     'lightgbm',
-    'xgboost'
+    'xgboost',
+    'tensorboard'
 ]
 
 freqai_rl = [
     'torch',
+    'gymnasium',
     'stable-baselines3',
-    'gym==0.21',
-    'sb3-contrib'
+    'sb3-contrib',
+    'tqdm'
 ]
 
 hdf5 = [
     'tables',
     'blosc',
 ]
 
 develop = [
     'coveralls',
     'mypy',
+    'ruff',
+    'pre-commit',
     'pytest',
     'pytest-asyncio',
     'pytest-cov',
     'pytest-mock',
     'pytest-random-order',
+    'isort',
+    'time-machine',
+    'types-cachetools',
+    'types-filelock',
+    'types-requests',
+    'types-tabulate',
+    'types-python-dateutil'
 ]
 
 jupyter = [
     'jupyter',
     'nbstripout',
     'ipykernel',
     'nbconvert',
@@ -53,18 +65,18 @@
         'pytest',
         'pytest-asyncio',
         'pytest-cov',
         'pytest-mock',
     ],
     install_requires=[
         # from requirements.txt
-        'ccxt>=2.6.26',
+        'ccxt>=3.0.0',
         'SQLAlchemy>=2.0.6',
-        'python-telegram-bot>=13.4',
-        'arrow>=0.17.0',
+        'python-telegram-bot>=20.1',
+        'arrow>=1.0.0',
         'cachetools',
         'requests',
         'urllib3',
         'jsonschema',
         'TA-Lib',
         'pandas-ta',
         'technical',
@@ -87,15 +99,21 @@
         'pydantic>=1.8.0',
         'uvicorn',
         'psutil',
         'pyjwt',
         'aiofiles',
         'schedule',
         'websockets',
-        'janus'
+        'janus',
+        'ast-comments',
+        'aiohttp',
+        'cryptography',
+        'httpx',
+        'python-dateutil',
+        'packaging',
     ],
     extras_require={
         'dev': all_extra,
         'plot': plot,
         'jupyter': jupyter,
         'hyperopt': hyperopt,
         'hdf5': hdf5,
```

### Comparing `freqtrade-2023.4/tests/commands/test_build_config.py` & `freqtrade-2023.5/tests/commands/test_build_config.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/commands/test_commands.py` & `freqtrade-2023.5/tests/commands/test_commands.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,16 +1,15 @@
 import json
 import re
-from datetime import datetime
+from datetime import datetime, timedelta
 from io import BytesIO
 from pathlib import Path
 from unittest.mock import MagicMock, PropertyMock
 from zipfile import ZipFile
 
-import arrow
 import pytest
 
 from freqtrade.commands import (start_backtesting_show, start_convert_data, start_convert_trades,
                                 start_create_userdir, start_download_data, start_hyperopt_list,
                                 start_hyperopt_show, start_install_ui, start_list_data,
                                 start_list_exchanges, start_list_markets, start_list_strategies,
                                 start_list_timeframes, start_new_strategy, start_show_trades,
@@ -21,14 +20,15 @@
                                                 get_ui_download_url, read_ui_version)
 from freqtrade.commands.list_commands import start_list_freqAI_models
 from freqtrade.configuration import setup_utils_configuration
 from freqtrade.enums import RunMode
 from freqtrade.exceptions import OperationalException
 from freqtrade.persistence.models import init_db
 from freqtrade.persistence.pairlock_middleware import PairLocks
+from freqtrade.util import dt_floor_day, dt_now, dt_utc
 from tests.conftest import (CURRENT_TEST_STRATEGY, EXMS, create_mock_trades, get_args, log_has,
                             log_has_re, patch_exchange, patched_configuration_load_config_file)
 from tests.conftest_trades import MOCK_TRADE_COUNT
 
 
 def test_setup_utils_configuration():
     args = [
@@ -685,31 +685,30 @@
         "--days", "20",
     ]
     pargs = get_args(args)
     pargs['config'] = None
     start_download_data(pargs)
     assert dl_mock.call_count == 1
     # 20days ago
-    days_ago = arrow.get(arrow.now().shift(days=-20).date()).int_timestamp
+    days_ago = dt_floor_day(dt_now() - timedelta(days=20)).timestamp()
     assert dl_mock.call_args_list[0][1]['timerange'].startts == days_ago
 
     dl_mock.reset_mock()
     args = [
         "download-data",
         "--exchange", "binance",
         "--pairs", "ETH/BTC", "XRP/BTC",
         "--timerange", "20200101-"
     ]
     pargs = get_args(args)
     pargs['config'] = None
     start_download_data(pargs)
     assert dl_mock.call_count == 1
 
-    assert dl_mock.call_args_list[0][1]['timerange'].startts == arrow.Arrow(
-        2020, 1, 1).int_timestamp
+    assert dl_mock.call_args_list[0][1]['timerange'].startts == int(dt_utc(2020, 1, 1).timestamp())
 
 
 def test_download_data_no_markets(mocker, caplog):
     dl_mock = mocker.patch('freqtrade.commands.data_commands.refresh_backtest_ohlcv_data',
                            MagicMock(return_value=["ETH/BTC", "XRP/BTC"]))
     patch_exchange(mocker, id='binance')
     mocker.patch(f'{EXMS}.markets', PropertyMock(return_value={}))
```

### Comparing `freqtrade-2023.4/tests/conftest.py` & `freqtrade-2023.5/tests/conftest.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,33 +1,33 @@
 # pragma pylint: disable=missing-docstring
 import json
 import logging
 import re
 from copy import deepcopy
-from datetime import datetime, timedelta
+from datetime import timedelta
 from pathlib import Path
 from typing import Optional
 from unittest.mock import MagicMock, Mock, PropertyMock
 
-import arrow
 import numpy as np
 import pandas as pd
 import pytest
-from telegram import Chat, Message, Update
 
 from freqtrade import constants
 from freqtrade.commands import Arguments
 from freqtrade.data.converter import ohlcv_to_dataframe
 from freqtrade.edge import PairInfo
 from freqtrade.enums import CandleType, MarginMode, RunMode, SignalDirection, TradingMode
 from freqtrade.exchange import Exchange
 from freqtrade.exchange.exchange import timeframe_to_minutes
 from freqtrade.freqtradebot import FreqtradeBot
 from freqtrade.persistence import LocalTrade, Order, Trade, init_db
 from freqtrade.resolvers import ExchangeResolver
+from freqtrade.util import dt_ts
+from freqtrade.util.datetime_helpers import dt_now
 from freqtrade.worker import Worker
 from tests.conftest_trades import (leverage_trade, mock_trade_1, mock_trade_2, mock_trade_3,
                                    mock_trade_4, mock_trade_5, mock_trade_6, short_trade)
 from tests.conftest_trades_usdt import (mock_trade_usdt_1, mock_trade_usdt_2, mock_trade_usdt_3,
                                         mock_trade_usdt_4, mock_trade_usdt_5, mock_trade_usdt_6,
                                         mock_trade_usdt_7)
 
@@ -178,15 +178,15 @@
 
 
 def get_patched_exchange(mocker, config, api_mock=None, id='binance',
                          mock_markets=True, mock_supported_modes=True) -> Exchange:
     patch_exchange(mocker, api_mock, id, mock_markets, mock_supported_modes)
     config['exchange']['name'] = id
     try:
-        exchange = ExchangeResolver.load_exchange(id, config, load_leverage_tiers=True)
+        exchange = ExchangeResolver.load_exchange(config, load_leverage_tiers=True)
     except ImportError:
         exchange = Exchange(config)
     return exchange
 
 
 def patch_wallet(mocker, free=999.9) -> None:
     mocker.patch('freqtrade.wallets.Wallets.get_free', MagicMock(
@@ -409,14 +409,22 @@
 
 @pytest.fixture(autouse=True)
 def patch_gc(mocker) -> None:
     mocker.patch("freqtrade.main.gc_set_threshold")
 
 
 @pytest.fixture(autouse=True)
+def user_dir(mocker, tmpdir) -> Path:
+    user_dir = Path(tmpdir) / "user_data"
+    mocker.patch('freqtrade.configuration.configuration.create_userdata_dir',
+                 return_value=user_dir)
+    return user_dir
+
+
+@pytest.fixture(autouse=True)
 def patch_coingekko(mocker) -> None:
     """
     Mocker to coingekko to speed up tests
     :param mocker: mocker to patch coingekko class
     :return: None
     """
 
@@ -482,15 +490,14 @@
         },
         "exit_pricing": {
             "use_order_book": False,
             "order_book_top": 1,
         },
         "exchange": {
             "name": "binance",
-            "enabled": True,
             "key": "key",
             "secret": "secret",
             "pair_whitelist": [
                 "ETH/BTC",
                 "LTC/BTC",
                 "XRP/BTC",
                 "NEO/BTC"
@@ -547,21 +554,14 @@
             ]
         },
     })
     return configuration
 
 
 @pytest.fixture
-def update():
-    _update = Update(0)
-    _update.message = Message(0, datetime.utcnow(), Chat(0, 0))
-    return _update
-
-
-@pytest.fixture
 def fee():
     return MagicMock(return_value=0.0025)
 
 
 @pytest.fixture
 def ticker():
     return MagicMock(return_value={
@@ -1660,16 +1660,16 @@
 @pytest.fixture(scope='function')
 def limit_buy_order_open():
     return {
         'id': 'mocked_limit_buy',
         'type': 'limit',
         'side': 'buy',
         'symbol': 'mocked',
-        'timestamp': arrow.utcnow().int_timestamp * 1000,
-        'datetime': arrow.utcnow().isoformat(),
+        'timestamp': dt_ts(),
+        'datetime': dt_now().isoformat(),
         'price': 0.00001099,
         'average': 0.00001099,
         'amount': 90.99181073,
         'filled': 0.0,
         'cost': 0.0009999,
         'remaining': 90.99181073,
         'status': 'open'
@@ -1688,16 +1688,16 @@
 @pytest.fixture
 def limit_buy_order_old():
     return {
         'id': 'mocked_limit_buy_old',
         'type': 'limit',
         'side': 'buy',
         'symbol': 'mocked',
-        'datetime': arrow.utcnow().shift(minutes=-601).isoformat(),
-        'timestamp': arrow.utcnow().shift(minutes=-601).int_timestamp * 1000,
+        'datetime': (dt_now() - timedelta(minutes=601)).isoformat(),
+        'timestamp': dt_ts(dt_now() - timedelta(minutes=601)),
         'price': 0.00001099,
         'amount': 90.99181073,
         'filled': 0.0,
         'remaining': 90.99181073,
         'status': 'open'
     }
 
@@ -1705,16 +1705,16 @@
 @pytest.fixture
 def limit_sell_order_old():
     return {
         'id': 'mocked_limit_sell_old',
         'type': 'limit',
         'side': 'sell',
         'symbol': 'ETH/BTC',
-        'timestamp': arrow.utcnow().shift(minutes=-601).int_timestamp * 1000,
-        'datetime': arrow.utcnow().shift(minutes=-601).isoformat(),
+        'timestamp': dt_ts(dt_now() - timedelta(minutes=601)),
+        'datetime': (dt_now() - timedelta(minutes=601)).isoformat(),
         'price': 0.00001099,
         'amount': 90.99181073,
         'filled': 0.0,
         'remaining': 90.99181073,
         'status': 'open'
     }
 
@@ -1722,16 +1722,16 @@
 @pytest.fixture
 def limit_buy_order_old_partial():
     return {
         'id': 'mocked_limit_buy_old_partial',
         'type': 'limit',
         'side': 'buy',
         'symbol': 'ETH/BTC',
-        'timestamp': arrow.utcnow().shift(minutes=-601).int_timestamp * 1000,
-        'datetime': arrow.utcnow().shift(minutes=-601).isoformat(),
+        'timestamp': dt_ts(dt_now() - timedelta(minutes=601)),
+        'datetime': (dt_now() - timedelta(minutes=601)).isoformat(),
         'price': 0.00001099,
         'amount': 90.99181073,
         'filled': 23.0,
         'cost': 90.99181073 * 23.0,
         'remaining': 67.99181073,
         'status': 'open'
     }
@@ -1753,16 +1753,16 @@
 
     exchange_name = request.param
     if exchange_name == 'kraken':
         return {
             'info': {},
             'id': 'AZNPFF-4AC4N-7MKTAT',
             'clientOrderId': None,
-            'timestamp': arrow.utcnow().shift(minutes=-601).int_timestamp * 1000,
-            'datetime': arrow.utcnow().shift(minutes=-601).isoformat(),
+            'timestamp': dt_ts(dt_now() - timedelta(minutes=601)),
+            'datetime': (dt_now() - timedelta(minutes=601)).isoformat(),
             'lastTradeTimestamp': None,
             'status': 'canceled',
             'symbol': 'LTC/USDT',
             'type': 'limit',
             'side': 'buy',
             'price': 34.3225,
             'cost': 0.0,
@@ -1774,16 +1774,16 @@
             'trades': []
         }
     elif exchange_name == 'binance':
         return {
             'info': {},
             'id': '1234512345',
             'clientOrderId': 'alb1234123',
-            'timestamp': arrow.utcnow().shift(minutes=-601).int_timestamp * 1000,
-            'datetime': arrow.utcnow().shift(minutes=-601).isoformat(),
+            'timestamp': dt_ts(dt_now() - timedelta(minutes=601)),
+            'datetime': (dt_now() - timedelta(minutes=601)).isoformat(),
             'lastTradeTimestamp': None,
             'symbol': 'LTC/USDT',
             'type': 'limit',
             'side': 'buy',
             'price': 0.016804,
             'amount': 0.55,
             'cost': 0.0,
@@ -1795,16 +1795,16 @@
             'trades': None
         }
     else:
         return {
             'info': {},
             'id': '1234512345',
             'clientOrderId': 'alb1234123',
-            'timestamp': arrow.utcnow().shift(minutes=-601).int_timestamp * 1000,
-            'datetime': arrow.utcnow().shift(minutes=-601).isoformat(),
+            'timestamp': dt_ts(dt_now() - timedelta(minutes=601)),
+            'datetime': (dt_now() - timedelta(minutes=601)).isoformat(),
             'lastTradeTimestamp': None,
             'symbol': 'LTC/USDT',
             'type': 'limit',
             'side': 'buy',
             'price': 0.016804,
             'amount': 0.55,
             'cost': 0.0,
@@ -1820,16 +1820,16 @@
 @pytest.fixture
 def limit_sell_order_open():
     return {
         'id': 'mocked_limit_sell',
         'type': 'limit',
         'side': 'sell',
         'symbol': 'mocked',
-        'datetime': arrow.utcnow().isoformat(),
-        'timestamp': arrow.utcnow().int_timestamp * 1000,
+        'datetime': dt_now().isoformat(),
+        'timestamp': dt_ts(),
         'price': 0.00001173,
         'amount': 90.99181073,
         'filled': 0.0,
         'remaining': 90.99181073,
         'status': 'open'
     }
 
@@ -2483,16 +2483,16 @@
 @pytest.fixture
 def buy_order_fee():
     return {
         'id': 'mocked_limit_buy_old',
         'type': 'limit',
         'side': 'buy',
         'symbol': 'mocked',
-        'timestamp': arrow.utcnow().shift(minutes=-601).int_timestamp * 1000,
-        'datetime': arrow.utcnow().shift(minutes=-601).isoformat(),
+        'timestamp': dt_ts(dt_now() - timedelta(minutes=601)),
+        'datetime': (dt_now() - timedelta(minutes=601)).isoformat(),
         'price': 0.245441,
         'amount': 8.0,
         'cost': 1.963528,
         'remaining': 90.99181073,
         'status': 'closed',
         'fee': None
     }
@@ -2593,15 +2593,15 @@
         open_rate=0.00001099,
         exchange='binance',
         open_order_id='123456789',
         amount=90.99181073,
         fee_open=0.0,
         fee_close=0.0,
         stake_amount=1,
-        open_date=arrow.utcnow().shift(minutes=-601).datetime,
+        open_date=dt_now() - timedelta(minutes=601),
         is_open=True
     )
     trade.orders = [
         Order(
             ft_order_side='buy',
             ft_pair=trade.pair,
             ft_is_open=False,
@@ -2631,15 +2631,15 @@
         open_rate=2.0,
         exchange='binance',
         open_order_id='123456789_exit',
         amount=30.0,
         fee_open=0.0,
         fee_close=0.0,
         stake_amount=60.0,
-        open_date=arrow.utcnow().shift(minutes=-601).datetime,
+        open_date=dt_now() - timedelta(minutes=601),
         is_open=True
     )
     trade.orders = [
         Order(
             ft_order_side='buy',
             ft_pair=trade.pair,
             ft_is_open=False,
@@ -2835,16 +2835,16 @@
 @pytest.fixture(scope='function')
 def limit_buy_order_usdt_open():
     return {
         'id': 'mocked_limit_buy_usdt',
         'type': 'limit',
         'side': 'buy',
         'symbol': 'mocked',
-        'datetime': arrow.utcnow().isoformat(),
-        'timestamp': arrow.utcnow().int_timestamp * 1000,
+        'datetime': dt_now().isoformat(),
+        'timestamp': dt_ts(),
         'price': 2.00,
         'average': 2.00,
         'amount': 30.0,
         'filled': 0.0,
         'cost': 60.0,
         'remaining': 30.0,
         'status': 'open'
@@ -2863,16 +2863,16 @@
 @pytest.fixture
 def limit_sell_order_usdt_open():
     return {
         'id': 'mocked_limit_sell_usdt',
         'type': 'limit',
         'side': 'sell',
         'symbol': 'mocked',
-        'datetime': arrow.utcnow().isoformat(),
-        'timestamp': arrow.utcnow().int_timestamp * 1000,
+        'datetime': dt_now().isoformat(),
+        'timestamp': dt_ts(),
         'price': 2.20,
         'amount': 30.0,
         'cost': 66.0,
         'filled': 0.0,
         'remaining': 30.0,
         'status': 'open'
     }
@@ -2890,16 +2890,16 @@
 @pytest.fixture(scope='function')
 def market_buy_order_usdt():
     return {
         'id': 'mocked_market_buy',
         'type': 'market',
         'side': 'buy',
         'symbol': 'mocked',
-        'timestamp': arrow.utcnow().int_timestamp * 1000,
-        'datetime': arrow.utcnow().isoformat(),
+        'timestamp': dt_ts(),
+        'datetime': dt_now().isoformat(),
         'price': 2.00,
         'amount': 30.0,
         'filled': 30.0,
         'remaining': 0.0,
         'status': 'closed'
     }
 
@@ -2947,16 +2947,16 @@
 @pytest.fixture
 def market_sell_order_usdt():
     return {
         'id': 'mocked_limit_sell',
         'type': 'market',
         'side': 'sell',
         'symbol': 'mocked',
-        'timestamp': arrow.utcnow().int_timestamp * 1000,
-        'datetime': arrow.utcnow().isoformat(),
+        'timestamp': dt_ts(),
+        'datetime': dt_now().isoformat(),
         'price': 2.20,
         'amount': 30.0,
         'filled': 30.0,
         'remaining': 0.0,
         'status': 'closed'
     }
```

### Comparing `freqtrade-2023.4/tests/conftest_trades.py` & `freqtrade-2023.5/tests/conftest_trades.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/conftest_trades_usdt.py` & `freqtrade-2023.5/tests/conftest_trades_usdt.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/data/test_btanalysis.py` & `freqtrade-2023.5/tests/data/test_btanalysis.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,12 +1,12 @@
+from datetime import datetime, timedelta, timezone
 from pathlib import Path
 from unittest.mock import MagicMock
 
 import pytest
-from arrow import Arrow
 from pandas import DataFrame, DateOffset, Timestamp, to_datetime
 
 from freqtrade.configuration import TimeRange
 from freqtrade.constants import LAST_BT_RESULT_FN
 from freqtrade.data.btanalysis import (BT_DATA_COLUMNS, analyze_trade_parallelism,
                                        extract_trades_of_period, get_latest_backtest_filename,
                                        get_latest_hyperopt_file, load_backtest_data,
@@ -14,14 +14,15 @@
 from freqtrade.data.history import load_data, load_pair_history
 from freqtrade.data.metrics import (calculate_cagr, calculate_calmar, calculate_csum,
                                     calculate_expectancy, calculate_market_change,
                                     calculate_max_drawdown, calculate_sharpe, calculate_sortino,
                                     calculate_underwater, combine_dataframes_with_mean,
                                     create_cum_profit)
 from freqtrade.exceptions import OperationalException
+from freqtrade.util import dt_utc
 from tests.conftest import CURRENT_TEST_STRATEGY, create_mock_trades
 from tests.conftest_trades import MOCK_TRADE_COUNT
 
 
 def test_get_latest_backtest_filename(testdatadir, mocker):
     with pytest.raises(ValueError, match=r"Directory .* does not exist\."):
         get_latest_backtest_filename(testdatadir / 'does_not_exist')
@@ -158,33 +159,33 @@
     data = load_pair_history(pair=pair, timeframe='1m',
                              datadir=testdatadir, timerange=timerange)
 
     trades = DataFrame(
         {'pair': [pair, pair, pair, pair],
          'profit_ratio': [0.0, 0.1, -0.2, -0.5],
          'profit_abs': [0.0, 1, -2, -5],
-         'open_date': to_datetime([Arrow(2017, 11, 13, 15, 40, 0).datetime,
-                                   Arrow(2017, 11, 14, 9, 41, 0).datetime,
-                                   Arrow(2017, 11, 14, 14, 20, 0).datetime,
-                                   Arrow(2017, 11, 15, 3, 40, 0).datetime,
+         'open_date': to_datetime([datetime(2017, 11, 13, 15, 40, 0, tzinfo=timezone.utc),
+                                   datetime(2017, 11, 14, 9, 41, 0, tzinfo=timezone.utc),
+                                   datetime(2017, 11, 14, 14, 20, 0, tzinfo=timezone.utc),
+                                   datetime(2017, 11, 15, 3, 40, 0, tzinfo=timezone.utc),
                                    ], utc=True
                                   ),
-         'close_date': to_datetime([Arrow(2017, 11, 13, 16, 40, 0).datetime,
-                                    Arrow(2017, 11, 14, 10, 41, 0).datetime,
-                                    Arrow(2017, 11, 14, 15, 25, 0).datetime,
-                                    Arrow(2017, 11, 15, 3, 55, 0).datetime,
+         'close_date': to_datetime([datetime(2017, 11, 13, 16, 40, 0, tzinfo=timezone.utc),
+                                    datetime(2017, 11, 14, 10, 41, 0, tzinfo=timezone.utc),
+                                    datetime(2017, 11, 14, 15, 25, 0, tzinfo=timezone.utc),
+                                    datetime(2017, 11, 15, 3, 55, 0, tzinfo=timezone.utc),
                                     ], utc=True)
          })
     trades1 = extract_trades_of_period(data, trades)
     # First and last trade are dropped as they are out of range
     assert len(trades1) == 2
-    assert trades1.iloc[0].open_date == Arrow(2017, 11, 14, 9, 41, 0).datetime
-    assert trades1.iloc[0].close_date == Arrow(2017, 11, 14, 10, 41, 0).datetime
-    assert trades1.iloc[-1].open_date == Arrow(2017, 11, 14, 14, 20, 0).datetime
-    assert trades1.iloc[-1].close_date == Arrow(2017, 11, 14, 15, 25, 0).datetime
+    assert trades1.iloc[0].open_date == datetime(2017, 11, 14, 9, 41, 0, tzinfo=timezone.utc)
+    assert trades1.iloc[0].close_date == datetime(2017, 11, 14, 10, 41, 0, tzinfo=timezone.utc)
+    assert trades1.iloc[-1].open_date == datetime(2017, 11, 14, 14, 20, 0, tzinfo=timezone.utc)
+    assert trades1.iloc[-1].close_date == datetime(2017, 11, 14, 15, 25, 0, tzinfo=timezone.utc)
 
 
 def test_analyze_trade_parallelism(testdatadir):
     filename = testdatadir / "backtest_results/backtest-result.json"
     bt_data = load_backtest_data(filename)
 
     res = analyze_trade_parallelism(bt_data, "5m")
@@ -416,15 +417,15 @@
 
 def test_calculate_max_drawdown2():
     values = [0.011580, 0.010048, 0.011340, 0.012161, 0.010416, 0.010009, 0.020024,
               -0.024662, -0.022350, 0.020496, -0.029859, -0.030511, 0.010041, 0.010872,
               -0.025782, 0.010400, 0.012374, 0.012467, 0.114741, 0.010303, 0.010088,
               -0.033961, 0.010680, 0.010886, -0.029274, 0.011178, 0.010693, 0.010711]
 
-    dates = [Arrow(2020, 1, 1).shift(days=i) for i in range(len(values))]
+    dates = [dt_utc(2020, 1, 1) + timedelta(days=i) for i in range(len(values))]
     df = DataFrame(zip(values, dates), columns=['profit', 'open_date'])
     # sort by profit and reset index
     df = df.sort_values('profit').reset_index(drop=True)
     df1 = df.copy()
     drawdown, hdate, ldate, hval, lval, drawdown_rel = calculate_max_drawdown(
         df, date_col='open_date', value_col='profit')
     # Ensure df has not been altered.
@@ -450,29 +451,29 @@
 ])
 def test_calculate_max_drawdown_abs(profits, relative, highd, lowd, result, result_rel):
     """
     Test case from issue https://github.com/freqtrade/freqtrade/issues/6655
     [1000, 500,  1000, 11000, 10000] # absolute results
     [1000, 50%,  0%,   0%,       ~9%]   # Relative drawdowns
     """
-    init_date = Arrow(2020, 1, 1)
-    dates = [init_date.shift(days=i) for i in range(len(profits))]
+    init_date = datetime(2020, 1, 1, tzinfo=timezone.utc)
+    dates = [init_date + timedelta(days=i) for i in range(len(profits))]
     df = DataFrame(zip(profits, dates), columns=['profit_abs', 'open_date'])
     # sort by profit and reset index
     df = df.sort_values('profit_abs').reset_index(drop=True)
     df1 = df.copy()
     drawdown, hdate, ldate, hval, lval, drawdown_rel = calculate_max_drawdown(
         df, date_col='open_date', starting_balance=1000, relative=relative)
     # Ensure df has not been altered.
     assert df.equals(df1)
 
     assert isinstance(drawdown, float)
     assert isinstance(drawdown_rel, float)
-    assert hdate == init_date.shift(days=highd)
-    assert ldate == init_date.shift(days=lowd)
+    assert hdate == init_date + timedelta(days=highd)
+    assert ldate == init_date + timedelta(days=lowd)
 
     # High must be before low
     assert hdate < ldate
     # High value must be higher than low value
     assert hval > lval
     assert drawdown == result
     assert pytest.approx(drawdown_rel) == result_rel
```

### Comparing `freqtrade-2023.4/tests/data/test_converter.py` & `freqtrade-2023.5/tests/data/test_converter.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/data/test_datahandler.py` & `freqtrade-2023.5/tests/data/test_datahandler.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/data/test_dataprovider.py` & `freqtrade-2023.5/tests/data/test_dataprovider.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/data/test_entryexitanalysis.py` & `freqtrade-2023.5/tests/data/test_entryexitanalysis.py`

 * *Files 8% similar despite different names*

```diff
@@ -14,16 +14,17 @@
 @pytest.fixture(autouse=True)
 def entryexitanalysis_cleanup() -> None:
     yield None
 
     Backtesting.cleanup()
 
 
-def test_backtest_analysis_nomock(default_conf, mocker, caplog, testdatadir, tmpdir, capsys):
+def test_backtest_analysis_nomock(default_conf, mocker, caplog, testdatadir, user_dir, capsys):
     caplog.set_level(logging.INFO)
+    (user_dir / 'backtest_results').mkdir(parents=True, exist_ok=True)
 
     default_conf.update({
         "use_exit_signal": True,
         "exit_profit_only": False,
         "exit_profit_offset": 0.0,
         "ignore_roi_if_entry_signal": False,
     })
@@ -76,15 +77,15 @@
 
     patched_configuration_load_config_file(mocker, default_conf)
 
     args = [
         'backtesting',
         '--config', 'config.json',
         '--datadir', str(testdatadir),
-        '--user-data-dir', str(tmpdir),
+        '--user-data-dir', str(user_dir),
         '--timeframe', '5m',
         '--timerange', '1515560100-1517287800',
         '--export', 'signals',
         '--cache', 'none',
     ]
     args = get_args(args)
     start_backtesting(args)
@@ -94,15 +95,15 @@
     assert 'EXIT REASON STATS' in captured.out
     assert 'LEFT OPEN TRADES REPORT' in captured.out
 
     base_args = [
         'backtesting-analysis',
         '--config', 'config.json',
         '--datadir', str(testdatadir),
-        '--user-data-dir', str(tmpdir),
+        '--user-data-dir', str(user_dir),
     ]
 
     # test group 0 and indicator list
     args = get_args(base_args +
                     ['--analysis-groups', "0",
                      '--indicator-list', "close", "rsi", "profit_abs"]
                     )
@@ -196,12 +197,21 @@
     captured = capsys.readouterr()
     assert 'exit_signal' in captured.out
     assert 'roi' in captured.out
     assert 'stop_loss' in captured.out
     assert 'trailing_stop_loss' in captured.out
 
     # test date filtering
-    args = get_args(base_args + ['--timerange', "20180129-20180130"])
+    args = get_args(base_args +
+                    ['--analysis-groups', "0", "1", "2",
+                     '--timerange', "20180129-20180130"]
+                    )
     start_analysis_entries_exits(args)
     captured = capsys.readouterr()
     assert 'enter_tag_long_a' in captured.out
     assert 'enter_tag_long_b' not in captured.out
+
+    # Due to the backtest mock, there's no rejected signals generated.
+    args = get_args(base_args + ['--rejected-signals'])
+    start_analysis_entries_exits(args)
+    captured = capsys.readouterr()
+    assert 'no rejected signals' in captured.out
```

### Comparing `freqtrade-2023.4/tests/data/test_history.py` & `freqtrade-2023.5/tests/data/test_history.py`

 * *Files 2% similar despite different names*

```diff
@@ -2,15 +2,14 @@
 
 import json
 import uuid
 from pathlib import Path
 from shutil import copyfile
 from unittest.mock import MagicMock, PropertyMock
 
-import arrow
 import pytest
 from pandas import DataFrame
 from pandas.testing import assert_frame_equal
 
 from freqtrade.configuration import TimeRange
 from freqtrade.constants import DATETIME_PRINT_FORMAT
 from freqtrade.data.converter import ohlcv_to_dataframe
@@ -22,14 +21,15 @@
                                                   validate_backtest_data)
 from freqtrade.data.history.idatahandler import get_datahandler
 from freqtrade.data.history.jsondatahandler import JsonDataHandler, JsonGzDataHandler
 from freqtrade.enums import CandleType
 from freqtrade.exchange import timeframe_to_minutes
 from freqtrade.misc import file_dump_json
 from freqtrade.resolvers import StrategyResolver
+from freqtrade.util import dt_utc
 from tests.conftest import (CURRENT_TEST_STRATEGY, EXMS, get_patched_exchange, log_has, log_has_re,
                             patch_exchange)
 
 
 def _clean_test_file(file: Path) -> None:
     """
     Backup existing file to avoid deleting the user file
@@ -194,15 +194,14 @@
     with test_filename.open("rt") as file:
         test_data = json.load(file)
 
     test_data_df = ohlcv_to_dataframe(test_data, '1m', 'UNITTEST/BTC',
                                       fill_missing=False, drop_incomplete=False)
     # now = last cached item + 1 hour
     now_ts = test_data[-1][0] / 1000 + 60 * 60
-    mocker.patch('arrow.utcnow', return_value=arrow.get(now_ts))
 
     # timeframe starts earlier than the cached data
     # should fully update data
     timerange = TimeRange('date', None, test_data[0][0] / 1000 - 1, 0)
     data, start_ts, end_ts = _load_cached_data_for_updating(
         'UNITTEST/BTC', '1m', timerange, data_handler, CandleType.SPOT)
     assert data.empty
@@ -349,40 +348,40 @@
                                       pair='MEME/BTC',
                                       timeframe='1m', candle_type='spot')
     assert log_has('Failed to download history data for pair: "MEME/BTC", timeframe: 1m.', caplog)
 
 
 def test_load_partial_missing(testdatadir, caplog) -> None:
     # Make sure we start fresh - test missing data at start
-    start = arrow.get('2018-01-01T00:00:00')
-    end = arrow.get('2018-01-11T00:00:00')
+    start = dt_utc(2018, 1, 1)
+    end = dt_utc(2018, 1, 11)
     data = load_data(testdatadir, '5m', ['UNITTEST/BTC'], startup_candles=20,
-                     timerange=TimeRange('date', 'date', start.int_timestamp, end.int_timestamp))
+                     timerange=TimeRange('date', 'date', start.timestamp(), end.timestamp()))
     assert log_has(
         'Using indicator startup period: 20 ...', caplog
     )
     # timedifference in 5 minutes
     td = ((end - start).total_seconds() // 60 // 5) + 1
     assert td != len(data['UNITTEST/BTC'])
     start_real = data['UNITTEST/BTC'].iloc[0, 0]
     assert log_has(f'UNITTEST/BTC, spot, 5m, '
                    f'data starts at {start_real.strftime(DATETIME_PRINT_FORMAT)}',
                    caplog)
     # Make sure we start fresh - test missing data at end
     caplog.clear()
-    start = arrow.get('2018-01-10T00:00:00')
-    end = arrow.get('2018-02-20T00:00:00')
+    start = dt_utc(2018, 1, 10)
+    end = dt_utc(2018, 2, 20)
     data = load_data(datadir=testdatadir, timeframe='5m', pairs=['UNITTEST/BTC'],
-                     timerange=TimeRange('date', 'date', start.int_timestamp, end.int_timestamp))
+                     timerange=TimeRange('date', 'date', start.timestamp(), end.timestamp()))
     # timedifference in 5 minutes
     td = ((end - start).total_seconds() // 60 // 5) + 1
     assert td != len(data['UNITTEST/BTC'])
 
     # Shift endtime with +5
-    end_real = arrow.get(data['UNITTEST/BTC'].iloc[-1, 0])
+    end_real = data['UNITTEST/BTC'].iloc[-1, 0].to_pydatetime()
     assert log_has(f'UNITTEST/BTC, spot, 5m, '
                    f'data ends at {end_real.strftime(DATETIME_PRINT_FORMAT)}',
                    caplog)
 
 
 def test_init(default_conf) -> None:
     assert {} == load_data(
```

### Comparing `freqtrade-2023.4/tests/edge/test_edge.py` & `freqtrade-2023.5/tests/edge/test_edge.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,37 +1,38 @@
 # pragma pylint: disable=missing-docstring, C0103, C0330
 # pragma pylint: disable=protected-access, too-many-lines, invalid-name, too-many-arguments
 
 import logging
 import math
+from datetime import timedelta
 from unittest.mock import MagicMock
 
-import arrow
 import numpy as np
 import pytest
 from pandas import DataFrame
 
 from freqtrade.data.converter import ohlcv_to_dataframe
 from freqtrade.edge import Edge, PairInfo
 from freqtrade.enums import ExitType
 from freqtrade.exceptions import OperationalException
+from freqtrade.util.datetime_helpers import dt_ts, dt_utc
 from tests.conftest import EXMS, get_patched_freqtradebot, log_has
 from tests.optimize import (BTContainer, BTrade, _build_backtest_dataframe,
                             _get_frame_time_from_offset)
 
 
 # Cases to be tested:
 # 1) Open trade should be removed from the end
 # 2) Two complete trades within dataframe (with sell hit for all)
 # 3) Entered, sl 1%, candle drops 8% => Trade closed, 1% loss
 # 4) Entered, sl 3%, candle drops 4%, recovers to 1% => Trade closed, 3% loss
 # 5) Stoploss and sell are hit. should sell on stoploss
 ####################################################################
 
-tests_start_time = arrow.get(2018, 10, 3)
+tests_start_time = dt_utc(2018, 10, 3)
 timeframe_in_minute = 60
 
 # End helper functions
 # Open trade should be removed from the end
 tc0 = BTContainer(data=[
     # D  O     H     L     C     V    B  S
     [0, 5000, 5025, 4975, 4987, 6172, 1, 0],
@@ -216,39 +217,39 @@
 
 def test_edge_heartbeat_calculate(mocker, edge_conf):
     freqtrade = get_patched_freqtradebot(mocker, edge_conf)
     edge = Edge(edge_conf, freqtrade.exchange, freqtrade.strategy)
     heartbeat = edge_conf['edge']['process_throttle_secs']
 
     # should not recalculate if heartbeat not reached
-    edge._last_updated = arrow.utcnow().int_timestamp - heartbeat + 1
+    edge._last_updated = dt_ts() - heartbeat + 1
 
     assert edge.calculate(edge_conf['exchange']['pair_whitelist']) is False
 
 
 def mocked_load_data(datadir, pairs=[], timeframe='0m',
                      timerange=None, *args, **kwargs):
     hz = 0.1
     base = 0.001
 
     NEOBTC = [
         [
-            tests_start_time.shift(minutes=(x * timeframe_in_minute)).int_timestamp * 1000,
+            dt_ts(tests_start_time + timedelta(minutes=(x * timeframe_in_minute))),
             math.sin(x * hz) / 1000 + base,
             math.sin(x * hz) / 1000 + base + 0.0001,
             math.sin(x * hz) / 1000 + base - 0.0001,
             math.sin(x * hz) / 1000 + base,
             123.45
         ] for x in range(0, 500)]
 
     hz = 0.2
     base = 0.002
     LTCBTC = [
         [
-            tests_start_time.shift(minutes=(x * timeframe_in_minute)).int_timestamp * 1000,
+            dt_ts(tests_start_time + timedelta(minutes=(x * timeframe_in_minute))),
             math.sin(x * hz) / 1000 + base,
             math.sin(x * hz) / 1000 + base + 0.0001,
             math.sin(x * hz) / 1000 + base - 0.0001,
             math.sin(x * hz) / 1000 + base,
             123.45
         ] for x in range(0, 500)]
 
@@ -264,15 +265,15 @@
     mocker.patch(f'{EXMS}.get_fee', MagicMock(return_value=0.001))
     mocker.patch('freqtrade.edge.edge_positioning.refresh_data', MagicMock())
     mocker.patch('freqtrade.edge.edge_positioning.load_data', mocked_load_data)
     edge = Edge(edge_conf, freqtrade.exchange, freqtrade.strategy)
 
     assert edge.calculate(edge_conf['exchange']['pair_whitelist'])
     assert len(edge._cached_pairs) == 2
-    assert edge._last_updated <= arrow.utcnow().int_timestamp + 2
+    assert edge._last_updated <= dt_ts() + 2
 
 
 def test_edge_process_no_data(mocker, edge_conf, caplog):
     freqtrade = get_patched_freqtradebot(mocker, edge_conf)
     mocker.patch(f'{EXMS}.get_fee', MagicMock(return_value=0.001))
     mocker.patch('freqtrade.edge.edge_positioning.refresh_data', MagicMock())
     mocker.patch('freqtrade.edge.edge_positioning.load_data', MagicMock(return_value={}))
```

### Comparing `freqtrade-2023.4/tests/exchange/test_binance.py` & `freqtrade-2023.5/tests/exchange/test_binance.py`

 * *Files 0% similar despite different names*

```diff
@@ -510,28 +510,28 @@
         assert isinstance(v, list)
         # Assert if conftest leverage tiers have less or equal tiers than the exchange
         assert len(v) >= len(value)
 
 
 def test_additional_exchange_init_binance(default_conf, mocker):
     api_mock = MagicMock()
-    api_mock.fapiPrivateGetPositionsideDual = MagicMock(return_value={"dualSidePosition": True})
+    api_mock.fapiPrivateGetPositionSideDual = MagicMock(return_value={"dualSidePosition": True})
     api_mock.fapiPrivateGetMultiAssetsMargin = MagicMock(return_value={"multiAssetsMargin": True})
     default_conf['dry_run'] = False
     default_conf['trading_mode'] = TradingMode.FUTURES
     default_conf['margin_mode'] = MarginMode.ISOLATED
     with pytest.raises(OperationalException,
                        match=r"Hedge Mode is not supported.*\nMulti-Asset Mode is not supported.*"):
         get_patched_exchange(mocker, default_conf, id="binance", api_mock=api_mock)
-    api_mock.fapiPrivateGetPositionsideDual = MagicMock(return_value={"dualSidePosition": False})
+    api_mock.fapiPrivateGetPositionSideDual = MagicMock(return_value={"dualSidePosition": False})
     api_mock.fapiPrivateGetMultiAssetsMargin = MagicMock(return_value={"multiAssetsMargin": False})
     exchange = get_patched_exchange(mocker, default_conf, id="binance", api_mock=api_mock)
     assert exchange
     ccxt_exceptionhandlers(mocker, default_conf, api_mock, 'binance',
-                           "additional_exchange_init", "fapiPrivateGetPositionsideDual")
+                           "additional_exchange_init", "fapiPrivateGetPositionSideDual")
 
 
 def test__set_leverage_binance(mocker, default_conf):
 
     api_mock = MagicMock()
     api_mock.set_leverage = MagicMock()
     type(api_mock).has = PropertyMock(return_value={'setLeverage': True})
```

### Comparing `freqtrade-2023.4/tests/exchange/test_bitpanda.py` & `freqtrade-2023.5/tests/exchange/test_bitpanda.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/exchange/test_bybit.py` & `freqtrade-2023.5/tests/exchange/test_bybit.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/exchange/test_ccxt_compat.py` & `freqtrade-2023.5/tests/exchange/test_ccxt_compat.py`

 * *Files 2% similar despite different names*

```diff
@@ -39,14 +39,18 @@
         'hasQuoteVolume': True,
         'timeframe': '1h',
         'futures': True,
         'futures_pair': 'BTC/USDT:USDT',
         'hasQuoteVolumeFutures': True,
         'leverage_tiers_public': False,
         'leverage_in_spot_market': False,
+        'private_methods': [
+            'fapiPrivateGetPositionSideDual',
+            'fapiPrivateGetMultiAssetsMargin'
+        ],
         'sample_order': [{
             "symbol": "SOLUSDT",
             "orderId": 3551312894,
             "orderListId": -1,
             "clientOrderId": "x-R4DD3S8297c73a11ccb9dc8f2811ba",
             "transactTime": 1674493798550,
             "price": "15.50000000",
@@ -217,19 +221,21 @@
         'hasQuoteVolume': True,
         'timeframe': '1h',
         'futures': True,
         'futures_pair': 'BTC/USDT:USDT',
         'hasQuoteVolumeFutures': False,
         'leverage_tiers_public': True,
         'leverage_in_spot_market': True,
+        'private_methods': ['fetch_accounts'],
     },
     'bybit': {
         'pair': 'BTC/USDT',
         'stake_currency': 'USDT',
         'hasQuoteVolume': True,
+        'use_ci_proxy': True,
         'timeframe': '1h',
         'futures_pair': 'BTC/USDT:USDT',
         'futures': True,
         'leverage_tiers_public': True,
         'leverage_in_spot_market': True,
         'sample_order': [
             {
@@ -298,15 +304,15 @@
 
 @pytest.fixture(params=EXCHANGES, scope="class")
 def exchange(request, exchange_conf):
     exchange_conf = set_test_proxy(
         exchange_conf, EXCHANGES[request.param].get('use_ci_proxy', False))
     exchange_conf['exchange']['name'] = request.param
     exchange_conf['stake_currency'] = EXCHANGES[request.param]['stake_currency']
-    exchange = ExchangeResolver.load_exchange(request.param, exchange_conf, validate=True)
+    exchange = ExchangeResolver.load_exchange(exchange_conf, validate=True)
 
     yield exchange, request.param
 
 
 @pytest.fixture(params=EXCHANGES, scope="class")
 def exchange_futures(request, exchange_conf, class_mocker):
     if EXCHANGES[request.param].get('futures') is not True:
@@ -326,15 +332,15 @@
         class_mocker.patch('freqtrade.exchange.okx.Okx.additional_exchange_init')
         class_mocker.patch('freqtrade.exchange.binance.Binance.additional_exchange_init')
         class_mocker.patch('freqtrade.exchange.bybit.Bybit.additional_exchange_init')
         class_mocker.patch(f'{EXMS}.load_cached_leverage_tiers', return_value=None)
         class_mocker.patch(f'{EXMS}.cache_leverage_tiers')
 
         exchange = ExchangeResolver.load_exchange(
-            request.param, exchange_conf, validate=True, load_leverage_tiers=True)
+            exchange_conf, validate=True, load_leverage_tiers=True)
 
         yield exchange, request.param
 
 
 @pytest.mark.longrun
 class TestCCXTExchange():
 
@@ -751,7 +757,12 @@
             futures_pair = EXCHANGES[futures_name].get(
                 'futures_pair',
                 EXCHANGES[futures_name]['pair']
             )
             max_stake_amount = futures.get_max_pair_stake_amount(futures_pair, 40000)
             assert (isinstance(max_stake_amount, float))
             assert max_stake_amount >= 0.0
+
+    def test_private_method_presence(self, exchange: EXCHANGE_FIXTURE_TYPE):
+        exch, exchangename = exchange
+        for method in EXCHANGES[exchangename].get('private_methods', []):
+            assert hasattr(exch._api, method)
```

### Comparing `freqtrade-2023.4/tests/exchange/test_exchange.py` & `freqtrade-2023.5/tests/exchange/test_exchange.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,32 +1,32 @@
 import copy
 import logging
 from copy import deepcopy
 from datetime import datetime, timedelta, timezone
 from random import randint
 from unittest.mock import MagicMock, Mock, PropertyMock, patch
 
-import arrow
 import ccxt
 import pytest
 from ccxt import DECIMAL_PLACES, ROUND, ROUND_UP, TICK_SIZE, TRUNCATE
 from pandas import DataFrame
 
 from freqtrade.enums import CandleType, MarginMode, TradingMode
 from freqtrade.exceptions import (DDosProtection, DependencyException, ExchangeError,
                                   InsufficientFundsError, InvalidOrderException,
                                   OperationalException, PricingError, TemporaryError)
 from freqtrade.exchange import (Binance, Bittrex, Exchange, Kraken, amount_to_precision,
                                 date_minus_candles, market_is_active, price_to_precision,
                                 timeframe_to_minutes, timeframe_to_msecs, timeframe_to_next_date,
                                 timeframe_to_prev_date, timeframe_to_seconds)
 from freqtrade.exchange.common import (API_FETCH_ORDER_RETRY_COUNT, API_RETRY_COUNT,
-                                       calculate_backoff, remove_credentials)
+                                       calculate_backoff, remove_exchange_credentials)
 from freqtrade.exchange.exchange import amount_to_contract_precision
 from freqtrade.resolvers.exchange_resolver import ExchangeResolver
+from freqtrade.util import dt_now, dt_ts
 from tests.conftest import (EXMS, generate_test_data_raw, get_mock_coro, get_patched_exchange,
                             log_has, log_has_re, num_log_has_re)
 
 
 # Make sure to always keep one exchange here which is NOT subclassed!!
 EXCHANGES = ['bittrex', 'binance', 'kraken', 'gate', 'kucoin', 'bybit']
 
@@ -133,24 +133,22 @@
 
 def test_init(default_conf, mocker, caplog):
     caplog.set_level(logging.INFO)
     get_patched_exchange(mocker, default_conf)
     assert log_has('Instance is running with dry_run enabled', caplog)
 
 
-def test_remove_credentials(default_conf, caplog) -> None:
+def test_remove_exchange_credentials(default_conf) -> None:
     conf = deepcopy(default_conf)
-    conf['dry_run'] = False
-    remove_credentials(conf)
+    remove_exchange_credentials(conf['exchange'], False)
 
     assert conf['exchange']['key'] != ''
     assert conf['exchange']['secret'] != ''
 
-    conf['dry_run'] = True
-    remove_credentials(conf)
+    remove_exchange_credentials(conf['exchange'], True)
     assert conf['exchange']['key'] == ''
     assert conf['exchange']['secret'] == ''
     assert conf['exchange']['password'] == ''
     assert conf['exchange']['uid'] == ''
 
 
 def test_init_ccxt_kwargs(default_conf, mocker, caplog):
@@ -224,44 +222,48 @@
 def test_exchange_resolver(default_conf, mocker, caplog):
     mocker.patch(f'{EXMS}._init_ccxt', MagicMock(return_value=MagicMock()))
     mocker.patch(f'{EXMS}._load_async_markets')
     mocker.patch(f'{EXMS}.validate_pairs')
     mocker.patch(f'{EXMS}.validate_timeframes')
     mocker.patch(f'{EXMS}.validate_stakecurrency')
     mocker.patch(f'{EXMS}.validate_pricing')
-
-    exchange = ExchangeResolver.load_exchange('zaif', default_conf)
+    default_conf['exchange']['name'] = 'zaif'
+    exchange = ExchangeResolver.load_exchange(default_conf)
     assert isinstance(exchange, Exchange)
     assert log_has_re(r"No .* specific subclass found. Using the generic class instead.", caplog)
     caplog.clear()
 
-    exchange = ExchangeResolver.load_exchange('Bittrex', default_conf)
+    default_conf['exchange']['name'] = 'Bittrex'
+    exchange = ExchangeResolver.load_exchange(default_conf)
     assert isinstance(exchange, Exchange)
     assert isinstance(exchange, Bittrex)
     assert not log_has_re(r"No .* specific subclass found. Using the generic class instead.",
                           caplog)
     caplog.clear()
 
-    exchange = ExchangeResolver.load_exchange('kraken', default_conf)
+    default_conf['exchange']['name'] = 'kraken'
+    exchange = ExchangeResolver.load_exchange(default_conf)
     assert isinstance(exchange, Exchange)
     assert isinstance(exchange, Kraken)
     assert not isinstance(exchange, Binance)
     assert not log_has_re(r"No .* specific subclass found. Using the generic class instead.",
                           caplog)
 
-    exchange = ExchangeResolver.load_exchange('binance', default_conf)
+    default_conf['exchange']['name'] = 'binance'
+    exchange = ExchangeResolver.load_exchange(default_conf)
     assert isinstance(exchange, Exchange)
     assert isinstance(exchange, Binance)
     assert not isinstance(exchange, Kraken)
 
     assert not log_has_re(r"No .* specific subclass found. Using the generic class instead.",
                           caplog)
 
     # Test mapping
-    exchange = ExchangeResolver.load_exchange('binanceus', default_conf)
+    default_conf['exchange']['name'] = 'binanceus'
+    exchange = ExchangeResolver.load_exchange(default_conf)
     assert isinstance(exchange, Exchange)
     assert isinstance(exchange, Binance)
     assert not isinstance(exchange, Kraken)
 
 
 def test_validate_order_time_in_force(default_conf, mocker, caplog):
     caplog.set_level(logging.INFO)
@@ -638,26 +640,26 @@
 
     api_mock = MagicMock()
     api_mock.load_markets = MagicMock(return_value=initial_markets)
     default_conf['exchange']['markets_refresh_interval'] = 10
     exchange = get_patched_exchange(mocker, default_conf, api_mock, id="binance",
                                     mock_markets=False)
     exchange._load_async_markets = MagicMock()
-    exchange._last_markets_refresh = arrow.utcnow().int_timestamp
+    exchange._last_markets_refresh = dt_ts()
 
     assert exchange.markets == initial_markets
 
     # less than 10 minutes have passed, no reload
     exchange.reload_markets()
     assert exchange.markets == initial_markets
     assert exchange._load_async_markets.call_count == 0
 
     api_mock.load_markets = MagicMock(return_value=updated_markets)
     # more than 10 minutes have passed, reload is executed
-    exchange._last_markets_refresh = arrow.utcnow().int_timestamp - 15 * 60
+    exchange._last_markets_refresh = dt_ts(dt_now() - timedelta(minutes=15))
     exchange.reload_markets()
     assert exchange.markets == updated_markets
     assert exchange._load_async_markets.call_count == 1
     assert log_has('Performing scheduled market reload..', caplog)
 
 
 def test_reload_markets_exception(default_conf, mocker, caplog):
@@ -986,36 +988,37 @@
     mocker.patch(f'{EXMS}._init_ccxt', MagicMock(return_value=api_mock))
     mocker.patch(f'{EXMS}._load_markets', MagicMock(return_value={}))
     mocker.patch(f'{EXMS}.validate_trading_mode_and_margin_mode')
     mocker.patch(f'{EXMS}.validate_pairs')
     mocker.patch(f'{EXMS}.validate_timeframes')
     mocker.patch(f'{EXMS}.validate_stakecurrency')
     mocker.patch(f'{EXMS}.name', 'Binance')
-    ExchangeResolver.load_exchange('binance', default_conf)
+    default_conf['exchange']['name'] = 'binance'
+    ExchangeResolver.load_exchange(default_conf)
     has.update({'fetchTicker': False})
     with pytest.raises(OperationalException, match="Ticker pricing not available for .*"):
-        ExchangeResolver.load_exchange('binance', default_conf)
+        ExchangeResolver.load_exchange(default_conf)
 
     has.update({'fetchTicker': True})
 
     default_conf['exit_pricing']['use_order_book'] = True
-    ExchangeResolver.load_exchange('binance', default_conf)
+    ExchangeResolver.load_exchange(default_conf)
     has.update({'fetchL2OrderBook': False})
 
     with pytest.raises(OperationalException, match="Orderbook not available for .*"):
-        ExchangeResolver.load_exchange('binance', default_conf)
+        ExchangeResolver.load_exchange(default_conf)
 
     has.update({'fetchL2OrderBook': True})
 
     # Binance has no tickers on futures
     default_conf['trading_mode'] = TradingMode.FUTURES
     default_conf['margin_mode'] = MarginMode.ISOLATED
 
     with pytest.raises(OperationalException, match="Ticker pricing not available for .*"):
-        ExchangeResolver.load_exchange('binance', default_conf)
+        ExchangeResolver.load_exchange(default_conf)
 
 
 def test_validate_ordertypes(default_conf, mocker):
     api_mock = MagicMock()
 
     type(api_mock).has = PropertyMock(return_value={'createMarketOrder': True})
     mocker.patch(f'{EXMS}._init_ccxt', MagicMock(return_value=api_mock))
@@ -1087,20 +1090,21 @@
     default_conf['order_types'] = {
         'entry': 'limit',
         'exit': 'limit',
         'stoploss': 'limit',
         'stoploss_on_exchange': True,
         'stoploss_price_type': stopadv,
     }
+    default_conf['exchange']['name'] = exchange_name
     if expected:
-        ExchangeResolver.load_exchange(exchange_name, default_conf)
+        ExchangeResolver.load_exchange(default_conf)
     else:
         with pytest.raises(OperationalException,
                            match=r'On exchange stoploss price type is not supported for .*'):
-            ExchangeResolver.load_exchange(exchange_name, default_conf)
+            ExchangeResolver.load_exchange(default_conf)
 
 
 def test_validate_order_types_not_in_config(default_conf, mocker):
     api_mock = MagicMock()
     mocker.patch(f'{EXMS}._init_ccxt', MagicMock(return_value=api_mock))
     mocker.patch(f'{EXMS}._load_markets', MagicMock(return_value={}))
     mocker.patch(f'{EXMS}.validate_pairs')
@@ -1769,14 +1773,79 @@
     res = exchange.fetch_positions()
     assert len(res) == 2
 
     ccxt_exceptionhandlers(mocker, default_conf, api_mock, exchange_name,
                            "fetch_positions", "fetch_positions")
 
 
+@pytest.mark.parametrize("exchange_name", EXCHANGES)
+def test_fetch_orders(default_conf, mocker, exchange_name, limit_order):
+
+    api_mock = MagicMock()
+    api_mock.fetch_orders = MagicMock(return_value=[
+        limit_order['buy'],
+        limit_order['sell'],
+    ])
+    api_mock.fetch_open_orders = MagicMock(return_value=[limit_order['buy']])
+    api_mock.fetch_closed_orders = MagicMock(return_value=[limit_order['buy']])
+
+    mocker.patch(f'{EXMS}.exchange_has', return_value=True)
+    start_time = datetime.now(timezone.utc) - timedelta(days=5)
+
+    exchange = get_patched_exchange(mocker, default_conf, api_mock, id=exchange_name)
+    # Not available in dry-run
+    assert exchange.fetch_orders('mocked', start_time) == []
+    assert api_mock.fetch_orders.call_count == 0
+    default_conf['dry_run'] = False
+
+    exchange = get_patched_exchange(mocker, default_conf, api_mock, id=exchange_name)
+    res = exchange.fetch_orders('mocked', start_time)
+    assert api_mock.fetch_orders.call_count == 1
+    assert api_mock.fetch_open_orders.call_count == 0
+    assert api_mock.fetch_closed_orders.call_count == 0
+    assert len(res) == 2
+
+    res = exchange.fetch_orders('mocked', start_time)
+
+    api_mock.fetch_orders.reset_mock()
+
+    def has_resp(_, endpoint):
+        if endpoint == 'fetchOrders':
+            return False
+        if endpoint == 'fetchClosedOrders':
+            return True
+        if endpoint == 'fetchOpenOrders':
+            return True
+
+    mocker.patch(f'{EXMS}.exchange_has', has_resp)
+
+    # happy path without fetchOrders
+    res = exchange.fetch_orders('mocked', start_time)
+    assert api_mock.fetch_orders.call_count == 0
+    assert api_mock.fetch_open_orders.call_count == 1
+    assert api_mock.fetch_closed_orders.call_count == 1
+
+    mocker.patch(f'{EXMS}.exchange_has', return_value=True)
+
+    ccxt_exceptionhandlers(mocker, default_conf, api_mock, exchange_name,
+                           "fetch_orders", "fetch_orders", retries=1,
+                           pair='mocked', since=start_time)
+
+    # Unhappy path - first fetch-orders call fails.
+    api_mock.fetch_orders = MagicMock(side_effect=ccxt.NotSupported())
+    api_mock.fetch_open_orders.reset_mock()
+    api_mock.fetch_closed_orders.reset_mock()
+
+    res = exchange.fetch_orders('mocked', start_time)
+
+    assert api_mock.fetch_orders.call_count == 1
+    assert api_mock.fetch_open_orders.call_count == 1
+    assert api_mock.fetch_closed_orders.call_count == 1
+
+
 def test_fetch_trading_fees(default_conf, mocker):
     api_mock = MagicMock()
     tick = {
         '1INCH/USDT:USDT': {
             'info': {'user_id': '',
                      'taker_fee': '0.0018',
                      'maker_fee': '0.0018',
@@ -2003,15 +2072,15 @@
 
 @pytest.mark.parametrize("exchange_name", EXCHANGES)
 @pytest.mark.parametrize('candle_type', ['mark', ''])
 def test_get_historic_ohlcv(default_conf, mocker, caplog, exchange_name, candle_type):
     exchange = get_patched_exchange(mocker, default_conf, id=exchange_name)
     ohlcv = [
         [
-            arrow.utcnow().int_timestamp * 1000,  # unix timestamp ms
+            dt_ts(),  # unix timestamp ms
             1,  # open
             2,  # high
             3,  # low
             4,  # close
             5,  # volume (in quote currency)
         ]
     ]
@@ -2023,15 +2092,15 @@
     exchange._async_get_candle_history = Mock(wraps=mock_candle_hist)
     # one_call calculation * 1.8 should do 2 calls
 
     since = 5 * 60 * exchange.ohlcv_candle_limit('5m', CandleType.SPOT) * 1.8
     ret = exchange.get_historic_ohlcv(
         pair,
         "5m",
-        int((arrow.utcnow().int_timestamp - since) * 1000),
+        dt_ts(dt_now() - timedelta(seconds=since)),
         candle_type=candle_type
     )
 
     assert exchange._async_get_candle_history.call_count == 2
     # Returns twice the above OHLCV data
     assert len(ret) == 2
     assert log_has_re(r'Downloaded data for .* with length .*\.', caplog)
@@ -2041,15 +2110,15 @@
     async def mock_get_candle_hist_error(pair, *args, **kwargs):
         raise TimeoutError()
 
     exchange._async_get_candle_history = MagicMock(side_effect=mock_get_candle_hist_error)
     ret = exchange.get_historic_ohlcv(
         pair,
         "5m",
-        int((arrow.utcnow().int_timestamp - since) * 1000),
+        dt_ts(dt_now() - timedelta(seconds=since)),
         candle_type=candle_type
     )
     assert log_has_re(r"Async code raised an exception: .*", caplog)
 
 
 @pytest.mark.asyncio
 @pytest.mark.parametrize("exchange_name", EXCHANGES)
@@ -2093,23 +2162,23 @@
     assert exchange._api_async.fetch_ohlcv.call_count == exp
 
 
 @pytest.mark.parametrize('candle_type', [CandleType.FUTURES, CandleType.MARK, CandleType.SPOT])
 def test_refresh_latest_ohlcv(mocker, default_conf, caplog, candle_type) -> None:
     ohlcv = [
         [
-            (arrow.utcnow().shift(minutes=-5).int_timestamp) * 1000,  # unix timestamp ms
+            dt_ts(dt_now() - timedelta(minutes=5)),  # unix timestamp ms
             1,  # open
             2,  # high
             3,  # low
             4,  # close
             5,  # volume (in quote currency)
         ],
         [
-            arrow.utcnow().int_timestamp * 1000,  # unix timestamp ms
+            dt_ts(),  # unix timestamp ms
             3,  # open
             1,  # high
             4,  # low
             6,  # close
             5,  # volume (in quote currency)
         ]
     ]
@@ -2291,15 +2360,15 @@
     assert res[pair2].at[0, 'open']
 
 
 @pytest.mark.parametrize("exchange_name", EXCHANGES)
 async def test__async_get_candle_history(default_conf, mocker, caplog, exchange_name):
     ohlcv = [
         [
-            arrow.utcnow().int_timestamp * 1000,  # unix timestamp ms
+            dt_ts(),  # unix timestamp ms
             1,  # open
             2,  # high
             3,  # low
             4,  # close
             5,  # volume (in quote currency)
         ]
     ]
@@ -2328,24 +2397,24 @@
 
     api_mock = MagicMock()
     with pytest.raises(OperationalException,
                        match=r'Could not fetch historical candle \(OHLCV\) data.*'):
         api_mock.fetch_ohlcv = MagicMock(side_effect=ccxt.BaseError("Unknown error"))
         exchange = get_patched_exchange(mocker, default_conf, api_mock, id=exchange_name)
         await exchange._async_get_candle_history(pair, "5m", CandleType.SPOT,
-                                                 (arrow.utcnow().int_timestamp - 2000) * 1000)
+                                                 dt_ts(dt_now() - timedelta(seconds=2000)))
 
     exchange.close()
 
     with pytest.raises(OperationalException, match=r'Exchange.* does not support fetching '
                                                    r'historical candle \(OHLCV\) data\..*'):
         api_mock.fetch_ohlcv = MagicMock(side_effect=ccxt.NotSupported("Not supported"))
         exchange = get_patched_exchange(mocker, default_conf, api_mock, id=exchange_name)
         await exchange._async_get_candle_history(pair, "5m", CandleType.SPOT,
-                                                 (arrow.utcnow().int_timestamp - 2000) * 1000)
+                                                 dt_ts(dt_now() - timedelta(seconds=2000)))
     exchange.close()
 
 
 async def test__async_kucoin_get_candle_history(default_conf, mocker, caplog):
     from freqtrade.exchange.common import _reset_logging_mixin
     _reset_logging_mixin()
     caplog.set_level(logging.INFO)
@@ -2360,15 +2429,15 @@
     msg = "Kucoin 429 error, avoid triggering DDosProtection backoff delay"
     assert not num_log_has_re(msg, caplog)
 
     for _ in range(3):
         with pytest.raises(DDosProtection, match=r'429 Too Many Requests'):
             await exchange._async_get_candle_history(
                 "ETH/BTC", "5m", CandleType.SPOT,
-                since_ms=(arrow.utcnow().int_timestamp - 2000) * 1000, count=3)
+                since_ms=dt_ts(dt_now() - timedelta(seconds=2000)), count=3)
     assert num_log_has_re(msg, caplog) == 3
 
     caplog.clear()
     # Test regular non-kucoin message
     api_mock.fetch_ohlcv = MagicMock(side_effect=ccxt.DDoSProtection(
         "kucoin GET https://openapi-v2.kucoin.com/api/v1/market/candles?"
         "symbol=ETH-BTC&type=5min&startAt=1640268735&endAt=1640418735"
@@ -2377,15 +2446,15 @@
     msg = r'_async_get_candle_history\(\) returned exception: .*'
     msg2 = r'Applying DDosProtection backoff delay: .*'
     with patch('freqtrade.exchange.common.asyncio.sleep', get_mock_coro(None)):
         for _ in range(3):
             with pytest.raises(DDosProtection, match=r'429 Too Many Requests'):
                 await exchange._async_get_candle_history(
                     "ETH/BTC", "5m", CandleType.SPOT,
-                    (arrow.utcnow().int_timestamp - 2000) * 1000, count=3)
+                    dt_ts(dt_now() - timedelta(seconds=2000)), count=3)
         # Expect the "returned exception" message 12 times (4 retries * 3 (loop))
         assert num_log_has_re(msg, caplog) == 12
         assert num_log_has_re(msg2, caplog) == 9
     exchange.close()
 
 
 async def test__async_get_candle_history_empty(default_conf, mocker, caplog):
@@ -2835,22 +2904,22 @@
                                "_async_fetch_trades", "fetch_trades",
                                pair='ABCD/BTC', since=None)
 
     api_mock = MagicMock()
     with pytest.raises(OperationalException, match=r'Could not fetch trade data*'):
         api_mock.fetch_trades = MagicMock(side_effect=ccxt.BaseError("Unknown error"))
         exchange = get_patched_exchange(mocker, default_conf, api_mock, id=exchange_name)
-        await exchange._async_fetch_trades(pair, since=(arrow.utcnow().int_timestamp - 2000) * 1000)
+        await exchange._async_fetch_trades(pair, since=dt_ts(dt_now() - timedelta(seconds=2000)))
     exchange.close()
 
     with pytest.raises(OperationalException, match=r'Exchange.* does not support fetching '
                                                    r'historical trade data\..*'):
         api_mock.fetch_trades = MagicMock(side_effect=ccxt.NotSupported("Not supported"))
         exchange = get_patched_exchange(mocker, default_conf, api_mock, id=exchange_name)
-        await exchange._async_fetch_trades(pair, since=(arrow.utcnow().int_timestamp - 2000) * 1000)
+        await exchange._async_fetch_trades(pair, since=dt_ts(dt_now() - timedelta(seconds=2000)))
     exchange.close()
 
 
 @pytest.mark.parametrize("exchange_name", EXCHANGES)
 async def test__async_fetch_trades_contract_size(default_conf, mocker, caplog, exchange_name,
                                                  fetch_trades_result):
     caplog.set_level(logging.DEBUG)
@@ -4928,15 +4997,15 @@
     default_conf['trading_mode'] = 'futures'
     default_conf['margin_mode'] = 'isolated'
     mocker.patch(f'{EXMS}.exchange_has', return_value=True)
     exchange = get_patched_exchange(mocker, default_conf, api_mock)
 
     exchange._leverage_tiers = leverage_tiers
     with pytest.raises(
-        OperationalException,
+        DependencyException,
         match='nominal value can not be lower than 0',
     ):
         exchange.get_maintenance_ratio_and_amt('1000SHIB/USDT:USDT', -1)
 
     exchange._leverage_tiers = {}
 
     with pytest.raises(
```

### Comparing `freqtrade-2023.4/tests/exchange/test_exchange_utils.py` & `freqtrade-2023.5/tests/exchange/test_exchange_utils.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/exchange/test_gate.py` & `freqtrade-2023.5/tests/exchange/test_gate.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/exchange/test_huobi.py` & `freqtrade-2023.5/tests/exchange/test_huobi.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/exchange/test_kraken.py` & `freqtrade-2023.5/tests/exchange/test_kraken.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/exchange/test_kucoin.py` & `freqtrade-2023.5/tests/exchange/test_kucoin.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/exchange/test_okx.py` & `freqtrade-2023.5/tests/exchange/test_okx.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/optimize/__init__.py` & `freqtrade-2023.5/tests/optimize/__init__.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,17 +1,18 @@
+from datetime import timedelta
 from typing import Dict, List, NamedTuple, Optional
 
-import arrow
 from pandas import DataFrame
 
 from freqtrade.enums import ExitType
 from freqtrade.exchange import timeframe_to_minutes
+from freqtrade.util.datetime_helpers import dt_utc
 
 
-tests_start_time = arrow.get(2018, 10, 3)
+tests_start_time = dt_utc(2018, 10, 3)
 tests_timeframe = '1h'
 
 
 class BTrade(NamedTuple):
     """
     Minimalistic Trade result used for functional backtesting
     """
@@ -42,15 +43,15 @@
     leverage: float = 1.0
     timeout: Optional[int] = None
     adjust_entry_price: Optional[float] = None
 
 
 def _get_frame_time_from_offset(offset):
     minutes = offset * timeframe_to_minutes(tests_timeframe)
-    return tests_start_time.shift(minutes=minutes).datetime
+    return tests_start_time + timedelta(minutes=minutes)
 
 
 def _build_backtest_dataframe(data):
     columns = ['date', 'open', 'high', 'low', 'close', 'volume', 'enter_long', 'exit_long',
                'enter_short', 'exit_short']
     if len(data[0]) == 8:
         # No short columns
```

### Comparing `freqtrade-2023.4/tests/optimize/conftest.py` & `freqtrade-2023.5/tests/optimize/conftest.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/optimize/test_backtest_detail.py` & `freqtrade-2023.5/tests/optimize/test_backtest_detail.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/optimize/test_backtesting.py` & `freqtrade-2023.5/tests/optimize/test_backtesting.py`

 * *Files 1% similar despite different names*

```diff
@@ -5,15 +5,14 @@
 from datetime import datetime, timedelta, timezone
 from pathlib import Path
 from unittest.mock import MagicMock, PropertyMock
 
 import numpy as np
 import pandas as pd
 import pytest
-from arrow import Arrow
 
 from freqtrade import constants
 from freqtrade.commands.optimize_commands import setup_optimize_configuration, start_backtesting
 from freqtrade.configuration import TimeRange
 from freqtrade.data import history
 from freqtrade.data.btanalysis import BT_DATA_COLUMNS, evaluate_result_multi
 from freqtrade.data.converter import clean_ohlcv_dataframe
@@ -22,14 +21,15 @@
 from freqtrade.enums import CandleType, ExitType, RunMode
 from freqtrade.exceptions import DependencyException, OperationalException
 from freqtrade.exchange.exchange import timeframe_to_next_date
 from freqtrade.optimize.backtest_caching import get_strategy_run_id
 from freqtrade.optimize.backtesting import Backtesting
 from freqtrade.persistence import LocalTrade, Trade
 from freqtrade.resolvers import StrategyResolver
+from freqtrade.util.datetime_helpers import dt_utc
 from tests.conftest import (CURRENT_TEST_STRATEGY, EXMS, get_args, log_has, log_has_re,
                             patch_exchange, patched_configuration_load_config_file)
 
 
 ORDER_TYPES = [
     {
         'entry': 'limit',
@@ -342,23 +342,23 @@
     # abort flag resets
     assert backtesting.abort is False
     assert backtesting.progress.progress == 0
 
 
 def test_backtesting_start(default_conf, mocker, caplog) -> None:
     def get_timerange(input1):
-        return Arrow(2017, 11, 14, 21, 17), Arrow(2017, 11, 14, 22, 59)
+        return dt_utc(2017, 11, 14, 21, 17), dt_utc(2017, 11, 14, 22, 59)
 
     mocker.patch('freqtrade.data.history.get_timerange', get_timerange)
     patch_exchange(mocker)
     mocker.patch('freqtrade.optimize.backtesting.Backtesting.backtest')
     mocker.patch('freqtrade.optimize.backtesting.generate_backtest_stats')
     mocker.patch('freqtrade.optimize.backtesting.show_backtest_results')
     sbs = mocker.patch('freqtrade.optimize.backtesting.store_backtest_stats')
-    sbc = mocker.patch('freqtrade.optimize.backtesting.store_backtest_signal_candles')
+    sbc = mocker.patch('freqtrade.optimize.backtesting.store_backtest_analysis_results')
     mocker.patch('freqtrade.plugins.pairlistmanager.PairListManager.whitelist',
                  PropertyMock(return_value=['UNITTEST/BTC']))
 
     default_conf['timeframe'] = '1m'
     default_conf['export'] = 'signals'
     default_conf['exportfilename'] = 'export.txt'
     default_conf['timerange'] = '-1510694220'
@@ -381,15 +381,15 @@
     assert backtesting.strategy.bot_loop_start.call_count == 0
     assert sbs.call_count == 1
     assert sbc.call_count == 1
 
 
 def test_backtesting_start_no_data(default_conf, mocker, caplog, testdatadir) -> None:
     def get_timerange(input1):
-        return Arrow(2017, 11, 14, 21, 17), Arrow(2017, 11, 14, 22, 59)
+        return dt_utc(2017, 11, 14, 21, 17), dt_utc(2017, 11, 14, 22, 59)
 
     mocker.patch('freqtrade.data.history.history_utils.load_pair_history',
                  MagicMock(return_value=pd.DataFrame()))
     mocker.patch('freqtrade.data.history.get_timerange', get_timerange)
     patch_exchange(mocker)
     mocker.patch('freqtrade.optimize.backtesting.Backtesting.backtest')
     mocker.patch('freqtrade.plugins.pairlistmanager.PairListManager.whitelist',
@@ -706,19 +706,19 @@
     assert len(results) == 2
 
     expected = pd.DataFrame(
         {'pair': [pair, pair],
          'stake_amount': [0.001, 0.001],
          'max_stake_amount': [0.001, 0.001],
          'amount': [0.00957442, 0.0097064],
-         'open_date': pd.to_datetime([Arrow(2018, 1, 29, 18, 40, 0).datetime,
-                                      Arrow(2018, 1, 30, 3, 30, 0).datetime], utc=True
+         'open_date': pd.to_datetime([dt_utc(2018, 1, 29, 18, 40, 0),
+                                      dt_utc(2018, 1, 30, 3, 30, 0)], utc=True
                                      ),
-         'close_date': pd.to_datetime([Arrow(2018, 1, 29, 22, 35, 0).datetime,
-                                       Arrow(2018, 1, 30, 4, 10, 0).datetime], utc=True),
+         'close_date': pd.to_datetime([dt_utc(2018, 1, 29, 22, 35, 0),
+                                       dt_utc(2018, 1, 30, 4, 10, 0)], utc=True),
          'open_rate': [0.104445, 0.10302485],
          'close_rate': [0.104969, 0.103541],
          'fee_open': [0.0025, 0.0025],
          'fee_close': [0.0025, 0.0025],
          'trade_duration': [235, 40],
          'profit_ratio': [0.0, 0.0],
          'profit_abs': [0.0, 0.0],
```

### Comparing `freqtrade-2023.4/tests/optimize/test_backtesting_adjust_position.py` & `freqtrade-2023.5/tests/optimize/test_backtesting_adjust_position.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,21 +1,21 @@
 # pragma pylint: disable=missing-docstring, W0212, line-too-long, C0103, unused-argument
 
 from copy import deepcopy
 from unittest.mock import MagicMock
 
 import pandas as pd
 import pytest
-from arrow import Arrow
 
 from freqtrade.configuration import TimeRange
 from freqtrade.data import history
 from freqtrade.data.history import get_timerange
 from freqtrade.enums import ExitType, TradingMode
 from freqtrade.optimize.backtesting import Backtesting
+from freqtrade.util.datetime_helpers import dt_utc
 from tests.conftest import EXMS, patch_exchange
 
 
 def test_backtest_position_adjustment(default_conf, fee, mocker, testdatadir) -> None:
     default_conf['use_exit_signal'] = False
     default_conf['max_open_trades'] = 10
     mocker.patch(f'{EXMS}.get_fee', fee)
@@ -48,19 +48,19 @@
     assert len(results) == 2
 
     expected = pd.DataFrame(
         {'pair': [pair, pair],
          'stake_amount': [500.0, 100.0],
          'max_stake_amount': [500.0, 100],
          'amount': [4806.87657523, 970.63960782],
-         'open_date': pd.to_datetime([Arrow(2018, 1, 29, 18, 40, 0).datetime,
-                                      Arrow(2018, 1, 30, 3, 30, 0).datetime], utc=True
+         'open_date': pd.to_datetime([dt_utc(2018, 1, 29, 18, 40, 0),
+                                      dt_utc(2018, 1, 30, 3, 30, 0)], utc=True
                                      ),
-         'close_date': pd.to_datetime([Arrow(2018, 1, 29, 22, 00, 0).datetime,
-                                       Arrow(2018, 1, 30, 4, 10, 0).datetime], utc=True),
+         'close_date': pd.to_datetime([dt_utc(2018, 1, 29, 22, 00, 0),
+                                       dt_utc(2018, 1, 30, 4, 10, 0)], utc=True),
          'open_rate': [0.10401764894444211, 0.10302485],
          'close_rate': [0.10453904066847439, 0.103541],
          'fee_open': [0.0025, 0.0025],
          'fee_close': [0.0025, 0.0025],
          'trade_duration': [200, 40],
          'profit_ratio': [0.0, 0.0],
          'profit_abs': [0.0, 0.0],
```

### Comparing `freqtrade-2023.4/tests/optimize/test_edge_cli.py` & `freqtrade-2023.5/tests/optimize/test_edge_cli.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/optimize/test_hyperopt.py` & `freqtrade-2023.5/tests/optimize/test_hyperopt.py`

 * *Files 3% similar despite different names*

```diff
@@ -2,28 +2,28 @@
 from datetime import datetime, timedelta
 from functools import wraps
 from pathlib import Path
 from unittest.mock import ANY, MagicMock, PropertyMock
 
 import pandas as pd
 import pytest
-from arrow import Arrow
 from filelock import Timeout
 from skopt.space import Integer
 
 from freqtrade.commands.optimize_commands import setup_optimize_configuration, start_hyperopt
 from freqtrade.data.history import load_data
 from freqtrade.enums import ExitType, RunMode
 from freqtrade.exceptions import OperationalException
 from freqtrade.optimize.hyperopt import Hyperopt
 from freqtrade.optimize.hyperopt_auto import HyperOptAuto
 from freqtrade.optimize.hyperopt_tools import HyperoptTools
 from freqtrade.optimize.optimize_reports import generate_strategy_stats
 from freqtrade.optimize.space import SKDecimal
 from freqtrade.strategy import IntParameter
+from freqtrade.util import dt_utc
 from tests.conftest import (CURRENT_TEST_STRATEGY, EXMS, get_args, get_markets, log_has, log_has_re,
                             patch_exchange, patched_configuration_load_config_file)
 
 
 def generate_result_metrics():
     return {
         'trade_count': 1,
@@ -345,22 +345,22 @@
 def test_hyperopt_format_results(hyperopt):
 
     bt_result = {
         'results': pd.DataFrame({"pair": ["UNITTEST/BTC", "UNITTEST/BTC",
                                           "UNITTEST/BTC", "UNITTEST/BTC"],
                                  "profit_ratio": [0.003312, 0.010801, 0.013803, 0.002780],
                                  "profit_abs": [0.000003, 0.000011, 0.000014, 0.000003],
-                                 "open_date": [Arrow(2017, 11, 14, 19, 32, 00).datetime,
-                                               Arrow(2017, 11, 14, 21, 36, 00).datetime,
-                                               Arrow(2017, 11, 14, 22, 12, 00).datetime,
-                                               Arrow(2017, 11, 14, 22, 44, 00).datetime],
-                                 "close_date": [Arrow(2017, 11, 14, 21, 35, 00).datetime,
-                                                Arrow(2017, 11, 14, 22, 10, 00).datetime,
-                                                Arrow(2017, 11, 14, 22, 43, 00).datetime,
-                                                Arrow(2017, 11, 14, 22, 58, 00).datetime],
+                                 "open_date": [dt_utc(2017, 11, 14, 19, 32, 00),
+                                               dt_utc(2017, 11, 14, 21, 36, 00),
+                                               dt_utc(2017, 11, 14, 22, 12, 00),
+                                               dt_utc(2017, 11, 14, 22, 44, 00)],
+                                 "close_date": [dt_utc(2017, 11, 14, 21, 35, 00),
+                                                dt_utc(2017, 11, 14, 22, 10, 00),
+                                                dt_utc(2017, 11, 14, 22, 43, 00),
+                                                dt_utc(2017, 11, 14, 22, 58, 00)],
                                  "open_rate": [0.002543, 0.003003, 0.003089, 0.003214],
                                  "close_rate": [0.002546, 0.003014, 0.003103, 0.003217],
                                  "trade_duration": [123, 34, 31, 14],
                                  "is_open": [False, False, False, True],
                                  "is_short": [False, False, False, False],
                                  "stake_amount": [0.01, 0.01, 0.01, 0.01],
                                  "exit_reason": [ExitType.ROI, ExitType.STOP_LOSS,
@@ -375,16 +375,16 @@
         'canceled_trade_entries': 0,
         'canceled_entry_orders': 0,
         'replaced_entry_orders': 0,
         'backtest_start_time': 1619718665,
         'backtest_end_time': 1619718665,
     }
     results_metrics = generate_strategy_stats(['XRP/BTC'], '', bt_result,
-                                              Arrow(2017, 11, 14, 19, 32, 00),
-                                              Arrow(2017, 12, 14, 19, 32, 00), market_change=0)
+                                              dt_utc(2017, 11, 14, 19, 32, 00),
+                                              dt_utc(2017, 12, 14, 19, 32, 00), market_change=0)
 
     results_explanation = HyperoptTools.format_results_explanation_string(results_metrics, 'BTC')
     total_profit = results_metrics['profit_total_abs']
 
     results = {
         'loss': 0.0,
         'params_dict': None,
@@ -419,22 +419,22 @@
                           })
 
     backtest_result = {
         'results': pd.DataFrame({"pair": ["UNITTEST/BTC", "UNITTEST/BTC",
                                           "UNITTEST/BTC", "UNITTEST/BTC"],
                                  "profit_ratio": [0.003312, 0.010801, 0.013803, 0.002780],
                                  "profit_abs": [0.000003, 0.000011, 0.000014, 0.000003],
-                                 "open_date": [Arrow(2017, 11, 14, 19, 32, 00).datetime,
-                                               Arrow(2017, 11, 14, 21, 36, 00).datetime,
-                                               Arrow(2017, 11, 14, 22, 12, 00).datetime,
-                                               Arrow(2017, 11, 14, 22, 44, 00).datetime],
-                                 "close_date": [Arrow(2017, 11, 14, 21, 35, 00).datetime,
-                                                Arrow(2017, 11, 14, 22, 10, 00).datetime,
-                                                Arrow(2017, 11, 14, 22, 43, 00).datetime,
-                                                Arrow(2017, 11, 14, 22, 58, 00).datetime],
+                                 "open_date": [dt_utc(2017, 11, 14, 19, 32, 00),
+                                               dt_utc(2017, 11, 14, 21, 36, 00),
+                                               dt_utc(2017, 11, 14, 22, 12, 00),
+                                               dt_utc(2017, 11, 14, 22, 44, 00)],
+                                 "close_date": [dt_utc(2017, 11, 14, 21, 35, 00),
+                                                dt_utc(2017, 11, 14, 22, 10, 00),
+                                                dt_utc(2017, 11, 14, 22, 43, 00),
+                                                dt_utc(2017, 11, 14, 22, 58, 00)],
                                  "open_rate": [0.002543, 0.003003, 0.003089, 0.003214],
                                  "close_rate": [0.002546, 0.003014, 0.003103, 0.003217],
                                  "trade_duration": [123, 34, 31, 14],
                                  "is_open": [False, False, False, True],
                                  "is_short": [False, False, False, False],
                                  "stake_amount": [0.01, 0.01, 0.01, 0.01],
                                  "exit_reason": [ExitType.ROI, ExitType.STOP_LOSS,
@@ -449,15 +449,15 @@
         'canceled_entry_orders': 0,
         'replaced_entry_orders': 0,
         'final_balance': 1000,
     }
 
     mocker.patch('freqtrade.optimize.hyperopt.Backtesting.backtest', return_value=backtest_result)
     mocker.patch('freqtrade.optimize.hyperopt.get_timerange',
-                 return_value=(Arrow(2017, 12, 10), Arrow(2017, 12, 13)))
+                 return_value=(dt_utc(2017, 12, 10), dt_utc(2017, 12, 13)))
     patch_exchange(mocker)
     mocker.patch.object(Path, 'open')
     mocker.patch('freqtrade.configuration.config_validation.validate_config_schema')
     mocker.patch('freqtrade.optimize.hyperopt.load', return_value={'XRP/BTC': None})
 
     optimizer_param = {
         'buy_plusdi': 0.02,
@@ -509,16 +509,16 @@
         'params_dict': optimizer_param,
         'params_not_optimized': {'buy': {}, 'protection': {}, 'sell': {}},
         'results_metrics': ANY,
         'total_profit': 3.1e-08
     }
 
     hyperopt = Hyperopt(hyperopt_conf)
-    hyperopt.min_date = Arrow(2017, 12, 10)
-    hyperopt.max_date = Arrow(2017, 12, 13)
+    hyperopt.min_date = dt_utc(2017, 12, 10)
+    hyperopt.max_date = dt_utc(2017, 12, 13)
     hyperopt.init_spaces()
     generate_optimizer_value = hyperopt.generate_optimizer(list(optimizer_param.values()))
     assert generate_optimizer_value == response_expected
 
 
 def test_clean_hyperopt(mocker, hyperopt_conf, caplog):
     patch_exchange(mocker)
```

### Comparing `freqtrade-2023.4/tests/optimize/test_hyperopt_tools.py` & `freqtrade-2023.5/tests/optimize/test_hyperopt_tools.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/optimize/test_hyperoptloss.py` & `freqtrade-2023.5/tests/optimize/test_hyperoptloss.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/optimize/test_optimize_reports.py` & `freqtrade-2023.5/tests/optimize/test_optimize_reports.py`

 * *Files 8% similar despite different names*

```diff
@@ -2,33 +2,34 @@
 from datetime import timedelta
 from pathlib import Path
 from shutil import copyfile
 
 import joblib
 import pandas as pd
 import pytest
-from arrow import Arrow
 
 from freqtrade.configuration import TimeRange
 from freqtrade.constants import BACKTEST_BREAKDOWNS, DATETIME_PRINT_FORMAT, LAST_BT_RESULT_FN
 from freqtrade.data import history
 from freqtrade.data.btanalysis import (get_latest_backtest_filename, load_backtest_data,
                                        load_backtest_stats)
 from freqtrade.edge import PairInfo
 from freqtrade.enums import ExitType
 from freqtrade.optimize.optimize_reports import (_get_resample_from_period, generate_backtest_stats,
                                                  generate_daily_stats, generate_edge_table,
                                                  generate_exit_reason_stats, generate_pair_metrics,
                                                  generate_periodic_breakdown_stats,
                                                  generate_strategy_comparison,
                                                  generate_trading_stats, show_sorted_pairlist,
-                                                 store_backtest_signal_candles,
+                                                 store_backtest_analysis_results,
                                                  store_backtest_stats, text_table_bt_results,
                                                  text_table_exit_reason, text_table_strategy)
 from freqtrade.resolvers.strategy_resolver import StrategyResolver
+from freqtrade.util import dt_ts
+from freqtrade.util.datetime_helpers import dt_from_ts, dt_utc
 from tests.conftest import CURRENT_TEST_STRATEGY
 from tests.data.test_history import _clean_test_file
 
 
 def _backup_file(file: Path, copy_file: bool = False) -> None:
     """
     Backup existing file to avoid deleting the user file
@@ -76,22 +77,22 @@
     StrategyResolver.load_strategy(default_conf)
 
     results = {'DefStrat': {
         'results': pd.DataFrame({"pair": ["UNITTEST/BTC", "UNITTEST/BTC",
                                           "UNITTEST/BTC", "UNITTEST/BTC"],
                                  "profit_ratio": [0.003312, 0.010801, 0.013803, 0.002780],
                                  "profit_abs": [0.000003, 0.000011, 0.000014, 0.000003],
-                                 "open_date": [Arrow(2017, 11, 14, 19, 32, 00).datetime,
-                                               Arrow(2017, 11, 14, 21, 36, 00).datetime,
-                                               Arrow(2017, 11, 14, 22, 12, 00).datetime,
-                                               Arrow(2017, 11, 14, 22, 44, 00).datetime],
-                                 "close_date": [Arrow(2017, 11, 14, 21, 35, 00).datetime,
-                                                Arrow(2017, 11, 14, 22, 10, 00).datetime,
-                                                Arrow(2017, 11, 14, 22, 43, 00).datetime,
-                                                Arrow(2017, 11, 14, 22, 58, 00).datetime],
+                                 "open_date": [dt_utc(2017, 11, 14, 19, 32, 00),
+                                               dt_utc(2017, 11, 14, 21, 36, 00),
+                                               dt_utc(2017, 11, 14, 22, 12, 00),
+                                               dt_utc(2017, 11, 14, 22, 44, 00)],
+                                 "close_date": [dt_utc(2017, 11, 14, 21, 35, 00),
+                                                dt_utc(2017, 11, 14, 22, 10, 00),
+                                                dt_utc(2017, 11, 14, 22, 43, 00),
+                                                dt_utc(2017, 11, 14, 22, 58, 00)],
                                  "open_rate": [0.002543, 0.003003, 0.003089, 0.003214],
                                  "close_rate": [0.002546, 0.003014, 0.003103, 0.003217],
                                  "trade_duration": [123, 34, 31, 14],
                                  "is_open": [False, False, False, True],
                                  "is_short": [False, False, False, False],
                                  "stake_amount": [0.01, 0.01, 0.01, 0.01],
                                  "exit_reason": [ExitType.ROI, ExitType.STOP_LOSS,
@@ -102,22 +103,22 @@
         'final_balance': 1000.02,
         'rejected_signals': 20,
         'timedout_entry_orders': 0,
         'timedout_exit_orders': 0,
         'canceled_trade_entries': 0,
         'canceled_entry_orders': 0,
         'replaced_entry_orders': 0,
-        'backtest_start_time': Arrow.utcnow().int_timestamp,
-        'backtest_end_time': Arrow.utcnow().int_timestamp,
+        'backtest_start_time': dt_ts() // 1000,
+        'backtest_end_time': dt_ts() // 1000,
         'run_id': '123',
         }
         }
     timerange = TimeRange.parse_timerange('1510688220-1510700340')
-    min_date = Arrow.fromtimestamp(1510688220)
-    max_date = Arrow.fromtimestamp(1510700340)
+    min_date = dt_from_ts(1510688220)
+    max_date = dt_from_ts(1510700340)
     btdata = history.load_data(testdatadir, '1m', ['UNITTEST/BTC'], timerange=timerange,
                                fill_up_missing=True)
 
     stats = generate_backtest_stats(btdata, results, min_date, max_date)
     assert isinstance(stats, dict)
     assert 'strategy' in stats
     assert 'DefStrat' in stats['strategy']
@@ -131,22 +132,22 @@
 
     # Retry with losing trade
     results = {'DefStrat': {
         'results': pd.DataFrame(
             {"pair": ["UNITTEST/BTC", "UNITTEST/BTC", "UNITTEST/BTC", "UNITTEST/BTC"],
              "profit_ratio": [0.003312, 0.010801, -0.013803, 0.002780],
              "profit_abs": [0.000003, 0.000011, -0.000014, 0.000003],
-             "open_date": [Arrow(2017, 11, 14, 19, 32, 00).datetime,
-                           Arrow(2017, 11, 14, 21, 36, 00).datetime,
-                           Arrow(2017, 11, 14, 22, 12, 00).datetime,
-                           Arrow(2017, 11, 14, 22, 44, 00).datetime],
-             "close_date": [Arrow(2017, 11, 14, 21, 35, 00).datetime,
-                            Arrow(2017, 11, 14, 22, 10, 00).datetime,
-                            Arrow(2017, 11, 14, 22, 43, 00).datetime,
-                            Arrow(2017, 11, 14, 22, 58, 00).datetime],
+             "open_date": [dt_utc(2017, 11, 14, 19, 32, 00),
+                           dt_utc(2017, 11, 14, 21, 36, 00),
+                           dt_utc(2017, 11, 14, 22, 12, 00),
+                           dt_utc(2017, 11, 14, 22, 44, 00)],
+             "close_date": [dt_utc(2017, 11, 14, 21, 35, 00),
+                            dt_utc(2017, 11, 14, 22, 10, 00),
+                            dt_utc(2017, 11, 14, 22, 43, 00),
+                            dt_utc(2017, 11, 14, 22, 58, 00)],
              "open_rate": [0.002543, 0.003003, 0.003089, 0.003214],
              "close_rate": [0.002546, 0.003014, 0.0032903, 0.003217],
              "trade_duration": [123, 34, 31, 14],
              "is_open": [False, False, False, True],
              "is_short": [False, False, False, False],
              "stake_amount": [0.01, 0.01, 0.01, 0.01],
              "exit_reason": [ExitType.ROI, ExitType.ROI,
@@ -157,16 +158,16 @@
         'final_balance': 1000.02,
         'rejected_signals': 20,
         'timedout_entry_orders': 0,
         'timedout_exit_orders': 0,
         'canceled_trade_entries': 0,
         'canceled_entry_orders': 0,
         'replaced_entry_orders': 0,
-        'backtest_start_time': Arrow.utcnow().int_timestamp,
-        'backtest_end_time': Arrow.utcnow().int_timestamp,
+        'backtest_start_time': dt_ts() // 1000,
+        'backtest_end_time': dt_ts() // 1000,
         'run_id': '124',
         }
     }
 
     stats = generate_backtest_stats(btdata, results, min_date, max_date)
     assert isinstance(stats, dict)
     assert 'strategy' in stats
@@ -228,54 +229,55 @@
 def test_store_backtest_candles(testdatadir, mocker):
 
     dump_mock = mocker.patch('freqtrade.optimize.optimize_reports.file_dump_joblib')
 
     candle_dict = {'DefStrat': {'UNITTEST/BTC': pd.DataFrame()}}
 
     # mock directory exporting
-    store_backtest_signal_candles(testdatadir, candle_dict, '2022_01_01_15_05_13')
+    store_backtest_analysis_results(testdatadir, candle_dict, {}, '2022_01_01_15_05_13')
 
-    assert dump_mock.call_count == 1
+    assert dump_mock.call_count == 2
     assert isinstance(dump_mock.call_args_list[0][0][0], Path)
     assert str(dump_mock.call_args_list[0][0][0]).endswith('_signals.pkl')
 
     dump_mock.reset_mock()
     # mock file exporting
     filename = Path(testdatadir / 'testresult')
-    store_backtest_signal_candles(filename, candle_dict, '2022_01_01_15_05_13')
-    assert dump_mock.call_count == 1
+    store_backtest_analysis_results(filename, candle_dict, {}, '2022_01_01_15_05_13')
+    assert dump_mock.call_count == 2
     assert isinstance(dump_mock.call_args_list[0][0][0], Path)
     # result will be testdatadir / testresult-<timestamp>_signals.pkl
     assert str(dump_mock.call_args_list[0][0][0]).endswith('_signals.pkl')
     dump_mock.reset_mock()
 
 
 def test_write_read_backtest_candles(tmpdir):
 
     candle_dict = {'DefStrat': {'UNITTEST/BTC': pd.DataFrame()}}
 
     # test directory exporting
-    stored_file = store_backtest_signal_candles(Path(tmpdir), candle_dict, '2022_01_01_15_05_13')
-    scp = stored_file.open("rb")
-    pickled_signal_candles = joblib.load(scp)
-    scp.close()
+    sample_date = '2022_01_01_15_05_13'
+    store_backtest_analysis_results(Path(tmpdir), candle_dict, {}, sample_date)
+    stored_file = Path(tmpdir / f'backtest-result-{sample_date}_signals.pkl')
+    with stored_file.open("rb") as scp:
+        pickled_signal_candles = joblib.load(scp)
 
     assert pickled_signal_candles.keys() == candle_dict.keys()
     assert pickled_signal_candles['DefStrat'].keys() == pickled_signal_candles['DefStrat'].keys()
     assert pickled_signal_candles['DefStrat']['UNITTEST/BTC'] \
         .equals(pickled_signal_candles['DefStrat']['UNITTEST/BTC'])
 
     _clean_test_file(stored_file)
 
     # test file exporting
     filename = Path(tmpdir / 'testresult')
-    stored_file = store_backtest_signal_candles(filename, candle_dict, '2022_01_01_15_05_13')
-    scp = stored_file.open("rb")
-    pickled_signal_candles = joblib.load(scp)
-    scp.close()
+    store_backtest_analysis_results(filename, candle_dict, {}, sample_date)
+    stored_file = Path(tmpdir / f'testresult-{sample_date}_signals.pkl')
+    with stored_file.open("rb") as scp:
+        pickled_signal_candles = joblib.load(scp)
 
     assert pickled_signal_candles.keys() == candle_dict.keys()
     assert pickled_signal_candles['DefStrat'].keys() == pickled_signal_candles['DefStrat'].keys()
     assert pickled_signal_candles['DefStrat']['UNITTEST/BTC'] \
         .equals(pickled_signal_candles['DefStrat']['UNITTEST/BTC'])
 
     _clean_test_file(stored_file)
```

### Comparing `freqtrade-2023.4/tests/persistence/test_key_value_store.py` & `freqtrade-2023.5/tests/persistence/test_key_value_store.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/persistence/test_migrations.py` & `freqtrade-2023.5/tests/persistence/test_migrations.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,19 +1,22 @@
 # pragma pylint: disable=missing-docstring, C0103
 import logging
+from importlib import import_module
 from pathlib import Path
 from unittest.mock import MagicMock
 
 import pytest
 from sqlalchemy import create_engine, select, text
+from sqlalchemy.schema import CreateTable
 
 from freqtrade.constants import DEFAULT_DB_PROD_URL
 from freqtrade.enums import TradingMode
 from freqtrade.exceptions import OperationalException
 from freqtrade.persistence import Trade, init_db
+from freqtrade.persistence.base import ModelBase
 from freqtrade.persistence.migrations import get_last_sequence_ids, set_sequence_ids
 from freqtrade.persistence.models import PairLock
 from tests.conftest import log_has
 
 
 spot, margin, futures = TradingMode.SPOT, TradingMode.MARGIN, TradingMode.FUTURES
 
@@ -407,7 +410,18 @@
 
     assert len(PairLock.get_all_locks().all()) == 2
     assert len(PairLock.session.scalars(select(PairLock).filter(PairLock.pair == '*')).all()) == 1
     pairlocks = PairLock.session.scalars(select(PairLock).filter(PairLock.pair == 'ETH/BTC')).all()
     assert len(pairlocks) == 1
     pairlocks[0].pair == 'ETH/BTC'
     pairlocks[0].side == '*'
+
+
+@pytest.mark.parametrize('dialect', [
+    'sqlite', 'postgresql', 'mysql', 'oracle', 'mssql',
+    ])
+def test_create_table_compiles(dialect):
+
+    dialect_mod = import_module(f"sqlalchemy.dialects.{dialect}")
+    for table in ModelBase.metadata.tables.values():
+        create_sql = str(CreateTable(table).compile(dialect=dialect_mod.dialect()))
+        assert 'CREATE TABLE' in create_sql
```

### Comparing `freqtrade-2023.4/tests/persistence/test_persistence.py` & `freqtrade-2023.5/tests/persistence/test_persistence.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,19 +1,19 @@
 # pragma pylint: disable=missing-docstring, C0103
 from datetime import datetime, timedelta, timezone
 from types import FunctionType
 
-import arrow
 import pytest
 from sqlalchemy import select
 
 from freqtrade.constants import CUSTOM_TAG_MAX_LENGTH, DATETIME_PRINT_FORMAT
 from freqtrade.enums import TradingMode
 from freqtrade.exceptions import DependencyException
 from freqtrade.persistence import LocalTrade, Order, Trade, init_db
+from freqtrade.util import dt_now
 from tests.conftest import create_mock_trades, create_mock_trades_with_leverage, log_has, log_has_re
 
 
 spot, margin, futures = TradingMode.SPOT, TradingMode.MARGIN, TradingMode.FUTURES
 
 
 @pytest.mark.parametrize('is_short', [False, True])
@@ -23,15 +23,15 @@
     trade = Trade(
         id=2,
         pair='ADA/USDT',
         stake_amount=0.001,
         open_rate=0.01,
         amount=5,
         is_open=True,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         is_short=is_short,
         leverage=2.0,
         trading_mode=margin
     )
@@ -45,15 +45,15 @@
     trade = Trade(
         id=2,
         pair='ADA/USDT',
         stake_amount=60.0,
         open_rate=2.0,
         amount=30.0,
         is_open=True,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         is_short=False,
         leverage=2.0,
         trading_mode=margin
     )
@@ -235,15 +235,15 @@
     """
 
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=20.0,
         amount=30.0,
         open_rate=2.0,
-        open_date=datetime.utcnow() - timedelta(minutes=minutes),
+        open_date=datetime.now(timezone.utc) - timedelta(minutes=minutes),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange=exchange,
         leverage=lev,
         interest_rate=rate,
         is_short=is_short,
         trading_mode=trading_mode
@@ -325,15 +325,15 @@
     trade = Trade(
         id=2,
         pair='ADA/USDT',
         stake_amount=60.0,
         open_rate=2.0,
         amount=30.0,
         is_open=True,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         is_short=is_short,
         leverage=lev,
         trading_mode=trading_mode
     )
@@ -424,15 +424,15 @@
     trade = Trade(
         id=2,
         pair='ADA/USDT',
         stake_amount=60.0,
         open_rate=open_rate,
         amount=30.0,
         is_open=True,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         is_short=is_short,
         interest_rate=0.0005,
         leverage=lev,
         trading_mode=trading_mode
@@ -481,15 +481,15 @@
         pair='ADA/USDT',
         stake_amount=60.0,
         open_rate=2.0,
         amount=30.0,
         is_open=True,
         fee_open=fee.return_value,
         fee_close=fee.return_value,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         exchange='binance',
         trading_mode=margin,
         leverage=1.0,
     )
 
     trade.open_order_id = 'mocked_market_buy'
     oobj = Order.parse_from_ccxt_object(market_buy_order_usdt, 'ADA/USDT', 'buy')
@@ -631,15 +631,15 @@
     assert trade.close_date is None
     assert trade.is_open is True
     trade.close(2.2)
     assert trade.is_open is False
     assert pytest.approx(trade.close_profit) == 0.094513715
     assert trade.close_date is not None
 
-    new_date = arrow.Arrow(2020, 2, 2, 15, 6, 1).datetime,
+    new_date = datetime(2020, 2, 2, 15, 6, 1),
     assert trade.close_date != new_date
     # Close should NOT update close_date if the trade has been closed already
     assert trade.is_open is False
     trade.close_date = new_date
     trade.close(2.2)
     assert trade.close_date == new_date
 
@@ -1322,15 +1322,15 @@
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=0.001,
         amount=123.0,
         amount_requested=123.0,
         fee_open=fee.return_value,
         fee_close=fee.return_value,
-        open_date=arrow.utcnow().shift(hours=-2).datetime,
+        open_date=dt_now() - timedelta(hours=2),
         open_rate=0.123,
         exchange='binance',
         enter_tag=None,
         open_order_id='dry_run_buy_12345',
         precision_mode=1,
         amount_precision=8.0,
         price_precision=7.0,
@@ -1407,16 +1407,16 @@
     trade = Trade(
         pair='XRP/BTC',
         stake_amount=0.001,
         amount=100.0,
         amount_requested=101.0,
         fee_open=fee.return_value,
         fee_close=fee.return_value,
-        open_date=arrow.utcnow().shift(hours=-2).datetime,
-        close_date=arrow.utcnow().shift(hours=-1).datetime,
+        open_date=dt_now() - timedelta(hours=2),
+        close_date=dt_now() - timedelta(hours=1),
         open_rate=0.123,
         close_rate=0.125,
         enter_tag='buys_signal_001',
         exchange='binance',
         precision_mode=2,
         amount_precision=7.0,
         price_precision=8.0,
@@ -1492,15 +1492,15 @@
 
 def test_stoploss_reinitialization(default_conf, fee):
     init_db(default_conf['db_url'])
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=30.0,
         fee_open=fee.return_value,
-        open_date=arrow.utcnow().shift(hours=-2).datetime,
+        open_date=dt_now() - timedelta(hours=2),
         amount=30.0,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=1,
         max_rate=1,
     )
 
@@ -1553,15 +1553,15 @@
 
 def test_stoploss_reinitialization_leverage(default_conf, fee):
     init_db(default_conf['db_url'])
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=30.0,
         fee_open=fee.return_value,
-        open_date=arrow.utcnow().shift(hours=-2).datetime,
+        open_date=dt_now() - timedelta(hours=2),
         amount=30.0,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=1,
         max_rate=1,
         leverage=5.0,
     )
@@ -1615,15 +1615,15 @@
 
 def test_stoploss_reinitialization_short(default_conf, fee):
     init_db(default_conf['db_url'])
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=0.001,
         fee_open=fee.return_value,
-        open_date=arrow.utcnow().shift(hours=-2).datetime,
+        open_date=dt_now() - timedelta(hours=2),
         amount=10,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=1,
         max_rate=1,
         is_short=True,
         leverage=5.0,
@@ -1674,15 +1674,15 @@
 
 
 def test_update_fee(fee):
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=30.0,
         fee_open=fee.return_value,
-        open_date=arrow.utcnow().shift(hours=-2).datetime,
+        open_date=dt_now() - timedelta(hours=2),
         amount=30.0,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=1,
         max_rate=1,
     )
     fee_cost = 0.15
@@ -1713,15 +1713,15 @@
 
 
 def test_fee_updated(fee):
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=30.0,
         fee_open=fee.return_value,
-        open_date=arrow.utcnow().shift(hours=-2).datetime,
+        open_date=dt_now() - timedelta(hours=2),
         amount=30.0,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=1,
         max_rate=1,
     )
 
@@ -2059,15 +2059,15 @@
 @pytest.mark.usefixtures("init_persistence")
 def test_trade_truncates_string_fields():
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=20.0,
         amount=30.0,
         open_rate=2.0,
-        open_date=datetime.utcnow() - timedelta(minutes=20),
+        open_date=datetime.now(timezone.utc) - timedelta(minutes=20),
         fee_open=0.001,
         fee_close=0.001,
         exchange='binance',
         leverage=1.0,
         trading_mode='futures',
         enter_tag='a' * CUSTOM_TAG_MAX_LENGTH * 2,
         exit_reason='b' * CUSTOM_TAG_MAX_LENGTH * 2,
@@ -2088,15 +2088,15 @@
     o1_cost = o1_amount * o1_rate
     o1_fee_cost = o1_cost * fee.return_value
     o1_trade_val = o1_cost + o1_fee_cost
 
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=o1_cost,
-        open_date=arrow.utcnow().shift(hours=-2).datetime,
+        open_date=dt_now() - timedelta(hours=2),
         amount=o1_amount,
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=o1_rate,
         max_rate=o1_rate,
         leverage=1,
@@ -2163,16 +2163,16 @@
         order_type="market",
         side="buy",
         price=o2_rate,
         average=o2_rate,
         filled=o2_amount,
         remaining=0,
         cost=o2_cost,
-        order_date=arrow.utcnow().shift(hours=-1).datetime,
-        order_filled_date=arrow.utcnow().shift(hours=-1).datetime,
+        order_date=dt_now() - timedelta(hours=1),
+        order_filled_date=dt_now() - timedelta(hours=1),
     )
     trade.orders.append(order2)
     trade.recalc_trade_from_orders()
 
     # Validate that the trade now has new averaged open price and total values
     avg_price = (o1_cost + o2_cost) / (o1_amount + o2_amount)
     assert trade.amount == o1_amount + o2_amount
@@ -2197,16 +2197,16 @@
         order_type="market",
         side="buy",
         price=o3_rate,
         average=o3_rate,
         filled=o3_amount,
         remaining=0,
         cost=o3_cost,
-        order_date=arrow.utcnow().shift(hours=-1).datetime,
-        order_filled_date=arrow.utcnow().shift(hours=-1).datetime,
+        order_date=dt_now() - timedelta(hours=1),
+        order_filled_date=dt_now() - timedelta(hours=1),
     )
     trade.orders.append(order3)
     trade.recalc_trade_from_orders()
 
     # Validate that the sum is still correct and open rate is averaged
     avg_price = (o1_cost + o2_cost + o3_cost) / (o1_amount + o2_amount + o3_amount)
     assert trade.amount == o1_amount + o2_amount + o3_amount
@@ -2253,15 +2253,15 @@
     o1_trade_val = o1_cost - o1_fee_cost if is_short else o1_cost + o1_fee_cost
     entry_side = "sell" if is_short else "buy"
     exit_side = "buy" if is_short else "sell"
 
     trade = Trade(
         pair='ADA/USDT',
         stake_amount=o1_cost,
-        open_date=arrow.utcnow().shift(hours=-2).datetime,
+        open_date=dt_now() - timedelta(hours=2),
         amount=o1_amount,
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=o1_rate,
         max_rate=o1_rate,
         is_short=is_short,
@@ -2305,16 +2305,16 @@
         order_type="market",
         side=entry_side,
         price=o1_rate,
         average=o1_rate,
         filled=o1_amount,
         remaining=0,
         cost=o1_cost,
-        order_date=arrow.utcnow().shift(hours=-1).datetime,
-        order_filled_date=arrow.utcnow().shift(hours=-1).datetime,
+        order_date=dt_now() - timedelta(hours=1),
+        order_filled_date=dt_now() - timedelta(hours=1),
     )
     trade.orders.append(order2)
     trade.recalc_trade_from_orders()
 
     # Validate that the trade values have not been changed
     assert trade.amount == o1_amount
     assert trade.stake_amount == o1_amount
@@ -2333,16 +2333,16 @@
         order_type="market",
         side=entry_side,
         price=1,
         average=2,
         filled=0,
         remaining=4,
         cost=5,
-        order_date=arrow.utcnow().shift(hours=-1).datetime,
-        order_filled_date=arrow.utcnow().shift(hours=-1).datetime,
+        order_date=dt_now() - timedelta(hours=1),
+        order_filled_date=dt_now() - timedelta(hours=1),
     )
     trade.orders.append(order3)
     trade.recalc_trade_from_orders()
 
     # Validate that the order values still are ignoring orders 2 and 3
     assert trade.amount == o1_amount
     assert trade.stake_amount == o1_amount
@@ -2360,16 +2360,16 @@
         order_type="market",
         side=entry_side,
         price=o1_rate,
         average=o1_rate,
         filled=o1_amount,
         remaining=0,
         cost=o1_cost,
-        order_date=arrow.utcnow().shift(hours=-1).datetime,
-        order_filled_date=arrow.utcnow().shift(hours=-1).datetime,
+        order_date=dt_now() - timedelta(hours=1),
+        order_filled_date=dt_now() - timedelta(hours=1),
     )
     trade.orders.append(order4)
     trade.recalc_trade_from_orders()
 
     # Validate that the trade values have been changed
     assert trade.amount == 2 * o1_amount
     assert trade.stake_amount == 2 * o1_amount
@@ -2477,33 +2477,45 @@
     assert len(orders) == 1
     orders = trades[4].select_filled_orders('sell')
     assert orders is not None
     assert len(orders) == 0
 
 
 @pytest.mark.usefixtures("init_persistence")
-def test_order_to_ccxt(limit_buy_order_open):
+def test_order_to_ccxt(limit_buy_order_open, limit_sell_order_usdt_open):
 
     order = Order.parse_from_ccxt_object(limit_buy_order_open, 'mocked', 'buy')
     order.ft_trade_id = 1
     order.session.add(order)
     Order.session.commit()
 
     order_resp = Order.order_by_id(limit_buy_order_open['id'])
     assert order_resp
 
     raw_order = order_resp.to_ccxt_object()
     del raw_order['fee']
     del raw_order['datetime']
     del raw_order['info']
-    assert raw_order['stopPrice'] is None
-    del raw_order['stopPrice']
+    assert raw_order.get('stopPrice') is None
+    raw_order.pop('stopPrice', None)
     del limit_buy_order_open['datetime']
     assert raw_order == limit_buy_order_open
 
+    order1 = Order.parse_from_ccxt_object(limit_sell_order_usdt_open, 'mocked', 'sell')
+    order1.ft_order_side = 'stoploss'
+    order1.stop_price = order1.price * 0.9
+    order1.ft_trade_id = 1
+    order1.session.add(order1)
+    Order.session.commit()
+
+    order_resp1 = Order.order_by_id(limit_sell_order_usdt_open['id'])
+    raw_order1 = order_resp1.to_ccxt_object()
+
+    assert raw_order1.get('stopPrice') is not None
+
 
 @pytest.mark.usefixtures("init_persistence")
 @pytest.mark.parametrize('data', [
     {
         # tuple 1 - side, amount, price
         # tuple 2 - amount, open_rate, stake_amount, cumulative_profit, realized_profit, rel_profit
         'orders': [
@@ -2576,15 +2588,15 @@
     trade = Trade(
         id=2,
         pair=pair,
         stake_amount=1000,
         open_rate=data['orders'][0][0][2],
         amount=data['orders'][0][0][1],
         is_open=True,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         fee_open=data['fee'],
         fee_close=data['fee'],
         exchange='binance',
         is_short=False,
         leverage=1.0,
         trading_mode=TradingMode.SPOT
     )
@@ -2606,16 +2618,16 @@
             order_type="market",
             side=order[0],
             price=price,
             average=price,
             filled=amount,
             remaining=0,
             cost=amount * price,
-            order_date=arrow.utcnow().shift(hours=-10 + idx).datetime,
-            order_filled_date=arrow.utcnow().shift(hours=-10 + idx).datetime,
+            order_date=dt_now() - timedelta(hours=10 + idx),
+            order_filled_date=dt_now() - timedelta(hours=10 + idx),
         )
         trade.orders.append(order_obj)
         trade.recalc_trade_from_orders()
         Trade.commit()
 
         orders1 = Order.session.scalars(select(Order)).all()
         assert orders1
```

### Comparing `freqtrade-2023.4/tests/persistence/test_trade_fromjson.py` & `freqtrade-2023.5/tests/persistence/test_trade_fromjson.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/plugins/test_pairlist.py` & `freqtrade-2023.5/tests/plugins/test_pairlist.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/plugins/test_pairlocks.py` & `freqtrade-2023.5/tests/plugins/test_pairlocks.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 from datetime import datetime, timedelta, timezone
 
-import arrow
 import pytest
 
 from freqtrade.persistence import PairLocks
 from freqtrade.persistence.models import PairLock
+from freqtrade.util import dt_now
 
 
 @pytest.mark.parametrize('use_db', (False, True))
 @pytest.mark.usefixtures("init_persistence")
 def test_PairLocks(use_db):
     PairLocks.timeframe = '5m'
     PairLocks.use_db = use_db
@@ -16,39 +16,39 @@
     if use_db:
         assert len(PairLock.get_all_locks().all()) == 0
 
     assert PairLocks.use_db == use_db
 
     pair = 'ETH/BTC'
     assert not PairLocks.is_pair_locked(pair)
-    PairLocks.lock_pair(pair, arrow.utcnow().shift(minutes=4).datetime)
+    PairLocks.lock_pair(pair, dt_now() + timedelta(minutes=4))
     # ETH/BTC locked for 4 minutes (on both sides)
     assert PairLocks.is_pair_locked(pair)
     assert PairLocks.is_pair_locked(pair, side='long')
     assert PairLocks.is_pair_locked(pair, side='short')
 
     pair = 'BNB/BTC'
-    PairLocks.lock_pair(pair, arrow.utcnow().shift(minutes=4).datetime, side='long')
+    PairLocks.lock_pair(pair, dt_now() + timedelta(minutes=4), side='long')
     assert not PairLocks.is_pair_locked(pair)
     assert PairLocks.is_pair_locked(pair, side='long')
     assert not PairLocks.is_pair_locked(pair, side='short')
 
     pair = 'BNB/USDT'
-    PairLocks.lock_pair(pair, arrow.utcnow().shift(minutes=4).datetime, side='short')
+    PairLocks.lock_pair(pair, dt_now() + timedelta(minutes=4), side='short')
     assert not PairLocks.is_pair_locked(pair)
     assert not PairLocks.is_pair_locked(pair, side='long')
     assert PairLocks.is_pair_locked(pair, side='short')
 
     # XRP/BTC should not be locked now
     pair = 'XRP/BTC'
     assert not PairLocks.is_pair_locked(pair)
     # Unlocking a pair that's not locked should not raise an error
     PairLocks.unlock_pair(pair)
 
-    PairLocks.lock_pair(pair, arrow.utcnow().shift(minutes=4).datetime)
+    PairLocks.lock_pair(pair, dt_now() + timedelta(minutes=4))
     assert PairLocks.is_pair_locked(pair)
 
     # Get both locks from above
     locks = PairLocks.get_pair_locks(None)
     assert len(locks) == 2
 
     # Unlock original pair
@@ -109,28 +109,28 @@
     if use_db:
         assert len(PairLock.get_all_locks().all()) == 0
 
     assert PairLocks.use_db == use_db
 
     pair = 'ETH/BTC'
     assert not PairLocks.is_pair_locked(pair)
-    PairLocks.lock_pair(pair, arrow.utcnow().shift(minutes=4).datetime)
+    PairLocks.lock_pair(pair, dt_now() + timedelta(minutes=4))
     # ETH/BTC locked for 4 minutes
     assert PairLocks.is_pair_locked(pair)
     lock = PairLocks.get_pair_longest_lock(pair)
 
-    assert lock.lock_end_time.replace(tzinfo=timezone.utc) > arrow.utcnow().shift(minutes=3)
-    assert lock.lock_end_time.replace(tzinfo=timezone.utc) < arrow.utcnow().shift(minutes=14)
+    assert lock.lock_end_time.replace(tzinfo=timezone.utc) > dt_now() + timedelta(minutes=3)
+    assert lock.lock_end_time.replace(tzinfo=timezone.utc) < dt_now() + timedelta(minutes=14)
 
-    PairLocks.lock_pair(pair, arrow.utcnow().shift(minutes=15).datetime)
+    PairLocks.lock_pair(pair, dt_now() + timedelta(minutes=15))
     assert PairLocks.is_pair_locked(pair)
 
     lock = PairLocks.get_pair_longest_lock(pair)
     # Must be longer than above
-    assert lock.lock_end_time.replace(tzinfo=timezone.utc) > arrow.utcnow().shift(minutes=14)
+    assert lock.lock_end_time.replace(tzinfo=timezone.utc) > dt_now() + timedelta(minutes=14)
 
     PairLocks.reset_locks()
     PairLocks.use_db = True
 
 
 @pytest.mark.parametrize('use_db', (False, True))
 @pytest.mark.usefixtures("init_persistence")
@@ -139,16 +139,16 @@
     PairLocks.use_db = use_db
     # No lock should be present
     if use_db:
         assert len(PairLock.get_all_locks().all()) == 0
 
     assert PairLocks.use_db == use_db
 
-    PairLocks.lock_pair('XRP/USDT', arrow.utcnow().shift(minutes=4).datetime, 'TestLock1')
-    PairLocks.lock_pair('ETH/USDT', arrow.utcnow().shift(minutes=4).datetime, 'TestLock2')
+    PairLocks.lock_pair('XRP/USDT', dt_now() + timedelta(minutes=4), 'TestLock1')
+    PairLocks.lock_pair('ETH/USDT', dt_now() + timedelta(minutes=4), 'TestLock2')
 
     assert PairLocks.is_pair_locked('XRP/USDT')
     assert PairLocks.is_pair_locked('ETH/USDT')
 
     PairLocks.unlock_reason('TestLock1')
     assert not PairLocks.is_pair_locked('XRP/USDT')
     assert PairLocks.is_pair_locked('ETH/USDT')
```

### Comparing `freqtrade-2023.4/tests/plugins/test_protections.py` & `freqtrade-2023.5/tests/plugins/test_protections.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,9 +1,9 @@
 import random
-from datetime import datetime, timedelta
+from datetime import datetime, timedelta, timezone
 
 import pytest
 
 from freqtrade import constants
 from freqtrade.enums import ExitType
 from freqtrade.persistence import PairLocks, Trade
 from freqtrade.persistence.trade_model import Order
@@ -20,16 +20,16 @@
     open_rate = random.random()
 
     trade = Trade(
         pair=pair,
         stake_amount=0.01,
         fee_open=fee,
         fee_close=fee,
-        open_date=datetime.utcnow() - timedelta(minutes=min_ago_open or 200),
-        close_date=datetime.utcnow() - timedelta(minutes=min_ago_close or 30),
+        open_date=datetime.now(timezone.utc) - timedelta(minutes=min_ago_open or 200),
+        close_date=datetime.now(timezone.utc) - timedelta(minutes=min_ago_close or 30),
         open_rate=open_rate,
         is_open=is_open,
         amount=0.01 / open_rate,
         exchange='binance',
         is_short=is_short,
         leverage=1,
     )
@@ -83,17 +83,17 @@
     default_conf['protections'] = [{'method': protection}
                                    for protection in constants.AVAILABLE_PROTECTIONS]
     freqtrade = get_patched_freqtradebot(mocker, default_conf)
 
     for handler in freqtrade.protections._protection_handlers:
         assert handler.name in constants.AVAILABLE_PROTECTIONS
         if not handler.has_global_stop:
-            assert handler.global_stop(datetime.utcnow(), '*') is None
+            assert handler.global_stop(datetime.now(timezone.utc), '*') is None
         if not handler.has_local_stop:
-            assert handler.stop_per_pair('XRP/BTC', datetime.utcnow(), '*') is None
+            assert handler.stop_per_pair('XRP/BTC', datetime.now(timezone.utc), '*') is None
 
 
 @pytest.mark.parametrize('timeframe,expected,protconf', [
     ('1m', [20, 10],
      [{"method": "StoplossGuard", "lookback_period_candles": 20, "stop_duration": 10}]),
     ('5m', [100, 15],
      [{"method": "StoplossGuard", "lookback_period_candles": 20, "stop_duration": 15}]),
```

### Comparing `freqtrade-2023.4/tests/plugins/test_remotepairlist.py` & `freqtrade-2023.5/tests/plugins/test_remotepairlist.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/rpc/test_fiat_convert.py` & `freqtrade-2023.5/tests/rpc/test_fiat_convert.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/rpc/test_rpc.py` & `freqtrade-2023.5/tests/rpc/test_rpc.py`

 * *Files 1% similar despite different names*

```diff
@@ -257,16 +257,15 @@
     result, headers, fiat_profit_sum = rpc._rpc_status_table(default_conf['stake_currency'], 'USD')
     assert 'instantly' == result[0][2]
     assert 'ETH/BTC' in result[0][1]
     assert 'nan%' == result[0][3]
     assert isnan(fiat_profit_sum)
 
 
-def test__rpc_timeunit_profit(default_conf_usdt, ticker, fee,
-                              limit_buy_order, limit_sell_order, markets, mocker) -> None:
+def test__rpc_timeunit_profit(default_conf_usdt, ticker, fee, markets, mocker) -> None:
     mocker.patch('freqtrade.rpc.telegram.Telegram', MagicMock())
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
         markets=PropertyMock(return_value=markets)
     )
@@ -291,15 +290,15 @@
         #  'fiat_value': 0.0, 'trade_count': 2}
         assert day['abs_profit'] in (0.0, pytest.approx(6.83), pytest.approx(-4.09))
         assert day['rel_profit'] in (0.0, pytest.approx(0.00642902), pytest.approx(-0.00383512))
         assert day['trade_count'] in (0, 1, 2)
         assert day['starting_balance'] in (pytest.approx(1062.37), pytest.approx(1066.46))
         assert day['fiat_value'] in (0.0, )
     # ensure first day is current date
-    assert str(days['data'][0]['date']) == str(datetime.utcnow().date())
+    assert str(days['data'][0]['date']) == str(datetime.now(timezone.utc).date())
 
     # Try invalid data
     with pytest.raises(RPCException, match=r'.*must be an integer greater than 0*'):
         rpc._rpc_timeunit_profit(0, stake_currency, fiat_display_currency)
 
 
 @pytest.mark.parametrize('is_short', [True, False])
@@ -411,27 +410,27 @@
     assert pytest.approx(stats['profit_closed_coin']) == 2.74
     assert pytest.approx(stats['profit_closed_percent_mean']) == -1.67
     assert pytest.approx(stats['profit_closed_fiat']) == 3.014
     assert pytest.approx(stats['profit_all_coin']) == -77.45964918
     assert pytest.approx(stats['profit_all_percent_mean']) == -57.86
     assert pytest.approx(stats['profit_all_fiat']) == -85.205614098
     assert stats['trade_count'] == 7
-    assert stats['first_trade_date'] == '2 days ago'
-    assert stats['latest_trade_date'] == '17 minutes ago'
+    assert stats['first_trade_humanized'] == '2 days ago'
+    assert stats['latest_trade_humanized'] == '17 minutes ago'
     assert stats['avg_duration'] in ('0:17:40')
     assert stats['best_pair'] == 'XRP/USDT'
     assert stats['best_rate'] == 10.0
 
     # Test non-available pair
     mocker.patch(f'{EXMS}.get_rate',
                  MagicMock(side_effect=ExchangeError("Pair 'XRP/USDT' not available")))
     stats = rpc._rpc_trade_statistics(stake_currency, fiat_display_currency)
     assert stats['trade_count'] == 7
-    assert stats['first_trade_date'] == '2 days ago'
-    assert stats['latest_trade_date'] == '17 minutes ago'
+    assert stats['first_trade_humanized'] == '2 days ago'
+    assert stats['latest_trade_humanized'] == '17 minutes ago'
     assert stats['avg_duration'] in ('0:17:40')
     assert stats['best_pair'] == 'XRP/USDT'
     assert stats['best_rate'] == 10.0
     assert isnan(stats['profit_all_coin'])
 
 
 def test_rpc_balance_handle_error(default_conf, mocker):
@@ -542,61 +541,75 @@
     assert 'USD' == result['symbol']
     assert result['currencies'] == [
         {
             'currency': 'BTC',
             'free': 10.0,
             'balance': 12.0,
             'used': 2.0,
+            'bot_owned': 9.9,  # available stake - reducing by reserved amount
             'est_stake': 10.0,  # In futures mode, "free" is used here.
+            'est_stake_bot': 9.9,
             'stake': 'BTC',
             'is_position': False,
             'leverage': 1.0,
             'position': 0.0,
             'side': 'long',
+            'is_bot_managed': True,
         },
         {
             'free': 1.0,
             'balance': 5.0,
             'currency': 'ETH',
+            'bot_owned': 0,
             'est_stake': 0.30794,
+            'est_stake_bot': 0,
             'used': 4.0,
             'stake': 'BTC',
             'is_position': False,
             'leverage': 1.0,
             'position': 0.0,
             'side': 'long',
-
+            'is_bot_managed': False,
         },
         {
             'free': 5.0,
             'balance': 10.0,
             'currency': 'USDT',
+            'bot_owned': 0,
             'est_stake': 0.0011562404610161968,
+            'est_stake_bot': 0,
             'used': 5.0,
             'stake': 'BTC',
             'is_position': False,
             'leverage': 1.0,
             'position': 0.0,
             'side': 'long',
+            'is_bot_managed': False,
         },
         {
             'free': 0.0,
             'balance': 0.0,
             'currency': 'ETH/USDT:USDT',
             'est_stake': 20,
+            'est_stake_bot': 20,
             'used': 0,
             'stake': 'BTC',
             'is_position': True,
             'leverage': 5.0,
             'position': 1000.0,
             'side': 'short',
+            'is_bot_managed': True,
         }
     ]
+    assert pytest.approx(result['total_bot']) == 29.9
+    assert pytest.approx(result['total']) == 30.309096
     assert result['starting_capital'] == 10
-    assert result['starting_capital_ratio'] == 0.0
+    # Very high starting capital ratio, because the futures position really has the wrong unit.
+    # TODO: improve this test (see comment above)
+    assert result['starting_capital_ratio'] == pytest.approx(1.98999999)
 
 
 def test_rpc_start(mocker, default_conf) -> None:
     mocker.patch('freqtrade.rpc.telegram.Telegram', MagicMock())
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=MagicMock()
```

### Comparing `freqtrade-2023.4/tests/rpc/test_rpc_apiserver.py` & `freqtrade-2023.5/tests/rpc/test_rpc_apiserver.py`

 * *Files 2% similar despite different names*

```diff
@@ -17,19 +17,21 @@
 from requests.auth import _basic_auth_str
 from sqlalchemy import select
 
 from freqtrade.__init__ import __version__
 from freqtrade.enums import CandleType, RunMode, State, TradingMode
 from freqtrade.exceptions import DependencyException, ExchangeError, OperationalException
 from freqtrade.loggers import setup_logging, setup_logging_pre
+from freqtrade.optimize.backtesting import Backtesting
 from freqtrade.persistence import PairLocks, Trade
 from freqtrade.rpc import RPC
 from freqtrade.rpc.api_server import ApiServer
 from freqtrade.rpc.api_server.api_auth import create_token, get_user_from_token
 from freqtrade.rpc.api_server.uvicorn_threaded import UvicornServer
+from freqtrade.rpc.api_server.webserver_bgwork import ApiBG
 from tests.conftest import (CURRENT_TEST_STRATEGY, EXMS, create_mock_trades, get_mock_coro,
                             get_patched_freqtradebot, log_has, log_has_re, patch_get_signal)
 
 
 BASE_URI = "/api/v1"
 _TEST_USER = "FreqTrader"
 _TEST_PASS = "SuperSecurePassword1!"
@@ -279,15 +281,15 @@
     """
     default_conf.update({"api_server": {"enabled": True,
                                         "listen_ip_address": "127.0.0.1",
                                         "listen_port": 8080,
                                         "username": "TestUser",
                                         "password": "testPass",
                                         }})
-    mocker.patch('freqtrade.rpc.telegram.Updater', MagicMock())
+    mocker.patch('freqtrade.rpc.telegram.Telegram._init')
     mocker.patch('freqtrade.rpc.api_server.webserver.ApiServer.start_api', MagicMock())
     apiserver = ApiServer(default_conf)
     apiserver.add_rpc_handler(RPC(get_patched_freqtradebot(mocker, default_conf)))
     assert apiserver._config == default_conf
     with pytest.raises(OperationalException, match="RPC Handler already attached."):
         apiserver.add_rpc_handler(RPC(get_patched_freqtradebot(mocker, default_conf)))
 
@@ -337,15 +339,15 @@
 def test_api_run(default_conf, mocker, caplog):
     default_conf.update({"api_server": {"enabled": True,
                                         "listen_ip_address": "127.0.0.1",
                                         "listen_port": 8080,
                                         "username": "TestUser",
                                         "password": "testPass",
                                         }})
-    mocker.patch('freqtrade.rpc.telegram.Updater', MagicMock())
+    mocker.patch('freqtrade.rpc.telegram.Telegram._init')
 
     server_inst_mock = MagicMock()
     server_inst_mock.run_in_thread = MagicMock()
     server_inst_mock.run = MagicMock()
     server_mock = MagicMock(return_value=server_inst_mock)
     mocker.patch('freqtrade.rpc.api_server.webserver.UvicornServer', server_mock)
 
@@ -415,15 +417,15 @@
 def test_api_cleanup(default_conf, mocker, caplog):
     default_conf.update({"api_server": {"enabled": True,
                                         "listen_ip_address": "127.0.0.1",
                                         "listen_port": 8080,
                                         "username": "TestUser",
                                         "password": "testPass",
                                         }})
-    mocker.patch('freqtrade.rpc.telegram.Updater', MagicMock())
+    mocker.patch('freqtrade.rpc.telegram.Telegram._init')
 
     server_mock = MagicMock()
     server_mock.cleanup = MagicMock()
     mocker.patch('freqtrade.rpc.api_server.webserver.UvicornServer', server_mock)
 
     apiserver = ApiServer(default_conf)
     apiserver.add_rpc_handler(RPC(get_patched_freqtradebot(mocker, default_conf)))
@@ -476,21 +478,26 @@
     assert "currencies" in response
     assert len(response["currencies"]) == 5
     assert response['currencies'][0] == {
         'currency': 'BTC',
         'free': 12.0,
         'balance': 12.0,
         'used': 0.0,
+        'bot_owned': pytest.approx(11.879999),
         'est_stake': 12.0,
+        'est_stake_bot': pytest.approx(11.879999),
         'stake': 'BTC',
         'is_position': False,
         'leverage': 1.0,
         'position': 0.0,
         'side': 'long',
+        'is_bot_managed': True,
     }
+    assert response['total'] == 12.159513094
+    assert response['total_bot'] == pytest.approx(11.879999)
     assert 'starting_capital' in response
     assert 'starting_capital_fiat' in response
     assert 'starting_capital_pct' in response
     assert 'starting_capital_ratio' in response
 
 
 @pytest.mark.parametrize('is_short', [True, False])
@@ -592,15 +599,15 @@
         markets=PropertyMock(return_value=markets)
     )
     rc = client_get(client, f"{BASE_URI}/daily")
     assert_response(rc)
     assert len(rc.json()['data']) == 7
     assert rc.json()['stake_currency'] == 'BTC'
     assert rc.json()['fiat_display_currency'] == 'USD'
-    assert rc.json()['data'][0]['date'] == str(datetime.utcnow().date())
+    assert rc.json()['data'][0]['date'] == str(datetime.now(timezone.utc).date())
 
 
 @pytest.mark.parametrize('is_short', [True, False])
 def test_api_trades(botclient, mocker, fee, markets, is_short):
     ftbot, client = botclient
     patch_get_signal(ftbot)
     mocker.patch.multiple(
@@ -731,14 +738,41 @@
     mocker.patch(f'{EXMS}.fetch_order', return_value=trade.orders[-1].to_ccxt_object())
 
     rc = client_delete(client, f"{BASE_URI}/trades/6/open-order")
     assert_response(rc)
     assert cancel_mock.call_count == 1
 
 
+@pytest.mark.parametrize('is_short', [True, False])
+def test_api_trade_reload_trade(botclient, mocker, fee, markets, ticker, is_short):
+    ftbot, client = botclient
+    patch_get_signal(ftbot, enter_long=not is_short, enter_short=is_short)
+    stoploss_mock = MagicMock()
+    cancel_mock = MagicMock()
+    ftbot.handle_onexchange_order = MagicMock()
+    mocker.patch.multiple(
+        EXMS,
+        markets=PropertyMock(return_value=markets),
+        fetch_ticker=ticker,
+        cancel_order=cancel_mock,
+        cancel_stoploss_order=stoploss_mock,
+    )
+
+    rc = client_post(client, f"{BASE_URI}/trades/10/reload")
+    assert_response(rc, 502)
+    assert 'Could not find trade with id 10.' in rc.json()['error']
+    assert ftbot.handle_onexchange_order.call_count == 0
+
+    create_mock_trades(fee, is_short=is_short)
+    Trade.commit()
+
+    rc = client_post(client, f"{BASE_URI}/trades/5/reload")
+    assert ftbot.handle_onexchange_order.call_count == 1
+
+
 def test_api_logs(botclient):
     ftbot, client = botclient
     rc = client_get(client, f"{BASE_URI}/logs")
     assert_response(rc)
     assert len(rc.json()) == 2
     assert 'logs' in rc.json()
     # Using a fixed comparison here would make this test fail!
@@ -852,16 +886,18 @@
     # raise ValueError(rc.json())
     assert rc.json() == {
         'avg_duration': ANY,
         'best_pair': expected['best_pair'],
         'best_pair_profit_ratio': expected['best_pair_profit_ratio'],
         'best_rate': expected['best_rate'],
         'first_trade_date': ANY,
+        'first_trade_humanized': ANY,
         'first_trade_timestamp': ANY,
-        'latest_trade_date': '5 minutes ago',
+        'latest_trade_date': ANY,
+        'latest_trade_humanized': '5 minutes ago',
         'latest_trade_timestamp': ANY,
         'profit_all_coin': pytest.approx(expected['profit_all_coin']),
         'profit_all_fiat': pytest.approx(expected['profit_all_fiat']),
         'profit_all_percent_mean': pytest.approx(expected['profit_all_percent_mean']),
         'profit_all_ratio_mean': pytest.approx(expected['profit_all_ratio_mean']),
         'profit_all_percent_sum': pytest.approx(expected['profit_all_percent_sum']),
         'profit_all_ratio_sum': pytest.approx(expected['profit_all_ratio_sum']),
@@ -1188,15 +1224,15 @@
         pair='ETH/BTC',
         amount=1,
         amount_requested=1,
         exchange='binance',
         stake_amount=1,
         open_rate=0.245441,
         open_order_id="123456",
-        open_date=datetime.utcnow(),
+        open_date=datetime.now(timezone.utc),
         is_open=False,
         is_short=False,
         fee_close=fee.return_value,
         fee_open=fee.return_value,
         close_rate=0.265441,
         id=22,
         timeframe=5,
@@ -1627,145 +1663,148 @@
     assert_response(rc)
     result = rc.json()
     assert 'cpu_pct' in result
     assert 'ram_pct' in result
 
 
 def test_api_backtesting(botclient, mocker, fee, caplog, tmpdir):
-    ftbot, client = botclient
-    mocker.patch(f'{EXMS}.get_fee', fee)
-
-    rc = client_get(client, f"{BASE_URI}/backtest")
-    # Backtest prevented in default mode
-    assert_response(rc, 502)
-
-    ftbot.config['runmode'] = RunMode.WEBSERVER
-    # Backtesting not started yet
-    rc = client_get(client, f"{BASE_URI}/backtest")
-    assert_response(rc)
-
-    result = rc.json()
-    assert result['status'] == 'not_started'
-    assert not result['running']
-    assert result['status_msg'] == 'Backtest not yet executed'
-    assert result['progress'] == 0
-
-    # Reset backtesting
-    rc = client_delete(client, f"{BASE_URI}/backtest")
-    assert_response(rc)
-    result = rc.json()
-    assert result['status'] == 'reset'
-    assert not result['running']
-    assert result['status_msg'] == 'Backtest reset'
-    ftbot.config['export'] = 'trades'
-    ftbot.config['backtest_cache'] = 'day'
-    ftbot.config['user_data_dir'] = Path(tmpdir)
-    ftbot.config['exportfilename'] = Path(tmpdir) / "backtest_results"
-    ftbot.config['exportfilename'].mkdir()
-
-    # start backtesting
-    data = {
-        "strategy": CURRENT_TEST_STRATEGY,
-        "timeframe": "5m",
-        "timerange": "20180110-20180111",
-        "max_open_trades": 3,
-        "stake_amount": 100,
-        "dry_run_wallet": 1000,
-        "enable_protections": False
-    }
-    rc = client_post(client, f"{BASE_URI}/backtest", data=data)
-    assert_response(rc)
-    result = rc.json()
-
-    assert result['status'] == 'running'
-    assert result['progress'] == 0
-    assert result['running']
-    assert result['status_msg'] == 'Backtest started'
-
-    rc = client_get(client, f"{BASE_URI}/backtest")
-    assert_response(rc)
-
-    result = rc.json()
-    assert result['status'] == 'ended'
-    assert not result['running']
-    assert result['status_msg'] == 'Backtest ended'
-    assert result['progress'] == 1
-    assert result['backtest_result']
-
-    rc = client_get(client, f"{BASE_URI}/backtest/abort")
-    assert_response(rc)
-    result = rc.json()
-    assert result['status'] == 'not_running'
-    assert not result['running']
-    assert result['status_msg'] == 'Backtest ended'
-
-    # Simulate running backtest
-    ApiServer._bgtask_running = True
-    rc = client_get(client, f"{BASE_URI}/backtest/abort")
-    assert_response(rc)
-    result = rc.json()
-    assert result['status'] == 'stopping'
-    assert not result['running']
-    assert result['status_msg'] == 'Backtest ended'
-
-    # Get running backtest...
-    rc = client_get(client, f"{BASE_URI}/backtest")
-    assert_response(rc)
-    result = rc.json()
-    assert result['status'] == 'running'
-    assert result['running']
-    assert result['step'] == "backtest"
-    assert result['status_msg'] == "Backtest running"
-
-    # Try delete with task still running
-    rc = client_delete(client, f"{BASE_URI}/backtest")
-    assert_response(rc)
-    result = rc.json()
-    assert result['status'] == 'running'
-
-    # Post to backtest that's still running
-    rc = client_post(client, f"{BASE_URI}/backtest", data=data)
-    assert_response(rc, 502)
-    result = rc.json()
-    assert 'Bot Background task already running' in result['error']
-
-    ApiServer._bgtask_running = False
-
-    # Rerun backtest (should get previous result)
-    rc = client_post(client, f"{BASE_URI}/backtest", data=data)
-    assert_response(rc)
-    result = rc.json()
-    assert log_has_re('Reusing result of previous backtest.*', caplog)
-
-    data['stake_amount'] = 101
-
-    mocker.patch('freqtrade.optimize.backtesting.Backtesting.backtest_one_strategy',
-                 side_effect=DependencyException('DeadBeef'))
-    rc = client_post(client, f"{BASE_URI}/backtest", data=data)
-    assert log_has("Backtesting caused an error: DeadBeef", caplog)
-
-    rc = client_get(client, f"{BASE_URI}/backtest")
-    assert_response(rc)
-    result = rc.json()
-    assert result['status'] == 'error'
-    assert 'Backtest failed' in result['status_msg']
-
-    # Delete backtesting to avoid leakage since the backtest-object may stick around.
-    rc = client_delete(client, f"{BASE_URI}/backtest")
-    assert_response(rc)
-
-    result = rc.json()
-    assert result['status'] == 'reset'
-    assert not result['running']
-    assert result['status_msg'] == 'Backtest reset'
+    try:
+        ftbot, client = botclient
+        mocker.patch(f'{EXMS}.get_fee', fee)
 
-    # Disallow base64 strategies
-    data['strategy'] = "xx:cHJpbnQoImhlbGxvIHdvcmxkIik="
-    rc = client_post(client, f"{BASE_URI}/backtest", data=data)
-    assert_response(rc, 500)
+        rc = client_get(client, f"{BASE_URI}/backtest")
+        # Backtest prevented in default mode
+        assert_response(rc, 502)
+
+        ftbot.config['runmode'] = RunMode.WEBSERVER
+        # Backtesting not started yet
+        rc = client_get(client, f"{BASE_URI}/backtest")
+        assert_response(rc)
+
+        result = rc.json()
+        assert result['status'] == 'not_started'
+        assert not result['running']
+        assert result['status_msg'] == 'Backtest not yet executed'
+        assert result['progress'] == 0
+
+        # Reset backtesting
+        rc = client_delete(client, f"{BASE_URI}/backtest")
+        assert_response(rc)
+        result = rc.json()
+        assert result['status'] == 'reset'
+        assert not result['running']
+        assert result['status_msg'] == 'Backtest reset'
+        ftbot.config['export'] = 'trades'
+        ftbot.config['backtest_cache'] = 'day'
+        ftbot.config['user_data_dir'] = Path(tmpdir)
+        ftbot.config['exportfilename'] = Path(tmpdir) / "backtest_results"
+        ftbot.config['exportfilename'].mkdir()
+
+        # start backtesting
+        data = {
+            "strategy": CURRENT_TEST_STRATEGY,
+            "timeframe": "5m",
+            "timerange": "20180110-20180111",
+            "max_open_trades": 3,
+            "stake_amount": 100,
+            "dry_run_wallet": 1000,
+            "enable_protections": False
+        }
+        rc = client_post(client, f"{BASE_URI}/backtest", data=data)
+        assert_response(rc)
+        result = rc.json()
+
+        assert result['status'] == 'running'
+        assert result['progress'] == 0
+        assert result['running']
+        assert result['status_msg'] == 'Backtest started'
+
+        rc = client_get(client, f"{BASE_URI}/backtest")
+        assert_response(rc)
+
+        result = rc.json()
+        assert result['status'] == 'ended'
+        assert not result['running']
+        assert result['status_msg'] == 'Backtest ended'
+        assert result['progress'] == 1
+        assert result['backtest_result']
+
+        rc = client_get(client, f"{BASE_URI}/backtest/abort")
+        assert_response(rc)
+        result = rc.json()
+        assert result['status'] == 'not_running'
+        assert not result['running']
+        assert result['status_msg'] == 'Backtest ended'
+
+        # Simulate running backtest
+        ApiBG.bgtask_running = True
+        rc = client_get(client, f"{BASE_URI}/backtest/abort")
+        assert_response(rc)
+        result = rc.json()
+        assert result['status'] == 'stopping'
+        assert not result['running']
+        assert result['status_msg'] == 'Backtest ended'
+
+        # Get running backtest...
+        rc = client_get(client, f"{BASE_URI}/backtest")
+        assert_response(rc)
+        result = rc.json()
+        assert result['status'] == 'running'
+        assert result['running']
+        assert result['step'] == "backtest"
+        assert result['status_msg'] == "Backtest running"
+
+        # Try delete with task still running
+        rc = client_delete(client, f"{BASE_URI}/backtest")
+        assert_response(rc)
+        result = rc.json()
+        assert result['status'] == 'running'
+
+        # Post to backtest that's still running
+        rc = client_post(client, f"{BASE_URI}/backtest", data=data)
+        assert_response(rc, 502)
+        result = rc.json()
+        assert 'Bot Background task already running' in result['error']
+
+        ApiBG.bgtask_running = False
+
+        # Rerun backtest (should get previous result)
+        rc = client_post(client, f"{BASE_URI}/backtest", data=data)
+        assert_response(rc)
+        result = rc.json()
+        assert log_has_re('Reusing result of previous backtest.*', caplog)
+
+        data['stake_amount'] = 101
+
+        mocker.patch('freqtrade.optimize.backtesting.Backtesting.backtest_one_strategy',
+                     side_effect=DependencyException('DeadBeef'))
+        rc = client_post(client, f"{BASE_URI}/backtest", data=data)
+        assert log_has("Backtesting caused an error: DeadBeef", caplog)
+
+        rc = client_get(client, f"{BASE_URI}/backtest")
+        assert_response(rc)
+        result = rc.json()
+        assert result['status'] == 'error'
+        assert 'Backtest failed' in result['status_msg']
+
+        # Delete backtesting to avoid leakage since the backtest-object may stick around.
+        rc = client_delete(client, f"{BASE_URI}/backtest")
+        assert_response(rc)
+
+        result = rc.json()
+        assert result['status'] == 'reset'
+        assert not result['running']
+        assert result['status_msg'] == 'Backtest reset'
+
+        # Disallow base64 strategies
+        data['strategy'] = "xx:cHJpbnQoImhlbGxvIHdvcmxkIik="
+        rc = client_post(client, f"{BASE_URI}/backtest", data=data)
+        assert_response(rc, 500)
+    finally:
+        Backtesting.cleanup()
 
 
 def test_api_backtest_history(botclient, mocker, testdatadir):
     ftbot, client = botclient
     mocker.patch('freqtrade.data.btanalysis._get_backtest_files',
                  return_value=[
                      testdatadir / 'backtest_results/backtest-result_multistrat.json',
@@ -1868,15 +1907,15 @@
                                             "listen_ip_address": "127.0.0.1",
                                             "listen_port": 8080,
                                             "CORS_origins": ['http://example.com'],
                                             "username": _TEST_USER,
                                             "password": _TEST_PASS,
                                             "ws_token": _TEST_WS_TOKEN
                                             }})
-        mocker.patch('freqtrade.rpc.telegram.Updater')
+        mocker.patch('freqtrade.rpc.telegram.Telegram._init')
         mocker.patch('freqtrade.rpc.api_server.ApiServer.start_api')
         apiserver = ApiServer(default_conf)
         apiserver.add_rpc_handler(RPC(get_patched_freqtradebot(mocker, default_conf)))
 
         # Start test client context manager to run lifespan events
         with TestClient(apiserver.app):
             # Test message is published on the Message Stream
```

### Comparing `freqtrade-2023.4/tests/rpc/test_rpc_emc.py` & `freqtrade-2023.5/tests/rpc/test_rpc_emc.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/rpc/test_rpc_manager.py` & `freqtrade-2023.5/tests/rpc/test_rpc_manager.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/rpc/test_rpc_telegram.py` & `freqtrade-2023.5/tests/rpc/test_rpc_telegram.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,20 +1,21 @@
 # pragma pylint: disable=missing-docstring, C0103
 # pragma pylint: disable=protected-access, unused-argument, invalid-name
 # pragma pylint: disable=too-many-lines, too-many-arguments
 
+import asyncio
 import logging
 import re
+import threading
 from datetime import datetime, timedelta, timezone
 from functools import reduce
 from random import choice, randint
 from string import ascii_uppercase
-from unittest.mock import ANY, MagicMock
+from unittest.mock import ANY, AsyncMock, MagicMock
 
-import arrow
 import pytest
 import time_machine
 from pandas import DataFrame
 from sqlalchemy import select
 from telegram import Chat, Message, ReplyKeyboardMarkup, Update
 from telegram.error import BadRequest, NetworkError, TelegramError
 
@@ -27,183 +28,242 @@
 from freqtrade.freqtradebot import FreqtradeBot
 from freqtrade.loggers import setup_logging
 from freqtrade.persistence import PairLocks, Trade
 from freqtrade.persistence.models import Order
 from freqtrade.rpc import RPC
 from freqtrade.rpc.rpc import RPCException
 from freqtrade.rpc.telegram import Telegram, authorized_only
+from freqtrade.util.datetime_helpers import dt_now
 from tests.conftest import (CURRENT_TEST_STRATEGY, EXMS, create_mock_trades,
                             create_mock_trades_usdt, get_patched_freqtradebot, log_has, log_has_re,
                             patch_exchange, patch_get_signal, patch_whitelist)
 
 
+@pytest.fixture(autouse=True)
+def mock_exchange_loop(mocker):
+    mocker.patch('freqtrade.exchange.exchange.Exchange._init_async_loop')
+
+
 @pytest.fixture
 def default_conf(default_conf) -> dict:
     # Telegram is enabled by default
     default_conf['telegram']['enabled'] = True
     return default_conf
 
 
+@pytest.fixture
+def update():
+    message = Message(0, datetime.now(timezone.utc), Chat(0, 0))
+    _update = Update(0, message=message)
+
+    return _update
+
+
+def patch_eventloop_threading(telegrambot):
+    is_init = False
+
+    def thread_fuck():
+        nonlocal is_init
+        telegrambot._loop = asyncio.new_event_loop()
+        is_init = True
+        telegrambot._loop.run_forever()
+    x = threading.Thread(target=thread_fuck, daemon=True)
+    x.start()
+    while not is_init:
+        pass
+
+
 class DummyCls(Telegram):
     """
     Dummy class for testing the Telegram @authorized_only decorator
     """
 
     def __init__(self, rpc: RPC, config) -> None:
         super().__init__(rpc, config)
         self.state = {'called': False}
 
     def _init(self):
         pass
 
     @authorized_only
-    def dummy_handler(self, *args, **kwargs) -> None:
+    async def dummy_handler(self, *args, **kwargs) -> None:
         """
         Fake method that only change the state of the object
         """
         self.state['called'] = True
 
     @authorized_only
-    def dummy_exception(self, *args, **kwargs) -> None:
+    async def dummy_exception(self, *args, **kwargs) -> None:
         """
         Fake method that throw an exception
         """
         raise Exception('test')
 
 
 def get_telegram_testobject(mocker, default_conf, mock=True, ftbot=None):
-    msg_mock = MagicMock()
+    msg_mock = AsyncMock()
     if mock:
         mocker.patch.multiple(
             'freqtrade.rpc.telegram.Telegram',
             _init=MagicMock(),
-            _send_msg=msg_mock
+            _send_msg=msg_mock,
+            _start_thread=MagicMock(),
         )
     if not ftbot:
+        mocker.patch('freqtrade.exchange.exchange.Exchange._init_async_loop')
         ftbot = get_patched_freqtradebot(mocker, default_conf)
     rpc = RPC(ftbot)
     telegram = Telegram(rpc, default_conf)
+    telegram._loop = MagicMock()
+    patch_eventloop_threading(telegram)
 
     return telegram, ftbot, msg_mock
 
 
 def test_telegram__init__(default_conf, mocker) -> None:
-    mocker.patch('freqtrade.rpc.telegram.Updater', MagicMock())
     mocker.patch('freqtrade.rpc.telegram.Telegram._init', MagicMock())
 
     telegram, _, _ = get_telegram_testobject(mocker, default_conf)
     assert telegram._config == default_conf
 
 
 def test_telegram_init(default_conf, mocker, caplog) -> None:
-    start_polling = MagicMock()
-    mocker.patch('freqtrade.rpc.telegram.Updater', MagicMock(return_value=start_polling))
+    app_mock = MagicMock()
+    mocker.patch('freqtrade.rpc.telegram.Telegram._start_thread', MagicMock())
+    mocker.patch('freqtrade.rpc.telegram.Telegram._init_telegram_app', return_value=app_mock)
+    mocker.patch('freqtrade.rpc.telegram.Telegram._startup_telegram', AsyncMock())
 
-    get_telegram_testobject(mocker, default_conf, mock=False)
-    assert start_polling.call_count == 0
+    telegram, _, _ = get_telegram_testobject(mocker, default_conf, mock=False)
+    telegram._init()
+    assert app_mock.call_count == 0
 
     # number of handles registered
-    assert start_polling.dispatcher.add_handler.call_count > 0
-    assert start_polling.start_polling.call_count == 1
+    assert app_mock.add_handler.call_count > 0
+    # assert start_polling.start_polling.call_count == 1
 
     message_str = ("rpc.telegram is listening for following commands: [['status'], ['profit'], "
                    "['balance'], ['start'], ['stop'], "
-                   "['forcesell', 'forceexit', 'fx'], ['forcebuy', 'forcelong'], ['forceshort'], "
-                   "['trades'], ['delete'], ['coo', 'cancel_open_order'], ['performance'], "
-                   "['buys', 'entries'], ['sells', 'exits'], ['mix_tags'], "
+                   "['forceexit', 'forcesell', 'fx'], ['forcebuy', 'forcelong'], ['forceshort'], "
+                   "['reload_trade'], ['trades'], ['delete'], ['cancel_open_order', 'coo'], "
+                   "['performance'], ['buys', 'entries'], ['exits', 'sells'], ['mix_tags'], "
                    "['stats'], ['daily'], ['weekly'], ['monthly'], "
-                   "['count'], ['locks'], ['unlock', 'delete_locks'], "
-                   "['reload_config', 'reload_conf'], ['show_config', 'show_conf'], "
+                   "['count'], ['locks'], ['delete_locks', 'unlock'], "
+                   "['reload_conf', 'reload_config'], ['show_conf', 'show_config'], "
                    "['stopbuy', 'stopentry'], ['whitelist'], ['blacklist'], "
-                   "['blacklist_delete', 'bl_delete'], "
+                   "['bl_delete', 'blacklist_delete'], "
                    "['logs'], ['edge'], ['health'], ['help'], ['version'], ['marketdir']"
                    "]")
 
     assert log_has(message_str, caplog)
 
 
-def test_cleanup(default_conf, mocker, ) -> None:
+async def test_telegram_startup(default_conf, mocker) -> None:
+    app_mock = MagicMock()
+    app_mock.initialize = AsyncMock()
+    app_mock.start = AsyncMock()
+    app_mock.updater.start_polling = AsyncMock()
+    app_mock.updater.running = False
+    sleep_mock = mocker.patch('freqtrade.rpc.telegram.asyncio.sleep', AsyncMock())
+
+    telegram, _, _ = get_telegram_testobject(mocker, default_conf)
+    telegram._app = app_mock
+    await telegram._startup_telegram()
+    assert app_mock.initialize.call_count == 1
+    assert app_mock.start.call_count == 1
+    assert app_mock.updater.start_polling.call_count == 1
+    assert sleep_mock.call_count == 1
+
+
+async def test_telegram_cleanup(default_conf, mocker, ) -> None:
+    app_mock = MagicMock()
+    app_mock.stop = AsyncMock()
+    app_mock.initialize = AsyncMock()
+
     updater_mock = MagicMock()
-    updater_mock.stop = MagicMock()
-    mocker.patch('freqtrade.rpc.telegram.Updater', updater_mock)
+    updater_mock.stop = AsyncMock()
+    app_mock.updater = updater_mock
+    # mocker.patch('freqtrade.rpc.telegram.Application', app_mock)
 
-    telegram, _, _ = get_telegram_testobject(mocker, default_conf, mock=False)
+    telegram, _, _ = get_telegram_testobject(mocker, default_conf)
+    telegram._app = app_mock
+    telegram._loop = asyncio.get_running_loop()
+    telegram._thread = MagicMock()
     telegram.cleanup()
-    assert telegram._updater.stop.call_count == 1
+    await asyncio.sleep(0.1)
+    assert app_mock.stop.call_count == 1
+    assert telegram._thread.join.call_count == 1
 
 
-def test_authorized_only(default_conf, mocker, caplog, update) -> None:
+async def test_authorized_only(default_conf, mocker, caplog, update) -> None:
     patch_exchange(mocker)
     caplog.set_level(logging.DEBUG)
     default_conf['telegram']['enabled'] = False
     bot = FreqtradeBot(default_conf)
     rpc = RPC(bot)
     dummy = DummyCls(rpc, default_conf)
 
     patch_get_signal(bot)
-    dummy.dummy_handler(update=update, context=MagicMock())
+    await dummy.dummy_handler(update=update, context=MagicMock())
     assert dummy.state['called'] is True
     assert log_has('Executing handler: dummy_handler for chat_id: 0', caplog)
     assert not log_has('Rejected unauthorized message from: 0', caplog)
     assert not log_has('Exception occurred within Telegram module', caplog)
 
 
-def test_authorized_only_unauthorized(default_conf, mocker, caplog) -> None:
+async def test_authorized_only_unauthorized(default_conf, mocker, caplog) -> None:
     patch_exchange(mocker)
     caplog.set_level(logging.DEBUG)
     chat = Chat(0xdeadbeef, 0)
-    update = Update(randint(1, 100))
-    update.message = Message(randint(1, 100), datetime.utcnow(), chat)
+    message = Message(randint(1, 100), datetime.now(timezone.utc), chat)
+    update = Update(randint(1, 100), message=message)
 
     default_conf['telegram']['enabled'] = False
     bot = FreqtradeBot(default_conf)
     rpc = RPC(bot)
     dummy = DummyCls(rpc, default_conf)
 
     patch_get_signal(bot)
-    dummy.dummy_handler(update=update, context=MagicMock())
+    await dummy.dummy_handler(update=update, context=MagicMock())
     assert dummy.state['called'] is False
     assert not log_has('Executing handler: dummy_handler for chat_id: 3735928559', caplog)
     assert log_has('Rejected unauthorized message from: 3735928559', caplog)
     assert not log_has('Exception occurred within Telegram module', caplog)
 
 
-def test_authorized_only_exception(default_conf, mocker, caplog, update) -> None:
+async def test_authorized_only_exception(default_conf, mocker, caplog, update) -> None:
     patch_exchange(mocker)
 
     default_conf['telegram']['enabled'] = False
 
     bot = FreqtradeBot(default_conf)
     rpc = RPC(bot)
     dummy = DummyCls(rpc, default_conf)
     patch_get_signal(bot)
 
-    dummy.dummy_exception(update=update, context=MagicMock())
+    await dummy.dummy_exception(update=update, context=MagicMock())
     assert dummy.state['called'] is False
     assert not log_has('Executing handler: dummy_handler for chat_id: 0', caplog)
     assert not log_has('Rejected unauthorized message from: 0', caplog)
     assert log_has('Exception occurred within Telegram module', caplog)
 
 
-def test_telegram_status(default_conf, update, mocker) -> None:
-    update.message.chat.id = "123"
+async def test_telegram_status(default_conf, update, mocker) -> None:
     default_conf['telegram']['enabled'] = False
-    default_conf['telegram']['chat_id'] = "123"
 
     status_table = MagicMock()
     mocker.patch('freqtrade.rpc.telegram.Telegram._status_table', status_table)
 
     mocker.patch.multiple(
         'freqtrade.rpc.rpc.RPC',
         _rpc_trade_status=MagicMock(return_value=[{
             'trade_id': 1,
             'pair': 'ETH/BTC',
             'base_currency': 'ETH',
             'quote_currency': 'BTC',
-            'open_date': arrow.utcnow(),
+            'open_date': dt_now(),
             'close_date': None,
             'open_rate': 1.099e-05,
             'close_rate': None,
             'current_rate': 1.098e-05,
             'amount': 90.99181074,
             'stake_amount': 90.99181074,
             'max_stake_amount': 90.99181074,
@@ -228,29 +288,27 @@
             'filled_entry_orders': [],
             'orders': []
         }]),
     )
 
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
 
-    telegram._status(update=update, context=MagicMock())
+    await telegram._status(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
 
     context = MagicMock()
     # /status table
     context.args = ["table"]
-    telegram._status(update=update, context=context)
+    await telegram._status(update=update, context=context)
     assert status_table.call_count == 1
 
 
 @pytest.mark.usefixtures("init_persistence")
-def test_telegram_status_multi_entry(default_conf, update, mocker, fee) -> None:
-    update.message.chat.id = "123"
+async def test_telegram_status_multi_entry(default_conf, update, mocker, fee) -> None:
     default_conf['telegram']['enabled'] = False
-    default_conf['telegram']['chat_id'] = "123"
     default_conf['position_adjustment_enable'] = True
     mocker.patch.multiple(
         EXMS,
         fetch_order=MagicMock(return_value=None),
         get_rate=MagicMock(return_value=0.22),
     )
 
@@ -280,51 +338,48 @@
         order_date=trade.open_date,
         order_filled_date=trade.open_date,
     )
     )
     trade.recalc_trade_from_orders()
     Trade.commit()
 
-    telegram._status(update=update, context=MagicMock())
+    await telegram._status(update=update, context=MagicMock())
     assert msg_mock.call_count == 4
     msg = msg_mock.call_args_list[0][0][0]
     assert re.search(r'Number of Entries.*2', msg)
     assert re.search(r'Number of Exits.*0', msg)
     assert re.search(r'Average Entry Price', msg)
     assert re.search(r'Order filled', msg)
     assert re.search(r'Close Date:', msg) is None
     assert re.search(r'Close Profit:', msg) is None
 
 
 @pytest.mark.usefixtures("init_persistence")
-def test_telegram_status_closed_trade(default_conf, update, mocker, fee) -> None:
-    update.message.chat.id = "123"
-    default_conf['telegram']['enabled'] = False
-    default_conf['telegram']['chat_id'] = "123"
+async def test_telegram_status_closed_trade(default_conf, update, mocker, fee) -> None:
     default_conf['position_adjustment_enable'] = True
     mocker.patch.multiple(
         EXMS,
         fetch_order=MagicMock(return_value=None),
         get_rate=MagicMock(return_value=0.22),
     )
 
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     create_mock_trades(fee)
     trade = Trade.get_trades([Trade.is_open.is_(False)]).first()
     context = MagicMock()
     context.args = [str(trade.id)]
-    telegram._status(update=update, context=context)
+    await telegram._status(update=update, context=context)
     assert msg_mock.call_count == 1
     msg = msg_mock.call_args_list[0][0][0]
     assert re.search(r'Close Date:', msg)
     assert re.search(r'Close Profit:', msg)
 
 
-def test_status_handle(default_conf, update, ticker, fee, mocker) -> None:
+async def test_status_handle(default_conf, update, ticker, fee, mocker) -> None:
     default_conf['max_open_trades'] = 3
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
         _dry_is_price_crossed=MagicMock(return_value=True),
     )
@@ -336,29 +391,29 @@
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     patch_get_signal(freqtradebot)
 
     freqtradebot.state = State.STOPPED
     # Status is also enabled when stopped
-    telegram._status(update=update, context=MagicMock())
+    await telegram._status(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'no active trade' in msg_mock.call_args_list[0][0][0]
     msg_mock.reset_mock()
 
     freqtradebot.state = State.RUNNING
-    telegram._status(update=update, context=MagicMock())
+    await telegram._status(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'no active trade' in msg_mock.call_args_list[0][0][0]
     msg_mock.reset_mock()
 
     # Create some test data
     freqtradebot.enter_positions()
     # Trigger status while we have a fulfilled order for the open trade
-    telegram._status(update=update, context=MagicMock())
+    await telegram._status(update=update, context=MagicMock())
 
     # close_rate should not be included in the message as the trade is not closed
     # and no line should be empty
     lines = msg_mock.call_args_list[0][0][0].split('\n')
     assert '' not in lines[:-1]
     assert 'Close Rate' not in ''.join(lines)
     assert 'Close Profit' not in ''.join(lines)
@@ -367,83 +422,83 @@
     assert 'ETH/BTC' in msg_mock.call_args_list[0][0][0]
     assert 'LTC/BTC' in msg_mock.call_args_list[1][0][0]
 
     msg_mock.reset_mock()
     context = MagicMock()
     context.args = ["2", "3"]
 
-    telegram._status(update=update, context=context)
+    await telegram._status(update=update, context=context)
 
     lines = msg_mock.call_args_list[0][0][0].split('\n')
     assert '' not in lines[:-1]
     assert 'Close Rate' not in ''.join(lines)
     assert 'Close Profit' not in ''.join(lines)
 
     assert msg_mock.call_count == 2
     assert 'LTC/BTC' in msg_mock.call_args_list[0][0][0]
 
     mocker.patch('freqtrade.rpc.telegram.MAX_MESSAGE_LENGTH', 500)
 
     msg_mock.reset_mock()
     context = MagicMock()
     context.args = ["2"]
-    telegram._status(update=update, context=context)
+    await telegram._status(update=update, context=context)
 
     assert msg_mock.call_count == 2
 
     msg1 = msg_mock.call_args_list[0][0][0]
     msg2 = msg_mock.call_args_list[1][0][0]
 
     assert 'Close Rate' not in msg1
     assert 'Trade ID:* `2`' in msg1
     assert 'Trade ID:* `2` - continued' in msg2
 
 
-def test_status_table_handle(default_conf, update, ticker, fee, mocker) -> None:
+async def test_status_table_handle(default_conf, update, ticker, fee, mocker) -> None:
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
     )
 
     default_conf['stake_amount'] = 15.0
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     patch_get_signal(freqtradebot)
 
     freqtradebot.state = State.STOPPED
     # Status table is also enabled when stopped
-    telegram._status_table(update=update, context=MagicMock())
+    await telegram._status_table(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'no active trade' in msg_mock.call_args_list[0][0][0]
     msg_mock.reset_mock()
 
     freqtradebot.state = State.RUNNING
-    telegram._status_table(update=update, context=MagicMock())
+    await telegram._status_table(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'no active trade' in msg_mock.call_args_list[0][0][0]
     msg_mock.reset_mock()
 
     # Create some test data
     freqtradebot.enter_positions()
 
-    telegram._status_table(update=update, context=MagicMock())
+    await telegram._status_table(update=update, context=MagicMock())
 
     text = re.sub('</?pre>', '', msg_mock.call_args_list[-1][0][0])
     line = text.split("\n")
     fields = re.sub('[ ]+', ' ', line[2].strip()).split(' ')
 
     assert int(fields[0]) == 1
     # assert 'L' in fields[1]
     assert 'ETH/BTC' in fields[1]
     assert msg_mock.call_count == 1
 
 
-def test_daily_handle(default_conf_usdt, update, ticker, fee, mocker, time_machine) -> None:
+async def test_daily_handle(default_conf_usdt, update, ticker, fee, mocker, time_machine) -> None:
     mocker.patch(
         'freqtrade.rpc.rpc.CryptoToFiatConverter._find_price',
         return_value=1.1
     )
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
@@ -457,81 +512,82 @@
     # Create some test data
     create_mock_trades_usdt(fee)
 
     # Try valid data
     # /daily 2
     context = MagicMock()
     context.args = ["2"]
-    telegram._daily(update=update, context=context)
+    await telegram._daily(update=update, context=context)
     assert msg_mock.call_count == 1
     assert "Daily Profit over the last 2 days</b>:" in msg_mock.call_args_list[0][0][0]
     assert 'Day ' in msg_mock.call_args_list[0][0][0]
-    assert str(datetime.utcnow().date()) in msg_mock.call_args_list[0][0][0]
+    assert str(datetime.now(timezone.utc).date()) in msg_mock.call_args_list[0][0][0]
     assert '  6.83 USDT' in msg_mock.call_args_list[0][0][0]
     assert '  7.51 USD' in msg_mock.call_args_list[0][0][0]
     assert '(2)' in msg_mock.call_args_list[0][0][0]
     assert '(2)  6.83 USDT  7.51 USD  0.64%' in msg_mock.call_args_list[0][0][0]
     assert '(0)' in msg_mock.call_args_list[0][0][0]
 
     # Reset msg_mock
     msg_mock.reset_mock()
     context.args = []
-    telegram._daily(update=update, context=context)
+    await telegram._daily(update=update, context=context)
     assert msg_mock.call_count == 1
     assert "Daily Profit over the last 7 days</b>:" in msg_mock.call_args_list[0][0][0]
-    assert str(datetime.utcnow().date()) in msg_mock.call_args_list[0][0][0]
-    assert str((datetime.utcnow() - timedelta(days=5)).date()) in msg_mock.call_args_list[0][0][0]
+    assert str(datetime.now(timezone.utc).date()) in msg_mock.call_args_list[0][0][0]
+    assert str((datetime.now(timezone.utc) - timedelta(days=5)).date()
+               ) in msg_mock.call_args_list[0][0][0]
     assert '  6.83 USDT' in msg_mock.call_args_list[0][0][0]
     assert '  7.51 USD' in msg_mock.call_args_list[0][0][0]
     assert '(2)' in msg_mock.call_args_list[0][0][0]
     assert '(1)' in msg_mock.call_args_list[0][0][0]
     assert '(0)' in msg_mock.call_args_list[0][0][0]
 
     # Reset msg_mock
     msg_mock.reset_mock()
 
     # /daily 1
     context = MagicMock()
     context.args = ["1"]
-    telegram._daily(update=update, context=context)
+    await telegram._daily(update=update, context=context)
     assert '  6.83 USDT' in msg_mock.call_args_list[0][0][0]
     assert '  7.51 USD' in msg_mock.call_args_list[0][0][0]
     assert '(2)' in msg_mock.call_args_list[0][0][0]
 
 
-def test_daily_wrong_input(default_conf, update, ticker, mocker) -> None:
+async def test_daily_wrong_input(default_conf, update, ticker, mocker) -> None:
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker
     )
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
     # Try invalid data
     msg_mock.reset_mock()
     freqtradebot.state = State.RUNNING
     # /daily -2
     context = MagicMock()
     context.args = ["-2"]
-    telegram._daily(update=update, context=context)
+    await telegram._daily(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'must be an integer greater than 0' in msg_mock.call_args_list[0][0][0]
 
     # Try invalid data
     msg_mock.reset_mock()
     freqtradebot.state = State.RUNNING
     # /daily today
     context = MagicMock()
     context.args = ["today"]
-    telegram._daily(update=update, context=context)
+    await telegram._daily(update=update, context=context)
     assert 'Daily Profit over the last 7 days</b>:' in msg_mock.call_args_list[0][0][0]
 
 
-def test_weekly_handle(default_conf_usdt, update, ticker, fee, mocker, time_machine) -> None:
+async def test_weekly_handle(default_conf_usdt, update, ticker, fee, mocker, time_machine) -> None:
     default_conf_usdt['max_open_trades'] = 1
     mocker.patch(
         'freqtrade.rpc.rpc.CryptoToFiatConverter._find_price',
         return_value=1.1
     )
     mocker.patch.multiple(
         EXMS,
@@ -544,31 +600,31 @@
     time_machine.move_to('2022-06-11')
     create_mock_trades_usdt(fee)
 
     # Try valid data
     # /weekly 2
     context = MagicMock()
     context.args = ["2"]
-    telegram._weekly(update=update, context=context)
+    await telegram._weekly(update=update, context=context)
     assert msg_mock.call_count == 1
     assert "Weekly Profit over the last 2 weeks (starting from Monday)</b>:" \
            in msg_mock.call_args_list[0][0][0]
     assert 'Monday ' in msg_mock.call_args_list[0][0][0]
-    today = datetime.utcnow().date()
+    today = datetime.now(timezone.utc).date()
     first_iso_day_of_current_week = today - timedelta(days=today.weekday())
     assert str(first_iso_day_of_current_week) in msg_mock.call_args_list[0][0][0]
     assert '  2.74 USDT' in msg_mock.call_args_list[0][0][0]
     assert '  3.01 USD' in msg_mock.call_args_list[0][0][0]
     assert '(3)' in msg_mock.call_args_list[0][0][0]
     assert '(0)' in msg_mock.call_args_list[0][0][0]
 
     # Reset msg_mock
     msg_mock.reset_mock()
     context.args = []
-    telegram._weekly(update=update, context=context)
+    await telegram._weekly(update=update, context=context)
     assert msg_mock.call_count == 1
     assert "Weekly Profit over the last 8 weeks (starting from Monday)</b>:" \
            in msg_mock.call_args_list[0][0][0]
     assert 'Weekly' in msg_mock.call_args_list[0][0][0]
     assert '  2.74 USDT' in msg_mock.call_args_list[0][0][0]
     assert '  3.01 USD' in msg_mock.call_args_list[0][0][0]
     assert '(3)' in msg_mock.call_args_list[0][0][0]
@@ -576,32 +632,32 @@
 
     # Try invalid data
     msg_mock.reset_mock()
     freqtradebot.state = State.RUNNING
     # /weekly -3
     context = MagicMock()
     context.args = ["-3"]
-    telegram._weekly(update=update, context=context)
+    await telegram._weekly(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'must be an integer greater than 0' in msg_mock.call_args_list[0][0][0]
 
     # Try invalid data
     msg_mock.reset_mock()
     freqtradebot.state = State.RUNNING
     # /weekly this week
     context = MagicMock()
     context.args = ["this week"]
-    telegram._weekly(update=update, context=context)
+    await telegram._weekly(update=update, context=context)
     assert (
         'Weekly Profit over the last 8 weeks (starting from Monday)</b>:'
         in msg_mock.call_args_list[0][0][0]
     )
 
 
-def test_monthly_handle(default_conf_usdt, update, ticker, fee, mocker, time_machine) -> None:
+async def test_monthly_handle(default_conf_usdt, update, ticker, fee, mocker, time_machine) -> None:
     default_conf_usdt['max_open_trades'] = 1
     mocker.patch(
         'freqtrade.rpc.rpc.CryptoToFiatConverter._find_price',
         return_value=1.1
     )
     mocker.patch.multiple(
         EXMS,
@@ -614,30 +670,30 @@
     time_machine.move_to('2022-06-11')
     create_mock_trades_usdt(fee)
 
     # Try valid data
     # /monthly 2
     context = MagicMock()
     context.args = ["2"]
-    telegram._monthly(update=update, context=context)
+    await telegram._monthly(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'Monthly Profit over the last 2 months</b>:' in msg_mock.call_args_list[0][0][0]
     assert 'Month ' in msg_mock.call_args_list[0][0][0]
-    today = datetime.utcnow().date()
+    today = datetime.now(timezone.utc).date()
     current_month = f"{today.year}-{today.month:02} "
     assert current_month in msg_mock.call_args_list[0][0][0]
     assert '  2.74 USDT' in msg_mock.call_args_list[0][0][0]
     assert '  3.01 USD' in msg_mock.call_args_list[0][0][0]
     assert '(3)' in msg_mock.call_args_list[0][0][0]
     assert '(0)' in msg_mock.call_args_list[0][0][0]
 
     # Reset msg_mock
     msg_mock.reset_mock()
     context.args = []
-    telegram._monthly(update=update, context=context)
+    await telegram._monthly(update=update, context=context)
     assert msg_mock.call_count == 1
     # Default to 6 months
     assert 'Monthly Profit over the last 6 months</b>:' in msg_mock.call_args_list[0][0][0]
     assert 'Month ' in msg_mock.call_args_list[0][0][0]
     assert current_month in msg_mock.call_args_list[0][0][0]
     assert '  2.74 USDT' in msg_mock.call_args_list[0][0][0]
     assert '  3.01 USD' in msg_mock.call_args_list[0][0][0]
@@ -646,15 +702,15 @@
 
     # Reset msg_mock
     msg_mock.reset_mock()
 
     # /monthly 12
     context = MagicMock()
     context.args = ["12"]
-    telegram._monthly(update=update, context=context)
+    await telegram._monthly(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'Monthly Profit over the last 12 months</b>:' in msg_mock.call_args_list[0][0][0]
     assert '  2.74 USDT' in msg_mock.call_args_list[0][0][0]
     assert '  3.01 USD' in msg_mock.call_args_list[0][0][0]
     assert '(3)' in msg_mock.call_args_list[0][0][0]
 
     # The one-digit months should contain a zero, Eg: September 2021 = "2021-09"
@@ -663,54 +719,54 @@
 
     # Try invalid data
     msg_mock.reset_mock()
     freqtradebot.state = State.RUNNING
     # /monthly -3
     context = MagicMock()
     context.args = ["-3"]
-    telegram._monthly(update=update, context=context)
+    await telegram._monthly(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'must be an integer greater than 0' in msg_mock.call_args_list[0][0][0]
 
     # Try invalid data
     msg_mock.reset_mock()
     freqtradebot.state = State.RUNNING
     # /monthly february
     context = MagicMock()
     context.args = ["february"]
-    telegram._monthly(update=update, context=context)
+    await telegram._monthly(update=update, context=context)
     assert 'Monthly Profit over the last 6 months</b>:' in msg_mock.call_args_list[0][0][0]
 
 
-def test_telegram_profit_handle(
+async def test_telegram_profit_handle(
         default_conf_usdt, update, ticker_usdt, ticker_sell_up, fee,
         limit_sell_order_usdt, mocker) -> None:
     mocker.patch('freqtrade.rpc.rpc.CryptoToFiatConverter._find_price', return_value=1.1)
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker_usdt,
         get_fee=fee,
     )
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf_usdt)
     patch_get_signal(freqtradebot)
 
-    telegram._profit(update=update, context=MagicMock())
+    await telegram._profit(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'No trades yet.' in msg_mock.call_args_list[0][0][0]
     msg_mock.reset_mock()
 
     # Create some test data
     freqtradebot.enter_positions()
     trade = Trade.session.scalars(select(Trade)).first()
 
     context = MagicMock()
     # Test with invalid 2nd argument (should silently pass)
     context.args = ["aaa"]
-    telegram._profit(update=update, context=context)
+    await telegram._profit(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'No closed trade' in msg_mock.call_args_list[-1][0][0]
     assert '*ROI:* All trades' in msg_mock.call_args_list[-1][0][0]
     mocker.patch('freqtrade.wallets.Wallets.get_starting_balance', return_value=1000)
     assert ('∙ `0.298 USDT (0.50%) (0.03 \N{GREEK CAPITAL LETTER SIGMA}%)`'
             in msg_mock.call_args_list[-1][0][0])
     msg_mock.reset_mock()
@@ -725,15 +781,15 @@
     trade.update_trade(oobj)
 
     trade.close_date = datetime.now(timezone.utc)
     trade.is_open = False
     Trade.commit()
 
     context.args = [3]
-    telegram._profit(update=update, context=context)
+    await telegram._profit(update=update, context=context)
     assert msg_mock.call_count == 1
     assert '*ROI:* Closed trades' in msg_mock.call_args_list[-1][0][0]
     assert ('∙ `5.685 USDT (9.45%) (0.57 \N{GREEK CAPITAL LETTER SIGMA}%)`'
             in msg_mock.call_args_list[-1][0][0])
     assert '∙ `6.253 USD`' in msg_mock.call_args_list[-1][0][0]
     assert '*ROI:* All trades' in msg_mock.call_args_list[-1][0][0]
     assert ('∙ `5.685 USDT (9.45%) (0.57 \N{GREEK CAPITAL LETTER SIGMA}%)`'
@@ -743,202 +799,219 @@
     assert '*Best Performing:* `ETH/USDT: 9.45%`' in msg_mock.call_args_list[-1][0][0]
     assert '*Max Drawdown:*' in msg_mock.call_args_list[-1][0][0]
     assert '*Profit factor:*' in msg_mock.call_args_list[-1][0][0]
     assert '*Trading volume:* `126 USDT`' in msg_mock.call_args_list[-1][0][0]
 
 
 @pytest.mark.parametrize('is_short', [True, False])
-def test_telegram_stats(default_conf, update, ticker, fee, mocker, is_short) -> None:
+async def test_telegram_stats(default_conf, update, ticker, fee, mocker, is_short) -> None:
     mocker.patch('freqtrade.rpc.rpc.CryptoToFiatConverter._find_price', return_value=15000.0)
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
     )
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
-    telegram._stats(update=update, context=MagicMock())
+    await telegram._stats(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'No trades yet.' in msg_mock.call_args_list[0][0][0]
     msg_mock.reset_mock()
 
     # Create some test data
     create_mock_trades(fee, is_short=is_short)
 
-    telegram._stats(update=update, context=MagicMock())
+    await telegram._stats(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'Exit Reason' in msg_mock.call_args_list[-1][0][0]
     assert 'ROI' in msg_mock.call_args_list[-1][0][0]
     assert 'Avg. Duration' in msg_mock.call_args_list[-1][0][0]
+    # Duration is not only N/A
+    assert '0:19:00' in msg_mock.call_args_list[-1][0][0]
+    assert 'N/A' in msg_mock.call_args_list[-1][0][0]
     msg_mock.reset_mock()
 
 
-def test_telegram_balance_handle(default_conf, update, mocker, rpc_balance, tickers) -> None:
+async def test_telegram_balance_handle(default_conf, update, mocker, rpc_balance, tickers) -> None:
     default_conf['dry_run'] = False
     mocker.patch(f'{EXMS}.get_balances', return_value=rpc_balance)
     mocker.patch(f'{EXMS}.get_tickers', tickers)
     mocker.patch(f'{EXMS}.get_valid_pair_combination', side_effect=lambda a, b: f"{a}/{b}")
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
-    telegram._balance(update=update, context=MagicMock())
+    await telegram._balance(update=update, context=MagicMock())
+    context = MagicMock()
+    context.args = ["full"]
+    await telegram._balance(update=update, context=context)
     result = msg_mock.call_args_list[0][0][0]
-    assert msg_mock.call_count == 1
+    result_full = msg_mock.call_args_list[1][0][0]
+    assert msg_mock.call_count == 2
     assert '*BTC:*' in result
     assert '*ETH:*' not in result
     assert '*USDT:*' not in result
     assert '*EUR:*' not in result
-    assert '*LTC:*' in result
+    assert '*LTC:*' not in result
+
+    assert '*LTC:*' in result_full
     assert '*XRP:*' not in result
     assert 'Balance:' in result
     assert 'Est. BTC:' in result
-    assert 'BTC: 12' in result
+    assert 'BTC: 11' in result
+    assert 'BTC: 12' in result_full
     assert "*3 Other Currencies (< 0.0001 BTC):*" in result
     assert 'BTC: 0.00000309' in result
+    assert '*Estimated Value*:' in result_full
+    assert '*Estimated Value (Bot managed assets only)*:' in result
 
 
-def test_balance_handle_empty_response(default_conf, update, mocker) -> None:
+async def test_balance_handle_empty_response(default_conf, update, mocker) -> None:
     default_conf['dry_run'] = False
     mocker.patch(f'{EXMS}.get_balances', return_value={})
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
     freqtradebot.config['dry_run'] = False
-    telegram._balance(update=update, context=MagicMock())
+    await telegram._balance(update=update, context=MagicMock())
     result = msg_mock.call_args_list[0][0][0]
     assert msg_mock.call_count == 1
     assert 'Starting capital: `0 BTC' in result
 
 
-def test_balance_handle_empty_response_dry(default_conf, update, mocker) -> None:
+async def test_balance_handle_empty_response_dry(default_conf, update, mocker) -> None:
     mocker.patch(f'{EXMS}.get_balances', return_value={})
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
-    telegram._balance(update=update, context=MagicMock())
+    await telegram._balance(update=update, context=MagicMock())
     result = msg_mock.call_args_list[0][0][0]
     assert msg_mock.call_count == 1
     assert "*Warning:* Simulated balances in Dry Mode." in result
     assert "Starting capital: `1000 BTC`" in result
 
 
-def test_balance_handle_too_large_response(default_conf, update, mocker) -> None:
+async def test_balance_handle_too_large_response(default_conf, update, mocker) -> None:
     balances = []
     for i in range(100):
         curr = choice(ascii_uppercase) + choice(ascii_uppercase) + choice(ascii_uppercase)
         balances.append({
             'currency': curr,
             'free': 1.0,
             'used': 0.5,
             'balance': i,
+            'bot_owned': 0.5,
             'est_stake': 1,
+            'est_stake_bot': 1,
             'stake': 'BTC',
             'is_position': False,
             'leverage': 1.0,
             'position': 0.0,
             'side': 'long',
+            'is_bot_managed': True,
         })
     mocker.patch('freqtrade.rpc.rpc.RPC._rpc_balance', return_value={
         'currencies': balances,
         'total': 100.0,
+        'total_bot': 100.0,
         'symbol': 100.0,
         'value': 1000.0,
+        'value_bot': 1000.0,
         'starting_capital': 1000,
         'starting_capital_fiat': 1000,
     })
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
-    telegram._balance(update=update, context=MagicMock())
+    await telegram._balance(update=update, context=MagicMock())
     assert msg_mock.call_count > 1
     # Test if wrap happens around 4000 -
     # and each single currency-output is around 120 characters long so we need
     # an offset to avoid random test failures
     assert len(msg_mock.call_args_list[0][0][0]) < 4096
     assert len(msg_mock.call_args_list[0][0][0]) > (4096 - 120)
 
 
-def test_start_handle(default_conf, update, mocker) -> None:
+async def test_start_handle(default_conf, update, mocker) -> None:
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     freqtradebot.state = State.STOPPED
     assert freqtradebot.state == State.STOPPED
-    telegram._start(update=update, context=MagicMock())
+    await telegram._start(update=update, context=MagicMock())
     assert freqtradebot.state == State.RUNNING
     assert msg_mock.call_count == 1
 
 
-def test_start_handle_already_running(default_conf, update, mocker) -> None:
+async def test_start_handle_already_running(default_conf, update, mocker) -> None:
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     freqtradebot.state = State.RUNNING
     assert freqtradebot.state == State.RUNNING
-    telegram._start(update=update, context=MagicMock())
+    await telegram._start(update=update, context=MagicMock())
     assert freqtradebot.state == State.RUNNING
     assert msg_mock.call_count == 1
     assert 'already running' in msg_mock.call_args_list[0][0][0]
 
 
-def test_stop_handle(default_conf, update, mocker) -> None:
+async def test_stop_handle(default_conf, update, mocker) -> None:
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     freqtradebot.state = State.RUNNING
     assert freqtradebot.state == State.RUNNING
-    telegram._stop(update=update, context=MagicMock())
+    await telegram._stop(update=update, context=MagicMock())
     assert freqtradebot.state == State.STOPPED
     assert msg_mock.call_count == 1
     assert 'stopping trader' in msg_mock.call_args_list[0][0][0]
 
 
-def test_stop_handle_already_stopped(default_conf, update, mocker) -> None:
+async def test_stop_handle_already_stopped(default_conf, update, mocker) -> None:
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     freqtradebot.state = State.STOPPED
     assert freqtradebot.state == State.STOPPED
-    telegram._stop(update=update, context=MagicMock())
+    await telegram._stop(update=update, context=MagicMock())
     assert freqtradebot.state == State.STOPPED
     assert msg_mock.call_count == 1
     assert 'already stopped' in msg_mock.call_args_list[0][0][0]
 
 
-def test_stopbuy_handle(default_conf, update, mocker) -> None:
+async def test_stopbuy_handle(default_conf, update, mocker) -> None:
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     assert freqtradebot.config['max_open_trades'] != 0
-    telegram._stopentry(update=update, context=MagicMock())
+    await telegram._stopentry(update=update, context=MagicMock())
     assert freqtradebot.config['max_open_trades'] == 0
     assert msg_mock.call_count == 1
     assert 'No more entries will occur from now. Run /reload_config to reset.' \
         in msg_mock.call_args_list[0][0][0]
 
 
-def test_reload_config_handle(default_conf, update, mocker) -> None:
+async def test_reload_config_handle(default_conf, update, mocker) -> None:
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     freqtradebot.state = State.RUNNING
     assert freqtradebot.state == State.RUNNING
-    telegram._reload_config(update=update, context=MagicMock())
+    await telegram._reload_config(update=update, context=MagicMock())
     assert freqtradebot.state == State.RELOAD_CONFIG
     assert msg_mock.call_count == 1
     assert 'Reloading config' in msg_mock.call_args_list[0][0][0]
 
 
-def test_telegram_forceexit_handle(default_conf, update, ticker, fee,
-                                   ticker_sell_up, mocker) -> None:
+async def test_telegram_forceexit_handle(default_conf, update, ticker, fee,
+                                         ticker_sell_up, mocker) -> None:
     mocker.patch('freqtrade.rpc.rpc.CryptoToFiatConverter._find_price', return_value=15000.0)
     msg_mock = mocker.patch('freqtrade.rpc.telegram.Telegram.send_msg', MagicMock())
     mocker.patch('freqtrade.rpc.telegram.Telegram._init', MagicMock())
     patch_exchange(mocker)
     patch_whitelist(mocker, default_conf)
     mocker.patch.multiple(
         EXMS,
@@ -960,15 +1033,15 @@
 
     # Increase the price and sell it
     mocker.patch(f'{EXMS}.fetch_ticker', ticker_sell_up)
 
     # /forceexit 1
     context = MagicMock()
     context.args = ["1"]
-    telegram._force_exit(update=update, context=context)
+    await telegram._force_exit(update=update, context=context)
 
     assert msg_mock.call_count == 4
     last_msg = msg_mock.call_args_list[-2][0][0]
     assert {
         'type': RPCMessageType.EXIT,
         'trade_id': 1,
         'exchange': 'Binance',
@@ -996,16 +1069,16 @@
         'close_rate': ANY,
         'stake_amount': 0.0009999999999054,
         'sub_trade': False,
         'cumulative_profit': 0.0,
     } == last_msg
 
 
-def test_telegram_force_exit_down_handle(default_conf, update, ticker, fee,
-                                         ticker_sell_down, mocker) -> None:
+async def test_telegram_force_exit_down_handle(default_conf, update, ticker, fee,
+                                               ticker_sell_down, mocker) -> None:
     mocker.patch('freqtrade.rpc.fiat_convert.CryptoToFiatConverter._find_price',
                  return_value=15000.0)
     msg_mock = mocker.patch('freqtrade.rpc.telegram.Telegram.send_msg', MagicMock())
     mocker.patch('freqtrade.rpc.telegram.Telegram._init', MagicMock())
     patch_exchange(mocker)
     patch_whitelist(mocker, default_conf)
 
@@ -1032,15 +1105,15 @@
 
     trade = Trade.session.scalars(select(Trade)).first()
     assert trade
 
     # /forceexit 1
     context = MagicMock()
     context.args = ["1"]
-    telegram._force_exit(update=update, context=context)
+    await telegram._force_exit(update=update, context=context)
 
     assert msg_mock.call_count == 4
 
     last_msg = msg_mock.call_args_list[-2][0][0]
     assert {
         'type': RPCMessageType.EXIT,
         'trade_id': 1,
@@ -1069,15 +1142,15 @@
         'close_rate': ANY,
         'stake_amount': 0.0009999999999054,
         'sub_trade': False,
         'cumulative_profit': 0.0,
     } == last_msg
 
 
-def test_forceexit_all_handle(default_conf, update, ticker, fee, mocker) -> None:
+async def test_forceexit_all_handle(default_conf, update, ticker, fee, mocker) -> None:
     patch_exchange(mocker)
     mocker.patch('freqtrade.rpc.fiat_convert.CryptoToFiatConverter._find_price',
                  return_value=15000.0)
     msg_mock = mocker.patch('freqtrade.rpc.telegram.Telegram.send_msg', MagicMock())
     mocker.patch('freqtrade.rpc.telegram.Telegram._init', MagicMock())
     patch_whitelist(mocker, default_conf)
     mocker.patch.multiple(
@@ -1095,15 +1168,15 @@
     # Create some test data
     freqtradebot.enter_positions()
     msg_mock.reset_mock()
 
     # /forceexit all
     context = MagicMock()
     context.args = ["all"]
-    telegram._force_exit(update=update, context=context)
+    await telegram._force_exit(update=update, context=context)
 
     # Called for each trade 2 times
     assert msg_mock.call_count == 8
     msg = msg_mock.call_args_list[0][0][0]
     assert {
         'type': RPCMessageType.EXIT,
         'trade_id': 1,
@@ -1132,42 +1205,42 @@
         'close_rate': ANY,
         'stake_amount': 0.0009999999999054,
         'sub_trade': False,
         'cumulative_profit': 0.0,
     } == msg
 
 
-def test_forceexit_handle_invalid(default_conf, update, mocker) -> None:
+async def test_forceexit_handle_invalid(default_conf, update, mocker) -> None:
     mocker.patch('freqtrade.rpc.fiat_convert.CryptoToFiatConverter._find_price',
                  return_value=15000.0)
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
     # Trader is not running
     freqtradebot.state = State.STOPPED
     # /forceexit 1
     context = MagicMock()
     context.args = ["1"]
-    telegram._force_exit(update=update, context=context)
+    await telegram._force_exit(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'not running' in msg_mock.call_args_list[0][0][0]
 
     # Invalid argument
     msg_mock.reset_mock()
     freqtradebot.state = State.RUNNING
     # /forceexit 123456
     context = MagicMock()
     context.args = ["123456"]
-    telegram._force_exit(update=update, context=context)
+    await telegram._force_exit(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'invalid argument' in msg_mock.call_args_list[0][0][0]
 
 
-def test_force_exit_no_pair(default_conf, update, ticker, fee, mocker) -> None:
+async def test_force_exit_no_pair(default_conf, update, ticker, fee, mocker) -> None:
     default_conf['max_open_trades'] = 4
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
         _dry_is_price_crossed=MagicMock(return_value=True),
     )
@@ -1175,601 +1248,619 @@
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     patch_get_signal(freqtradebot)
 
     # /forceexit
     context = MagicMock()
     context.args = []
-    telegram._force_exit(update=update, context=context)
+    await telegram._force_exit(update=update, context=context)
     # No pair
     assert msg_mock.call_args_list[0][1]['msg'] == 'No open trade found.'
 
     # Create some test data
     freqtradebot.enter_positions()
     msg_mock.reset_mock()
 
     # /forceexit
-    telegram._force_exit(update=update, context=context)
+    await telegram._force_exit(update=update, context=context)
     keyboard = msg_mock.call_args_list[0][1]['keyboard']
     # 4 pairs + cancel
     assert reduce(lambda acc, x: acc + len(x), keyboard, 0) == 5
     assert keyboard[-1][0].text == "Cancel"
 
     assert keyboard[1][0].callback_data == 'force_exit__2 '
     update = MagicMock()
-    update.callback_query = MagicMock()
+    update.callback_query = AsyncMock()
     update.callback_query.data = keyboard[1][0].callback_data
-    telegram._force_exit_inline(update, None)
+    await telegram._force_exit_inline(update, None)
     assert update.callback_query.answer.call_count == 1
     assert update.callback_query.edit_message_text.call_count == 1
     assert femock.call_count == 1
     assert femock.call_args_list[0][0][0] == '2'
 
     # Retry exiting - but cancel instead
     update.callback_query.reset_mock()
-    telegram._force_exit(update=update, context=context)
+    await telegram._force_exit(update=update, context=context)
     # Use cancel button
     update.callback_query.data = keyboard[-1][0].callback_data
-    telegram._force_exit_inline(update, None)
+    await telegram._force_exit_inline(update, None)
     query = update.callback_query
     assert query.answer.call_count == 1
     assert query.edit_message_text.call_count == 1
     assert query.edit_message_text.call_args_list[-1][1]['text'] == "Force exit canceled."
 
 
-def test_force_enter_handle(default_conf, update, mocker) -> None:
+async def test_force_enter_handle(default_conf, update, mocker) -> None:
     mocker.patch('freqtrade.rpc.rpc.CryptoToFiatConverter._find_price', return_value=15000.0)
 
     fbuy_mock = MagicMock(return_value=None)
     mocker.patch('freqtrade.rpc.rpc.RPC._rpc_force_entry', fbuy_mock)
 
     telegram, freqtradebot, _ = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
     # /forcelong ETH/BTC
     context = MagicMock()
     context.args = ["ETH/BTC"]
-    telegram._force_enter(update=update, context=context, order_side=SignalDirection.LONG)
+    await telegram._force_enter(update=update, context=context, order_side=SignalDirection.LONG)
 
     assert fbuy_mock.call_count == 1
     assert fbuy_mock.call_args_list[0][0][0] == 'ETH/BTC'
     assert fbuy_mock.call_args_list[0][0][1] is None
     assert fbuy_mock.call_args_list[0][1]['order_side'] == SignalDirection.LONG
 
     # Reset and retry with specified price
     fbuy_mock = MagicMock(return_value=None)
     mocker.patch('freqtrade.rpc.rpc.RPC._rpc_force_entry', fbuy_mock)
     # /forcelong ETH/BTC 0.055
     context = MagicMock()
     context.args = ["ETH/BTC", "0.055"]
-    telegram._force_enter(update=update, context=context, order_side=SignalDirection.LONG)
+    await telegram._force_enter(update=update, context=context, order_side=SignalDirection.LONG)
 
     assert fbuy_mock.call_count == 1
     assert fbuy_mock.call_args_list[0][0][0] == 'ETH/BTC'
     assert isinstance(fbuy_mock.call_args_list[0][0][1], float)
     assert fbuy_mock.call_args_list[0][0][1] == 0.055
 
 
-def test_force_enter_handle_exception(default_conf, update, mocker) -> None:
+async def test_force_enter_handle_exception(default_conf, update, mocker) -> None:
     mocker.patch('freqtrade.rpc.rpc.CryptoToFiatConverter._find_price', return_value=15000.0)
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
-    update.message.text = '/forcebuy ETH/Nonepair'
-    telegram._force_enter(update=update, context=MagicMock(), order_side=SignalDirection.LONG)
+    await telegram._force_enter(update=update, context=MagicMock(), order_side=SignalDirection.LONG)
 
     assert msg_mock.call_count == 1
     assert msg_mock.call_args_list[0][0][0] == 'Force_entry not enabled.'
 
 
-def test_force_enter_no_pair(default_conf, update, mocker) -> None:
+async def test_force_enter_no_pair(default_conf, update, mocker) -> None:
     mocker.patch('freqtrade.rpc.rpc.CryptoToFiatConverter._find_price', return_value=15000.0)
 
     fbuy_mock = MagicMock(return_value=None)
     mocker.patch('freqtrade.rpc.rpc.RPC._rpc_force_entry', fbuy_mock)
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     patch_get_signal(freqtradebot)
 
     context = MagicMock()
     context.args = []
-    telegram._force_enter(update=update, context=context, order_side=SignalDirection.LONG)
+    await telegram._force_enter(update=update, context=context, order_side=SignalDirection.LONG)
 
     assert fbuy_mock.call_count == 0
     assert msg_mock.call_count == 1
     assert msg_mock.call_args_list[0][1]['msg'] == 'Which pair?'
     # assert msg_mock.call_args_list[0][1]['callback_query_handler'] == 'forcebuy'
     keyboard = msg_mock.call_args_list[0][1]['keyboard']
     # One additional button - cancel
     assert reduce(lambda acc, x: acc + len(x), keyboard, 0) == 5
     update = MagicMock()
-    update.callback_query = MagicMock()
+    update.callback_query = AsyncMock()
     update.callback_query.data = 'XRP/USDT_||_long'
-    telegram._force_enter_inline(update, None)
+    await telegram._force_enter_inline(update, None)
     assert fbuy_mock.call_count == 1
 
 
-def test_telegram_performance_handle(default_conf_usdt, update, ticker, fee, mocker) -> None:
+async def test_telegram_performance_handle(default_conf_usdt, update, ticker, fee, mocker) -> None:
 
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
     )
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf_usdt)
 
     # Create some test data
     create_mock_trades_usdt(fee)
 
-    telegram._performance(update=update, context=MagicMock())
+    await telegram._performance(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'Performance' in msg_mock.call_args_list[0][0][0]
     assert '<code>XRP/USDT\t2.842 USDT (10.00%) (1)</code>' in msg_mock.call_args_list[0][0][0]
 
 
-def test_telegram_entry_tag_performance_handle(
+async def test_telegram_entry_tag_performance_handle(
         default_conf_usdt, update, ticker, fee, mocker) -> None:
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
     )
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf_usdt)
     patch_get_signal(freqtradebot)
 
     create_mock_trades_usdt(fee)
 
     context = MagicMock()
-    telegram._enter_tag_performance(update=update, context=context)
+    await telegram._enter_tag_performance(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'Entry Tag Performance' in msg_mock.call_args_list[0][0][0]
     assert '<code>TEST1\t3.987 USDT (5.00%) (1)</code>' in msg_mock.call_args_list[0][0][0]
 
     context.args = ['XRP/USDT']
-    telegram._enter_tag_performance(update=update, context=context)
+    await telegram._enter_tag_performance(update=update, context=context)
     assert msg_mock.call_count == 2
 
     msg_mock.reset_mock()
     mocker.patch('freqtrade.rpc.rpc.RPC._rpc_enter_tag_performance',
                  side_effect=RPCException('Error'))
-    telegram._enter_tag_performance(update=update, context=MagicMock())
+    await telegram._enter_tag_performance(update=update, context=MagicMock())
 
     assert msg_mock.call_count == 1
     assert "Error" in msg_mock.call_args_list[0][0][0]
 
 
-def test_telegram_exit_reason_performance_handle(default_conf_usdt, update, ticker, fee,
-                                                 mocker) -> None:
+async def test_telegram_exit_reason_performance_handle(
+        default_conf_usdt, update, ticker, fee, mocker) -> None:
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
     )
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf_usdt)
     patch_get_signal(freqtradebot)
 
     create_mock_trades_usdt(fee)
 
     context = MagicMock()
-    telegram._exit_reason_performance(update=update, context=context)
+    await telegram._exit_reason_performance(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'Exit Reason Performance' in msg_mock.call_args_list[0][0][0]
     assert '<code>roi\t2.842 USDT (10.00%) (1)</code>' in msg_mock.call_args_list[0][0][0]
     context.args = ['XRP/USDT']
 
-    telegram._exit_reason_performance(update=update, context=context)
+    await telegram._exit_reason_performance(update=update, context=context)
     assert msg_mock.call_count == 2
 
     msg_mock.reset_mock()
     mocker.patch('freqtrade.rpc.rpc.RPC._rpc_exit_reason_performance',
                  side_effect=RPCException('Error'))
-    telegram._exit_reason_performance(update=update, context=MagicMock())
+    await telegram._exit_reason_performance(update=update, context=MagicMock())
 
     assert msg_mock.call_count == 1
     assert "Error" in msg_mock.call_args_list[0][0][0]
 
 
-def test_telegram_mix_tag_performance_handle(default_conf_usdt, update, ticker, fee,
-                                             mocker) -> None:
+async def test_telegram_mix_tag_performance_handle(default_conf_usdt, update, ticker, fee,
+                                                   mocker) -> None:
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
     )
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf_usdt)
     patch_get_signal(freqtradebot)
 
     # Create some test data
     create_mock_trades_usdt(fee)
 
     context = MagicMock()
-    telegram._mix_tag_performance(update=update, context=context)
+    await telegram._mix_tag_performance(update=update, context=context)
     assert msg_mock.call_count == 1
     assert 'Mix Tag Performance' in msg_mock.call_args_list[0][0][0]
     assert ('<code>TEST3 roi\t2.842 USDT (10.00%) (1)</code>'
             in msg_mock.call_args_list[0][0][0])
 
     context.args = ['XRP/USDT']
-    telegram._mix_tag_performance(update=update, context=context)
+    await telegram._mix_tag_performance(update=update, context=context)
     assert msg_mock.call_count == 2
 
     msg_mock.reset_mock()
     mocker.patch('freqtrade.rpc.rpc.RPC._rpc_mix_tag_performance',
                  side_effect=RPCException('Error'))
-    telegram._mix_tag_performance(update=update, context=MagicMock())
+    await telegram._mix_tag_performance(update=update, context=MagicMock())
 
     assert msg_mock.call_count == 1
     assert "Error" in msg_mock.call_args_list[0][0][0]
 
 
-def test_count_handle(default_conf, update, ticker, fee, mocker) -> None:
+async def test_count_handle(default_conf, update, ticker, fee, mocker) -> None:
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
     )
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
 
     freqtradebot.state = State.STOPPED
-    telegram._count(update=update, context=MagicMock())
+    await telegram._count(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'not running' in msg_mock.call_args_list[0][0][0]
     msg_mock.reset_mock()
     freqtradebot.state = State.RUNNING
 
     # Create some test data
     freqtradebot.enter_positions()
     msg_mock.reset_mock()
-    telegram._count(update=update, context=MagicMock())
+    await telegram._count(update=update, context=MagicMock())
 
     msg = ('<pre>  current    max    total stake\n---------  -----  -------------\n'
            '        1      {}          {}</pre>').format(
         default_conf['max_open_trades'],
         default_conf['stake_amount']
     )
     assert msg in msg_mock.call_args_list[0][0][0]
 
 
-def test_telegram_lock_handle(default_conf, update, ticker, fee, mocker) -> None:
+async def test_telegram_lock_handle(default_conf, update, ticker, fee, mocker) -> None:
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
         get_fee=fee,
     )
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
     patch_get_signal(freqtradebot)
-    telegram._locks(update=update, context=MagicMock())
+    await telegram._locks(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert 'No active locks.' in msg_mock.call_args_list[0][0][0]
 
     msg_mock.reset_mock()
 
-    PairLocks.lock_pair('ETH/BTC', arrow.utcnow().shift(minutes=4).datetime, 'randreason')
-    PairLocks.lock_pair('XRP/BTC', arrow.utcnow().shift(minutes=20).datetime, 'deadbeef')
+    PairLocks.lock_pair('ETH/BTC', dt_now() + timedelta(minutes=4), 'randreason')
+    PairLocks.lock_pair('XRP/BTC', dt_now() + timedelta(minutes=20), 'deadbeef')
 
-    telegram._locks(update=update, context=MagicMock())
+    await telegram._locks(update=update, context=MagicMock())
 
     assert 'Pair' in msg_mock.call_args_list[0][0][0]
     assert 'Until' in msg_mock.call_args_list[0][0][0]
     assert 'Reason\n' in msg_mock.call_args_list[0][0][0]
     assert 'ETH/BTC' in msg_mock.call_args_list[0][0][0]
     assert 'XRP/BTC' in msg_mock.call_args_list[0][0][0]
     assert 'deadbeef' in msg_mock.call_args_list[0][0][0]
     assert 'randreason' in msg_mock.call_args_list[0][0][0]
 
     context = MagicMock()
     context.args = ['XRP/BTC']
     msg_mock.reset_mock()
-    telegram._delete_locks(update=update, context=context)
+    await telegram._delete_locks(update=update, context=context)
 
     assert 'ETH/BTC' in msg_mock.call_args_list[0][0][0]
     assert 'randreason' in msg_mock.call_args_list[0][0][0]
     assert 'XRP/BTC' not in msg_mock.call_args_list[0][0][0]
     assert 'deadbeef' not in msg_mock.call_args_list[0][0][0]
 
 
-def test_whitelist_static(default_conf, update, mocker) -> None:
+async def test_whitelist_static(default_conf, update, mocker) -> None:
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
-    telegram._whitelist(update=update, context=MagicMock())
+    await telegram._whitelist(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert ("Using whitelist `['StaticPairList']` with 4 pairs\n"
             "`ETH/BTC, LTC/BTC, XRP/BTC, NEO/BTC`" in msg_mock.call_args_list[0][0][0])
 
     context = MagicMock()
     context.args = ['sorted']
     msg_mock.reset_mock()
-    telegram._whitelist(update=update, context=context)
+    await telegram._whitelist(update=update, context=context)
     assert ("Using whitelist `['StaticPairList']` with 4 pairs\n"
             "`ETH/BTC, LTC/BTC, NEO/BTC, XRP/BTC`" in msg_mock.call_args_list[0][0][0])
 
     context = MagicMock()
     context.args = ['baseonly']
     msg_mock.reset_mock()
-    telegram._whitelist(update=update, context=context)
+    await telegram._whitelist(update=update, context=context)
     assert ("Using whitelist `['StaticPairList']` with 4 pairs\n"
             "`ETH, LTC, XRP, NEO`" in msg_mock.call_args_list[0][0][0])
 
     context = MagicMock()
     context.args = ['baseonly', 'sorted']
     msg_mock.reset_mock()
-    telegram._whitelist(update=update, context=context)
+    await telegram._whitelist(update=update, context=context)
     assert ("Using whitelist `['StaticPairList']` with 4 pairs\n"
             "`ETH, LTC, NEO, XRP`" in msg_mock.call_args_list[0][0][0])
 
 
-def test_whitelist_dynamic(default_conf, update, mocker) -> None:
+async def test_whitelist_dynamic(default_conf, update, mocker) -> None:
     mocker.patch(f'{EXMS}.exchange_has', return_value=True)
     default_conf['pairlists'] = [{'method': 'VolumePairList',
                                   'number_assets': 4
                                   }]
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
 
-    telegram._whitelist(update=update, context=MagicMock())
+    await telegram._whitelist(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert ("Using whitelist `['VolumePairList']` with 4 pairs\n"
             "`ETH/BTC, LTC/BTC, XRP/BTC, NEO/BTC`" in msg_mock.call_args_list[0][0][0])
 
     context = MagicMock()
     context.args = ['sorted']
     msg_mock.reset_mock()
-    telegram._whitelist(update=update, context=context)
+    await telegram._whitelist(update=update, context=context)
     assert ("Using whitelist `['VolumePairList']` with 4 pairs\n"
             "`ETH/BTC, LTC/BTC, NEO/BTC, XRP/BTC`" in msg_mock.call_args_list[0][0][0])
 
     context = MagicMock()
     context.args = ['baseonly']
     msg_mock.reset_mock()
-    telegram._whitelist(update=update, context=context)
+    await telegram._whitelist(update=update, context=context)
     assert ("Using whitelist `['VolumePairList']` with 4 pairs\n"
             "`ETH, LTC, XRP, NEO`" in msg_mock.call_args_list[0][0][0])
 
     context = MagicMock()
     context.args = ['baseonly', 'sorted']
     msg_mock.reset_mock()
-    telegram._whitelist(update=update, context=context)
+    await telegram._whitelist(update=update, context=context)
     assert ("Using whitelist `['VolumePairList']` with 4 pairs\n"
             "`ETH, LTC, NEO, XRP`" in msg_mock.call_args_list[0][0][0])
 
 
-def test_blacklist_static(default_conf, update, mocker) -> None:
+async def test_blacklist_static(default_conf, update, mocker) -> None:
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
-    telegram._blacklist(update=update, context=MagicMock())
+    await telegram._blacklist(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert ("Blacklist contains 2 pairs\n`DOGE/BTC, HOT/BTC`"
             in msg_mock.call_args_list[0][0][0])
 
     msg_mock.reset_mock()
 
     # /blacklist ETH/BTC
     context = MagicMock()
     context.args = ["ETH/BTC"]
-    telegram._blacklist(update=update, context=context)
+    await telegram._blacklist(update=update, context=context)
     assert msg_mock.call_count == 1
     assert ("Blacklist contains 3 pairs\n`DOGE/BTC, HOT/BTC, ETH/BTC`"
             in msg_mock.call_args_list[0][0][0])
     assert freqtradebot.pairlists.blacklist == ["DOGE/BTC", "HOT/BTC", "ETH/BTC"]
 
     msg_mock.reset_mock()
     context = MagicMock()
     context.args = ["XRP/.*"]
-    telegram._blacklist(update=update, context=context)
+    await telegram._blacklist(update=update, context=context)
     assert msg_mock.call_count == 1
 
     assert ("Blacklist contains 4 pairs\n`DOGE/BTC, HOT/BTC, ETH/BTC, XRP/.*`"
             in msg_mock.call_args_list[0][0][0])
     assert freqtradebot.pairlists.blacklist == ["DOGE/BTC", "HOT/BTC", "ETH/BTC", "XRP/.*"]
 
     msg_mock.reset_mock()
     context.args = ["DOGE/BTC"]
-    telegram._blacklist_delete(update=update, context=context)
+    await telegram._blacklist_delete(update=update, context=context)
     assert msg_mock.call_count == 1
     assert ("Blacklist contains 3 pairs\n`HOT/BTC, ETH/BTC, XRP/.*`"
             in msg_mock.call_args_list[0][0][0])
 
 
-def test_telegram_logs(default_conf, update, mocker) -> None:
+async def test_telegram_logs(default_conf, update, mocker) -> None:
     mocker.patch.multiple(
         'freqtrade.rpc.telegram.Telegram',
         _init=MagicMock(),
     )
     setup_logging(default_conf)
 
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     context = MagicMock()
     context.args = []
-    telegram._logs(update=update, context=context)
+    await telegram._logs(update=update, context=context)
     assert msg_mock.call_count == 1
     assert "freqtrade\\.rpc\\.telegram" in msg_mock.call_args_list[0][0][0]
 
     msg_mock.reset_mock()
     context.args = ["1"]
-    telegram._logs(update=update, context=context)
+    await telegram._logs(update=update, context=context)
     assert msg_mock.call_count == 1
 
     msg_mock.reset_mock()
     # Test with changed MaxMessageLength
     mocker.patch('freqtrade.rpc.telegram.MAX_MESSAGE_LENGTH', 200)
     context = MagicMock()
     context.args = []
-    telegram._logs(update=update, context=context)
+    await telegram._logs(update=update, context=context)
     # Called at least 2 times. Exact times will change with unrelated changes to setup messages
     # Therefore we don't test for this explicitly.
     assert msg_mock.call_count >= 2
 
 
-def test_edge_disabled(default_conf, update, mocker) -> None:
+async def test_edge_disabled(default_conf, update, mocker) -> None:
 
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
 
-    telegram._edge(update=update, context=MagicMock())
+    await telegram._edge(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert "Edge is not enabled." in msg_mock.call_args_list[0][0][0]
 
 
-def test_edge_enabled(edge_conf, update, mocker) -> None:
+async def test_edge_enabled(edge_conf, update, mocker) -> None:
     mocker.patch('freqtrade.edge.Edge._cached_pairs', mocker.PropertyMock(
         return_value={
             'E/F': PairInfo(-0.01, 0.66, 3.71, 0.50, 1.71, 10, 60),
         }
     ))
 
     telegram, _, msg_mock = get_telegram_testobject(mocker, edge_conf)
 
-    telegram._edge(update=update, context=MagicMock())
+    await telegram._edge(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert '<b>Edge only validated following pairs:</b>\n<pre>' in msg_mock.call_args_list[0][0][0]
     assert 'Pair      Winrate    Expectancy    Stoploss' in msg_mock.call_args_list[0][0][0]
 
     msg_mock.reset_mock()
 
     mocker.patch('freqtrade.edge.Edge._cached_pairs', mocker.PropertyMock(
         return_value={}))
-    telegram._edge(update=update, context=MagicMock())
+    await telegram._edge(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert '<b>Edge only validated following pairs:</b>' in msg_mock.call_args_list[0][0][0]
     assert 'Winrate' not in msg_mock.call_args_list[0][0][0]
 
 
 @pytest.mark.parametrize('is_short,regex_pattern',
                          [(True, r"just now[ ]*XRP\/BTC \(#3\)  -1.00% \("),
                           (False, r"just now[ ]*XRP\/BTC \(#3\)  1.00% \(")])
-def test_telegram_trades(mocker, update, default_conf, fee, is_short, regex_pattern):
+async def test_telegram_trades(mocker, update, default_conf, fee, is_short, regex_pattern):
 
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     context = MagicMock()
     context.args = []
 
-    telegram._trades(update=update, context=context)
+    await telegram._trades(update=update, context=context)
     assert "<b>0 recent trades</b>:" in msg_mock.call_args_list[0][0][0]
     assert "<pre>" not in msg_mock.call_args_list[0][0][0]
     msg_mock.reset_mock()
 
     context.args = ['hello']
-    telegram._trades(update=update, context=context)
+    await telegram._trades(update=update, context=context)
     assert "<b>0 recent trades</b>:" in msg_mock.call_args_list[0][0][0]
     assert "<pre>" not in msg_mock.call_args_list[0][0][0]
     msg_mock.reset_mock()
 
     create_mock_trades(fee, is_short=is_short)
 
     context = MagicMock()
     context.args = [5]
-    telegram._trades(update=update, context=context)
+    await telegram._trades(update=update, context=context)
     msg_mock.call_count == 1
     assert "2 recent trades</b>:" in msg_mock.call_args_list[0][0][0]
     assert "Profit (" in msg_mock.call_args_list[0][0][0]
     assert "Close Date" in msg_mock.call_args_list[0][0][0]
     assert "<pre>" in msg_mock.call_args_list[0][0][0]
     assert bool(re.search(regex_pattern, msg_mock.call_args_list[0][0][0]))
 
 
 @pytest.mark.parametrize('is_short', [True, False])
-def test_telegram_delete_trade(mocker, update, default_conf, fee, is_short):
+async def test_telegram_delete_trade(mocker, update, default_conf, fee, is_short):
 
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
     context = MagicMock()
     context.args = []
 
-    telegram._delete_trade(update=update, context=context)
+    await telegram._delete_trade(update=update, context=context)
     assert "Trade-id not set." in msg_mock.call_args_list[0][0][0]
 
     msg_mock.reset_mock()
     create_mock_trades(fee, is_short=is_short)
 
     context = MagicMock()
     context.args = [1]
-    telegram._delete_trade(update=update, context=context)
+    await telegram._delete_trade(update=update, context=context)
     msg_mock.call_count == 1
     assert "Deleted trade 1." in msg_mock.call_args_list[0][0][0]
     assert "Please make sure to take care of this asset" in msg_mock.call_args_list[0][0][0]
 
 
 @pytest.mark.parametrize('is_short', [True, False])
-def test_telegram_delete_open_order(mocker, update, default_conf, fee, is_short, ticker):
+async def test_telegram_reload_trade_from_exchange(mocker, update, default_conf, fee, is_short):
+
+    telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
+    context = MagicMock()
+    context.args = []
+
+    await telegram._reload_trade_from_exchange(update=update, context=context)
+    assert "Trade-id not set." in msg_mock.call_args_list[0][0][0]
+
+    msg_mock.reset_mock()
+    create_mock_trades(fee, is_short=is_short)
+
+    context.args = [5]
+
+    await telegram._reload_trade_from_exchange(update=update, context=context)
+    assert "Status: `Reloaded from orders from exchange`" in msg_mock.call_args_list[0][0][0]
+
+
+@pytest.mark.parametrize('is_short', [True, False])
+async def test_telegram_delete_open_order(mocker, update, default_conf, fee, is_short, ticker):
 
     mocker.patch.multiple(
         EXMS,
         fetch_ticker=ticker,
     )
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
     context = MagicMock()
     context.args = []
 
-    telegram._cancel_open_order(update=update, context=context)
+    await telegram._cancel_open_order(update=update, context=context)
     assert "Trade-id not set." in msg_mock.call_args_list[0][0][0]
 
     msg_mock.reset_mock()
     create_mock_trades(fee, is_short=is_short)
 
     context = MagicMock()
     context.args = [5]
-    telegram._cancel_open_order(update=update, context=context)
+    await telegram._cancel_open_order(update=update, context=context)
     assert "No open order for trade_id" in msg_mock.call_args_list[0][0][0]
 
     msg_mock.reset_mock()
 
     trade = Trade.get_trades([Trade.id == 6]).first()
     mocker.patch(f'{EXMS}.fetch_order', return_value=trade.orders[-1].to_ccxt_object())
     context = MagicMock()
     context.args = [6]
-    telegram._cancel_open_order(update=update, context=context)
+    await telegram._cancel_open_order(update=update, context=context)
     assert msg_mock.call_count == 1
     assert "Open order canceled." in msg_mock.call_args_list[0][0][0]
 
 
-def test_help_handle(default_conf, update, mocker) -> None:
+async def test_help_handle(default_conf, update, mocker) -> None:
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
 
-    telegram._help(update=update, context=MagicMock())
+    await telegram._help(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert '*/help:* `This help message`' in msg_mock.call_args_list[0][0][0]
 
 
-def test_version_handle(default_conf, update, mocker) -> None:
+async def test_version_handle(default_conf, update, mocker) -> None:
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
-    telegram._version(update=update, context=MagicMock())
+    await telegram._version(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert f'*Version:* `{__version__}`' in msg_mock.call_args_list[0][0][0]
 
     msg_mock.reset_mock()
     freqtradebot.strategy.version = lambda: '1.1.1'
 
-    telegram._version(update=update, context=MagicMock())
+    await telegram._version(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert f'*Version:* `{__version__}`' in msg_mock.call_args_list[0][0][0]
     assert '*Strategy version: * `1.1.1`' in msg_mock.call_args_list[0][0][0]
 
 
-def test_show_config_handle(default_conf, update, mocker) -> None:
+async def test_show_config_handle(default_conf, update, mocker) -> None:
 
     default_conf['runmode'] = RunMode.DRY_RUN
 
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
-    telegram._show_config(update=update, context=MagicMock())
+    await telegram._show_config(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert '*Mode:* `{}`'.format('Dry-run') in msg_mock.call_args_list[0][0][0]
     assert '*Exchange:* `binance`' in msg_mock.call_args_list[0][0][0]
     assert f'*Strategy:* `{CURRENT_TEST_STRATEGY}`' in msg_mock.call_args_list[0][0][0]
     assert '*Stoploss:* `-0.1`' in msg_mock.call_args_list[0][0][0]
 
     msg_mock.reset_mock()
     freqtradebot.config['trailing_stop'] = True
-    telegram._show_config(update=update, context=MagicMock())
+    await telegram._show_config(update=update, context=MagicMock())
     assert msg_mock.call_count == 1
     assert '*Mode:* `{}`'.format('Dry-run') in msg_mock.call_args_list[0][0][0]
     assert '*Exchange:* `binance`' in msg_mock.call_args_list[0][0][0]
     assert f'*Strategy:* `{CURRENT_TEST_STRATEGY}`' in msg_mock.call_args_list[0][0][0]
     assert '*Initial Stoploss:* `-0.1`' in msg_mock.call_args_list[0][0][0]
 
 
@@ -1803,15 +1894,15 @@
         'stake_amount': 0.01465333,
         'stake_amount_fiat': 0.0,
         'stake_currency': 'BTC',
         'fiat_currency': 'USD',
         'current_rate': 1.099e-05,
         'amount': 1333.3333333333335,
         'analyzed_candle': {'open': 1.1, 'high': 2.2, 'low': 1.0, 'close': 1.5},
-        'open_date': arrow.utcnow().shift(hours=-1)
+        'open_date': dt_now() + timedelta(hours=-1)
     }
     telegram, freqtradebot, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     telegram.send_msg(msg)
     leverage_text = f'*Leverage:* `{leverage}`\n' if leverage and leverage != 1.0 else ''
 
     assert msg_mock.call_args[0][0] == (
@@ -1864,30 +1955,30 @@
 
 def test_send_msg_protection_notification(default_conf, mocker, time_machine) -> None:
 
     default_conf['telegram']['notification_settings']['protection_trigger'] = 'on'
 
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
     time_machine.move_to("2021-09-01 05:00:00 +00:00")
-    lock = PairLocks.lock_pair('ETH/BTC', arrow.utcnow().shift(minutes=6).datetime, 'randreason')
+    lock = PairLocks.lock_pair('ETH/BTC', dt_now() + timedelta(minutes=6), 'randreason')
     msg = {
         'type': RPCMessageType.PROTECTION_TRIGGER,
     }
     msg.update(lock.to_json())
     telegram.send_msg(msg)
     assert (msg_mock.call_args[0][0] == "*Protection* triggered due to randreason. "
             "`ETH/BTC` will be locked until `2021-09-01 05:10:00`.")
 
     msg_mock.reset_mock()
     # Test global protection
 
     msg = {
         'type': RPCMessageType.PROTECTION_TRIGGER_GLOBAL,
     }
-    lock = PairLocks.lock_pair('*', arrow.utcnow().shift(minutes=100).datetime, 'randreason')
+    lock = PairLocks.lock_pair('*', dt_now() + timedelta(minutes=100), 'randreason')
     msg.update(lock.to_json())
     telegram.send_msg(msg)
     assert (msg_mock.call_args[0][0] == "*Protection* triggered due to randreason. "
             "*All pairs* will be locked until `2021-09-01 06:45:00`.")
 
 
 @pytest.mark.parametrize('message_type,entered,enter_signal,leverage', [
@@ -1910,15 +2001,15 @@
         'leverage': leverage,
         'stake_amount': 0.01465333,
         'direction': entered,
         'stake_currency': 'BTC',
         'fiat_currency': 'USD',
         'open_rate': 1.099e-05,
         'amount': 1333.3333333333335,
-        'open_date': arrow.utcnow().shift(hours=-1)
+        'open_date': dt_now() - timedelta(hours=1)
     })
     leverage_text = f'*Leverage:* `{leverage}`\n' if leverage != 1.0 else ''
     assert msg_mock.call_args[0][0] == (
         f'\N{CHECK MARK} *Binance (dry):* {entered}ed ETH/BTC (#1)\n'
         f'*Enter Tag:* `{enter_signal}`\n'
         '*Amount:* `1333.33333333`\n'
         f"{leverage_text}"
@@ -1937,15 +2028,15 @@
         'stake_amount': 0.01465333,
         'sub_trade': True,
         'direction': entered,
         'stake_currency': 'BTC',
         'fiat_currency': 'USD',
         'open_rate': 1.099e-05,
         'amount': 1333.3333333333335,
-        'open_date': arrow.utcnow().shift(hours=-1)
+        'open_date': dt_now() - timedelta(hours=1)
     })
 
     assert msg_mock.call_args[0][0] == (
         f'\N{CHECK MARK} *Binance (dry):* {entered}ed ETH/BTC (#1)\n'
         f'*Enter Tag:* `{enter_signal}`\n'
         '*Amount:* `1333.33333333`\n'
         f"{leverage_text}"
@@ -1976,16 +2067,16 @@
             'current_rate': 3.201e-05,
             'profit_amount': -0.05746268,
             'profit_ratio': -0.57405275,
             'stake_currency': 'ETH',
             'fiat_currency': 'USD',
             'enter_tag': 'buy_signal1',
             'exit_reason': ExitType.STOP_LOSS.value,
-            'open_date': arrow.utcnow().shift(hours=-1),
-            'close_date': arrow.utcnow(),
+            'open_date': dt_now() - timedelta(hours=1),
+            'close_date': dt_now(),
         })
         assert msg_mock.call_args[0][0] == (
             '\N{WARNING SIGN} *Binance (dry):* Exiting KEY/ETH (#1)\n'
             '*Unrealized Profit:* `-57.41% (loss: -0.05746268 ETH / -24.812 USD)`\n'
             '*Enter Tag:* `buy_signal1`\n'
             '*Exit Reason:* `stop_loss`\n'
             '*Direction:* `Long`\n'
@@ -2012,16 +2103,16 @@
             'cumulative_profit': -0.15746268,
             'profit_amount': -0.05746268,
             'profit_ratio': -0.57405275,
             'stake_currency': 'ETH',
             'fiat_currency': 'USD',
             'enter_tag': 'buy_signal1',
             'exit_reason': ExitType.STOP_LOSS.value,
-            'open_date': arrow.utcnow().shift(days=-1, hours=-2, minutes=-30),
-            'close_date': arrow.utcnow(),
+            'open_date': dt_now() - timedelta(days=1, hours=2, minutes=30),
+            'close_date': dt_now(),
             'stake_amount': 0.01,
             'sub_trade': True,
         })
         assert msg_mock.call_args[0][0] == (
             '\N{WARNING SIGN} *Binance (dry):* Partially exiting KEY/ETH (#1)\n'
             '*Unrealized Sub Profit:* `-57.41% (loss: -0.05746268 ETH / -24.812 USD)`\n'
             '*Cumulative Profit:* (`-0.15746268 ETH / -24.812 USD`)\n'
@@ -2049,16 +2140,16 @@
             'open_rate': 7.5e-05,
             'current_rate': 3.201e-05,
             'profit_amount': -0.05746268,
             'profit_ratio': -0.57405275,
             'stake_currency': 'ETH',
             'enter_tag': 'buy_signal1',
             'exit_reason': ExitType.STOP_LOSS.value,
-            'open_date': arrow.utcnow().shift(days=-1, hours=-2, minutes=-30),
-            'close_date': arrow.utcnow(),
+            'open_date': dt_now() - timedelta(days=1, hours=2, minutes=30),
+            'close_date': dt_now(),
         })
         assert msg_mock.call_args[0][0] == (
             '\N{WARNING SIGN} *Binance (dry):* Exiting KEY/ETH (#1)\n'
             '*Unrealized Profit:* `-57.41% (loss: -0.05746268 ETH)`\n'
             '*Enter Tag:* `buy_signal1`\n'
             '*Exit Reason:* `stop_loss`\n'
             '*Direction:* `Long`\n'
@@ -2068,15 +2159,15 @@
             '*Exit Rate:* `0.00003201`\n'
             '*Duration:* `1 day, 2:30:00 (1590.0 min)`'
         )
         # Reset singleton function to avoid random breaks
         telegram._rpc._fiat_converter.convert_amount = old_convamount
 
 
-def test_send_msg_sell_cancel_notification(default_conf, mocker) -> None:
+async def test_send_msg_sell_cancel_notification(default_conf, mocker) -> None:
 
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
 
     old_convamount = telegram._rpc._fiat_converter.convert_amount
     telegram._rpc._fiat_converter.convert_amount = lambda a, b, c: -24.812
     telegram.send_msg({
         'type': RPCMessageType.EXIT_CANCEL,
@@ -2131,16 +2222,16 @@
             'open_rate': 7.5e-05,
             'close_rate': 3.201e-05,
             'profit_amount': -0.05746268,
             'profit_ratio': -0.57405275,
             'stake_currency': 'ETH',
             'enter_tag': enter_signal,
             'exit_reason': ExitType.STOP_LOSS.value,
-            'open_date': arrow.utcnow().shift(days=-1, hours=-2, minutes=-30),
-            'close_date': arrow.utcnow(),
+            'open_date': dt_now() - timedelta(days=1, hours=2, minutes=30),
+            'close_date': dt_now(),
         })
 
         leverage_text = f'*Leverage:* `{leverage}`\n' if leverage and leverage != 1.0 else ''
         assert msg_mock.call_args[0][0] == (
             '\N{WARNING SIGN} *Binance (dry):* Exited KEY/ETH (#1)\n'
             '*Profit:* `-57.41% (loss: -0.05746268 ETH)`\n'
             f'*Enter Tag:* `{enter_signal}`\n'
@@ -2160,15 +2251,15 @@
     telegram.send_msg({
         'type': RPCMessageType.STATUS,
         'status': 'running'
     })
     assert msg_mock.call_args[0][0] == '*Status:* `running`'
 
 
-def test_warning_notification(default_conf, mocker) -> None:
+async def test_warning_notification(default_conf, mocker) -> None:
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
     telegram.send_msg({
         'type': RPCMessageType.WARNING,
         'status': 'message'
     })
     assert msg_mock.call_args[0][0] == '\N{WARNING SIGN} *Warning:* `message`'
 
@@ -2222,15 +2313,15 @@
         'direction': enter,
         'stake_amount': 0.01465333,
         'stake_amount_fiat': 0.0,
         'stake_currency': 'BTC',
         'fiat_currency': None,
         'current_rate': 1.099e-05,
         'amount': 1333.3333333333335,
-        'open_date': arrow.utcnow().shift(hours=-1)
+        'open_date': dt_now() - timedelta(hours=1)
     })
 
     leverage_text = f'*Leverage:* `{leverage}`\n' if leverage and leverage != 1.0 else ''
     assert msg_mock.call_args[0][0] == (
         f'\N{LARGE BLUE CIRCLE} *Binance:* {enter} ETH/BTC (#1)\n'
         f'*Enter Tag:* `{enter_signal}`\n'
         '*Amount:* `1333.33333333`\n'
@@ -2268,16 +2359,16 @@
         'current_rate': 3.201e-05,
         'profit_amount': -0.05746268,
         'profit_ratio': -0.57405275,
         'stake_currency': 'ETH',
         'fiat_currency': 'USD',
         'enter_tag': enter_signal,
         'exit_reason': ExitType.STOP_LOSS.value,
-        'open_date': arrow.utcnow().shift(hours=-2, minutes=-35, seconds=-3),
-        'close_date': arrow.utcnow(),
+        'open_date': dt_now() - timedelta(hours=2, minutes=35, seconds=3),
+        'close_date': dt_now(),
     })
 
     leverage_text = f'*Leverage:* `{leverage}`\n' if leverage and leverage != 1.0 else ''
     assert msg_mock.call_args[0][0] == (
         '\N{WARNING SIGN} *Binance (dry):* Exiting KEY/ETH (#1)\n'
         '*Unrealized Profit:* `-57.41% (loss: -0.05746268 ETH)`\n'
         f'*Enter Tag:* `{enter_signal}`\n'
@@ -2305,68 +2396,70 @@
     del default_conf['fiat_display_currency']
 
     telegram, _, _ = get_telegram_testobject(mocker, default_conf)
 
     assert telegram._get_sell_emoji(msg) == expected
 
 
-def test_telegram__send_msg(default_conf, mocker, caplog) -> None:
+async def test_telegram__send_msg(default_conf, mocker, caplog) -> None:
     mocker.patch('freqtrade.rpc.telegram.Telegram._init', MagicMock())
     bot = MagicMock()
+    bot.send_message = AsyncMock()
+    bot.edit_message_text = AsyncMock()
     telegram, _, _ = get_telegram_testobject(mocker, default_conf, mock=False)
-    telegram._updater = MagicMock()
-    telegram._updater.bot = bot
+    telegram._app = MagicMock()
+    telegram._app.bot = bot
 
-    telegram._config['telegram']['enabled'] = True
-    telegram._send_msg('test')
+    await telegram._send_msg('test')
     assert len(bot.method_calls) == 1
 
     # Test update
     query = MagicMock()
-    telegram._send_msg('test', callback_path="DeadBeef", query=query, reload_able=True)
-    edit_message_text = telegram._updater.bot.edit_message_text
+    await telegram._send_msg('test', callback_path="DeadBeef", query=query, reload_able=True)
+    edit_message_text = telegram._app.bot.edit_message_text
     assert edit_message_text.call_count == 1
     assert "Updated: " in edit_message_text.call_args_list[0][1]['text']
 
-    telegram._updater.bot.edit_message_text = MagicMock(side_effect=BadRequest("not modified"))
-    telegram._send_msg('test', callback_path="DeadBeef", query=query)
-    assert telegram._updater.bot.edit_message_text.call_count == 1
+    telegram._app.bot.edit_message_text = AsyncMock(side_effect=BadRequest("not modified"))
+    await telegram._send_msg('test', callback_path="DeadBeef", query=query)
+    assert telegram._app.bot.edit_message_text.call_count == 1
     assert not log_has_re(r"TelegramError: .*", caplog)
 
-    telegram._updater.bot.edit_message_text = MagicMock(side_effect=BadRequest(""))
-    telegram._send_msg('test2', callback_path="DeadBeef", query=query)
-    assert telegram._updater.bot.edit_message_text.call_count == 1
+    telegram._app.bot.edit_message_text = AsyncMock(side_effect=BadRequest(""))
+    await telegram._send_msg('test2', callback_path="DeadBeef", query=query)
+    assert telegram._app.bot.edit_message_text.call_count == 1
     assert log_has_re(r"TelegramError: .*", caplog)
 
-    telegram._updater.bot.edit_message_text = MagicMock(side_effect=TelegramError("DeadBEEF"))
-    telegram._send_msg('test3', callback_path="DeadBeef", query=query)
+    telegram._app.bot.edit_message_text = AsyncMock(side_effect=TelegramError("DeadBEEF"))
+    await telegram._send_msg('test3', callback_path="DeadBeef", query=query)
 
     assert log_has_re(r"TelegramError: DeadBEEF! Giving up.*", caplog)
 
 
-def test__send_msg_network_error(default_conf, mocker, caplog) -> None:
+async def test__send_msg_network_error(default_conf, mocker, caplog) -> None:
     mocker.patch('freqtrade.rpc.telegram.Telegram._init', MagicMock())
     bot = MagicMock()
     bot.send_message = MagicMock(side_effect=NetworkError('Oh snap'))
     telegram, _, _ = get_telegram_testobject(mocker, default_conf, mock=False)
-    telegram._updater = MagicMock()
-    telegram._updater.bot = bot
+    telegram._app = MagicMock()
+    telegram._app.bot = bot
 
     telegram._config['telegram']['enabled'] = True
-    telegram._send_msg('test')
+    await telegram._send_msg('test')
 
     # Bot should've tried to send it twice
     assert len(bot.method_calls) == 2
     assert log_has('Telegram NetworkError: Oh snap! Trying one more time.', caplog)
 
 
-def test__send_msg_keyboard(default_conf, mocker, caplog) -> None:
+@pytest.mark.filterwarnings("ignore:.*ChatPermissions")
+async def test__send_msg_keyboard(default_conf, mocker, caplog) -> None:
     mocker.patch('freqtrade.rpc.telegram.Telegram._init', MagicMock())
     bot = MagicMock()
-    bot.send_message = MagicMock()
+    bot.send_message = AsyncMock()
     freqtradebot = get_patched_freqtradebot(mocker, default_conf)
     rpc = RPC(freqtradebot)
 
     invalid_keys_list = [['/not_valid', '/profit'], ['/daily'], ['/alsoinvalid']]
     default_keys_list = [['/daily', '/profit', '/balance'],
                          ['/status', '/status table', '/performance'],
                          ['/count', '/start', '/stop', '/help']]
@@ -2374,22 +2467,22 @@
 
     custom_keys_list = [['/daily', '/stats', '/balance', '/profit', '/profit 5'],
                         ['/count', '/start', '/reload_config', '/help']]
     custom_keyboard = ReplyKeyboardMarkup(custom_keys_list)
 
     def init_telegram(freqtradebot):
         telegram = Telegram(rpc, default_conf)
-        telegram._updater = MagicMock()
-        telegram._updater.bot = bot
+        telegram._app = MagicMock()
+        telegram._app.bot = bot
         return telegram
 
     # no keyboard in config -> default keyboard
     freqtradebot.config['telegram']['enabled'] = True
     telegram = init_telegram(freqtradebot)
-    telegram._send_msg('test')
+    await telegram._send_msg('test')
     used_keyboard = bot.send_message.call_args[1]['reply_markup']
     assert used_keyboard == default_keyboard
 
     # invalid keyboard in config -> default keyboard
     freqtradebot.config['telegram']['enabled'] = True
     freqtradebot.config['telegram']['keyboard'] = invalid_keys_list
     err_msg = re.escape("config.telegram.keyboard: Invalid commands for custom "
@@ -2398,25 +2491,26 @@
     with pytest.raises(OperationalException, match=err_msg):
         telegram = init_telegram(freqtradebot)
 
     # valid keyboard in config -> custom keyboard
     freqtradebot.config['telegram']['enabled'] = True
     freqtradebot.config['telegram']['keyboard'] = custom_keys_list
     telegram = init_telegram(freqtradebot)
-    telegram._send_msg('test')
+    await telegram._send_msg('test')
     used_keyboard = bot.send_message.call_args[1]['reply_markup']
     assert used_keyboard == custom_keyboard
     assert log_has("using custom keyboard from config.json: "
                    "[['/daily', '/stats', '/balance', '/profit', '/profit 5'], ['/count', "
                    "'/start', '/reload_config', '/help']]", caplog)
 
 
-def test_change_market_direction(default_conf, mocker, update) -> None:
+async def test_change_market_direction(default_conf, mocker, update) -> None:
     telegram, _, msg_mock = get_telegram_testobject(mocker, default_conf)
     assert telegram._rpc._freqtrade.strategy.market_direction == MarketDirection.NONE
     context = MagicMock()
     context.args = ["long"]
-    telegram._changemarketdir(update, context)
+    await telegram._changemarketdir(update, context)
     assert telegram._rpc._freqtrade.strategy.market_direction == MarketDirection.LONG
     context = MagicMock()
     context.args = ["invalid"]
+    await telegram._changemarketdir(update, context)
     assert telegram._rpc._freqtrade.strategy.market_direction == MarketDirection.LONG
```

### Comparing `freqtrade-2023.4/tests/rpc/test_rpc_webhook.py` & `freqtrade-2023.5/tests/rpc/test_rpc_webhook.py`

 * *Files 2% similar despite different names*

```diff
@@ -13,14 +13,18 @@
 
 
 def get_webhook_dict() -> dict:
     return {
         "enabled": True,
         "url": "https://maker.ifttt.com/trigger/freqtrade_test/with/key/c764udvJ5jfSlswVRukZZ2/",
         "webhookentry": {
+            # Intentionally broken, as "entry" should have priority.
+            "value1": "Buying {pair55555}",
+        },
+        "entry": {
             "value1": "Buying {pair}",
             "value2": "limit {limit:8f}",
             "value3": "{stake_amount:8f} {stake_currency}",
             "value4": "leverage {leverage:.1f}",
             "value5": "direction {direction}"
         },
         "webhookentrycancel": {
@@ -85,23 +89,23 @@
         'stake_amount_fiat': 500,
         'stake_currency': 'BTC',
         'fiat_currency': 'EUR'
     }
     webhook.send_msg(msg=msg)
     assert msg_mock.call_count == 1
     assert (msg_mock.call_args[0][0]["value1"] ==
-            default_conf["webhook"]["webhookentry"]["value1"].format(**msg))
+            default_conf["webhook"]["entry"]["value1"].format(**msg))
     assert (msg_mock.call_args[0][0]["value2"] ==
-            default_conf["webhook"]["webhookentry"]["value2"].format(**msg))
+            default_conf["webhook"]["entry"]["value2"].format(**msg))
     assert (msg_mock.call_args[0][0]["value3"] ==
-            default_conf["webhook"]["webhookentry"]["value3"].format(**msg))
+            default_conf["webhook"]["entry"]["value3"].format(**msg))
     assert (msg_mock.call_args[0][0]["value4"] ==
-            default_conf["webhook"]["webhookentry"]["value4"].format(**msg))
+            default_conf["webhook"]["entry"]["value4"].format(**msg))
     assert (msg_mock.call_args[0][0]["value5"] ==
-            default_conf["webhook"]["webhookentry"]["value5"].format(**msg))
+            default_conf["webhook"]["entry"]["value5"].format(**msg))
     # Test short
     msg_mock.reset_mock()
 
     msg = {
         'type': RPCMessageType.ENTRY,
         'exchange': 'Binance',
         'pair': 'ETH/BTC',
@@ -112,23 +116,23 @@
         'stake_amount_fiat': 500,
         'stake_currency': 'BTC',
         'fiat_currency': 'EUR'
     }
     webhook.send_msg(msg=msg)
     assert msg_mock.call_count == 1
     assert (msg_mock.call_args[0][0]["value1"] ==
-            default_conf["webhook"]["webhookentry"]["value1"].format(**msg))
+            default_conf["webhook"]["entry"]["value1"].format(**msg))
     assert (msg_mock.call_args[0][0]["value2"] ==
-            default_conf["webhook"]["webhookentry"]["value2"].format(**msg))
+            default_conf["webhook"]["entry"]["value2"].format(**msg))
     assert (msg_mock.call_args[0][0]["value3"] ==
-            default_conf["webhook"]["webhookentry"]["value3"].format(**msg))
+            default_conf["webhook"]["entry"]["value3"].format(**msg))
     assert (msg_mock.call_args[0][0]["value4"] ==
-            default_conf["webhook"]["webhookentry"]["value4"].format(**msg))
+            default_conf["webhook"]["entry"]["value4"].format(**msg))
     assert (msg_mock.call_args[0][0]["value5"] ==
-            default_conf["webhook"]["webhookentry"]["value5"].format(**msg))
+            default_conf["webhook"]["entry"]["value5"].format(**msg))
     # Test buy cancel
     msg_mock.reset_mock()
 
     msg = {
         'type': RPCMessageType.ENTRY_CANCEL,
         'exchange': 'Binance',
         'pair': 'ETH/BTC',
@@ -324,14 +328,15 @@
                 default_conf["webhook"]["webhookstatus"]["value2"].format(**msg))
         assert (msg_mock.call_args[0][0]["value3"] ==
                 default_conf["webhook"]["webhookstatus"]["value3"].format(**msg))
 
 
 def test_exception_send_msg(default_conf, mocker, caplog):
     default_conf["webhook"] = get_webhook_dict()
+    del default_conf["webhook"]["entry"]
     del default_conf["webhook"]["webhookentry"]
 
     webhook = Webhook(RPC(get_patched_freqtradebot(mocker, default_conf)), default_conf)
     webhook.send_msg({'type': RPCMessageType.ENTRY})
     assert log_has(f"Message type '{RPCMessageType.ENTRY}' not configured for webhooks",
                    caplog)
```

### Comparing `freqtrade-2023.4/tests/strategy/test_default_strategy.py` & `freqtrade-2023.5/tests/strategy/test_default_strategy.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-from datetime import datetime
+from datetime import datetime, timezone
 
 import pytest
 from pandas import DataFrame
 
 from freqtrade.persistence.models import Trade
 
 from .strats.strategy_test_v3 import StrategyTestV3
@@ -39,17 +39,17 @@
         pair='ETH/BTC',
         fee_open=fee.return_value,
         is_short=is_short
     )
 
     assert strategy.confirm_trade_entry(pair='ETH/BTC', order_type='limit', amount=0.1,
                                         rate=20000, time_in_force='gtc',
-                                        current_time=datetime.utcnow(),
+                                        current_time=datetime.now(timezone.utc),
                                         side=side, entry_tag=None) is True
     assert strategy.confirm_trade_exit(pair='ETH/BTC', trade=trade, order_type='limit', amount=0.1,
                                        rate=20000, time_in_force='gtc', exit_reason='roi',
                                        sell_reason='roi',
-                                       current_time=datetime.utcnow(),
+                                       current_time=datetime.now(timezone.utc),
                                        side=side) is True
 
     assert strategy.custom_stoploss(pair='ETH/BTC', trade=trade, current_time=datetime.now(),
                                     current_rate=20_000, current_profit=0.05) == strategy.stoploss
```

### Comparing `freqtrade-2023.4/tests/strategy/test_interface.py` & `freqtrade-2023.5/tests/strategy/test_interface.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,14 +1,13 @@
 # pragma pylint: disable=missing-docstring, C0103
 import logging
 from datetime import datetime, timedelta, timezone
 from pathlib import Path
 from unittest.mock import MagicMock
 
-import arrow
 import pytest
 from pandas import DataFrame
 
 from freqtrade.configuration import TimeRange
 from freqtrade.constants import CUSTOM_TAG_MAX_LENGTH
 from freqtrade.data.dataprovider import DataProvider
 from freqtrade.data.history import load_data
@@ -18,27 +17,28 @@
 from freqtrade.optimize.space import SKDecimal
 from freqtrade.persistence import PairLocks, Trade
 from freqtrade.resolvers import StrategyResolver
 from freqtrade.strategy.hyper import detect_parameters
 from freqtrade.strategy.parameters import (BaseParameter, BooleanParameter, CategoricalParameter,
                                            DecimalParameter, IntParameter, RealParameter)
 from freqtrade.strategy.strategy_wrapper import strategy_safe_wrapper
+from freqtrade.util import dt_now
 from tests.conftest import (CURRENT_TEST_STRATEGY, TRADE_SIDES, create_mock_trades, log_has,
                             log_has_re)
 
 from .strats.strategy_test_v3 import StrategyTestV3
 
 
 # Avoid to reinit the same object again and again
 _STRATEGY = StrategyTestV3(config={})
 _STRATEGY.dp = DataProvider({}, None, None)
 
 
 def test_returns_latest_signal(ohlcv_history):
-    ohlcv_history.loc[1, 'date'] = arrow.utcnow()
+    ohlcv_history.loc[1, 'date'] = dt_now()
     # Take a copy to correctly modify the call
     mocked_history = ohlcv_history.copy()
     mocked_history['enter_long'] = 0
     mocked_history['exit_long'] = 0
     mocked_history['enter_short'] = 0
     mocked_history['exit_short'] = 0
     # Set tags in lines that don't matter to test nan in the sell line
@@ -155,15 +155,15 @@
     _STRATEGY.analyze_pair('foo')
     assert log_has_re(r'Strategy caused the following exception: xyz.*', caplog)
 
 
 def test_get_signal_old_dataframe(default_conf, mocker, caplog, ohlcv_history):
     # default_conf defines a 5m interval. we check interval * 2 + 5m
     # this is necessary as the last candle is removed (partial candles) by default
-    ohlcv_history.loc[1, 'date'] = arrow.utcnow().shift(minutes=-16)
+    ohlcv_history.loc[1, 'date'] = dt_now() - timedelta(minutes=16)
     # Take a copy to correctly modify the call
     mocked_history = ohlcv_history.copy()
     mocked_history['exit_long'] = 0
     mocked_history['enter_long'] = 0
     mocked_history.loc[1, 'enter_long'] = 1
 
     caplog.set_level(logging.INFO)
@@ -176,15 +176,15 @@
     )
     assert log_has('Outdated history for pair xyz. Last tick is 16 minutes old', caplog)
 
 
 def test_get_signal_no_sell_column(default_conf, mocker, caplog, ohlcv_history):
     # default_conf defines a 5m interval. we check interval * 2 + 5m
     # this is necessary as the last candle is removed (partial candles) by default
-    ohlcv_history.loc[1, 'date'] = arrow.utcnow()
+    ohlcv_history.loc[1, 'date'] = dt_now()
     # Take a copy to correctly modify the call
     mocked_history = ohlcv_history.copy()
     # Intentionally don't set sell column
     # mocked_history['sell'] = 0
     mocked_history['enter_long'] = 0
     mocked_history.loc[1, 'enter_long'] = 1
 
@@ -220,15 +220,15 @@
         current_time=current_time,
         timeframe_seconds=300,
         enter=True
     ) is not True
 
 
 def test_assert_df_raise(mocker, caplog, ohlcv_history):
-    ohlcv_history.loc[1, 'date'] = arrow.utcnow().shift(minutes=-16)
+    ohlcv_history.loc[1, 'date'] = dt_now() - timedelta(minutes=16)
     # Take a copy to correctly modify the call
     mocked_history = ohlcv_history.copy()
     mocked_history['sell'] = 0
     mocked_history['buy'] = 0
     mocked_history.loc[1, 'buy'] = 1
 
     caplog.set_level(logging.INFO)
@@ -319,29 +319,29 @@
     for roi in min_roi_list:
         strategy = StrategyResolver.load_strategy(default_conf)
         strategy.minimal_roi = roi
         trade = Trade(
             pair='ETH/BTC',
             stake_amount=0.001,
             amount=5,
-            open_date=arrow.utcnow().shift(hours=-1).datetime,
+            open_date=dt_now() - timedelta(hours=1),
             fee_open=fee.return_value,
             fee_close=fee.return_value,
             exchange='binance',
             open_rate=1,
         )
 
-        assert not strategy.min_roi_reached(trade, 0.02, arrow.utcnow().shift(minutes=-56).datetime)
-        assert strategy.min_roi_reached(trade, 0.12, arrow.utcnow().shift(minutes=-56).datetime)
+        assert not strategy.min_roi_reached(trade, 0.02, dt_now() - timedelta(minutes=56))
+        assert strategy.min_roi_reached(trade, 0.12, dt_now() - timedelta(minutes=56))
 
-        assert not strategy.min_roi_reached(trade, 0.04, arrow.utcnow().shift(minutes=-39).datetime)
-        assert strategy.min_roi_reached(trade, 0.06, arrow.utcnow().shift(minutes=-39).datetime)
+        assert not strategy.min_roi_reached(trade, 0.04, dt_now() - timedelta(minutes=39))
+        assert strategy.min_roi_reached(trade, 0.06, dt_now() - timedelta(minutes=39))
 
-        assert not strategy.min_roi_reached(trade, -0.01, arrow.utcnow().shift(minutes=-1).datetime)
-        assert strategy.min_roi_reached(trade, 0.02, arrow.utcnow().shift(minutes=-1).datetime)
+        assert not strategy.min_roi_reached(trade, -0.01, dt_now() - timedelta(minutes=1))
+        assert strategy.min_roi_reached(trade, 0.02, dt_now() - timedelta(minutes=1))
 
 
 def test_min_roi_reached2(default_conf, fee) -> None:
 
     # test with ROI raising after last interval
     min_roi_list = [{20: 0.07,
                      30: 0.05,
@@ -357,33 +357,33 @@
     for roi in min_roi_list:
         strategy = StrategyResolver.load_strategy(default_conf)
         strategy.minimal_roi = roi
         trade = Trade(
             pair='ETH/BTC',
             stake_amount=0.001,
             amount=5,
-            open_date=arrow.utcnow().shift(hours=-1).datetime,
+            open_date=dt_now() - timedelta(hours=1),
             fee_open=fee.return_value,
             fee_close=fee.return_value,
             exchange='binance',
             open_rate=1,
         )
 
-        assert not strategy.min_roi_reached(trade, 0.02, arrow.utcnow().shift(minutes=-56).datetime)
-        assert strategy.min_roi_reached(trade, 0.12, arrow.utcnow().shift(minutes=-56).datetime)
+        assert not strategy.min_roi_reached(trade, 0.02, dt_now() - timedelta(minutes=56))
+        assert strategy.min_roi_reached(trade, 0.12, dt_now() - timedelta(minutes=56))
 
-        assert not strategy.min_roi_reached(trade, 0.04, arrow.utcnow().shift(minutes=-39).datetime)
-        assert strategy.min_roi_reached(trade, 0.071, arrow.utcnow().shift(minutes=-39).datetime)
+        assert not strategy.min_roi_reached(trade, 0.04, dt_now() - timedelta(minutes=39))
+        assert strategy.min_roi_reached(trade, 0.071, dt_now() - timedelta(minutes=39))
 
-        assert not strategy.min_roi_reached(trade, 0.04, arrow.utcnow().shift(minutes=-26).datetime)
-        assert strategy.min_roi_reached(trade, 0.06, arrow.utcnow().shift(minutes=-26).datetime)
+        assert not strategy.min_roi_reached(trade, 0.04, dt_now() - timedelta(minutes=26))
+        assert strategy.min_roi_reached(trade, 0.06, dt_now() - timedelta(minutes=26))
 
         # Should not trigger with 20% profit since after 55 minutes only 30% is active.
-        assert not strategy.min_roi_reached(trade, 0.20, arrow.utcnow().shift(minutes=-2).datetime)
-        assert strategy.min_roi_reached(trade, 0.31, arrow.utcnow().shift(minutes=-2).datetime)
+        assert not strategy.min_roi_reached(trade, 0.20, dt_now() - timedelta(minutes=2))
+        assert strategy.min_roi_reached(trade, 0.31, dt_now() - timedelta(minutes=2))
 
 
 def test_min_roi_reached3(default_conf, fee) -> None:
 
     # test for issue #1948
     min_roi = {20: 0.07,
                30: 0.05,
@@ -391,33 +391,33 @@
                }
     strategy = StrategyResolver.load_strategy(default_conf)
     strategy.minimal_roi = min_roi
     trade = Trade(
         pair='ETH/BTC',
         stake_amount=0.001,
         amount=5,
-        open_date=arrow.utcnow().shift(hours=-1).datetime,
+        open_date=dt_now() - timedelta(hours=1),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=1,
     )
 
-    assert not strategy.min_roi_reached(trade, 0.02, arrow.utcnow().shift(minutes=-56).datetime)
-    assert not strategy.min_roi_reached(trade, 0.12, arrow.utcnow().shift(minutes=-56).datetime)
+    assert not strategy.min_roi_reached(trade, 0.02, dt_now() - timedelta(minutes=56))
+    assert not strategy.min_roi_reached(trade, 0.12, dt_now() - timedelta(minutes=56))
 
-    assert not strategy.min_roi_reached(trade, 0.04, arrow.utcnow().shift(minutes=-39).datetime)
-    assert strategy.min_roi_reached(trade, 0.071, arrow.utcnow().shift(minutes=-39).datetime)
+    assert not strategy.min_roi_reached(trade, 0.04, dt_now() - timedelta(minutes=39))
+    assert strategy.min_roi_reached(trade, 0.071, dt_now() - timedelta(minutes=39))
 
-    assert not strategy.min_roi_reached(trade, 0.04, arrow.utcnow().shift(minutes=-26).datetime)
-    assert strategy.min_roi_reached(trade, 0.06, arrow.utcnow().shift(minutes=-26).datetime)
+    assert not strategy.min_roi_reached(trade, 0.04, dt_now() - timedelta(minutes=26))
+    assert strategy.min_roi_reached(trade, 0.06, dt_now() - timedelta(minutes=26))
 
     # Should not trigger with 20% profit since after 55 minutes only 30% is active.
-    assert not strategy.min_roi_reached(trade, 0.20, arrow.utcnow().shift(minutes=-2).datetime)
-    assert strategy.min_roi_reached(trade, 0.31, arrow.utcnow().shift(minutes=-2).datetime)
+    assert not strategy.min_roi_reached(trade, 0.20, dt_now() - timedelta(minutes=2))
+    assert strategy.min_roi_reached(trade, 0.31, dt_now() - timedelta(minutes=2))
 
 
 @pytest.mark.parametrize(
     'profit,adjusted,expected,liq,trailing,custom,profit2,adjusted2,expected2,custom_stop', [
         # Profit, adjusted stoploss(absolute), profit for 2nd call, enable trailing,
         #   enable custom stoploss, expected after 1st call, expected after 2nd call
         (0.2, 0.9, ExitType.NONE, None, False, False, 0.3, 0.9, ExitType.NONE, None),
@@ -445,30 +445,30 @@
                              profit2, adjusted2, expected2, custom_stop) -> None:
 
     strategy = StrategyResolver.load_strategy(default_conf)
     trade = Trade(
         pair='ETH/BTC',
         stake_amount=0.01,
         amount=1,
-        open_date=arrow.utcnow().shift(hours=-1).datetime,
+        open_date=dt_now() - timedelta(hours=1),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=1,
         liquidation_price=liq,
     )
     trade.adjust_min_max_rates(trade.open_rate, trade.open_rate)
     strategy.trailing_stop = trailing
     strategy.trailing_stop_positive = -0.05
     strategy.use_custom_stoploss = custom
     original_stopvalue = strategy.custom_stoploss
     if custom_stop:
         strategy.custom_stoploss = custom_stop
 
-    now = arrow.utcnow().datetime
+    now = dt_now()
     current_rate = trade.open_rate * (1 + profit)
     sl_flag = strategy.ft_stoploss_reached(current_rate=current_rate, trade=trade,
                                            current_time=now, current_profit=profit,
                                            force_stoploss=0, high=None)
     assert isinstance(sl_flag, ExitCheckTuple)
     assert sl_flag.exit_type == expected
     if expected == ExitType.NONE:
@@ -494,22 +494,22 @@
 def test_custom_exit(default_conf, fee, caplog) -> None:
 
     strategy = StrategyResolver.load_strategy(default_conf)
     trade = Trade(
         pair='ETH/BTC',
         stake_amount=0.01,
         amount=1,
-        open_date=arrow.utcnow().shift(hours=-1).datetime,
+        open_date=dt_now() - timedelta(hours=1),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=1,
     )
 
-    now = arrow.utcnow().datetime
+    now = dt_now()
     res = strategy.should_exit(trade, 1, now,
                                enter=False, exit_=False,
                                low=None, high=None)
 
     assert res == []
 
     strategy.custom_exit = MagicMock(return_value=True)
@@ -543,21 +543,21 @@
 def test_should_sell(default_conf, fee) -> None:
 
     strategy = StrategyResolver.load_strategy(default_conf)
     trade = Trade(
         pair='ETH/BTC',
         stake_amount=0.01,
         amount=1,
-        open_date=arrow.utcnow().shift(hours=-1).datetime,
+        open_date=dt_now() - timedelta(hours=1),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         exchange='binance',
         open_rate=1,
     )
-    now = arrow.utcnow().datetime
+    now = dt_now()
     res = strategy.should_exit(trade, 1, now,
                                enter=False, exit_=False,
                                low=None, high=None)
 
     assert res == []
     strategy.min_roi_reached = MagicMock(return_value=True)
 
@@ -724,15 +724,15 @@
     PairLocks.use_db = True
     strategy = StrategyResolver.load_strategy(default_conf)
     # No lock should be present
     assert len(PairLocks.get_pair_locks(None)) == 0
 
     pair = 'ETH/BTC'
     assert not strategy.is_pair_locked(pair)
-    strategy.lock_pair(pair, arrow.now(timezone.utc).shift(minutes=4).datetime)
+    strategy.lock_pair(pair, dt_now() + timedelta(minutes=4))
     # ETH/BTC locked for 4 minutes
     assert strategy.is_pair_locked(pair)
 
     # XRP/BTC should not be locked now
     pair = 'XRP/BTC'
     assert not strategy.is_pair_locked(pair)
 
@@ -742,15 +742,15 @@
     # Unlock original pair
     pair = 'ETH/BTC'
     strategy.unlock_pair(pair)
     assert not strategy.is_pair_locked(pair)
 
     # Lock with reason
     reason = "TestLockR"
-    strategy.lock_pair(pair, arrow.now(timezone.utc).shift(minutes=4).datetime, reason)
+    strategy.lock_pair(pair, dt_now() + timedelta(minutes=4), reason)
     assert strategy.is_pair_locked(pair)
     strategy.unlock_reason(reason)
     assert not strategy.is_pair_locked(pair)
 
     pair = 'BTC/USDT'
     # Lock until 14:30
     lock_time = datetime(2020, 5, 1, 14, 30, 0, tzinfo=timezone.utc)
```

### Comparing `freqtrade-2023.4/tests/strategy/test_strategy_helpers.py` & `freqtrade-2023.5/tests/strategy/test_strategy_helpers.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/strategy/test_strategy_loading.py` & `freqtrade-2023.5/tests/strategy/test_strategy_loading.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/test_arguments.py` & `freqtrade-2023.5/tests/test_arguments.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/test_binance_mig.py` & `freqtrade-2023.5/tests/test_binance_mig.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/test_configuration.py` & `freqtrade-2023.5/tests/test_configuration.py`

 * *Files 1% similar despite different names*

```diff
@@ -1267,15 +1267,15 @@
     args = Arguments(arglist).get_parsed_arg()
 
     with pytest.raises(OperationalException, match=r"No pairs file found with path.*"):
         configuration = Configuration(args)
         configuration.get_config()
 
 
-def test_pairlist_resolving_fallback(mocker):
+def test_pairlist_resolving_fallback(mocker, tmpdir):
     mocker.patch.object(Path, "exists", MagicMock(return_value=True))
     mocker.patch.object(Path, "open", MagicMock(return_value=MagicMock()))
     mocker.patch("freqtrade.configuration.configuration.load_file",
                  MagicMock(return_value=['XRP/BTC', 'ETH/BTC']))
     arglist = [
         'download-data',
         '--exchange', 'binance'
@@ -1286,15 +1286,15 @@
     args['config'] = None
 
     configuration = Configuration(args, RunMode.OTHER)
     config = configuration.get_config()
 
     assert config['pairs'] == ['ETH/BTC', 'XRP/BTC']
     assert config['exchange']['name'] == 'binance'
-    assert config['datadir'] == Path.cwd() / "user_data/data/binance"
+    assert config['datadir'] == Path(tmpdir) / "user_data/data/binance"
 
 
 @pytest.mark.parametrize("setting", [
     ("webhook", "webhookbuy", 'testWEbhook',
      "webhook", "webhookentry", 'testWEbhook'),
     ("ask_strategy", "ignore_buying_expired_candle_after", 5,
      None, "ignore_buying_expired_candle_after", 6),
```

### Comparing `freqtrade-2023.4/tests/test_directory_operations.py` & `freqtrade-2023.5/tests/test_directory_operations.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/test_freqtradebot.py` & `freqtrade-2023.5/tests/test_freqtradebot.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,31 +1,32 @@
 # pragma pylint: disable=missing-docstring, C0103
 # pragma pylint: disable=protected-access, too-many-lines, invalid-name, too-many-arguments
 
 import logging
 import time
 from copy import deepcopy
+from datetime import timedelta
 from typing import List
 from unittest.mock import ANY, MagicMock, PropertyMock, patch
 
-import arrow
 import pytest
 from pandas import DataFrame
 from sqlalchemy import select
 
 from freqtrade.constants import CANCEL_REASON, UNLIMITED_STAKE_AMOUNT
 from freqtrade.enums import (CandleType, ExitCheckTuple, ExitType, RPCMessageType, RunMode,
                              SignalDirection, State)
 from freqtrade.exceptions import (DependencyException, ExchangeError, InsufficientFundsError,
                                   InvalidOrderException, OperationalException, PricingError,
                                   TemporaryError)
 from freqtrade.freqtradebot import FreqtradeBot
 from freqtrade.persistence import Order, PairLocks, Trade
 from freqtrade.persistence.models import PairLock
 from freqtrade.plugins.protections.iprotection import ProtectionReturn
+from freqtrade.util.datetime_helpers import dt_now, dt_utc
 from freqtrade.worker import Worker
 from tests.conftest import (EXMS, create_mock_trades, create_mock_trades_usdt,
                             get_patched_freqtradebot, get_patched_worker, log_has, log_has_re,
                             patch_edge, patch_exchange, patch_get_signal, patch_wallet,
                             patch_whitelist)
 from tests.conftest_trades import (MOCK_TRADE_COUNT, entry_side, exit_side, mock_order_1,
                                    mock_order_2, mock_order_2_sell, mock_order_3, mock_order_3_sell,
@@ -117,42 +118,70 @@
         'stoploss': 'limit',
         'stoploss_on_exchange': True,
     }
     conf['entry_pricing']['price_side'] = 'ask'
 
     freqtrade = FreqtradeBot(conf)
     if runmode == RunMode.LIVE:
-        assert not log_has_re(".*stoploss_on_exchange .* dry-run", caplog)
+        assert not log_has_re(r".*stoploss_on_exchange .* dry-run", caplog)
     assert freqtrade.strategy.order_types['stoploss_on_exchange']
 
     caplog.clear()
     # is left untouched
     conf = default_conf_usdt.copy()
     conf['runmode'] = runmode
     conf['order_types'] = {
         'entry': 'market',
         'exit': 'limit',
         'stoploss': 'limit',
         'stoploss_on_exchange': False,
     }
     freqtrade = FreqtradeBot(conf)
     assert not freqtrade.strategy.order_types['stoploss_on_exchange']
-    assert not log_has_re(".*stoploss_on_exchange .* dry-run", caplog)
+    assert not log_has_re(r".*stoploss_on_exchange .* dry-run", caplog)
 
 
 def test_get_trade_stake_amount(default_conf_usdt, mocker) -> None:
     patch_RPCManager(mocker)
     patch_exchange(mocker)
 
     freqtrade = FreqtradeBot(default_conf_usdt)
 
     result = freqtrade.wallets.get_trade_stake_amount('ETH/USDT')
     assert result == default_conf_usdt['stake_amount']
 
 
+@pytest.mark.parametrize('runmode', [
+    RunMode.DRY_RUN,
+    RunMode.LIVE
+])
+def test_load_strategy_no_keys(default_conf_usdt, mocker, runmode, caplog) -> None:
+    patch_RPCManager(mocker)
+    patch_exchange(mocker)
+    conf = deepcopy(default_conf_usdt)
+    conf['runmode'] = runmode
+    erm = mocker.patch('freqtrade.freqtradebot.ExchangeResolver.load_exchange')
+
+    freqtrade = FreqtradeBot(conf)
+    strategy_config = freqtrade.strategy.config
+    assert id(strategy_config['exchange']) == id(conf['exchange'])
+    # Keys have been removed and are not passed to the exchange
+    assert strategy_config['exchange']['key'] == ''
+    assert strategy_config['exchange']['secret'] == ''
+
+    assert erm.call_count == 1
+    ex_conf = erm.call_args_list[0][1]['exchange_config']
+    assert id(ex_conf) != id(conf['exchange'])
+    # Keys are still present
+    assert ex_conf['key'] != ''
+    assert ex_conf['key'] == default_conf_usdt['exchange']['key']
+    assert ex_conf['secret'] != ''
+    assert ex_conf['secret'] == default_conf_usdt['exchange']['secret']
+
+
 @pytest.mark.parametrize("amend_last,wallet,max_open,lsamr,expected", [
                         (False, 120, 2, 0.5, [60, None]),
                         (True, 120, 2, 0.5, [60, 58.8]),
                         (False, 180, 3, 0.5, [60, 60, None]),
                         (True, 180, 3, 0.5, [60, 60, 58.2]),
                         (False, 122, 3, 0.5, [60, 60, None]),
                         (True, 122, 3, 0.5, [60, 60, 0.0]),
@@ -441,15 +470,15 @@
     message = r"Global pairlock active until.* Not creating new trades."
     n = freqtrade.enter_positions()
     # 0 trades, but it's not because of pairlock.
     assert n == 0
     assert not log_has_re(message, caplog)
     caplog.clear()
 
-    PairLocks.lock_pair('*', arrow.utcnow().shift(minutes=20).datetime, 'Just because', side='*')
+    PairLocks.lock_pair('*', dt_now() + timedelta(minutes=20), 'Just because', side='*')
     n = freqtrade.enter_positions()
     assert n == 0
     assert log_has_re(message, caplog)
 
 
 @pytest.mark.parametrize('is_short', [False, True])
 def test_handle_protections(mocker, default_conf_usdt, fee, is_short):
@@ -462,15 +491,15 @@
             "stop_duration_candles": 4,
             "only_per_pair": False
         }
     ]
 
     freqtrade = get_patched_freqtradebot(mocker, default_conf_usdt)
     freqtrade.protections._protection_handlers[1].global_stop = MagicMock(
-        return_value=ProtectionReturn(True, arrow.utcnow().shift(hours=1).datetime, "asdf"))
+        return_value=ProtectionReturn(True, dt_now() + timedelta(hours=1), "asdf"))
     create_mock_trades(fee, is_short)
     freqtrade.handle_protections('ETC/BTC', '*')
     send_msg_mock = freqtrade.rpc.send_msg
     assert send_msg_mock.call_count == 2
     assert send_msg_mock.call_args_list[0][0][0]['type'] == RPCMessageType.PROTECTION_TRIGGER
     assert send_msg_mock.call_args_list[1][0][0]['type'] == RPCMessageType.PROTECTION_TRIGGER_GLOBAL
 
@@ -1258,15 +1287,15 @@
         'amount': enter_order['amount'],
         'filled': 0,
         'remaining': enter_order['amount'],
         'info': {'stopPrice': 22},
     }])
     trade.stoploss_order_id = "107"
     trade.is_open = True
-    trade.stoploss_last_update = arrow.utcnow().shift(hours=-1).datetime
+    trade.stoploss_last_update = dt_now() - timedelta(hours=1)
     trade.stop_loss = 24
     trade.exit_reason = None
     trade.orders.append(
         Order(
             ft_order_side='stoploss',
             ft_pair=trade.pair,
             ft_is_open=True,
@@ -1407,15 +1436,15 @@
         'average': 2,
         'filled': trade.amount / 2,
         'remaining': trade.amount / 2,
         'amount': enter_order['amount'],
     })
     mocker.patch(f'{EXMS}.fetch_stoploss_order', stoploss_order_hit)
     mocker.patch(f'{EXMS}.cancel_stoploss_order_with_result', stoploss_order_cancel)
-    trade.stoploss_last_update = arrow.utcnow().shift(minutes=-10).datetime
+    trade.stoploss_last_update = dt_now() - timedelta(minutes=10)
 
     assert freqtrade.handle_stoploss_on_exchange(trade) is False
     # Canceled Stoploss filled partially ...
     assert log_has_re('Cancelling current stoploss on exchange.*', caplog)
 
     assert trade.stoploss_order_id == "102"
     assert trade.amount == 15
@@ -1627,15 +1656,15 @@
 
     freqtrade.enter_positions()
     trade = Trade.session.scalars(select(Trade)).first()
     trade.is_short = is_short
     trade.is_open = True
     trade.open_order_id = None
     trade.stoploss_order_id = '100'
-    trade.stoploss_last_update = arrow.utcnow().shift(minutes=-20).datetime
+    trade.stoploss_last_update = dt_now() - timedelta(minutes=20)
     trade.orders.append(
         Order(
             ft_order_side='stoploss',
             ft_pair=trade.pair,
             ft_is_open=True,
             ft_amount=trade.amount,
             ft_price=trade.stop_loss,
@@ -1758,15 +1787,15 @@
     freqtrade.enter_positions()
     trade = Trade.session.scalars(select(Trade)).first()
     trade.is_short = is_short
     trade.is_open = True
     trade.open_order_id = None
     trade.stoploss_order_id = "abcd"
     trade.stop_loss = 0.2
-    trade.stoploss_last_update = arrow.utcnow().shift(minutes=-601).datetime.replace(tzinfo=None)
+    trade.stoploss_last_update = (dt_now() - timedelta(minutes=601)).replace(tzinfo=None)
     trade.is_short = is_short
 
     stoploss_order_hanging = {
         'id': "abcd",
         'status': 'open',
         'type': 'stop_loss_limit',
         'price': 3,
@@ -1782,15 +1811,15 @@
     freqtrade.handle_trailing_stoploss_on_exchange(trade, stoploss_order_hanging)
     assert log_has_re(r"Could not cancel stoploss order abcd for pair ETH/USDT.*", caplog)
 
     # Still try to create order
     assert stoploss.call_count == 1
 
     # Fail creating stoploss order
-    trade.stoploss_last_update = arrow.utcnow().shift(minutes=-601).datetime
+    trade.stoploss_last_update = dt_now() - timedelta(minutes=601)
     caplog.clear()
     cancel_mock = mocker.patch(f'{EXMS}.cancel_stoploss_order')
     mocker.patch(f'{EXMS}.create_stoploss', side_effect=ExchangeError())
     freqtrade.handle_trailing_stoploss_on_exchange(trade, stoploss_order_hanging)
     assert cancel_mock.call_count == 1
     assert log_has_re(r"Could not create trailing stoploss order for pair ETH/USDT\..*", caplog)
 
@@ -1871,15 +1900,15 @@
 
     freqtrade.enter_positions()
     trade = Trade.session.scalars(select(Trade)).first()
     trade.is_short = is_short
     trade.is_open = True
     trade.open_order_id = None
     trade.stoploss_order_id = '100'
-    trade.stoploss_last_update = arrow.utcnow().shift(minutes=-601).datetime
+    trade.stoploss_last_update = dt_now() - timedelta(minutes=601)
     trade.orders.append(
         Order(
             ft_order_side='stoploss',
             ft_pair=trade.pair,
             ft_is_open=True,
             ft_amount=trade.amount,
             ft_price=trade.stop_loss,
@@ -2009,15 +2038,15 @@
     freqtrade.active_pair_whitelist = freqtrade.edge.adjust(freqtrade.active_pair_whitelist)
 
     freqtrade.enter_positions()
     trade = Trade.session.scalars(select(Trade)).first()
     trade.is_open = True
     trade.open_order_id = None
     trade.stoploss_order_id = '100'
-    trade.stoploss_last_update = arrow.utcnow().datetime
+    trade.stoploss_last_update = dt_now()
     trade.orders.append(
         Order(
             ft_order_side='stoploss',
             ft_pair=trade.pair,
             ft_is_open=True,
             ft_amount=trade.amount,
             ft_price=trade.stop_loss,
@@ -2103,51 +2132,96 @@
     n = freqtrade.enter_positions()
     assert n == 0
     assert log_has(log_message, caplog)
     # create_trade should be called once for every pair in the whitelist.
     assert mock_ct.call_count == len(default_conf_usdt['exchange']['pair_whitelist'])
 
 
+@pytest.mark.usefixtures("init_persistence")
 @pytest.mark.parametrize("is_short", [False, True])
 def test_exit_positions(mocker, default_conf_usdt, limit_order, is_short, caplog) -> None:
     freqtrade = get_patched_freqtradebot(mocker, default_conf_usdt)
 
     mocker.patch('freqtrade.freqtradebot.FreqtradeBot.handle_trade', MagicMock(return_value=True))
     mocker.patch(f'{EXMS}.fetch_order', return_value=limit_order[entry_side(is_short)])
     mocker.patch(f'{EXMS}.get_trades_for_order', return_value=[])
 
-    # TODO: should not be magicmock
-    trade = MagicMock()
-    trade.is_short = is_short
-    trade.open_order_id = '123'
-    trade.open_fee = 0.001
+    order_id = '123'
+    trade = Trade(
+            open_order_id=order_id,
+            pair='ETH/USDT',
+            fee_open=0.001,
+            fee_close=0.001,
+            open_rate=0.01,
+            open_date=dt_now(),
+            stake_amount=0.01,
+            amount=11,
+            exchange="binance",
+            is_short=is_short,
+            leverage=1,
+            )
+    trade.orders.append(Order(
+        ft_order_side=entry_side(is_short),
+        price=0.01,
+        ft_pair=trade.pair,
+        ft_amount=trade.amount,
+        ft_price=trade.open_rate,
+        order_id=order_id,
+
+    ))
+    Trade.session.add(trade)
+    Trade.commit()
     trades = [trade]
+    freqtrade.wallets.update()
     n = freqtrade.exit_positions(trades)
     assert n == 0
     # Test amount not modified by fee-logic
     assert not log_has_re(r'Applying fee to amount for Trade .*', caplog)
 
     gra = mocker.patch('freqtrade.freqtradebot.FreqtradeBot.get_real_amount', return_value=0.0)
     # test amount modified by fee-logic
     n = freqtrade.exit_positions(trades)
     assert n == 0
     assert gra.call_count == 0
 
 
+@pytest.mark.usefixtures("init_persistence")
 @pytest.mark.parametrize("is_short", [False, True])
 def test_exit_positions_exception(mocker, default_conf_usdt, limit_order, caplog, is_short) -> None:
     freqtrade = get_patched_freqtradebot(mocker, default_conf_usdt)
     order = limit_order[entry_side(is_short)]
     mocker.patch(f'{EXMS}.fetch_order', return_value=order)
 
-    # TODO: should not be magicmock
-    trade = MagicMock()
-    trade.is_short = is_short
+    order_id = '123'
+    trade = Trade(
+        open_order_id=order_id,
+        pair='ETH/USDT',
+        fee_open=0.001,
+        fee_close=0.001,
+        open_rate=0.01,
+        open_date=dt_now(),
+        stake_amount=0.01,
+        amount=11,
+        exchange="binance",
+        is_short=is_short,
+        leverage=1,
+    )
+    trade.orders.append(Order(
+        ft_order_side=entry_side(is_short),
+        price=0.01,
+        ft_pair=trade.pair,
+        ft_amount=trade.amount,
+        ft_price=trade.open_rate,
+        order_id=order_id,
+
+    ))
     trade.open_order_id = None
-    trade.pair = 'ETH/USDT'
+    Trade.session.add(trade)
+    Trade.commit()
+    freqtrade.wallets.update()
     trades = [trade]
 
     # Test raise of DependencyException exception
     mocker.patch(
         'freqtrade.freqtradebot.FreqtradeBot.handle_trade',
         side_effect=DependencyException()
     )
@@ -2169,15 +2243,15 @@
     order_id = order['id']
 
     trade = Trade(
         open_order_id=order_id,
         fee_open=0.001,
         fee_close=0.001,
         open_rate=0.01,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         amount=11,
         exchange="binance",
         is_short=is_short,
         leverage=1,
     )
     trade.orders.append(Order(
         ft_order_side=entry_side(is_short),
@@ -2242,15 +2316,15 @@
     freqtrade = get_patched_freqtradebot(mocker, default_conf_usdt)
     caplog.clear()
     trade = Trade(
         pair='LTC/USDT',
         amount=amount,
         exchange='binance',
         open_rate=2.0,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         open_order_id=order_id,
         is_open=True,
         leverage=1,
         is_short=is_short,
     )
@@ -2329,15 +2403,15 @@
     trade = Trade(
         pair='LTC/ETH',
         amount=amount,
         exchange='binance',
         open_rate=0.245441,
         fee_open=0.0025,
         fee_close=0.0025,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         open_order_id=open_order['id'],
         is_open=True,
         interest_rate=0.0005,
         leverage=1,
         is_short=is_short,
     )
     order = Order.parse_from_ccxt_object(buy_order, 'LTC/ETH', entry_side(is_short))
@@ -2915,16 +2989,16 @@
         EXMS,
         fetch_ticker=ticker_usdt,
         fetch_order=MagicMock(return_value=limit_sell_order_old),
         cancel_order=cancel_order_mock
     )
     freqtrade = FreqtradeBot(default_conf_usdt)
 
-    open_trade_usdt.open_date = arrow.utcnow().shift(hours=-5).datetime
-    open_trade_usdt.close_date = arrow.utcnow().shift(minutes=-601).datetime
+    open_trade_usdt.open_date = dt_now() - timedelta(hours=5)
+    open_trade_usdt.close_date = dt_now() - timedelta(minutes=601)
     open_trade_usdt.close_profit_abs = 0.001
 
     Trade.session.add(open_trade_usdt)
     Trade.commit()
     # Ensure default is false
     freqtrade.manage_open_orders()
     assert cancel_order_mock.call_count == 0
@@ -2997,16 +3071,16 @@
         fetch_ticker=ticker_usdt,
         fetch_order=MagicMock(return_value=limit_sell_order_old),
         cancel_order=cancel_order_mock,
         get_min_pair_stake_amount=MagicMock(return_value=0),
     )
     freqtrade = FreqtradeBot(default_conf_usdt)
 
-    open_trade_usdt.open_date = arrow.utcnow().shift(hours=-5).datetime
-    open_trade_usdt.close_date = arrow.utcnow().shift(minutes=-601).datetime
+    open_trade_usdt.open_date = dt_now() - timedelta(hours=5)
+    open_trade_usdt.close_date = dt_now() - timedelta(minutes=601)
     open_trade_usdt.close_profit_abs = 0.001
     open_trade_usdt.is_short = is_short
 
     Trade.session.add(open_trade_usdt)
     Trade.commit()
 
     freqtrade.strategy.check_exit_timeout = MagicMock(return_value=False)
@@ -3038,16 +3112,16 @@
         EXMS,
         fetch_ticker=ticker_usdt,
         fetch_order=MagicMock(return_value=limit_sell_order_old),
         cancel_order_with_result=cancel_order_mock
     )
     freqtrade = FreqtradeBot(default_conf_usdt)
 
-    open_trade_usdt.open_date = arrow.utcnow().shift(hours=-5).datetime
-    open_trade_usdt.close_date = arrow.utcnow().shift(minutes=-601).datetime
+    open_trade_usdt.open_date = dt_now() - timedelta(hours=5)
+    open_trade_usdt.close_date = dt_now() - timedelta(minutes=601)
     open_trade_usdt.is_short = is_short
 
     Trade.session.add(open_trade_usdt)
     Trade.commit()
 
     # check it does cancel sell orders over the time limit
     freqtrade.manage_open_orders()
@@ -3367,19 +3441,19 @@
 
     trade = Trade(
         pair='LTC/ETH',
         amount=2,
         exchange='binance',
         open_rate=0.245441,
         open_order_id="sell_123456",
-        open_date=arrow.utcnow().shift(days=-2).datetime,
+        open_date=dt_now() - timedelta(days=2),
         fee_open=fee.return_value,
         fee_close=fee.return_value,
         close_rate=0.555,
-        close_date=arrow.utcnow().datetime,
+        close_date=dt_now(),
         exit_reason="sell_reason_whatever",
         stake_amount=0.245441 * 2,
     )
     trade.orders = [
         Order(
             ft_order_side='buy',
             ft_pair=trade.pair,
@@ -5388,15 +5462,15 @@
 
     # Test with trade without orders
     trade = Trade(
         pair='XRP/ETH',
         stake_amount=60.0,
         fee_open=fee.return_value,
         fee_close=fee.return_value,
-        open_date=arrow.utcnow().datetime,
+        open_date=dt_now(),
         is_open=True,
         amount=30,
         open_rate=2.0,
         exchange='binance',
         is_short=is_short
     )
     Trade.session.add(trade)
@@ -5503,14 +5577,59 @@
                            side_effect=ExchangeError())
     order = mock_order_5_stoploss(is_short=is_short)
 
     freqtrade.handle_insufficient_funds(trades[4])
     assert log_has(f"Error updating {order['id']}.", caplog)
 
 
+@pytest.mark.usefixtures("init_persistence")
+@pytest.mark.parametrize("is_short", [False, True])
+def test_handle_onexchange_order(mocker, default_conf_usdt, limit_order, is_short, caplog):
+    freqtrade = get_patched_freqtradebot(mocker, default_conf_usdt)
+    mock_uts = mocker.spy(freqtrade, 'update_trade_state')
+
+    entry_order = limit_order[entry_side(is_short)]
+    exit_order = limit_order[exit_side(is_short)]
+    mock_fo = mocker.patch(f'{EXMS}.fetch_orders', return_value=[
+        entry_order,
+        exit_order,
+    ])
+
+    order_id = entry_order['id']
+
+    trade = Trade(
+            open_order_id=order_id,
+            pair='ETH/USDT',
+            fee_open=0.001,
+            fee_close=0.001,
+            open_rate=entry_order['price'],
+            open_date=dt_now(),
+            stake_amount=entry_order['cost'],
+            amount=entry_order['amount'],
+            exchange="binance",
+            is_short=is_short,
+            leverage=1,
+            )
+
+    trade.orders.append(Order.parse_from_ccxt_object(
+        entry_order, 'ADA/USDT', entry_side(is_short))
+    )
+    Trade.session.add(trade)
+    freqtrade.handle_onexchange_order(trade)
+    assert log_has_re(r"Found previously unknown order .*", caplog)
+    assert mock_uts.call_count == 1
+    assert mock_fo.call_count == 1
+
+    trade = Trade.session.scalars(select(Trade)).first()
+
+    assert len(trade.orders) == 2
+    assert trade.is_open is False
+    assert trade.exit_reason == ExitType.SOLD_ON_EXCHANGE.value
+
+
 def test_get_valid_price(mocker, default_conf_usdt) -> None:
     patch_RPCManager(mocker)
     patch_exchange(mocker)
     freqtrade = FreqtradeBot(default_conf_usdt)
     freqtrade.config['custom_price_max_distance_ratio'] = 0.02
 
     custom_price_string = "10"
@@ -5617,17 +5736,17 @@
     enter_rate_mock = MagicMock(return_value=bid)
     enter_mm = MagicMock(return_value=open_order)
     patch_RPCManager(mocker)
     patch_exchange(mocker)
     default_conf['trading_mode'] = 'futures'
     default_conf['margin_mode'] = 'isolated'
 
-    date_midnight = arrow.get('2021-09-01 00:00:00').datetime
-    date_eight = arrow.get('2021-09-01 08:00:00').datetime
-    date_sixteen = arrow.get('2021-09-01 16:00:00').datetime
+    date_midnight = dt_utc(2021, 9, 1)
+    date_eight = dt_utc(2021, 9, 1, 8)
+    date_sixteen = dt_utc(2021, 9, 1, 16)
     columns = ['date', 'open', 'high', 'low', 'close', 'volume']
     # 16:00 entry is actually never used
     # But should be kept in the test to ensure we're filtering correctly.
     funding_rates = {
         "LTC/USDT":
             DataFrame([
                 [date_midnight, 0.00032583, 0, 0, 0, 0],
@@ -5908,15 +6027,15 @@
         'average': 9,
         'amount': 12,
         'filled': 12,
         'cost': 108,
         'ft_is_open': False,
         'id': '651',
         'order_id': '651',
-        'datetime': arrow.utcnow().isoformat(),
+        'datetime': dt_now().isoformat(),
     }
 
     mocker.patch(f'{EXMS}.create_order', MagicMock(return_value=closed_dca_order_1))
     mocker.patch(f'{EXMS}.fetch_order', MagicMock(return_value=closed_dca_order_1))
     mocker.patch(f'{EXMS}.fetch_order_or_stoploss_order',
                  MagicMock(return_value=closed_dca_order_1))
     freqtrade.manage_open_orders()
```

### Comparing `freqtrade-2023.4/tests/test_indicators.py` & `freqtrade-2023.5/tests/test_indicators.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/test_integration.py` & `freqtrade-2023.5/tests/test_integration.py`

 * *Files 1% similar despite different names*

```diff
@@ -71,16 +71,17 @@
 
     mocker.patch.multiple(
         'freqtrade.freqtradebot.FreqtradeBot',
         create_stoploss_order=MagicMock(return_value=True),
         _notify_exit=MagicMock(),
     )
     mocker.patch("freqtrade.strategy.interface.IStrategy.should_exit", should_sell_mock)
-    wallets_mock = mocker.patch("freqtrade.wallets.Wallets.update", MagicMock())
-    mocker.patch("freqtrade.wallets.Wallets.get_free", MagicMock(return_value=1000))
+    wallets_mock = mocker.patch("freqtrade.wallets.Wallets.update")
+    mocker.patch("freqtrade.wallets.Wallets.get_free", return_value=1000)
+    mocker.patch("freqtrade.wallets.Wallets.check_exit_amount", return_value=True)
 
     freqtrade = get_patched_freqtradebot(mocker, default_conf)
     freqtrade.strategy.order_types['stoploss_on_exchange'] = True
     # Switch ordertype to market to close trade immediately
     freqtrade.strategy.order_types['exit'] = 'market'
     freqtrade.strategy.confirm_trade_entry = MagicMock(return_value=True)
     freqtrade.strategy.confirm_trade_exit = MagicMock(return_value=True)
```

### Comparing `freqtrade-2023.4/tests/test_main.py` & `freqtrade-2023.5/tests/test_main.py`

 * *Files identical despite different names*

### Comparing `freqtrade-2023.4/tests/test_misc.py` & `freqtrade-2023.5/tests/test_misc.py`

 * *Files 5% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 import pandas as pd
 import pytest
 
 from freqtrade.misc import (dataframe_to_json, decimals_per_coin, deep_merge_dicts, file_dump_json,
                             file_load_json, format_ms_time, json_to_dataframe, pair_to_filename,
                             parse_db_uri_for_logging, plural, render_template,
                             render_template_with_fallback, round_coin_value, safe_value_fallback,
-                            safe_value_fallback2, shorten_date)
+                            safe_value_fallback2)
 
 
 def test_decimals_per_coin():
     assert decimals_per_coin('USDT') == 3
     assert decimals_per_coin('EUR') == 3
     assert decimals_per_coin('BTC') == 8
     assert decimals_per_coin('ETH') == 5
@@ -35,20 +35,14 @@
     assert round_coin_value(222.00, 'USDT', False) == '222'
     assert round_coin_value(222.12745, 'EUR', False) == '222.127'
     assert round_coin_value(0.1274512123, 'BTC', False) == '0.12745121'
     assert round_coin_value(0.1274512123, 'ETH', False) == '0.12745'
     assert round_coin_value(222.2, 'USDT', False, True) == '222.200'
 
 
-def test_shorten_date() -> None:
-    str_data = '1 day, 2 hours, 3 minutes, 4 seconds ago'
-    str_shorten_data = '1 d, 2 h, 3 min, 4 sec ago'
-    assert shorten_date(str_data) == str_shorten_data
-
-
 def test_file_dump_json(mocker) -> None:
     file_open = mocker.patch('freqtrade.misc.Path.open', MagicMock())
     json_dump = mocker.patch('rapidjson.dump', MagicMock())
     file_dump_json(Path('somefile'), [1, 2, 3])
     assert file_open.call_count == 1
     assert json_dump.call_count == 1
     file_open = mocker.patch('freqtrade.misc.gzip.open', MagicMock())
```

### Comparing `freqtrade-2023.4/tests/test_plotting.py` & `freqtrade-2023.5/tests/test_plotting.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,9 +1,8 @@
 from copy import deepcopy
-from pathlib import Path
 from unittest.mock import MagicMock
 
 import pandas as pd
 import plotly.graph_objects as go
 import pytest
 from plotly.subplots import make_subplots
 
@@ -278,21 +277,21 @@
 
 
 def test_generate_Plot_filename():
     fn = generate_plot_filename("UNITTEST/BTC", "5m")
     assert fn == "freqtrade-plot-UNITTEST_BTC-5m.html"
 
 
-def test_generate_plot_file(mocker, caplog):
+def test_generate_plot_file(mocker, caplog, user_dir):
     fig = generate_empty_figure()
     plot_mock = mocker.patch("freqtrade.plot.plotting.plot", MagicMock())
     store_plot_file(fig, filename="freqtrade-plot-UNITTEST_BTC-5m.html",
-                    directory=Path("user_data/plot"))
+                    directory=user_dir / "plot")
 
-    expected_fn = str(Path("user_data/plot/freqtrade-plot-UNITTEST_BTC-5m.html"))
+    expected_fn = str(user_dir / "plot/freqtrade-plot-UNITTEST_BTC-5m.html")
     assert plot_mock.call_count == 1
     assert plot_mock.call_args[0][0] == fig
     assert (plot_mock.call_args_list[0][1]['filename']
             == expected_fn)
     assert log_has(f"Stored plot as {expected_fn}",
                    caplog)
```

### Comparing `freqtrade-2023.4/tests/test_strategy_updater.py` & `freqtrade-2023.5/tests/test_strategy_updater.py`

 * *Files 5% similar despite different names*

```diff
@@ -12,37 +12,37 @@
 from tests.conftest import get_args
 
 
 if sys.version_info < (3, 9):
     pytest.skip("StrategyUpdater is not compatible with Python 3.8", allow_module_level=True)
 
 
-def test_strategy_updater_start(tmpdir, capsys) -> None:
+def test_strategy_updater_start(user_dir, capsys) -> None:
     # Effective test without mocks.
     teststrats = Path(__file__).parent / 'strategy/strats'
-    tmpdirp = Path(tmpdir) / "strategies"
-    tmpdirp.mkdir()
+    tmpdirp = Path(user_dir) / "strategies"
+    tmpdirp.mkdir(parents=True, exist_ok=True)
     shutil.copy(teststrats / 'strategy_test_v2.py', tmpdirp)
     old_code = (teststrats / 'strategy_test_v2.py').read_text()
 
     args = [
         "strategy-updater",
         "--userdir",
-        str(tmpdir),
+        str(user_dir),
         "--strategy-list",
         "StrategyTestV2"
          ]
     pargs = get_args(args)
     pargs['config'] = None
 
     start_strategy_update(pargs)
 
-    assert Path(tmpdir / "strategies_orig_updater").exists()
+    assert Path(user_dir / "strategies_orig_updater").exists()
     # Backup file exists
-    assert Path(tmpdir / "strategies_orig_updater" / 'strategy_test_v2.py').exists()
+    assert Path(user_dir / "strategies_orig_updater" / 'strategy_test_v2.py').exists()
     # updated file exists
     new_file = Path(tmpdirp / 'strategy_test_v2.py')
     assert new_file.exists()
     new_code = new_file.read_text()
     assert 'INTERFACE_VERSION = 3' in new_code
     assert 'INTERFACE_VERSION = 2' in old_code
     captured = capsys.readouterr()
```

### Comparing `freqtrade-2023.4/tests/test_timerange.py` & `freqtrade-2023.5/tests/test_timerange.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,11 +1,10 @@
 # pragma pylint: disable=missing-docstring, C0103
 from datetime import datetime, timezone
 
-import arrow
 import pytest
 
 from freqtrade.configuration import TimeRange
 from freqtrade.exceptions import OperationalException
 
 
 def test_parse_timerange_incorrect():
@@ -65,15 +64,15 @@
 
     x = TimeRange('date', None, 1274486400, 0)
     x.subtract_start(300)
     assert x.startts == 1274486400 - 300
 
 
 def test_adjust_start_if_necessary():
-    min_date = arrow.Arrow(2017, 11, 14, 21, 15, 00)
+    min_date = datetime(2017, 11, 14, 21, 15, 00, tzinfo=timezone.utc)
 
     x = TimeRange('date', 'date', 1510694100, 1510780500)
     # Adjust by 20 candles - min_date == startts
     x.adjust_start_if_necessary(300, 20, min_date)
     assert x.startts == 1510694100 + (20 * 300)
 
     x = TimeRange('date', 'date', 1510700100, 1510780500)
```

### Comparing `freqtrade-2023.4/tests/test_wallets.py` & `freqtrade-2023.5/tests/test_wallets.py`

 * *Files 11% similar despite different names*

```diff
@@ -1,15 +1,17 @@
 # pragma pylint: disable=missing-docstring
 from copy import deepcopy
 from unittest.mock import MagicMock
 
 import pytest
+from sqlalchemy import select
 
 from freqtrade.constants import UNLIMITED_STAKE_AMOUNT
 from freqtrade.exceptions import DependencyException
+from freqtrade.persistence import Trade
 from tests.conftest import EXMS, create_mock_trades, get_patched_freqtradebot, patch_wallet
 
 
 def test_sync_wallet_at_boot(mocker, default_conf):
     default_conf['dry_run'] = False
     mocker.patch.multiple(
         EXMS,
@@ -39,15 +41,15 @@
     assert freqtrade.wallets._wallets['BNT'].used == 2.0
     assert freqtrade.wallets._wallets['BNT'].total == 3.0
     assert freqtrade.wallets._wallets['GAS'].free == 0.260739
     assert freqtrade.wallets._wallets['GAS'].used == 0.0
     assert freqtrade.wallets._wallets['GAS'].total == 0.260739
     assert freqtrade.wallets.get_free('BNT') == 1.0
     assert 'USDT' in freqtrade.wallets._wallets
-    assert freqtrade.wallets._last_wallet_refresh > 0
+    assert freqtrade.wallets._last_wallet_refresh is not None
     mocker.patch.multiple(
         EXMS,
         get_balances=MagicMock(return_value={
             "BNT": {
                 "free": 1.2,
                 "used": 1.9,
                 "total": 3.5
@@ -326,15 +328,15 @@
     freqtrade = get_patched_freqtradebot(mocker, default_conf)
 
     assert len(freqtrade.wallets._wallets) == 1
     assert len(freqtrade.wallets._positions) == 2
 
     assert 'USDT' in freqtrade.wallets._wallets
     assert 'ETH/USDT:USDT' in freqtrade.wallets._positions
-    assert freqtrade.wallets._last_wallet_refresh > 0
+    assert freqtrade.wallets._last_wallet_refresh is not None
 
     # Remove ETH/USDT:USDT position
     del mock_result[0]
     freqtrade.wallets.update()
     assert len(freqtrade.wallets._positions) == 1
     assert 'ETH/USDT:USDT' not in freqtrade.wallets._positions
 
@@ -360,7 +362,52 @@
     positions['LTC/BTC'].side == 'short'
 
     assert freqtrade.wallets.get_starting_balance() == default_conf['dry_run_wallet']
     total = freqtrade.wallets.get_total('BTC')
     free = freqtrade.wallets.get_free('BTC')
     used = freqtrade.wallets.get_used('BTC')
     assert free + used == total
+
+
+def test_check_exit_amount(mocker, default_conf, fee):
+    freqtrade = get_patched_freqtradebot(mocker, default_conf)
+    update_mock = mocker.patch("freqtrade.wallets.Wallets.update")
+    total_mock = mocker.patch("freqtrade.wallets.Wallets.get_total", return_value=123)
+
+    create_mock_trades(fee, is_short=None)
+    trade = Trade.session.scalars(select(Trade)).first()
+    assert trade.amount == 123
+
+    assert freqtrade.wallets.check_exit_amount(trade) is True
+    assert update_mock.call_count == 0
+    assert total_mock.call_count == 1
+
+    update_mock.reset_mock()
+    # Reduce returned amount to below the trade amount - which should
+    # trigger a wallet update and return False, triggering "order refinding"
+    total_mock = mocker.patch("freqtrade.wallets.Wallets.get_total", return_value=100)
+    assert freqtrade.wallets.check_exit_amount(trade) is False
+    assert update_mock.call_count == 1
+    assert total_mock.call_count == 2
+
+
+def test_check_exit_amount_futures(mocker, default_conf, fee):
+    default_conf['trading_mode'] = 'futures'
+    default_conf['margin_mode'] = 'isolated'
+    freqtrade = get_patched_freqtradebot(mocker, default_conf)
+    total_mock = mocker.patch("freqtrade.wallets.Wallets.get_total", return_value=123)
+
+    create_mock_trades(fee, is_short=None)
+    trade = Trade.session.scalars(select(Trade)).first()
+    trade.trading_mode = 'futures'
+    assert trade.amount == 123
+
+    assert freqtrade.wallets.check_exit_amount(trade) is True
+    assert total_mock.call_count == 0
+
+    update_mock = mocker.patch("freqtrade.wallets.Wallets.update")
+    trade.amount = 150
+    # Reduce returned amount to below the trade amount - which should
+    # trigger a wallet update and return False, triggering "order refinding"
+    assert freqtrade.wallets.check_exit_amount(trade) is False
+    assert total_mock.call_count == 0
+    assert update_mock.call_count == 1
```

### Comparing `freqtrade-2023.4/tests/test_worker.py` & `freqtrade-2023.5/tests/test_worker.py`

 * *Files identical despite different names*

