# Comparing `tmp/rayfed_nightly-0.1.0b20230510.dev0-py3-none-any.whl.zip` & `tmp/rayfed_nightly-0.1.0b20230528.dev0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,27 +1,27 @@
-Zip file size: 38249 bytes, number of entries: 25
--rw-r--r--  2.0 unx      853 b- defN 23-May-10 01:22 fed/__init__.py
--rw-r--r--  2.0 unx    15899 b- defN 23-May-10 01:22 fed/api.py
--rw-r--r--  2.0 unx    14926 b- defN 23-May-10 01:22 fed/barriers.py
--rw-r--r--  2.0 unx     2933 b- defN 23-May-10 01:22 fed/cleanup.py
--rw-r--r--  2.0 unx     2280 b- defN 23-May-10 01:22 fed/config.py
--rw-r--r--  2.0 unx     2877 b- defN 23-May-10 01:22 fed/fed_object.py
--rw-r--r--  2.0 unx     7908 b- defN 23-May-10 01:22 fed/tree_util.py
--rw-r--r--  2.0 unx     5254 b- defN 23-May-10 01:22 fed/utils.py
--rw-r--r--  2.0 unx      581 b- defN 23-May-10 01:22 fed/_private/__init__.py
--rw-r--r--  2.0 unx      581 b- defN 23-May-10 01:22 fed/_private/api.py
--rw-r--r--  2.0 unx     4487 b- defN 23-May-10 01:22 fed/_private/compatible_utils.py
--rw-r--r--  2.0 unx     1268 b- defN 23-May-10 01:22 fed/_private/constants.py
--rw-r--r--  2.0 unx     3837 b- defN 23-May-10 01:22 fed/_private/fed_actor.py
--rw-r--r--  2.0 unx     3825 b- defN 23-May-10 01:22 fed/_private/fed_call_holder.py
--rw-r--r--  2.0 unx     1017 b- defN 23-May-10 01:22 fed/_private/global_context.py
--rw-r--r--  2.0 unx     2859 b- defN 23-May-10 01:22 fed/_private/grpc_options.py
--rw-r--r--  2.0 unx     2386 b- defN 23-May-10 01:22 fed/_private/serialization_utils.py
--rw-r--r--  2.0 unx      581 b- defN 23-May-10 01:22 fed/grpc/__init__.py
--rw-r--r--  2.0 unx     5608 b- defN 23-May-10 01:22 fed/grpc/fed_pb2.py
--rw-r--r--  2.0 unx     2955 b- defN 23-May-10 01:22 fed/grpc/fed_pb2_grpc.py
--rw-r--r--  2.0 unx    11356 b- defN 23-May-10 01:24 rayfed_nightly-0.1.0b20230510.dev0.dist-info/LICENSE
--rw-r--r--  2.0 unx     7243 b- defN 23-May-10 01:24 rayfed_nightly-0.1.0b20230510.dev0.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-May-10 01:24 rayfed_nightly-0.1.0b20230510.dev0.dist-info/WHEEL
--rw-r--r--  2.0 unx        4 b- defN 23-May-10 01:24 rayfed_nightly-0.1.0b20230510.dev0.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     2053 b- defN 23-May-10 01:24 rayfed_nightly-0.1.0b20230510.dev0.dist-info/RECORD
-25 files, 103663 bytes uncompressed, 34951 bytes compressed:  66.3%
+Zip file size: 38450 bytes, number of entries: 25
+-rw-r--r--  2.0 unx      853 b- defN 23-May-28 01:42 fed/__init__.py
+-rw-r--r--  2.0 unx    16111 b- defN 23-May-28 01:42 fed/api.py
+-rw-r--r--  2.0 unx    15662 b- defN 23-May-28 01:42 fed/barriers.py
+-rw-r--r--  2.0 unx     3074 b- defN 23-May-28 01:42 fed/cleanup.py
+-rw-r--r--  2.0 unx     2280 b- defN 23-May-28 01:42 fed/config.py
+-rw-r--r--  2.0 unx     2877 b- defN 23-May-28 01:42 fed/fed_object.py
+-rw-r--r--  2.0 unx     7908 b- defN 23-May-28 01:42 fed/tree_util.py
+-rw-r--r--  2.0 unx     5254 b- defN 23-May-28 01:42 fed/utils.py
+-rw-r--r--  2.0 unx      581 b- defN 23-May-28 01:42 fed/_private/__init__.py
+-rw-r--r--  2.0 unx      581 b- defN 23-May-28 01:42 fed/_private/api.py
+-rw-r--r--  2.0 unx     4487 b- defN 23-May-28 01:42 fed/_private/compatible_utils.py
+-rw-r--r--  2.0 unx     1268 b- defN 23-May-28 01:42 fed/_private/constants.py
+-rw-r--r--  2.0 unx     3837 b- defN 23-May-28 01:42 fed/_private/fed_actor.py
+-rw-r--r--  2.0 unx     3825 b- defN 23-May-28 01:42 fed/_private/fed_call_holder.py
+-rw-r--r--  2.0 unx     1017 b- defN 23-May-28 01:42 fed/_private/global_context.py
+-rw-r--r--  2.0 unx     2859 b- defN 23-May-28 01:42 fed/_private/grpc_options.py
+-rw-r--r--  2.0 unx     2386 b- defN 23-May-28 01:42 fed/_private/serialization_utils.py
+-rw-r--r--  2.0 unx      581 b- defN 23-May-28 01:42 fed/grpc/__init__.py
+-rw-r--r--  2.0 unx     5608 b- defN 23-May-28 01:42 fed/grpc/fed_pb2.py
+-rw-r--r--  2.0 unx     2955 b- defN 23-May-28 01:42 fed/grpc/fed_pb2_grpc.py
+-rw-r--r--  2.0 unx    11356 b- defN 23-May-28 01:44 rayfed_nightly-0.1.0b20230528.dev0.dist-info/LICENSE
+-rw-r--r--  2.0 unx     7243 b- defN 23-May-28 01:44 rayfed_nightly-0.1.0b20230528.dev0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-May-28 01:44 rayfed_nightly-0.1.0b20230528.dev0.dist-info/WHEEL
+-rw-r--r--  2.0 unx        4 b- defN 23-May-28 01:44 rayfed_nightly-0.1.0b20230528.dev0.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     2053 b- defN 23-May-28 01:44 rayfed_nightly-0.1.0b20230528.dev0.dist-info/RECORD
+25 files, 104752 bytes uncompressed, 35152 bytes compressed:  66.4%
```

## zipnote {}

```diff
@@ -54,23 +54,23 @@
 
 Filename: fed/grpc/fed_pb2.py
 Comment: 
 
 Filename: fed/grpc/fed_pb2_grpc.py
 Comment: 
 
-Filename: rayfed_nightly-0.1.0b20230510.dev0.dist-info/LICENSE
+Filename: rayfed_nightly-0.1.0b20230528.dev0.dist-info/LICENSE
 Comment: 
 
-Filename: rayfed_nightly-0.1.0b20230510.dev0.dist-info/METADATA
+Filename: rayfed_nightly-0.1.0b20230528.dev0.dist-info/METADATA
 Comment: 
 
-Filename: rayfed_nightly-0.1.0b20230510.dev0.dist-info/WHEEL
+Filename: rayfed_nightly-0.1.0b20230528.dev0.dist-info/WHEEL
 Comment: 
 
-Filename: rayfed_nightly-0.1.0b20230510.dev0.dist-info/top_level.txt
+Filename: rayfed_nightly-0.1.0b20230528.dev0.dist-info/top_level.txt
 Comment: 
 
-Filename: rayfed_nightly-0.1.0b20230510.dev0.dist-info/RECORD
+Filename: rayfed_nightly-0.1.0b20230528.dev0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## fed/api.py

```diff
@@ -66,14 +66,18 @@
                         # The address for other parties.
                         'address': '127.0.0.1:10001',
                         # (Optional) the listen address, the `address` will be
                         # used if not provided.
                         'listen_addr': '0.0.0.0:10001',
                         # (Optional) The party specific metadata sent with the grpc request
                         'grpc_metadata': (('token', 'alice-token'),),
+                        'grpc_options': [
+                            ('grpc.default_authority', 'alice'),
+                            ('grpc.max_send_message_length', 50 * 1024 * 1024)
+                        ]
                     },
                     'bob': {
                         # The address for other parties.
                         'address': '127.0.0.1:10002',
                         # (Optional) the listen address, the `address` will be
                         # used if not provided.
                         'listen_addr': '0.0.0.0:10002',
```

## fed/barriers.py

```diff
@@ -20,15 +20,15 @@
 
 import cloudpickle
 import grpc
 import ray
 
 import fed.config as fed_config
 import fed.utils as fed_utils
-from fed._private.constants import RAYFED_DATE_FMT, RAYFED_LOG_FMT
+from fed._private import constants
 from fed._private.grpc_options import get_grpc_options, set_max_message_length
 from fed.cleanup import push_to_sending
 from fed.grpc import fed_pb2, fed_pb2_grpc
 from fed.utils import setup_logger
 
 logger = logging.getLogger(__name__)
 
@@ -122,35 +122,34 @@
     dest,
     data,
     upstream_seq_id,
     downstream_seq_id,
     metadata=None,
     tls_config=None,
     retry_policy=None,
+    grpc_options=None
 ):
+    grpc_options = get_grpc_options(retry_policy=retry_policy) if \
+                    grpc_options is None else fed_utils.dict2tuple(grpc_options)
+
     tls_enabled = fed_utils.tls_enabled(tls_config)
-    grpc_options = get_grpc_options(retry_policy=retry_policy)
     cluster_config = fed_config.get_cluster_config()
     metadata = fed_utils.dict2tuple(metadata)
     if tls_enabled:
         ca_cert, private_key, cert_chain = fed_utils.load_cert_config(tls_config)
         credentials = grpc.ssl_channel_credentials(
             certificate_chain=cert_chain,
             private_key=private_key,
             root_certificates=ca_cert,
         )
 
         async with grpc.aio.secure_channel(
             dest,
             credentials,
-            options=grpc_options
-            + [
-                # ('grpc.ssl_target_name_override', "rayfed"),
-                # ("grpc.default_authority", "rayfed"),
-            ],
+            options=grpc_options,
         ) as channel:
             stub = fed_pb2_grpc.GrpcServiceStub(channel)
             data = cloudpickle.dumps(data)
             request = fed_pb2.SendDataRequest(
                 data=data,
                 upstream_seq_id=str(upstream_seq_id),
                 downstream_seq_id=str(downstream_seq_id),
@@ -190,16 +189,16 @@
         party: str,
         tls_config: Dict = None,
         logging_level: str = None,
         retry_policy: Dict = None,
     ):
         setup_logger(
             logging_level=logging_level,
-            logging_format=RAYFED_LOG_FMT,
-            date_format=RAYFED_DATE_FMT,
+            logging_format=constants.RAYFED_LOG_FMT,
+            date_format=constants.RAYFED_DATE_FMT,
             party_val=party,
         )
         self._stats = {"send_op_count": 0}
         self._cluster = cluster
         self._party = party
         self._tls_config = tls_config
         self.retry_policy = retry_policy
@@ -226,59 +225,76 @@
             f'from {upstream_seq_id}'
         )
         logger.debug(
             f'Sending {send_log_msg} with{"out" if not self._tls_config else ""}'
             ' credentials.'
         )
         dest_addr = self._cluster[dest_party]['address']
-        dest_party_grpc_metadata = dict(
-            self._cluster[dest_party].get('grpc_metadata', {})
-        )
-        global_grpc_metadata = (
-            dict(self._grpc_metadata) if self._grpc_metadata is not None else {}
-        )
-        # merge grpc metadata
-        grpc_metadata = {**global_grpc_metadata, **dest_party_grpc_metadata}
+        dest_party_grpc_config = self.setup_grpc_config(dest_party)
         try:
             response = await send_data_grpc(
                 dest=dest_addr,
                 data=data,
                 upstream_seq_id=upstream_seq_id,
                 downstream_seq_id=downstream_seq_id,
-                metadata=grpc_metadata,
+                metadata=dest_party_grpc_config['grpc_metadata'],
                 tls_config=self._tls_config,
                 retry_policy=self.retry_policy,
+                grpc_options=dest_party_grpc_config['grpc_options']
             )
         except Exception as e:
             logger.error(f'Failed to {send_log_msg}, error: {e}')
             return False
         logger.debug(f"Succeeded to send {send_log_msg}. Response is {response}")
         return True  # True indicates it's sent successfully.
 
+    def setup_grpc_config(self, dest_party):
+        dest_party_grpc_config = {}
+        global_grpc_metadata = (
+            dict(self._grpc_metadata) if self._grpc_metadata is not None else {}
+        )
+        dest_party_grpc_metadata = dict(
+            self._cluster[dest_party].get('grpc_metadata', {})
+        )
+        # merge grpc metadata
+        dest_party_grpc_config['grpc_metadata'] = {
+            **global_grpc_metadata, **dest_party_grpc_metadata}
+
+        global_grpc_options = dict(get_grpc_options(self.retry_policy))
+        dest_party_grpc_options = dict(
+            self._cluster[dest_party].get('grpc_options', {})
+        )
+        dest_party_grpc_config['grpc_options'] = {
+            **global_grpc_options, **dest_party_grpc_options}
+        return dest_party_grpc_config
+
     async def _get_stats(self):
         return self._stats
 
     async def _get_grpc_options(self):
         return get_grpc_options()
 
+    async def _get_cluster_info(self):
+        return self._cluster
+
 
 @ray.remote
 class RecverProxyActor:
     def __init__(
         self,
         listen_addr: str,
         party: str,
         logging_level: str,
         tls_config=None,
         retry_policy: Dict = None,
     ):
         setup_logger(
             logging_level=logging_level,
-            logging_format=RAYFED_LOG_FMT,
-            date_format=RAYFED_DATE_FMT,
+            logging_format=constants.RAYFED_LOG_FMT,
+            date_format=constants.RAYFED_DATE_FMT,
             party_val=party,
         )
         self._stats = {"receive_op_count": 0}
         self._listen_addr = listen_addr
         self._party = party
         self._tls_config = tls_config
         self.retry_policy = retry_policy
@@ -340,14 +356,15 @@
     party: str,
     logging_level: str,
     tls_config=None,
     retry_policy=None,
 ):
     # Create RecevrProxyActor
     # Not that this is now a threaded actor.
+    # NOTE(NKcqx): This is not just addr, but a party dict containing 'address'
     party_addr = cluster[party]
     listen_addr = party_addr.get('listen_addr', None)
     if not listen_addr:
         listen_addr = party_addr['address']
 
     recver_proxy_actor = RecverProxyActor.options(
         name=f"RecverProxyActor-{party}", max_concurrency=1000
```

## fed/cleanup.py

```diff
@@ -19,15 +19,15 @@
 import time
 from collections import deque
 
 import ray
 
 logger = logging.getLogger(__name__)
 
-_sending_obj_refs_q = deque()
+_sending_obj_refs_q = None
 
 _check_send_thread = None
 
 _EXIT_ON_FAILURE_SENDING = False
 
 
 def set_exit_on_failure_sending(exit_when_failure_sending: bool):
@@ -41,14 +41,16 @@
 
 
 def _check_sending_objs():
     def _signal_exit():
         os.kill(os.getpid(), signal.SIGTERM)
 
     global _sending_obj_refs_q
+    if not _sending_obj_refs_q:
+        _sending_obj_refs_q = deque()
     while True:
         try:
             obj_ref = _sending_obj_refs_q.popleft()
         except IndexError:
             time.sleep(0.5)
             continue
         if isinstance(obj_ref, bool):
@@ -62,14 +64,16 @@
             logger.warn('Signal self to exit.')
             _signal_exit()
             break
 
     logger.info('Check sending thread was exited.')
     global _check_send_thread
     _check_send_thread = None
+    logger.info('Clearing sending queue.')
+    _sending_obj_refs_q = None
 
 
 def _main_thread_monitor():
     main_thread = threading.main_thread()
     main_thread.join()
     notify_to_exit()
```

## Comparing `rayfed_nightly-0.1.0b20230510.dev0.dist-info/LICENSE` & `rayfed_nightly-0.1.0b20230528.dev0.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `rayfed_nightly-0.1.0b20230510.dev0.dist-info/METADATA` & `rayfed_nightly-0.1.0b20230528.dev0.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: rayfed-nightly
-Version: 0.1.0b20230510.dev0
+Version: 0.1.0b20230528.dev0
 Summary: A multiple parties joint, distributed execution engine based on Ray,to help build your own federated learning frameworks in minutes.
 Home-page: https://github.com/ray-project/rayfed
 Author: RayFed Team
 Author-email: rayfed-dev@googlegroups.com
 License: Apache 2.0
 Platform: UNKNOWN
 Description-Content-Type: text/markdown
```

## Comparing `rayfed_nightly-0.1.0b20230510.dev0.dist-info/RECORD` & `rayfed_nightly-0.1.0b20230528.dev0.dist-info/RECORD`

 * *Files 8% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 fed/__init__.py,sha256=6Xds1gLndBN-E4GBTuxnc7gf3Zw_D8iNejjA3JTjWnc,853
-fed/api.py,sha256=51vq0xwq2IVsGsEM9IVjoxpOEgTohTVQlmJEWvjJEZc,15899
-fed/barriers.py,sha256=YcbbiW7bIUOlRKMWqyDyQdrDGdjzBqqikZtZYaHyEwI,14926
-fed/cleanup.py,sha256=5P_Z6nX7GqB6WbHt1b8oVhNdUfYVRhclDdgUNt5weK0,2933
+fed/api.py,sha256=kFNa0FgyNF1zj9Z3gWjoDgPY5E_wAOswGm3IcYDnbXQ,16111
+fed/barriers.py,sha256=ZBT8P4p7MXC8fqW7hQb6EWEHCU4GsAbNzCseEKicdqA,15662
+fed/cleanup.py,sha256=w4FAOleKE2lv_hLJxq4ien2BdUK0UuMXlw7OSWTm8MI,3074
 fed/config.py,sha256=bpflURNHjH224XWM9BUgvMLzH-3BRzZJ_oX0PtdErrw,2280
 fed/fed_object.py,sha256=l2BRa9WZ3jqXSDjwFPURcAIK8XkH8A5UYA_OcY4TOD0,2877
 fed/tree_util.py,sha256=25LiGASBcreE34OsGsoeRWH4t6BuBk3QVcKjCe38jTI,7908
 fed/utils.py,sha256=gMJrnH9-EPkcWrwWyXRtnl5HOGeCl1kP2Gc0In7m5es,5254
 fed/_private/__init__.py,sha256=MDXwlZ-y7_o-tfqh8DVkjlO-6MlWqwLdbSIZUJfXtF0,581
 fed/_private/api.py,sha256=MDXwlZ-y7_o-tfqh8DVkjlO-6MlWqwLdbSIZUJfXtF0,581
 fed/_private/compatible_utils.py,sha256=ZhaLX797pZ-PnwlNIMgRzkwrysW0wbruQLHm-WsNUUs,4487
@@ -14,12 +14,12 @@
 fed/_private/fed_call_holder.py,sha256=uJhmyq1nIn4nqJUg1bOqjgXrgFscZHsdpi5pXrXPF2M,3825
 fed/_private/global_context.py,sha256=dlfeqdp6C_5bGDvzHcxbR6xZGELfVyoQtDIZ4ampwZw,1017
 fed/_private/grpc_options.py,sha256=_r43xjQfg0JmD0T447wHV42EYhP0YpBubsGKG22TuN4,2859
 fed/_private/serialization_utils.py,sha256=l63nacVabcyKpys9tVT2zUMmKecimeVflsJ6v45AYvc,2386
 fed/grpc/__init__.py,sha256=MDXwlZ-y7_o-tfqh8DVkjlO-6MlWqwLdbSIZUJfXtF0,581
 fed/grpc/fed_pb2.py,sha256=CKRJyBIx8MG4XtqtARL9ETFEyIsX2ksO0IVU9JgBhWQ,5608
 fed/grpc/fed_pb2_grpc.py,sha256=PsTotUwY4gEHWV0gQnPwpoQWdNJCczNZti6bJBYFj5Q,2955
-rayfed_nightly-0.1.0b20230510.dev0.dist-info/LICENSE,sha256=QwcOLU5TJoTeUhuIXzhdCEEDDvorGiC6-3YTOl4TecE,11356
-rayfed_nightly-0.1.0b20230510.dev0.dist-info/METADATA,sha256=xU28BaA_aAW1H8H8HpK_3C9HvxXWjA0odxwzhdp-EnE,7243
-rayfed_nightly-0.1.0b20230510.dev0.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-rayfed_nightly-0.1.0b20230510.dev0.dist-info/top_level.txt,sha256=5gd1qhbpzLAi36ONV8p_s65_-iAiOSwFljYh-ONEwts,4
-rayfed_nightly-0.1.0b20230510.dev0.dist-info/RECORD,,
+rayfed_nightly-0.1.0b20230528.dev0.dist-info/LICENSE,sha256=QwcOLU5TJoTeUhuIXzhdCEEDDvorGiC6-3YTOl4TecE,11356
+rayfed_nightly-0.1.0b20230528.dev0.dist-info/METADATA,sha256=34rBnLGn4WOQAskVkn2ZVvF5O0mdRIEfW2Ugg282zpU,7243
+rayfed_nightly-0.1.0b20230528.dev0.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+rayfed_nightly-0.1.0b20230528.dev0.dist-info/top_level.txt,sha256=5gd1qhbpzLAi36ONV8p_s65_-iAiOSwFljYh-ONEwts,4
+rayfed_nightly-0.1.0b20230528.dev0.dist-info/RECORD,,
```

